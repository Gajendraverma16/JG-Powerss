This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

<additional_info>

</additional_info>

</file_summary>

<directory_structure>
.env.development
.env.production
.gitignore
eslint.config.js
index.html
jsconfig.json
package.json
postcss.config.cjs
public/Arrow.svg
public/calendar-2.svg
public/caret-down.svg
public/dashboard.svg
public/hugeicons_less-than.svg
public/Invoice.svg
public/message-question.svg
public/NewVector.svg
public/notification.svg
public/payments.svg
public/quotation.svg
public/right.svg
public/Vector.svg
public/vite.svg
README.md
src/api.js
src/App.css
src/App.jsx
src/assets/react.svg
src/auth/AuthContext.jsx
src/components/Layout.jsx
src/components/old-roles-permissions.jsx
src/components/SampleComponent.jsx
src/components/SampleComponent2.jsx
src/components/Sidebar.jsx
src/components/TinyTapEditor.jsx
src/components/tiptap-extension/link-extension.js
src/components/tiptap-extension/selection-extension.js
src/components/tiptap-extension/trailing-node-extension.js
src/components/tiptap-icons/align-center-icon.jsx
src/components/tiptap-icons/align-justify-icon.jsx
src/components/tiptap-icons/align-left-icon.jsx
src/components/tiptap-icons/align-right-icon.jsx
src/components/tiptap-icons/arrow-left-icon.jsx
src/components/tiptap-icons/ban-icon.jsx
src/components/tiptap-icons/block-quote-icon.jsx
src/components/tiptap-icons/bold-icon.jsx
src/components/tiptap-icons/chevron-down-icon.jsx
src/components/tiptap-icons/close-icon.jsx
src/components/tiptap-icons/code-block-icon.jsx
src/components/tiptap-icons/code2-icon.jsx
src/components/tiptap-icons/corner-down-left-icon.jsx
src/components/tiptap-icons/external-link-icon.jsx
src/components/tiptap-icons/heading-five-icon.jsx
src/components/tiptap-icons/heading-four-icon.jsx
src/components/tiptap-icons/heading-icon.jsx
src/components/tiptap-icons/heading-one-icon.jsx
src/components/tiptap-icons/heading-six-icon.jsx
src/components/tiptap-icons/heading-three-icon.jsx
src/components/tiptap-icons/heading-two-icon.jsx
src/components/tiptap-icons/highlighter-icon.jsx
src/components/tiptap-icons/image-plus-icon.jsx
src/components/tiptap-icons/italic-icon.jsx
src/components/tiptap-icons/link-icon.jsx
src/components/tiptap-icons/list-icon.jsx
src/components/tiptap-icons/list-ordered-icon.jsx
src/components/tiptap-icons/list-todo-icon.jsx
src/components/tiptap-icons/moon-star-icon.jsx
src/components/tiptap-icons/redo2-icon.jsx
src/components/tiptap-icons/strike-icon.jsx
src/components/tiptap-icons/subscript-icon.jsx
src/components/tiptap-icons/sun-icon.jsx
src/components/tiptap-icons/superscript-icon.jsx
src/components/tiptap-icons/trash-icon.jsx
src/components/tiptap-icons/underline-icon.jsx
src/components/tiptap-icons/undo2-icon.jsx
src/components/tiptap-node/code-block-node/code-block-node.scss
src/components/tiptap-node/image-node/image-node.scss
src/components/tiptap-node/image-upload-node/image-upload-node-extension.js
src/components/tiptap-node/image-upload-node/image-upload-node.jsx
src/components/tiptap-node/image-upload-node/image-upload-node.scss
src/components/tiptap-node/image-upload-node/index.jsx
src/components/tiptap-node/list-node/list-node.scss
src/components/tiptap-node/paragraph-node/paragraph-node.scss
src/components/tiptap-templates/simple/data/content.json
src/components/tiptap-templates/simple/simple-editor.jsx
src/components/tiptap-templates/simple/simple-editor.scss
src/components/tiptap-templates/simple/theme-toggle.jsx
src/components/tiptap-ui-primitive/button/button-colors.scss
src/components/tiptap-ui-primitive/button/button-group.scss
src/components/tiptap-ui-primitive/button/button.jsx
src/components/tiptap-ui-primitive/button/button.scss
src/components/tiptap-ui-primitive/button/index.jsx
src/components/tiptap-ui-primitive/dropdown-menu/dropdown-menu.jsx
src/components/tiptap-ui-primitive/dropdown-menu/dropdown-menu.scss
src/components/tiptap-ui-primitive/dropdown-menu/index.jsx
src/components/tiptap-ui-primitive/popover/index.jsx
src/components/tiptap-ui-primitive/popover/popover.jsx
src/components/tiptap-ui-primitive/popover/popover.scss
src/components/tiptap-ui-primitive/separator/index.jsx
src/components/tiptap-ui-primitive/separator/separator.jsx
src/components/tiptap-ui-primitive/separator/separator.scss
src/components/tiptap-ui-primitive/spacer/index.jsx
src/components/tiptap-ui-primitive/spacer/spacer.jsx
src/components/tiptap-ui-primitive/toolbar/index.jsx
src/components/tiptap-ui-primitive/toolbar/toolbar.jsx
src/components/tiptap-ui-primitive/toolbar/toolbar.scss
src/components/tiptap-ui-primitive/tooltip/index.jsx
src/components/tiptap-ui-primitive/tooltip/tooltip.jsx
src/components/tiptap-ui-primitive/tooltip/tooltip.scss
src/components/tiptap-ui/blockquote-button/blockquote-button.jsx
src/components/tiptap-ui/blockquote-button/index.jsx
src/components/tiptap-ui/code-block-button/code-block-button.jsx
src/components/tiptap-ui/code-block-button/index.jsx
src/components/tiptap-ui/color-highlight-button/color-highlight-button.jsx
src/components/tiptap-ui/color-highlight-button/color-highlight-button.scss
src/components/tiptap-ui/color-highlight-button/index.jsx
src/components/tiptap-ui/color-highlight-popover/color-highlight-popover.jsx
src/components/tiptap-ui/color-highlight-popover/color-highlight-popover.scss
src/components/tiptap-ui/color-highlight-popover/index.jsx
src/components/tiptap-ui/heading-button/heading-button.jsx
src/components/tiptap-ui/heading-button/index.jsx
src/components/tiptap-ui/heading-dropdown-menu/heading-dropdown-menu.jsx
src/components/tiptap-ui/heading-dropdown-menu/index.jsx
src/components/tiptap-ui/image-upload-button/image-upload-button.jsx
src/components/tiptap-ui/image-upload-button/index.jsx
src/components/tiptap-ui/link-popover/index.jsx
src/components/tiptap-ui/link-popover/link-popover.jsx
src/components/tiptap-ui/link-popover/link-popover.scss
src/components/tiptap-ui/list-button/index.jsx
src/components/tiptap-ui/list-button/list-button.jsx
src/components/tiptap-ui/list-dropdown-menu/index.jsx
src/components/tiptap-ui/list-dropdown-menu/list-dropdown-menu.jsx
src/components/tiptap-ui/mark-button/index.jsx
src/components/tiptap-ui/mark-button/mark-button.jsx
src/components/tiptap-ui/text-align-button/index.jsx
src/components/tiptap-ui/text-align-button/text-align-button.jsx
src/components/tiptap-ui/undo-redo-button/index.jsx
src/components/tiptap-ui/undo-redo-button/undo-redo-button.jsx
src/hooks/use-cursor-visibility.js
src/hooks/use-menu-navigation.js
src/hooks/use-mobile.js
src/hooks/use-tiptap-editor.js
src/hooks/use-window-size.js
src/index.css
src/lib/tiptap-utils.js
src/main.jsx
src/pages/customer inquiry/Customer.jsx
src/pages/dashboard/AvgLeads.jsx
src/pages/dashboard/Container1.jsx
src/pages/dashboard/ContainerBackup.jsx
src/pages/dashboard/dashboard.jsx
src/pages/dashboard/listhere.jsx
src/pages/dashboard/Quotation.jsx
src/pages/invoice/CreateInvoice.jsx
src/pages/invoice/ViewInvoice.jsx
src/pages/leads/AllLeads.jsx
src/pages/leads/CustomLeadsComponent.jsx
src/pages/login/Login.jsx
src/pages/logout/logout.jsx
src/pages/payment/CreatePayment.jsx
src/pages/payment/ViewPayment.jsx
src/pages/quotation/CreateQuotation.jsx
src/pages/quotation/View.jsx
src/pages/settings/CreateNewUser.jsx
src/pages/settings/LeadsSettings.jsx
src/pages/settings/OrganisationInfo.jsx
src/pages/settings/RolesPermissions.jsx
src/pages/settings/UpdateProfile.jsx
src/routes/AppRoutes.jsx
src/styles/_keyframe-animations.scss
src/styles/_variables.scss
src/styles/scrollbar.css
tailwind.config.js
vite.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".env.development">
VITE_API_URL=https://inquiry.questdigiflex.in/public/api
</file>

<file path=".env.production">
VITE_API_URL=https://inquiry.questdigiflex.in/public/api
</file>

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

# Dependencies
node_modules/

# Build outputs
/dist/
dist-ssr/

# Vite cache
.vite/

# Local env files
.env
.env.*.local

# Generated config
*.local

# Editor directories and files
.vscode/
!.vscode/extensions.json
.idea/
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?

# System files
.DS_Store
Thumbs.db

# Logs (duplicate covered above for extra safety)
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Others
yarn-error.log*

# Lockfiles (optional)
# yarn.lock
# package-lock.json
</file>

<file path="eslint.config.js">
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'

export default [
  { ignores: ['dist'] },
  {
    files: ['**/*.{js,jsx}'],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    plugins: {
      'react-hooks': reactHooks,
      'react-refresh': reactRefresh,
    },
    rules: {
      ...js.configs.recommended.rules,
      ...reactHooks.configs.recommended.rules,
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
      'react-refresh/only-export-components': [
        'warn',
        { allowConstantExport: true },
      ],
    },
  },
]
</file>

<file path="jsconfig.json">
{
  "compilerOptions": {
    "target": "ESNext",
    "module": "ESNext",
    "jsx": "react",
    "baseUrl": ".",
    "paths": {
      // Optional: if you use absolute imports from src, e.g. "@/components"
      "@/*": ["src/*"]
    }
  },
  "include": ["src"]
}
</file>

<file path="postcss.config.cjs">
// postcss.config.cjs
module.exports = {
  plugins: {
    // Use the new PostCSS plugin entrypoint
    '@tailwindcss/postcss': {},
    autoprefixer: {},
  },
}
</file>

<file path="public/Arrow.svg">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<g opacity="0.48">
<rect y="24" width="24" height="24" rx="12" transform="rotate(-90 0 24)" fill="#1B80DB"/>
<path opacity="0.8" fill-rule="evenodd" clip-rule="evenodd" d="M10.0525 12.0009L14.5503 7.46527C14.8832 7.12914 14.8832 6.58702 14.5503 6.25089C14.3917 6.09032 14.1753 6 13.9496 6C13.724 6 13.5076 6.09032 13.349 6.25089L8.25046 11.3928C7.9165 11.7286 7.9165 12.2714 8.25046 12.6072L13.3488 17.7491C13.5076 17.9097 13.724 18 13.9496 18C14.1753 18 14.3917 17.9097 14.5505 17.7491C14.8832 17.4129 14.8832 16.8708 14.5501 16.5347L10.0525 12.0009Z" fill="white"/>
</g>
</svg>
</file>

<file path="public/calendar-2.svg">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M8 2V5" stroke="#787486" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M16 2V5" stroke="#787486" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M3.5 9.08984H20.5" stroke="#787486" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M21 8.5V17C21 20 19.5 22 16 22H8C4.5 22 3 20 3 17V8.5C3 5.5 4.5 3.5 8 3.5H16C19.5 3.5 21 5.5 21 8.5Z" stroke="#787486" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M11.9955 13.7002H12.0045" stroke="#787486" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M8.29431 13.7002H8.30329" stroke="#787486" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M8.29431 16.7002H8.30329" stroke="#787486" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</file>

<file path="public/caret-down.svg">
<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M4.27337 6H11.7267C11.8586 6.00055 11.9873 6.04019 12.0966 6.1139C12.2059 6.18761 12.2909 6.29208 12.3409 6.4141C12.3908 6.53612 12.4035 6.67021 12.3772 6.79942C12.351 6.92863 12.287 7.04715 12.1934 7.14L8.47337 10.86C8.41139 10.9225 8.33766 10.9721 8.25642 11.0059C8.17518 11.0398 8.08804 11.0572 8.00004 11.0572C7.91203 11.0572 7.82489 11.0398 7.74365 11.0059C7.66241 10.9721 7.58868 10.9225 7.5267 10.86L3.8067 7.14C3.71309 7.04715 3.64911 6.92863 3.62285 6.79942C3.59659 6.67021 3.60924 6.53612 3.65919 6.4141C3.70914 6.29208 3.79415 6.18761 3.90347 6.1139C4.0128 6.04019 4.14152 6.00055 4.27337 6Z" fill="#727A90"/>
</svg>
</file>

<file path="public/dashboard.svg">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M6.57129 2.75C7.31425 2.75 7.83235 2.75039 8.2373 2.7793C8.53566 2.80061 8.74055 2.83609 8.89844 2.88477L9.04297 2.9375C9.49809 3.13612 9.8727 3.47913 10.1113 3.91016L10.2051 4.10059C10.2818 4.27661 10.3349 4.50764 10.3633 4.90527C10.3922 5.31025 10.3926 5.82822 10.3926 6.57129C10.3926 7.31426 10.3922 7.83235 10.3633 8.2373C10.342 8.53571 10.3065 8.74054 10.2578 8.89844L10.2051 9.04297C10.0064 9.49812 9.66352 9.87273 9.23242 10.1113L9.04297 10.2051C8.86691 10.2819 8.63514 10.3349 8.2373 10.3633C7.83235 10.3922 7.31426 10.3926 6.57129 10.3926C5.82822 10.3926 5.31025 10.3922 4.90527 10.3633C4.6067 10.3419 4.40207 10.3065 4.24414 10.2578L4.10059 10.2051C3.64525 10.0064 3.2699 9.66367 3.03125 9.23242L2.9375 9.04297C2.86069 8.86691 2.80772 8.63514 2.7793 8.2373C2.75039 7.83235 2.75 7.31425 2.75 6.57129C2.75 5.82823 2.75037 5.31025 2.7793 4.90527C2.80062 4.60675 2.83605 4.40206 2.88477 4.24414L2.9375 4.10059C3.13613 3.64533 3.479 3.26991 3.91016 3.03125L4.10059 2.9375C4.2766 2.86077 4.50772 2.8077 4.90527 2.7793C5.31025 2.75037 5.82823 2.75 6.57129 2.75Z" stroke="white" stroke-width="1.5"/>
<path d="M6.57129 13.6074C7.31425 13.6074 7.83235 13.6078 8.2373 13.6367C8.53566 13.658 8.74055 13.6935 8.89844 13.7422L9.04297 13.7949C9.49809 13.9935 9.8727 14.3365 10.1113 14.7676L10.2051 14.958C10.2818 15.134 10.3349 15.3651 10.3633 15.7627C10.3922 16.1677 10.3926 16.6856 10.3926 17.4287C10.3926 18.1717 10.3922 18.6898 10.3633 19.0947C10.342 19.3931 10.3065 19.598 10.2578 19.7559L10.2051 19.9004C10.0064 20.3555 9.66352 20.7301 9.23242 20.9688L9.04297 21.0625C8.86691 21.1393 8.63514 21.1923 8.2373 21.2207C7.83235 21.2496 7.31426 21.25 6.57129 21.25C5.82822 21.25 5.31025 21.2496 4.90527 21.2207C4.6067 21.1994 4.40207 21.164 4.24414 21.1152L4.10059 21.0625C3.64525 20.8638 3.2699 20.5211 3.03125 20.0898L2.9375 19.9004C2.86069 19.7243 2.80772 19.4926 2.7793 19.0947C2.75039 18.6898 2.75 18.1717 2.75 17.4287C2.75 16.6857 2.75037 16.1677 2.7793 15.7627C2.80062 15.4642 2.83605 15.2595 2.88477 15.1016L2.9375 14.958C3.13613 14.5028 3.479 14.1273 3.91016 13.8887L4.10059 13.7949C4.2766 13.7182 4.50772 13.6651 4.90527 13.6367C5.31025 13.6078 5.82823 13.6074 6.57129 13.6074Z" stroke="white" stroke-width="1.5"/>
<path d="M17.4285 2.75C18.1714 2.75 18.6895 2.75039 19.0945 2.7793C19.3928 2.80061 19.5977 2.83609 19.7556 2.88477L19.9001 2.9375C20.3552 3.13612 20.7299 3.47913 20.9685 3.91016L21.0622 4.10059C21.139 4.27661 21.192 4.50764 21.2204 4.90527C21.2494 5.31025 21.2497 5.82822 21.2497 6.57129C21.2497 7.31426 21.2494 7.83235 21.2204 8.2373C21.1991 8.53571 21.1637 8.74054 21.115 8.89844L21.0622 9.04297C20.8636 9.49812 20.5207 9.87273 20.0896 10.1113L19.9001 10.2051C19.7241 10.2819 19.4923 10.3349 19.0945 10.3633C18.6895 10.3922 18.1714 10.3926 17.4285 10.3926C16.6854 10.3926 16.1674 10.3922 15.7624 10.3633C15.4639 10.3419 15.2592 10.3065 15.1013 10.2578L14.9577 10.2051C14.5024 10.0064 14.1271 9.66367 13.8884 9.23242L13.7947 9.04297C13.7178 8.86691 13.6649 8.63514 13.6365 8.2373C13.6076 7.83235 13.6072 7.31425 13.6072 6.57129C13.6072 5.82823 13.6075 5.31025 13.6365 4.90527C13.6578 4.60675 13.6932 4.40206 13.7419 4.24414L13.7947 4.10059C13.9933 3.64533 14.3362 3.26991 14.7673 3.03125L14.9577 2.9375C15.1338 2.86077 15.3649 2.8077 15.7624 2.7793C16.1674 2.75037 16.6854 2.75 17.4285 2.75Z" stroke="white" stroke-width="1.5"/>
<path d="M17.4285 13.6074C18.1714 13.6074 18.6895 13.6078 19.0945 13.6367C19.3928 13.658 19.5977 13.6935 19.7556 13.7422L19.9001 13.7949C20.3553 13.9935 20.7299 14.3365 20.9685 14.7676L21.0623 14.958C21.139 15.134 21.1921 15.3651 21.2205 15.7627C21.2494 16.1677 21.2498 16.6856 21.2498 17.4287C21.2498 18.1717 21.2494 18.6898 21.2205 19.0947C21.1991 19.3931 21.1637 19.598 21.115 19.7559L21.0623 19.9004C20.8636 20.3555 20.5207 20.7301 20.0896 20.9688L19.9001 21.0625C19.7241 21.1393 19.4923 21.1923 19.0945 21.2207C18.6895 21.2496 18.1714 21.25 17.4285 21.25C16.6854 21.25 16.1674 21.2496 15.7625 21.2207C15.4639 21.1994 15.2592 21.164 15.1013 21.1152L14.9578 21.0625C14.5024 20.8638 14.1271 20.5211 13.8884 20.0898L13.7947 19.9004C13.7179 19.7243 13.6649 19.4926 13.6365 19.0947C13.6076 18.6898 13.6072 18.1717 13.6072 17.4287C13.6072 16.6857 13.6076 16.1677 13.6365 15.7627C13.6578 15.4642 13.6932 15.2595 13.7419 15.1016L13.7947 14.958C13.9933 14.5028 14.3362 14.1273 14.7673 13.8887L14.9578 13.7949C15.1338 13.7182 15.3649 13.6651 15.7625 13.6367C16.1674 13.6078 16.6854 13.6074 17.4285 13.6074Z" stroke="white" stroke-width="1.5"/>
</svg>
</file>

<file path="public/hugeicons_less-than.svg">
<svg width="33" height="32" viewBox="0 0 33 32" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M23.1667 5.33398L12.06 13.3873C9.09198 15.5407 9.09198 16.462 12.06 18.614L23.1667 26.6673" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</file>

<file path="public/Invoice.svg">
<svg width="17" height="22" viewBox="0 0 17 22" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M13.6663 1.00049H2.99994C1.8954 1.00049 0.999992 1.89589 0.999992 3.00044V19C0.999992 20.1045 1.8954 21 2.99994 21H13.6663C14.7709 21 15.6663 20.1045 15.6663 19V3.00044C15.6663 1.89589 14.7709 1.00049 13.6663 1.00049Z" stroke="#787486"/>
<path d="M5.6665 11.0012L10.9997 5.66797" stroke="#787486" stroke-linecap="round"/>
<path d="M6.33315 7.00127C6.70133 7.00127 6.9998 6.7028 6.9998 6.33462C6.9998 5.96644 6.70133 5.66797 6.33315 5.66797C5.96497 5.66797 5.6665 5.96644 5.6665 6.33462C5.6665 6.7028 5.96497 7.00127 6.33315 7.00127Z" stroke="#787486"/>
<path d="M10.3331 11.0008C10.7013 11.0008 10.9997 10.7023 10.9997 10.3341C10.9997 9.96595 10.7013 9.66748 10.3331 9.66748C9.96491 9.66748 9.66644 9.96595 9.66644 10.3341C9.66644 10.7023 9.96491 11.0008 10.3331 11.0008Z" stroke="#787486"/>
<path d="M4.3332 15.0005H12.333M4.3332 17.6671H12.333" stroke="#787486" stroke-linecap="round"/>
</svg>
</file>

<file path="public/message-question.svg">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M17 18.4302H13L8.54999 21.3902C7.88999 21.8302 7 21.3602 7 20.5602V18.4302C4 18.4302 2 16.4302 2 13.4302V7.43018C2 4.43018 4 2.43018 7 2.43018H17C20 2.43018 22 4.43018 22 7.43018V13.4302C22 16.4302 20 18.4302 17 18.4302Z" stroke="#787486" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M12 11.3599V11.1499C12 10.4699 12.42 10.1099 12.84 9.81989C13.25 9.53989 13.66 9.1799 13.66 8.5199C13.66 7.5999 12.92 6.85986 12 6.85986C11.08 6.85986 10.34 7.5999 10.34 8.5199" stroke="#787486" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M11.9955 13.75H12.0045" stroke="#787486" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</file>

<file path="public/NewVector.svg">
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="1080" height="1080" viewBox="0 0 1080 1080" xml:space="preserve">
<desc>Created with Fabric.js 5.2.4</desc>
<defs>
</defs>
<g transform="matrix(1 0 0 1 540 540)" id="05056b48-98b4-4f9d-ac61-276f16f355b9"  >
<rect style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: rgb(255,255,255); fill-rule: nonzero; opacity: 1; visibility: hidden;" vector-effect="non-scaling-stroke"  x="-540" y="-540" rx="0" ry="0" width="1080" height="1080" />
</g>
<g transform="matrix(1 0 0 1 540 540)" id="329ccdf5-5b6b-45e3-a84e-8b44e38bfe57"  >
</g>
<g transform="matrix(1 0 0 1 540 540)" id="f1dfd0e4-8627-4324-8145-f85c3f3e7637"  >
<path style="stroke: rgb(211,211,211); stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: rgb(211,211,211); fill-rule: nonzero; opacity: 1;" vector-effect="non-scaling-stroke"  transform=" translate(-7, -32.35)" d="M 13 64.7 C 13.3866 64.7 13.7 64.3866 13.7 64 C 13.7 63.6134 13.3866 63.3 13 63.3 L 13 64.7 Z M 1 0 L 0.3 0 L 0.3 53.2951 L 1 53.2951 L 1.7 53.2951 L 1.7 0 L 1 0 Z M 1 53.2951 L 0.3 53.2951 C 0.3 58.1048 1.30961 61.0286 3.15174 62.7189 C 4.98655 64.4024 7.47907 64.7 10 64.7 L 10 64 L 10 63.3 C 7.52093 63.3 5.51345 62.9859 4.09826 61.6873 C 2.69039 60.3955 1.7 57.9668 1.7 53.2951 L 1 53.2951 Z M 10 64 L 10 64.7 L 13 64.7 L 13 64 L 13 63.3 L 10 63.3 L 10 64 Z" stroke-linecap="round" />
</g>
<g transform="matrix(NaN NaN NaN NaN 0 0)"  >
<g style=""   >
</g>
</g>
<g transform="matrix(NaN NaN NaN NaN 0 0)"  >
<g style=""   >
</g>
</g>
<g transform="matrix(NaN NaN NaN NaN 0 0)"  >
<g style=""   >
</g>
</g>
<g transform="matrix(NaN NaN NaN NaN 0 0)"  >
<g style=""   >
</g>
</g>
</svg>
</file>

<file path="public/notification.svg">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M12.02 2.91016C8.71003 2.91016 6.02003 5.60016 6.02003 8.91016V11.8002C6.02003 12.4102 5.76003 13.3402 5.45003 13.8602L4.30003 15.7702C3.59003 16.9502 4.08003 18.2602 5.38003 18.7002C9.69003 20.1402 14.34 20.1402 18.65 18.7002C19.86 18.3002 20.39 16.8702 19.73 15.7702L18.58 13.8602C18.28 13.3402 18.02 12.4102 18.02 11.8002V8.91016C18.02 5.61016 15.32 2.91016 12.02 2.91016Z" stroke="#787486" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round"/>
<path d="M13.87 3.19994C13.56 3.10994 13.24 3.03994 12.91 2.99994C11.95 2.87994 11.03 2.94994 10.17 3.19994C10.46 2.45994 11.18 1.93994 12.02 1.93994C12.86 1.93994 13.58 2.45994 13.87 3.19994Z" stroke="#787486" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M15.02 19.0601C15.02 20.7101 13.67 22.0601 12.02 22.0601C11.2 22.0601 10.44 21.7201 9.90002 21.1801C9.36002 20.6401 9.02002 19.8801 9.02002 19.0601" stroke="#787486" stroke-width="1.5" stroke-miterlimit="10"/>
</svg>
</file>

<file path="public/payments.svg">
<svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<rect width="26" height="26" fill="url(#pattern0_6_1250)"/>
<defs>
<pattern id="pattern0_6_1250" patternContentUnits="objectBoundingBox" width="1" height="1">
<use xlink:href="#image0_6_1250" transform="scale(0.005)"/>
</pattern>
<image id="image0_6_1250" width="200" height="200" preserveAspectRatio="none" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAACXBIWXMAAAPoAAAD6AG1e1JrAAAgAElEQVR4nO2dCXgb133gnyiJ4i1SvEGQ4C1KvmI3R+ukaS7rpHhTFA+J933gmMGcGNyDiyApiZbtbCK39W6cJun262bb5usm39ftt4m/tmmabpvE8dqt11Yc106a1PE6lhxb3O89YEDMAARIAhBJ6f35/T4AwxnM8f6/ee8NgHkA4MCBAwcOHDhw4MCBAwcOHDhw4MCBAwcOHDhw4MCBAwcOHDhw4MCBAwcOHDhw4MCBAwcOHDhw4MCBAwcOHDhw4MCBAwcOHDhQpCnAgQNHWGBBcOCIEVgQHLssdlc6YkFw3NHIzc3dmJzDoPlsWxgtoLm5OcgZxIXe83IuXIhDvwL5//uSzvl7jDjHo6dfRm9PT0x6EqS1tTUmGo0mJjseWJC7DSzInRMkNzcghYRCDizIbmR3CdLeei4me1+QkBTRiS+AkosK5P9XFmDCpES6XUzcY3JRRu/53pj09CRCD2hvaY3JXSFIZ2cnaGlpA+eaW8GpU2fA6dNn0XNYq8RK/p6efsT57r4gAxsg/b8PXIhDb5ecePMHuBBR8EkXcRNI64bbkxriHIeugejEWOb8JpHKuvd8gICA/aCzrQt0tHaA7s7zoL2lHTSfPoemwec9Xd2gRqORsecEaWlpCQrRjjh7phUUFaoOFBWqDhUXVWSXlWryyko1+WWlmoKy0poQqrJaGRXldQUV5Q0bUBdCXRabKgXqzVBeg6goq0aoSjR3HGndEtI2JZW4x6JhAzZeJrxs4oHKubS2QFVSA8lXlWjyjuSVZBcVlB8qyCs80Hy6FXS194DONihLJ3peU1WzxwTJORwg+PrsmXOg5VwHONfcCVpbesD5rqFDpMFSMjNF1Rh05ge0c/yj2jn+09o5/oR2jj+pnRMQunmzDP2CJYhNgUUGMR8bUkG8+YkFIYR+3oTQzfJ3HGndEuHblVTiHhObgtjzK8snFlJZa+eEE9o54dO6Wf7R+SnjA9ppsoY3WosnhmbTO5p7QNe5C6C38xJoP9u1Lgh8rKrZ5YIgOQrCST+cV1xUWFBRXVyoOXbqRNdH3M5rZ12OxwectquTTttVwm69YrFbr7ht5pVFm3llyWa+4pewCpcRFtPKOvwVOeH/M634bXx87FyAzcxr45cQdmFZhsO8cucQriDspssI5bbFZyWJXFEQe35l+WyEVNZW4fKSVbi8aDNfcTvMKxav/SrhMPknfY7Vfo/typmzn+v6yP0NHznWVPNw9fG6h4tqKhvSa6rqgIRGI5ck5TEwMLABfQiKooDBYAAsywOWEYDAOwBpsACKsAODzqwm9LZOmhQtArf4DEf7vimwS9/jGf+PONr3AmP0vMRS3pdZyvsKS3lfZSnvDcboeTUWwfk2hCbdMlhKDk2KrzJEAPTc6EoMyhkbxfwU4ZQRb38RpC86Rk/E/m5pedL3Kk14ZURbBxMXV9JgKfeNYFm9wlPulwXK85JAeV4QKM8PBcrzPQvn/6aF8z9j4fxmC+/r8DpX1bTRBgReBBxrBZSRA5SRQXlJUSQYHh7cgGFECgUJAMVgaBNgGQtQldWmVZQ3HOloHapbXnz6E17XF0ec1ieesgpXvyOwK68L7NIazyyvMaRvjSa8a5TBs0aTbhks5Y2Jcn4ljNEjgyZFGYzRJUP5/+hstD5xy8tTBpeMePsDj1Ms4h6fuMsvyoiYh4yzfZs+BptDWT485V4zGd1rAuVBmGjE6wLj+7bA+J6yW1ZHBG7x46dPdtd96MFHj/zWIx9Po0gT4DgToGkajI2NBRgfkROcngJBLq3TP4SsNeg5AC22W1dyzLz/tMvxhM3t/Pw3GNL/PEctv8Yal95iSN97UQtJcZBZyq1gpwWJkWRxkycySeHJIURoO10b4IkLEo1whtjW8mFEn891x1CWf1AIJe+ZKN9bJsr3mpm7/LyFv/IN0X7N6hGfOLXoeTLLoIMnbBuwmB1gbHQKjI1NrIuiECbJgqyLMdA/Agb6xlBz6qO/9ZlDVmG50iM+dcJuuQb7Bs+xxqWbDOlfM3NX13j6MkoIVGPEESS8sBFbPOOSelGGMuFJg0NGxPoi1u2JgysO8vllgsCaNO5ZON4JIZ7wWz2hpLaGoLdRg4TDka4gnjWO9En5ddNmXv2O0/rE4pLv+okV//Wq7s7hDJ51gdHhWTA6MglGR8eDjAYZRmz5y3vKL/GFy3Hx4iC4ODAKLg6Mg4v9k+DC+XHAGF2Ao30aq3DZYOGv/CnPLL8YqDH8t6EgErGr8O0nSGqbAPGbKIk2kRLff3EXHz9xy0gnp5AwRABJDOk1Q7jXGAOskf1rrHHpNk9ffsvMXX7JaX3iz63CZZqjPXU0KYKxER0YG50Dly6OhYmSIkFgzTEyPAV6uofBpYEZcPpkzyEzv1zncjxxiWeW/4Ihff8eKPjFdTGMS7I2rtT/2Fxy7IYCTm4Ta2tyYEGYWIIQ68cW5hXML472v8XR/m8J7NKowC4d7Wwbzhgf1SNJRkemky/IxYsXkSB9A5dA38AQuNA7AgYGJkFf3www8csau2XVauaXv81S3jdo0v0bVG0HN3ad9T5E9D6CYwN2SwEn+t7xlo+1/5sh0eW3+/6OHRQkQPjxDDZrP6BJ9895xv83Zn7Z6RGfqhm8uADGRhbA+Ngs6pOkRJCBS4NIkL7+MZCTozq4sGAut1lXu1nK+9cs5b3F0b6oAkSTIzJJ4h38nRZku8nj2APL7/T7i5sSZCM2yhHG6HmfMXq+bbesnreYlspUZfUHp6e0QUHGwcjICBIlcUEGh5Acg8PD6PnFS2Pg8GFVkUHvGLVZV7/CM/7XWMp9m6OhDJGdRuUVlZ2uwjG7CyrWRZIwtvf+7p/azFf+yCpcHq4oO1oMLypdHBgG4+OTYGR4bHOfg2xGkMHhUcT+g4fSsnMKD51t7nnE6/nC04Kw8jLP+N+DYkiCKDcyXBBFVRi8KrXzhYTZ/YJQ2xLF/Z7ALv2LzXzli6dOdD2cmVGQDsCBfYODw2B4aBRcujSUHEFg/6N/aAiA/emHOjoHKt3uxweslpXv8tzSTY7132Zo7xrLeNYYOpYg6zIkfmbA3C1QKRMEnYxvM0bPuxzt+Tsz7+sdHZ6tKMgvS4fNLCgHFCVhQYZGxgKSXBoGhwsrCuz25ZMOx5XLDO3+N5bxrUGgIBTlQmz1oOx0AWHuakHWICzlfl3gvMs2y+JjTY0P5kNBYA0C+9ZxY38UwgUJNK/GQd/ACCgurq7m+UU3y3i+byTdvzbC5hLlWYOPRqOISObBSF3bFLNboVKQH4zR9Q7Pev7BInhdmqomzcjwBLr4BDvq2xIkXBLYvBoamQCHDuXv/8QnznyY55b+O0N736YozwdQDJJwBSCdiDshBRbk7oVKjSAfsLT4tsB5v97R1vdIZmZuGuygX7zUn7ggsIl1KCMn7czZ89lm83Izz638PUMtfmAkvajmCJcDC4Khd5kgFGFHl6OhJDzr+e6i99rp890DWQCAfeMTm7jMu5EckiCwrVZwpDyD4zy1NuvqDM+tvEQZfWshQcLkwIJg6N0rCOyLvGi3+icZ2lydkZF1aHDo4vY76RLTU7Mg/3BZwfi48YRgurJEE+g3G+uXbHECY8g7mfBbPYHKPtC8YeZ9i2Ojc5/Lyc4r2NTX3WMLkgamp+ZBYUFF2eQEOyKYVv+IJtBXSrAgmLW9I4go5esbZt7/7NjIwlBOdn5Z0gQpK62pnJ+zkIJp9X8wpO8XYR/nY0Ewa3tIkF+Yef83xkYWDDnZ+ZXwdyJJEaSivK5Gq7U5BNPq3zKk71dYEAy9NwX5lZn3Pzc2smDLyc6vSaYg9foF27KFX/0BQ/rewYJg6L0pyDtm3v+/x0YW/DnZ+XXJFKRRv2B7wsKvvsSQvnelTjoWBEPvLUHeNfP+/zM2svB4TnZ+QzIFadIv2L5g4VdfYanFW+FfZceCYOi9I8gtM+9/ZWxk4Qs52flHky3I0xZ+9ScM6buFm1gYeo8IAj8HQY+Bb49DQX4yNrLwdE52flOyBblu4VdvbFWQ1J8hdj4J7mWoHRdgy4LcGBtZuJ4yQWjCeyv8DiM7fQB2OkHudagdFyA2pMEWuINN4C43WBAMFoTCgmBBdgvULpAAC7KL2ekEvdsTnEpyH8TGL92YHNVez8suaJocm8SCYEGwIFSYIBbOjwXBYKgYgkwML2BBMBgq2mVednFrgsTTJ64g8W7eHGcHlDebjkBxs+ktE+/9N71e23qHL9bNr+PezDpBNpUQsYiz/Ba3h9zu8d12OcQ5/nqHAlvgUSdCwgQpbJoanwL79u2LCRYEC3JPCSIwvjBBZsG+ffsTE2RmeiEkiNX0+L0jyGbXn+oESfHxSVRYcg8KMj40fz0/pyh5gqjKapt089aQINLGRztIEQcwzg7tekHucrAg+1MnSDJ2kNDFQW9LjHjvvynEDUjGe6dy++KxB04ghi3WiJsQZHrcgAQZH54E+9HfvhDbEqSstKZJO2sJCSIVDNwBZWEpd1CZsHtPkPhJtjflCHCvCWJmF5MryOyMNiSITbiGvs17dwuSWMLtuBBad2wiBHEruDcEKcgtToYgAMzOzoPSksom7Zxw3WZehbf8CQoSOLhxBdni/3fjWXZPkbAgW0HcA4I4IgSZGtMnTxB4/9LSkoomvVa4brdAQVyoDwIPNqn3RjlQWzvIuyJpYmDErG0MTDr3BohyNkrcOGxVENrgDMO1Rus94QQEGSWuH8kraRroHUxckMHBQVBSrGoy6My/L9pXX2OMrvcjBYmHd0OindWSldzJYOeT8C4RRLc9tlrjICnCCcnhg4/vm9ml1yZH9L+fNEHgyLbFRRXHCL3lGbfzyTfhIDmBppEYM/Fl6BY3ZLNNgZ0CJgFG3JCNBUkOW22RyGqMKKKY2aU3J0f0zxzJKzmWFEH6+y6CokJVA2mwXfa6n/pHlhZfIw2ONwmd401S794E3pgQOnEDHHL0th3BqMMYY0DpxJRC6rcGbXApcAZBr18zs4v/ODmqvXwkr6RhoO+iTI5tNrGGgaqsWiU6Vqavrjz9pN3qf9Zu9X/NZln6mpn3fzU+yzGxmJZkmGgPgmNcCpxRYWnHluApOVudH+NQIMbBjZDKVUJgfDLM7KIMC+dHSHmkzBOrsIxQTrfxYZgWv2oXfJCv2QU/5FmfePVJQstOFx8pU13qv5S4IHCgkaLCksMT49pP6rVs78y0bmRuVjeh17Ljei07pltgNgG3IfA9wiGC6HV0TAx6RgZhYDeFUS9nq/Nj2C3ChyB1HEIq42hI80gY9OtIORKeW9p5Wsb8NBFibsowNje1MDYzOT8+M6mdmJnQj9CkqXduSvfJooLiwwN9/UkQ5FI/SEtLO5CbU3C4pFhVUlJSUqZSqcorKysRFRXlm6BiQ9RqdblaDd+vAqEJUqVRB6iqiopGo5FRU1OzKWqr5Wx1fkxNGJoobDx/DSynqpry6srqDdGoNTIqK9dRq6sQFarKEKpyNUJ6rQ5SVVFVXlWhLleryoOg6WUVZVUlqlLV4fQDBw8M9PUmR5BLgwNo0MOBgUuB54N9aHpf33kwMTUUyeRIHMaCjICpqTEZ00Hk0yc2ZP29NsfUhJytzo8ZUzCiIPp805MTYUyBmanpCOB0yNTERIgJCCwHWblPgenpaQR8LjERXGZybDzA+Cjo7zsP+nsvgP7evgAXBsDgwEUweLEf9F04n7ggFRUVCsqBWq0ClZUV6FFdWRYJnB6kpkYjo7YaUgPqampBXU11iIbamqg01teCxrp6UF8fnYaGBhlH648Ggc8bQFNj49ZoaAqw1eU2WP7Y0aaYJLr+iPdsPB5go/dP8v4fDR7ndeTHH5ZdJI2gobYBUVdTj6jV1EVQU1WDqK6sUlAdQqPWhKiqqEKoVZVBKkBpaWlMEo64gsRBLkgNkmNdkHUaauuiIh1UuRiNIRoajspYL6AAUQtbSoLNksDy4ckakcSNxxNef/h7RSPV+39UcbyVQBl2TpBKUFpafqcFgWKoQWVlJXqUZJEITAv8HwKlCEfaeenASEgHTE5doAaprwX1MmLVIHIChVqvYKs1w/aXD0jRqCBGDbLF9W+uhkrd/h+NqEHkICGCZRiirj50ApROkNKJM5wajQZRXaWWEyaLRl0ZoqpCjYA1hwQSoax4Q5ImCEz66IKsyxBtmkajARpNDaiprkNsTZCG4EGtBvUN1QpJAjQ01q2jFKShLkrhxiJeYmx9+Ug55CS6/o3Ek8RM9f4fbahbRylIw/oJTonUhJaa2FLTWy5IJSJCkDA0lRUhIgUpVwhRmHxB6uoagFpdFRKkrKwMqFSqkCwBETQbAuXQaOpC1GoaEHXVjTIaao4iGoOg17XrZ6BotcfW+iCBAj3e0Chj823wTZ59N+yDRE/iRNe/+T7I9ra/Kc7ym+6DhNUeMWsQqYmlqEVComxQa6wTaGZJr0PNqaAQKlUZKCsvAYWFBckRBMoBkxzKAMWAK5MkgY9VVdUbC6KuAVWVtYhtCVKz3oaN1v+I3gc5FiSsDxJW4Mfrm2REtrlhuz1K32DT7Xf58sqEjdpHSGD9kf2O+4Mo3n+b298UZ/nIfof8+AfKL7wf0hinDxLID2U/BDW1gv2PaP2OEKrqAMHXgT7Iej+kuLgYlJSUoHxOSh9EVa4GJSVloaYVfF0BO0CoVqlCIkBJJKAU4WJUVdYjNFUNiFrNUURddZOMhppjUWmsbULU10kcl9FQf5+Mo3UPBIHP7wNN9fcHkApeer0hDwZRTN/m8scaHwwiJe6DMhJdv/L9jjV8KIDy/VO0/0eDx3kd+fFvrD0eJFCO0mupfKXyl/KitupYgODrmsqGAFV1oLqyFlSr64Gmoi5ElapWQX2QwOvSksogFQiYv2VlKvjhNxIn8mZXWwxYe6QfzNinrqjer9HUHaxU1xysqqxN12jq0qsq6yOoVNch1qc1IjRVTYjaqmOIOs1xGQ0190WlsfZ+RH1dkNoHZTTUPSTjaK2cpvqHgzwY5OFtsr3ljzU8EuRDQR6Rkej6le+38funZv+PKo63ksaaBwMEy1F63VD9AKJOcz+ituq+qNRUHg/SlF6tbkyvrmhK16iOhqgqb4xJaXHNOiWag/V19x+sVNftT9uXsU9VXpW4IHNzC6CsTH2ANFjyRfuVUovgVZlNngqBd6s4xqViKKcMmnTEJN78ZtaLELgAPOuRIU3fLtL7K9eDufOYeV8I5XTpOUuLCJhr4Uj5ED5Nmjcyv0QVY3RVwEersFw6PWHMz8spOTA3a0j0pg1BQUo1h0mD4+Oi/Vq3y/H4JdF+ZdhpuzpkM68MWYVlGRbTUkzizS8wvgDcogwz7w8951nftgm9f5BE3gvjSxipPDnaM8RS7g3zBeZaOHbrFYRyujK/RPvqkNP6+JDdcm3Ybrl26eryM90wl/PzVIenJhaSJkgtaXA4Rfu1vzLz/n8SOO/zPOt7nqXcCI72hJCmbUT4vNHmZ4yuEDQpIijCGXouET4fZm/CblD20cp5ozzaaDrMzxCM/3mBXYH8E8zh2SnWmZdTVjszrUuaIMdJg+NZ0X7tP3jWt8aznjWOhiPdiugxHPiDqljEmp8xuhDhdx+XpkX7H2bvwijKFRItPzaaX5kzEoH8XCcw3bPGkD4EzOHZKfbZ3OzS40kRZH5eC0pLNMf0C5Y/sAqXX2cp922WDmww/A1wvATGCY6hN4GUG9HESYSASN41llqE3LaZr7w+PUH/QW526bEk9EHSwPy8HgrSpF+wXLcKl2+wlPsWFgRD7yncazThhdyymFZuTIwZr2dlFjdNT2kTF2RuVofui6WbNyNB4F1NGMqJkh3e6hELgqH3kCBmfhkJkpNVggXBYGi5JDJBknAVa10QeOM4KAhNijJBdn7H720SHWBmp9dP3fFx0pdvjI/qr+dmFzdNTc5t78NBLMjeAQvi3KIg/pAgExOziQsC780LxweRBKEI5y2aDHTOdzo5MFgQaouCCNwiEiQvpyQ5gkgD6GBBdidYEOe2BRkfn06uIPASmVKQnT8AGIwzPqkSRBqjEAuCofYyqRRErapHl3mxIBhqr4IFwWCc96AgCQ+LvMPrT/XyqT4+hh0+/snllsAuBQTJLWoaH5+M+SHhpj4oxIJgQai7UpAjTePj41iQu379O719xJ4CC3LPrX+nt4/YU2BB9tr6438Y506Q3f1BJXWnyg8LsjfXjwVxYkF2c4Kmfv32mOx+QRwx2XEBsCBYECyIcy8LYt9oY6ImwFZ3MOGB5hXzbzXBtzpOd8TA9ilOgJ1uYtEJC36n1o9eB38wRVw/nFfYBAfcSUtLi0nyBImaeFgQLIgbC7KrBUkwYXe/IDstgIgFwYJgQWgsyPYECXTWoh2I8P9tXpB4TaS9JkiqBdp5AUQsCBYEC0JjQe5WQWwyIi+17nVBYl+GxYK4d4sgERuzSwSRS4IFwYJM3FlBtkZEARvkUHqHDKPOJkP5/2Q3wSISWLG+ra5/7zeRxF0uQGwYwh0EPhdvWbjlG1OjxPWCvMKmKSwIFgQL4r7LBdHKoXSinHgJnGJB4hHYL/vG7HiCY0HSsCBYECyIuDsFiXtza0JONGGkx2hNLEYnbggSKKyzTehtkc2cOGJt1ORbT36XjHgCK/dvpxPo3hHEDbll4fw3psb0d40g75Fa81sM6fg5bbC/SSwIbxp1FhmU1iaD0TnkEOKbNIn4OU2Kb1GE871EBKENzvcpveMdUmv9JTFv+Rmptb4ZC9rgfBNuuwRDOsL5GWlw/JI0ON4hDY7bcH07nVBYkLTdJohsB8LksP+GNthf5ynHc2bO/XW74Pua0+r/ioX3fDUcGyfHYfKF4f+qXVj+ipn3f41nPV9nafE5inC+ThHO38Rr4oUEUdQEJtr1CzPr/aGNX/qWXVj+r2bW+zUz6/2KmfV+FWLhfTLMnFtGcLvhfvyRhff8CUM5v8UYXf/MGF3vwKHCIhNvpwUQsSA7J4hcDoZwf0AbnL+mDfaf0Ab7X9OE9RlSx9nmpnTz0xMLEwszhtHpiYWxcGbH5SxM6UPMTxNjujl2VK/lJyjSOs/Soo0i7M9QhPOvKcL5E4qA63J+sJEgSKKAIL+h9I6fUXrbDxammT9ZmKFW5qeM1NwkOTk9rhufHteNTo/rxiBzUwYZCzNytLMkZFQ7S45oZ6kpirRSFGFfpgjn1ymD659p0v1LmnTf3i0JRmNB4t+bt1LdEBqCTRr+QBpAMd4GcqRLxnpzKrjRBm8AVHu4fs0Q4o9NtOsPLbynTWAdx37no5+ozjyYXZGblV+enZFbnpN5uDw/50h5YX4JeoTT4bRw4HzZGdnlOZk55QV5heVFBaXlR/JKKh77dHO1mfUeM9GudqPO9gxHul6gDa53lf0ICbhNPNxPQvwlS7n/1Mz7yN/52Gc/nnEovz4r63BVxqEcFVxHOLlZeYj83HwZBXkFIYLTyvKyC1RZmQVVXR0DDXbrlQ/ThHeaJt3foUn3r2nC+wEaFWkXJBm9lwmd/FCZ3jKzizcmR7XX83OONE2OTe4tQRhC/KlRZ/nPZs59kSbMBfoFChTmF4KigmJQXlIOSotK0fMjh4+AgrwCkJdzGORk5oDsjGwZcFpOVhbIzc4BbedaQEdbG2g52w7amrtAe3MvsPC+AmJBuGjU2f4LbXC9vpEgsHah9I6bAuP5J5tlyXjubM8jWZmF+841t4OO9g7Q2dmO1hFOXk5uBPm5eTLC/6fTGsDsjB7Mz5oAz/ibaNK9SJPu79OE920siJgaQUb01/NzivakIN8TGM95E+0s/ezvndxP6ikkRHFhESgsKAClRcWg6EghKMg7jJJLSkooAyQ7IzMkRoAs0NbSDM6dbQbtLVCQDtByphv094ztt/C+UoHxXWAI9z8o+0HhlwXNrPcGZ7R/6dOfOv1oVmZBTk9PPzh//jxoa28BF3q7QH5eTkTyK6XZSBzI3Nwc0C4QQDvHg1OPXcinSfenaNLtpgnvK1gQEQsSlOMDhnC/yxDinxl1wgPaWQoszOqAXmtAYkApyktKkRhHDuejR4jyjCxPSihKFmg+cwp0d3aBzrYu0NHaBVrOdiJJgjXJgwwh/jlsZgW3QSnI2zbT4t9ODC/YMg7lV7S2dILu7h5Uc3R0nANt7c0gJysjJGg4mxWEIAig1xmBXsuDksL6NJp0F9Kku4cm3T/AcoipEWRPNbEC3GQI8RWGdHyxs7XvqHaWBLD2IPUkqj2kGgTKsXlBAvR0dYPO9g7Qdq4N1SJd7T2gu+MCEuXEZ1qPWlnvdVbvfJVacNxk9a41nvAggtv7M4Hx/LFujp3Iyykp6+q8ALo6z4Ourg7Q1d2GyMrOAFlZWRHk5OTIyM3NRSgFYSga6Ob1QDdvBHOTJKANrv02fuWTjNHzvc2MA77jCUjucu4OQcSbDOl4mSFtTx5r+FC9bh42ObTAaDBGyLFVQdpbWhEdrR2gq70bSdJ8+hyqTQoPl9WT88JTPOn6vybSe5MzuJWCvOEwL31JO8sM5R8uK2051xUUpCskSaKC6LU6QOjg/uoBoWUBbXACG7/y24zR9V0siJgkQVxrtN6z1wSR8T5DOn7JkLZnVUWaBsNcQBBSb4iQY6uCwE46rEFgp7qtrQ10dXSiaVCa0sLyBmKB/zJDiP/BU+734bbAq1Zh/NzC+f9MP2+aLzpSVd7R1ge6OiEXQpJEk2NrgiwA3YIW6BdIMD9NANpg32fjlz7LUM7vS4OlYkHEe16QNYZ0vMeQtm92NPf87pGc4kx4RoVND3jFSgm8ggXJz81HwKtZkNysvAhg36Onqwe0tXUE+g9tXagWOXI4P6v5dOvvCqzjW7TB/h6ptaKDqdjetwXG9w92YXnx3Jnexs72i6CrYyAoyXlEVlZOVHKy82Tkwu0Lbmc4C7NzqCk5P6MFDTX3HWBIR8sjQwgAAA77SURBVLWF900xlPMFLIi49wXZ6te3lWJwhiCE4zZHOH5k4zxz3S19TZn789L0sySYn9SB+akFlEDhwE58OFAoGQsEGsIajtIL90ECTi88Upo2PDh5jKHN87TR9iOKsN+WfmDEGZ2IYAK+T+rFt23mlb+0W6988vTJ7n2wM00SAtDOG4FOS6L3D2duagERb3slSB2DWJgxgMba+3N5Shwws94vcUbnG2hbpBMLFmQtFYIkfOO4OygI5GcC5XqW0lomP/rQ7z1UU9FUUq06mlutasioVjemV6sbDwYf02sqmyKQ/qepaEivVIc4GHzMqFQ35FaqG0pOPtb6kNnkmeIY55dpo+3N8F/gKQRZYynvGmP0/IvdssrNTZserat+uKqy4lh+TdUDWbXV96dXqZsgB4OP6dUVAZTbVlt1LJyDAe5Lr9Pcn3W09qGCmsrjVY99qu2zAuP5Tyba8wOOdL0jq3mxIGv3pCAK3uNJ1xtWZvE5ziC6iVlzL21wfow2OOsYQlQzhFjOEKIKwpGuCKT/0QaniiJClFOEU02SzjqSdH6M5xf7BGHJQ1Gu54xG8Q2aFN+TbR9s1lByQQid49cstfiChV/9Y4G9Mk9o3Z+hDL77DAuuKoPWWWHQOssNWrsKwhBuBEd6ggS2jafc4ZQjjN4qE+W7z8wunaR0IiXQ/i8JtP9FjvS8w5GeDzgSXiwIgAURsSChq1s68aaVWfobgfY/bWaXBDO7NG3hlkcs3PKghVsesrCXh2z8FRl201UZNvMqwipcHbQKV0fMwtVpQVgReG7p91nG97cU5blpjPo5Q+RvueF9vuCHdhZ+9ecCs/rf7ObPe2zCk3oLf23Uanp82Gp6HK4DrmvIzKwg4DaGo9jeQRt/5ZKNvzJq46/oLezlJQt7+VsCvfyqifJ/wJG+kBhYEDGll3l3nSCb3KnbDCH+iiHE1znS9a/wO1M85X4eYqI9z5soXwiB9keFZwJwtA/BMr4XGNr9rxTlet1oFH9lNIq3jUalFNFuzgx/1BT4ciZj9PyGIX0/Z0jfKyy1+CJLLf6YMXqeD+BCcGQ0PM/zRi/CRIb4kYn0/thEel80kd4bPOH5JU94bprIxTWewILQSRYEfsbF6l23rMzijamRPSyI8n2kNrji8uuGmGgPggsCtxNtK+1eoygXAoohEU0I+d3XN3OHkPV5TLQrBE8FLhuH9yWkz1nigQURUyfI8PpXTZIuSLzhD7a6A+HJClG+D/yNBAT2BSC8cXNI80vLU1QA5foiBZXfDiieEIE+i32NpR2IgBRimCBiqOOPBFFgMrplSNMjLo9jQdawILtSkGi/bZDEcK6xtIjgGBd6lAkBr4bBecMJXrlbF0RECNT68/DlsSDinmliPW0VLv8k1QPo7PgB3SKb+TqIEmXtsNnaAgsiboPA15ng14g4g/uWjfX/ZGZU/3RBsm4cFybIF6zC5VewIIkLkkx2ev/pvSXITRvrf2VmVP+FgrzCo8kUpFG/YLlmFS6/SBHOd6VhDZItBxYEC0KnVpBf21j/CzOj+tWCvMKGpAlSUV5Xr1+wLFlMK/9MEc53sCBYEHpvCvL/bKz/H2dG9b6CvMK6pN2bV1VWW2PQWu1mfvlvaFL8VSoFudPC7PT6MeIdEkRcMxnEtxzM8nMzI4S1IK+wOmmClJXWVBq0VkJgl/6SJsVfYEEw9N4U5N8dzPI3hnqnDYcOZKmTIsjU5BwUpMygtQ4L7NKXWcr9xmaTCwuCoXdXE+sNG7v8paHe6aFDB7LKkiAIABMTU6CsVFNg0FofE9glP0t5b0grT8b4FjudoDu9fox4JwW5YWOXfTMjxOcK8goLkiLI+PgkUJVVZzCUs9piWpniaN9LcKXwC3ybub1/PDYcpjlJCbvXBcaICSF9ATYoyIse67UJ1mDX5OccOdTX05/oB4UAjI1NgIMHMtMu9IxmmXn/GZ7x/z1Nuj+ASUzoEqxBkGTuIFgQjJgiQcTbnMH9Pmdwf9fKLJ7ubhnIBGD/vt7zvYkLMjg4DIaHxsHB/blpLc19jwjc4tcZo+dtyuD6AAuCBaF3OaF7HhDutxnC/fUP3ffxR7LS89Mu9Q2BS/2XEhdkeGgUTEzMguHBSdBY/7BG4Lwuxuj6Prw9JhYEC0LvDUHegTclZEiHs/SIRjPQOwz6L1wCSWliTU3OgJHhMVSLPPTAR/KtFs8JQm9Z4WjPv6G+SJIFUQ6dluoET/UgmzvNTp9AqB3eP/hzAwvnf93C+5ZEm/+zDTXH8gd6B8FA30V0M4+EBRkdHUe1CJSkqLAsXa+j1Vazr4+jPd9ljJ6bFOG8ve0dxIJgiJQKAn94967AeP7Owrt6m0+3l2emZ6b39/ah5lVS+iDwMi/sh4yOjsLLXvtKilXp05P6h828/2lC53g5YkCaJAuS6oS92wW52/ePji3Iexzp+heeEr/44Q89+nD6/sz0A2lp+wYv9oO+CxcQSemkQzkGhy6C/v5+9Lq2+nixzbwyYjGtfDk4zsa2a5GAEFiQVAGHnYvFTm8flTRBwn7EFviO2m2aFF+z8UvPTo7ohzIP5hYPDgyCvgvnQW9PJxi6NAB6e5LQxJqengYzMzNgenoSPcL7Sj30wMcOuhyPlwvsUjtHe74FB6LZdmIGhYAdfsiWh3GONww05q6Cki7iBAnJYbQh4K87gz8Jv8nRnr8S7audczNMWcahvIMXLlwAnZ2t6MbjHR2toLu7M74AWxUEfvVkeHAazEwywOV4okLgFk2M0fU/KcL5b6GhzeJcicKCYMikChKQJPhr0Pdp0vEmz/q+beb9VouwWNXW0gfgsBXNzc1IDnhP5fM9XckSBIoxFRJlfHwazEzrwMwUCS4NzKRbheVajvZdpAyuv6AMrn8PbLgnSNjObFMQZZMAC3JvQynySTnkG2P0/Adj9HyTpdwjHONqfOC+j2V0tveD8919aFwXSQyJJAsyh756Ar/hOz2lRZJwjAsI3GI1Y3QZKIPrTymD50XK4HmLMnhuQ0lCO6do02NBMOQ2kL7mpBDkNk1436IJ74tW4eqf8Yyfpgh7nUFnAq0tPaCt9Tzo7upF92bu7u5OrSDTU7NBApLA+9R2dVw6tOh5stLM+x8z88uLLLX4HYb03YwmiLLjG/egpLiJtZGYyqpc+u5Z+DKJsJn1bYadTlhqG9sZ6zhsdn1wWYMW/uzCvcYz/ps8s/wd0fakz+/94gmWFqvuv+/DGXodDdraukBnR09IEPjZBxwzpqe7E5E6Qaan0SNlZABJcECvZYHLeTXbIz5xSrRfs8ImF6kXn6cMrtcogys0PrlSlN0iiHTAIfoFWwTS/ySSIUn4OrdLtG29kxg2uZ3xThBbLKv3aNL9FmP0vAZvCmjml//CaX3cyrO+k2bel02RZnRjcYIwgo72wJguqPbo6g0Ksi5JagSBckxPIiiKBFqtFhAGGtTVHkv78COfPNLWMlBn5v2PWkwrwxzte4qjfd/maM9POcZ1W/qZ6KYTHAuCBdGv1x7wi7Is5f2pwC79LzO//KRovzZMk+KjDXUP1RXkqwqKi8rTDAYSQFiWBZ2dncFmFWxe9YCezt47KwhpNACdbgFtDEkGahPY7JqfZYBFWKwQOG+HwHnNAuf9Q4HzfpNnfd/jaM8PGaPnxzTpfonUiy+TevEVUi++SurFG8HH6BgckcSafxMQOgdCOZ0yuCJQLpMIm1nfZkh0/xOF2sa2xjoOYTkAc+JlUg9zxP1jUi/+kNSL3yMNjr8k9LY/0GsFQTdvajfozBWwL0wYAvk3Pz8PGIYBJAklMaBBjgL9jYAkSa9B1iNNQSBKS0sRFRUVQFWuDqMKkl6jOVpUX3e8uq7mvmPdnYMf8bgeP+MRn+pzOz8/IdqeNDitT5jtlmtuu+Xaos28umQzr/qtwlWEhb+CMHOXA89NKyGswmVE+LQASwpWUsxSTGx8arFw/piY+Z3FEjwOVmFZhs28glC+tplXlmzmlUW79Yrbblm1OK1PGezmJ2Gu9Locj5/+7Y9+5sO52cVNWVmHNXm5R4oyM3PTMzNzQYD1IcADZIADafCL7QDsB/vkwGn7IrM6epZvSQw5MkFUqgjONbcCODps89kOcO5sNxgZmkufn+WKpsap6rkZ7oGZSeZ3ZiaZT89OsSdmp9iTEnMzHEL5em6GQWjneBm6eVOABU6OND1VKNenQD+fWnRzbEy08zvH/CyDmJuhELPTRsTMFBliepIIMTVhQEyM609MjOs/PTFGPDo7xT8wPmKsNmithd2dgwdPn2oFn/vsKXD69GnwqU99KnJkLyhIUJLszEMhEXafIMGapPlsCzh9+iw419wOms+2gZZzHSD/cMmBokLVoczM3KzCI6V5hUdK84sKywrCKS4qR5QUqxClJRUyVOVVQdSIClVlitDEIfby6hRTUaaOiXR8dorKSk0ItboKEX58wuctK1MVlJWppTLOLy2pyCsuqsjKP1xyKDen4EBAjLPgsc+dRIKcPXs2qiDZGdkgOyMToRRCyY4LcvLkaTQ+YEtLG+LcuXOgtbUVDajZ3Hwm8OFNkEA7sRsNkCk9l+jp6ZEBvzYAUU5HXOhOHtHefwvr6+1JLRfOd8UEfjC2m+hRHJ+I6YrylUSAj6dOnQInTpwAJx47hSSBuQWbVeEE5NhDgsAaAzaxAoK0gJaW5gCtZxCwExVNEonw/0GiJ2mvggSkiSvEJtYVRu8O07PLOa8oXyVQglOnzqBHKEaAMyEyDuUEyMhC7DlBkBznAjUIrDnC5UiOIMqEjZK4Sa01sCA9Oy7IOpIYe0cQ2ZUsdahp1drajpDVIi3NqDklF6RTRkQVvaUzvCRH5xZRyrKRhFiQnpQLchI1reDjiROfiyAjI2PvCyLJAa9owT5IQJIAd0aQRPsgWJCeHRfksRiCZOykIDh2MhItQJwA8rjX9/+uCyxIcuNe3/+7LrAgyY17ff/vusCCJDfu9f2/6wILggNHjMCC4MARI7AgOHDECCwIDhw4Uhb4BIEDR4zAguDAESOwIDhwxAgsCA4cMQILggNHjMCC4MARI7AgOHDECCwIDhw4cODAgQMHDhw4cODAgQMHDhw4cODAgQMHiBr/H2FDrH77cf/rAAAAAElFTkSuQmCC"/>
</defs>
</svg>
</file>

<file path="public/quotation.svg">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M9.89404 6.6416H13.1201M9.89404 10.3285H15.8852M9.89404 14.0154H15.8852" stroke="#242220" stroke-opacity="0.56" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
<path fill-rule="evenodd" clip-rule="evenodd" d="M20.8734 14.8102C20.9547 14.0117 20.9547 13.0117 20.9547 11.7497L20.9547 9.14727C20.9549 8.18134 20.955 7.55842 20.7869 6.96887C20.6948 6.64565 20.5658 6.33413 20.4024 6.04044C20.1043 5.50473 19.6638 5.06435 18.9806 4.38148L18.8369 4.23773C18.154 3.55459 17.7136 3.11402 17.1779 2.81598C16.8842 2.65258 16.5727 2.52354 16.2495 2.43141C15.6599 2.26336 15.037 2.26349 14.0711 2.26369L12.8896 2.2637V2.2657C12.0275 2.27087 11.3018 2.28939 10.6895 2.35574C9.81826 2.45013 9.09478 2.6479 8.47272 3.09986C8.10103 3.3699 7.77417 3.69676 7.50413 4.06845C7.21632 4.46458 7.03158 4.90185 6.91099 5.3922L6.15529 5.59469C3.81968 6.22052 2.43362 8.62123 3.05945 10.9568L5.0872 18.5245C5.71303 20.8601 8.11374 22.2462 10.4494 21.6204L15.7912 20.189C16.8115 19.9156 17.6505 19.3036 18.2198 18.5063C18.4998 18.4087 18.7617 18.282 19.0089 18.1168C19.4869 17.7974 19.8974 17.387 20.2168 16.9089C20.616 16.3114 20.7902 15.6284 20.8734 14.8102ZM14.0821 3.64631L13.9695 3.64628C12.5854 3.6463 11.6001 3.64775 10.8384 3.73028C10.0848 3.81192 9.63247 3.96621 9.28538 4.21839C9.03107 4.40316 8.80743 4.6268 8.62266 4.88111C8.37048 5.2282 8.21619 5.68055 8.13455 6.43412C8.0515 7.20062 8.05055 8.19351 8.05055 9.59139V11.7113C8.05055 13.0203 8.05139 13.9499 8.12467 14.6703C8.19678 15.3791 8.33327 15.8083 8.5554 16.1408C8.77396 16.4679 9.05479 16.7487 9.38188 16.9673C9.71432 17.1894 10.1435 17.3259 10.8524 17.398C11.5728 17.4713 12.5024 17.4721 13.8113 17.4721C15.1202 17.4721 16.0499 17.4713 16.7703 17.398C17.4791 17.3259 17.9083 17.1894 18.2407 16.9673C18.5678 16.7487 18.8487 16.4679 19.0672 16.1408C19.2894 15.8083 19.4258 15.3791 19.498 14.6703C19.5712 13.9499 19.5721 13.0203 19.5721 11.7113V9.40704C19.5721 8.953 19.5706 8.682 19.5445 8.48778C19.5325 8.39878 19.5184 8.3542 19.5102 8.33413C19.5083 8.32948 19.5068 8.32642 19.5058 8.32464L19.5046 8.3224L19.5023 8.32113C19.5005 8.3202 19.4975 8.31871 19.4928 8.31679C19.4728 8.30853 19.4282 8.29444 19.3392 8.28247C19.145 8.25636 18.874 8.25489 18.4199 8.25489L17.457 8.25489C17.058 8.25494 16.6923 8.25498 16.3947 8.21498C16.0671 8.17093 15.7207 8.06728 15.4359 7.78245C15.1511 7.49762 15.0474 7.1513 15.0034 6.82365C14.9634 6.52611 14.9634 6.16034 14.9635 5.7614L14.9635 4.61409C14.9635 4.25307 14.9625 4.03783 14.9455 3.88062C14.9355 3.78814 14.9227 3.75025 14.918 3.73926C14.9046 3.72119 14.8886 3.70519 14.8705 3.69176C14.8595 3.68703 14.8216 3.67428 14.7291 3.66426C14.5849 3.64864 14.3918 3.64655 14.0821 3.64631ZM15.4599 18.8463C14.9767 18.8547 14.442 18.8547 13.8496 18.8547H13.773C12.511 18.8547 11.511 18.8547 10.7124 18.7735C9.89427 18.6902 9.21124 18.5161 8.61376 18.1168C8.13571 17.7974 7.72525 17.387 7.40583 16.9089C7.0066 16.3114 6.83242 15.6284 6.74919 14.8102C6.66795 14.0117 6.66796 13.0117 6.66797 11.7497V9.55038C6.66796 8.49853 6.66796 7.61717 6.71172 6.87695L6.51313 6.93016C4.91508 7.35836 3.96673 9.00096 4.39492 10.599L6.42267 18.1667C6.85087 19.7647 8.49346 20.7131 10.0915 20.2849L15.4334 18.8535C15.4423 18.8512 15.4511 18.8487 15.4599 18.8463ZM19.1942 6.71263C19.2263 6.7704 19.2565 6.82919 19.2848 6.88888C19.0385 6.87224 18.7591 6.87227 18.4612 6.8723L17.4982 6.87231C17.0442 6.87231 16.7732 6.87084 16.5789 6.84473C16.4899 6.83276 16.4454 6.81867 16.4253 6.81041C16.4206 6.80849 16.4176 6.807 16.4158 6.80607L16.4136 6.8048L16.4123 6.80256C16.4114 6.80078 16.4099 6.79772 16.408 6.79307C16.3997 6.773 16.3856 6.72842 16.3736 6.63942C16.3475 6.4452 16.3461 6.1742 16.3461 5.72016L16.3461 4.58156C16.3461 4.34944 16.3461 4.13127 16.3359 3.93665C16.3934 3.96399 16.45 3.99317 16.5057 4.02416C16.8519 4.21675 17.1516 4.50774 17.9311 5.28725C18.7106 6.06676 19.0016 6.36646 19.1942 6.71263Z" fill="#242220" fill-opacity="0.56"/>
</svg>
</file>

<file path="public/right.svg">
<svg width="15" height="24" viewBox="0 0 15 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M0.833348 1.33398L11.94 9.38732C14.908 11.5407 14.908 12.462 11.94 14.614L0.833348 22.6673" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</file>

<file path="public/Vector.svg">
<svg width="14" height="65" viewBox="0 0 14 65" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M13 64.7C13.3866 64.7 13.7 64.3866 13.7 64C13.7 63.6134 13.3866 63.3 13 63.3V64.7ZM1 0H0.3V53.2951H1H1.7V0H1ZM1 53.2951H0.3C0.3 58.1048 1.30961 61.0286 3.15174 62.7189C4.98655 64.4024 7.47907 64.7 10 64.7V64V63.3C7.52093 63.3 5.51345 62.9859 4.09826 61.6873C2.69039 60.3955 1.7 57.9668 1.7 53.2951H1ZM10 64V64.7H13V64V63.3H10V64Z" fill="black"/>
</svg>
</file>

<file path="public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="README.md">
# React + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## Expanding the ESLint configuration

If you are developing a production application, we recommend using TypeScript with type-aware lint rules enabled. Check out the [TS template](https://github.com/vitejs/vite/tree/main/packages/create-vite/template-react-ts) for information on how to integrate TypeScript and [`typescript-eslint`](https://typescript-eslint.io) in your project.
</file>

<file path="src/api.js">
// src/api.js
import axios from 'axios';

const api = axios.create({
  baseURL: import.meta.env.VITE_API_URL,    // uses your .env values
});

// helper to set (or remove) the auth token
export function setAuthToken(token) {
  if (token) {
    console.log(token, 'token is here');
    api.defaults.headers.common['Authorization'] = `Bearer ${token}`;
  } else {
    delete api.defaults.headers.common['Authorization'];
  }
}

export default api;
</file>

<file path="src/App.jsx">
import './index.css'

function App() {

  return (
    <>
    <div>
      <h1>Page live</h1>
    </div>
    </>
  )
}

export default App
</file>

<file path="src/assets/react.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="35.93" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 228"><path fill="#00D8FF" d="M210.483 73.824a171.49 171.49 0 0 0-8.24-2.597c.465-1.9.893-3.777 1.273-5.621c6.238-30.281 2.16-54.676-11.769-62.708c-13.355-7.7-35.196.329-57.254 19.526a171.23 171.23 0 0 0-6.375 5.848a155.866 155.866 0 0 0-4.241-3.917C100.759 3.829 77.587-4.822 63.673 3.233C50.33 10.957 46.379 33.89 51.995 62.588a170.974 170.974 0 0 0 1.892 8.48c-3.28.932-6.445 1.924-9.474 2.98C17.309 83.498 0 98.307 0 113.668c0 15.865 18.582 31.778 46.812 41.427a145.52 145.52 0 0 0 6.921 2.165a167.467 167.467 0 0 0-2.01 9.138c-5.354 28.2-1.173 50.591 12.134 58.266c13.744 7.926 36.812-.22 59.273-19.855a145.567 145.567 0 0 0 5.342-4.923a168.064 168.064 0 0 0 6.92 6.314c21.758 18.722 43.246 26.282 56.54 18.586c13.731-7.949 18.194-32.003 12.4-61.268a145.016 145.016 0 0 0-1.535-6.842c1.62-.48 3.21-.974 4.76-1.488c29.348-9.723 48.443-25.443 48.443-41.52c0-15.417-17.868-30.326-45.517-39.844Zm-6.365 70.984c-1.4.463-2.836.91-4.3 1.345c-3.24-10.257-7.612-21.163-12.963-32.432c5.106-11 9.31-21.767 12.459-31.957c2.619.758 5.16 1.557 7.61 2.4c23.69 8.156 38.14 20.213 38.14 29.504c0 9.896-15.606 22.743-40.946 31.14Zm-10.514 20.834c2.562 12.94 2.927 24.64 1.23 33.787c-1.524 8.219-4.59 13.698-8.382 15.893c-8.067 4.67-25.32-1.4-43.927-17.412a156.726 156.726 0 0 1-6.437-5.87c7.214-7.889 14.423-17.06 21.459-27.246c12.376-1.098 24.068-2.894 34.671-5.345a134.17 134.17 0 0 1 1.386 6.193ZM87.276 214.515c-7.882 2.783-14.16 2.863-17.955.675c-8.075-4.657-11.432-22.636-6.853-46.752a156.923 156.923 0 0 1 1.869-8.499c10.486 2.32 22.093 3.988 34.498 4.994c7.084 9.967 14.501 19.128 21.976 27.15a134.668 134.668 0 0 1-4.877 4.492c-9.933 8.682-19.886 14.842-28.658 17.94ZM50.35 144.747c-12.483-4.267-22.792-9.812-29.858-15.863c-6.35-5.437-9.555-10.836-9.555-15.216c0-9.322 13.897-21.212 37.076-29.293c2.813-.98 5.757-1.905 8.812-2.773c3.204 10.42 7.406 21.315 12.477 32.332c-5.137 11.18-9.399 22.249-12.634 32.792a134.718 134.718 0 0 1-6.318-1.979Zm12.378-84.26c-4.811-24.587-1.616-43.134 6.425-47.789c8.564-4.958 27.502 2.111 47.463 19.835a144.318 144.318 0 0 1 3.841 3.545c-7.438 7.987-14.787 17.08-21.808 26.988c-12.04 1.116-23.565 2.908-34.161 5.309a160.342 160.342 0 0 1-1.76-7.887Zm110.427 27.268a347.8 347.8 0 0 0-7.785-12.803c8.168 1.033 15.994 2.404 23.343 4.08c-2.206 7.072-4.956 14.465-8.193 22.045a381.151 381.151 0 0 0-7.365-13.322Zm-45.032-43.861c5.044 5.465 10.096 11.566 15.065 18.186a322.04 322.04 0 0 0-30.257-.006c4.974-6.559 10.069-12.652 15.192-18.18ZM82.802 87.83a323.167 323.167 0 0 0-7.227 13.238c-3.184-7.553-5.909-14.98-8.134-22.152c7.304-1.634 15.093-2.97 23.209-3.984a321.524 321.524 0 0 0-7.848 12.897Zm8.081 65.352c-8.385-.936-16.291-2.203-23.593-3.793c2.26-7.3 5.045-14.885 8.298-22.6a321.187 321.187 0 0 0 7.257 13.246c2.594 4.48 5.28 8.868 8.038 13.147Zm37.542 31.03c-5.184-5.592-10.354-11.779-15.403-18.433c4.902.192 9.899.29 14.978.29c5.218 0 10.376-.117 15.453-.343c-4.985 6.774-10.018 12.97-15.028 18.486Zm52.198-57.817c3.422 7.8 6.306 15.345 8.596 22.52c-7.422 1.694-15.436 3.058-23.88 4.071a382.417 382.417 0 0 0 7.859-13.026a347.403 347.403 0 0 0 7.425-13.565Zm-16.898 8.101a358.557 358.557 0 0 1-12.281 19.815a329.4 329.4 0 0 1-23.444.823c-7.967 0-15.716-.248-23.178-.732a310.202 310.202 0 0 1-12.513-19.846h.001a307.41 307.41 0 0 1-10.923-20.627a310.278 310.278 0 0 1 10.89-20.637l-.001.001a307.318 307.318 0 0 1 12.413-19.761c7.613-.576 15.42-.876 23.31-.876H128c7.926 0 15.743.303 23.354.883a329.357 329.357 0 0 1 12.335 19.695a358.489 358.489 0 0 1 11.036 20.54a329.472 329.472 0 0 1-11 20.722Zm22.56-122.124c8.572 4.944 11.906 24.881 6.52 51.026c-.344 1.668-.73 3.367-1.15 5.09c-10.622-2.452-22.155-4.275-34.23-5.408c-7.034-10.017-14.323-19.124-21.64-27.008a160.789 160.789 0 0 1 5.888-5.4c18.9-16.447 36.564-22.941 44.612-18.3ZM128 90.808c12.625 0 22.86 10.235 22.86 22.86s-10.235 22.86-22.86 22.86s-22.86-10.235-22.86-22.86s10.235-22.86 22.86-22.86Z"></path></svg>
</file>

<file path="src/auth/AuthContext.jsx">
// src/auth/AuthContext.jsx
import { createContext, useContext, useState, useEffect } from "react";
import api, { setAuthToken } from "../api";

import { useNavigate } from "react-router-dom";

const AuthContext = createContext();
export const useAuth = () => useContext(AuthContext);

export function AuthProvider({ children }) {
  const navigate = useNavigate();
  const [user, setUser] = useState(null);
  const [token, setToken] = useState(localStorage.getItem("token"));
  const [loading, setLoading] = useState(true);
  const [rolePermissions, setRolePermissions] = useState(() => {
    // Try to load from localStorage for persistence
    const stored = localStorage.getItem("rolePermissions");
    return stored ? JSON.parse(stored) : [];
  });

  // Sync axios header & fetch profile if token exists
  useEffect(() => {
    const initialize = async () => {
      if (token) {
        // 1. Set axios header
        setAuthToken(token);

        // 2. Try to load user from localStorage if stored
        const storedUser = localStorage.getItem("user");
        if (storedUser) {
          try {
            const parsed = JSON.parse(storedUser);
            setUser(parsed);
          } catch {
            setUser(null);
          }
        }

        // 3. Load permissions from localStorage if available
        const storedPerms = localStorage.getItem("rolePermissions");
        if (storedPerms) {
          setRolePermissions(JSON.parse(storedPerms));
        } else {
          setRolePermissions([]);
        }

        // 4. Optionally, verify token by calling a "get profile" endpoint if available.
        // If your API has something like GET /user or GET /profile:
        // try {
        //   const profileRes = await api.get('/user'); // adjust endpoint
        //   setUser(profileRes.data);
        //   localStorage.setItem('user', JSON.stringify(profileRes.data));
        // } catch (error) {
        //   // Token invalid or expired
        //   console.error('Token invalid, logging out', error);
        //   logout();
        // }
      } else {
        setAuthToken(null);
        setUser(null);
        setRolePermissions([]);
        localStorage.removeItem("rolePermissions");
      }
      setLoading(false);
    };
    initialize();
  }, [token]);

  // --- Periodically refresh permissions every 10 seconds ---
  useEffect(() => {
    let intervalId;
    const fetchPermissions = async () => {
      if (user && user.role) {
        // Skip fetching for admin role
        if (user.role === "admin") {
          setRolePermissions("ALL"); // or set to [] if you prefer
          localStorage.setItem("rolePermissions", JSON.stringify("ALL"));
          console.log(
            "[AuthContext] Admin role detected, all permissions enabled."
          );
          return;
        }
        try {
          // 1. Get all roles
          const rolesRes = await api.get("/roles");
          console.log("[AuthContext] Roles response:", rolesRes.data);
          if (rolesRes.data && rolesRes.data.success) {
            const roles = rolesRes.data.data;
            console.log("[AuthContext] Roles fetched:", roles);
            // 2. Find role id by name
            const userRoleName = user.role;
            console.log(
              "[AuthContext] User role from user object:",
              userRoleName
            );
            const matchedRole = roles.find((r) => r.name === userRoleName);
            console.log("[AuthContext] Matched role:", matchedRole);
            if (matchedRole) {
              // 3. Fetch permissions for this role id
              const permsRes = await api.get(
                `/role/${matchedRole.id}/module-permissions`
              );
              if (permsRes.data && permsRes.data.success) {
                setRolePermissions(permsRes.data.data);
                // Add extra permissions for 'user' role
                if (user && user.role === "user") {
                  let perms = permsRes.data.data;
                  if (Array.isArray(perms)) {
                    perms = [...perms, "noBulkAssign", "noCsv"];
                  }
                  setRolePermissions(perms);
                  localStorage.setItem(
                    "rolePermissions",
                    JSON.stringify(perms)
                  );
                } else {
                  setRolePermissions(permsRes.data.data);
                  localStorage.setItem(
                    "rolePermissions",
                    JSON.stringify(permsRes.data.data)
                  );
                }
              } else {
                setRolePermissions([]);
                localStorage.removeItem("rolePermissions");
                console.log(
                  "[AuthContext] Permissions cleared (no data returned)"
                );
              }
            } else {
              setRolePermissions([]);
              localStorage.removeItem("rolePermissions");
              console.log("[AuthContext] Permissions cleared (role not found)");
            }
          } else {
            setRolePermissions([]);
            localStorage.removeItem("rolePermissions");
            console.log(
              "[AuthContext] Permissions cleared (roles fetch failed)"
            );
          }
        } catch (err) {
          // Optionally handle error (e.g., network issue)
          console.log("[AuthContext] Permissions fetch error:", err);
        }
      }
    };
    if (user && user.role && user.role !== "admin") {
      intervalId = setInterval(fetchPermissions, 10000); // 10 seconds for testing
    } else if (user && user.role === "admin") {
      setRolePermissions("ALL");
      localStorage.setItem("rolePermissions", JSON.stringify("ALL"));
      console.log(
        "[AuthContext] Admin role detected, all permissions enabled."
      );
    }
    return () => {
      if (intervalId) clearInterval(intervalId);
    };
  }, [user && user.role]);

  const login = async (email, password) => {
    try {
      // 1. Call the login endpoint
      const response = await api.post("/login", { email, password });
      // The API returns JSON like:
      // {
      //   success: true,
      //   message: "Login successful",
      //   user: { id, username, email, role },
      //   access_token: "...",
      //   token_type: "Bearer"
      // }
      const data = response.data;
      if (data.success && data.access_token) {
        // 2. Extract token and user
        const tokenValue = data.access_token;
        const userInfo = data.user;

        // 3. Persist token (and optionally user info)
        localStorage.setItem("token", tokenValue);
        // Optionally store user info as JSON if you want persistence across reloads:
        localStorage.setItem("user", JSON.stringify(userInfo));

        // 4. Update state
        setToken(tokenValue);
        setUser(userInfo);

        // 5. Set axios default header for future requests
        setAuthToken(tokenValue);

        // --- Set role permissions ---
        if (userInfo.role === "admin") {
          // Admin gets all permissions immediately
          setRolePermissions("ALL");
          localStorage.setItem("rolePermissions", JSON.stringify("ALL"));
          console.log(
            "[AuthContext] Admin role detected during login, all permissions enabled."
          );
        } else {
          // For non-admin users, fetch permissions from API
          try {
            // 1. Get all roles
            const rolesRes = await api.get("/roles");
            console.log("[AuthContext] Roles response:", rolesRes.data);
            if (rolesRes.data && rolesRes.data.success) {
              const roles = rolesRes.data.data;
              console.log("[AuthContext] Roles fetched:", roles);
              // 2. Find role id by name
              const userRoleName = userInfo.role;
              const matchedRole = roles.find((r) => r.name === userRoleName);
              if (matchedRole) {
                // 3. Fetch permissions for this role id
                const permsRes = await api.get(
                  `/role/${matchedRole.id}/module-permissions`
                );
                if (permsRes.data && permsRes.data.success) {
                  // Add extra permissions for 'user' role
                  if (userInfo.role === "user") {
                    let perms = permsRes.data.data;
                    if (Array.isArray(perms)) {
                      perms = [...perms, "nobulkassign", "nocsv"];
                    }
                    setRolePermissions(perms);
                    localStorage.setItem(
                      "rolePermissions",
                      JSON.stringify(perms)
                    );
                  } else {
                    setRolePermissions(permsRes.data.data);
                    localStorage.setItem(
                      "rolePermissions",
                      JSON.stringify(permsRes.data.data)
                    );
                  }
                } else {
                  setRolePermissions([]);
                  localStorage.removeItem("rolePermissions");
                }
              } else {
                setRolePermissions([]);
                localStorage.removeItem("rolePermissions");
              }
            } else {
              setRolePermissions([]);
              localStorage.removeItem("rolePermissions");
            }
          } catch (err) {
            console.log(
              "[AuthContext] Permissions fetch error during login:",
              err
            );
            setRolePermissions([]);
            localStorage.removeItem("rolePermissions");
          }
        }
        // --- End set role permissions ---

        // 6. Navigate to dashboard (or other post-login route)
        navigate("/dashboard", { replace: true });
        return;
      }
      // If API indicates failure:
      throw new Error(data.message || "Login failed");
    } catch (err) {
      // If axios error or API returned non-2xx, extract message if available
      if (err.response && err.response.data && err.response.data.message) {
        throw new Error(err.response.data.message);
      }
      throw new Error(err.message || "Login error");
    }
  };

  const logout = () => {
    // 1. Remove from storage
    localStorage.removeItem("token");
    localStorage.removeItem("user");
    localStorage.removeItem("rolePermissions");
    // 2. Clear axios header
    setAuthToken(null);
    // 3. Clear state
    setToken(null);
    setUser(null);
    setRolePermissions([]);
    // 4. Redirect
    navigate("/login", { replace: true });
  };

  const updateUser = (newUserData) => {
    console.log("updating user from context", newUserData);
    setUser((currentUser) => {
      const updatedUser = { ...currentUser, ...newUserData };
      localStorage.setItem("user", JSON.stringify(updatedUser));
      return updatedUser;
    });
  };

  return (
    <AuthContext.Provider
      value={{ user, login, logout, loading, updateUser, rolePermissions }}
    >
      {children}
    </AuthContext.Provider>
  );
}
</file>

<file path="src/components/old-roles-permissions.jsx">
import React, { useState, useEffect } from "react";
import { FiChevronDown } from "react-icons/fi";
import { TbDotsVertical } from "react-icons/tb";
import { FiEdit } from "react-icons/fi";
import api from "../../api";
import Swal from "sweetalert2";
import dummyAvatar from "/dummyavatar.jpeg";

const RolesPermissions = () => {
  const [users, setUsers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [activeDropdown, setActiveDropdown] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingUser, setEditingUser] = useState(null);
  const [formData, setFormData] = useState({
    name: "",
    email: "",
    phoneno: "",
    address: "",
  });

  // State for active screen and role dropdown
  const [activeScreen, setActiveScreen] = useState("roles"); // 'roles' or 'permissions'
  const [isRoleDropdownOpen, setIsRoleDropdownOpen] = useState(false);
  const [selectedRole, setSelectedRole] = useState(null);

  // State for Add Role Modal
  const [isAddRoleModalOpen, setIsAddRoleModalOpen] = useState(false);
  const [newRoleData, setNewRoleData] = useState({
    name: "",
    email: "",
    phoneno: "",
    password: "",
    address: "",
    description: "",
    image: null,
  });
  const [imagePreview, setImagePreview] = useState(null);

  // --- Permissions State ---
  const initialPermissions = {
    Leads: { view: true, create: true, edit: true, delete: false },
    Quotation: { view: true, create: true, edit: true, delete: false },
    Invoice: { view: true, create: true, edit: true, delete: false },
    Payment: { view: true, create: false, edit: false, delete: false },
    "Customer Inquiry": {
      view: true,
      create: false,
      edit: false,
      delete: false,
    },
  };

  const [permissions, setPermissions] = useState(initialPermissions);

  const handlePermissionChange = (module, permission) => {
    setPermissions((prev) => ({
      ...prev,
      [module]: {
        ...prev[module],
        [permission]: !prev[module][permission],
      },
    }));
  };

  const handleSaveChanges = async () => {
    if (!selectedRole) {
      Swal.fire({
        icon: "warning",
        title: "No Role Selected",
        text: "Please select a role before saving permissions.",
        confirmButtonColor: "#2798FF",
      });
      return;
    }

    const payload = {
      role: selectedRole,
      permissions: permissions,
    };

    const loadingAlert = Swal.fire({
      title: "Saving Permissions...",
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      },
    });

    try {
      const response = await api.post("/permissions", payload);
      await loadingAlert.close();

      if (response.data.success) {
        await Swal.fire({
          icon: "success",
          title: "Permissions Saved!",
          text: `Permissions for ${selectedRole} have been updated successfully.`,
          confirmButtonColor: "#2798FF",
        });
      } else {
        throw new Error(response.data.message || "Failed to save permissions.");
      }
    } catch (err) {
      await loadingAlert.close();
      Swal.fire({
        icon: "error",
        title: "Save Failed",
        text: err.message || "An error occurred while saving permissions.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };
  // --- End of Permissions State ---

  useEffect(() => {
    const fetchUsers = async () => {
      try {
        const response = await api.get("/userlist");
        if (response.data.success) {
          setUsers([...response.data.result]);
        } else {
          console.error("Failed to fetch users");
        }
      } catch (err) {
        console.error("Error fetching users" + err.message);
      } finally {
        setLoading(false);
      }
    };

    fetchUsers();
  }, []);

  const resetForm = () => {
    if (imagePreview) {
      URL.revokeObjectURL(imagePreview);
    }
    setImagePreview(null);
    setNewRoleData({
      name: "",
      email: "",
      phoneno: "",
      password: "",
      address: "",
      description: "",
      image: null,
    });
  };

  const handleCloseModal = () => {
    setIsAddRoleModalOpen(false);
    resetForm();
  };

  const toggleDropdown = (userId) => {
    setActiveDropdown(activeDropdown === userId ? null : userId);
  };

  const handleEdit = (user) => {
    setEditingUser(user);
    setFormData({
      name: user.name,
      email: user.email,
      phoneno: user.phoneno,
      address: user.address,
    });
    setIsModalOpen(true);
    setActiveDropdown(null);
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData((prev) => ({
      ...prev,
      [name]: value,
    }));
  };

  const handleNewRoleChange = (e) => {
    const { name, value, files } = e.target;
    if (name === "image") {
      const file = files[0];
      if (file) {
        setNewRoleData((prev) => ({ ...prev, image: file }));
        if (imagePreview) {
          URL.revokeObjectURL(imagePreview); // Revoke old one
        }
        setImagePreview(URL.createObjectURL(file));
      }
    } else {
      setNewRoleData((prev) => ({ ...prev, [name]: value }));
    }
  };

  const handleAddRoleSubmit = async (e) => {
    e.preventDefault();

    const formData = new FormData();
    Object.keys(newRoleData).forEach((key) => {
      formData.append(key, newRoleData[key]);
    });

    try {
      // Show loading state
      const loadingAlert = Swal.fire({
        title: "Creating User...",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      // API call to create user with multipart/form-data
      const response = await api.post("/users", formData, {
        headers: {
          "Content-Type": "multipart/form-data",
        },
      });

      await loadingAlert.close();

      if (response.data.success || response.data.status) {
        const newUser = response.data.result;
        // Prepend the new user to the list
        setUsers((prev) => [newUser, ...prev]);
        setIsAddRoleModalOpen(false);
        resetForm();

        await Swal.fire({
          icon: "success",
          title: "User Created!",
          text: `User "${newUser.name}" has been successfully created.`,
          confirmButtonColor: "#2798FF",
        });
      } else {
        throw new Error("Failed to create user");
      }
    } catch (err) {
      Swal.fire({
        icon: "error",
        title: "Creation Failed",
        text: err.message || "An error occurred while creating the user.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  // DELETE
  const handleDelete = async (id) => {
    const result = await Swal.fire({
      title: "Are you sure?",
      text: "This cannot be undone.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#DD6B55",
      cancelButtonColor: "#aaa",
      confirmButtonText: "Yes, delete it!",
    });
    if (result.isConfirmed) {
      try {
        const response = await api.delete(`/deleteuser/${id}`);
        if (response.data.success) {
          setUsers((prev) => prev.filter((u) => u.id !== id));
          await Swal.fire({
            icon: "success",
            title: "Deleted!",
            text: "User has been removed.",
            confirmButtonColor: "#2798FF",
          });
        } else {
          throw new Error("Server rejected delete");
        }
      } catch (err) {
        Swal.fire({
          icon: "error",
          title: "Delete Failed",
          text: err.message,
          confirmButtonColor: "#DD6B55",
        });
      }
    }
    setActiveDropdown(null);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      const response = await api.post(
        `/updateuser/${editingUser.id}`,
        formData
      );
      if (response.data.success) {
        // Update the users list with the edited user
        setUsers(
          users.map((user) =>
            user.id === editingUser.id ? { ...user, ...formData } : user
          )
        );
        setIsModalOpen(false);
        await Swal.fire({
          icon: "success",
          title: "User Updated",
          text: `${formData.name} was successfully updated.`,
          confirmButtonColor: "#2798FF",
        });
      } else {
        Swal.fire({
          icon: "error",
          title: "Update Failed",
          text: "Failed to update user.",
          confirmButtonColor: "#DD6B55",
        });
      }
    } catch (err) {
      Swal.fire({
        icon: "error",
        title: "Update Failed",
        text: err.message,
        confirmButtonColor: "#DD6B55",
      });
    }
    setActiveDropdown(null);
  };

  const formatAddress = (address) => {
    try {
      const parsedAddress = JSON.parse(address);
      if (parsedAddress && typeof parsedAddress === "object") {
        const { blockUnitStreetName, city, state, country, pincode } =
          parsedAddress;
        return (
          <>
            <span className="font-bold">{blockUnitStreetName}</span>
            <br />
            {city}, {state}, {country}
            <br />
            {pincode}, {country}
          </>
        );
      }
    } catch (e) {
      // Not a JSON string, treat as plain text
    }
    return address;
  };

  if (loading) {
    return (
      <div className="w-full min-h-[797px] flex items-center justify-center">
        Loading...
      </div>
    );
  }

  return (
    <div className="w-full h-auto min-h-[480px] p-4 md:p-6 relative bg-gradient-to-br from-white to-[#E7F4FF] rounded-[10px] shadow-[2px_2px_6px_rgba(24,95,235,0.1)] flex flex-col">
      {/* Header Section */}
      <div className="flex flex-wrap items-center justify-between gap-4 mb-8">
        {/* Title */}
        <div className="flex gap-6">
          <button
            onClick={() => setActiveScreen("roles")}
            className="focus:outline-none"
          >
            <h2
              className={`text-[20px] md:text-[22px] font-medium text-[#1F2837] whitespace-nowrap pb-1 ${
                activeScreen === "roles"
                  ? "border-b-2 border-[#2798FF]"
                  : "border-b-2 border-transparent"
              }`}
            >
              Roles
            </h2>
          </button>
          <button
            onClick={() => setActiveScreen("permissions")}
            className="focus:outline-none"
          >
            <h2
              className={`text-[20px] md:text-[22px] font-medium text-[#1F2837] whitespace-nowrap pb-1 ${
                activeScreen === "permissions"
                  ? "border-b-2 border-[#2798FF]"
                  : "border-b-2 border-transparent"
              }`}
            >
              Permissions
            </h2>
          </button>
        </div>

        <div className="flex items-center gap-3 md:gap-4">
          {activeScreen === "roles" ? (
            <button
              onClick={() => setIsAddRoleModalOpen(true)}
              className=" hover:bg-blue-500
        bg-[#ef7e1b] text-white
        h-[44px] px-8
        rounded-[8px]
        flex items-center justify-center
      "
            >
              Add Role
            </button>
          ) : (
            <div className="relative">
              <button
                onClick={() => setIsRoleDropdownOpen((prev) => !prev)}
                className="bg-[#ef7e1b] text-white h-[44px] px-4 rounded-[8px] flex items-center justify-center gap-2"
              >
                <span>{selectedRole || "Select Role Name"}</span>
                <FiChevronDown />
              </button>
              {isRoleDropdownOpen && (
                <div className="absolute right-0 mt-2 w-48 rounded-md shadow-md bg-gradient-to-br from-white to-[#E7F4FF] z-10 overflow-hidden">
                  <div>
                    {selectedRole && (
                      <>
                        <button
                          onClick={(e) => {
                            e.preventDefault();
                            setSelectedRole(null);
                            setIsRoleDropdownOpen(false);
                          }}
                          className="group flex items-center px-4 py-2 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors"
                        >
                          <span className="group-hover:text-white transition-colors">
                            Select Role Name
                          </span>
                        </button>
                        <svg
                          className="w-full h-[1px]"
                          viewBox="0 0 100 1"
                          preserveAspectRatio="none"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <polygon points="0,0 50,1 100,0" fill="#E5E7EB" />
                        </svg>
                      </>
                    )}
                    <button
                      onClick={(e) => {
                        e.preventDefault();
                        setSelectedRole("Sales Manager");
                        setIsRoleDropdownOpen(false);
                      }}
                      className="group flex items-center px-4 py-2 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors"
                    >
                      <span className="group-hover:text-white transition-colors">
                        Sales Manager
                      </span>
                    </button>
                    <svg
                      className="w-full h-[1px]"
                      viewBox="0 0 100 1"
                      preserveAspectRatio="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <polygon points="0,0 50,1 100,0" fill="#E5E7EB" />
                    </svg>
                    <button
                      onClick={(e) => {
                        e.preventDefault();
                        setSelectedRole("Manager");
                        setIsRoleDropdownOpen(false);
                      }}
                      className="group flex items-center px-4 py-2 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors"
                    >
                      <span className="group-hover:text-white transition-colors">
                        Manager
                      </span>
                    </button>
                    <svg
                      className="w-full h-[1px]"
                      viewBox="0 0 100 1"
                      preserveAspectRatio="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <polygon points="0,0 50,1 100,0" fill="#E5E7EB" />
                    </svg>
                    <button
                      onClick={(e) => {
                        e.preventDefault();
                        setSelectedRole("Sales Representative");
                        setIsRoleDropdownOpen(false);
                      }}
                      className="group flex items-center px-4 py-2 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors"
                    >
                      <span className="group-hover:text-white transition-colors">
                        Sales Representative
                      </span>
                    </button>
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      </div>

      {activeScreen === "roles" ? (
        <>
          {/* User List Table */}
          <div className="hidden md:block w-full flex-grow">
            <table className="w-full min-w-[1000px] border-collapse">
              <thead>
                <tr className="text-left text-[#4B5563]">
                  <th className="py-4 px-6 font-medium text-sm">Name</th>
                  <th className="py-4 px-6 font-medium text-sm">Email</th>
                  <th className="py-4 px-6 font-medium text-sm">Role</th>
                  <th className="py-4 px-6 font-medium text-sm">
                    Descriptions
                  </th>
                  <th className="py-4 px-6 font-medium text-sm">Actions</th>
                </tr>
              </thead>
              <tbody>
                {users.length === 0 ? (
                  <tr>
                    <td
                      colSpan="5"
                      className="py-8 px-6 text-center text-[#4B5563]"
                    >
                      No users available.
                    </td>
                  </tr>
                ) : (
                  users.map((user) => {
                    return (
                      <tr key={user.id} className="border-t border-[#E5E7EB]">
                        <td className="py-4 px-6 text-sm text-[#4B5563]">
                          <div className="flex items-center gap-3">
                            <img
                              src={user.image || dummyAvatar}
                              alt={user.name}
                              className="w-10 h-10 rounded-full"
                            />
                            <span>{user.name}</span>
                          </div>
                        </td>
                        <td className="py-4 px-6 text-sm text-[#4B5563]">
                          {user.email}
                        </td>
                        <td className="py-4 px-6 text-sm text-[#4B5563]">
                          {user.role || "N/A"}
                        </td>
                        <td className="py-4 px-6 text-sm text-[#4B5563]">
                          {formatAddress(user.address)}
                        </td>

                        <td className="py-4 px-6 relative">
                          <button
                            onClick={() => toggleDropdown(user.id)}
                            className="p-2 text-[#4B5563] hover:bg-blue-200  rounded-full transition-colors "
                          >
                            <TbDotsVertical className="w-4 h-4" />
                          </button>
                          {activeDropdown === user.id && (
                            <div className="relative">
                              {/* Trigger, etc. */}
                              <div className="absolute left-3 w-24 rounded-md shadow-md bg-gradient-to-br from-white to-[#E7F4FF] z-10 overflow-hidden">
                                <div className="">
                                  {/* EDIT button */}
                                  <button
                                    onClick={() => handleEdit(user)}
                                    className="group flex items-center px-2 py-1 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors first:rounded-t-md"
                                  >
                                    <svg
                                      xmlns="http://www.w3.org/2000/svg"
                                      width="24"
                                      height="24"
                                      viewBox="0 0 24 24"
                                      className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                    >
                                      <path
                                        fill="currentColor"
                                        d="M4 14v-2h7v2zm0-4V8h11v2zm0-4V4h11v2zm9 14v-3.075l6.575-6.55l3.075 3.05L16.075 20zm7.5-6.575l-.925-.925zm-6 5.075h.95l3.025-3.05l-.45-.475l-.475-.45l-3.05 3.025zm3.525-3.525l-.475-.45l.925.925z"
                                      />
                                    </svg>
                                    <span className="group-hover:text-white transition-colors">
                                      Edit
                                    </span>
                                  </button>

                                  {/* Tapered separator (geometric taper) */}
                                  <svg
                                    className="w-full h-[1px]" // adjust h-1 or h-2 as needed
                                    viewBox="0 0 100 1"
                                    preserveAspectRatio="none"
                                    xmlns="http://www.w3.org/2000/svg"
                                  >
                                    <polygon
                                      points="0,0 50,1 100,0"
                                      fill="#E5E7EB"
                                    />
                                  </svg>

                                  {/* DELETE button */}
                                  <button
                                    onClick={() => handleDelete(user.id)}
                                    className="group flex items-center px-2 py-1 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors last:rounded-b-md"
                                  >
                                    <svg
                                      xmlns="http://www.w3.org/2000/svg"
                                      width="24"
                                      height="24"
                                      viewBox="0 0 24 24"
                                      className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                    >
                                      <path
                                        fill="currentColor"
                                        d="M7.616 20q-.672 0-1.144-.472T6 18.385V6H5V5h4v-.77h6V5h4v1h-1v12.385q0 .69-.462 1.153T16.384 20zM17 6H7v12.385q0 .269.173.442t.443.173h8.769q.23 0 .423-.192t.192-.424zM9.808 17h1V8h-1zm3.384 0h1V8h-1zM7 6v13z"
                                      />
                                    </svg>
                                    <span className="group-hover:text-white transition-colors">
                                      Delete
                                    </span>
                                  </button>
                                </div>
                              </div>
                            </div>
                          )}
                        </td>
                      </tr>
                    );
                  })
                )}
              </tbody>
            </table>
          </div>

          {/* User List Cards for Mobile */}
          <div className="md:hidden w-full space-y-4 pb-24 flex-grow">
            {users.length === 0 ? (
              <div className="py-8 px-6 text-center text-[#4B5563]">
                No users available.
              </div>
            ) : (
              users.map((user) => {
                return (
                  <div
                    key={user.id}
                    className="bg-white rounded-lg shadow p-4 border border-gray-200/80"
                  >
                    <div className="flex justify-between items-start">
                      <div className="flex items-center gap-3">
                        <img
                          src={user.image || dummyAvatar}
                          alt={user.name}
                          className="w-10 h-10 rounded-full"
                        />
                        <div className="space-y-1 pr-2">
                          <p className="font-bold text-lg text-[#1F2837]">
                            {user.name}
                          </p>
                          <p className="text-sm text-gray-500 break-all">
                            {user.email}
                          </p>
                        </div>
                      </div>
                      {/* Actions button */}
                      <div className="relative">
                        <button
                          onClick={() => toggleDropdown(user.id)}
                          className="p-2 text-[#4B5563] rounded-full hover:bg-gray-100"
                        >
                          <TbDotsVertical className="w-5 h-5" />
                        </button>
                        {activeDropdown === user.id && (
                          <div className="absolute right-0 mt-1 w-28 rounded-md shadow-md bg-gradient-to-br from-white to-[#E7F4FF] z-20 overflow-hidden">
                            <div>
                              {/* EDIT button */}
                              <button
                                onClick={() => handleEdit(user)}
                                className="group flex items-center px-3 py-2 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors first:rounded-t-md"
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="24"
                                  height="24"
                                  viewBox="0 0 24 24"
                                  className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                >
                                  <path
                                    fill="currentColor"
                                    d="M4 14v-2h7v2zm0-4V8h11v2zm0-4V4h11v2zm9 14v-3.075l6.575-6.55l3.075 3.05L16.075 20zm7.5-6.575l-.925-.925zm-6 5.075h.95l3.025-3.05l-.45-.475l-.475-.45l-3.05 3.025zm3.525-3.525l-.475-.45l.925.925z"
                                  />
                                </svg>
                                <span className="group-hover:text-white transition-colors">
                                  Edit
                                </span>
                              </button>

                              {/* Tapered separator */}
                              <svg
                                className="w-full h-[1px]"
                                viewBox="0 0 100 1"
                                preserveAspectRatio="none"
                                xmlns="http://www.w3.org/2000/svg"
                              >
                                <polygon
                                  points="0,0 50,1 100,0"
                                  fill="#E5E7EB"
                                />
                              </svg>

                              {/* DELETE button */}
                              <button
                                onClick={() => handleDelete(user.id)}
                                className="group flex items-center px-3 py-2 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors last:rounded-b-md"
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="24"
                                  height="24"
                                  viewBox="0 0 24 24"
                                  className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                >
                                  <path
                                    fill="currentColor"
                                    d="M7.616 20q-.672 0-1.144-.472T6 18.385V6H5V5h4v-.77h6V5h4v1h-1v12.385q0 .69-.462 1.153T16.384 20zM17 6H7v12.385q0 .269.173.442t.443.173h8.769q.23 0 .423-.192t.192-.424zM9.808 17h1V8h-1zm3.384 0h1V8h-1zM7 6v13z"
                                  />
                                </svg>
                                <span className="group-hover:text-white transition-colors">
                                  Delete
                                </span>
                              </button>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                    <div className="mt-4 space-y-3 text-sm">
                      <div>
                        <span className="font-medium text-gray-600">
                          Role:{" "}
                        </span>
                        <span className="text-gray-800">
                          {user.role || "N/A"}
                        </span>
                      </div>
                      <div>
                        <span className="font-medium text-gray-600">
                          Description:{" "}
                        </span>
                        <span className="text-gray-800">
                          {formatAddress(user.address)}
                        </span>
                      </div>
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </>
      ) : (
        <div className="w-full flex-grow">
          <div>
            <PermissionsTable
              permissions={permissions}
              onPermissionChange={handlePermissionChange}
            />
          </div>
        </div>
      )}

      {/* Edit Modal */}
      {isModalOpen && (
        <div className="fixed inset-0 flex items-center justify-center z-50">
          {/* Frosted overlay */}
          <div
            className="absolute inset-0 bg-gray-50/10 backdrop-blur-sm border border-white/30"
            onClick={() => setIsModalOpen(false)}
          />

          {/* Glassmorphism modal container */}
          <div
            className="
    w-11/12 max-w-[800px] max-h-[90vh] overflow-y-auto p-6 md:p-8
    rounded-2xl
    bg-gradient-to-br from-[#FFFFFF] to-[#E6F4FF]
    shadow-lg
    relative z-10
  "
          >
            {/* Close button */}
            <button
              onClick={() => setIsModalOpen(false)}
              className="absolute top-6 right-6 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13 1L1 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M1 1L13 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Modal title */}
            <h2 className="text-[29px] font-medium text-[#1F2837] mb-8">
              Edit User
            </h2>

            {/* Form grid */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
              {/* Customer Name */}
              <div className="space-y-2 md:col-start-1 md:row-start-1">
                <label className="block text-[#4B5563] text-[16px] mb-2">
                  Customer Name
                </label>
                <div className="relative">
                  <input
                    type="text"
                    name="name"
                    value={formData.name}
                    onChange={handleInputChange}
                    className="
          w-full h-[48px] px-3 rounded-[12px]
          bg-[#E7EFF8] border border-white/20
          focus:ring-2 focus:ring-[#0e4053] outline-none
          text-[#545454] placeholder-[#545454]
        "
                  />
                  <button className="absolute right-3 top-1/2 -translate-y-1/2">
                    <FiEdit className="w-5 h-5 text-gray-500" />
                  </button>
                </div>
              </div>

              {/* Email */}
              <div className="space-y-2 md:col-start-2 md:row-start-1">
                <label className="block text-[#4B5563] text-[16px] mb-2">
                  Email
                </label>
                <input
                  type="email"
                  name="email"
                  value={formData.email}
                  onChange={handleInputChange}
                  className="
        w-full h-[48px] px-3 rounded-[12px]
        bg-[#E7EFF8] border border-white/20
        focus:ring-2 focus:ring-[#0e4053] outline-none
        text-[#545454] placeholder-[#545454]
      "
                />
              </div>

              {/* Address: full-width on md+ by spanning 2 columns */}
              <div className="space-y-2 md:col-start-1 md:col-span-2 md:row-start-2">
                <label className="block text-[#4B5563] text-[16px] mb-2">
                  Address
                </label>
                <textarea
                  name="address"
                  value={formData.address}
                  onChange={handleInputChange}
                  rows="3"
                  className="
        w-full min-h-[115px] p-3 rounded-[12px]
        bg-[#E7EFF8] border border-white/20
        focus:ring-2 focus:ring-[#0e4053] outline-none
        text-[#545454] placeholder-[#545454] resize-none
      "
                />
              </div>

              {/* Contact (Phone Number) */}
              <div className="space-y-2 md:col-start-1 md:row-start-3">
                <label className="block text-[#4B5563] text-[16px] mb-2">
                  Contact
                </label>
                <input
                  type="text"
                  name="phoneno"
                  value={formData.phoneno}
                  onChange={handleInputChange}
                  className="
        w-full h-[48px] px-3 rounded-[12px]
        bg-[#E7EFF8] border border-white/20
        focus:ring-2 focus:ring-[#0e4053] outline-none
        text-[#545454] placeholder-[#545454]
      "
                />
              </div>

              {/* (Optional) empty div to fill the right column on the third row, if you want consistent spacing */}
              <div className="hidden md:block md:col-start-2 md:row-start-3" />
            </div>

            {/* Save button */}
            <div className="mt-10 flex justify-center">
              <button
                type="submit"
                onClick={handleSubmit}
                className="w-[207px] h-[46px] bg-[#ef7e1b] text-white rounded-[10px] hover:bg-[#ee7f1b] transition-colors"
              >
                Save
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Add Role Modal */}
      {isAddRoleModalOpen && (
        <div className="fixed inset-0 flex items-center justify-center z-50">
          <div
            className="absolute inset-0 bg-gray-50/10 backdrop-blur-sm"
            onClick={handleCloseModal}
          />
          <div className="w-11/12 max-w-[800px] max-h-[90vh] overflow-y-auto p-6 md:p-8 rounded-2xl bg-gradient-to-br from-white to-[#E6F4FF] shadow-lg relative z-10">
            <button
              onClick={handleCloseModal}
              className="absolute top-6 right-6 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13 1L1 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M1 1L13 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>
            <h2 className="text-[29px] font-medium text-[#1F2837] mb-8">
              Add New User
            </h2>
            <form onSubmit={handleAddRoleSubmit}>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                {/* --- Left Column: Profile Picture --- */}
                <div className="md:col-span-1 flex flex-col items-center">
                  <label className="block text-[#4B5563] text-[16px] mb-4 w-full">
                    Profile Picture
                  </label>
                  <div className="relative w-32 h-32">
                    <img
                      src={imagePreview || dummyAvatar}
                      alt="Profile Preview"
                      className="w-32 h-32 rounded-full object-cover border-2 border-white shadow-md"
                    />
                    <label
                      htmlFor="file-upload"
                      className="absolute bottom-1 right-1 bg-[#ef7e1b] text-white rounded-full p-2 cursor-pointer hover:bg-blue-600 transition-colors"
                    >
                      <FiEdit className="w-4 h-4" />
                      <input
                        type="file"
                        name="image"
                        id="file-upload"
                        onChange={handleNewRoleChange}
                        className="hidden"
                        accept="image/*"
                      />
                    </label>
                  </div>
                  <p className="text-xs text-gray-500 mt-2">
                    PNG, JPG, GIF up to 10MB
                  </p>
                </div>

                {/* --- Right Columns: User Details --- */}
                <div className="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="space-y-2">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Full Name
                    </label>
                    <input
                      type="text"
                      name="name"
                      value={newRoleData.name}
                      onChange={handleNewRoleChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454]"
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Email
                    </label>
                    <input
                      type="email"
                      name="email"
                      value={newRoleData.email}
                      onChange={handleNewRoleChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454]"
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Phone Number
                    </label>
                    <input
                      type="tel"
                      name="phoneno"
                      value={newRoleData.phoneno}
                      onChange={handleNewRoleChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454]"
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Password
                    </label>
                    <input
                      type="password"
                      name="password"
                      value={newRoleData.password}
                      onChange={handleNewRoleChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454]"
                      required
                    />
                  </div>
                  <div className="md:col-span-2 space-y-2">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Address
                    </label>
                    <textarea
                      name="address"
                      value={newRoleData.address}
                      onChange={handleNewRoleChange}
                      rows="3"
                      className="w-full p-3 rounded-[12px] bg-[#E7EFF8] border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] resize-none"
                    />
                  </div>
                  <div className="md:col-span-2 space-y-2">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Description
                    </label>
                    <textarea
                      name="description"
                      value={newRoleData.description}
                      onChange={handleNewRoleChange}
                      rows="4"
                      className="w-full p-2 rounded-[12px] bg-[#E7EFF8] border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] resize-none"
                    />
                  </div>
                </div>
              </div>
              <div className="mt-10 flex justify-center">
                <button
                  type="submit"
                  className="w-[207px] h-[46px] bg-[#ef7e1b] text-white rounded-[10px] hover:bg-[#ee7f1b] transition-colors"
                >
                  Create User
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
};

// --- Sub-components for Permissions ---

const PermissionToggle = ({ checked, onChange }) => {
  return (
    <button
      type="button"
      onClick={onChange}
      className={`relative inline-flex items-center h-6 rounded-full w-11 transition-colors ${
        checked ? "bg-[#ef7e1b]" : "bg-gray-300"
      }`}
    >
      <span
        className={`inline-block w-4 h-4 transform bg-white rounded-full transition-transform ${
          checked ? "translate-x-6" : "translate-x-1"
        }`}
      />
    </button>
  );
};

const PermissionsTable = ({ permissions, onPermissionChange }) => {
  const headers = ["Module", "View", "Create", "Edit", "Delete"];

  return (
    <div className="w-full rounded-lg  overflow-hidden">
      {/* Header */}
      <div className="grid grid-cols-[2fr_0.75fr_0.75fr_0.75fr_0.75fr_2fr] gap-x-4 px-6 py-4 border-b border-gray-200 ">
        {headers.map((header, index) => (
          <div
            key={header}
            className={`font-medium text-sm text-[#4B5563] ${
              index > 0 ? "text-center" : "text-left"
            }`}
          >
            {header}
          </div>
        ))}
        <div /> {/* Empty header for spacing */}
      </div>

      {/* Body */}
      <div>
        {Object.entries(permissions).map(([moduleName, modulePermissions]) => (
          <div
            key={moduleName}
            className="grid grid-cols-[2fr_0.75fr_0.75fr_0.75fr_0.75fr_2fr] gap-x-4 px-6 py-4 border-b border-gray-200 items-center last:border-b-0 hover:bg-gray-50/30 transition-colors"
          >
            <div className="font-medium text-sm text-[#4B5563]">
              {moduleName}
            </div>
            {Object.keys(modulePermissions).map((permission) => (
              <div key={permission} className="flex justify-center">
                <PermissionToggle
                  checked={modulePermissions[permission]}
                  onChange={() => onPermissionChange(moduleName, permission)}
                />
              </div>
            ))}
            <div /> {/* Empty cell for spacing */}
          </div>
        ))}
      </div>
    </div>
  );
};

export default RolesPermissions;
</file>

<file path="src/components/SampleComponent.jsx">
import React, { useState, useEffect } from "react";
import { FiChevronDown } from "react-icons/fi";
//DONT USE THIS FILE DIRECTLY---COPY PASTE INTO ANOTHER THEN USE.
const CreateUser = () => {
  // Mobile detection and search state
  const [isMobile, setIsMobile] = useState(() => window.innerWidth < 768);
  const [isSearchExpanded, setIsSearchExpanded] = useState(false);

  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth < 768);
      if (window.innerWidth >= 768) {
        setIsSearchExpanded(false);
      }
    };
    checkMobile();
    window.addEventListener("resize", checkMobile);
    return () => window.removeEventListener("resize", checkMobile);
  }, []);

  const handleSearchToggle = () => {
    setIsSearchExpanded(!isSearchExpanded);
  };

  const handleSearchBlur = () => {
    if (isMobile) {
      setIsSearchExpanded(false);
    }
  };

  return (
    // Add `relative` here so that absolute children position within this container:
    <div className="relative w-full min-h-[797px] p-4 md:p-6 bg-gradient-to-br from-white to-[#E7F4FF] rounded-[10px] shadow-[2px_2px_6px_rgba(24,95,235,0.1)]">
      {/* Header Section */}
      <div className="flex items-center gap-2 md:gap-4 mb-8">
        <h1 className="text-[16px] md:text-[20px] font-medium text-[#1F2837] whitespace-nowrap">
          Create New User
        </h1>

        {/* Search Container */}
        <div className={`flex-1 max-w-[377px] ${isMobile ? "ml-2" : "mx-auto"}`}>
          {isMobile && !isSearchExpanded ? (
            // Collapsed state: just the search icon
            <button
              onClick={handleSearchToggle}
              className="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center rounded-[6px] hover:bg-gray-50 transition-colors"
            >
              {/* search icon SVG */}
              <svg
                width="20"
                height="20"
                viewBox="0 0 22 22"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M10.5417 19.25C15.3512 19.25 19.25 15.3512 19.25 10.5417C19.25 5.73223 15.3512 1.83334 10.5417 1.83334C5.73223 1.83334 1.83334 5.73223 1.33334 10.5417C1.83334 15.3512 5.73223 19.25 10.5417 19.25Z"
                  stroke="#787374"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M18.3333 18.3333L20.1667 20.1667"
                  stroke="#787374"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>
          ) : (
            // Expanded state or desktop: full search bar
            <div className="relative w-full">
              <div className="absolute left-[16.8px] top-1/2 transform -translate-y-1/2 pointer-events-none">
                {/* search icon SVG */}
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 22 22"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M10.5417 19.25C15.3512 19.25 19.25 15.3512 19.25 10.5417C19.25 5.73223 15.3512 1.83334 10.5417 1.83334C5.73223 1.83334 1.83334 5.73223 1.33334 10.5417C1.83334 15.3512 5.73223 19.25 10.5417 19.25Z"
                    stroke="#787374"
                    strokeWidth="1.5"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                  <path
                    d="M18.3333 18.3333L20.1667 20.1667"
                    stroke="#787374"
                    strokeWidth="1.5"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                </svg>
              </div>
              <input
                type="search"
                placeholder={isMobile ? "Search" : "Search by Name, Contact"}
                className="w-full h-[36px] md:h-[44px] pl-12 pr-4 bg-[#E9F1F9] rounded-[6px] text-[#787374] placeholder-[#787374] focus:outline-none text-sm md:text-base placeholder:text-[10.3px] md:placeholder:text-base"
                onBlur={handleSearchBlur}
                autoFocus={isMobile && isSearchExpanded}
              />
            </div>
          )}
        </div>

        {/* Display Dropdown */}
        <div className="flex items-center gap-1 md:gap-2 ml-auto">
          <span className="text-[#727A90] text-sm md:text-base whitespace-nowrap">
            Display
          </span>
          <div className="flex items-center h-[36px] md:h-[40px] px-2 md:px-3 bg-white border border-[#E9EAEA] rounded-[12px] cursor-pointer">
            <span className="text-[#242729] mr-1 md:mr-2 text-sm md:text-base">
              10
            </span>
            <FiChevronDown className="w-3 h-3 md:w-4 md:h-4 text-[#727A90]" />
          </div>
        </div>
      </div>

      {/* Main content here... e.g. user list/table */}

      {/* Pagination Controls */}
      <div
        className={`
          fixed bottom-10 left-0 right-0 flex justify-center gap-2 px-4
          md:absolute md:bottom-6 md:left-1/2 md:-translate-x-1/2 md:px-0
        `}
      >
        <button className="w-[44px] h-[44px] md:w-[52px] md:h-[52px] rounded-full flex items-center justify-center hover:bg-gray-50">
          <img
            src="/hugeicons_less-than.svg"
            alt="Previous"
            className="w-5 h-5 md:w-6 md:h-6"
          />
        </button>
        <button className="w-[44px] h-[44px] md:w-[52px] md:h-[52px] rounded-full border border-[#7E7B7B] flex items-center justify-center hover:bg-gray-50">
          <img src="/right.svg" alt="Next" className="w-5 h-5 md:w-6 md:h-6" />
        </button>
      </div>
    </div>
  );
};

export default CreateUser;
</file>

<file path="src/components/SampleComponent2.jsx">
import React, { useState, useEffect } from 'react';

/**
 * DataContainer: A reusable container component for list-based UIs with title, search, pagination, and mobile responsiveness.
 *
 * Props:
 * - title: string - Title to display in header.
 * - fetchData: () => Promise<Array> - Async function to fetch the data array.
 * - searchFields: string[] - Keys in each item to filter by searchTerm (case-insensitive).
 * - itemsPerPageOptions: number[] - Options for items per page dropdown.
 * - defaultItemsPerPage: number - Initial items per page.
 * - actions: JSX.Element - Actions to show in header (e.g., Create button).
 * - children: function - Render prop receiving container state and helper functions: {
 *       currentItems: Array,
 *       filteredItems: Array,
 *       searchTerm: string,
 *       onSearchChange: (e) => void,
 *       isMobile: boolean,
 *       isSearchExpanded: boolean,
 *       toggleSearch: () => void,
 *       onSearchBlur: () => void,
 *       itemsPerPage: number,
 *       onItemsPerPageChange: (newCount) => void,
 *       currentPage: number,
 *       totalPages: number,
 *       onPreviousPage: () => void,
 *       onNextPage: () => void,
 *       loading: boolean,
 *       error: string | null,
 *   } => JSX
 *
 * Usage Example:
 *
 * <DataContainer
 *   title="Users"
 *   fetchData={async () => { const res = await api.get('/userlist'); return res.data.result; }}
 *   searchFields={[ 'name', 'email', 'phoneno', 'address' ]}
 *   itemsPerPageOptions={[5, 10, 20, 50]}
 *   defaultItemsPerPage={10}
 *   actions={<button onClick={openCreateModal}>Create User</button>}
 * >
 *   {({ currentItems, filteredItems, searchTerm, onSearchChange, isMobile, isSearchExpanded, toggleSearch, onSearchBlur, itemsPerPage, onItemsPerPageChange, currentPage, totalPages, onPreviousPage, onNextPage, loading, error }) => (
 *     <> // Render table or cards here using currentItems
 *       {loading ? (
 *         <div className="w-full min-h-[200px] flex items-center justify-center">Loading...</div>
 *       ) : error ? (
 *         <div className="text-red-600">{error}</div>
 *       ) : (
 *         <>
 *           {/* Example: render table for desktop */}
 *           <div className="hidden md:block w-full">
 *             <table className="w-full border-collapse">
 *               <thead>...</thead>
 *               <tbody>
 *                 {currentItems.map(item => (
 *                   <tr key={item.id}>...</tr>
 *                 ))}
 *               </tbody>
 *             </table>
 *           </div>
 *           {/* Mobile cards */}
 *           <div className="md:hidden space-y-4">
 *             {currentItems.map(item => (
 *               <div key={item.id} className="bg-white p-4 rounded-lg shadow">...</div>
 *             ))}
 *           </div>
 *         </>
 *       )}
 *     </>
 *   )}
 * </DataContainer>
 */

const DataContainer = ({
  title,
  fetchData,
  searchFields = [],
  itemsPerPageOptions = [5, 10, 20, 50],
  defaultItemsPerPage = 10,
  actions = null,
  children,
}) => {
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const [isMobile, setIsMobile] = useState(() => window.innerWidth < 768);
  const [isSearchExpanded, setIsSearchExpanded] = useState(false);

  const [searchTerm, setSearchTerm] = useState('');
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(defaultItemsPerPage);

  // Fetch data on mount
  useEffect(() => {
    let cancelled = false;
    const load = async () => {
      try {
        const data = await fetchData();
        if (!cancelled) {
          setItems(Array.isArray(data) ? data : []);
        }
      } catch (err) {
        if (!cancelled) setError(err.message || 'Error fetching data');
      } finally {
        if (!cancelled) setLoading(false);
      }
    };
    load();
    return () => {
      cancelled = true;
    };
  }, [fetchData]);

  // Handle window resize for mobile detection
  useEffect(() => {
    const handleResize = () => {
      const mobile = window.innerWidth < 768;
      setIsMobile(mobile);
      if (!mobile) setIsSearchExpanded(false);
    };
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  // Filter items by searchTerm
  const filteredItems = items.filter(item => {
    if (!searchTerm) return true;
    const lower = searchTerm.toLowerCase();
    return searchFields.some(key => {
      const val = item[key];
      return typeof val === 'string' && val.toLowerCase().includes(lower);
    });
  });

  // Pagination calculations
  const totalPages = Math.max(1, Math.ceil(filteredItems.length / itemsPerPage));
  useEffect(() => {
    if (currentPage > totalPages) {
      setCurrentPage(totalPages);
    }
  }, [totalPages]);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const currentItems = filteredItems.slice(startIndex, endIndex);

  // Reset to first page when searchTerm or itemsPerPage changes
  useEffect(() => {
    setCurrentPage(1);
  }, [searchTerm, itemsPerPage]);

  // Handlers
  const onSearchChange = e => setSearchTerm(e.target.value);
  const toggleSearch = () => setIsSearchExpanded(prev => !prev);
  const onSearchBlur = () => {
    if (isMobile) setIsSearchExpanded(false);
  };

  const onItemsPerPageChange = newCount => setItemsPerPage(newCount);
  const onPreviousPage = () => {
    setCurrentPage(prev => Math.max(1, prev - 1));
  };
  const onNextPage = () => {
    setCurrentPage(prev => Math.min(totalPages, prev + 1));
  };

  // Header JSX
  const renderHeader = () => (
    <div className="flex flex-wrap items-center justify-between gap-4 mb-8">
      {/* Title */}
      <h1 className="text-[20px] md:text-[22px] font-medium text-[#1F2837] whitespace-nowrap">
        {title}
      </h1>

      {/* Search Container */}
      <div className="flex-1 max-w-[400px] mx-1">
        {isMobile && !isSearchExpanded ? (
          <button
            onClick={toggleSearch}
            className="w-10 h-10 flex items-center rounded-[6px] hover:bg-gray-50 transition-colors"
          >
            {/* search icon SVG */}
            <svg width="20" height="20" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10.5417 19.25C15.3512 19.25 19.25 15.3512 19.25 10.5417C19.25 5.73223 15.3512 1.83334 10.5417 1.83334C5.73223 1.83334 1.83334 5.73223 1.33334 10.5417C1.83334 15.3512 5.73223 19.25 10.5417 19.25Z" stroke="#787374" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
              <path d="M18.3333 18.3333L20.1667 20.1667" stroke="#787374" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
            </svg>
          </button>
        ) : (
          <div className="relative w-full">
            {/* Search icon inside input */}
            <div className="absolute left-4 top-1/2 -translate-y-1/2 pointer-events-none">
              <svg width="20" height="20" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10.5417 19.25C15.3512 19.25 19.25 15.3512 19.25 10.5417C19.25 5.73223 15.3512 1.83334 10.5417 1.83334C5.73223 1.83334 1.83334 5.73223 1.33334 10.5417C1.83334 15.3512 5.73223 19.25 10.5417 19.25Z" stroke="#787374" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                <path d="M18.3333 18.3333L20.1667 20.1667" stroke="#787374" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
              </svg>
            </div>
            <input
              type="search"
              placeholder={isMobile ? 'Search' : 'Search'}
              value={searchTerm}
              onChange={onSearchChange}
              className="w-full h-[44px] pl-12 pr-4 bg-[#E9F1F9] rounded-[6px] text-[#787374] placeholder-[#787374] focus:outline-none text-sm md:text-base"
              onBlur={onSearchBlur}
              autoFocus={isMobile && isSearchExpanded}
            />
          </div>
        )}
      </div>

      {/* Actions Slot */}
      {actions && (
        <div className="flex items-center gap-3 md:gap-4">
          {actions}
        </div>
      )}

      {/* Items per page dropdown */}
      <div className="flex items-center gap-2">
        <span className="text-[#727A90] text-sm md:text-base whitespace-nowrap">Display</span>
        <div className="relative">
          <select
            value={itemsPerPage}
            onChange={e => onItemsPerPageChange(parseInt(e.target.value, 10))}
            className="appearance-none h-[44px] pl-3 pr-10 min-w-[72px] md:min-w-[88px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-sm md:text-base focus:outline-none"
          >
            {itemsPerPageOptions.map(opt => (
              <option key={opt} value={opt}>{opt}</option>
            ))}
          </select>
          <img src="/caret-down.svg" alt="" aria-hidden="true" className="pointer-events-none absolute right-3 md:right-4 top-1/2 -translate-y-1/2 w-4 h-4" />
        </div>
      </div>
    </div>
  );

  // Pagination Controls JSX
  const renderPagination = () => (
    filteredItems.length > 0 && (
      <div className="flex justify-center p-4 md:p-6 mt-8">
        <div className="flex items-center gap-2 md:gap-3">
          {/* Previous Page */}
          <button
            onClick={onPreviousPage}
            disabled={currentPage === 1}
            className={`w-[44px] h-[44px] md:w-[52px] md:h-[52px] rounded-full border border-[#7E7B7B] flex items-center justify-center transition-colors ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : 'group hover:bg-blue-200 hover:border-white hover:text-white'}`}
          >
            <svg width="33" height="32" viewBox="0 0 33 32" fill="none" xmlns="http://www.w3.org/2000/svg" className={`stroke-current text-[#7E7B7B] ${currentPage === 1 ? '' : 'group-hover:text-white'}`}>
              <path d="M23.1667 5.33398L12.06 13.3873C9.09198 15.5407 9.09198 16.462 12.06 18.614L23.1667 26.6673" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
            </svg>
          </button>

          {/* Page Info */}
          <div className="flex items-center gap-2 text-sm text-[#4B5563]">
            <span>Page {currentPage} of {totalPages}</span>
            <span>({filteredItems.length} total)</span>
          </div>

          {/* Next Page */}
          <button
            onClick={onNextPage}
            disabled={currentPage === totalPages}
            className={`w-[44px] h-[44px] md:w-[52px] md:h-[52px] rounded-full border border-[#7E7B7B] flex items-center justify-center transition-colors ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : 'group hover:bg-blue-200 hover:border-white hover:text-white'}`}
          >
            <svg width="52" height="52" viewBox="0 0 52 52" fill="none" xmlns="http://www.w3.org/2000/svg" className={`stroke-current text-[#7E7B7B] ${currentPage === totalPages ? '' : 'group-hover:text-white'}`}>
              <circle cx="26" cy="26" r="25.5" strokeWidth="1" />
              <path d="M20.8333 15.334L31.94 23.3873C34.908 25.5407 34.908 26.462 31.94 28.614L20.8333 36.6673" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
            </svg>
          </button>
        </div>
      </div>
    )
  );

  return (
    <div className="w-full min-h-[200px] p-4 md:p-6 relative bg-gradient-to-br from-white to-[#E7F4FF] rounded-[10px] shadow-[2px_2px_6px_rgba(24,95,235,0.1)]">
      {renderHeader()}
      {/* Optional search results info */}
      {searchTerm && (
        <div className="mb-4 text-sm text-[#4B5563]">
          Showing {filteredItems.length} results for "{searchTerm}"
        </div>
      )}
      {/* Children render function for list content */}
      {children({
        currentItems,
        filteredItems,
        searchTerm,
        onSearchChange,
        isMobile,
        isSearchExpanded,
        toggleSearch,
        onSearchBlur,
        itemsPerPage,
        onItemsPerPageChange,
        currentPage,
        totalPages,
        onPreviousPage,
        onNextPage,
        loading,
        error,
      })}
      {renderPagination()}
    </div>
  );
};

export default DataContainer;
</file>

<file path="src/components/TinyTapEditor.jsx">
// src/components/SimpleEditor.jsx
import React, { useEffect, useState } from 'react';
import { useEditor, EditorContent } from '@tiptap/react';
import StarterKit from '@tiptap/starter-kit';
import Placeholder from '@tiptap/extension-placeholder';
import Link from '@tiptap/extension-link';
import CharacterCount from '@tiptap/extension-character-count';

function MenuBar({ editor }) {
  if (!editor) {
    return null;
  }
  return (
    <div className="flex flex-wrap gap-2 mb-2">
      {/* Bold */}
      <button
        type="button"
        onClick={() => editor.chain().focus().toggleBold().run()}
        className={`px-2 py-1 border rounded ${editor.isActive('bold') ? 'bg-gray-200' : ''}`}
      >
        B
      </button>
      {/* Italic */}
      <button
        type="button"
        onClick={() => editor.chain().focus().toggleItalic().run()}
        className={`px-2 py-1 border rounded ${editor.isActive('italic') ? 'bg-gray-200' : ''}`}
      >
        I
      </button>
      {/* Heading */}
      <button
        type="button"
        onClick={() => editor.chain().focus().toggleHeading({ level: 2 }).run()}
        className={`px-2 py-1 border rounded ${editor.isActive('heading', { level: 2 }) ? 'bg-gray-200' : ''}`}
      >
        H2
      </button>
      {/* Bullet List */}
      <button
        type="button"
        onClick={() => editor.chain().focus().toggleBulletList().run()}
        className={`px-2 py-1 border rounded ${editor.isActive('bulletList') ? 'bg-gray-200' : ''}`}
      >
        • List
      </button>
      {/* Link */}
      <button
        type="button"
        onClick={() => {
          const url = window.prompt('Enter URL');
          if (url) {
            editor.chain().focus().extendMarkRange('link').setLink({ href: url }).run();
          }
        }}
        className={`px-2 py-1 border rounded ${editor.isActive('link') ? 'bg-gray-200' : ''}`}
      >
        Link
      </button>
      {/* Clear formatting */}
      <button
        type="button"
        onClick={() => editor.chain().focus().unsetAllMarks().clearNodes().run()}
        className="px-2 py-1 border rounded"
      >
        Clear
      </button>
    </div>
  );
}

export default function SimpleEditor({ initialContent = '', onUpdate }) {
  const editor = useEditor({
    extensions: [
      StarterKit,
      Placeholder.configure({ placeholder: 'Start typing...' }),
      Link.configure({ openOnClick: true }),
      CharacterCount.configure({ limit: 1000 }), // optional: adjust limit or remove
    ],
    content: initialContent,
    onUpdate: ({ editor }) => {
      const html = editor.getHTML();
      const json = editor.getJSON();
      if (onUpdate) {
        onUpdate({ html, json });
      }
    },
  });

  // Clean up editor on unmount
  useEffect(() => {
    return () => {
      if (editor) {
        editor.destroy();
      }
    };
  }, [editor]);

  return (
    <div className="border rounded-md">
      <MenuBar editor={editor} />
      <EditorContent editor={editor} className="ProseMirror p-4 min-h-[200px]" />
      {/* Optional: character count display */}
      {editor && (
        <div className="text-sm text-gray-500 mt-1 text-right">
          {editor.storage.characterCount.characters()} / 1000
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/tiptap-extension/link-extension.js">
import TiptapLink from "@tiptap/extension-link"
import { getMarkRange } from "@tiptap/react"
import { Plugin, TextSelection } from "@tiptap/pm/state"

export const Link = TiptapLink.extend({
  inclusive: false,

  parseHTML() {
    return [
      {
        tag: 'a[href]:not([data-type="button"]):not([href *= "javascript:" i])',
      },
    ]
  },

  addProseMirrorPlugins() {
    const { editor } = this

    return [
      ...(this.parent?.() || []),
      new Plugin({
        props: {
          handleKeyDown: (_, event) => {
            const { selection } = editor.state

            if (event.key === "Escape" && selection.empty !== true) {
              editor.commands.focus(selection.to, { scrollIntoView: false })
            }

            return false
          },
          handleClick(view, pos) {
            const { schema, doc, tr } = view.state
            let range

            if (schema.marks.link) {
              range = getMarkRange(doc.resolve(pos), schema.marks.link)
            }

            if (!range) {
              return
            }

            const { from, to } = range
            const start = Math.min(from, to)
            const end = Math.max(from, to)

            if (pos < start || pos > end) {
              return
            }

            const $start = doc.resolve(start)
            const $end = doc.resolve(end)
            const transaction = tr.setSelection(new TextSelection($start, $end))

            view.dispatch(transaction)
          },
        },
      }),
    ];
  },
})

export default Link
</file>

<file path="src/components/tiptap-extension/selection-extension.js">
import { Extension, isNodeSelection } from "@tiptap/react"
import { Plugin, PluginKey } from "@tiptap/pm/state"
import { Decoration, DecorationSet } from "@tiptap/pm/view"

export const Selection = Extension.create({
  name: "selection",

  addProseMirrorPlugins() {
    const { editor } = this

    return [
      new Plugin({
        key: new PluginKey("selection"),
        props: {
          decorations(state) {
            if (state.selection.empty) {
              return null
            }

            if (editor.isFocused === true || !editor.isEditable) {
              return null
            }

            if (isNodeSelection(state.selection)) {
              return null
            }

            return DecorationSet.create(state.doc, [
              Decoration.inline(state.selection.from, state.selection.to, {
                class: "selection",
              }),
            ]);
          },
        },
      }),
    ];
  },
})

export default Selection
</file>

<file path="src/components/tiptap-extension/trailing-node-extension.js">
import { Extension } from "@tiptap/react"
import { Plugin, PluginKey } from "@tiptap/pm/state"

function nodeEqualsType({
  types,
  node
}) {
  if (!node) return false

  if (Array.isArray(types)) {
    return types.includes(node.type);
  }

  return node.type === types
}

export const TrailingNode = Extension.create({
  name: "trailingNode",

  addOptions() {
    return {
      node: "paragraph",
      notAfter: ["paragraph"],
    }
  },

  addProseMirrorPlugins() {
    const plugin = new PluginKey(this.name)
    const disabledNodes = Object.entries(this.editor.schema.nodes)
      .map(([, value]) => value)
      .filter((node) => this.options.notAfter.includes(node.name))

    return [
      new Plugin({
        key: plugin,
        appendTransaction: (_, __, state) => {
          const { doc, tr, schema } = state
          const shouldInsertNodeAtEnd = plugin.getState(state)
          const endPosition = doc.content.size
          const type = schema.nodes[this.options.node]

          if (!shouldInsertNodeAtEnd) {
            return null
          }

          if (type) {
            return tr.insert(endPosition, type.create());
          }

          return null
        },
        state: {
          init: (_, state) => {
            const lastNode = state.tr.doc.lastChild

            return !nodeEqualsType({ node: lastNode, types: disabledNodes });
          },
          apply: (tr, value) => {
            if (!tr.docChanged) {
              return value
            }

            const lastNode = tr.doc.lastChild

            return !nodeEqualsType({ node: lastNode, types: disabledNodes });
          },
        },
      }),
    ];
  },
})

export default TrailingNode
</file>

<file path="src/components/tiptap-icons/align-center-icon.jsx">
import * as React from "react"

export const AlignCenterIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M2 6C2 5.44772 2.44772 5 3 5H21C21.5523 5 22 5.44772 22 6C22 6.55228 21.5523 7 21 7H3C2.44772 7 2 6.55228 2 6Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M6 12C6 11.4477 6.44772 11 7 11H17C17.5523 11 18 11.4477 18 12C18 12.5523 17.5523 13 17 13H7C6.44772 13 6 12.5523 6 12Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M4 18C4 17.4477 4.44772 17 5 17H19C19.5523 17 20 17.4477 20 18C20 18.5523 19.5523 19 19 19H5C4.44772 19 4 18.5523 4 18Z"
        fill="currentColor" />
    </svg>
  );
})

AlignCenterIcon.displayName = "AlignCenterIcon"
</file>

<file path="src/components/tiptap-icons/align-justify-icon.jsx">
import * as React from "react"

export const AlignJustifyIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M2 6C2 5.44772 2.44772 5 3 5H21C21.5523 5 22 5.44772 22 6C22 6.55228 21.5523 7 21 7H3C2.44772 7 2 6.55228 2 6Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M2 12C2 11.4477 2.44772 11 3 11H21C21.5523 11 22 11.4477 22 12C22 12.5523 21.5523 13 21 13H3C2.44772 13 2 12.5523 2 12Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M2 18C2 17.4477 2.44772 17 3 17H21C21.5523 17 22 17.4477 22 18C22 18.5523 21.5523 19 21 19H3C2.44772 19 2 18.5523 2 18Z"
        fill="currentColor" />
    </svg>
  );
})

AlignJustifyIcon.displayName = "AlignJustifyIcon"
</file>

<file path="src/components/tiptap-icons/align-left-icon.jsx">
import * as React from "react"

export const AlignLeftIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M2 6C2 5.44772 2.44772 5 3 5H21C21.5523 5 22 5.44772 22 6C22 6.55228 21.5523 7 21 7H3C2.44772 7 2 6.55228 2 6Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M2 12C2 11.4477 2.44772 11 3 11H15C15.5523 11 16 11.4477 16 12C16 12.5523 15.5523 13 15 13H3C2.44772 13 2 12.5523 2 12Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M2 18C2 17.4477 2.44772 17 3 17H17C17.5523 17 18 17.4477 18 18C18 18.5523 17.5523 19 17 19H3C2.44772 19 2 18.5523 2 18Z"
        fill="currentColor" />
    </svg>
  );
})

AlignLeftIcon.displayName = "AlignLeftIcon"
</file>

<file path="src/components/tiptap-icons/align-right-icon.jsx">
import * as React from "react"

export const AlignRightIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M2 6C2 5.44772 2.44772 5 3 5H21C21.5523 5 22 5.44772 22 6C22 6.55228 21.5523 7 21 7H3C2.44772 7 2 6.55228 2 6Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M8 12C8 11.4477 8.44772 11 9 11H21C21.5523 11 22 11.4477 22 12C22 12.5523 21.5523 13 21 13H9C8.44772 13 8 12.5523 8 12Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M6 18C6 17.4477 6.44772 17 7 17H21C21.5523 17 22 17.4477 22 18C22 18.5523 21.5523 19 21 19H7C6.44772 19 6 18.5523 6 18Z"
        fill="currentColor" />
    </svg>
  );
})

AlignRightIcon.displayName = "AlignRightIcon"
</file>

<file path="src/components/tiptap-icons/arrow-left-icon.jsx">
import * as React from "react"

export const ArrowLeftIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        d="M12.7071 5.70711C13.0976 5.31658 13.0976 4.68342 12.7071 4.29289C12.3166 3.90237 11.6834 3.90237 11.2929 4.29289L4.29289 11.2929C3.90237 11.6834 3.90237 12.3166 4.29289 12.7071L11.2929 19.7071C11.6834 20.0976 12.3166 20.0976 12.7071 19.7071C13.0976 19.3166 13.0976 18.6834 12.7071 18.2929L7.41421 13L19 13C19.5523 13 20 12.5523 20 12C20 11.4477 19.5523 11 19 11L7.41421 11L12.7071 5.70711Z"
        fill="currentColor" />
    </svg>
  );
})

ArrowLeftIcon.displayName = "ArrowLeftIcon"
</file>

<file path="src/components/tiptap-icons/ban-icon.jsx">
import * as React from "react"

export const BanIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M4.43471 4.01458C4.34773 4.06032 4.26607 4.11977 4.19292 4.19292C4.11977 4.26607 4.06032 4.34773 4.01458 4.43471C2.14611 6.40628 1 9.0693 1 12C1 18.0751 5.92487 23 12 23C14.9306 23 17.5936 21.854 19.5651 19.9856C19.6522 19.9398 19.7339 19.8803 19.8071 19.8071C19.8803 19.7339 19.9398 19.6522 19.9856 19.5651C21.854 17.5936 23 14.9306 23 12C23 5.92487 18.0751 1 12 1C9.0693 1 6.40628 2.14611 4.43471 4.01458ZM6.38231 4.9681C7.92199 3.73647 9.87499 3 12 3C16.9706 3 21 7.02944 21 12C21 14.125 20.2635 16.078 19.0319 17.6177L6.38231 4.9681ZM17.6177 19.0319C16.078 20.2635 14.125 21 12 21C7.02944 21 3 16.9706 3 12C3 9.87499 3.73647 7.92199 4.9681 6.38231L17.6177 19.0319Z"
        fill="currentColor" />
    </svg>
  );
})

BanIcon.displayName = "BanIcon"
</file>

<file path="src/components/tiptap-icons/block-quote-icon.jsx">
import * as React from "react"

export const BlockQuoteIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M8 6C8 5.44772 8.44772 5 9 5H16C16.5523 5 17 5.44772 17 6C17 6.55228 16.5523 7 16 7H9C8.44772 7 8 6.55228 8 6Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M4 3C4.55228 3 5 3.44772 5 4L5 20C5 20.5523 4.55229 21 4 21C3.44772 21 3 20.5523 3 20L3 4C3 3.44772 3.44772 3 4 3Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M8 12C8 11.4477 8.44772 11 9 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H9C8.44772 13 8 12.5523 8 12Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M8 18C8 17.4477 8.44772 17 9 17H16C16.5523 17 17 17.4477 17 18C17 18.5523 16.5523 19 16 19H9C8.44772 19 8 18.5523 8 18Z"
        fill="currentColor" />
    </svg>
  );
})

BlockQuoteIcon.displayName = "BlockQuoteIcon"
</file>

<file path="src/components/tiptap-icons/bold-icon.jsx">
import * as React from "react"

export const BoldIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M6 2.5C5.17157 2.5 4.5 3.17157 4.5 4V20C4.5 20.8284 5.17157 21.5 6 21.5H15C16.4587 21.5 17.8576 20.9205 18.8891 19.8891C19.9205 18.8576 20.5 17.4587 20.5 16C20.5 14.5413 19.9205 13.1424 18.8891 12.1109C18.6781 11.9 18.4518 11.7079 18.2128 11.5359C19.041 10.5492 19.5 9.29829 19.5 8C19.5 6.54131 18.9205 5.14236 17.8891 4.11091C16.8576 3.07946 15.4587 2.5 14 2.5H6ZM14 10.5C14.663 10.5 15.2989 10.2366 15.7678 9.76777C16.2366 9.29893 16.5 8.66304 16.5 8C16.5 7.33696 16.2366 6.70107 15.7678 6.23223C15.2989 5.76339 14.663 5.5 14 5.5H7.5V10.5H14ZM7.5 18.5V13.5H15C15.663 13.5 16.2989 13.7634 16.7678 14.2322C17.2366 14.7011 17.5 15.337 17.5 16C17.5 16.663 17.2366 17.2989 16.7678 17.7678C16.2989 18.2366 15.663 18.5 15 18.5H7.5Z"
        fill="currentColor" />
    </svg>
  );
})

BoldIcon.displayName = "BoldIcon"
</file>

<file path="src/components/tiptap-icons/chevron-down-icon.jsx">
import * as React from "react"

export const ChevronDownIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M5.29289 8.29289C5.68342 7.90237 6.31658 7.90237 6.70711 8.29289L12 13.5858L17.2929 8.29289C17.6834 7.90237 18.3166 7.90237 18.7071 8.29289C19.0976 8.68342 19.0976 9.31658 18.7071 9.70711L12.7071 15.7071C12.3166 16.0976 11.6834 16.0976 11.2929 15.7071L5.29289 9.70711C4.90237 9.31658 4.90237 8.68342 5.29289 8.29289Z"
        fill="currentColor" />
    </svg>
  );
})

ChevronDownIcon.displayName = "ChevronDownIcon"
</file>

<file path="src/components/tiptap-icons/close-icon.jsx">
import * as React from "react"

export const CloseIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        d="M18.7071 6.70711C19.0976 6.31658 19.0976 5.68342 18.7071 5.29289C18.3166 4.90237 17.6834 4.90237 17.2929 5.29289L12 10.5858L6.70711 5.29289C6.31658 4.90237 5.68342 4.90237 5.29289 5.29289C4.90237 5.68342 4.90237 6.31658 5.29289 6.70711L10.5858 12L5.29289 17.2929C4.90237 17.6834 4.90237 18.3166 5.29289 18.7071C5.68342 19.0976 6.31658 19.0976 6.70711 18.7071L12 13.4142L17.2929 18.7071C17.6834 19.0976 18.3166 19.0976 18.7071 18.7071C19.0976 18.3166 19.0976 17.6834 18.7071 17.2929L13.4142 12L18.7071 6.70711Z"
        fill="currentColor" />
    </svg>
  );
})

CloseIcon.displayName = "CloseIcon"
</file>

<file path="src/components/tiptap-icons/code-block-icon.jsx">
import * as React from "react"

export const CodeBlockIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M6.70711 2.29289C7.09763 2.68342 7.09763 3.31658 6.70711 3.70711L4.41421 6L6.70711 8.29289C7.09763 8.68342 7.09763 9.31658 6.70711 9.70711C6.31658 10.0976 5.68342 10.0976 5.29289 9.70711L2.29289 6.70711C1.90237 6.31658 1.90237 5.68342 2.29289 5.29289L5.29289 2.29289C5.68342 1.90237 6.31658 1.90237 6.70711 2.29289Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M10.2929 2.29289C10.6834 1.90237 11.3166 1.90237 11.7071 2.29289L14.7071 5.29289C15.0976 5.68342 15.0976 6.31658 14.7071 6.70711L11.7071 9.70711C11.3166 10.0976 10.6834 10.0976 10.2929 9.70711C9.90237 9.31658 9.90237 8.68342 10.2929 8.29289L12.5858 6L10.2929 3.70711C9.90237 3.31658 9.90237 2.68342 10.2929 2.29289Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M17 4C17 3.44772 17.4477 3 18 3H19C20.6569 3 22 4.34315 22 6V18C22 19.6569 20.6569 21 19 21H5C3.34315 21 2 19.6569 2 18V12C2 11.4477 2.44772 11 3 11C3.55228 11 4 11.4477 4 12V18C4 18.5523 4.44772 19 5 19H19C19.5523 19 20 18.5523 20 18V6C20 5.44772 19.5523 5 19 5H18C17.4477 5 17 4.55228 17 4Z"
        fill="currentColor" />
    </svg>
  );
})

CodeBlockIcon.displayName = "CodeBlockIcon"
</file>

<file path="src/components/tiptap-icons/code2-icon.jsx">
import * as React from "react"

export const Code2Icon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        d="M15.4545 4.2983C15.6192 3.77115 15.3254 3.21028 14.7983 3.04554C14.2712 2.88081 13.7103 3.1746 13.5455 3.70175L8.54554 19.7017C8.38081 20.2289 8.6746 20.7898 9.20175 20.9545C9.72889 21.1192 10.2898 20.8254 10.4545 20.2983L15.4545 4.2983Z"
        fill="currentColor" />
      <path
        d="M6.70711 7.29289C7.09763 7.68342 7.09763 8.31658 6.70711 8.70711L3.41421 12L6.70711 15.2929C7.09763 15.6834 7.09763 16.3166 6.70711 16.7071C6.31658 17.0976 5.68342 17.0976 5.29289 16.7071L1.29289 12.7071C0.902369 12.3166 0.902369 11.6834 1.29289 11.2929L5.29289 7.29289C5.68342 6.90237 6.31658 6.90237 6.70711 7.29289Z"
        fill="currentColor" />
      <path
        d="M17.2929 7.29289C17.6834 6.90237 18.3166 6.90237 18.7071 7.29289L22.7071 11.2929C23.0976 11.6834 23.0976 12.3166 22.7071 12.7071L18.7071 16.7071C18.3166 17.0976 17.6834 17.0976 17.2929 16.7071C16.9024 16.3166 16.9024 15.6834 17.2929 15.2929L20.5858 12L17.2929 8.70711C16.9024 8.31658 16.9024 7.68342 17.2929 7.29289Z"
        fill="currentColor" />
    </svg>
  );
})

Code2Icon.displayName = "Code2Icon"
</file>

<file path="src/components/tiptap-icons/corner-down-left-icon.jsx">
import * as React from "react"

export const CornerDownLeftIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M21 4C21 3.44772 20.5523 3 20 3C19.4477 3 19 3.44772 19 4V11C19 11.7956 18.6839 12.5587 18.1213 13.1213C17.5587 13.6839 16.7956 14 16 14H6.41421L9.70711 10.7071C10.0976 10.3166 10.0976 9.68342 9.70711 9.29289C9.31658 8.90237 8.68342 8.90237 8.29289 9.29289L3.29289 14.2929C2.90237 14.6834 2.90237 15.3166 3.29289 15.7071L8.29289 20.7071C8.68342 21.0976 9.31658 21.0976 9.70711 20.7071C10.0976 20.3166 10.0976 19.6834 9.70711 19.2929L6.41421 16H16C17.3261 16 18.5979 15.4732 19.5355 14.5355C20.4732 13.5979 21 12.3261 21 11V4Z"
        fill="currentColor" />
    </svg>
  );
})

CornerDownLeftIcon.displayName = "CornerDownLeftIcon"
</file>

<file path="src/components/tiptap-icons/external-link-icon.jsx">
import * as React from "react"

export const ExternalLinkIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        d="M14 3C14 2.44772 14.4477 2 15 2H21C21.5523 2 22 2.44772 22 3V9C22 9.55228 21.5523 10 21 10C20.4477 10 20 9.55228 20 9V5.41421L10.7071 14.7071C10.3166 15.0976 9.68342 15.0976 9.29289 14.7071C8.90237 14.3166 8.90237 13.6834 9.29289 13.2929L18.5858 4H15C14.4477 4 14 3.55228 14 3Z"
        fill="currentColor" />
      <path
        d="M4.29289 7.29289C4.48043 7.10536 4.73478 7 5 7H11C11.5523 7 12 6.55228 12 6C12 5.44772 11.5523 5 11 5H5C4.20435 5 3.44129 5.31607 2.87868 5.87868C2.31607 6.44129 2 7.20435 2 8V19C2 19.7957 2.31607 20.5587 2.87868 21.1213C3.44129 21.6839 4.20435 22 5 22H16C16.7957 22 17.5587 21.6839 18.1213 21.1213C18.6839 20.5587 19 19.7957 19 19V13C19 12.4477 18.5523 12 18 12C17.4477 12 17 12.4477 17 13V19C17 19.2652 16.8946 19.5196 16.7071 19.7071C16.5196 19.8946 16.2652 20 16 20H5C4.73478 20 4.48043 19.8946 4.29289 19.7071C4.10536 19.5196 4 19.2652 4 19V8C4 7.73478 4.10536 7.48043 4.29289 7.29289Z"
        fill="currentColor" />
    </svg>
  );
})

ExternalLinkIcon.displayName = "ExternalLinkIcon"
</file>

<file path="src/components/tiptap-icons/heading-five-icon.jsx">
import * as React from "react"

export const HeadingFiveIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        d="M5 6C5 5.44772 4.55228 5 4 5C3.44772 5 3 5.44772 3 6V18C3 18.5523 3.44772 19 4 19C4.55228 19 5 18.5523 5 18V13H11V18C11 18.5523 11.4477 19 12 19C12.5523 19 13 18.5523 13 18V6C13 5.44772 12.5523 5 12 5C11.4477 5 11 5.44772 11 6V11H5V6Z"
        fill="currentColor" />
      <path
        d="M16 10C16 9.44772 16.4477 9 17 9H21C21.5523 9 22 9.44772 22 10C22 10.5523 21.5523 11 21 11H18V12H18.3C20.2754 12 22 13.4739 22 15.5C22 17.5261 20.2754 19 18.3 19C17.6457 19 17.0925 18.8643 16.5528 18.5944C16.0588 18.3474 15.8586 17.7468 16.1055 17.2528C16.3525 16.7588 16.9532 16.5586 17.4472 16.8056C17.7074 16.9357 17.9542 17 18.3 17C19.3246 17 20 16.2739 20 15.5C20 14.7261 19.3246 14 18.3 14H17C16.4477 14 16 13.5523 16 13L16 12.9928V10Z"
        fill="currentColor" />
    </svg>
  );
})

HeadingFiveIcon.displayName = "HeadingFiveIcon"
</file>

<file path="src/components/tiptap-icons/heading-four-icon.jsx">
import * as React from "react"

export const HeadingFourIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        d="M4 5C4.55228 5 5 5.44772 5 6V11H11V6C11 5.44772 11.4477 5 12 5C12.5523 5 13 5.44772 13 6V18C13 18.5523 12.5523 19 12 19C11.4477 19 11 18.5523 11 18V13H5V18C5 18.5523 4.55228 19 4 19C3.44772 19 3 18.5523 3 18V6C3 5.44772 3.44772 5 4 5Z"
        fill="currentColor" />
      <path
        d="M17 9C17.5523 9 18 9.44772 18 10V13H20V10C20 9.44772 20.4477 9 21 9C21.5523 9 22 9.44772 22 10V18C22 18.5523 21.5523 19 21 19C20.4477 19 20 18.5523 20 18V15H17C16.4477 15 16 14.5523 16 14V10C16 9.44772 16.4477 9 17 9Z"
        fill="currentColor" />
    </svg>
  );
})

HeadingFourIcon.displayName = "HeadingFourIcon"
</file>

<file path="src/components/tiptap-icons/heading-icon.jsx">
import * as React from "react"

export const HeadingIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        d="M6 3C6.55228 3 7 3.44772 7 4V11H17V4C17 3.44772 17.4477 3 18 3C18.5523 3 19 3.44772 19 4V20C19 20.5523 18.5523 21 18 21C17.4477 21 17 20.5523 17 20V13H7V20C7 20.5523 6.55228 21 6 21C5.44772 21 5 20.5523 5 20V4C5 3.44772 5.44772 3 6 3Z"
        fill="currentColor" />
    </svg>
  );
})

HeadingIcon.displayName = "HeadingIcon"
</file>

<file path="src/components/tiptap-icons/heading-one-icon.jsx">
import * as React from "react"

export const HeadingOneIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        d="M5 6C5 5.44772 4.55228 5 4 5C3.44772 5 3 5.44772 3 6V18C3 18.5523 3.44772 19 4 19C4.55228 19 5 18.5523 5 18V13H11V18C11 18.5523 11.4477 19 12 19C12.5523 19 13 18.5523 13 18V6C13 5.44772 12.5523 5 12 5C11.4477 5 11 5.44772 11 6V11H5V6Z"
        fill="currentColor" />
      <path
        d="M21.0001 10C21.0001 9.63121 20.7971 9.29235 20.472 9.11833C20.1468 8.94431 19.7523 8.96338 19.4454 9.16795L16.4454 11.168C15.9859 11.4743 15.8617 12.0952 16.1681 12.5547C16.4744 13.0142 17.0953 13.1384 17.5548 12.8321L19.0001 11.8685V18C19.0001 18.5523 19.4478 19 20.0001 19C20.5524 19 21.0001 18.5523 21.0001 18V10Z"
        fill="currentColor" />
    </svg>
  );
})

HeadingOneIcon.displayName = "HeadingOneIcon"
</file>

<file path="src/components/tiptap-icons/heading-six-icon.jsx">
import * as React from "react"

export const HeadingSixIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        d="M5 6C5 5.44772 4.55228 5 4 5C3.44772 5 3 5.44772 3 6V18C3 18.5523 3.44772 19 4 19C4.55228 19 5 18.5523 5 18V13H11V18C11 18.5523 11.4477 19 12 19C12.5523 19 13 18.5523 13 18V6C13 5.44772 12.5523 5 12 5C11.4477 5 11 5.44772 11 6V11H5V6Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M20.7071 9.29289C21.0976 9.68342 21.0976 10.3166 20.7071 10.7071C19.8392 11.575 19.2179 12.2949 18.7889 13.0073C18.8587 13.0025 18.929 13 19 13C20.6569 13 22 14.3431 22 16C22 17.6569 20.6569 19 19 19C17.3431 19 16 17.6569 16 16C16 14.6007 16.2837 13.4368 16.8676 12.3419C17.4384 11.2717 18.2728 10.3129 19.2929 9.29289C19.6834 8.90237 20.3166 8.90237 20.7071 9.29289ZM19 17C18.4477 17 18 16.5523 18 16C18 15.4477 18.4477 15 19 15C19.5523 15 20 15.4477 20 16C20 16.5523 19.5523 17 19 17Z"
        fill="currentColor" />
    </svg>
  );
})

HeadingSixIcon.displayName = "HeadingSixIcon"
</file>

<file path="src/components/tiptap-icons/heading-three-icon.jsx">
import * as React from "react"

export const HeadingThreeIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        d="M4 5C4.55228 5 5 5.44772 5 6V11H11V6C11 5.44772 11.4477 5 12 5C12.5523 5 13 5.44772 13 6V18C13 18.5523 12.5523 19 12 19C11.4477 19 11 18.5523 11 18V13H5V18C5 18.5523 4.55228 19 4 19C3.44772 19 3 18.5523 3 18V6C3 5.44772 3.44772 5 4 5Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M19.4608 11.2169C19.1135 11.0531 18.5876 11.0204 18.0069 11.3619C17.5309 11.642 16.918 11.4831 16.638 11.007C16.358 10.531 16.5169 9.91809 16.9929 9.63807C18.1123 8.97962 19.3364 8.94691 20.314 9.40808C21.2839 9.86558 21.9999 10.818 21.9999 12C21.9999 12.7957 21.6838 13.5587 21.1212 14.1213C20.5586 14.6839 19.7956 15 18.9999 15C18.4476 15 17.9999 14.5523 17.9999 14C17.9999 13.4477 18.4476 13 18.9999 13C19.2651 13 19.5195 12.8947 19.707 12.7071C19.8946 12.5196 19.9999 12.2652 19.9999 12C19.9999 11.6821 19.8159 11.3844 19.4608 11.2169Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M18.0001 14C18.0001 13.4477 18.4478 13 19.0001 13C19.7957 13 20.5588 13.3161 21.1214 13.8787C21.684 14.4413 22.0001 15.2043 22.0001 16C22.0001 17.2853 21.2767 18.3971 20.1604 18.8994C19.0257 19.41 17.642 19.2315 16.4001 18.3C15.9582 17.9686 15.8687 17.3418 16.2001 16.9C16.5314 16.4582 17.1582 16.3686 17.6001 16.7C18.3581 17.2685 18.9744 17.24 19.3397 17.0756C19.7234 16.9029 20.0001 16.5147 20.0001 16C20.0001 15.7348 19.8947 15.4804 19.7072 15.2929C19.5196 15.1054 19.2653 15 19.0001 15C18.4478 15 18.0001 14.5523 18.0001 14Z"
        fill="currentColor" />
    </svg>
  );
})

HeadingThreeIcon.displayName = "HeadingThreeIcon"
</file>

<file path="src/components/tiptap-icons/heading-two-icon.jsx">
import * as React from "react"

export const HeadingTwoIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        d="M5 6C5 5.44772 4.55228 5 4 5C3.44772 5 3 5.44772 3 6V18C3 18.5523 3.44772 19 4 19C4.55228 19 5 18.5523 5 18V13H11V18C11 18.5523 11.4477 19 12 19C12.5523 19 13 18.5523 13 18V6C13 5.44772 12.5523 5 12 5C11.4477 5 11 5.44772 11 6V11H5V6Z"
        fill="currentColor" />
      <path
        d="M22.0001 12C22.0001 10.7611 21.1663 9.79297 20.0663 9.42632C18.9547 9.05578 17.6171 9.28724 16.4001 10.2C15.9582 10.5314 15.8687 11.1582 16.2001 11.6C16.5314 12.0418 17.1582 12.1314 17.6001 11.8C18.383 11.2128 19.0455 11.1942 19.4338 11.3237C19.8339 11.457 20.0001 11.7389 20.0001 12C20.0001 12.4839 19.8554 12.7379 19.6537 12.9481C19.4275 13.1837 19.1378 13.363 18.7055 13.6307C18.6313 13.6767 18.553 13.7252 18.4701 13.777C17.9572 14.0975 17.3128 14.5261 16.8163 15.2087C16.3007 15.9177 16.0001 16.8183 16.0001 18C16.0001 18.5523 16.4478 19 17.0001 19H21.0001C21.5523 19 22.0001 18.5523 22.0001 18C22.0001 17.4477 21.5523 17 21.0001 17H18.131C18.21 16.742 18.3176 16.5448 18.4338 16.385C18.6873 16.0364 19.0429 15.7775 19.5301 15.473C19.5898 15.4357 19.6536 15.3966 19.7205 15.3556C20.139 15.0992 20.6783 14.7687 21.0964 14.3332C21.6447 13.7621 22.0001 13.0161 22.0001 12Z"
        fill="currentColor" />
    </svg>
  );
})

HeadingTwoIcon.displayName = "HeadingTwoIcon"
</file>

<file path="src/components/tiptap-icons/highlighter-icon.jsx">
import * as React from "react"

export const HighlighterIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M14.7072 4.70711C15.0977 4.31658 15.0977 3.68342 14.7072 3.29289C14.3167 2.90237 13.6835 2.90237 13.293 3.29289L8.69294 7.89286L8.68594 7.9C8.13626 8.46079 7.82837 9.21474 7.82837 10C7.82837 10.2306 7.85491 10.4584 7.90631 10.6795L2.29289 16.2929C2.10536 16.4804 2 16.7348 2 17V20C2 20.5523 2.44772 21 3 21H12C12.2652 21 12.5196 20.8946 12.7071 20.7071L15.3205 18.0937C15.5416 18.1452 15.7695 18.1717 16.0001 18.1717C16.7853 18.1717 17.5393 17.8639 18.1001 17.3142L22.7072 12.7071C23.0977 12.3166 23.0977 11.6834 22.7072 11.2929C22.3167 10.9024 21.6835 10.9024 21.293 11.2929L16.6971 15.8887C16.5105 16.0702 16.2605 16.1717 16.0001 16.1717C15.7397 16.1717 15.4897 16.0702 15.303 15.8887L10.1113 10.697C9.92992 10.5104 9.82837 10.2604 9.82837 10C9.82837 9.73963 9.92992 9.48958 10.1113 9.30297L14.7072 4.70711ZM13.5858 17L9.00004 12.4142L4 17.4142V19H11.5858L13.5858 17Z"
        fill="currentColor" />
    </svg>
  );
})

HighlighterIcon.displayName = "HighlighterIcon"
</file>

<file path="src/components/tiptap-icons/image-plus-icon.jsx">
import * as React from "react"

export const ImagePlusIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M20 2C20 1.44772 19.5523 1 19 1C18.4477 1 18 1.44772 18 2V4H16C15.4477 4 15 4.44772 15 5C15 5.55228 15.4477 6 16 6H18V8C18 8.55228 18.4477 9 19 9C19.5523 9 20 8.55228 20 8V6H22C22.5523 6 23 5.55228 23 5C23 4.44772 22.5523 4 22 4H20V2ZM5 4C4.73478 4 4.48043 4.10536 4.29289 4.29289C4.10536 4.48043 4 4.73478 4 5V19C4 19.2652 4.10536 19.5196 4.29289 19.7071C4.48043 19.8946 4.73478 20 5 20H5.58579L14.379 11.2068C14.9416 10.6444 15.7045 10.3284 16.5 10.3284C17.2955 10.3284 18.0584 10.6444 18.621 11.2068L20 12.5858V12C20 11.4477 20.4477 11 21 11C21.5523 11 22 11.4477 22 12V14.998C22 14.9994 22 15.0007 22 15.002V19C22 19.7957 21.6839 20.5587 21.1213 21.1213C20.5587 21.6839 19.7957 22 19 22H6.00219C6.00073 22 5.99927 22 5.99781 22H5C4.20435 22 3.44129 21.6839 2.87868 21.1213C2.31607 20.5587 2 19.7957 2 19V5C2 4.20435 2.31607 3.44129 2.87868 2.87868C3.44129 2.31607 4.20435 2 5 2H12C12.5523 2 13 2.44772 13 3C13 3.55228 12.5523 4 12 4H5ZM8.41422 20H19C19.2652 20 19.5196 19.8946 19.7071 19.7071C19.8946 19.5196 20 19.2652 20 19V15.4142L17.207 12.6212C17.0195 12.4338 16.7651 12.3284 16.5 12.3284C16.2349 12.3284 15.9806 12.4337 15.7931 12.6211L8.41422 20ZM6.87868 6.87868C7.44129 6.31607 8.20435 6 9 6C9.79565 6 10.5587 6.31607 11.1213 6.87868C11.6839 7.44129 12 8.20435 12 9C12 9.79565 11.6839 10.5587 11.1213 11.1213C10.5587 11.6839 9.79565 12 9 12C8.20435 12 7.44129 11.6839 6.87868 11.1213C6.31607 10.5587 6 9.79565 6 9C6 8.20435 6.31607 7.44129 6.87868 6.87868ZM9 8C8.73478 8 8.48043 8.10536 8.29289 8.29289C8.10536 8.48043 8 8.73478 8 9C8 9.26522 8.10536 9.51957 8.29289 9.70711C8.48043 9.89464 8.73478 10 9 10C9.26522 10 9.51957 9.89464 9.70711 9.70711C9.89464 9.51957 10 9.26522 10 9C10 8.73478 9.89464 8.48043 9.70711 8.29289C9.51957 8.10536 9.26522 8 9 8Z"
        fill="currentColor" />
    </svg>
  );
})

ImagePlusIcon.displayName = "ImagePlusIcon"
</file>

<file path="src/components/tiptap-icons/italic-icon.jsx">
import * as React from "react"

export const ItalicIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        d="M15.0222 3H19C19.5523 3 20 3.44772 20 4C20 4.55228 19.5523 5 19 5H15.693L10.443 19H14C14.5523 19 15 19.4477 15 20C15 20.5523 14.5523 21 14 21H9.02418C9.00802 21.0004 8.99181 21.0004 8.97557 21H5C4.44772 21 4 20.5523 4 20C4 19.4477 4.44772 19 5 19H8.30704L13.557 5H10C9.44772 5 9 4.55228 9 4C9 3.44772 9.44772 3 10 3H14.9782C14.9928 2.99968 15.0075 2.99967 15.0222 3Z"
        fill="currentColor" />
    </svg>
  );
})

ItalicIcon.displayName = "ItalicIcon"
</file>

<file path="src/components/tiptap-icons/link-icon.jsx">
import * as React from "react"

export const LinkIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        d="M16.9958 1.06669C15.4226 1.05302 13.907 1.65779 12.7753 2.75074L12.765 2.76086L11.045 4.47086C10.6534 4.86024 10.6515 5.49341 11.0409 5.88507C11.4303 6.27673 12.0634 6.27858 12.4551 5.88919L14.1697 4.18456C14.9236 3.45893 15.9319 3.05752 16.9784 3.06662C18.0272 3.07573 19.0304 3.49641 19.772 4.23804C20.5137 4.97967 20.9344 5.98292 20.9435 7.03171C20.9526 8.07776 20.5515 9.08563 19.8265 9.83941L16.833 12.8329C16.4274 13.2386 15.9393 13.5524 15.4019 13.7529C14.8645 13.9533 14.2903 14.0359 13.7181 13.9949C13.146 13.9539 12.5894 13.7904 12.0861 13.5154C11.5827 13.2404 11.1444 12.8604 10.8008 12.401C10.47 11.9588 9.84333 11.8685 9.40108 12.1993C8.95883 12.5301 8.86849 13.1568 9.1993 13.599C9.71464 14.288 10.3721 14.858 11.1272 15.2705C11.8822 15.683 12.7171 15.9283 13.5753 15.9898C14.4334 16.0513 15.2948 15.9274 16.1009 15.6267C16.907 15.326 17.639 14.8555 18.2473 14.247L21.2472 11.2471L21.2593 11.2347C22.3523 10.1031 22.9571 8.58751 22.9434 7.01433C22.9297 5.44115 22.2987 3.93628 21.1863 2.82383C20.0738 1.71138 18.5689 1.08036 16.9958 1.06669Z"
        fill="currentColor" />
      <path
        d="M10.4247 8.0102C9.56657 7.94874 8.70522 8.07256 7.89911 8.37326C7.09305 8.67395 6.36096 9.14458 5.75272 9.753L2.75285 12.7529L2.74067 12.7653C1.64772 13.8969 1.04295 15.4125 1.05662 16.9857C1.07029 18.5589 1.70131 20.0637 2.81376 21.1762C3.9262 22.2886 5.43108 22.9196 7.00426 22.9333C8.57744 22.947 10.0931 22.3422 11.2247 21.2493L11.2371 21.2371L12.9471 19.5271C13.3376 19.1366 13.3376 18.5034 12.9471 18.1129C12.5565 17.7223 11.9234 17.7223 11.5328 18.1129L9.82932 19.8164C9.07555 20.5414 8.06768 20.9425 7.02164 20.9334C5.97285 20.9243 4.9696 20.5036 4.22797 19.762C3.48634 19.0203 3.06566 18.0171 3.05655 16.9683C3.04746 15.9222 3.44851 14.9144 4.17355 14.1606L7.16719 11.167C7.5727 10.7613 8.06071 10.4476 8.59811 10.2471C9.13552 10.0467 9.70976 9.96412 10.2819 10.0051C10.854 10.0461 11.4106 10.2096 11.9139 10.4846C12.4173 10.7596 12.8556 11.1397 13.1992 11.599C13.53 12.0412 14.1567 12.1316 14.5989 11.8007C15.0412 11.4699 15.1315 10.8433 14.8007 10.401C14.2854 9.71205 13.6279 9.14198 12.8729 8.72948C12.1178 8.31697 11.2829 8.07166 10.4247 8.0102Z"
        fill="currentColor" />
    </svg>
  );
})

LinkIcon.displayName = "LinkIcon"
</file>

<file path="src/components/tiptap-icons/list-icon.jsx">
import * as React from "react"

export const ListIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M7 6C7 5.44772 7.44772 5 8 5H21C21.5523 5 22 5.44772 22 6C22 6.55228 21.5523 7 21 7H8C7.44772 7 7 6.55228 7 6Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M7 12C7 11.4477 7.44772 11 8 11H21C21.5523 11 22 11.4477 22 12C22 12.5523 21.5523 13 21 13H8C7.44772 13 7 12.5523 7 12Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M7 18C7 17.4477 7.44772 17 8 17H21C21.5523 17 22 17.4477 22 18C22 18.5523 21.5523 19 21 19H8C7.44772 19 7 18.5523 7 18Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M2 6C2 5.44772 2.44772 5 3 5H3.01C3.56228 5 4.01 5.44772 4.01 6C4.01 6.55228 3.56228 7 3.01 7H3C2.44772 7 2 6.55228 2 6Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M2 12C2 11.4477 2.44772 11 3 11H3.01C3.56228 11 4.01 11.4477 4.01 12C4.01 12.5523 3.56228 13 3.01 13H3C2.44772 13 2 12.5523 2 12Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M2 18C2 17.4477 2.44772 17 3 17H3.01C3.56228 17 4.01 17.4477 4.01 18C4.01 18.5523 3.56228 19 3.01 19H3C2.44772 19 2 18.5523 2 18Z"
        fill="currentColor" />
    </svg>
  );
})

ListIcon.displayName = "ListIcon"
</file>

<file path="src/components/tiptap-icons/list-ordered-icon.jsx">
import * as React from "react"

export const ListOrderedIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M9 6C9 5.44772 9.44772 5 10 5H21C21.5523 5 22 5.44772 22 6C22 6.55228 21.5523 7 21 7H10C9.44772 7 9 6.55228 9 6Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M9 12C9 11.4477 9.44772 11 10 11H21C21.5523 11 22 11.4477 22 12C22 12.5523 21.5523 13 21 13H10C9.44772 13 9 12.5523 9 12Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M9 18C9 17.4477 9.44772 17 10 17H21C21.5523 17 22 17.4477 22 18C22 18.5523 21.5523 19 21 19H10C9.44772 19 9 18.5523 9 18Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M3 6C3 5.44772 3.44772 5 4 5H5C5.55228 5 6 5.44772 6 6V10C6 10.5523 5.55228 11 5 11C4.44772 11 4 10.5523 4 10V7C3.44772 7 3 6.55228 3 6Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M3 10C3 9.44772 3.44772 9 4 9H6C6.55228 9 7 9.44772 7 10C7 10.5523 6.55228 11 6 11H4C3.44772 11 3 10.5523 3 10Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M5.82219 13.0431C6.54543 13.4047 6.99997 14.1319 6.99997 15C6.99997 15.5763 6.71806 16.0426 6.48747 16.35C6.31395 16.5814 6.1052 16.8044 5.91309 17H5.99997C6.55226 17 6.99997 17.4477 6.99997 18C6.99997 18.5523 6.55226 19 5.99997 19H3.99997C3.44769 19 2.99997 18.5523 2.99997 18C2.99997 17.4237 3.28189 16.9575 3.51247 16.65C3.74323 16.3424 4.03626 16.0494 4.26965 15.8161C4.27745 15.8083 4.2852 15.8006 4.29287 15.7929C4.55594 15.5298 4.75095 15.3321 4.88748 15.15C4.96287 15.0495 4.99021 14.9922 4.99911 14.9714C4.99535 14.9112 4.9803 14.882 4.9739 14.8715C4.96613 14.8588 4.95382 14.845 4.92776 14.8319C4.87723 14.8067 4.71156 14.7623 4.44719 14.8944C3.95321 15.1414 3.35254 14.9412 3.10555 14.4472C2.85856 13.9533 3.05878 13.3526 3.55276 13.1056C4.28839 12.7378 5.12272 12.6934 5.82219 13.0431Z"
        fill="currentColor" />
    </svg>
  );
})

ListOrderedIcon.displayName = "ListOrderedIcon"
</file>

<file path="src/components/tiptap-icons/list-todo-icon.jsx">
import * as React from "react"

export const ListTodoIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M2 6C2 4.89543 2.89543 4 4 4H8C9.10457 4 10 4.89543 10 6V10C10 11.1046 9.10457 12 8 12H4C2.89543 12 2 11.1046 2 10V6ZM8 6H4V10H8V6Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M9.70711 14.2929C10.0976 14.6834 10.0976 15.3166 9.70711 15.7071L5.70711 19.7071C5.31658 20.0976 4.68342 20.0976 4.29289 19.7071L2.29289 17.7071C1.90237 17.3166 1.90237 16.6834 2.29289 16.2929C2.68342 15.9024 3.31658 15.9024 3.70711 16.2929L5 17.5858L8.29289 14.2929C8.68342 13.9024 9.31658 13.9024 9.70711 14.2929Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M12 6C12 5.44772 12.4477 5 13 5H21C21.5523 5 22 5.44772 22 6C22 6.55228 21.5523 7 21 7H13C12.4477 7 12 6.55228 12 6Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M12 12C12 11.4477 12.4477 11 13 11H21C21.5523 11 22 11.4477 22 12C22 12.5523 21.5523 13 21 13H13C12.4477 13 12 12.5523 12 12Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M12 18C12 17.4477 12.4477 17 13 17H21C21.5523 17 22 17.4477 22 18C22 18.5523 21.5523 19 21 19H13C12.4477 19 12 18.5523 12 18Z"
        fill="currentColor" />
    </svg>
  );
})

ListTodoIcon.displayName = "ListTodoIcon"
</file>

<file path="src/components/tiptap-icons/moon-star-icon.jsx">
import * as React from "react"

export const MoonStarIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M12 2C10.0222 2 8.08879 2.58649 6.4443 3.6853C4.79981 4.78412 3.51809 6.3459 2.76121 8.17317C2.00433 10.0004 1.8063 12.0111 2.19215 13.9509C2.578 15.8907 3.53041 17.6725 4.92894 19.0711C6.32746 20.4696 8.10929 21.422 10.0491 21.8079C11.9889 22.1937 13.9996 21.9957 15.8268 21.2388C17.6541 20.4819 19.2159 19.2002 20.3147 17.5557C21.4135 15.9112 22 13.9778 22 12C22 11.5955 21.7564 11.2309 21.3827 11.0761C21.009 10.9213 20.5789 11.0069 20.2929 11.2929C19.287 12.2988 17.9226 12.864 16.5 12.864C15.0774 12.864 13.713 12.2988 12.7071 11.2929C11.7012 10.287 11.136 8.92261 11.136 7.5C11.136 6.07739 11.7012 4.71304 12.7071 3.70711C12.9931 3.42111 13.0787 2.99099 12.9239 2.61732C12.7691 2.24364 12.4045 2 12 2ZM7.55544 5.34824C8.27036 4.87055 9.05353 4.51389 9.87357 4.28778C9.39271 5.27979 9.13604 6.37666 9.13604 7.5C9.13604 9.45304 9.91189 11.3261 11.2929 12.7071C12.6739 14.0881 14.547 14.864 16.5 14.864C17.6233 14.864 18.7202 14.6073 19.7122 14.1264C19.4861 14.9465 19.1295 15.7296 18.6518 16.4446C17.7727 17.7602 16.5233 18.7855 15.0615 19.391C13.5997 19.9965 11.9911 20.155 10.4393 19.8463C8.88743 19.5376 7.46197 18.7757 6.34315 17.6569C5.22433 16.538 4.4624 15.1126 4.15372 13.5607C3.84504 12.0089 4.00347 10.4003 4.60897 8.93853C5.21447 7.47672 6.23985 6.22729 7.55544 5.34824Z"
        fill="currentColor" />
      <path
        d="M19 2C19.5523 2 20 2.44772 20 3V4H21C21.5523 4 22 4.44772 22 5C22 5.55228 21.5523 6 21 6H20V7C20 7.55228 19.5523 8 19 8C18.4477 8 18 7.55228 18 7V6H17C16.4477 6 16 5.55228 16 5C16 4.44772 16.4477 4 17 4H18V3C18 2.44772 18.4477 2 19 2Z"
        fill="currentColor" />
    </svg>
  );
})

MoonStarIcon.displayName = "MoonStarIcon"
</file>

<file path="src/components/tiptap-icons/redo2-icon.jsx">
import * as React from "react"

export const Redo2Icon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M15.7071 2.29289C15.3166 1.90237 14.6834 1.90237 14.2929 2.29289C13.9024 2.68342 13.9024 3.31658 14.2929 3.70711L17.5858 7H9.5C7.77609 7 6.12279 7.68482 4.90381 8.90381C3.68482 10.1228 3 11.7761 3 13.5C3 14.3536 3.16813 15.1988 3.49478 15.9874C3.82144 16.7761 4.30023 17.4926 4.90381 18.0962C6.12279 19.3152 7.77609 20 9.5 20H13C13.5523 20 14 19.5523 14 19C14 18.4477 13.5523 18 13 18H9.5C8.30653 18 7.16193 17.5259 6.31802 16.682C5.90016 16.2641 5.56869 15.768 5.34254 15.2221C5.1164 14.6761 5 14.0909 5 13.5C5 12.3065 5.47411 11.1619 6.31802 10.318C7.16193 9.47411 8.30653 9 9.5 9H17.5858L14.2929 12.2929C13.9024 12.6834 13.9024 13.3166 14.2929 13.7071C14.6834 14.0976 15.3166 14.0976 15.7071 13.7071L20.7071 8.70711C21.0976 8.31658 21.0976 7.68342 20.7071 7.29289L15.7071 2.29289Z"
        fill="currentColor" />
    </svg>
  );
})

Redo2Icon.displayName = "Redo2Icon"
</file>

<file path="src/components/tiptap-icons/strike-icon.jsx">
import * as React from "react"

export const StrikeIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        d="M9.00039 3H16.0001C16.5524 3 17.0001 3.44772 17.0001 4C17.0001 4.55229 16.5524 5 16.0001 5H9.00011C8.68006 4.99983 8.36412 5.07648 8.07983 5.22349C7.79555 5.37051 7.55069 5.5836 7.36585 5.84487C7.181 6.10614 7.06155 6.40796 7.01754 6.72497C6.97352 7.04198 7.00623 7.36492 7.11292 7.66667C7.29701 8.18737 7.02414 8.75872 6.50344 8.94281C5.98274 9.1269 5.4114 8.85403 5.2273 8.33333C5.01393 7.72984 4.94851 7.08396 5.03654 6.44994C5.12456 5.81592 5.36346 5.21229 5.73316 4.68974C6.10285 4.1672 6.59256 3.74101 7.16113 3.44698C7.72955 3.15303 8.36047 2.99975 9.00039 3Z"
        fill="currentColor" />
      <path
        d="M18 13H20C20.5523 13 21 12.5523 21 12C21 11.4477 20.5523 11 20 11H4C3.44772 11 3 11.4477 3 12C3 12.5523 3.44772 13 4 13H14C14.7956 13 15.5587 13.3161 16.1213 13.8787C16.6839 14.4413 17 15.2044 17 16C17 16.7956 16.6839 17.5587 16.1213 18.1213C15.5587 18.6839 14.7956 19 14 19H6C5.44772 19 5 19.4477 5 20C5 20.5523 5.44772 21 6 21H14C15.3261 21 16.5979 20.4732 17.5355 19.5355C18.4732 18.5979 19 17.3261 19 16C19 14.9119 18.6453 13.8604 18 13Z"
        fill="currentColor" />
    </svg>
  );
})

StrikeIcon.displayName = "StrikeIcon"
</file>

<file path="src/components/tiptap-icons/subscript-icon.jsx">
import * as React from "react"

export const SubscriptIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M3.29289 7.29289C3.68342 6.90237 4.31658 6.90237 4.70711 7.29289L12.7071 15.2929C13.0976 15.6834 13.0976 16.3166 12.7071 16.7071C12.3166 17.0976 11.6834 17.0976 11.2929 16.7071L3.29289 8.70711C2.90237 8.31658 2.90237 7.68342 3.29289 7.29289Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M12.7071 7.29289C13.0976 7.68342 13.0976 8.31658 12.7071 8.70711L4.70711 16.7071C4.31658 17.0976 3.68342 17.0976 3.29289 16.7071C2.90237 16.3166 2.90237 15.6834 3.29289 15.2929L11.2929 7.29289C11.6834 6.90237 12.3166 6.90237 12.7071 7.29289Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M17.4079 14.3995C18.0284 14.0487 18.7506 13.9217 19.4536 14.0397C20.1566 14.1578 20.7977 14.5138 21.2696 15.0481L21.2779 15.0574L21.2778 15.0575C21.7439 15.5988 22 16.2903 22 17C22 18.0823 21.3962 18.8401 20.7744 19.3404C20.194 19.8073 19.4858 20.141 18.9828 20.378C18.9638 20.387 18.9451 20.3958 18.9266 20.4045C18.4473 20.6306 18.2804 20.7817 18.1922 20.918C18.1773 20.9412 18.1619 20.9681 18.1467 21H21C21.5523 21 22 21.4477 22 22C22 22.5523 21.5523 23 21 23H17C16.4477 23 16 22.5523 16 22C16 21.1708 16.1176 20.4431 16.5128 19.832C16.9096 19.2184 17.4928 18.8695 18.0734 18.5956C18.6279 18.334 19.138 18.0901 19.5207 17.7821C19.8838 17.49 20 17.2477 20 17C20 16.7718 19.9176 16.5452 19.7663 16.3672C19.5983 16.1792 19.3712 16.0539 19.1224 16.0121C18.8722 15.9701 18.6152 16.015 18.3942 16.1394C18.1794 16.2628 18.0205 16.4549 17.9422 16.675C17.7572 17.1954 17.1854 17.4673 16.665 17.2822C16.1446 17.0972 15.8728 16.5254 16.0578 16.005C16.2993 15.3259 16.7797 14.7584 17.4039 14.4018L17.4079 14.3995L17.4079 14.3995Z"
        fill="currentColor" />
    </svg>
  );
})

SubscriptIcon.displayName = "SubscriptIcon"
</file>

<file path="src/components/tiptap-icons/sun-icon.jsx">
import * as React from "react"

export const SunIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        d="M12 1C12.5523 1 13 1.44772 13 2V4C13 4.55228 12.5523 5 12 5C11.4477 5 11 4.55228 11 4V2C11 1.44772 11.4477 1 12 1Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M7 12C7 9.23858 9.23858 7 12 7C14.7614 7 17 9.23858 17 12C17 14.7614 14.7614 17 12 17C9.23858 17 7 14.7614 7 12ZM12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9Z"
        fill="currentColor" />
      <path
        d="M13 20C13 19.4477 12.5523 19 12 19C11.4477 19 11 19.4477 11 20V22C11 22.5523 11.4477 23 12 23C12.5523 23 13 22.5523 13 22V20Z"
        fill="currentColor" />
      <path
        d="M4.22282 4.22289C4.61335 3.83236 5.24651 3.83236 5.63704 4.22289L7.04704 5.63289C7.43756 6.02341 7.43756 6.65658 7.04704 7.0471C6.65651 7.43762 6.02335 7.43762 5.63283 7.0471L4.22282 5.6371C3.8323 5.24658 3.8323 4.61341 4.22282 4.22289Z"
        fill="currentColor" />
      <path
        d="M18.367 16.9529C17.9765 16.5623 17.3433 16.5623 16.9528 16.9529C16.5623 17.3434 16.5623 17.9766 16.9528 18.3671L18.3628 19.7771C18.7533 20.1676 19.3865 20.1676 19.777 19.7771C20.1675 19.3866 20.1675 18.7534 19.777 18.3629L18.367 16.9529Z"
        fill="currentColor" />
      <path
        d="M1 12C1 11.4477 1.44772 11 2 11H4C4.55228 11 5 11.4477 5 12C5 12.5523 4.55228 13 4 13H2C1.44772 13 1 12.5523 1 12Z"
        fill="currentColor" />
      <path
        d="M20 11C19.4477 11 19 11.4477 19 12C19 12.5523 19.4477 13 20 13H22C22.5523 13 23 12.5523 23 12C23 11.4477 22.5523 11 22 11H20Z"
        fill="currentColor" />
      <path
        d="M7.04704 16.9529C7.43756 17.3434 7.43756 17.9766 7.04704 18.3671L5.63704 19.7771C5.24651 20.1676 4.61335 20.1676 4.22282 19.7771C3.8323 19.3866 3.8323 18.7534 4.22283 18.3629L5.63283 16.9529C6.02335 16.5623 6.65651 16.5623 7.04704 16.9529Z"
        fill="currentColor" />
      <path
        d="M19.777 5.6371C20.1675 5.24657 20.1675 4.61341 19.777 4.22289C19.3865 3.83236 18.7533 3.83236 18.3628 4.22289L16.9528 5.63289C16.5623 6.02341 16.5623 6.65658 16.9528 7.0471C17.3433 7.43762 17.9765 7.43762 18.367 7.0471L19.777 5.6371Z"
        fill="currentColor" />
    </svg>
  );
})

SunIcon.displayName = "SunIcon"
</file>

<file path="src/components/tiptap-icons/superscript-icon.jsx">
import * as React from "react"

export const SuperscriptIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M12.7071 7.29289C13.0976 7.68342 13.0976 8.31658 12.7071 8.70711L4.70711 16.7071C4.31658 17.0976 3.68342 17.0976 3.29289 16.7071C2.90237 16.3166 2.90237 15.6834 3.29289 15.2929L11.2929 7.29289C11.6834 6.90237 12.3166 6.90237 12.7071 7.29289Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M3.29289 7.29289C3.68342 6.90237 4.31658 6.90237 4.70711 7.29289L12.7071 15.2929C13.0976 15.6834 13.0976 16.3166 12.7071 16.7071C12.3166 17.0976 11.6834 17.0976 11.2929 16.7071L3.29289 8.70711C2.90237 8.31658 2.90237 7.68342 3.29289 7.29289Z"
        fill="currentColor" />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M17.405 1.40657C18.0246 1.05456 18.7463 0.92634 19.4492 1.04344C20.1521 1.16054 20.7933 1.51583 21.2652 2.0497L21.2697 2.05469L21.2696 2.05471C21.7431 2.5975 22 3.28922 22 4.00203C22 5.08579 21.3952 5.84326 20.7727 6.34289C20.1966 6.80531 19.4941 7.13675 18.9941 7.37261C18.9714 7.38332 18.9491 7.39383 18.9273 7.40415C18.4487 7.63034 18.2814 7.78152 18.1927 7.91844C18.1778 7.94155 18.1625 7.96834 18.1473 8.00003H21C21.5523 8.00003 22 8.44774 22 9.00003C22 9.55231 21.5523 10 21 10H17C16.4477 10 16 9.55231 16 9.00003C16 8.17007 16.1183 7.44255 16.5138 6.83161C16.9107 6.21854 17.4934 5.86971 18.0728 5.59591C18.6281 5.33347 19.1376 5.09075 19.5208 4.78316C19.8838 4.49179 20 4.25026 20 4.00203C20 3.77192 19.9178 3.54865 19.7646 3.37182C19.5968 3.18324 19.3696 3.05774 19.1205 3.01625C18.8705 2.97459 18.6137 3.02017 18.3933 3.14533C18.1762 3.26898 18.0191 3.45826 17.9406 3.67557C17.7531 4.19504 17.18 4.46414 16.6605 4.27662C16.141 4.0891 15.8719 3.51596 16.0594 2.99649C16.303 2.3219 16.7817 1.76125 17.4045 1.40689L17.405 1.40657Z"
        fill="currentColor" />
    </svg>
  );
})

SuperscriptIcon.displayName = "SuperscriptIcon"
</file>

<file path="src/components/tiptap-icons/trash-icon.jsx">
import * as React from "react"

export const TrashIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M7 5V4C7 3.17477 7.40255 2.43324 7.91789 1.91789C8.43324 1.40255 9.17477 1 10 1H14C14.8252 1 15.5668 1.40255 16.0821 1.91789C16.5975 2.43324 17 3.17477 17 4V5H21C21.5523 5 22 5.44772 22 6C22 6.55228 21.5523 7 21 7H20V20C20 20.8252 19.5975 21.5668 19.0821 22.0821C18.5668 22.5975 17.8252 23 17 23H7C6.17477 23 5.43324 22.5975 4.91789 22.0821C4.40255 21.5668 4 20.8252 4 20V7H3C2.44772 7 2 6.55228 2 6C2 5.44772 2.44772 5 3 5H7ZM9 4C9 3.82523 9.09745 3.56676 9.33211 3.33211C9.56676 3.09745 9.82523 3 10 3H14C14.1748 3 14.4332 3.09745 14.6679 3.33211C14.9025 3.56676 15 3.82523 15 4V5H9V4ZM6 7V20C6 20.1748 6.09745 20.4332 6.33211 20.6679C6.56676 20.9025 6.82523 21 7 21H17C17.1748 21 17.4332 20.9025 17.6679 20.6679C17.9025 20.4332 18 20.1748 18 20V7H6Z"
        fill="currentColor" />
    </svg>
  );
})

TrashIcon.displayName = "TrashIcon"
</file>

<file path="src/components/tiptap-icons/underline-icon.jsx">
import * as React from "react"

export const UnderlineIcon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M7 4C7 3.44772 6.55228 3 6 3C5.44772 3 5 3.44772 5 4V10C5 11.8565 5.7375 13.637 7.05025 14.9497C8.36301 16.2625 10.1435 17 12 17C13.8565 17 15.637 16.2625 16.9497 14.9497C18.2625 13.637 19 11.8565 19 10V4C19 3.44772 18.5523 3 18 3C17.4477 3 17 3.44772 17 4V10C17 11.3261 16.4732 12.5979 15.5355 13.5355C14.5979 14.4732 13.3261 15 12 15C10.6739 15 9.40215 14.4732 8.46447 13.5355C7.52678 12.5979 7 11.3261 7 10V4ZM4 19C3.44772 19 3 19.4477 3 20C3 20.5523 3.44772 21 4 21H20C20.5523 21 21 20.5523 21 20C21 19.4477 20.5523 19 20 19H4Z"
        fill="currentColor" />
    </svg>
  );
})

UnderlineIcon.displayName = "UnderlineIcon"
</file>

<file path="src/components/tiptap-icons/undo2-icon.jsx">
import * as React from "react"

export const Undo2Icon = React.memo(({
  className,
  ...props
}) => {
  return (
    <svg
      width="24"
      height="24"
      className={className}
      viewBox="0 0 24 24"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      {...props}>
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M9.70711 3.70711C10.0976 3.31658 10.0976 2.68342 9.70711 2.29289C9.31658 1.90237 8.68342 1.90237 8.29289 2.29289L3.29289 7.29289C2.90237 7.68342 2.90237 8.31658 3.29289 8.70711L8.29289 13.7071C8.68342 14.0976 9.31658 14.0976 9.70711 13.7071C10.0976 13.3166 10.0976 12.6834 9.70711 12.2929L6.41421 9H14.5C15.0909 9 15.6761 9.1164 16.2221 9.34254C16.768 9.56869 17.2641 9.90016 17.682 10.318C18.0998 10.7359 18.4313 11.232 18.6575 11.7779C18.8836 12.3239 19 12.9091 19 13.5C19 14.0909 18.8836 14.6761 18.6575 15.2221C18.4313 15.768 18.0998 16.2641 17.682 16.682C17.2641 17.0998 16.768 17.4313 16.2221 17.6575C15.6761 17.8836 15.0909 18 14.5 18H11C10.4477 18 10 18.4477 10 19C10 19.5523 10.4477 20 11 20H14.5C15.3536 20 16.1988 19.8319 16.9874 19.5052C17.7761 19.1786 18.4926 18.6998 19.0962 18.0962C19.6998 17.4926 20.1786 16.7761 20.5052 15.9874C20.8319 15.1988 21 14.3536 21 13.5C21 12.6464 20.8319 11.8012 20.5052 11.0126C20.1786 10.2239 19.6998 9.50739 19.0962 8.90381C18.4926 8.30022 17.7761 7.82144 16.9874 7.49478C16.1988 7.16813 15.3536 7 14.5 7H6.41421L9.70711 3.70711Z"
        fill="currentColor" />
    </svg>
  );
})

Undo2Icon.displayName = "Undo2Icon"
</file>

<file path="src/components/tiptap-node/code-block-node/code-block-node.scss">
.tiptap.ProseMirror {
  --tt-inline-code-bg-color: var(--tt-gray-light-a-100);
  --tt-inline-code-text-color: var(--tt-gray-light-a-700);
  --tt-inline-code-border-color: var(--tt-gray-light-a-200);
  --tt-codeblock-bg: var(--tt-gray-light-a-50);
  --tt-codeblock-text: var(--tt-gray-light-a-800);
  --tt-codeblock-border: var(--tt-gray-light-a-200);

  .dark & {
    --tt-inline-code-bg-color: var(--tt-gray-dark-a-100);
    --tt-inline-code-text-color: var(--tt-gray-dark-a-700);
    --tt-inline-code-border-color: var(--tt-gray-dark-a-200);
    --tt-codeblock-bg: var(--tt-gray-dark-a-50);
    --tt-codeblock-text: var(--tt-gray-dark-a-800);
    --tt-codeblock-border: var(--tt-gray-dark-a-200);
  }
}

/* =====================
   CODE FORMATTING
   ===================== */
.tiptap.ProseMirror {
  // Inline code
  code {
    background-color: var(--tt-inline-code-bg-color);
    color: var(--tt-inline-code-text-color);
    border: 1px solid var(--tt-inline-code-border-color);
    font-family: "JetBrains Mono NL", monospace;
    font-size: 0.875em;
    line-height: 1.4;
    border-radius: 6px/0.375rem;
    padding: 0.1em 0.2em;
  }

  // Code blocks
  pre {
    background-color: var(--tt-codeblock-bg);
    color: var(--tt-codeblock-text);
    border: 1px solid var(--tt-codeblock-border);
    margin-top: 1.5em;
    margin-bottom: 1.5em;
    padding: 1em;
    font-size: 1rem;
    border-radius: 6px/0.375rem;

    code {
      background-color: transparent;
      border: none;
      border-radius: 0;
      -webkit-text-fill-color: inherit;
      color: inherit;
    }
  }
}
</file>

<file path="src/components/tiptap-node/image-node/image-node.scss">
.tiptap.ProseMirror {
  img {
    max-width: 100%;
    height: auto;
    display: block;
  }

  > img:not([data-type="emoji"] img) {
    margin: 2rem 0;
    outline: 0.125rem solid transparent;
    border-radius: var(--tt-radius-xs, 0.25rem);
  }

  &.ProseMirror-focused
    img:not([data-type="emoji"] img).ProseMirror-selectednode {
    outline-color: var(--tt-brand-color-500);
  }

  // Thread image handling
  .tiptap-thread:has(> img) {
    margin: 2rem 0;

    img {
      outline: 0.125rem solid transparent;
      border-radius: var(--tt-radius-xs, 0.25rem);
    }
  }

  .tiptap-thread img {
    margin: 0;
  }
}
</file>

<file path="src/components/tiptap-node/image-upload-node/image-upload-node-extension.js">
import { mergeAttributes, Node } from "@tiptap/react"
import { ReactNodeViewRenderer } from "@tiptap/react"
import { ImageUploadNode as ImageUploadNodeComponent } from "@/components/tiptap-node/image-upload-node/image-upload-node"

/**
 * A TipTap node extension that creates an image upload component.
 * @see registry/tiptap-node/image-upload-node/image-upload-node
 */
export const ImageUploadNode = Node.create({
  name: "imageUpload",

  group: "block",

  draggable: true,

  selectable: true,

  atom: true,

  addOptions() {
    return {
      accept: "image/*",
      limit: 1,
      maxSize: 0,
      upload: undefined,
      onError: undefined,
      onSuccess: undefined,
    }
  },

  addAttributes() {
    return {
      accept: {
        default: this.options.accept,
      },
      limit: {
        default: this.options.limit,
      },
      maxSize: {
        default: this.options.maxSize,
      },
    }
  },

  parseHTML() {
    return [{ tag: 'div[data-type="image-upload"]' }]
  },

  renderHTML({ HTMLAttributes }) {
    return [
      "div",
      mergeAttributes({ "data-type": "image-upload" }, HTMLAttributes),
    ];
  },

  addNodeView() {
    return ReactNodeViewRenderer(ImageUploadNodeComponent);
  },

  addCommands() {
    return {
      setImageUploadNode:
        (options = {}) =>
        ({ commands }) => {
          return commands.insertContent({
            type: this.name,
            attrs: options,
          });
        },
    };
  },

  /**
   * Adds Enter key handler to trigger the upload component when it's selected.
   */
  addKeyboardShortcuts() {
    return {
      Enter: ({ editor }) => {
        const { selection } = editor.state
        const { nodeAfter } = selection.$from

        if (
          nodeAfter &&
          nodeAfter.type.name === "imageUpload" &&
          editor.isActive("imageUpload")
        ) {
          const nodeEl = editor.view.nodeDOM(selection.$from.pos)
          if (nodeEl && nodeEl instanceof HTMLElement) {
            // Since NodeViewWrapper is wrapped with a div, we need to click the first child
            const firstChild = nodeEl.firstChild
            if (firstChild && firstChild instanceof HTMLElement) {
              firstChild.click()
              return true
            }
          }
        }
        return false
      },
    };
  },
})

export default ImageUploadNode
</file>

<file path="src/components/tiptap-node/image-upload-node/image-upload-node.jsx">
import * as React from "react"
import { NodeViewWrapper } from "@tiptap/react"
import { CloseIcon } from "@/components/tiptap-icons/close-icon"
import "@/components/tiptap-node/image-upload-node/image-upload-node.scss"

function useFileUpload(options) {
  const [fileItem, setFileItem] = React.useState(null)

  const uploadFile = async file => {
    if (file.size > options.maxSize) {
      const error = new Error(`File size exceeds maximum allowed (${options.maxSize / 1024 / 1024}MB)`)
      options.onError?.(error)
      return null
    }

    const abortController = new AbortController()

    const newFileItem = {
      id: crypto.randomUUID(),
      file,
      progress: 0,
      status: "uploading",
      abortController,
    }

    setFileItem(newFileItem)

    try {
      if (!options.upload) {
        throw new Error("Upload function is not defined")
      }

      const url = await options.upload(file, (event) => {
        setFileItem((prev) => {
          if (!prev) return null
          return {
            ...prev,
            progress: event.progress,
          }
        })
      }, abortController.signal)

      if (!url) throw new Error("Upload failed: No URL returned")

      if (!abortController.signal.aborted) {
        setFileItem((prev) => {
          if (!prev) return null
          return {
            ...prev,
            status: "success",
            url,
            progress: 100,
          }
        })
        options.onSuccess?.(url)
        return url
      }

      return null
    } catch (error) {
      if (!abortController.signal.aborted) {
        setFileItem((prev) => {
          if (!prev) return null
          return {
            ...prev,
            status: "error",
            progress: 0,
          }
        })
        options.onError?.(error instanceof Error ? error : new Error("Upload failed"))
      }
      return null
    }
  }

  const uploadFiles = async files => {
    if (!files || files.length === 0) {
      options.onError?.(new Error("No files to upload"))
      return null
    }

    if (options.limit && files.length > options.limit) {
      options.onError?.(
        new Error(`Maximum ${options.limit} file${options.limit === 1 ? "" : "s"} allowed`)
      )
      return null
    }

    const file = files[0]
    if (!file) {
      options.onError?.(new Error("File is undefined"))
      return null
    }

    return uploadFile(file);
  }

  const clearFileItem = () => {
    if (!fileItem) return

    if (fileItem.abortController) {
      fileItem.abortController.abort()
    }
    if (fileItem.url) {
      URL.revokeObjectURL(fileItem.url)
    }
    setFileItem(null)
  }

  return {
    fileItem,
    uploadFiles,
    clearFileItem,
  }
}

const CloudUploadIcon = () => (
  <svg
    width="24"
    height="24"
    viewBox="0 0 24 24"
    className="tiptap-image-upload-icon"
    fill="currentColor"
    xmlns="http://www.w3.org/2000/svg">
    <path
      d="M11.1953 4.41771C10.3478 4.08499 9.43578 3.94949 8.5282 4.02147C7.62062 4.09345 6.74133 4.37102 5.95691 4.83316C5.1725 5.2953 4.50354 5.92989 4.00071 6.68886C3.49788 7.44783 3.17436 8.31128 3.05465 9.2138C2.93495 10.1163 3.0222 11.0343 3.3098 11.8981C3.5974 12.7619 4.07781 13.5489 4.71463 14.1995C5.10094 14.5942 5.09414 15.2274 4.69945 15.6137C4.30476 16 3.67163 15.9932 3.28532 15.5985C2.43622 14.731 1.79568 13.6816 1.41221 12.5299C1.02875 11.3781 0.91241 10.1542 1.07201 8.95084C1.23162 7.74748 1.66298 6.59621 2.33343 5.58425C3.00387 4.57229 3.89581 3.72617 4.9417 3.10998C5.98758 2.4938 7.15998 2.1237 8.37008 2.02773C9.58018 1.93176 10.7963 2.11243 11.9262 2.55605C13.0561 2.99968 14.0703 3.69462 14.8919 4.58825C15.5423 5.29573 16.0585 6.11304 16.4177 7.00002H17.4999C18.6799 6.99991 19.8288 7.37933 20.7766 8.08222C21.7245 8.78515 22.4212 9.7743 22.7637 10.9036C23.1062 12.0328 23.0765 13.2423 22.6788 14.3534C22.2812 15.4644 21.5367 16.4181 20.5554 17.0736C20.0962 17.3803 19.4752 17.2567 19.1684 16.7975C18.8617 16.3382 18.9853 15.7172 19.4445 15.4105C20.069 14.9934 20.5427 14.3865 20.7958 13.6794C21.0488 12.9724 21.0678 12.2027 20.8498 11.4841C20.6318 10.7655 20.1885 10.136 19.5853 9.6887C18.9821 9.24138 18.251 8.99993 17.5001 9.00002H15.71C15.2679 9.00002 14.8783 8.70973 14.7518 8.28611C14.4913 7.41374 14.0357 6.61208 13.4195 5.94186C12.8034 5.27164 12.0427 4.75043 11.1953 4.41771Z"
      fill="currentColor" />
    <path
      d="M11 14.4142V21C11 21.5523 11.4477 22 12 22C12.5523 22 13 21.5523 13 21V14.4142L15.2929 16.7071C15.6834 17.0976 16.3166 17.0976 16.7071 16.7071C17.0976 16.3166 17.0976 15.6834 16.7071 15.2929L12.7078 11.2936C12.7054 11.2912 12.703 11.2888 12.7005 11.2864C12.5208 11.1099 12.2746 11.0008 12.003 11L12 11L11.997 11C11.8625 11.0004 11.7343 11.0273 11.6172 11.0759C11.502 11.1236 11.3938 11.1937 11.2995 11.2864C11.297 11.2888 11.2946 11.2912 11.2922 11.2936L7.29289 15.2929C6.90237 15.6834 6.90237 16.3166 7.29289 16.7071C7.68342 17.0976 8.31658 17.0976 8.70711 16.7071L11 14.4142Z"
      fill="currentColor" />
  </svg>
)

const FileIcon = () => (
  <svg
    width="43"
    height="57"
    viewBox="0 0 43 57"
    fill="currentColor"
    className="tiptap-image-upload-dropzone-rect-primary"
    xmlns="http://www.w3.org/2000/svg">
    <path
      d="M0.75 10.75C0.75 5.64137 4.89137 1.5 10 1.5H32.3431C33.2051 1.5 34.0317 1.84241 34.6412 2.4519L40.2981 8.10876C40.9076 8.71825 41.25 9.5449 41.25 10.4069V46.75C41.25 51.8586 37.1086 56 32 56H10C4.89137 56 0.75 51.8586 0.75 46.75V10.75Z"
      fill="currentColor"
      fillOpacity="0.11"
      stroke="currentColor"
      strokeWidth="1.5" />
  </svg>
)

const FileCornerIcon = () => (
  <svg
    width="10"
    height="10"
    className="tiptap-image-upload-dropzone-rect-secondary"
    viewBox="0 0 10 10"
    fill="currentColor"
    xmlns="http://www.w3.org/2000/svg">
    <path
      d="M0 0.75H0.343146C1.40401 0.75 2.42143 1.17143 3.17157 1.92157L8.82843 7.57843C9.57857 8.32857 10 9.34599 10 10.4069V10.75H4C1.79086 10.75 0 8.95914 0 6.75V0.75Z"
      fill="currentColor" />
  </svg>
)

const ImageUploadDragArea = ({
  onFile,
  children,
}) => {
  const [dragover, setDragover] = React.useState(false)

  const onDrop = (e) => {
    setDragover(false)
    e.preventDefault()
    e.stopPropagation()

    const files = Array.from(e.dataTransfer.files)
    onFile(files)
  }

  const onDragover = (e) => {
    e.preventDefault()
    setDragover(true)
  }

  const onDragleave = (e) => {
    e.preventDefault()
    setDragover(false)
  }

  return (
    <div
      className={`tiptap-image-upload-dragger ${dragover ? "tiptap-image-upload-dragger-active" : ""}`}
      onDrop={onDrop}
      onDragOver={onDragover}
      onDragLeave={onDragleave}>
      {children}
    </div>
  );
}

const ImageUploadPreview = ({
  file,
  progress,
  status,
  onRemove,
}) => {
  const formatFileSize = (bytes) => {
    if (bytes === 0) return "0 Bytes"
    const k = 1024
    const sizes = ["Bytes", "KB", "MB", "GB"]
    const i = Math.floor(Math.log(bytes) / Math.log(k))
    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
  }

  return (
    <div className="tiptap-image-upload-preview">
      {status === "uploading" && (
        <div
          className="tiptap-image-upload-progress"
          style={{ width: `${progress}%` }} />
      )}
      <div className="tiptap-image-upload-preview-content">
        <div className="tiptap-image-upload-file-info">
          <div className="tiptap-image-upload-file-icon">
            <CloudUploadIcon />
          </div>
          <div className="tiptap-image-upload-details">
            <span className="tiptap-image-upload-text">{file.name}</span>
            <span className="tiptap-image-upload-subtext">
              {formatFileSize(file.size)}
            </span>
          </div>
        </div>
        <div className="tiptap-image-upload-actions">
          {status === "uploading" && (
            <span className="tiptap-image-upload-progress-text">
              {progress}%
            </span>
          )}
          <button
            className="tiptap-image-upload-close-btn"
            onClick={(e) => {
              e.stopPropagation()
              onRemove()
            }}>
            <CloseIcon />
          </button>
        </div>
      </div>
    </div>
  );
}

const DropZoneContent = ({ maxSize }) => (
  <>
    <div className="tiptap-image-upload-dropzone">
      <FileIcon />
      <FileCornerIcon />
      <div className="tiptap-image-upload-icon-container">
        <CloudUploadIcon />
      </div>
    </div>

    <div className="tiptap-image-upload-content">
      <span className="tiptap-image-upload-text">
        <em>Click to upload</em> or drag and drop
      </span>
      <span className="tiptap-image-upload-subtext">
        Maximum file size {maxSize / 1024 / 1024}MB.
      </span>
    </div>
  </>
)

export const ImageUploadNode = (props) => {
  const { accept, limit, maxSize } = props.node.attrs
  const inputRef = React.useRef(null)
  const extension = props.extension

  const uploadOptions = {
    maxSize,
    limit,
    accept,
    upload: extension.options.upload,
    onSuccess: extension.options.onSuccess,
    onError: extension.options.onError,
  }

  const { fileItem, uploadFiles, clearFileItem } = useFileUpload(uploadOptions)

  const handleChange = (e) => {
    const files = e.target.files
    if (!files || files.length === 0) {
      extension.options.onError?.(new Error("No file selected"))
      return
    }
    handleUpload(Array.from(files))
  }

  const handleUpload = async (files) => {
    const url = await uploadFiles(files)

    if (url) {
      const pos = props.getPos()
      const filename = files[0]?.name.replace(/\.[^/.]+$/, "") || "unknown"

      props.editor
        .chain()
        .focus()
        .deleteRange({ from: pos, to: pos + 1 })
        .insertContentAt(pos, [
          {
            type: "image",
            attrs: { src: url, alt: filename, title: filename },
          },
        ])
        .run()
    }
  }

  const handleClick = () => {
    if (inputRef.current && !fileItem) {
      inputRef.current.value = ""
      inputRef.current.click()
    }
  }

  return (
    <NodeViewWrapper className="tiptap-image-upload" tabIndex={0} onClick={handleClick}>
      {!fileItem && (
        <ImageUploadDragArea onFile={handleUpload}>
          <DropZoneContent maxSize={maxSize} />
        </ImageUploadDragArea>
      )}
      {fileItem && (
        <ImageUploadPreview
          file={fileItem.file}
          progress={fileItem.progress}
          status={fileItem.status}
          onRemove={clearFileItem} />
      )}
      <input
        ref={inputRef}
        name="file"
        accept={accept}
        type="file"
        onChange={handleChange}
        onClick={(e) => e.stopPropagation()} />
    </NodeViewWrapper>
  );
}
</file>

<file path="src/components/tiptap-node/image-upload-node/image-upload-node.scss">
:root {
  --tt-button-default-icon-color: var(--tt-gray-light-a-600);

  --tiptap-image-upload-active: var(--tt-brand-color-500);
  --tiptap-image-upload-progress-bg: var(--tt-brand-color-50);
  --tiptap-image-upload-icon-bg: var(--tt-brand-color-500);

  --tiptap-image-upload-text-color: var(--tt-gray-light-a-700);
  --tiptap-image-upload-subtext-color: var(--tt-gray-light-a-400);
  --tiptap-image-upload-border: var(--tt-gray-light-a-300);
  --tiptap-image-upload-border-hover: var(--tt-gray-light-a-400);
  --tiptap-image-upload-border-active: var(--tt-brand-color-500);

  --tiptap-image-upload-icon-doc-bg: var(--tt-gray-light-a-200);
  --tiptap-image-upload-icon-doc-border: var(--tt-gray-light-300);
  --tiptap-image-upload-icon-color: var(--white);
}

.dark {
  --tt-button-default-icon-color: var(--tt-gray-dark-a-600);

  --tiptap-image-upload-active: var(--tt-brand-color-400);
  --tiptap-image-upload-progress-bg: var(--tt-brand-color-900);
  --tiptap-image-upload-icon-bg: var(--tt-brand-color-400);

  --tiptap-image-upload-text-color: var(--tt-gray-dark-a-700);
  --tiptap-image-upload-subtext-color: var(--tt-gray-dark-a-400);
  --tiptap-image-upload-border: var(--tt-gray-dark-a-300);
  --tiptap-image-upload-border-hover: var(--tt-gray-dark-a-400);
  --tiptap-image-upload-border-active: var(--tt-brand-color-400);

  --tiptap-image-upload-icon-doc-bg: var(--tt-gray-dark-a-200);
  --tiptap-image-upload-icon-doc-border: var(--tt-gray-dark-300);
  --tiptap-image-upload-icon-color: var(--black);
}

.tiptap-image-upload {
  margin: 2rem 0;

  input[type="file"] {
    display: none;
  }

  .tiptap-image-upload-dropzone {
    position: relative;
    width: 3.125rem;
    height: 3.75rem;
    display: inline-flex;
    align-items: flex-start;
    justify-content: center;
    -webkit-user-select: none; /* Safari */
    -ms-user-select: none; /* IE 10 and IE 11 */
    user-select: none;
  }

  .tiptap-image-upload-icon-container {
    position: absolute;
    width: 1.75rem;
    height: 1.75rem;
    bottom: 0;
    right: 0;
    background-color: var(--tiptap-image-upload-icon-bg);
    border-radius: var(--tt-radius-lg, 0.75rem);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .tiptap-image-upload-icon {
    width: 0.875rem;
    height: 0.875rem;
    color: var(--tiptap-image-upload-icon-color);
  }

  .tiptap-image-upload-dropzone-rect-primary {
    color: var(--tiptap-image-upload-icon-doc-bg);
    position: absolute;
  }

  .tiptap-image-upload-dropzone-rect-secondary {
    position: absolute;
    top: 0;
    right: 0.25rem;
    bottom: 0;
    color: var(--tiptap-image-upload-icon-doc-border);
  }

  .tiptap-image-upload-text {
    color: var(--tiptap-image-upload-text-color);
    font-weight: 500;
    font-size: 0.875rem;
    line-height: normal;

    em {
      font-style: normal;
      text-decoration: underline;
    }
  }

  .tiptap-image-upload-subtext {
    color: var(--tiptap-image-upload-subtext-color);
    font-weight: 600;
    line-height: normal;
    font-size: 0.75rem;
  }

  .tiptap-image-upload-preview {
    position: relative;
    border-radius: var(--tt-radius-md, 0.5rem);
    overflow: hidden;

    .tiptap-image-upload-progress {
      position: absolute;
      inset: 0;
      background-color: var(--tiptap-image-upload-progress-bg);
      transition: all 300ms ease-out;
    }

    .tiptap-image-upload-preview-content {
      position: relative;
      border: 1px solid var(--tiptap-image-upload-border);
      border-radius: var(--tt-radius-md, 0.5rem);
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .tiptap-image-upload-file-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      height: 2rem;

      .tiptap-image-upload-file-icon {
        padding: 0.5rem;
        background-color: var(--tiptap-image-upload-icon-bg);
        border-radius: var(--tt-radius-lg, 0.75rem);

        svg {
          width: 0.875rem;
          height: 0.875rem;
          color: var(--tiptap-image-upload-icon-color);
        }
      }
    }

    .tiptap-image-upload-details {
      display: flex;
      flex-direction: column;
    }

    .tiptap-image-upload-actions {
      display: flex;
      align-items: center;

      .tiptap-image-upload-progress-text {
        font-size: 0.75rem;
        color: var(--tiptap-image-upload-border-active);
      }

      .tiptap-image-upload-close-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        color: var(--tt-button-default-icon-color);
        transition: color 200ms ease;

        svg {
          width: 1rem;
          height: 1rem;
        }
      }
    }
  }

  .tiptap-image-upload-dragger {
    padding: 2rem 1.5rem;
    border: 1.5px dashed var(--tiptap-image-upload-border);
    border-radius: var(--tt-radius-md, 0.5rem);
    text-align: center;
    cursor: pointer;
    position: relative;
    overflow: hidden;

    &-active {
      border-color: var(--tiptap-image-upload-border-active);
      background-color: rgba(
        var(--tiptap-image-upload-active-rgb, 0, 0, 255),
        0.05
      );
    }
  }

  .tiptap-image-upload-content {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 0.25rem;
    -webkit-user-select: none; /* Safari */
    -ms-user-select: none; /* IE 10 and IE 11 */
    user-select: none;
  }
}

.tiptap.ProseMirror.ProseMirror-focused {
  .ProseMirror-selectednode .tiptap-image-upload-dragger {
    border-color: var(--tiptap-image-upload-active);
  }
}
</file>

<file path="src/components/tiptap-node/image-upload-node/index.jsx">
export * from "./image-upload-node-extension"
</file>

<file path="src/components/tiptap-node/list-node/list-node.scss">
.tiptap.ProseMirror {
  --tt-checklist-bg-color: var(--tt-gray-light-a-100);
  --tt-checklist-bg-active-color: var(--tt-gray-light-a-900);
  --tt-checklist-border-color: var(--tt-gray-light-a-200);
  --tt-checklist-border-active-color: var(--tt-gray-light-a-900);
  --tt-checklist-check-icon-color: var(--white);
  --tt-checklist-text-active: var(--tt-gray-light-a-500);

  .dark & {
    --tt-checklist-bg-color: var(--tt-gray-dark-a-100);
    --tt-checklist-bg-active-color: var(--tt-gray-dark-a-900);
    --tt-checklist-border-color: var(--tt-gray-dark-a-200);
    --tt-checklist-border-active-color: var(--tt-gray-dark-a-900);
    --tt-checklist-check-icon-color: var(--black);
    --tt-checklist-text-active: var(--tt-gray-dark-a-500);
  }
}

/* =====================
     LISTS
     ===================== */
.tiptap.ProseMirror {
  // Common list styles
  ol,
  ul {
    margin-top: 1.5em;
    margin-bottom: 1.5em;
    padding-left: 1.5em;

    &:first-child {
      margin-top: 0;
    }

    &:last-child {
      margin-bottom: 0;
    }

    ol,
    ul {
      margin-top: 0;
      margin-bottom: 0;
    }
  }

  li {
    p {
      margin-top: 0;
    }
  }

  // Ordered lists
  ol {
    list-style: decimal;

    ol {
      list-style: lower-alpha;

      ol {
        list-style: lower-roman;
      }
    }
  }

  // Unordered lists
  ul:not([data-type="taskList"]) {
    list-style: disc;

    ul {
      list-style: circle;

      ul {
        list-style: disc;
      }
    }
  }

  // Task lists
  ul[data-type="taskList"] {
    padding-left: 0.25em;

    li {
      display: flex;
      flex-direction: row;
      align-items: flex-start;

      &:not(:has(> p:first-child)) {
        list-style-type: none;
      }

      &[data-checked="true"] {
        > div > p {
          opacity: 0.5;
          text-decoration: line-through;
        }

        > div > p span {
          text-decoration: line-through;
        }
      }

      label {
        position: relative;
        padding-top: 4px;
        padding-right: 8px;

        input[type="checkbox"] {
          position: absolute;
          opacity: 0;
          width: 0;
          height: 0;
        }

        span {
          display: block;
          width: 1em;
          height: 1em;
          border: 1px solid var(--tt-checklist-border-color);
          border-radius: var(--tt-radius-xs, 0.25rem);
          position: relative;
          cursor: pointer;
          background-color: var(--tt-checklist-bg-color);
          transition:
            background-color 80ms ease-out,
            border-color 80ms ease-out;

          &::before {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 0.75em;
            height: 0.75em;
            background-color: var(--tt-checklist-check-icon-color);
            opacity: 0;
            -webkit-mask: url("data:image/svg+xml,%3Csvg%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22currentColor%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20clip-rule%3D%22evenodd%22%20d%3D%22M21.4142%204.58579C22.1953%205.36683%2022.1953%206.63317%2021.4142%207.41421L10.4142%2018.4142C9.63317%2019.1953%208.36684%2019.1953%207.58579%2018.4142L2.58579%2013.4142C1.80474%2012.6332%201.80474%2011.3668%202.58579%2010.5858C3.36683%209.80474%204.63317%209.80474%205.41421%2010.5858L9%2014.1716L18.5858%204.58579C19.3668%203.80474%2020.6332%203.80474%2021.4142%204.58579Z%22%20fill%3D%22currentColor%22%2F%3E%3C%2Fsvg%3E")
              center/contain no-repeat;
            mask: url("data:image/svg+xml,%3Csvg%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22currentColor%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20clip-rule%3D%22evenodd%22%20d%3D%22M21.4142%204.58579C22.1953%205.36683%2022.1953%206.63317%2021.4142%207.41421L10.4142%2018.4142C9.63317%2019.1953%208.36684%2019.1953%207.58579%2018.4142L2.58579%2013.4142C1.80474%2012.6332%201.80474%2011.3668%202.58579%2010.5858C3.36683%209.80474%204.63317%209.80474%205.41421%2010.5858L9%2014.1716L18.5858%204.58579C19.3668%203.80474%2020.6332%203.80474%2021.4142%204.58579Z%22%20fill%3D%22currentColor%22%2F%3E%3C%2Fsvg%3E")
              center/contain no-repeat;
          }
        }

        input[type="checkbox"]:checked + span {
          background: var(--tt-checklist-bg-active-color);
          border-color: var(--tt-checklist-border-active-color);

          &::before {
            opacity: 1;
          }
        }
      }

      div {
        flex: 1 1 0%;
        min-width: 0;
      }
    }
  }
}
</file>

<file path="src/components/tiptap-node/paragraph-node/paragraph-node.scss">
.tiptap.ProseMirror {
  --blockquote-bg-color: var(--tt-gray-light-900);
  --link-text-color: var(--tt-brand-color-500);
  --separator-color: var(--tt-gray-light-a-200);
  --thread-text: var(--tt-gray-light-900);
  --placeholder-color: var(--tt-gray-light-a-400);

  // Mathematics variables
  --tiptap-mathematics-bg-color: var(--tt-gray-light-a-200);
  --tiptap-mathematics-border-color: var(--tt-brand-color-500);

  .dark & {
    --blockquote-bg-color: var(--tt-gray-dark-900);
    --link-text-color: var(--tt-brand-color-400);
    --separator-color: var(--tt-gray-dark-a-200);
    --thread-text: var(--tt-gray-dark-900);
    --placeholder-color: var(--tt-gray-dark-a-400);

    --tiptap-mathematics-bg-color: var(--tt-gray-dark-a-200);
    --tiptap-mathematics-border-color: var(--tt-brand-color-400);
  }
}

/* =====================
     CORE EDITOR STYLES
     ===================== */
.tiptap.ProseMirror {
  white-space: pre-wrap;
  outline: none;
  caret-color: var(--tt-cursor-color);

  // Paragraph spacing
  p:not(:first-child) {
    font-size: 1rem;
    line-height: 1.6;
    font-weight: normal;
    margin-top: 20px;
  }

  // Selection styles
  &:not(.readonly):not(.ProseMirror-hideselection) {
    ::selection {
      background-color: var(--tt-selection-color);
    }

    .selection::selection {
      background: transparent;
    }
  }

  .selection {
    display: inline;
    background-color: var(--tt-selection-color);
  }

  .ProseMirror-hideselection {
    caret-color: transparent;
  }

  // Placeholder
  > p.is-editor-empty::before {
    content: attr(data-placeholder);
    pointer-events: none;
    color: var(--placeholder-color);
    float: left;
    height: 0;
  }

  // Resize cursor
  &.resize-cursor {
    cursor: ew-resize;
    cursor: col-resize;
  }
}

/* =====================
     GAP CURSOR
     ===================== */
.tiptap.ProseMirror {
  .ProseMirror-gapcursor {
    display: none;
    pointer-events: none;
    position: absolute;

    &:after {
      content: "";
      display: block;
      position: absolute;
      top: 1em;
      width: 1.25em;
      border-top: 1px solid black;
      animation: ProseMirror-cursor-blink 1.1s steps(2, start) infinite;
    }
  }

  &.ProseMirror-focused,
  &.ProseMirror.ProseMirror-focused {
    .ProseMirror-gapcursor {
      display: block;
    }
  }
}

@keyframes ProseMirror-cursor-blink {
  to {
    visibility: hidden;
  }
}

/* =====================
     TEXT DECORATION
     ===================== */
.tiptap.ProseMirror {
  // Text decoration inheritance for spans
  a span {
    text-decoration: underline;
  }

  s span {
    text-decoration: line-through;
  }

  u span {
    text-decoration: underline;
  }
}

/* =====================
     BLOCKQUOTE
     ===================== */
.tiptap.ProseMirror {
  blockquote {
    position: relative;
    padding-left: 1em;
    padding-top: 0.375em;
    padding-bottom: 0.375em;
    margin: 1.5rem 0;

    p {
      margin-top: 0;
    }

    &::before,
    &.is-empty::before {
      position: absolute;
      bottom: 0;
      left: 0;
      top: 0;
      height: 100%;
      width: 0.25em;
      background-color: var(--blockquote-bg-color);
      content: "";
      border-radius: 0;
    }
  }
}

/* =====================
     COLLABORATION
     ===================== */
.tiptap.ProseMirror {
  .collaboration-cursor {
    &__caret {
      border-right: 1px solid transparent;
      border-left: 1px solid transparent;
      pointer-events: none;
      margin-left: -1px;
      margin-right: -1px;
      position: relative;
      word-break: normal;
    }

    &__label {
      border-radius: 0.25rem;
      border-bottom-left-radius: 0;
      font-size: 0.75rem;
      font-weight: 600;
      left: -1px;
      line-height: 1;
      padding: 0.125rem 0.375rem;
      position: absolute;
      top: -1.3em;
      user-select: none;
      white-space: nowrap;
    }
  }
}

/* =====================
     EMOJI
     ===================== */
.tiptap.ProseMirror [data-type="emoji"] img {
  display: inline-block;
  width: 1.25em;
  height: 1.25em;
  cursor: text;
}

/* =====================
     HEADINGS
     ===================== */
.tiptap.ProseMirror {
  h1,
  h2,
  h3,
  h4 {
    position: relative;
    color: inherit;
    font-style: inherit;

    &:first-child {
      margin-top: 0;
    }
  }

  h1 {
    font-size: 1.5em;
    font-weight: 700;
    margin-top: 3em;
  }

  h2 {
    font-size: 1.25em;
    font-weight: 700;
    margin-top: 2.5em;
  }

  h3 {
    font-size: 1.125em;
    font-weight: 600;
    margin-top: 2em;
  }

  h4 {
    font-size: 1em;
    font-weight: 600;
    margin-top: 2em;
  }
}

/* =====================
     HORIZONTAL RULE
     ===================== */
.tiptap.ProseMirror {
  hr {
    margin-top: 3em;
    margin-bottom: 3em;
    border: none;
    height: 1px;
    background-color: var(--separator-color);
  }

  &.ProseMirror-focused {
    hr.ProseMirror-selectednode {
      border-radius: 9999px;
      outline: 3px solid var(--tt-brand-color-500);
      outline-offset: 2px;
    }
  }
}

/* =====================
     LINKS
     ===================== */
.tiptap.ProseMirror {
  a {
    color: var(--link-text-color);
    text-decoration: underline;
  }
}

/* =====================
     MENTION
     ===================== */
.tiptap.ProseMirror {
  [data-type="mention"] {
    display: inline-block;
    color: var(--tt-brand-color-500);
  }
}

/* =====================
     THREADS
     ===================== */
.tiptap.ProseMirror {
  // Base styles for inline threads
  .tiptap-thread.tiptap-thread--unresolved.tiptap-thread--inline {
    transition:
      color 0.2s ease-in-out,
      background-color 0.2s ease-in-out;
    color: var(--thread-text);
    border-bottom: 2px dashed var(--tt-color-yellow-base);
    font-weight: 600;

    &.tiptap-thread--selected,
    &.tiptap-thread--hovered {
      background-color: var(--tt-color-yellow-inc-2);
      border-bottom-color: transparent;
    }
  }

  // Block thread styles with images
  .tiptap-thread.tiptap-thread--unresolved.tiptap-thread--block {
    &:has(img) {
      outline: 0.125rem solid var(--tt-color-yellow-base);
      border-radius: var(--tt-radius-xs, 0.25rem);
      overflow: hidden;
      width: fit-content;

      &.tiptap-thread--selected {
        outline-width: 0.25rem;
        outline-color: var(--tt-color-yellow-base);
      }

      &.tiptap-thread--hovered {
        outline-width: 0.25rem;
      }
    }

    // Block thread styles without images
    &:not(:has(img)) {
      border-radius: 0.25rem;
      border-bottom: 0.125rem dashed var(--tt-color-yellow-base);
      padding-bottom: 0.5rem;
      outline: 0.25rem solid transparent;

      &.tiptap-thread--hovered,
      &.tiptap-thread--selected {
        background-color: var(--tt-color-yellow-base);
        outline-color: var(--tt-color-yellow-base);
      }
    }
  }

  // Resolved thread styles
  .tiptap-thread.tiptap-thread--resolved.tiptap-thread--inline.tiptap-thread--selected {
    background-color: var(--tt-color-yellow-base);
    border-color: transparent;
    opacity: 0.5;
  }

  // React renderer specific styles
  .tiptap-thread.tiptap-thread--block:has(.react-renderer) {
    margin-top: 3rem;
    margin-bottom: 3rem;
  }
}

/* =====================
     Mathematics
     ===================== */
.tiptap.ProseMirror {
  .Tiptap-mathematics-editor {
    padding: 0 0.25rem;
    margin: 0 0.25rem;
    border: 1px solid var(--tiptap-mathematics-border-color);
    font-family: monospace;
    font-size: 0.875rem;
  }

  .Tiptap-mathematics-render {
    padding: 0 0.25rem;

    &--editable {
      cursor: pointer;
      transition: background 0.2s;

      &:hover {
        background: var(--tiptap-mathematics-bg-color);
      }
    }
  }

  .Tiptap-mathematics-editor,
  .Tiptap-mathematics-render {
    border-radius: var(--tt-radius-xs);
    display: inline-block;
  }
}

/* =====================
     PLACEHOLDER
     ===================== */
.is-empty[data-placeholder]:has(
    > .ProseMirror-trailingBreak:only-child
  )::before {
  content: "Write, type '/' for commands…";
}

.is-empty[data-placeholder]:has(
    > .ProseMirror-trailingBreak:only-child
  ):before {
  pointer-events: none;
  height: 0;
  position: absolute;
  font-style: italic;
}

.is-empty[data-placeholder]:has(> .ProseMirror-trailingBreak):before {
  color: var(--placeholder-color);
}
</file>



<file path="src/components/tiptap-templates/simple/theme-toggle.jsx">
"use client"

import * as React from "react"

// --- UI Primitives ---
import { Button } from "@/components/tiptap-ui-primitive/button"

// --- Icons ---
import { MoonStarIcon } from "@/components/tiptap-icons/moon-star-icon"
import { SunIcon } from "@/components/tiptap-icons/sun-icon"

export function ThemeToggle() {
  const [isDarkMode, setIsDarkMode] = React.useState(false)

  React.useEffect(() => {
    const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)")
    const handleChange = () => setIsDarkMode(mediaQuery.matches)
    mediaQuery.addEventListener("change", handleChange)
    return () => mediaQuery.removeEventListener("change", handleChange);
  }, [])

  React.useEffect(() => {
    const initialDarkMode =
      !!document.querySelector('meta[name="color-scheme"][content="dark"]') ||
      window.matchMedia("(prefers-color-scheme: dark)").matches
    setIsDarkMode(initialDarkMode)
  }, [])

  React.useEffect(() => {
    document.documentElement.classList.toggle("dark", isDarkMode)
  }, [isDarkMode])

  const toggleDarkMode = () => setIsDarkMode((isDark) => !isDark)

  return (
    <Button
      onClick={toggleDarkMode}
      aria-label={`Switch to ${isDarkMode ? "light" : "dark"} mode`}
      data-style="ghost">
      {isDarkMode ? (
        <MoonStarIcon className="tiptap-button-icon" />
      ) : (
        <SunIcon className="tiptap-button-icon" />
      )}
    </Button>
  );
}
</file>

<file path="src/components/tiptap-ui-primitive/button/button-colors.scss">
.tiptap-button {
  /************************************************** 
      Default button background color 
  **************************************************/

  /* Light mode */
  --tt-button-default-bg-color: var(--tt-gray-light-a-100);
  --tt-button-hover-bg-color: var(--tt-gray-light-200);
  --tt-button-active-bg-color: var(--tt-gray-light-a-200);
  --tt-button-active-bg-color-emphasized: var(
    --tt-brand-color-100
  ); //more important active state
  --tt-button-active-bg-color-subdued: var(
    --tt-gray-light-a-200
  ); //less important active state
  --tt-button-active-hover-bg-color: var(--tt-gray-light-300);
  --tt-button-active-hover-bg-color-emphasized: var(
    --tt-brand-color-200
  ); //more important active state hover
  --tt-button-active-hover-bg-color-subdued: var(
    --tt-gray-light-a-300
  ); //less important active state hover
  --tt-button-disabled-bg-color: var(--tt-gray-light-a-50);

  /* Dark mode */
  .dark & {
    --tt-button-default-bg-color: var(--tt-gray-dark-a-100);
    --tt-button-hover-bg-color: var(--tt-gray-dark-200);
    --tt-button-active-bg-color: var(--tt-gray-dark-a-200);
    --tt-button-active-bg-color-emphasized: var(
      --tt-brand-color-900
    ); //more important active state
    --tt-button-active-bg-color-subdued: var(
      --tt-gray-dark-a-200
    ); //less important active state
    --tt-button-active-hover-bg-color: var(--tt-gray-dark-300);
    --tt-button-active-hover-bg-color-emphasized: var(
      --tt-brand-color-800
    ); //more important active state hover
    --tt-button-active-hover-bg-color-subdued: var(
      --tt-gray-dark-a-300
    ); //less important active state hover
    --tt-button-disabled-bg-color: var(--tt-gray-dark-a-50);
  }

  /************************************************** 
      Default button text color 
  **************************************************/

  /* Light mode */
  --tt-button-default-text-color: var(--tt-gray-light-a-600);
  --tt-button-hover-text-color: var(--tt-gray-light-a-900);
  --tt-button-active-text-color: var(--tt-gray-light-a-900);
  --tt-button-active-text-color-emphasized: var(--tt-gray-light-a-900);
  --tt-button-active-text-color-subdued: var(--tt-gray-light-a-900);
  --tt-button-disabled-text-color: var(--tt-gray-light-a-400);

  /* Dark mode */
  .dark & {
    --tt-button-default-text-color: var(--tt-gray-dark-a-600);
    --tt-button-hover-text-color: var(--tt-gray-dark-a-900);
    --tt-button-active-text-color: var(--tt-gray-dark-a-900);
    --tt-button-active-text-color-emphasized: var(--tt-gray-dark-a-900);
    --tt-button-active-text-color-subdued: var(--tt-gray-dark-a-900);
    --tt-button-disabled-text-color: var(--tt-gray-dark-a-300);
  }

  /************************************************** 
      Default button icon color 
  **************************************************/

  /* Light mode */
  --tt-button-default-icon-color: var(--tt-gray-light-a-600);
  --tt-button-hover-icon-color: var(--tt-gray-light-a-900);
  --tt-button-active-icon-color: var(--tt-brand-color-500);
  --tt-button-active-icon-color-emphasized: var(--tt-brand-color-600);
  --tt-button-active-icon-color-subdued: var(--tt-gray-light-a-900);
  --tt-button-disabled-icon-color: var(--tt-gray-light-a-400);

  /* Dark mode */
  .dark & {
    --tt-button-default-icon-color: var(--tt-gray-dark-a-600);
    --tt-button-hover-icon-color: var(--tt-gray-dark-a-900);
    --tt-button-active-icon-color: var(--tt-brand-color-400);
    --tt-button-active-icon-color-emphasized: var(--tt-brand-color-400);
    --tt-button-active-icon-color-subdued: var(--tt-gray-dark-a-900);
    --tt-button-disabled-icon-color: var(--tt-gray-dark-a-400);
  }

  /************************************************** 
      Default button subicon color 
  **************************************************/

  /* Light mode */
  --tt-button-default-icon-sub-color: var(--tt-gray-light-a-400);
  --tt-button-hover-icon-sub-color: var(--tt-gray-light-a-500);
  --tt-button-active-icon-sub-color: var(--tt-gray-light-a-400);
  --tt-button-active-icon-sub-color-emphasized: var(--tt-gray-light-a-500);
  --tt-button-active-icon-sub-color-subdued: var(--tt-gray-light-a-400);
  --tt-button-disabled-icon-sub-color: var(--tt-gray-light-a-100);

  /* Dark mode */
  .dark & {
    --tt-button-default-icon-sub-color: var(--tt-gray-dark-a-300);
    --tt-button-hover-icon-sub-color: var(--tt-gray-dark-a-400);
    --tt-button-active-icon-sub-color: var(--tt-gray-dark-a-300);
    --tt-button-active-icon-sub-color-emphasized: var(--tt-gray-dark-a-400);
    --tt-button-active-icon-sub-color-subdued: var(--tt-gray-dark-a-300);
    --tt-button-disabled-icon-sub-color: var(--tt-gray-dark-a-100);
  }

  /************************************************** 
      Default button dropdown / arrows color 
  **************************************************/

  /* Light mode */
  --tt-button-default-dropdown-arrows-color: var(--tt-gray-light-a-600);
  --tt-button-hover-dropdown-arrows-color: var(--tt-gray-light-a-700);
  --tt-button-active-dropdown-arrows-color: var(--tt-gray-light-a-600);
  --tt-button-active-dropdown-arrows-color-emphasized: var(
    --tt-gray-light-a-700
  );
  --tt-button-active-dropdown-arrows-color-subdued: var(--tt-gray-light-a-600);
  --tt-button-disabled-dropdown-arrows-color: var(--tt-gray-light-a-400);

  /* Dark mode */
  .dark & {
    --tt-button-default-dropdown-arrows-color: var(--tt-gray-dark-a-600);
    --tt-button-hover-dropdown-arrows-color: var(--tt-gray-dark-a-700);
    --tt-button-active-dropdown-arrows-color: var(--tt-gray-dark-a-600);
    --tt-button-active-dropdown-arrows-color-emphasized: var(
      --tt-gray-dark-a-700
    );
    --tt-button-active-dropdown-arrows-color-subdued: var(--tt-gray-dark-a-600);
    --tt-button-disabled-dropdown-arrows-color: var(--tt-gray-dark-a-400);
  }

  /* ----------------------------------------------------------------
      --------------------------- GHOST BUTTON --------------------------
      ---------------------------------------------------------------- */

  &[data-style="ghost"] {
    /************************************************** 
        Ghost button background color 
    **************************************************/

    /* Light mode */
    --tt-button-default-bg-color: var(--transparent);
    --tt-button-hover-bg-color: var(--tt-gray-light-200);
    --tt-button-active-bg-color: var(--tt-gray-light-a-100);
    --tt-button-active-bg-color-emphasized: var(
      --tt-brand-color-100
    ); //more important active state
    --tt-button-active-bg-color-subdued: var(
      --tt-gray-light-a-100
    ); //less important active state
    --tt-button-active-hover-bg-color: var(--tt-gray-light-200);
    --tt-button-active-hover-bg-color-emphasized: var(
      --tt-brand-color-200
    ); //more important active state hover
    --tt-button-active-hover-bg-color-subdued: var(
      --tt-gray-light-a-200
    ); //less important active state hover
    --tt-button-disabled-bg-color: var(--transparent);

    /* Dark mode */
    .dark & {
      --tt-button-default-bg-color: var(--transparent);
      --tt-button-hover-bg-color: var(--tt-gray-dark-200);
      --tt-button-active-bg-color: var(--tt-gray-dark-a-100);
      --tt-button-active-bg-color-emphasized: var(
        --tt-brand-color-900
      ); //more important active state
      --tt-button-active-bg-color-subdued: var(
        --tt-gray-dark-a-100
      ); //less important active state
      --tt-button-active-hover-bg-color: var(--tt-gray-dark-200);
      --tt-button-active-hover-bg-color-emphasized: var(
        --tt-brand-color-800
      ); //more important active state hover
      --tt-button-active-hover-bg-color-subdued: var(
        --tt-gray-dark-a-200
      ); //less important active state hover
      --tt-button-disabled-bg-color: var(--transparent);
    }

    /************************************************** 
        Ghost button text color 
    **************************************************/

    /* Light mode */
    --tt-button-default-text-color: var(--tt-gray-light-a-600);
    --tt-button-hover-text-color: var(--tt-gray-light-a-900);
    --tt-button-active-text-color: var(--tt-gray-light-a-900);
    --tt-button-active-text-color-emphasized: var(--tt-gray-light-a-900);
    --tt-button-active-text-color-subdued: var(--tt-gray-light-a-900);
    --tt-button-disabled-text-color: var(--tt-gray-light-a-400);

    /* Dark mode */
    .dark & {
      --tt-button-default-text-color: var(--tt-gray-dark-a-600);
      --tt-button-hover-text-color: var(--tt-gray-dark-a-900);
      --tt-button-active-text-color: var(--tt-gray-dark-a-900);
      --tt-button-active-text-color-emphasized: var(--tt-gray-dark-a-900);
      --tt-button-active-text-color-subdued: var(--tt-gray-dark-a-900);
      --tt-button-disabled-text-color: var(--tt-gray-dark-a-300);
    }

    /************************************************** 
        Ghost button icon color 
    **************************************************/

    /* Light mode */
    --tt-button-default-icon-color: var(--tt-gray-light-a-600);
    --tt-button-hover-icon-color: var(--tt-gray-light-a-900);
    --tt-button-active-icon-color: var(--tt-brand-color-500);
    --tt-button-active-icon-color-emphasized: var(--tt-brand-color-600);
    --tt-button-active-icon-color-subdued: var(--tt-gray-light-a-900);
    --tt-button-disabled-icon-color: var(--tt-gray-light-a-400);

    /* Dark mode */
    .dark & {
      --tt-button-default-icon-color: var(--tt-gray-dark-a-600);
      --tt-button-hover-icon-color: var(--tt-gray-dark-a-900);
      --tt-button-active-icon-color: var(--tt-brand-color-400);
      --tt-button-active-icon-color-emphasized: var(--tt-brand-color-300);
      --tt-button-active-icon-color-subdued: var(--tt-gray-dark-a-900);
      --tt-button-disabled-icon-color: var(--tt-gray-dark-a-400);
    }

    /************************************************** 
        Ghost button subicon color 
    **************************************************/

    /* Light mode */
    --tt-button-default-icon-sub-color: var(--tt-gray-light-a-400);
    --tt-button-hover-icon-sub-color: var(--tt-gray-light-a-500);
    --tt-button-active-icon-sub-color: var(--tt-gray-light-a-400);
    --tt-button-active-icon-sub-color-emphasized: var(--tt-gray-light-a-500);
    --tt-button-active-icon-sub-color-subdued: var(--tt-gray-light-a-400);
    --tt-button-disabled-icon-sub-color: var(--tt-gray-light-a-100);

    /* Dark mode */
    .dark & {
      --tt-button-default-icon-sub-color: var(--tt-gray-dark-a-300);
      --tt-button-hover-icon-sub-color: var(--tt-gray-dark-a-400);
      --tt-button-active-icon-sub-color: var(--tt-gray-dark-a-300);
      --tt-button-active-icon-sub-color-emphasized: var(--tt-gray-dark-a-400);
      --tt-button-active-icon-sub-color-subdued: var(--tt-gray-dark-a-300);
      --tt-button-disabled-icon-sub-color: var(--tt-gray-dark-a-100);
    }

    /************************************************** 
        Ghost button dropdown / arrows color 
    **************************************************/

    /* Light mode */
    --tt-button-default-dropdown-arrows-color: var(--tt-gray-light-a-600);
    --tt-button-hover-dropdown-arrows-color: var(--tt-gray-light-a-700);
    --tt-button-active-dropdown-arrows-color: var(--tt-gray-light-a-600);
    --tt-button-active-dropdown-arrows-color-emphasized: var(
      --tt-gray-light-a-700
    );
    --tt-button-active-dropdown-arrows-color-subdued: var(
      --tt-gray-light-a-600
    );
    --tt-button-disabled-dropdown-arrows-color: var(--tt-gray-light-a-400);

    /* Dark mode */
    .dark & {
      --tt-button-default-dropdown-arrows-color: var(--tt-gray-dark-a-600);
      --tt-button-hover-dropdown-arrows-color: var(--tt-gray-dark-a-700);
      --tt-button-active-dropdown-arrows-color: var(--tt-gray-dark-a-600);
      --tt-button-active-dropdown-arrows-color-emphasized: var(
        --tt-gray-dark-a-700
      );
      --tt-button-active-dropdown-arrows-color-subdued: var(
        --tt-gray-dark-a-600
      );
      --tt-button-disabled-dropdown-arrows-color: var(--tt-gray-dark-a-400);
    }
  }

  /* ----------------------------------------------------------------
      -------------------------- PRIMARY BUTTON -------------------------
      ---------------------------------------------------------------- */

  &[data-style="primary"] {
    /************************************************** 
        Primary button background color 
    **************************************************/

    /* Light mode */
    --tt-button-default-bg-color: var(--tt-brand-color-500);
    --tt-button-hover-bg-color: var(--tt-brand-color-600);
    --tt-button-active-bg-color: var(--tt-brand-color-100);
    --tt-button-active-bg-color-emphasized: var(
      --tt-brand-color-100
    ); //more important active state
    --tt-button-active-bg-color-subdued: var(
      --tt-brand-color-100
    ); //less important active state
    --tt-button-active-hover-bg-color: var(--tt-brand-color-200);
    --tt-button-active-hover-bg-color-emphasized: var(
      --tt-brand-color-200
    ); //more important active state hover
    --tt-button-active-hover-bg-color-subdued: var(
      --tt-brand-color-200
    ); //less important active state hover
    --tt-button-disabled-bg-color: var(--tt-gray-light-a-100);

    /* Dark mode */
    .dark & {
      --tt-button-default-bg-color: var(--tt-brand-color-500);
      --tt-button-hover-bg-color: var(--tt-brand-color-600);
      --tt-button-active-bg-color: var(--tt-brand-color-900);
      --tt-button-active-bg-color-emphasized: var(
        --tt-brand-color-900
      ); //more important active state
      --tt-button-active-bg-color-subdued: var(
        --tt-brand-color-900
      ); //less important active state
      --tt-button-active-hover-bg-color: var(--tt-brand-color-800);
      --tt-button-active-hover-bg-color-emphasized: var(
        --tt-brand-color-800
      ); //more important active state hover
      --tt-button-active-hover-bg-color-subdued: var(
        --tt-brand-color-800
      ); //less important active state hover
      --tt-button-disabled-bg-color: var(--tt-gray-dark-a-100);
    }

    /************************************************** 
        Primary button text color 
    **************************************************/

    /* Light mode */
    --tt-button-default-text-color: var(--white);
    --tt-button-hover-text-color: var(--white);
    --tt-button-active-text-color: var(--tt-gray-light-a-900);
    --tt-button-active-text-color-emphasized: var(--tt-gray-light-a-900);
    --tt-button-active-text-color-subdued: var(--tt-gray-light-a-900);
    --tt-button-disabled-text-color: var(--tt-gray-light-a-400);

    /* Dark mode */
    .dark & {
      --tt-button-default-text-color: var(--white);
      --tt-button-hover-text-color: var(--white);
      --tt-button-active-text-color: var(--tt-gray-dark-a-900);
      --tt-button-active-text-color-emphasized: var(--tt-gray-dark-a-900);
      --tt-button-active-text-color-subdued: var(--tt-gray-dark-a-900);
      --tt-button-disabled-text-color: var(--tt-gray-dark-a-300);
    }

    /************************************************** 
        Primary button icon color 
    **************************************************/

    /* Light mode */
    --tt-button-default-icon-color: var(--white);
    --tt-button-hover-icon-color: var(--white);
    --tt-button-active-icon-color: var(--tt-brand-color-600);
    --tt-button-active-icon-color-emphasized: var(--tt-brand-color-600);
    --tt-button-active-icon-color-subdued: var(--tt-brand-color-600);
    --tt-button-disabled-icon-color: var(--tt-gray-light-a-400);

    /* Dark mode */
    .dark & {
      --tt-button-default-icon-color: var(--white);
      --tt-button-hover-icon-color: var(--white);
      --tt-button-active-icon-color: var(--tt-brand-color-400);
      --tt-button-active-icon-color-emphasized: var(--tt-brand-color-400);
      --tt-button-active-icon-color-subdued: var(--tt-brand-color-400);
      --tt-button-disabled-icon-color: var(--tt-gray-dark-a-300);
    }

    /************************************************** 
        Primary button subicon color 
    **************************************************/

    /* Light mode */
    --tt-button-default-icon-sub-color: var(--tt-gray-dark-a-500);
    --tt-button-hover-icon-sub-color: var(--tt-gray-dark-a-500);
    --tt-button-active-icon-sub-color: var(--tt-gray-light-a-500);
    --tt-button-active-icon-sub-color-emphasized: var(--tt-gray-light-a-500);
    --tt-button-active-icon-sub-color-subdued: var(--tt-gray-light-a-500);
    --tt-button-disabled-icon-sub-color: var(--tt-gray-light-a-100);

    /* Dark mode */
    .dark & {
      --tt-button-default-icon-sub-color: var(--tt-gray-dark-a-400);
      --tt-button-hover-icon-sub-color: var(--tt-gray-dark-a-500);
      --tt-button-active-icon-sub-color: var(--tt-gray-dark-a-300);
      --tt-button-active-icon-sub-color-emphasized: var(--tt-gray-dark-a-400);
      --tt-button-active-icon-sub-color-subdued: var(--tt-gray-dark-a-300);
      --tt-button-disabled-icon-sub-color: var(--tt-gray-dark-a-100);
    }

    /************************************************** 
        Primary button dropdown / arrows color 
    **************************************************/

    /* Light mode */
    --tt-button-default-dropdown-arrows-color: var(--white);
    --tt-button-hover-dropdown-arrows-color: var(--white);
    --tt-button-active-dropdown-arrows-color: var(--tt-gray-light-a-700);
    --tt-button-active-dropdown-arrows-color-emphasized: var(
      --tt-gray-light-a-700
    );
    --tt-button-active-dropdown-arrows-color-subdued: var(
      --tt-gray-light-a-700
    );
    --tt-button-disabled-dropdown-arrows-color: var(--tt-gray-light-a-400);

    /* Dark mode */
    .dark & {
      --tt-button-default-dropdown-arrows-color: var(--white);
      --tt-button-hover-dropdown-arrows-color: var(--white);
      --tt-button-active-dropdown-arrows-color: var(--tt-gray-dark-a-600);
      --tt-button-active-dropdown-arrows-color-emphasized: var(
        --tt-gray-dark-a-600
      );
      --tt-button-active-dropdown-arrows-color-subdued: var(
        --tt-gray-dark-a-600
      );
      --tt-button-disabled-dropdown-arrows-color: var(--tt-gray-dark-a-400);
    }
  }
}
</file>

<file path="src/components/tiptap-ui-primitive/button/button-group.scss">
.tiptap-button-group {
  align-items: center;
  display: flex;
  gap: 0.125rem;
  flex-direction: column;
}

.tiptap-button-group {
  &[data-orientation="vertical"],
  [data-orientation="vertical"] {
    flex-direction: column;
  }

  &[data-orientation="horizontal"],
  [data-orientation="horizontal"] {
    flex-direction: row;
  }
}
</file>

<file path="src/components/tiptap-ui-primitive/button/button.jsx">
import * as React from "react"
import {
  Tooltip,
  TooltipContent,
  TooltipTrigger,
} from "@/components/tiptap-ui-primitive/tooltip"

import "@/components/tiptap-ui-primitive/button/button-colors.scss"
import "@/components/tiptap-ui-primitive/button/button-group.scss"
import "@/components/tiptap-ui-primitive/button/button.scss"

export const MAC_SYMBOLS = {
  ctrl: "⌘",
  alt: "⌥",
  shift: "⇧"
}

export const formatShortcutKey = (key, isMac) => {
  if (isMac) {
    const lowerKey = key.toLowerCase()
    return MAC_SYMBOLS[lowerKey] || key.toUpperCase();
  }
  return key.charAt(0).toUpperCase() + key.slice(1);
}

export const parseShortcutKeys = (
  shortcutKeys,
  isMac
) => {
  if (!shortcutKeys) return []

  return shortcutKeys
    .split("-")
    .map((key) => key.trim())
    .map((key) => formatShortcutKey(key, isMac));
}

export const ShortcutDisplay = ({
  shortcuts,
}) => {
  if (shortcuts.length === 0) return null

  return (
    <div>
      {shortcuts.map((key, index) => (
        <React.Fragment key={index}>
          {index > 0 && <kbd>+</kbd>}
          <kbd>{key}</kbd>
        </React.Fragment>
      ))}
    </div>
  );
}

export const Button = React.forwardRef((
  {
    className = "",
    children,
    tooltip,
    showTooltip = true,
    shortcutKeys,
    "aria-label": ariaLabel,
    ...props
  },
  ref
) => {
  const isMac = React.useMemo(() =>
    typeof navigator !== "undefined" &&
    navigator.platform.toLowerCase().includes("mac"), [])

  const shortcuts = React.useMemo(() => parseShortcutKeys(shortcutKeys, isMac), [shortcutKeys, isMac])

  if (!tooltip || !showTooltip) {
    return (
      <button
        className={`tiptap-button ${className}`.trim()}
        ref={ref}
        aria-label={ariaLabel}
        {...props}>
        {children}
      </button>
    );
  }

  return (
    <Tooltip delay={200}>
      <TooltipTrigger
        className={`tiptap-button ${className}`.trim()}
        ref={ref}
        aria-label={ariaLabel}
        {...props}>
        {children}
      </TooltipTrigger>
      <TooltipContent>
        {tooltip}
        <ShortcutDisplay shortcuts={shortcuts} />
      </TooltipContent>
    </Tooltip>
  );
})

Button.displayName = "Button"

export default Button
</file>

<file path="src/components/tiptap-ui-primitive/button/button.scss">
.tiptap-button {
  font-size: 0.875rem;
  font-weight: 500;
  font-feature-settings:
    "salt" on,
    "cv01" on;
  line-height: 1.15;
  height: 2rem;
  min-width: 2rem;
  border: none;
  padding: 0.5rem;
  gap: 0.25rem;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--tt-radius-lg, 0.75rem);
  transition-property: background, color, opacity;
  transition-duration: var(--tt-transition-duration-default);
  transition-timing-function: var(--tt-transition-easing-default);

  // focus-visible
  &:focus-visible {
    outline: none;
  }

  &[data-highlighted="true"],
  &[data-focus-visible="true"] {
    background-color: var(--tt-button-hover-bg-color);
    color: var(--tt-button-hover-text-color);
    // outline: 2px solid var(--tt-button-active-icon-color);
  }

  /* button size large */
  &[data-size="large"] {
    font-size: 0.9375rem;
    height: 2.375rem;
    min-width: 2.375rem;
    padding: 0.625rem;
  }

  /* button size small */
  &[data-size="small"] {
    font-size: 0.75rem;
    line-height: 1.2;
    height: 1.5rem;
    min-width: 1.5rem;
    padding: 0.3125rem;
    border-radius: var(--tt-radius-md, 0.5rem);
  }

  /* trim / expand text of the button */
  .tiptap-button-text {
    padding: 0 0.125rem;
    flex-grow: 1;
    text-align: left;
    line-height: 1.5rem;
  }

  &[data-text-trim="on"] {
    .tiptap-button-text {
      text-overflow: ellipsis;
      overflow: hidden;
    }
  }

  /* global icon settings */
  .tiptap-button-icon,
  .tiptap-button-icon-sub,
  .tiptap-button-dropdown-arrows,
  .tiptap-button-dropdown-small {
    pointer-events: none;
    flex-shrink: 0;
  }

  /* standard icon, what is used */
  .tiptap-button-icon {
    width: 1rem;
    height: 1rem;
  }

  &[data-size="large"] .tiptap-button-icon {
    width: 1.125rem;
    height: 1.125rem;
  }

  &[data-size="small"] .tiptap-button-icon {
    width: 0.875rem;
    height: 0.875rem;
  }

  /* if 2 icons are used and this icon should be more subtle */
  .tiptap-button-icon-sub {
    width: 1rem;
    height: 1rem;
  }

  &[data-size="large"] .tiptap-button-icon-sub {
    width: 1.125rem;
    height: 1.125rem;
  }

  &[data-size="small"] .tiptap-button-icon-sub {
    width: 0.875rem;
    height: 0.875rem;
  }

  /* dropdown menus or arrows that are slightly smaller */
  .tiptap-button-dropdown-arrows {
    width: 0.75rem;
    height: 0.75rem;
  }

  &[data-size="large"] .tiptap-button-dropdown-arrows {
    width: 0.875rem;
    height: 0.875rem;
  }

  &[data-size="small"] .tiptap-button-dropdown-arrows {
    width: 0.625rem;
    height: 0.625rem;
  }

  /* dropdown menu for icon buttons only */
  .tiptap-button-dropdown-small {
    width: 0.625rem;
    height: 0.625rem;
  }

  &[data-size="large"] .tiptap-button-dropdown-small {
    width: 0.75rem;
    height: 0.75rem;
  }

  &[data-size="small"] .tiptap-button-dropdown-small {
    width: 0.5rem;
    height: 0.5rem;
  }

  /* button only has icons */
  &:has(> svg):not(:has(> :not(svg))) {
    gap: 0.125rem;

    &[data-size="large"],
    &[data-size="small"] {
      gap: 0.125rem;
    }
  }

  /* button only has 2 icons and one of them is dropdown small */
  &:has(> svg:nth-of-type(2)):has(> .tiptap-button-dropdown-small):not(
      :has(> svg:nth-of-type(3))
    ):not(:has(> .tiptap-button-text)) {
    gap: 0;
    padding-right: 0.25rem;

    &[data-size="large"] {
      padding-right: 0.375rem;
    }

    &[data-size="small"] {
      padding-right: 0.25rem;
    }
  }

  /* Emoji is used in a button */
  .tiptap-button-emoji {
    width: 1rem;
    display: flex;
    justify-content: center;
  }

  &[data-size="large"] .tiptap-button-emoji {
    width: 1.125rem;
  }

  &[data-size="small"] .tiptap-button-emoji {
    width: 0.875rem;
  }
}

/* --------------------------------------------
----------- BUTTON COLOR SETTINGS -------------
-------------------------------------------- */

.tiptap-button {
  background-color: var(--tt-button-default-bg-color);
  color: var(--tt-button-default-text-color);

  .tiptap-button-icon {
    color: var(--tt-button-default-icon-color);
  }

  .tiptap-button-icon-sub {
    color: var(--tt-button-default-icon-sub-color);
  }

  .tiptap-button-dropdown-arrows {
    color: var(--tt-button-default-dropdown-arrows-color);
  }

  .tiptap-button-dropdown-small {
    color: var(--tt-button-default-dropdown-arrows-color);
  }

  /* hover state of a button */
  &:hover,
  &[data-active-item="true"]:not([disabled]) {
    background-color: var(--tt-button-hover-bg-color);
    color: var(--tt-button-hover-text-color);

    .tiptap-button-icon {
      color: var(--tt-button-hover-icon-color);
    }

    .tiptap-button-icon-sub {
      color: var(--tt-button-hover-icon-sub-color);
    }

    .tiptap-button-dropdown-arrows,
    .tiptap-button-dropdown-small {
      color: var(--tt-button-hover-dropdown-arrows-color);
    }
  }

  /* Active state of a button */
  &[data-active-state="on"]:not([disabled]),
  &[data-state="open"]:not([disabled]) {
    background-color: var(--tt-button-active-bg-color);
    color: var(--tt-button-active-text-color);

    .tiptap-button-icon {
      color: var(--tt-button-active-icon-color);
    }

    .tiptap-button-icon-sub {
      color: var(--tt-button-active-icon-sub-color);
    }

    .tiptap-button-dropdown-arrows,
    .tiptap-button-dropdown-small {
      color: var(--tt-button-active-dropdown-arrows-color);
    }

    &:hover {
      background-color: var(--tt-button-active-hover-bg-color);
    }

    /* Emphasized */
    &[data-appearance="emphasized"] {
      background-color: var(--tt-button-active-bg-color-emphasized);
      color: var(--tt-button-active-text-color-emphasized);

      .tiptap-button-icon {
        color: var(--tt-button-active-icon-color-emphasized);
      }

      .tiptap-button-icon-sub {
        color: var(--tt-button-active-icon-sub-color-emphasized);
      }

      .tiptap-button-dropdown-arrows,
      .tiptap-button-dropdown-small {
        color: var(--tt-button-active-dropdown-arrows-color-emphasized);
      }

      &:hover {
        background-color: var(--tt-button-active-hover-bg-color-emphasized);
      }
    }

    /* Subdued */
    &[data-appearance="subdued"] {
      background-color: var(--tt-button-active-bg-color-subdued);
      color: var(--tt-button-active-text-color-subdued);

      .tiptap-button-icon {
        color: var(--tt-button-active-icon-color-subdued);
      }

      .tiptap-button-icon-sub {
        color: var(--tt-button-active-icon-sub-color-subdued);
      }

      .tiptap-button-dropdown-arrows,
      .tiptap-button-dropdown-small {
        color: var(--tt-button-active-dropdown-arrows-color-subdued);
      }

      &:hover {
        background-color: var(--tt-button-active-hover-bg-color-subdued);

        .tiptap-button-icon {
          color: var(--tt-button-active-icon-color-subdued);
        }
      }
    }
  }

  &:disabled {
    background-color: var(--tt-button-disabled-bg-color);
    color: var(--tt-button-disabled-text-color);

    .tiptap-button-icon {
      color: var(--tt-button-disabled-icon-color);
    }
  }
}
</file>

<file path="src/components/tiptap-ui-primitive/button/index.jsx">
export * from "./button"
</file>

<file path="src/components/tiptap-ui-primitive/dropdown-menu/dropdown-menu.jsx">
import * as React from "react"
import {
  autoUpdate,
  flip,
  FloatingFocusManager,
  FloatingList,
  FloatingPortal,
  offset,
  shift,
  useClick,
  useDismiss,
  useFloating,
  useInteractions,
  useListItem,
  useListNavigation,
  useMergeRefs,
  useRole,
  useTypeahead,
} from "@floating-ui/react"
import "@/components/tiptap-ui-primitive/dropdown-menu/dropdown-menu.scss"
import { Separator } from "@/components/tiptap-ui-primitive/separator"

const DropdownMenuContext = React.createContext(null)

function useDropdownMenuContext() {
  const context = React.useContext(DropdownMenuContext)
  if (!context) {
    throw new Error("DropdownMenu components must be wrapped in <DropdownMenu />")
  }
  return context
}

function useDropdownMenu({
  initialOpen = false,
  open: controlledOpen,
  onOpenChange: setControlledOpen,
  side = "bottom",
  align = "start"
}) {
  const [uncontrolledOpen, setUncontrolledOpen] = React.useState(initialOpen)
  const [currentPlacement, setCurrentPlacement] = React.useState(`${side}-${align}`)
  const [activeIndex, setActiveIndex] = React.useState(null)

  const open = controlledOpen ?? uncontrolledOpen
  const setOpen = setControlledOpen ?? setUncontrolledOpen

  const elementsRef = React.useRef([])
  const labelsRef = React.useRef([])

  const floating = useFloating({
    open,
    onOpenChange: setOpen,
    placement: currentPlacement,
    middleware: [offset({ mainAxis: 4 }), flip(), shift({ padding: 4 })],
    whileElementsMounted: autoUpdate,
  })

  const { context } = floating

  const interactions = useInteractions([
    useClick(context, {
      event: "mousedown",
      toggle: true,
      ignoreMouse: false,
    }),
    useRole(context, { role: "menu" }),
    useDismiss(context, {
      outsidePress: true,
      outsidePressEvent: "mousedown",
    }),
    useListNavigation(context, {
      listRef: elementsRef,
      activeIndex,
      onNavigate: setActiveIndex,
      loop: true,
    }),
    useTypeahead(context, {
      listRef: labelsRef,
      onMatch: open ? setActiveIndex : undefined,
      activeIndex,
    }),
  ])

  const updatePosition = React.useCallback((
    newSide,
    newAlign
  ) => {
    setCurrentPlacement(`${newSide}-${newAlign}`)
  }, [])

  return React.useMemo(() => ({
    open,
    setOpen,
    activeIndex,
    setActiveIndex,
    elementsRef,
    labelsRef,
    updatePosition,
    ...interactions,
    ...floating,
  }), [open, setOpen, activeIndex, interactions, floating, updatePosition]);
}

export function DropdownMenu({
  children,
  ...options
}) {
  const dropdown = useDropdownMenu(options)
  return (
    <DropdownMenuContext.Provider value={dropdown}>
      <FloatingList elementsRef={dropdown.elementsRef} labelsRef={dropdown.labelsRef}>
        {children}
      </FloatingList>
    </DropdownMenuContext.Provider>
  );
}

export const DropdownMenuTrigger = React.forwardRef(({ children, asChild = false, ...props }, propRef) => {
  const context = useDropdownMenuContext()
  const childrenRef = React.isValidElement(children)
    ? parseInt(React.version, 10) >= 19
      ? // eslint-disable-next-line @typescript-eslint/no-explicit-any
        (children).props.ref
      : // eslint-disable-next-line @typescript-eslint/no-explicit-any
        (children).ref
    : undefined
  const ref = useMergeRefs([context.refs.setReference, propRef, childrenRef])

  if (asChild && React.isValidElement(children)) {
    const dataAttributes = {
      "data-state": context.open ? "open" : "closed",
    }

    return React.cloneElement(children, context.getReferenceProps({
      ref,
      ...props,
      ...(typeof children.props === "object" ? children.props : {}),
      "aria-expanded": context.open,
      "aria-haspopup": "menu",
      ...dataAttributes,
    }));
  }

  return (
    <button
      ref={ref}
      aria-expanded={context.open}
      aria-haspopup="menu"
      data-state={context.open ? "open" : "closed"}
      {...context.getReferenceProps(props)}>
      {children}
    </button>
  );
})

DropdownMenuTrigger.displayName = "DropdownMenuTrigger"

export const DropdownMenuContent = React.forwardRef((
  {
    style,
    className,
    orientation = "vertical",
    side = "bottom",
    align = "start",
    portal = true,
    portalProps = {},
    ...props
  },
  propRef
) => {
  const context = useDropdownMenuContext()
  const ref = useMergeRefs([context.refs.setFloating, propRef])

  React.useEffect(() => {
    context.updatePosition(side, align)
  }, [context, side, align])

  if (!context.open) return null

  const content = (
    <FloatingFocusManager
      context={context.context}
      modal={false}
      initialFocus={0}
      returnFocus={true}>
      <div
        ref={ref}
        className={`tiptap-dropdown-menu ${className || ""}`}
        style={{
          position: context.strategy,
          top: context.y ?? 0,
          left: context.x ?? 0,
          outline: "none",
          ...style,
        }}
        aria-orientation={orientation}
        data-orientation={orientation}
        data-state={context.open ? "open" : "closed"}
        data-side={side}
        data-align={align}
        {...context.getFloatingProps(props)}>
        {props.children}
      </div>
    </FloatingFocusManager>
  )

  if (portal) {
    return <FloatingPortal {...portalProps}>{content}</FloatingPortal>;
  }

  return content
})

DropdownMenuContent.displayName = "DropdownMenuContent"

export const DropdownMenuItem = React.forwardRef((
  { children, disabled, asChild = false, onSelect, className, ...props },
  ref
) => {
  const context = useDropdownMenuContext()
  const item = useListItem({ label: disabled ? null : children?.toString() })
  const isActive = context.activeIndex === item.index

  const handleSelect = React.useCallback((event) => {
    if (disabled) return
    onSelect?.()
    props.onClick?.(event)
    context.setOpen(false)
  }, [context, disabled, onSelect, props])

  const itemProps = {
    ref: useMergeRefs([item.ref, ref]),
    role: "menuitem",
    className,
    tabIndex: isActive ? 0 : -1,
    "data-highlighted": isActive,
    "aria-disabled": disabled,
    ...context.getItemProps({
      ...props,
      onClick: handleSelect,
    }),
  }

  if (asChild && React.isValidElement(children)) {
    const childProps = children.props

    // Create merged props without adding onClick directly to the props object
    const mergedProps = {
      ...itemProps,
      ...(typeof children.props === "object" ? children.props : {}),
    }

    // Handle onClick separately based on the element type
    const eventHandlers = {
      onClick: (event) => {
        // Cast the event to make it compatible with handleSelect
        handleSelect(event)
        childProps.onClick?.(event)
      },
    }

    return React.cloneElement(children, {
      ...mergedProps,
      ...eventHandlers,
    });
  }

  return <div {...itemProps}>{children}</div>;
})

DropdownMenuItem.displayName = "DropdownMenuItem"

export const DropdownMenuGroup = React.forwardRef(({ children, label, className, ...props }, ref) => {
  return (
    <div
      {...props}
      ref={ref}
      role="group"
      aria-label={label}
      className={`tiptap-button-group ${className || ""}`}>
      {children}
    </div>
  );
})

DropdownMenuGroup.displayName = "DropdownMenuGroup"

export const DropdownMenuSeparator = React.forwardRef(({ className, ...props }, ref) => (
  <Separator
    ref={ref}
    className={`tiptap-dropdown-menu-separator ${className || ""}`}
    {...props} />
))
DropdownMenuSeparator.displayName = Separator.displayName
</file>

<file path="src/components/tiptap-ui-primitive/dropdown-menu/dropdown-menu.scss">
.tiptap-dropdown-menu {
  --tt-popover-bg-color: var(--white);
  --tt-popover-border-color: var(--tt-gray-light-a-100);
  --tt-popover-text-color: var(--tt-gray-light-a-600);
  --tt-popover-label: var(--tt-gray-light-a-400);

  .dark & {
    --tt-popover-border-color: var(--tt-gray-dark-a-50);
    --tt-popover-bg-color: var(--tt-gray-dark-50);
    --tt-popover-text-color: var(--tt-gray-dark-a-600);
    --tt-popover-label: var(--tt-gray-dark-a-400);
  }
}

/* --------------------------------------------
      --------- POPOVER STYLING SETTINGS -----------
      -------------------------------------------- */
.tiptap-dropdown-menu {
  --padding: 0.25rem;
  --border-width: 1px;

  z-index: 200;
  border-radius: calc(
    var(--padding) + var(--tt-radius-lg) + var(--border-width)
  );
  border: var(--border-width) solid var(--tt-popover-border-color);
  background-color: var(--tt-popover-bg-color);
  padding: var(--padding);
  color: var(--tt-popover-text-color);
  box-shadow: var(--tt-shadow-elevated-md);
  outline: none;
  overflow: auto;
  gap: 0.25rem;

  button {
    width: 100%;
  }

  .tiptap-dropdown-menu-separator {
    margin: 0.25rem 0;
  }

  .tiptap-dropdown-menu-label {
    margin-left: 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
    color: var(--tt-popover-label);
  }

  /* Animation states */
  &[data-state="open"] {
    animation:
      fadeIn 150ms cubic-bezier(0.16, 1, 0.3, 1),
      zoomIn 150ms cubic-bezier(0.16, 1, 0.3, 1);
  }

  &[data-state="closed"] {
    animation:
      fadeOut 150ms cubic-bezier(0.16, 1, 0.3, 1),
      zoomOut 150ms cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* Position-based animations */
  &[data-side="top"],
  &[data-side="top-start"],
  &[data-side="top-end"] {
    animation: slideFromBottom 150ms cubic-bezier(0.16, 1, 0.3, 1);
  }

  &[data-side="right"],
  &[data-side="right-start"],
  &[data-side="right-end"] {
    animation: slideFromLeft 150ms cubic-bezier(0.16, 1, 0.3, 1);
  }

  &[data-side="bottom"],
  &[data-side="bottom-start"],
  &[data-side="bottom-end"] {
    animation: slideFromTop 150ms cubic-bezier(0.16, 1, 0.3, 1);
  }

  &[data-side="left"],
  &[data-side="left-start"],
  &[data-side="left-end"] {
    animation: slideFromRight 150ms cubic-bezier(0.16, 1, 0.3, 1);
  }
}
</file>

<file path="src/components/tiptap-ui-primitive/dropdown-menu/index.jsx">
export * from "./dropdown-menu"
</file>

<file path="src/components/tiptap-ui-primitive/popover/index.jsx">
export * from "./popover"
</file>

<file path="src/components/tiptap-ui-primitive/popover/popover.jsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
import * as React from "react"
import {
  useFloating,
  autoUpdate,
  offset,
  flip,
  shift,
  useClick,
  useDismiss,
  useRole,
  useInteractions,
  useMergeRefs,
  FloatingFocusManager,
  limitShift,
  FloatingPortal,
} from "@floating-ui/react"
import "@/components/tiptap-ui-primitive/popover/popover.scss"

const PopoverContext = React.createContext(null)

function usePopoverContext() {
  const context = React.useContext(PopoverContext)
  if (!context) {
    throw new Error("Popover components must be wrapped in <Popover />")
  }
  return context
}

function usePopover({
  initialOpen = false,
  modal,
  open: controlledOpen,
  onOpenChange: setControlledOpen,
  side = "bottom",
  align = "center",
  sideOffset = 4,
  alignOffset = 0
} = {}) {
  const [uncontrolledOpen, setUncontrolledOpen] = React.useState(initialOpen)
  const [labelId, setLabelId] = React.useState()
  const [descriptionId, setDescriptionId] = React.useState()
  const [currentPlacement, setCurrentPlacement] = React.useState(`${side}-${align}`)
  const [offsets, setOffsets] = React.useState({ sideOffset, alignOffset })

  const open = controlledOpen ?? uncontrolledOpen
  const setOpen = setControlledOpen ?? setUncontrolledOpen

  const middleware = React.useMemo(() => [
    offset({
      mainAxis: offsets.sideOffset,
      crossAxis: offsets.alignOffset,
    }),
    flip({
      fallbackAxisSideDirection: "end",
      crossAxis: false,
    }),
    shift({
      limiter: limitShift({ offset: offsets.sideOffset }),
    }),
  ], [offsets.sideOffset, offsets.alignOffset])

  const floating = useFloating({
    placement: currentPlacement,
    open,
    onOpenChange: setOpen,
    whileElementsMounted: autoUpdate,
    middleware,
  })

  const interactions = useInteractions([
    useClick(floating.context),
    useDismiss(floating.context),
    useRole(floating.context),
  ])

  const updatePosition = React.useCallback((
    newSide,
    newAlign,
    newSideOffset,
    newAlignOffset
  ) => {
    setCurrentPlacement(`${newSide}-${newAlign}`)
    if (newSideOffset !== undefined || newAlignOffset !== undefined) {
      setOffsets({
        sideOffset: newSideOffset ?? offsets.sideOffset,
        alignOffset: newAlignOffset ?? offsets.alignOffset,
      })
    }
  }, [offsets.sideOffset, offsets.alignOffset])

  return React.useMemo(() => ({
    open,
    setOpen,
    ...interactions,
    ...floating,
    modal,
    labelId,
    descriptionId,
    setLabelId,
    setDescriptionId,
    updatePosition,
  }), [
    open,
    setOpen,
    interactions,
    floating,
    modal,
    labelId,
    descriptionId,
    updatePosition,
  ]);
}

function Popover({
  children,
  modal = false,
  ...options
}) {
  const popover = usePopover({ modal, ...options })
  return (
    <PopoverContext.Provider value={popover}>
      {children}
    </PopoverContext.Provider>
  );
}

const PopoverTrigger = React.forwardRef(
  function PopoverTrigger({ children, asChild = false, ...props }, propRef) {
    const context = usePopoverContext()
    const childrenRef = React.isValidElement(children)
      ? parseInt(React.version, 10) >= 19
        ? (children.props).ref
        : (children).ref
      : undefined
    const ref = useMergeRefs([context.refs.setReference, propRef, childrenRef])

    if (asChild && React.isValidElement(children)) {
      return React.cloneElement(children, context.getReferenceProps({
        ref,
        ...props,
        ...(children.props),
        "data-state": context.open ? "open" : "closed",
      }));
    }

    return (
      <button
        ref={ref}
        data-state={context.open ? "open" : "closed"}
        {...context.getReferenceProps(props)}>
        {children}
      </button>
    );
  }
)

const PopoverContent = React.forwardRef(function PopoverContent(
  {
    className,
    side = "bottom",
    align = "center",
    sideOffset,
    alignOffset,
    style,
    portal = true,
    portalProps = {},
    asChild = false,
    children,
    ...props
  },
  propRef
) {
  const context = usePopoverContext()
  const childrenRef = React.isValidElement(children)
    ? parseInt(React.version, 10) >= 19
      ? (children.props).ref
      : (children).ref
    : undefined
  const ref = useMergeRefs([context.refs.setFloating, propRef, childrenRef])

  React.useEffect(() => {
    context.updatePosition(side, align, sideOffset, alignOffset)
  }, [context, side, align, sideOffset, alignOffset])

  if (!context.context.open) return null

  const contentProps = {
    ref,
    style: {
      position: context.strategy,
      top: context.y ?? 0,
      left: context.x ?? 0,
      ...style,
    },
    "aria-labelledby": context.labelId,
    "aria-describedby": context.descriptionId,
    className: `tiptap-popover ${className || ""}`,
    "data-side": side,
    "data-align": align,
    "data-state": context.context.open ? "open" : "closed",
    ...context.getFloatingProps(props),
  }

  const content =
    asChild && React.isValidElement(children) ? (
      React.cloneElement(children, {
        ...contentProps,
        ...(children.props),
      })
    ) : (
      <div {...contentProps}>{children}</div>
    )

  const wrappedContent = (
    <FloatingFocusManager context={context.context} modal={context.modal}>
      {content}
    </FloatingFocusManager>
  )

  if (portal) {
    return <FloatingPortal {...portalProps}>{wrappedContent}</FloatingPortal>;
  }

  return wrappedContent
})

PopoverTrigger.displayName = "PopoverTrigger"
PopoverContent.displayName = "PopoverContent"

export { Popover, PopoverTrigger, PopoverContent }
</file>

<file path="src/components/tiptap-ui-primitive/popover/popover.scss">
.tiptap-popover {
  --tt-popover-bg-color: var(--white);
  --tt-popover-border-color: var(--tt-gray-light-a-100);
  --tt-popover-text-color: var(--tt-gray-light-a-600);

  .dark & {
    --tt-popover-border-color: var(--tt-gray-dark-a-50);
    --tt-popover-bg-color: var(--tt-gray-dark-50);
    --tt-popover-text-color: var(--tt-gray-dark-a-600);
  }
}

/* --------------------------------------------
    --------- POPOVER STYLING SETTINGS -----------
    -------------------------------------------- */
.tiptap-popover {
  --padding: 0.25rem;
  --border-width: 1px;

  z-index: 50;
  border-radius: calc(
    var(--padding) + var(--tt-radius-lg) + var(--border-width)
  );
  border: var(--border-width) solid var(--tt-popover-border-color);
  background-color: var(--tt-popover-bg-color);
  padding: var(--padding);
  color: var(--tt-popover-text-color);
  box-shadow: var(--tt-shadow-elevated-md);
  outline: none;
  overflow: hidden;
  display: flex;
  align-items: center;
  gap: 0.25rem;

  button {
    width: 100%;
  }

  &[data-orientation="horizontal"] {
    --padding: 0.125rem;
  }

  /* Animation states */
  &[data-state="open"] {
    animation:
      fadeIn 150ms cubic-bezier(0.16, 1, 0.3, 1),
      zoomIn 150ms cubic-bezier(0.16, 1, 0.3, 1);
  }

  &[data-state="closed"] {
    animation:
      fadeOut 150ms cubic-bezier(0.16, 1, 0.3, 1),
      zoomOut 150ms cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* Position-based animations */
  &[data-side="top"],
  &[data-side="top-start"],
  &[data-side="top-end"] {
    animation: slideFromBottom 150ms cubic-bezier(0.16, 1, 0.3, 1);
  }

  &[data-side="right"],
  &[data-side="right-start"],
  &[data-side="right-end"] {
    animation: slideFromLeft 150ms cubic-bezier(0.16, 1, 0.3, 1);
  }

  &[data-side="bottom"],
  &[data-side="bottom-start"],
  &[data-side="bottom-end"] {
    animation: slideFromTop 150ms cubic-bezier(0.16, 1, 0.3, 1);
  }

  &[data-side="left"],
  &[data-side="left-start"],
  &[data-side="left-end"] {
    animation: slideFromRight 150ms cubic-bezier(0.16, 1, 0.3, 1);
  }
}
</file>

<file path="src/components/tiptap-ui-primitive/separator/index.jsx">
export * from "./separator"
</file>

<file path="src/components/tiptap-ui-primitive/separator/separator.jsx">
import * as React from "react"
import "@/components/tiptap-ui-primitive/separator/separator.scss"

export const Separator = React.forwardRef((
  { decorative, orientation = "vertical", className = "", ...divProps },
  ref
) => {
  const ariaOrientation = orientation === "vertical" ? orientation : undefined
  const semanticProps = decorative
    ? { role: "none" }
    : { "aria-orientation": ariaOrientation, role: "separator" }

  return (
    <div
      className={`tiptap-separator ${className}`.trim()}
      data-orientation={orientation}
      {...semanticProps}
      {...divProps}
      ref={ref} />
  );
})

Separator.displayName = "Separator"
</file>

<file path="src/components/tiptap-ui-primitive/separator/separator.scss">
.tiptap-separator {
  --tt-link-border-color: var(--tt-gray-light-a-200);

  .dark & {
    --tt-link-border-color: var(--tt-gray-dark-a-200);
  }
}

.tiptap-separator {
  flex-shrink: 0;
  background-color: var(--tt-link-border-color);

  &[data-orientation="horizontal"] {
    height: 1px;
    width: 100%;
  }

  &[data-orientation="vertical"] {
    height: 1.5rem;
    width: 1px;
  }
}
</file>

<file path="src/components/tiptap-ui-primitive/spacer/index.jsx">
export * from "./spacer"
</file>

<file path="src/components/tiptap-ui-primitive/spacer/spacer.jsx">
import * as React from "react"

export const Spacer = React.forwardRef((
  { orientation = "horizontal", size, className = "", style = {}, ...props },
  ref
) => {
  const computedStyle = {
    ...style,
    ...(orientation === "horizontal" && !size && { flex: 1 }),
    ...(size && {
      width: orientation === "vertical" ? "1px" : size,
      height: orientation === "horizontal" ? "1px" : size,
    }),
  }

  return (<div ref={ref} {...props} className={className} style={computedStyle} />);
})

Spacer.displayName = "Spacer"
</file>

<file path="src/components/tiptap-ui-primitive/toolbar/index.jsx">
export * from "./toolbar"
</file>

<file path="src/components/tiptap-ui-primitive/toolbar/toolbar.jsx">
"use client";
import * as React from "react"
import { Separator } from "@/components/tiptap-ui-primitive/separator"
import "@/components/tiptap-ui-primitive/toolbar/toolbar.scss"

const mergeRefs = refs => {
  return (value) => {
    refs.forEach((ref) => {
      if (typeof ref === "function") {
        ref(value)
      } else if (ref != null) {
        ;(ref).current = value
      }
    })
  };
}

const useObserveVisibility = (ref, callback) => {
  React.useEffect(() => {
    const element = ref.current
    if (!element) return

    let isMounted = true

    if (isMounted) {
      requestAnimationFrame(callback)
    }

    const observer = new MutationObserver(() => {
      if (isMounted) {
        requestAnimationFrame(callback)
      }
    })

    observer.observe(element, {
      childList: true,
      subtree: true,
      attributes: true,
    })

    return () => {
      isMounted = false
      observer.disconnect()
    };
  }, [ref, callback])
}

const useToolbarKeyboardNav = toolbarRef => {
  React.useEffect(() => {
    const toolbar = toolbarRef.current
    if (!toolbar) return

    const getFocusableElements = () =>
      Array.from(toolbar.querySelectorAll(
        'button:not([disabled]), [role="button"]:not([disabled]), [tabindex="0"]:not([disabled])'
      ))

    const navigateToIndex = (
      e,
      targetIndex,
      elements
    ) => {
      e.preventDefault()
      let nextIndex = targetIndex

      if (nextIndex >= elements.length) {
        nextIndex = 0
      } else if (nextIndex < 0) {
        nextIndex = elements.length - 1
      }

      elements[nextIndex]?.focus()
    }

    const handleKeyDown = (e) => {
      const focusableElements = getFocusableElements()
      if (!focusableElements.length) return

      const currentElement = document.activeElement
      const currentIndex = focusableElements.indexOf(currentElement)

      if (!toolbar.contains(currentElement)) return

      const keyActions = {
        ArrowRight: () =>
          navigateToIndex(e, currentIndex + 1, focusableElements),
        ArrowDown: () =>
          navigateToIndex(e, currentIndex + 1, focusableElements),
        ArrowLeft: () =>
          navigateToIndex(e, currentIndex - 1, focusableElements),
        ArrowUp: () => navigateToIndex(e, currentIndex - 1, focusableElements),
        Home: () => navigateToIndex(e, 0, focusableElements),
        End: () =>
          navigateToIndex(e, focusableElements.length - 1, focusableElements),
      }

      const action = keyActions[e.key]
      if (action) {
        action()
      }
    }

    const handleFocus = (e) => {
      const target = e.target
      if (toolbar.contains(target)) {
        target.setAttribute("data-focus-visible", "true")
      }
    }

    const handleBlur = (e) => {
      const target = e.target
      if (toolbar.contains(target)) {
        target.removeAttribute("data-focus-visible")
      }
    }

    toolbar.addEventListener("keydown", handleKeyDown)
    toolbar.addEventListener("focus", handleFocus, true)
    toolbar.addEventListener("blur", handleBlur, true)

    const focusableElements = getFocusableElements()
    focusableElements.forEach((element) => {
      element.addEventListener("focus", handleFocus)
      element.addEventListener("blur", handleBlur)
    })

    return () => {
      toolbar.removeEventListener("keydown", handleKeyDown)
      toolbar.removeEventListener("focus", handleFocus, true)
      toolbar.removeEventListener("blur", handleBlur, true)

      const focusableElements = getFocusableElements()
      focusableElements.forEach((element) => {
        element.removeEventListener("focus", handleFocus)
        element.removeEventListener("blur", handleBlur)
      })
    };
  }, [toolbarRef])
}

const useToolbarVisibility = ref => {
  const [isVisible, setIsVisible] = React.useState(true)
  const isMountedRef = React.useRef(false)

  React.useEffect(() => {
    isMountedRef.current = true
    return () => {
      isMountedRef.current = false
    }
  }, [])

  const checkVisibility = React.useCallback(() => {
    if (!isMountedRef.current) return

    const toolbar = ref.current
    if (!toolbar) return

    // Check if any group has visible children
    const hasVisibleChildren = Array.from(toolbar.children).some((child) => {
      if (!(child instanceof HTMLElement)) return false
      if (child.getAttribute("role") === "group") {
        return child.children.length > 0
      }
      return false
    })

    setIsVisible(hasVisibleChildren)
  }, [ref])

  useObserveVisibility(ref, checkVisibility)
  return isVisible
}

const useGroupVisibility = ref => {
  const [isVisible, setIsVisible] = React.useState(true)
  const isMountedRef = React.useRef(false)

  React.useEffect(() => {
    isMountedRef.current = true
    return () => {
      isMountedRef.current = false
    }
  }, [])

  const checkVisibility = React.useCallback(() => {
    if (!isMountedRef.current) return

    const group = ref.current
    if (!group) return

    const hasVisibleChildren = Array.from(group.children).some((child) => {
      if (!(child instanceof HTMLElement)) return false
      return true
    })

    setIsVisible(hasVisibleChildren)
  }, [ref])

  useObserveVisibility(ref, checkVisibility)
  return isVisible
}

const useSeparatorVisibility = ref => {
  const [isVisible, setIsVisible] = React.useState(true)
  const isMountedRef = React.useRef(false)

  React.useEffect(() => {
    isMountedRef.current = true
    return () => {
      isMountedRef.current = false
    }
  }, [])

  const checkVisibility = React.useCallback(() => {
    if (!isMountedRef.current) return

    const separator = ref.current
    if (!separator) return

    const prevSibling = separator.previousElementSibling
    const nextSibling = separator.nextElementSibling

    if (!prevSibling || !nextSibling) {
      setIsVisible(false)
      return
    }

    const areBothGroups =
      prevSibling.getAttribute("role") === "group" &&
      nextSibling.getAttribute("role") === "group"

    const haveBothChildren =
      prevSibling.children.length > 0 && nextSibling.children.length > 0

    setIsVisible(areBothGroups && haveBothChildren)
  }, [ref])

  useObserveVisibility(ref, checkVisibility)
  return isVisible
}

export const Toolbar = React.forwardRef(({ children, className, variant = "fixed", ...props }, ref) => {
  const toolbarRef = React.useRef(null)
  const isVisible = useToolbarVisibility(toolbarRef)

  useToolbarKeyboardNav(toolbarRef)

  if (!isVisible) return null

  return (
    <div
      ref={mergeRefs([toolbarRef, ref])}
      role="toolbar"
      aria-label="toolbar"
      data-variant={variant}
      className={`tiptap-toolbar ${className || ""}`}
      {...props}>
      {children}
    </div>
  );
})

Toolbar.displayName = "Toolbar"

export const ToolbarGroup = React.forwardRef(({ children, className, ...props }, ref) => {
  const groupRef = React.useRef(null)
  const isVisible = useGroupVisibility(groupRef)

  if (!isVisible) return null

  return (
    <div
      ref={mergeRefs([groupRef, ref])}
      role="group"
      className={`tiptap-toolbar-group ${className || ""}`}
      {...props}>
      {children}
    </div>
  );
})

ToolbarGroup.displayName = "ToolbarGroup"

export const ToolbarSeparator = React.forwardRef(({ ...props }, ref) => {
  const separatorRef = React.useRef(null)
  const isVisible = useSeparatorVisibility(separatorRef)

  if (!isVisible) return null

  return (
    <Separator
      ref={mergeRefs([separatorRef, ref])}
      orientation="vertical"
      decorative
      {...props} />
  );
})

ToolbarSeparator.displayName = "ToolbarSeparator"
</file>

<file path="src/components/tiptap-ui-primitive/tooltip/index.jsx">
export * from "./tooltip"
</file>

<file path="src/components/tiptap-ui-primitive/tooltip/tooltip.jsx">
"use client";
import * as React from "react"
import {
  useFloating,
  autoUpdate,
  offset,
  flip,
  shift,
  useHover,
  useFocus,
  useDismiss,
  useRole,
  useInteractions,
  useMergeRefs,
  FloatingPortal,
  FloatingDelayGroup,
} from "@floating-ui/react";
import "@/components/tiptap-ui-primitive/tooltip/tooltip.scss"

function useTooltip({
  initialOpen = false,
  placement = "top",
  open: controlledOpen,
  onOpenChange: setControlledOpen,
  delay = 600,
  closeDelay = 0
} = {}) {
  const [uncontrolledOpen, setUncontrolledOpen] =
    React.useState(initialOpen)

  const open = controlledOpen ?? uncontrolledOpen
  const setOpen = setControlledOpen ?? setUncontrolledOpen

  const data = useFloating({
    placement,
    open,
    onOpenChange: setOpen,
    whileElementsMounted: autoUpdate,
    middleware: [
      offset(4),
      flip({
        crossAxis: placement.includes("-"),
        fallbackAxisSideDirection: "start",
        padding: 4,
      }),
      shift({ padding: 4 }),
    ],
  })

  const context = data.context

  const hover = useHover(context, {
    mouseOnly: true,
    move: false,
    restMs: delay,
    enabled: controlledOpen == null,
    delay: {
      close: closeDelay,
    },
  })
  const focus = useFocus(context, {
    enabled: controlledOpen == null,
  })
  const dismiss = useDismiss(context)
  const role = useRole(context, { role: "tooltip" })

  const interactions = useInteractions([hover, focus, dismiss, role])

  return React.useMemo(() => ({
    open,
    setOpen,
    ...interactions,
    ...data,
  }), [open, setOpen, interactions, data]);
}

const TooltipContext = React.createContext(null)

function useTooltipContext() {
  const context = React.useContext(TooltipContext)

  if (context == null) {
    throw new Error("Tooltip components must be wrapped in <TooltipProvider />")
  }

  return context
}

export function Tooltip({
  children,
  ...props
}) {
  const tooltip = useTooltip(props)

  if (!props.useDelayGroup) {
    return (
      <TooltipContext.Provider value={tooltip}>
        {children}
      </TooltipContext.Provider>
    );
  }

  return (
    <FloatingDelayGroup
      delay={{ open: props.delay ?? 0, close: props.closeDelay ?? 0 }}
      timeoutMs={props.timeout}>
      <TooltipContext.Provider value={tooltip}>
        {children}
      </TooltipContext.Provider>
    </FloatingDelayGroup>
  );
}

export const TooltipTrigger = React.forwardRef(
  function TooltipTrigger({ children, asChild = false, ...props }, propRef) {
    const context = useTooltipContext()
    const childrenRef = React.isValidElement(children)
      ? parseInt(React.version, 10) >= 19
        ? // eslint-disable-next-line @typescript-eslint/no-explicit-any
          (children).props.ref
        : // eslint-disable-next-line @typescript-eslint/no-explicit-any
          (children).ref
      : undefined
    const ref = useMergeRefs([context.refs.setReference, propRef, childrenRef])

    if (asChild && React.isValidElement(children)) {
      const dataAttributes = {
        "data-tooltip-state": context.open ? "open" : "closed",
      }

      return React.cloneElement(children, context.getReferenceProps({
        ref,
        ...props,
        ...(typeof children.props === "object" ? children.props : {}),
        ...dataAttributes,
      }));
    }

    return (
      <button
        ref={ref}
        data-tooltip-state={context.open ? "open" : "closed"}
        {...context.getReferenceProps(props)}>
        {children}
      </button>
    );
  }
)

export const TooltipContent = React.forwardRef(function TooltipContent(
  { style, children, portal = true, portalProps = {}, ...props },
  propRef
) {
  const context = useTooltipContext()
  const ref = useMergeRefs([context.refs.setFloating, propRef])

  if (!context.open) return null

  const content = (
    <div
      ref={ref}
      style={{
        ...context.floatingStyles,
        ...style,
      }}
      {...context.getFloatingProps(props)}
      className="tiptap-tooltip">
      {children}
    </div>
  )

  if (portal) {
    return <FloatingPortal {...portalProps}>{content}</FloatingPortal>;
  }

  return content
})

Tooltip.displayName = "Tooltip"
TooltipTrigger.displayName = "TooltipTrigger"
TooltipContent.displayName = "TooltipContent"
</file>

<file path="src/components/tiptap-ui-primitive/tooltip/tooltip.scss">
.tiptap-tooltip {
  --tt-tooltip-bg: var(--tt-gray-light-900);
  --tt-tooltip-text: var(--white);
  --tt-kbd: var(--tt-gray-dark-a-400);

  .dark & {
    --tt-tooltip-bg: var(--white);
    --tt-tooltip-text: var(--tt-gray-light-600);
    --tt-kbd: var(--tt-gray-light-a-400);
  }
}

.tiptap-tooltip {
  z-index: 200;
  overflow: hidden;
  border-radius: var(--tt-radius-md, 0.375rem);
  background-color: var(--tt-tooltip-bg);
  padding: 0.375rem 0.5rem;
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--tt-tooltip-text);
  box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
  text-align: center;

  kbd {
    display: inline-block;
    text-align: center;
    vertical-align: baseline;
    font-family:
      ui-sans-serif,
      system-ui,
      -apple-system,
      BlinkMacSystemFont,
      "Segoe UI",
      Roboto,
      "Helvetica Neue",
      Arial,
      "Noto Sans",
      sans-serif;
    text-transform: capitalize;
    color: var(--tt-kbd);
  }
}
</file>

<file path="src/components/tiptap-ui/blockquote-button/blockquote-button.jsx">
import * as React from "react"
import { isNodeSelection } from "@tiptap/react";

// --- Hooks ---
import { useTiptapEditor } from "@/hooks/use-tiptap-editor"

// --- Icons ---
import { BlockQuoteIcon } from "@/components/tiptap-icons/block-quote-icon"

// --- Lib ---
import { isNodeInSchema } from "@/lib/tiptap-utils"

import { Button } from "@/components/tiptap-ui-primitive/button"

export function canToggleBlockquote(editor) {
  if (!editor) return false

  try {
    return editor.can().toggleWrap("blockquote");
  } catch {
    return false
  }
}

export function isBlockquoteActive(editor) {
  if (!editor) return false
  return editor.isActive("blockquote");
}

export function toggleBlockquote(editor) {
  if (!editor) return false
  return editor.chain().focus().toggleWrap("blockquote").run();
}

export function isBlockquoteButtonDisabled(editor, canToggle, userDisabled = false) {
  if (!editor) return true
  if (userDisabled) return true
  if (!canToggle) return true
  return false
}

export function shouldShowBlockquoteButton(params) {
  const { editor, hideWhenUnavailable, nodeInSchema, canToggle } = params

  if (!nodeInSchema || !editor) {
    return false
  }

  if (hideWhenUnavailable) {
    if (isNodeSelection(editor.state.selection) || !canToggle) {
      return false
    }
  }

  return Boolean(editor?.isEditable);
}

export function useBlockquoteState(
  editor,
  disabled = false,
  hideWhenUnavailable = false
) {
  const nodeInSchema = isNodeInSchema("blockquote", editor)

  const canToggle = canToggleBlockquote(editor)
  const isDisabled = isBlockquoteButtonDisabled(editor, canToggle, disabled)
  const isActive = isBlockquoteActive(editor)

  const shouldShow = React.useMemo(() =>
    shouldShowBlockquoteButton({
      editor,
      hideWhenUnavailable,
      nodeInSchema,
      canToggle,
    }), [editor, hideWhenUnavailable, nodeInSchema, canToggle])

  const handleToggle = React.useCallback(() => {
    if (!isDisabled && editor) {
      return toggleBlockquote(editor);
    }
    return false
  }, [editor, isDisabled])

  const shortcutKey = "Ctrl-Shift-b"
  const label = "Blockquote"

  return {
    nodeInSchema,
    canToggle,
    isDisabled,
    isActive,
    shouldShow,
    handleToggle,
    shortcutKey,
    label,
  }
}

export const BlockquoteButton = React.forwardRef((
  {
    editor: providedEditor,
    text,
    hideWhenUnavailable = false,
    className = "",
    disabled,
    onClick,
    children,
    ...buttonProps
  },
  ref
) => {
  const editor = useTiptapEditor(providedEditor)

  const {
    isDisabled,
    isActive,
    shouldShow,
    handleToggle,
    shortcutKey,
    label,
  } = useBlockquoteState(editor, disabled, hideWhenUnavailable)

  const handleClick = React.useCallback((e) => {
    onClick?.(e)

    if (!e.defaultPrevented && !isDisabled) {
      handleToggle()
    }
  }, [onClick, isDisabled, handleToggle])

  if (!shouldShow || !editor || !editor.isEditable) {
    return null
  }

  return (
    <Button
      type="button"
      className={className.trim()}
      disabled={isDisabled}
      data-style="ghost"
      data-active-state={isActive ? "on" : "off"}
      data-disabled={isDisabled}
      role="button"
      tabIndex={-1}
      aria-label="blockquote"
      aria-pressed={isActive}
      tooltip={label}
      shortcutKeys={shortcutKey}
      onClick={handleClick}
      {...buttonProps}
      ref={ref}>
      {children || (
        <>
          <BlockQuoteIcon className="tiptap-button-icon" />
          {text && <span className="tiptap-button-text">{text}</span>}
        </>
      )}
    </Button>
  );
})

BlockquoteButton.displayName = "BlockquoteButton"

export default BlockquoteButton
</file>

<file path="src/components/tiptap-ui/blockquote-button/index.jsx">
export * from "./blockquote-button"
</file>

<file path="src/components/tiptap-ui/code-block-button/code-block-button.jsx">
import * as React from "react"
import { isNodeSelection } from "@tiptap/react";

// --- Hooks ---
import { useTiptapEditor } from "@/hooks/use-tiptap-editor"

// --- Icons ---
import { CodeBlockIcon } from "@/components/tiptap-icons/code-block-icon"

// --- Lib ---
import { isNodeInSchema } from "@/lib/tiptap-utils"

import { Button } from "@/components/tiptap-ui-primitive/button"

export function canToggleCodeBlock(editor) {
  if (!editor) return false

  try {
    return editor.can().toggleNode("codeBlock", "paragraph");
  } catch {
    return false
  }
}

export function isCodeBlockActive(editor) {
  if (!editor) return false
  return editor.isActive("codeBlock");
}

export function toggleCodeBlock(editor) {
  if (!editor) return false
  return editor.chain().focus().toggleNode("codeBlock", "paragraph").run();
}

export function isCodeBlockButtonDisabled(editor, canToggle, userDisabled = false) {
  if (!editor) return true
  if (userDisabled) return true
  if (!canToggle) return true
  return false
}

export function shouldShowCodeBlockButton(params) {
  const { editor, hideWhenUnavailable, nodeInSchema, canToggle } = params

  if (!nodeInSchema || !editor) {
    return false
  }

  if (hideWhenUnavailable) {
    if (isNodeSelection(editor.state.selection) || !canToggle) {
      return false
    }
  }

  return Boolean(editor?.isEditable);
}

export function useCodeBlockState(
  editor,
  disabled = false,
  hideWhenUnavailable = false
) {
  const nodeInSchema = isNodeInSchema("codeBlock", editor)

  const canToggle = canToggleCodeBlock(editor)
  const isDisabled = isCodeBlockButtonDisabled(editor, canToggle, disabled)
  const isActive = isCodeBlockActive(editor)

  const shouldShow = React.useMemo(() =>
    shouldShowCodeBlockButton({
      editor,
      hideWhenUnavailable,
      nodeInSchema,
      canToggle,
    }), [editor, hideWhenUnavailable, nodeInSchema, canToggle])

  const handleToggle = React.useCallback(() => {
    if (!isDisabled && editor) {
      return toggleCodeBlock(editor);
    }
    return false
  }, [editor, isDisabled])

  const shortcutKey = "Ctrl-Alt-c"
  const label = "Code Block"

  return {
    nodeInSchema,
    canToggle,
    isDisabled,
    isActive,
    shouldShow,
    handleToggle,
    shortcutKey,
    label,
  }
}

export const CodeBlockButton = React.forwardRef((
  {
    editor: providedEditor,
    text,
    hideWhenUnavailable = false,
    className = "",
    disabled,
    onClick,
    children,
    ...buttonProps
  },
  ref
) => {
  const editor = useTiptapEditor(providedEditor)

  const {
    isDisabled,
    isActive,
    shouldShow,
    handleToggle,
    shortcutKey,
    label,
  } = useCodeBlockState(editor, disabled, hideWhenUnavailable)

  const handleClick = React.useCallback((e) => {
    onClick?.(e)

    if (!e.defaultPrevented && !isDisabled) {
      handleToggle()
    }
  }, [onClick, isDisabled, handleToggle])

  if (!shouldShow || !editor || !editor.isEditable) {
    return null
  }

  return (
    <Button
      type="button"
      className={className.trim()}
      disabled={isDisabled}
      data-style="ghost"
      data-active-state={isActive ? "on" : "off"}
      data-disabled={isDisabled}
      role="button"
      tabIndex={-1}
      aria-label="codeBlock"
      aria-pressed={isActive}
      tooltip={label}
      shortcutKeys={shortcutKey}
      onClick={handleClick}
      {...buttonProps}
      ref={ref}>
      {children || (
        <>
          <CodeBlockIcon className="tiptap-button-icon" />
          {text && <span className="tiptap-button-text">{text}</span>}
        </>
      )}
    </Button>
  );
})

CodeBlockButton.displayName = "CodeBlockButton"

export default CodeBlockButton
</file>

<file path="src/components/tiptap-ui/code-block-button/index.jsx">
export * from "./code-block-button"
</file>

<file path="src/components/tiptap-ui/color-highlight-button/color-highlight-button.jsx">
"use client";
import * as React from "react"
import { isNodeSelection } from "@tiptap/react";

// --- Hooks ---
import { useTiptapEditor } from "@/hooks/use-tiptap-editor"

// --- Lib ---
import {
  findNodePosition,
  isEmptyNode,
  isMarkInSchema,
} from "@/lib/tiptap-utils"

import { Button } from "@/components/tiptap-ui-primitive/button"

// --- Styles ---
import "@/components/tiptap-ui/color-highlight-button/color-highlight-button.scss"

export const HIGHLIGHT_COLORS = [
  {
    label: "Default background",
    value: "var(--tt-bg-color)",
    border: "var(--tt-bg-color-contrast)",
  },
  {
    label: "Gray background",
    value: "var(--tt-color-highlight-gray)",
    border: "var(--tt-color-highlight-gray-contrast)",
  },
  {
    label: "Brown background",
    value: "var(--tt-color-highlight-brown)",
    border: "var(--tt-color-highlight-brown-contrast)",
  },
  {
    label: "Orange background",
    value: "var(--tt-color-highlight-orange)",
    border: "var(--tt-color-highlight-orange-contrast)",
  },
  {
    label: "Yellow background",
    value: "var(--tt-color-highlight-yellow)",
    border: "var(--tt-color-highlight-yellow-contrast)",
  },
  {
    label: "Green background",
    value: "var(--tt-color-highlight-green)",
    border: "var(--tt-color-highlight-green-contrast)",
  },
  {
    label: "Blue background",
    value: "var(--tt-color-highlight-blue)",
    border: "var(--tt-color-highlight-blue-contrast)",
  },
  {
    label: "Purple background",
    value: "var(--tt-color-highlight-purple)",
    border: "var(--tt-color-highlight-purple-contrast)",
  },
  {
    label: "Pink background",
    value: "var(--tt-color-highlight-pink)",
    border: "var(--tt-color-highlight-pink-contrast)",
  },
  {
    label: "Red background",
    value: "var(--tt-color-highlight-red)",
    border: "var(--tt-color-highlight-red-contrast)",
  },
]

/**
 * Checks if highlight can be toggled in the current editor state
 */
export function canToggleHighlight(editor) {
  if (!editor) return false
  try {
    return editor.can().setMark("highlight");
  } catch {
    return false
  }
}

/**
 * Checks if highlight is active in the current selection
 */
export function isHighlightActive(editor, color) {
  if (!editor) return false
  return editor.isActive("highlight", { color });
}

/**
 * Toggles highlight on the current selection or specified node
 */
export function toggleHighlight(editor, color, node, nodePos) {
  if (!editor) return

  try {
    const chain = editor.chain().focus()

    if (isEmptyNode(node)) {
      chain.toggleMark("highlight", { color }).run()
    } else if (nodePos !== undefined && nodePos !== null && nodePos !== -1) {
      chain.setNodeSelection(nodePos).toggleMark("highlight", { color }).run()
    } else if (node) {
      const foundPos = findNodePosition({ editor, node })
      if (foundPos) {
        chain
          .setNodeSelection(foundPos.pos)
          .toggleMark("highlight", { color })
          .run()
      } else {
        chain.toggleMark("highlight", { color }).run()
      }
    } else {
      chain.toggleMark("highlight", { color }).run()
    }

    editor.chain().setMeta("hideDragHandle", true).run()
  } catch (error) {
    console.error("Failed to apply highlight:", error)
  }
}

/**
 * Determines if the highlight button should be disabled
 */
export function isColorHighlightButtonDisabled(editor, userDisabled = false) {
  if (!editor || userDisabled) return true

  const isIncompatibleContext =
    editor.isActive("code") ||
    editor.isActive("codeBlock") ||
    editor.isActive("imageUpload")

  return isIncompatibleContext || !canToggleHighlight(editor);
}

/**
 * Determines if the highlight button should be shown
 */
export function shouldShowColorHighlightButton(editor, hideWhenUnavailable, highlightInSchema) {
  if (!highlightInSchema || !editor) return false

  if (hideWhenUnavailable) {
    if (
      isNodeSelection(editor.state.selection) ||
      !canToggleHighlight(editor)
    ) {
      return false
    }
  }

  return true
}

/**
 * Custom hook to manage highlight button state
 */
export function useHighlightState(
  editor,
  color,
  disabled = false,
  hideWhenUnavailable = false
) {
  const highlightInSchema = isMarkInSchema("highlight", editor)
  const isDisabled = isColorHighlightButtonDisabled(editor, disabled)
  const isActive = isHighlightActive(editor, color)

  const shouldShow = React.useMemo(() =>
    shouldShowColorHighlightButton(editor, hideWhenUnavailable, highlightInSchema), [editor, hideWhenUnavailable, highlightInSchema])

  return {
    highlightInSchema,
    isDisabled,
    isActive,
    shouldShow,
  }
}

/**
 * ColorHighlightButton component for TipTap editor
 */
export const ColorHighlightButton = React.forwardRef((
  {
    editor: providedEditor,
    node,
    nodePos,
    color,
    text,
    hideWhenUnavailable = false,
    className = "",
    disabled,
    onClick,
    onApplied,
    children,
    style,
    ...buttonProps
  },
  ref
) => {
  const editor = useTiptapEditor(providedEditor)
  const { isDisabled, isActive, shouldShow } = useHighlightState(editor, color, disabled, hideWhenUnavailable)

  const handleClick = React.useCallback((e) => {
    onClick?.(e)

    if (!e.defaultPrevented && !isDisabled && editor) {
      toggleHighlight(editor, color, node, nodePos)
      onApplied?.(color)
    }
  }, [color, editor, isDisabled, node, nodePos, onClick, onApplied])

  const buttonStyle = React.useMemo(() =>
    ({
      ...style,
      "--highlight-color": color
    }), [color, style])

  if (!shouldShow || !editor || !editor.isEditable) {
    return null
  }

  return (
    <Button
      type="button"
      className={className.trim()}
      disabled={isDisabled}
      data-style="ghost"
      data-active-state={isActive ? "on" : "off"}
      data-disabled={isDisabled}
      role="button"
      tabIndex={-1}
      aria-label={`${color} highlight color`}
      aria-pressed={isActive}
      onClick={handleClick}
      style={buttonStyle}
      {...buttonProps}
      ref={ref}>
      {children || (
        <>
          <span
            className="tiptap-button-highlight"
            style={{
              "--highlight-color": color
            }} />
          {text && <span className="tiptap-button-text">{text}</span>}
        </>
      )}
    </Button>
  );
})

ColorHighlightButton.displayName = "ColorHighlightButton"

export default ColorHighlightButton
</file>

<file path="src/components/tiptap-ui/color-highlight-button/color-highlight-button.scss">
.tiptap-button-highlight {
  position: relative;
  width: 1.25rem;
  height: 1.25rem;
  margin: 0 -0.175rem;
  border-radius: var(--tt-radius-xl);
  background-color: var(--highlight-color);
  transition: transform 0.2s ease;

  &::after {
    content: "";
    position: absolute;
    width: 100%;
    height: 100%;
    left: 0;
    top: 0;
    border-radius: inherit;
    box-sizing: border-box;
    border: 1px solid var(--highlight-color);
    filter: brightness(95%);
    mix-blend-mode: multiply;

    .dark & {
      filter: brightness(140%);
      mix-blend-mode: lighten;
    }
  }
}

.tiptap-button {
  &[data-active-state="on"] {
    .tiptap-button-highlight {
      &::after {
        filter: brightness(80%);
      }
    }
  }

  .dark & {
    &[data-active-state="on"] {
      .tiptap-button-highlight {
        &::after {
          // Andere Eigenschaft für .dark Kontext
          filter: brightness(180%);
        }
      }
    }
  }
}
</file>

<file path="src/components/tiptap-ui/color-highlight-button/index.jsx">
export * from "./color-highlight-button"
</file>

<file path="src/components/tiptap-ui/color-highlight-popover/color-highlight-popover.jsx">
import * as React from "react"
import { isNodeSelection } from "@tiptap/react";

// --- Hooks ---
import { useMenuNavigation } from "@/hooks/use-menu-navigation"
import { useTiptapEditor } from "@/hooks/use-tiptap-editor"

// --- Icons ---
import { BanIcon } from "@/components/tiptap-icons/ban-icon"
import { HighlighterIcon } from "@/components/tiptap-icons/highlighter-icon"

// --- Lib ---
import { isMarkInSchema } from "@/lib/tiptap-utils"

import { Button } from "@/components/tiptap-ui-primitive/button"
import {
  Popover,
  PopoverTrigger,
  PopoverContent,
} from "@/components/tiptap-ui-primitive/popover"
import { Separator } from "@/components/tiptap-ui-primitive/separator"

// --- Tiptap UI ---
import {
  ColorHighlightButton,
  canToggleHighlight,
} from "@/components/tiptap-ui/color-highlight-button"

// --- Styles ---
import "@/components/tiptap-ui/color-highlight-popover/color-highlight-popover.scss"

export const DEFAULT_HIGHLIGHT_COLORS = [
  {
    label: "Green",
    value: "var(--tt-color-highlight-green)",
    border: "var(--tt-color-highlight-green-contrast)",
  },
  {
    label: "Blue",
    value: "var(--tt-color-highlight-blue)",
    border: "var(--tt-color-highlight-blue-contrast)",
  },
  {
    label: "Red",
    value: "var(--tt-color-highlight-red)",
    border: "var(--tt-color-highlight-red-contrast)",
  },
  {
    label: "Purple",
    value: "var(--tt-color-highlight-purple)",
    border: "var(--tt-color-highlight-purple-contrast)",
  },
  {
    label: "Yellow",
    value: "var(--tt-color-highlight-yellow)",
    border: "var(--tt-color-highlight-yellow-contrast)",
  },
]

export const ColorHighlightPopoverButton = React.forwardRef(({ className, children, ...props }, ref) => (
  <Button
    type="button"
    className={className}
    data-style="ghost"
    data-appearance="default"
    role="button"
    tabIndex={-1}
    aria-label="Highlight text"
    tooltip="Highlight"
    ref={ref}
    {...props}>
    {children || <HighlighterIcon className="tiptap-button-icon" />}
  </Button>
))

ColorHighlightPopoverButton.displayName = "ColorHighlightPopoverButton"

export function ColorHighlightPopoverContent({
  editor: providedEditor,
  colors = DEFAULT_HIGHLIGHT_COLORS,
  onClose
}) {
  const editor = useTiptapEditor(providedEditor)
  const containerRef = React.useRef(null)

  const removeHighlight = React.useCallback(() => {
    if (!editor) return
    editor.chain().focus().unsetMark("highlight").run()
    onClose?.()
  }, [editor, onClose])

  const menuItems = React.useMemo(() => [...colors, { label: "Remove highlight", value: "none" }], [colors])

  const { selectedIndex } = useMenuNavigation({
    containerRef,
    items: menuItems,
    orientation: "both",
    onSelect: (item) => {
      if (item.value === "none") {
        removeHighlight()
      }
      onClose?.()
    },
    onClose,
    autoSelectFirstItem: false,
  })

  return (
    <div
      ref={containerRef}
      className="tiptap-color-highlight-content"
      tabIndex={0}>
      <div className="tiptap-button-group" data-orientation="horizontal">
        {colors.map((color, index) => (
          <ColorHighlightButton
            key={color.value}
            editor={editor}
            color={color.value}
            aria-label={`${color.label} highlight color`}
            tabIndex={index === selectedIndex ? 0 : -1}
            data-highlighted={selectedIndex === index}
            onClick={onClose} />
        ))}
      </div>
      <Separator />
      <div className="tiptap-button-group">
        <Button
          onClick={removeHighlight}
          aria-label="Remove highlight"
          tabIndex={selectedIndex === colors.length ? 0 : -1}
          type="button"
          role="menuitem"
          data-style="ghost"
          data-highlighted={selectedIndex === colors.length}>
          <BanIcon className="tiptap-button-icon" />
        </Button>
      </div>
    </div>
  );
}

export function ColorHighlightPopover({
  editor: providedEditor,
  colors = DEFAULT_HIGHLIGHT_COLORS,
  hideWhenUnavailable = false,
  ...props
}) {
  const editor = useTiptapEditor(providedEditor)
  const [isOpen, setIsOpen] = React.useState(false)
  const [isDisabled, setIsDisabled] = React.useState(false)

  const markAvailable = isMarkInSchema("highlight", editor)

  React.useEffect(() => {
    if (!editor) return

    const updateIsDisabled = () => {
      let isDisabled = false

      if (!markAvailable || !editor) {
        isDisabled = true
      }

      const isInCompatibleContext =
        editor.isActive("code") ||
        editor.isActive("codeBlock") ||
        editor.isActive("imageUpload")

      if (isInCompatibleContext) {
        isDisabled = true
      }

      setIsDisabled(isDisabled)
    }

    editor.on("selectionUpdate", updateIsDisabled)
    editor.on("update", updateIsDisabled)

    return () => {
      editor.off("selectionUpdate", updateIsDisabled)
      editor.off("update", updateIsDisabled)
    };
  }, [editor, markAvailable])

  const isActive = editor?.isActive("highlight") ?? false

  const shouldShow = React.useMemo(() => {
    if (!hideWhenUnavailable || !editor) return true

    return !(
      isNodeSelection(editor.state.selection) || !canToggleHighlight(editor)
    );
  }, [hideWhenUnavailable, editor])

  if (!shouldShow || !editor || !editor.isEditable) {
    return null
  }

  return (
    <Popover open={isOpen} onOpenChange={setIsOpen}>
      <PopoverTrigger asChild>
        <ColorHighlightPopoverButton
          disabled={isDisabled}
          data-active-state={isActive ? "on" : "off"}
          data-disabled={isDisabled}
          aria-pressed={isActive}
          {...props} />
      </PopoverTrigger>
      <PopoverContent aria-label="Highlight colors">
        <ColorHighlightPopoverContent editor={editor} colors={colors} onClose={() => setIsOpen(false)} />
      </PopoverContent>
    </Popover>
  );
}

export default ColorHighlightPopover
</file>

<file path="src/components/tiptap-ui/color-highlight-popover/color-highlight-popover.scss">
.tiptap-color-highlight-content {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  outline: none;
}
</file>

<file path="src/components/tiptap-ui/color-highlight-popover/index.jsx">
export * from "./color-highlight-popover"
</file>

<file path="src/components/tiptap-ui/heading-button/heading-button.jsx">
import * as React from "react"
import { isNodeSelection } from "@tiptap/react";

// --- Hooks ---
import { useTiptapEditor } from "@/hooks/use-tiptap-editor"

// --- Icons ---
import { HeadingOneIcon } from "@/components/tiptap-icons/heading-one-icon"
import { HeadingTwoIcon } from "@/components/tiptap-icons/heading-two-icon"
import { HeadingThreeIcon } from "@/components/tiptap-icons/heading-three-icon"
import { HeadingFourIcon } from "@/components/tiptap-icons/heading-four-icon"
import { HeadingFiveIcon } from "@/components/tiptap-icons/heading-five-icon"
import { HeadingSixIcon } from "@/components/tiptap-icons/heading-six-icon"

// --- Lib ---
import { isNodeInSchema } from "@/lib/tiptap-utils"

import { Button } from "@/components/tiptap-ui-primitive/button"

export const headingIcons = {
  1: HeadingOneIcon,
  2: HeadingTwoIcon,
  3: HeadingThreeIcon,
  4: HeadingFourIcon,
  5: HeadingFiveIcon,
  6: HeadingSixIcon,
}

export const headingShortcutKeys = {
  1: "Ctrl-Alt-1",
  2: "Ctrl-Alt-2",
  3: "Ctrl-Alt-3",
  4: "Ctrl-Alt-4",
  5: "Ctrl-Alt-5",
  6: "Ctrl-Alt-6",
}

export function canToggleHeading(editor, level) {
  if (!editor) return false

  try {
    return editor.can().toggleNode("heading", "paragraph", { level });
  } catch {
    return false
  }
}

export function isHeadingActive(editor, level) {
  if (!editor) return false
  return editor.isActive("heading", { level });
}

export function toggleHeading(editor, level) {
  if (!editor) return

  if (editor.isActive("heading", { level })) {
    editor.chain().focus().setNode("paragraph").run()
  } else {
    editor.chain().focus().toggleNode("heading", "paragraph", { level }).run()
  }
}

export function isHeadingButtonDisabled(editor, level, userDisabled = false) {
  if (!editor) return true
  if (userDisabled) return true
  if (!canToggleHeading(editor, level)) return true
  return false
}

export function shouldShowHeadingButton(params) {
  const { editor, hideWhenUnavailable, headingInSchema } = params

  if (!headingInSchema || !editor) {
    return false
  }

  if (hideWhenUnavailable) {
    if (isNodeSelection(editor.state.selection)) {
      return false
    }
  }

  return true
}

export function getFormattedHeadingName(level) {
  return `Heading ${level}`
}

export function useHeadingState(
  editor,
  level,
  disabled = false
) {
  const headingInSchema = isNodeInSchema("heading", editor)
  const isDisabled = isHeadingButtonDisabled(editor, level, disabled)
  const isActive = isHeadingActive(editor, level)

  const Icon = headingIcons[level]
  const shortcutKey = headingShortcutKeys[level]
  const formattedName = getFormattedHeadingName(level)

  return {
    headingInSchema,
    isDisabled,
    isActive,
    Icon,
    shortcutKey,
    formattedName,
  }
}

export const HeadingButton = React.forwardRef((
  {
    editor: providedEditor,
    level,
    text,
    hideWhenUnavailable = false,
    className = "",
    disabled,
    onClick,
    children,
    ...buttonProps
  },
  ref
) => {
  const editor = useTiptapEditor(providedEditor)

  const {
    headingInSchema,
    isDisabled,
    isActive,
    Icon,
    shortcutKey,
    formattedName,
  } = useHeadingState(editor, level, disabled)

  const handleClick = React.useCallback((e) => {
    onClick?.(e)

    if (!e.defaultPrevented && !isDisabled && editor) {
      toggleHeading(editor, level)
    }
  }, [onClick, isDisabled, editor, level])

  const show = React.useMemo(() => {
    return shouldShowHeadingButton({
      editor,
      level,
      hideWhenUnavailable,
      headingInSchema,
    });
  }, [editor, level, hideWhenUnavailable, headingInSchema])

  if (!show || !editor || !editor.isEditable) {
    return null
  }

  return (
    <Button
      type="button"
      className={className.trim()}
      disabled={isDisabled}
      data-style="ghost"
      data-active-state={isActive ? "on" : "off"}
      data-disabled={isDisabled}
      role="button"
      tabIndex={-1}
      aria-label={formattedName}
      aria-pressed={isActive}
      tooltip={formattedName}
      shortcutKeys={shortcutKey}
      onClick={handleClick}
      {...buttonProps}
      ref={ref}>
      {children || (
        <>
          <Icon className="tiptap-button-icon" />
          {text && <span className="tiptap-button-text">{text}</span>}
        </>
      )}
    </Button>
  );
})

HeadingButton.displayName = "HeadingButton"

export default HeadingButton
</file>

<file path="src/components/tiptap-ui/heading-button/index.jsx">
export * from "./heading-button"
</file>

<file path="src/components/tiptap-ui/heading-dropdown-menu/heading-dropdown-menu.jsx">
import * as React from "react"
import { isNodeSelection } from "@tiptap/react";

// --- Hooks ---
import { useTiptapEditor } from "@/hooks/use-tiptap-editor"

// --- Icons ---
import { ChevronDownIcon } from "@/components/tiptap-icons/chevron-down-icon"
import { HeadingIcon } from "@/components/tiptap-icons/heading-icon"

// --- Lib ---
import { isNodeInSchema } from "@/lib/tiptap-utils"

// --- Tiptap UI ---
import { HeadingButton, headingIcons, getFormattedHeadingName } from "@/components/tiptap-ui/heading-button/heading-button";

import { Button } from "@/components/tiptap-ui-primitive/button"
import {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuGroup,
} from "@/components/tiptap-ui-primitive/dropdown-menu"

export function HeadingDropdownMenu({
  editor: providedEditor,
  levels = [1, 2, 3, 4, 5, 6],
  hideWhenUnavailable = false,
  onOpenChange,
  ...props
}) {
  const [isOpen, setIsOpen] = React.useState(false)
  const editor = useTiptapEditor(providedEditor)

  const headingInSchema = isNodeInSchema("heading", editor)

  const handleOnOpenChange = React.useCallback((open) => {
    setIsOpen(open)
    onOpenChange?.(open)
  }, [onOpenChange])

  const getActiveIcon = React.useCallback(() => {
    if (!editor) return <HeadingIcon className="tiptap-button-icon" />;

    const activeLevel = levels.find((level) =>
      editor.isActive("heading", { level }))

    if (!activeLevel) return <HeadingIcon className="tiptap-button-icon" />;

    const ActiveIcon = headingIcons[activeLevel]
    return <ActiveIcon className="tiptap-button-icon" />;
  }, [editor, levels])

  const canToggleAnyHeading = React.useCallback(() => {
    if (!editor) return false
    return levels.some((level) =>
      editor.can().toggleNode("heading", "paragraph", { level }));
  }, [editor, levels])

  const isDisabled = !canToggleAnyHeading()
  const isAnyHeadingActive = editor?.isActive("heading") ?? false

  const show = React.useMemo(() => {
    if (!headingInSchema || !editor) {
      return false
    }

    if (hideWhenUnavailable) {
      if (isNodeSelection(editor.state.selection) || !canToggleAnyHeading()) {
        return false
      }
    }

    return true
  }, [headingInSchema, editor, hideWhenUnavailable, canToggleAnyHeading])

  if (!show || !editor || !editor.isEditable) {
    return null
  }

  return (
    <DropdownMenu open={isOpen} onOpenChange={handleOnOpenChange}>
      <DropdownMenuTrigger asChild>
        <Button
          type="button"
          disabled={isDisabled}
          data-style="ghost"
          data-active-state={isAnyHeadingActive ? "on" : "off"}
          data-disabled={isDisabled}
          role="button"
          tabIndex={-1}
          aria-label="Format text as heading"
          aria-pressed={isAnyHeadingActive}
          tooltip="Heading"
          {...props}>
          {getActiveIcon()}
          <ChevronDownIcon className="tiptap-button-dropdown-small" />
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent>
        <DropdownMenuGroup>
          {levels.map((level) => (
            <DropdownMenuItem key={`heading-${level}`} asChild>
              <HeadingButton
                editor={editor}
                level={level}
                text={getFormattedHeadingName(level)}
                tooltip={""} />
            </DropdownMenuItem>
          ))}
        </DropdownMenuGroup>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}

export default HeadingDropdownMenu
</file>

<file path="src/components/tiptap-ui/heading-dropdown-menu/index.jsx">
export * from "./heading-dropdown-menu"
</file>

<file path="src/components/tiptap-ui/image-upload-button/image-upload-button.jsx">
"use client";
import * as React from "react"

// --- Hooks ---
import { useTiptapEditor } from "@/hooks/use-tiptap-editor"

// --- Icons ---
import { ImagePlusIcon } from "@/components/tiptap-icons/image-plus-icon"

import { Button } from "@/components/tiptap-ui-primitive/button"

export function isImageActive(editor, extensionName) {
  if (!editor) return false
  return editor.isActive(extensionName);
}

export function insertImage(editor, extensionName) {
  if (!editor) return false

  return editor
    .chain()
    .focus()
    .insertContent({
      type: extensionName,
    })
    .run();
}

export function useImageUploadButton(
  editor,
  extensionName = "imageUpload",
  disabled = false
) {
  const isActive = isImageActive(editor, extensionName)
  const handleInsertImage = React.useCallback(() => {
    if (disabled) return false
    return insertImage(editor, extensionName);
  }, [editor, extensionName, disabled])

  return {
    isActive,
    handleInsertImage,
  }
}

export const ImageUploadButton = React.forwardRef((
  {
    editor: providedEditor,
    extensionName = "imageUpload",
    text,
    className = "",
    disabled,
    onClick,
    children,
    ...buttonProps
  },
  ref
) => {
  const editor = useTiptapEditor(providedEditor)
  const { isActive, handleInsertImage } = useImageUploadButton(editor, extensionName, disabled)

  const handleClick = React.useCallback((e) => {
    onClick?.(e)

    if (!e.defaultPrevented && !disabled) {
      handleInsertImage()
    }
  }, [onClick, disabled, handleInsertImage])

  if (!editor || !editor.isEditable) {
    return null
  }

  return (
    <Button
      ref={ref}
      type="button"
      className={className.trim()}
      data-style="ghost"
      data-active-state={isActive ? "on" : "off"}
      role="button"
      tabIndex={-1}
      aria-label="Add image"
      aria-pressed={isActive}
      tooltip="Add image"
      onClick={handleClick}
      {...buttonProps}>
      {children || (
        <>
          <ImagePlusIcon className="tiptap-button-icon" />
          {text && <span className="tiptap-button-text">{text}</span>}
        </>
      )}
    </Button>
  );
})

ImageUploadButton.displayName = "ImageUploadButton"

export default ImageUploadButton
</file>

<file path="src/components/tiptap-ui/image-upload-button/index.jsx">
export * from "./image-upload-button"
</file>

<file path="src/components/tiptap-ui/link-popover/index.jsx">
export * from "./link-popover"
</file>

<file path="src/components/tiptap-ui/link-popover/link-popover.jsx">
import * as React from "react"
import { isNodeSelection } from "@tiptap/react";

// --- Hooks ---
import { useTiptapEditor } from "@/hooks/use-tiptap-editor"

// --- Icons ---
import { CornerDownLeftIcon } from "@/components/tiptap-icons/corner-down-left-icon"
import { ExternalLinkIcon } from "@/components/tiptap-icons/external-link-icon"
import { LinkIcon } from "@/components/tiptap-icons/link-icon"
import { TrashIcon } from "@/components/tiptap-icons/trash-icon"

// --- Lib ---
import { isMarkInSchema } from "@/lib/tiptap-utils"

import { Button } from "@/components/tiptap-ui-primitive/button"
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@/components/tiptap-ui-primitive/popover"
import { Separator } from "@/components/tiptap-ui-primitive/separator"

// --- Styles ---
import "@/components/tiptap-ui/link-popover/link-popover.scss"

export const useLinkHandler = (props) => {
  const { editor, onSetLink, onLinkActive } = props
  const [url, setUrl] = React.useState(null)

  React.useEffect(() => {
    if (!editor) return

    // Get URL immediately on mount
    const { href } = editor.getAttributes("link")

    if (editor.isActive("link") && url === null) {
      setUrl(href || "")
      onLinkActive?.()
    }
  }, [editor, onLinkActive, url])

  React.useEffect(() => {
    if (!editor) return

    const updateLinkState = () => {
      const { href } = editor.getAttributes("link")
      setUrl(href || "")

      if (editor.isActive("link") && url !== null) {
        onLinkActive?.()
      }
    }

    editor.on("selectionUpdate", updateLinkState)
    return () => {
      editor.off("selectionUpdate", updateLinkState)
    };
  }, [editor, onLinkActive, url])

  const setLink = React.useCallback(() => {
    if (!url || !editor) return

    editor.chain().focus().extendMarkRange("link").setLink({ href: url }).run()

    setUrl(null)

    onSetLink?.()
  }, [editor, onSetLink, url])

  const removeLink = React.useCallback(() => {
    if (!editor) return
    editor
      .chain()
      .focus()
      .extendMarkRange("link")
      .unsetLink()
      .setMeta("preventAutolink", true)
      .run()
    setUrl("")
  }, [editor])

  return {
    url: url || "",
    setUrl,
    setLink,
    removeLink,
    isActive: editor?.isActive("link") || false,
  };
}

export const LinkButton = React.forwardRef(({ className, children, ...props }, ref) => {
  return (
    <Button
      type="button"
      className={className}
      data-style="ghost"
      role="button"
      tabIndex={-1}
      aria-label="Link"
      tooltip="Link"
      ref={ref}
      {...props}>
      {children || <LinkIcon className="tiptap-button-icon" />}
    </Button>
  );
})

export const LinkContent = ({ editor: providedEditor }) => {
  const editor = useTiptapEditor(providedEditor)

  const linkHandler = useLinkHandler({
    editor: editor,
  })

  return <LinkMain {...linkHandler} />;
}

const LinkMain = ({
  url,
  setUrl,
  setLink,
  removeLink,
  isActive,
}) => {
  const handleKeyDown = (event) => {
    if (event.key === "Enter") {
      event.preventDefault()
      setLink()
    }
  }

  return (
    <>
      <input
        type="url"
        placeholder="Paste a link..."
        value={url}
        onChange={(e) => setUrl(e.target.value)}
        onKeyDown={handleKeyDown}
        autoComplete="off"
        autoCorrect="off"
        autoCapitalize="off"
        className="tiptap-input tiptap-input-clamp" />
      <div className="tiptap-button-group" data-orientation="horizontal">
        <Button
          type="button"
          onClick={setLink}
          title="Apply link"
          disabled={!url && !isActive}
          data-style="ghost">
          <CornerDownLeftIcon className="tiptap-button-icon" />
        </Button>
      </div>
      <Separator />
      <div className="tiptap-button-group" data-orientation="horizontal">
        <Button
          type="button"
          onClick={() => window.open(url, "_blank")}
          title="Open in new window"
          disabled={!url && !isActive}
          data-style="ghost">
          <ExternalLinkIcon className="tiptap-button-icon" />
        </Button>

        <Button
          type="button"
          onClick={removeLink}
          title="Remove link"
          disabled={!url && !isActive}
          data-style="ghost">
          <TrashIcon className="tiptap-button-icon" />
        </Button>
      </div>
    </>
  );
}

export function LinkPopover({
  editor: providedEditor,
  hideWhenUnavailable = false,
  onOpenChange,
  autoOpenOnLinkActive = true,
  ...props
}) {
  const editor = useTiptapEditor(providedEditor)

  const linkInSchema = isMarkInSchema("link", editor)

  const [isOpen, setIsOpen] = React.useState(false)

  const onSetLink = () => {
    setIsOpen(false)
  }

  const onLinkActive = () => setIsOpen(autoOpenOnLinkActive)

  const linkHandler = useLinkHandler({
    editor: editor,
    onSetLink,
    onLinkActive,
  })

  const isDisabled = React.useMemo(() => {
    if (!editor) return true
    if (editor.isActive("codeBlock")) return true
    return !editor.can().setLink?.({ href: "" });
  }, [editor])

  const canSetLink = React.useMemo(() => {
    if (!editor) return false
    try {
      return editor.can().setMark("link");
    } catch {
      return false
    }
  }, [editor])

  const isActive = editor?.isActive("link") ?? false

  const handleOnOpenChange = React.useCallback((nextIsOpen) => {
    setIsOpen(nextIsOpen)
    onOpenChange?.(nextIsOpen)
  }, [onOpenChange])

  const show = React.useMemo(() => {
    if (!linkInSchema || !editor) {
      return false
    }

    if (hideWhenUnavailable) {
      if (isNodeSelection(editor.state.selection) || !canSetLink) {
        return false
      }
    }

    return true
  }, [linkInSchema, hideWhenUnavailable, editor, canSetLink])

  if (!show || !editor || !editor.isEditable) {
    return null
  }

  return (
    <Popover open={isOpen} onOpenChange={handleOnOpenChange}>
      <PopoverTrigger asChild>
        <LinkButton
          disabled={isDisabled}
          data-active-state={isActive ? "on" : "off"}
          data-disabled={isDisabled}
          {...props} />
      </PopoverTrigger>
      <PopoverContent>
        <LinkMain {...linkHandler} />
      </PopoverContent>
    </Popover>
  );
}

LinkButton.displayName = "LinkButton"
</file>

<file path="src/components/tiptap-ui/link-popover/link-popover.scss">
.tiptap-input {
  display: block;
  width: 100%;
  height: 2rem;
  font-size: 1rem;
  line-height: 1.5rem;
  padding: 0.375rem 0.75rem;
  border-radius: 0.375rem;
  background: none;

  &:focus {
    outline: none;
  }

  &-clamp {
    min-width: 12rem;
    padding-right: 0;

    text-overflow: ellipsis;
    white-space: nowrap;

    &:focus {
      text-overflow: clip;
      overflow: visible;
    }
  }
}
</file>

<file path="src/components/tiptap-ui/list-button/index.jsx">
export * from "./list-button"
</file>

<file path="src/components/tiptap-ui/list-button/list-button.jsx">
"use client";
import * as React from "react"
import { isNodeSelection } from "@tiptap/react";

// --- Hooks ---
import { useTiptapEditor } from "@/hooks/use-tiptap-editor"

// --- Icons ---
import { ListIcon } from "@/components/tiptap-icons/list-icon"
import { ListOrderedIcon } from "@/components/tiptap-icons/list-ordered-icon"
import { ListTodoIcon } from "@/components/tiptap-icons/list-todo-icon"

// --- Lib ---
import { isNodeInSchema } from "@/lib/tiptap-utils"

import { Button } from "@/components/tiptap-ui-primitive/button"

export const listOptions = [
  {
    label: "Bullet List",
    type: "bulletList",
    icon: ListIcon,
  },
  {
    label: "Ordered List",
    type: "orderedList",
    icon: ListOrderedIcon,
  },
  {
    label: "Task List",
    type: "taskList",
    icon: ListTodoIcon,
  },
]

export const listShortcutKeys = {
  bulletList: "Ctrl-Shift-8",
  orderedList: "Ctrl-Shift-7",
  taskList: "Ctrl-Shift-9",
}

export function canToggleList(editor, type) {
  if (!editor) {
    return false
  }

  switch (type) {
    case "bulletList":
      return editor.can().toggleBulletList();
    case "orderedList":
      return editor.can().toggleOrderedList();
    case "taskList":
      return editor.can().toggleList("taskList", "taskItem");
    default:
      return false
  }
}

export function isListActive(editor, type) {
  if (!editor) return false

  switch (type) {
    case "bulletList":
      return editor.isActive("bulletList");
    case "orderedList":
      return editor.isActive("orderedList");
    case "taskList":
      return editor.isActive("taskList");
    default:
      return false
  }
}

export function toggleList(editor, type) {
  if (!editor) return

  switch (type) {
    case "bulletList":
      editor.chain().focus().toggleBulletList().run()
      break
    case "orderedList":
      editor.chain().focus().toggleOrderedList().run()
      break
    case "taskList":
      editor.chain().focus().toggleList("taskList", "taskItem").run()
      break
  }
}

export function getListOption(type) {
  return listOptions.find((option) => option.type === type);
}

export function shouldShowListButton(params) {
  const { editor, type, hideWhenUnavailable, listInSchema } = params

  if (!listInSchema || !editor) {
    return false
  }

  if (hideWhenUnavailable) {
    if (
      isNodeSelection(editor.state.selection) ||
      !canToggleList(editor, type)
    ) {
      return false
    }
  }

  return true
}

export function useListState(editor, type) {
  const listInSchema = isNodeInSchema(type, editor)
  const listOption = getListOption(type)
  const isActive = isListActive(editor, type)
  const shortcutKey = listShortcutKeys[type]

  return {
    listInSchema,
    listOption,
    isActive,
    shortcutKey,
  }
}

export const ListButton = React.forwardRef((
  {
    editor: providedEditor,
    type,
    hideWhenUnavailable = false,
    className = "",
    onClick,
    text,
    children,
    ...buttonProps
  },
  ref
) => {
  const editor = useTiptapEditor(providedEditor)
  const { listInSchema, listOption, isActive, shortcutKey } = useListState(editor, type)

  const Icon = listOption?.icon || ListIcon

  const handleClick = React.useCallback((e) => {
    onClick?.(e)

    if (!e.defaultPrevented && editor) {
      toggleList(editor, type)
    }
  }, [onClick, editor, type])

  const show = React.useMemo(() => {
    return shouldShowListButton({
      editor,
      type,
      hideWhenUnavailable,
      listInSchema,
    });
  }, [editor, type, hideWhenUnavailable, listInSchema])

  if (!show || !editor || !editor.isEditable) {
    return null
  }

  return (
    <Button
      type="button"
      className={className.trim()}
      data-style="ghost"
      data-active-state={isActive ? "on" : "off"}
      role="button"
      tabIndex={-1}
      aria-label={listOption?.label || type}
      aria-pressed={isActive}
      tooltip={listOption?.label || type}
      shortcutKeys={shortcutKey}
      onClick={handleClick}
      {...buttonProps}
      ref={ref}>
      {children || (
        <>
          <Icon className="tiptap-button-icon" />
          {text && <span className="tiptap-button-text">{text}</span>}
        </>
      )}
    </Button>
  );
})

ListButton.displayName = "ListButton"

export default ListButton
</file>

<file path="src/components/tiptap-ui/list-dropdown-menu/index.jsx">
export * from "./list-dropdown-menu"
</file>

<file path="src/components/tiptap-ui/list-dropdown-menu/list-dropdown-menu.jsx">
import * as React from "react"
import { isNodeSelection } from "@tiptap/react";

// --- Hooks ---
import { useTiptapEditor } from "@/hooks/use-tiptap-editor"

// --- Icons ---
import { ChevronDownIcon } from "@/components/tiptap-icons/chevron-down-icon"
import { ListIcon } from "@/components/tiptap-icons/list-icon"

// --- Lib ---
import { isNodeInSchema } from "@/lib/tiptap-utils"

// --- Tiptap UI ---
import { ListButton, canToggleList, isListActive, listOptions } from "@/components/tiptap-ui/list-button/list-button";

import { Button } from "@/components/tiptap-ui-primitive/button"
import {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuItem,
} from "@/components/tiptap-ui-primitive/dropdown-menu"

export function canToggleAnyList(editor, listTypes) {
  if (!editor) return false
  return listTypes.some((type) => canToggleList(editor, type));
}

export function isAnyListActive(editor, listTypes) {
  if (!editor) return false
  return listTypes.some((type) => isListActive(editor, type));
}

export function getFilteredListOptions(availableTypes) {
  return listOptions.filter((option) => !option.type || availableTypes.includes(option.type));
}

export function shouldShowListDropdown(params) {
  const { editor, hideWhenUnavailable, listInSchema, canToggleAny } = params

  if (!listInSchema || !editor) {
    return false
  }

  if (hideWhenUnavailable) {
    if (isNodeSelection(editor.state.selection) || !canToggleAny) {
      return false
    }
  }

  return true
}

export function useListDropdownState(
  editor,
  availableTypes
) {
  const [isOpen, setIsOpen] = React.useState(false)

  const listInSchema = availableTypes.some((type) =>
    isNodeInSchema(type, editor))

  const filteredLists = React.useMemo(() => getFilteredListOptions(availableTypes), [availableTypes])

  const canToggleAny = canToggleAnyList(editor, availableTypes)
  const isAnyActive = isAnyListActive(editor, availableTypes)

  const handleOpenChange = React.useCallback((open, callback) => {
    setIsOpen(open)
    callback?.(open)
  }, [])

  return {
    isOpen,
    setIsOpen,
    listInSchema,
    filteredLists,
    canToggleAny,
    isAnyActive,
    handleOpenChange,
  }
}

export function useActiveListIcon(
  editor,
  filteredLists
) {
  return React.useCallback(() => {
    const activeOption = filteredLists.find((option) =>
      isListActive(editor, option.type))

    return activeOption ? (
      <activeOption.icon className="tiptap-button-icon" />
    ) : (
      <ListIcon className="tiptap-button-icon" />
    );
  }, [editor, filteredLists]);
}

export function ListDropdownMenu({
  editor: providedEditor,
  types = ["bulletList", "orderedList", "taskList"],
  hideWhenUnavailable = false,
  onOpenChange,
  ...props
}) {
  const editor = useTiptapEditor(providedEditor)

  const {
    isOpen,
    listInSchema,
    filteredLists,
    canToggleAny,
    isAnyActive,
    handleOpenChange,
  } = useListDropdownState(editor, types)

  const getActiveIcon = useActiveListIcon(editor, filteredLists)

  const show = React.useMemo(() => {
    return shouldShowListDropdown({
      editor,
      listTypes: types,
      hideWhenUnavailable,
      listInSchema,
      canToggleAny,
    });
  }, [editor, types, hideWhenUnavailable, listInSchema, canToggleAny])

  const handleOnOpenChange = React.useCallback(
    (open) => handleOpenChange(open, onOpenChange),
    [handleOpenChange, onOpenChange]
  )

  if (!show || !editor || !editor.isEditable) {
    return null
  }

  return (
    <DropdownMenu open={isOpen} onOpenChange={handleOnOpenChange}>
      <DropdownMenuTrigger asChild>
        <Button
          type="button"
          data-style="ghost"
          data-active-state={isAnyActive ? "on" : "off"}
          role="button"
          tabIndex={-1}
          aria-label="List options"
          tooltip="List"
          {...props}>
          {getActiveIcon()}
          <ChevronDownIcon className="tiptap-button-dropdown-small" />
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent>
        <DropdownMenuGroup>
          {filteredLists.map((option) => (
            <DropdownMenuItem key={option.type} asChild>
              <ListButton
                editor={editor}
                type={option.type}
                text={option.label}
                hideWhenUnavailable={hideWhenUnavailable}
                tooltip={""} />
            </DropdownMenuItem>
          ))}
        </DropdownMenuGroup>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}

export default ListDropdownMenu
</file>

<file path="src/components/tiptap-ui/mark-button/index.jsx">
export * from "./mark-button"
</file>

<file path="src/components/tiptap-ui/mark-button/mark-button.jsx">
import * as React from "react"
import { isNodeSelection } from "@tiptap/react";

// --- Hooks ---
import { useTiptapEditor } from "@/hooks/use-tiptap-editor"

// --- Icons ---
import { BoldIcon } from "@/components/tiptap-icons/bold-icon"
import { Code2Icon } from "@/components/tiptap-icons/code2-icon"
import { ItalicIcon } from "@/components/tiptap-icons/italic-icon"
import { StrikeIcon } from "@/components/tiptap-icons/strike-icon"
import { SubscriptIcon } from "@/components/tiptap-icons/subscript-icon"
import { SuperscriptIcon } from "@/components/tiptap-icons/superscript-icon"
import { UnderlineIcon } from "@/components/tiptap-icons/underline-icon"

// --- Lib ---
import { isMarkInSchema } from "@/lib/tiptap-utils"

import { Button } from "@/components/tiptap-ui-primitive/button"

export const markIcons = {
  bold: BoldIcon,
  italic: ItalicIcon,
  underline: UnderlineIcon,
  strike: StrikeIcon,
  code: Code2Icon,
  superscript: SuperscriptIcon,
  subscript: SubscriptIcon,
}

export const markShortcutKeys = {
  bold: "Ctrl-b",
  italic: "Ctrl-i",
  underline: "Ctrl-u",
  strike: "Ctrl-Shift-s",
  code: "Ctrl-e",
  superscript: "Ctrl-.",
  subscript: "Ctrl-,",
}

export function canToggleMark(editor, type) {
  if (!editor) return false

  try {
    return editor.can().toggleMark(type);
  } catch {
    return false
  }
}

export function isMarkActive(editor, type) {
  if (!editor) return false
  return editor.isActive(type);
}

export function toggleMark(editor, type) {
  if (!editor) return
  editor.chain().focus().toggleMark(type).run()
}

export function isMarkButtonDisabled(editor, type, userDisabled = false) {
  if (!editor) return true
  if (userDisabled) return true
  if (editor.isActive("codeBlock")) return true
  if (!canToggleMark(editor, type)) return true
  return false
}

export function shouldShowMarkButton(params) {
  const { editor, type, hideWhenUnavailable, markInSchema } = params

  if (!markInSchema || !editor) {
    return false
  }

  if (hideWhenUnavailable) {
    if (
      isNodeSelection(editor.state.selection) ||
      !canToggleMark(editor, type)
    ) {
      return false
    }
  }

  return true
}

export function getFormattedMarkName(type) {
  return type.charAt(0).toUpperCase() + type.slice(1);
}

export function useMarkState(
  editor,
  type,
  disabled = false
) {
  const markInSchema = isMarkInSchema(type, editor)
  const isDisabled = isMarkButtonDisabled(editor, type, disabled)
  const isActive = isMarkActive(editor, type)

  const Icon = markIcons[type]
  const shortcutKey = markShortcutKeys[type]
  const formattedName = getFormattedMarkName(type)

  return {
    markInSchema,
    isDisabled,
    isActive,
    Icon,
    shortcutKey,
    formattedName,
  }
}

export const MarkButton = React.forwardRef((
  {
    editor: providedEditor,
    type,
    text,
    hideWhenUnavailable = false,
    className = "",
    disabled,
    onClick,
    children,
    ...buttonProps
  },
  ref
) => {
  const editor = useTiptapEditor(providedEditor)

  const {
    markInSchema,
    isDisabled,
    isActive,
    Icon,
    shortcutKey,
    formattedName,
  } = useMarkState(editor, type, disabled)

  const handleClick = React.useCallback((e) => {
    onClick?.(e)

    if (!e.defaultPrevented && !isDisabled && editor) {
      toggleMark(editor, type)
    }
  }, [onClick, isDisabled, editor, type])

  const show = React.useMemo(() => {
    return shouldShowMarkButton({
      editor,
      type,
      hideWhenUnavailable,
      markInSchema,
    });
  }, [editor, type, hideWhenUnavailable, markInSchema])

  if (!show || !editor || !editor.isEditable) {
    return null
  }

  return (
    <Button
      type="button"
      className={className.trim()}
      disabled={isDisabled}
      data-style="ghost"
      data-active-state={isActive ? "on" : "off"}
      data-disabled={isDisabled}
      role="button"
      tabIndex={-1}
      aria-label={type}
      aria-pressed={isActive}
      tooltip={formattedName}
      shortcutKeys={shortcutKey}
      onClick={handleClick}
      {...buttonProps}
      ref={ref}>
      {children || (
        <>
          <Icon className="tiptap-button-icon" />
          {text && <span className="tiptap-button-text">{text}</span>}
        </>
      )}
    </Button>
  );
})

MarkButton.displayName = "MarkButton"

export default MarkButton
</file>

<file path="src/components/tiptap-ui/text-align-button/index.jsx">
export * from "./text-align-button"
</file>

<file path="src/components/tiptap-ui/text-align-button/text-align-button.jsx">
import * as React from "react"

// --- Hooks ---
import { useTiptapEditor } from "@/hooks/use-tiptap-editor"

// --- Icons ---
import { AlignCenterIcon } from "@/components/tiptap-icons/align-center-icon"
import { AlignJustifyIcon } from "@/components/tiptap-icons/align-justify-icon"
import { AlignLeftIcon } from "@/components/tiptap-icons/align-left-icon"
import { AlignRightIcon } from "@/components/tiptap-icons/align-right-icon"

import { Button } from "@/components/tiptap-ui-primitive/button"

export const textAlignIcons = {
  left: AlignLeftIcon,
  center: AlignCenterIcon,
  right: AlignRightIcon,
  justify: AlignJustifyIcon,
}

export const textAlignShortcutKeys = {
  left: "Ctrl-Shift-l",
  center: "Ctrl-Shift-e",
  right: "Ctrl-Shift-r",
  justify: "Ctrl-Shift-j",
}

export const textAlignLabels = {
  left: "Align left",
  center: "Align center",
  right: "Align right",
  justify: "Align justify",
}

export function hasSetTextAlign(commands) {
  return "setTextAlign" in commands
}

export function checkTextAlignExtension(editor) {
  if (!editor) return false

  const hasExtension = editor.extensionManager.extensions.some((extension) => extension.name === "textAlign")

  if (!hasExtension) {
    console.warn("TextAlign extension is not available. " +
      "Make sure it is included in your editor configuration.")
  }

  return hasExtension
}

export function canSetTextAlign(editor, align, alignAvailable) {
  if (!editor || !alignAvailable) return false

  try {
    return editor.can().setTextAlign(align);
  } catch {
    return false
  }
}

export function isTextAlignActive(editor, align) {
  if (!editor) return false
  return editor.isActive({ textAlign: align });
}

export function setTextAlign(editor, align) {
  if (!editor) return false

  const chain = editor.chain().focus()
  if (hasSetTextAlign(chain)) {
    return chain.setTextAlign(align).run();
  }
  return false
}

export function isTextAlignButtonDisabled(editor, alignAvailable, canAlign, userDisabled = false) {
  if (!editor || !alignAvailable) return true
  if (userDisabled) return true
  if (!canAlign) return true
  return false
}

export function shouldShowTextAlignButton(editor, canAlign, hideWhenUnavailable) {
  if (!editor?.isEditable) return false
  if (hideWhenUnavailable && !canAlign) return false
  return true
}

export function useTextAlign(
  editor,
  align,
  disabled = false,
  hideWhenUnavailable = false
) {
  const alignAvailable = React.useMemo(() => checkTextAlignExtension(editor), [editor])

  const canAlign = React.useMemo(
    () => canSetTextAlign(editor, align, alignAvailable),
    [editor, align, alignAvailable]
  )

  const isDisabled = isTextAlignButtonDisabled(editor, alignAvailable, canAlign, disabled)
  const isActive = isTextAlignActive(editor, align)

  const handleAlignment = React.useCallback(() => {
    if (!alignAvailable || !editor || isDisabled) return false
    return setTextAlign(editor, align);
  }, [alignAvailable, editor, isDisabled, align])

  const shouldShow = React.useMemo(
    () => shouldShowTextAlignButton(editor, canAlign, hideWhenUnavailable),
    [editor, canAlign, hideWhenUnavailable]
  )

  const Icon = textAlignIcons[align]
  const shortcutKey = textAlignShortcutKeys[align]
  const label = textAlignLabels[align]

  return {
    alignAvailable,
    canAlign,
    isDisabled,
    isActive,
    handleAlignment,
    shouldShow,
    Icon,
    shortcutKey,
    label,
  }
}

export const TextAlignButton = React.forwardRef((
  {
    editor: providedEditor,
    align,
    text,
    hideWhenUnavailable = false,
    className = "",
    disabled,
    onClick,
    children,
    ...buttonProps
  },
  ref
) => {
  const editor = useTiptapEditor(providedEditor)

  const {
    isDisabled,
    isActive,
    handleAlignment,
    shouldShow,
    Icon,
    shortcutKey,
    label,
  } = useTextAlign(editor, align, disabled, hideWhenUnavailable)

  const handleClick = React.useCallback((e) => {
    onClick?.(e)

    if (!e.defaultPrevented && !disabled) {
      handleAlignment()
    }
  }, [onClick, disabled, handleAlignment])

  if (!shouldShow || !editor || !editor.isEditable) {
    return null
  }

  return (
    <Button
      type="button"
      className={className.trim()}
      disabled={isDisabled}
      data-style="ghost"
      data-active-state={isActive ? "on" : "off"}
      data-disabled={isDisabled}
      role="button"
      tabIndex={-1}
      aria-label={label}
      aria-pressed={isActive}
      tooltip={label}
      shortcutKeys={shortcutKey}
      onClick={handleClick}
      {...buttonProps}
      ref={ref}>
      {children || (
        <>
          <Icon className="tiptap-button-icon" />
          {text && <span className="tiptap-button-text">{text}</span>}
        </>
      )}
    </Button>
  );
})

TextAlignButton.displayName = "TextAlignButton"

export default TextAlignButton
</file>

<file path="src/components/tiptap-ui/undo-redo-button/index.jsx">
export * from "./undo-redo-button"
</file>

<file path="src/components/tiptap-ui/undo-redo-button/undo-redo-button.jsx">
import * as React from "react"

// --- Hooks ---
import { useTiptapEditor } from "@/hooks/use-tiptap-editor"

// --- Icons ---
import { Redo2Icon } from "@/components/tiptap-icons/redo2-icon"
import { Undo2Icon } from "@/components/tiptap-icons/undo2-icon"

import { Button } from "@/components/tiptap-ui-primitive/button";

export const historyIcons = {
  undo: Undo2Icon,
  redo: Redo2Icon,
}

export const historyShortcutKeys = {
  undo: "Ctrl-z",
  redo: "Ctrl-Shift-z",
}

export const historyActionLabels = {
  undo: "Undo",
  redo: "Redo",
}

/**
 * Checks if a history action can be executed.
 *
 * @param editor The TipTap editor instance
 * @param action The history action to check
 * @returns Whether the action can be executed
 */
export function canExecuteHistoryAction(editor, action) {
  if (!editor) return false
  return action === "undo" ? editor.can().undo() : editor.can().redo();
}

/**
 * Executes a history action on the editor.
 *
 * @param editor The TipTap editor instance
 * @param action The history action to execute
 * @returns Whether the action was executed successfully
 */
export function executeHistoryAction(editor, action) {
  if (!editor) return false
  const chain = editor.chain().focus()
  return action === "undo" ? chain.undo().run() : chain.redo().run();
}

/**
 * Determines if a history action should be disabled.
 *
 * @param editor The TipTap editor instance
 * @param action The history action to check
 * @param userDisabled Whether the action is explicitly disabled by the user
 * @returns Whether the action should be disabled
 */
export function isHistoryActionDisabled(editor, action, userDisabled = false) {
  if (userDisabled) return true
  return !canExecuteHistoryAction(editor, action);
}

/**
 * Hook that provides all the necessary state and handlers for a history action.
 *
 * @param editor The TipTap editor instance
 * @param action The history action to handle
 * @param disabled Whether the action is explicitly disabled
 * @returns Object containing state and handlers for the history action
 */
export function useHistoryAction(
  editor,
  action,
  disabled = false
) {
  const canExecute = React.useMemo(() => canExecuteHistoryAction(editor, action), [editor, action])

  const isDisabled = isHistoryActionDisabled(editor, action, disabled)

  const handleAction = React.useCallback(() => {
    if (!editor || isDisabled) return
    executeHistoryAction(editor, action)
  }, [editor, action, isDisabled])

  const Icon = historyIcons[action]
  const actionLabel = historyActionLabels[action]
  const shortcutKey = historyShortcutKeys[action]

  return {
    canExecute,
    isDisabled,
    handleAction,
    Icon,
    actionLabel,
    shortcutKey,
  }
}

/**
 * Button component for triggering undo/redo actions in a TipTap editor.
 */
export const UndoRedoButton = React.forwardRef((
  {
    editor: providedEditor,
    action,
    text,
    className = "",
    disabled,
    onClick,
    children,
    ...buttonProps
  },
  ref
) => {
  const editor = useTiptapEditor(providedEditor)

  const { isDisabled, handleAction, Icon, actionLabel, shortcutKey } =
    useHistoryAction(editor, action, disabled)

  const handleClick = React.useCallback((e) => {
    onClick?.(e)

    if (!e.defaultPrevented && !disabled) {
      handleAction()
    }
  }, [onClick, disabled, handleAction])

  if (!editor || !editor.isEditable) {
    return null
  }

  return (
    <Button
      ref={ref}
      type="button"
      className={className.trim()}
      disabled={isDisabled}
      data-style="ghost"
      data-disabled={isDisabled}
      role="button"
      tabIndex={-1}
      aria-label={actionLabel}
      tooltip={actionLabel}
      shortcutKeys={shortcutKey}
      onClick={handleClick}
      {...buttonProps}>
      {children || (
        <>
          <Icon className="tiptap-button-icon" />
          {text && <span className="tiptap-button-text">{text}</span>}
        </>
      )}
    </Button>
  );
})

UndoRedoButton.displayName = "UndoRedoButton"

export default UndoRedoButton
</file>

<file path="src/hooks/use-cursor-visibility.js">
"use client";
import * as React from "react"
import { useWindowSize } from "@/hooks/use-window-size";

/**
 * Custom hook that ensures the cursor remains visible when typing in a TipTap editor.
 * Automatically scrolls the window when the cursor would be hidden by the toolbar.
 *
 * This is particularly useful for long-form content editing where the cursor
 * might move out of the visible area as the user types.
 *
 * @param options Configuration options for cursor visibility behavior
 * @returns void
 */
export function useCursorVisibility({
  editor,
  overlayHeight = 0,
  elementRef = null
}) {
  const { height: windowHeight } = useWindowSize()
  const [rect, setRect] = React.useState({
    x: 0,
    y: 0,
    width: 0,
    height: 0,
  })

  const updateRect = React.useCallback(() => {
    const element = elementRef?.current ?? document.body

    const { x, y, width, height } = element.getBoundingClientRect()
    setRect({ x, y, width, height })
  }, [elementRef])

  React.useEffect(() => {
    const element = elementRef?.current ?? document.body

    updateRect()

    const resizeObserver = new ResizeObserver(() => {
      window.requestAnimationFrame(updateRect)
    })

    resizeObserver.observe(element)
    window.addEventListener("scroll", updateRect, { passive: true })

    return () => {
      resizeObserver.disconnect()
      window.removeEventListener("scroll", updateRect)
    };
  }, [elementRef, updateRect])

  React.useEffect(() => {
    const ensureCursorVisibility = () => {
      if (!editor) return

      const { state, view } = editor

      if (!view.hasFocus()) return

      // Get current cursor position coordinates
      const { from } = state.selection
      const cursorCoords = view.coordsAtPos(from)

      if (windowHeight < rect.height) {
        if (cursorCoords) {
          // Check if there's enough space between cursor and bottom of window
          const availableSpace =
            windowHeight - cursorCoords.top - overlayHeight > 0

          // If not enough space, scroll to position cursor in the middle of viewport
          if (!availableSpace) {
            const targetScrollY =
              // TODO: Needed?
              //   window.scrollY + (cursorCoords.top - windowHeight / 2)
              cursorCoords.top - windowHeight / 2

            window.scrollTo({
              top: targetScrollY,
              behavior: "smooth",
            })
          }
        }
      }
    }

    ensureCursorVisibility()
  }, [editor, overlayHeight, windowHeight, rect.height])

  return rect
}
</file>

<file path="src/hooks/use-menu-navigation.js">
"use client";
import * as React from "react"

export function useMenuNavigation(
  {
    editor,
    containerRef,
    query,
    items,
    onSelect,
    onClose,
    orientation = "vertical",
    autoSelectFirstItem = true
  }
) {
  const [selectedIndex, setSelectedIndex] = React.useState(autoSelectFirstItem ? 0 : -1)

  React.useEffect(() => {
    const handleKeyboardNavigation = (event) => {
      if (!items.length) return false

      const moveNext = () =>
        setSelectedIndex((currentIndex) => {
          if (currentIndex === -1) return 0
          return (currentIndex + 1) % items.length
        })

      const movePrev = () =>
        setSelectedIndex((currentIndex) => {
          if (currentIndex === -1) return items.length - 1
          return (currentIndex - 1 + items.length) % items.length
        })

      switch (event.key) {
        case "ArrowUp": {
          if (orientation === "horizontal") return false
          event.preventDefault()
          movePrev()
          return true
        }

        case "ArrowDown": {
          if (orientation === "horizontal") return false
          event.preventDefault()
          moveNext()
          return true
        }

        case "ArrowLeft": {
          if (orientation === "vertical") return false
          event.preventDefault()
          movePrev()
          return true
        }

        case "ArrowRight": {
          if (orientation === "vertical") return false
          event.preventDefault()
          moveNext()
          return true
        }

        case "Tab": {
          event.preventDefault()
          if (event.shiftKey) {
            movePrev()
          } else {
            moveNext()
          }
          return true
        }

        case "Home": {
          event.preventDefault()
          setSelectedIndex(0)
          return true
        }

        case "End": {
          event.preventDefault()
          setSelectedIndex(items.length - 1)
          return true
        }

        case "Enter": {
          if (event.isComposing) return false
          event.preventDefault()
          if (selectedIndex !== -1 && items[selectedIndex]) {
            onSelect?.(items[selectedIndex])
          }
          return true
        }

        case "Escape": {
          event.preventDefault()
          onClose?.()
          return true
        }

        default:
          return false
      }
    }

    let targetElement = null

    if (editor) {
      targetElement = editor.view.dom
    } else if (containerRef?.current) {
      targetElement = containerRef.current
    }

    if (targetElement) {
      targetElement.addEventListener("keydown", handleKeyboardNavigation, true)

      return () => {
        targetElement?.removeEventListener("keydown", handleKeyboardNavigation, true)
      };
    }

    return undefined
  }, [
    editor,
    containerRef,
    items,
    selectedIndex,
    onSelect,
    onClose,
    orientation,
  ])

  React.useEffect(() => {
    if (query) {
      setSelectedIndex(autoSelectFirstItem ? 0 : -1)
    }
  }, [query, autoSelectFirstItem])

  return {
    selectedIndex: items.length ? selectedIndex : undefined,
    setSelectedIndex,
  }
}
</file>

<file path="src/hooks/use-mobile.js">
import * as React from "react"

const MOBILE_BREAKPOINT = 768

export function useMobile() {
  const [isMobile, setIsMobile] = React.useState(undefined)

  React.useEffect(() => {
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)
    const onChange = () => {
      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    }
    mql.addEventListener("change", onChange)
    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    return () => mql.removeEventListener("change", onChange);
  }, [])

  return !!isMobile
}
</file>

<file path="src/hooks/use-tiptap-editor.js">
"use client";
import * as React from "react"
import { useCurrentEditor } from "@tiptap/react"

export function useTiptapEditor(providedEditor) {
  const { editor: coreEditor } = useCurrentEditor()
  return React.useMemo(() => providedEditor || coreEditor, [providedEditor, coreEditor]);
}
</file>

<file path="src/hooks/use-window-size.js">
import * as React from "react"

/**
 * Custom hook to track window size and viewport information
 * @returns Current window dimensions and offsetTop
 */
export function useWindowSize() {
  const [windowSize, setWindowSize] = React.useState({
    width: 0,
    height: 0,
    offsetTop: 0,
  })

  React.useEffect(() => {
    handleResize()

    function handleResize() {
      if (typeof window === "undefined") return

      const vp = window.visualViewport
      if (!vp) return

      const { width = 0, height = 0, offsetTop = 0 } = vp

      // Only update state if values have changed
      setWindowSize((state) => {
        if (
          width === state.width &&
          height === state.height &&
          offsetTop === state.offsetTop
        ) {
          return state
        }

        return { width, height, offsetTop }
      })
    }

    const visualViewport = window.visualViewport
    if (visualViewport) {
      visualViewport.addEventListener("resize", handleResize)
      visualViewport.addEventListener("scroll", handleResize)
    }

    return () => {
      if (visualViewport) {
        visualViewport.removeEventListener("resize", handleResize)
        visualViewport.removeEventListener("scroll", handleResize)
      }
    };
  }, [])

  return windowSize
}
</file>

<file path="src/lib/tiptap-utils.js">
export const MAX_FILE_SIZE = 5 * 1024 * 1024 // 5MB

/**
 * Checks if a mark exists in the editor schema
 * @param markName - The name of the mark to check
 * @param editor - The editor instance
 * @returns boolean indicating if the mark exists in the schema
 */
export const isMarkInSchema = (markName, editor) => {
  if (!editor?.schema) return false
  return editor.schema.spec.marks.get(markName) !== undefined;
}

/**
 * Checks if a node exists in the editor schema
 * @param nodeName - The name of the node to check
 * @param editor - The editor instance
 * @returns boolean indicating if the node exists in the schema
 */
export const isNodeInSchema = (nodeName, editor) => {
  if (!editor?.schema) return false
  return editor.schema.spec.nodes.get(nodeName) !== undefined;
}

/**
 * Gets the active attributes of a specific mark in the current editor selection.
 *
 * @param editor - The Tiptap editor instance.
 * @param markName - The name of the mark to look for (e.g., "highlight", "link").
 * @returns The attributes of the active mark, or `null` if the mark is not active.
 */
export function getActiveMarkAttrs(editor, markName) {
  if (!editor) return null
  const { state } = editor
  const marks = state.storedMarks || state.selection.$from.marks()
  const mark = marks.find((mark) => mark.type.name === markName)

  return mark?.attrs ?? null
}

/**
 * Checks if a node is empty
 */
export function isEmptyNode(node) {
  return !!node && node.content.size === 0
}

/**
 * Utility function to conditionally join class names into a single string.
 * Filters out falsey values like false, undefined, null, and empty strings.
 *
 * @param classes - List of class name strings or falsey values.
 * @returns A single space-separated string of valid class names.
 */
export function cn(...classes) {
  return classes.filter(Boolean).join(" ");
}

/**
 * Finds the position and instance of a node in the document
 * @param props Object containing editor, node (optional), and nodePos (optional)
 * @param props.editor The TipTap editor instance
 * @param props.node The node to find (optional if nodePos is provided)
 * @param props.nodePos The position of the node to find (optional if node is provided)
 * @returns An object with the position and node, or null if not found
 */
export function findNodePosition(props) {
  const { editor, node, nodePos } = props

  if (!editor || !editor.state?.doc) return null

  // Zero is valid position
  const hasValidNode = node !== undefined && node !== null
  const hasValidPos = nodePos !== undefined && nodePos !== null

  if (!hasValidNode && !hasValidPos) {
    return null
  }

  if (hasValidPos) {
    try {
      const nodeAtPos = editor.state.doc.nodeAt(nodePos)
      if (nodeAtPos) {
        return { pos: nodePos, node: nodeAtPos };
      }
    } catch (error) {
      console.error("Error checking node at position:", error)
      return null
    }
  }

  // Otherwise search for the node in the document
  let foundPos = -1
  let foundNode = null

  editor.state.doc.descendants((currentNode, pos) => {
    // TODO: Needed?
    // if (currentNode.type && currentNode.type.name === node!.type.name) {
    if (currentNode === node) {
      foundPos = pos
      foundNode = currentNode
      return false
    }
    return true
  })

  return foundPos !== -1 && foundNode !== null
    ? { pos: foundPos, node: foundNode }
    : null
}

/**
 * Handles image upload with progress tracking and abort capability
 * @param file The file to upload
 * @param onProgress Optional callback for tracking upload progress
 * @param abortSignal Optional AbortSignal for cancelling the upload
 * @returns Promise resolving to the URL of the uploaded image
 */
export const handleImageUpload = async (file, onProgress, abortSignal) => {
  // Validate file
  if (!file) {
    throw new Error("No file provided")
  }

  if (file.size > MAX_FILE_SIZE) {
    throw new Error(`File size exceeds maximum allowed (${MAX_FILE_SIZE / (1024 * 1024)}MB)`)
  }

  // For demo/testing: Simulate upload progress
  for (let progress = 0; progress <= 100; progress += 10) {
    if (abortSignal?.aborted) {
      throw new Error("Upload cancelled")
    }
    await new Promise((resolve) => setTimeout(resolve, 500))
    onProgress?.({ progress })
  }

  return "/images/placeholder-image.png"

  // Uncomment for production use:
  // return convertFileToBase64(file, abortSignal);
}

/**
 * Converts a File to base64 string
 * @param file The file to convert
 * @param abortSignal Optional AbortSignal for cancelling the conversion
 * @returns Promise resolving to the base64 representation of the file
 */
export const convertFileToBase64 = (file, abortSignal) => {
  if (!file) {
    return Promise.reject(new Error("No file provided"));
  }

  return new Promise((resolve, reject) => {
    const reader = new FileReader()

    const abortHandler = () => {
      reader.abort()
      reject(new Error("Upload cancelled"))
    }

    if (abortSignal) {
      abortSignal.addEventListener("abort", abortHandler)
    }

    reader.onloadend = () => {
      if (abortSignal) {
        abortSignal.removeEventListener("abort", abortHandler)
      }

      if (typeof reader.result === "string") {
        resolve(reader.result)
      } else {
        reject(new Error("Failed to convert File to base64"))
      }
    }

    reader.onerror = (error) =>
      reject(new Error(`File reading error: ${error}`))
    reader.readAsDataURL(file)
  });
}
</file>

<file path="src/main.jsx">
import React from 'react';
import ReactDOM from 'react-dom/client';
import { BrowserRouter } from 'react-router-dom';
import { AuthProvider } from './auth/AuthContext';
import AppRoutes from './routes/AppRoutes';
import './index.css';

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
     <BrowserRouter>
      <AuthProvider>
        <AppRoutes />
      </AuthProvider>
    </BrowserRouter>
  </React.StrictMode>
);
</file>

<file path="src/pages/customer inquiry/Customer.jsx">
import api from "@/api";
import React, { useState, useEffect, useRef } from "react";
import Swal from "sweetalert2"; // Import SweetAlert2
import { Country, State, City } from "country-state-city";
import {
  Document,
  Page,
  Text,
  View as PDFView,
  StyleSheet,
  PDFDownloadLink,
  Image as PDFImage,
} from "@react-pdf/renderer";

// PDF Styles (pixel-perfect, Tailwind-inspired)
const pdfStyles = StyleSheet.create({
  page: {
    flexDirection: "column",
    backgroundColor: "#fff",
    padding: 16, // reduce padding for more content
    minHeight: "100vh",
    borderRadius: 16, // matches rounded-2xl
    fontFamily: "Helvetica",
    fontSize: 10, // base font size smaller
    maxHeight: 842, // A4 height in pt
    maxWidth: 595, // A4 width in pt
  },
  headerSection: {
    flexDirection: "row",
    marginBottom: 16, // reduce spacing
    alignItems: "flex-start",
    justifyContent: "space-between",
  },
  logo: {
    width: 64, // smaller logo
    height: 64,
    borderRadius: 9999,
    marginRight: 12, // tighter spacing
    objectFit: "cover",
  },
  companyInfo: {
    flexDirection: "column",
    flexGrow: 1,
  },
  companyName: {
    fontSize: 20, // smaller title
    fontWeight: "bold",
    color: "#2798FF", // text-[rgb(39,152,255)]
    marginBottom: 2,
  },
  address: {
    fontSize: 9,
    color: "#1F2937", // text-[rgb(31,41,55)]
    marginBottom: 1,
  },
  contactRow: {
    flexDirection: "row",
    gap: 8,
    marginBottom: 1,
  },
  contact: {
    fontSize: 9,
    color: "#1F2937",
    marginRight: 8,
  },
  invoiceTitle: {
    fontSize: 20,
    fontWeight: "bold",
    color: "#2798FF",
    textAlign: "right",
  },
  divider: {
    width: "100%",
    height: 1, // thinner divider
    backgroundColor: "#2798FF",
    marginVertical: 6,
  },
  detailsRow: {
    flexDirection: "row",
    justifyContent: "space-between",
    fontSize: 9,
    color: "#4B5563",
    marginBottom: 8,
  },
  sectionTitle: {
    fontWeight: "bold",
    fontSize: 12,
    color: "#4B5563",
    marginBottom: 4,
  },
  partyBlock: {
    flex: 1,
    paddingRight: 8, // tighter
    paddingLeft: 0,
  },
  partyBlockRight: {
    flex: 1,
    paddingLeft: 8,
    paddingRight: 0,
  },
  partyLabel: {
    fontWeight: "bold",
    fontSize: 12,
    color: "#4B5563",
    marginBottom: 4,
  },
  partyField: {
    fontSize: 10,
    color: "#1F2837",
    fontWeight: "600",
    marginBottom: 1,
  },
  partyAddress: {
    fontSize: 9,
    color: "#545454",
    marginBottom: 1,
  },
  partyContact: {
    fontSize: 9,
    color: "#545454",
    marginBottom: 1,
  },
  table: {
    width: "100%",
    marginTop: 0,
    borderWidth: 1,
    borderColor: "#E5E7EB",
    borderRadius: 8,
    overflow: "hidden",
    marginBottom: 12,
  },
  tableHeader: {
    flexDirection: "row",
    backgroundColor: "#E7EFF8",
    color: "#4B5563",
    fontWeight: "bold",
    fontSize: 10,
  },
  th: {
    padding: 4,
    borderRightWidth: 1,
    borderColor: "#E5E7EB",
    textAlign: "center",
    fontWeight: "500",
    fontSize: 9,
    // Remove any top/bottom border
    borderTopWidth: 0,
    borderBottomWidth: 0,
  },
  thDesc: { width: "50%", textAlign: "left" },
  thQty: { width: "10%", textAlign: "center" },
  thRate: { width: "16.6%", textAlign: "right" },
  thGst: { width: "10%", textAlign: "center" },
  thAmt: { width: "13.4%", textAlign: "right" },
  td: {
    padding: 4,
    borderRightWidth: 1,
    borderColor: "#E5E7EB",
    fontSize: 9,
    color: "#545454",
    textAlign: "center",
    // Remove any top/bottom border
    borderTopWidth: 0,
    borderBottomWidth: 0,
  },
  tdDesc: { width: "50%", textAlign: "left" },
  tdQty: { width: "10%", textAlign: "center" },
  tdRate: { width: "16.6%", textAlign: "right" },
  tdGst: { width: "10%", textAlign: "center" },
  tdAmt: { width: "13.4%", textAlign: "right" },
  tableRow: {
    flexDirection: "row",
    // Remove bottom border
    borderBottomWidth: 0,
    borderColor: "#E5E7EB",
    flexGrow: 1, // Make each row grow to fill available vertical space
  },
  totalsBlock: {
    marginTop: 0,
    alignItems: "flex-end",
    flexDirection: "column",
    gap: 2,
  },
  totalRow: {
    flexDirection: "row",
    justifyContent: "flex-end",
    gap: 8,
    fontSize: 9,
    color: "#1F2837",
  },
  totalLabel: { fontWeight: "bold" },
  totalValue: { fontWeight: "bold" },
  bankBlock: {
    marginTop: 0,
    fontSize: 9,
    color: "#4B5563",
    width: "50%",
    paddingRight: 8,
  },
  bankBlockRight: {
    marginTop: 0,
    fontSize: 9,
    color: "#4B5563",
    width: "50%",
    textAlign: "right",
    paddingLeft: 8,
  },
  termsBlock: {
    marginTop: 0,
    fontSize: 8,
    color: "#4B5563",
    width: "50%",
    paddingRight: 8,
  },
  signBlock: {
    width: "50%",
    textAlign: "center",
    paddingLeft: 8,
  },
  seal: {
    width: 48,
    height: 48,
    margin: "0 auto 4px auto",
    objectFit: "contain",
  },
  signatory: {
    fontWeight: "bold",
    fontSize: 9,
    color: "#1F2837",
    textAlign: "center",
    marginTop: 4,
  },
  tableBody: {
    // New style for the table body container
    flexGrow: 1,
    flexDirection: "column",
  },
});

const InvoicePDF = ({ invoiceData, serviceItems, organizationEmail, user }) => (
  <Document>
    <Page size="A4" style={pdfStyles.page}>
      {/* Header */}
      <PDFView style={pdfStyles.headerSection}>
        <PDFView style={{ flexDirection: "row", alignItems: "center" }}>
          {user?.profile_pic && (
            <PDFImage src={user.profile_pic} style={pdfStyles.logo} />
          )}
          <PDFView style={pdfStyles.companyInfo}>
            <Text style={pdfStyles.companyName}>{invoiceData.companyName}</Text>
            {/* Address block: match view mode */}
            {invoiceData.addressLine1 && (
              <Text style={pdfStyles.address}>{invoiceData.addressLine1}</Text>
            )}
            {invoiceData.addressLine2 && (
              <Text style={pdfStyles.address}>{invoiceData.addressLine2}</Text>
            )}
            <PDFView style={pdfStyles.contactRow}>
              {organizationEmail && (
                <Text style={pdfStyles.contact}>
                  Email: {organizationEmail}
                </Text>
              )}
              <Text style={pdfStyles.contact}>
                Mobile: {invoiceData.mobile}
              </Text>
            </PDFView>
          </PDFView>
        </PDFView>
        <Text style={pdfStyles.invoiceTitle}>INVOICE</Text>
      </PDFView>
      <PDFView style={pdfStyles.divider} />
      {/* Invoice Details */}
      <PDFView style={pdfStyles.detailsRow}>
        <Text>Invoice No.: {invoiceData.invoiceNo}</Text>
        <Text>Invoice Date: {invoiceData.invoiceDate}</Text>
      </PDFView>
      <PDFView style={pdfStyles.divider} />
      {/* Bill To / Ship To */}
      <PDFView
        style={{
          flexDirection: "row",
          justifyContent: "space-between",
          marginBottom: 32, // mb-8
        }}
      >
        {/* Bill To */}
        <PDFView style={pdfStyles.partyBlock}>
          <Text style={pdfStyles.partyLabel}>BILL TO</Text>
          <Text style={pdfStyles.partyField}>{invoiceData.billToName}</Text>
          {invoiceData.billToAddress?.blockUnitStreetName && (
            <Text style={pdfStyles.partyAddress}>
              {invoiceData.billToAddress.blockUnitStreetName}
            </Text>
          )}
          {(invoiceData.billToAddress?.state ||
            invoiceData.billToAddress?.city) && (
            <Text style={pdfStyles.partyAddress}>
              {invoiceData.billToAddress?.state}
              {invoiceData.billToAddress?.state &&
              invoiceData.billToAddress?.city
                ? ", "
                : ""}
              {invoiceData.billToAddress?.city}
            </Text>
          )}
          {(invoiceData.billToAddress?.pincode ||
            invoiceData.billToAddress?.country) && (
            <Text style={pdfStyles.partyAddress}>
              {invoiceData.billToAddress?.pincode}
              {invoiceData.billToAddress?.pincode &&
              invoiceData.billToAddress?.country
                ? ", "
                : ""}
              {invoiceData.billToAddress?.country}
            </Text>
          )}
          {invoiceData.billToEmail && (
            <Text style={pdfStyles.partyContact}>
              Email: {invoiceData.billToEmail}
            </Text>
          )}
          {invoiceData.billToPhone && (
            <Text style={pdfStyles.partyContact}>
              Mobile: {invoiceData.billToPhone}
            </Text>
          )}
          {invoiceData.billToAddress?.gstin && (
            <Text style={pdfStyles.partyContact}>
              GSTIN: {invoiceData.billToAddress.gstin}
            </Text>
          )}
        </PDFView>
        {/* Ship To */}
        <PDFView style={pdfStyles.partyBlockRight}>
          <Text style={pdfStyles.partyLabel}>SHIP TO</Text>
          <Text style={pdfStyles.partyField}>{invoiceData.shipToName}</Text>
          {invoiceData.shipToAddress?.blockUnitStreetName && (
            <Text style={pdfStyles.partyAddress}>
              {invoiceData.shipToAddress.blockUnitStreetName}
            </Text>
          )}
          {(invoiceData.shipToAddress?.state ||
            invoiceData.shipToAddress?.city) && (
            <Text style={pdfStyles.partyAddress}>
              {invoiceData.shipToAddress?.state}
              {invoiceData.shipToAddress?.state &&
              invoiceData.shipToAddress?.city
                ? ", "
                : ""}
              {invoiceData.shipToAddress?.city}
            </Text>
          )}
          {(invoiceData.shipToAddress?.pincode ||
            invoiceData.shipToAddress?.country) && (
            <Text style={pdfStyles.partyAddress}>
              {invoiceData.shipToAddress?.pincode}
              {invoiceData.shipToAddress?.pincode &&
              invoiceData.shipToAddress?.country
                ? ", "
                : ""}
              {invoiceData.shipToAddress?.country}
            </Text>
          )}
          {invoiceData.shipToEmail && (
            <Text style={pdfStyles.partyContact}>
              Email: {invoiceData.shipToEmail}
            </Text>
          )}
          {invoiceData.shipToPhone && (
            <Text style={pdfStyles.partyContact}>
              Mobile: {invoiceData.shipToPhone}
            </Text>
          )}
          {invoiceData.shipToAddress?.gstin && (
            <Text style={pdfStyles.partyContact}>
              GSTIN: {invoiceData.shipToAddress.gstin}
            </Text>
          )}
        </PDFView>
      </PDFView>
      {/* Items Table - EXTENDED */}
      <PDFView
        style={{
          ...pdfStyles.table,
          minHeight: 320,
          flexGrow: 1,
          marginBottom: 24,
        }}
      >
        <PDFView style={pdfStyles.tableHeader}>
          <Text style={[pdfStyles.th, pdfStyles.thDesc]}>ITEMS</Text>
          <Text style={[pdfStyles.th, pdfStyles.thQty]}>QTY</Text>
          <Text style={[pdfStyles.th, pdfStyles.thRate]}>RATE</Text>
          <Text style={[pdfStyles.th, pdfStyles.thGst]}>GST</Text>
          <Text style={[pdfStyles.th, pdfStyles.thAmt]}>AMOUNT</Text>
        </PDFView>
        <PDFView style={pdfStyles.tableBody}>
          {" "}
          {/* Wrap rows in a new flex container */}
          {serviceItems.map((item, idx) => (
            <PDFView style={pdfStyles.tableRow} key={idx}>
              <Text style={[pdfStyles.td, pdfStyles.tdDesc]}>
                {item.description}
              </Text>
              <Text style={[pdfStyles.td, pdfStyles.tdQty]}>
                {item.quantity}
              </Text>
              <Text style={[pdfStyles.td, pdfStyles.tdRate]}>{item.rate}</Text>
              <Text style={[pdfStyles.td, pdfStyles.tdGst]}>
                {item.taxRate}
              </Text>
              <Text style={[pdfStyles.td, pdfStyles.tdAmt]}>{item.amount}</Text>
            </PDFView>
          ))}
          {/* Add empty rows to visually extend the table if there are few items */}
          {Array.from({ length: Math.max(0, 8 - serviceItems.length) }).map(
            (_, idx) => (
              <PDFView style={pdfStyles.tableRow} key={`empty-${idx}`}>
                <Text style={[pdfStyles.td, pdfStyles.tdDesc]}> </Text>
                <Text style={[pdfStyles.td, pdfStyles.tdQty]}> </Text>
                <Text style={[pdfStyles.td, pdfStyles.tdRate]}> </Text>
                <Text style={[pdfStyles.td, pdfStyles.tdGst]}> </Text>
                <Text style={[pdfStyles.td, pdfStyles.tdAmt]}> </Text>
              </PDFView>
            )
          )}
          {/* Subtotal and GST rows */}
          <PDFView style={pdfStyles.tableRow}>
            <Text
              style={{
                ...pdfStyles.td,
                textAlign: "right",
                fontWeight: "bold",
                width: "100%",
                paddingRight: 0,
                paddingLeft: 0,
                marginRight: 4, // right margin-1
              }}
              colSpan={4}
            >
              SUB TOTAL
            </Text>
            <Text
              style={{
                ...pdfStyles.td,
                ...pdfStyles.tdAmt,
                fontWeight: "bold",
                textAlign: "right",

              }}
            >
              {serviceItems.reduce(
                (sum, item) => sum + item.amount - item.taxAmount,
                0
              )}
            </Text>
          </PDFView>
          <PDFView style={pdfStyles.tableRow}>
            <Text
              style={{
                ...pdfStyles.td,
                textAlign: "right",
                fontSize: 8, // smaller text
                width: "100%",
                paddingRight: 0,
                paddingLeft: 0,
                marginRight: 4, // right margin-1

              }}
              colSpan={4}
            >
              CGST AMOUNT
            </Text>
            <Text
              style={{
                ...pdfStyles.td,
                ...pdfStyles.tdAmt,
                textAlign: "right",

              }}
            >
              {serviceItems.reduce(
                (sum, item) => sum + (item.cgstAmount || 0),
                0
              )}
            </Text>
          </PDFView>
          <PDFView style={pdfStyles.tableRow}>
            <Text
              style={{
                ...pdfStyles.td,
                textAlign: "right",
                fontSize: 8, // smaller text
                width: "100%",
                paddingRight: 0,
                paddingLeft: 0,
                marginRight: 4, // right margin-1

              }}
              colSpan={4}
            >
              SGST AMOUNT
            </Text>
            <Text
              style={{
                ...pdfStyles.td,
                ...pdfStyles.tdAmt,
                textAlign: "right",

              }}
            >
              {serviceItems.reduce(
                (sum, item) => sum + (item.sgstAmount || 0),
                0
              )}
            </Text>
          </PDFView>
          <PDFView style={pdfStyles.tableRow}>
            <Text
              style={{
                ...pdfStyles.td,
                textAlign: "right",
                fontSize: 8, // smaller text
                width: "100%",
                paddingRight: 0,
                paddingLeft: 0,
                marginRight: 4, // right margin-1

              }}
              colSpan={4}
            >
              IGST AMOUNT
            </Text>
            <Text
              style={{
                ...pdfStyles.td,
                ...pdfStyles.tdAmt,
                textAlign: "right",

              }}
            >
              {serviceItems.reduce(
                (sum, item) => sum + (item.igstAmount || 0),
                0
              )}
            </Text>
          </PDFView>
        </PDFView>{" "}
        {/* End of new flex container */}
      </PDFView>
      {/* Bank Details and Totals */}
      <PDFView
        style={{
          flexDirection: "row",
          justifyContent: "space-between",
          marginBottom: 32,
        }}
      >
        <PDFView style={pdfStyles.bankBlock}>
          {/* Bank details with clear separation */}
          <PDFView style={{ flexDirection: "row", marginBottom: 2 }}>
            <Text style={{ fontWeight: "bold", width: 80 }}>Bank Name:</Text>
            <Text style={{ color: "#545454" }}>{invoiceData.bankName}</Text>
          </PDFView>
          <PDFView style={{ flexDirection: "row", marginBottom: 2 }}>
            <Text style={{ fontWeight: "bold", width: 80 }}>Account Name:</Text>
            <Text style={{ color: "#545454" }}>{invoiceData.accountName}</Text>
          </PDFView>
          <PDFView style={{ flexDirection: "row", marginBottom: 2 }}>
            <Text style={{ fontWeight: "bold", width: 80 }}>IFSC Code:</Text>
            <Text style={{ color: "#545454" }}>{invoiceData.ifscCode}</Text>
          </PDFView>
          <PDFView style={{ flexDirection: "row", marginBottom: 2 }}>
            <Text style={{ fontWeight: "bold", width: 80 }}>Account No:</Text>
            <Text style={{ color: "#545454" }}>{invoiceData.accountNo}</Text>
          </PDFView>
          <PDFView style={{ flexDirection: "row", marginBottom: 2 }}>
            <Text style={{ fontWeight: "bold", width: 80 }}>Bank Branch:</Text>
            <Text style={{ color: "#545454" }}>{invoiceData.bankBranch}</Text>
          </PDFView>
        </PDFView>
        <PDFView style={pdfStyles.bankBlockRight}>
          <PDFView
            style={{
              flexDirection: "row",
              justifyContent: "flex-end",
              alignItems: "center",
              marginBottom: 8,
            }}
          >
            <Text
              style={{ fontWeight: "bold", marginRight: 16, color: "#1F2837" }}
            >
              GRAND TOTAL
            </Text>
            <Text
              style={{
                borderBottomWidth: 1,
                borderColor: "#E5E7EB",
                fontWeight: "bold",
                width: 64,
                textAlign: "right",
                color: "#1F2837",
              }}
            >
              {serviceItems.reduce((sum, item) => sum + (item.amount || 0), 0)}
            </Text>
          </PDFView>
          <PDFView
            style={{
              flexDirection: "row",
              justifyContent: "flex-end",
              alignItems: "center",
              marginBottom: 8,
            }}
          >
            <Text
              style={{ fontWeight: "bold", marginRight: 16, color: "#1F2837" }}
            >
              Received Amount
            </Text>
            <Text
              style={{
                borderBottomWidth: 1,
                borderColor: "#E5E7EB",
                width: 64,
                textAlign: "right",
                color: "#545454",
              }}
            >
              {invoiceData.receivedAmount || 0}
            </Text>
          </PDFView>
          <PDFView
            style={{
              flexDirection: "row",
              justifyContent: "flex-end",
              alignItems: "center",
            }}
          >
            <Text
              style={{ fontWeight: "bold", marginRight: 16, color: "#1F2837" }}
            >
              Balance
            </Text>
            <Text
              style={{
                borderBottomWidth: 1,
                borderColor: "#E5E7EB",
                width: 64,
                textAlign: "right",
                color: "#545454",
              }}
            >
              {serviceItems.reduce((sum, item) => sum + (item.amount || 0), 0) -
                (invoiceData.receivedAmount || 0)}
            </Text>
          </PDFView>
        </PDFView>
      </PDFView>
      {/* Move Terms and Conditions and Signature to the very bottom */}
      <PDFView
        style={{
          flexDirection: "row",
          justifyContent: "space-between",
          alignItems: "flex-end",
          marginTop: 24,
        }}
      >
        <PDFView style={pdfStyles.termsBlock}>
          <Text style={{ fontWeight: "bold", marginBottom: 8, fontSize: 12 }}>
            TERMS AND CONDITIONS:
          </Text>
          <PDFView>
            {invoiceData.termsAndConditions?.map((term, idx) => (
              <Text key={idx} style={{ marginBottom: 2 }}>{`${
                idx + 1
              }. ${term}`}</Text>
            ))}
          </PDFView>
        </PDFView>
        <PDFView style={pdfStyles.signBlock}>
          {invoiceData.upload_seal && (
            <PDFImage src={invoiceData.upload_seal} style={pdfStyles.seal} />
          )}
          <Text style={pdfStyles.signatory}>AUTHORISED SIGNATORY FOR</Text>
          <Text style={{ color: "#545454", fontSize: 12, textAlign: "center" }}>
            {invoiceData.authorisedSignatory}
          </Text>
        </PDFView>
      </PDFView>
    </Page>
  </Document>
);

const invoiceComponent = () => {
  const [isEditMode, setIsEditMode] = useState(false);
  const [organizationEmail, setOrganizationEmail] = useState(""); // New state for organization email
  const [receivedAmount, setReceivedAmount] = useState(0); // New state for received amount

  const [invoiceData, setInvoiceData] = useState({
    companyName: "Company Name",
    addressLine1: "3rd Floor, The View Building, Yeshwant Niwas Rd,",
    addressLine2: "Nehru Park, Lad Colony, Indore, Madhya Pradesh 452001",
    mobile: "9630109451",
    companyState: "Madhya Pradesh", // Added for GST compliance
    invoiceNo: "869",
    invoiceDate: new Date().toISOString().slice(0, 10),
    billToName: "Priya Sharma",
    billToPhone: "+91 98765 43210",
    billToEmail: "priya.sharma@example.com", // Changed dummy Bill To email
    billToState: "Madhya Pradesh", // Added for GST compliance
    billToAddress: {
      blockUnitStreetName: "Sunshine Apartments, 2nd Floor",
      city: "Indore",
      state: "Madhya Pradesh",
      pincode: "452001",
      country: "India",
      gstin: "22AAAAA0000A1Z5",
    },
    shipToName: "Rajesh Kumar",
    shipToPhone: "+91 91234 56789",
    shipToEmail: "rajesh.kumar@example.com", // Changed dummy Ship To email
    shipToState: "Madhya Pradesh",
    shipToAddress: {
      blockUnitStreetName: "Green Park Villas, Block B",
      city: "Bhopal",
      state: "Madhya Pradesh",
      pincode: "462001",
      country: "India",
      gstin: "23BBBBB1111B2Z6",
    },
    bankName: "HDFC BANK",
    accountName: "ARCHDESIGN WORLD",
    ifscCode: "HDFC0006170",
    accountNo: "50200096797196",
    bankBranch: "ANAJ MANDI INDORE MP",
    termsAndConditions: [
      "Clients may request unlimited changes before drawings are finalized and approved. Once work has proceeded past this stage, any further drawing changes will incur additional costs.",
      "A refund policy is not available.",
      "The plot size and dimensions used in the drawings are based solely on the measurements provided by the client. If any discrepancy is discovered after the drawings are complete, the company will not be held responsible.",
    ],
    authorisedSignatory: "Archdesignworld",
    upload_seal: "",
  });

  const [serviceItems, setServiceItems] = useState([
    {
      description: "Complete set",
      quantity: 1,
      rate: 25000,
      taxRate: 18, // Default GST rate (total GST)
      amount: 25000, // This will be updated to include tax
      taxAmount: 0, // Total GST amount for the item
      cgstAmount: 0, // CGST amount for the item
      sgstAmount: 0, // SGST amount for the item
      igstAmount: 0, // IGST amount for the item
    },
  ]);

  // State for manually edited amounts and totals
  const [editedServiceItemAmounts, setEditedServiceItemAmounts] = useState({});
  const [editedSubTotal, setEditedSubTotal] = useState(null);
  const [editedCgstTotal, setEditedCgstTotal] = useState(null);
  const [editedSgstTotal, setEditedSgstTotal] = useState(null);
  const [editedIgstTotal, setEditedIgstTotal] = useState(null);

  const [editedGrandTotal, setEditedGrandTotal] = useState(null);
  const [editedBalance, setEditedBalance] = useState(null);

  // States for manually edited GST labels and percentages
  const [editedCgstLabel, setEditedCgstLabel] = useState(null);
  const [editedSgstLabel, setEditedSgstLabel] = useState(null);
  const [editedIgstLabel, setEditedIgstLabel] = useState(null);
  const [editedCgstPercentage, setEditedCgstPercentage] = useState(null);
  const [editedSgstPercentage, setEditedSgstPercentage] = useState(null);
  const [editedIgstPercentage, setEditedIgstPercentage] = useState(null);

  // Dummy user object to simulate user context data
  const [user, setUser] = useState({
    profile_pic: "src/assets/dummyavatar.jpeg", // Placeholder image path
    phoneno: "+91 9876543210",
    email: "priya@email.com",
    address: "Indore",
  });

  // To store the original state for discarding changes
  const [originalInvoiceData, setOriginalInvoiceData] = useState(invoiceData);
  const [originalServiceItems, setOriginalServiceItems] =
    useState(serviceItems);

  // Address form state for Bill To
  const [formData, setFormData] = useState({
    blockUnitStreetName: "",
    state: "",
    city: "",
    pincode: "",
    country: "",
    gstin: "",
  });
  const [gstinError, setGstinError] = useState("");
  const [countryDropdownOpen, setCountryDropdownOpen] = useState(false);
  const [stateDropdownOpen, setStateDropdownOpen] = useState(false);
  const [cityDropdownOpen, setCityDropdownOpen] = useState(false);
  const [countrySearchTerm, setCountrySearchTerm] = useState("");
  const [stateSearchTerm, setStateSearchTerm] = useState("");
  const [citySearchTerm, setCitySearchTerm] = useState("");
  const [filteredCountries, setFilteredCountries] = useState(
    Country.getAllCountries()
  );
  const [filteredStates, setFilteredStates] = useState([]);
  const [filteredCities, setFilteredCities] = useState([]);
  const [selectedCountryObj, setSelectedCountryObj] = useState(null);
  const [selectedStateObj, setSelectedStateObj] = useState(null);
  const countryDropdownRef = useRef(null);
  const stateDropdownRef = useRef(null);
  const cityDropdownRef = useRef(null);

  const [leadDropdownOpen, setLeadDropdownOpen] = useState(false);
  const [leadSearchTerm, setLeadSearchTerm] = useState("");
  const [leads, setLeads] = useState([]);
  const [leadsLoading, setLeadsLoading] = useState(false);
  const leadDropdownRef = useRef(null);

  // Ship To state (mirrors Bill To)
  const [shipToFormData, setShipToFormData] = useState({
    blockUnitStreetName: "",
    state: "",
    city: "",
    pincode: "",
    country: "",
    gstin: "",
  });
  const [shipToGstinError, setShipToGstinError] = useState("");
  const [shipToLeadDropdownOpen, setShipToLeadDropdownOpen] = useState(false);
  const [shipToLeadSearchTerm, setShipToLeadSearchTerm] = useState("");
  const shipToDropdownRef = useRef(null);
  const [shipToCountryDropdownOpen, setShipToCountryDropdownOpen] =
    useState(false);
  const [shipToStateDropdownOpen, setShipToStateDropdownOpen] = useState(false);
  const [shipToCityDropdownOpen, setShipToCityDropdownOpen] = useState(false);
  const [shipToCountrySearchTerm, setShipToCountrySearchTerm] = useState("");
  const [shipToStateSearchTerm, setShipToStateSearchTerm] = useState("");
  const [shipToCitySearchTerm, setShipToCitySearchTerm] = useState("");
  const [shipToFilteredCountries, setShipToFilteredCountries] = useState(
    Country.getAllCountries()
  );
  const [shipToFilteredStates, setShipToFilteredStates] = useState([]);
  const [shipToFilteredCities, setShipToFilteredCities] = useState([]);
  const [shipToSelectedCountryObj, setShipToSelectedCountryObj] =
    useState(null);
  const [shipToSelectedStateObj, setShipToSelectedStateObj] = useState(null);
  const shipToCountryDropdownRef = useRef(null);
  const shipToStateDropdownRef = useRef(null);
  const shipToCityDropdownRef = useRef(null);

  // Function to auto-resize textarea
  const autoResizeTextarea = (eOrElement) => {
    const element = eOrElement.target || eOrElement;
    if (element) {
      element.style.height = "auto";
      element.style.height = element.scrollHeight + "px";
    }
  };

  useEffect(() => {
    const fetchOrganizationData = async () => {
      try {
        const data = await api.get("/orglist"); // Directly get data
        console.log("this is API Response: fetch", data);
        if (data.data.success && data.data.result) {
          let orgData = null;
          if (Array.isArray(data.data.result)) {
            orgData = data.data.result[0];
          } else if (typeof data.data.result === "object") {
            orgData = Object.values(data.data.result)[0];
          }
          if (orgData) {
            console.log("Organization data here");
            const addressLines = orgData.address
              ? orgData.address.split("\n")
              : ["", ""];
            // Extract state as the part after the last comma in the second line
            let parsedState = "";
            if (addressLines.length > 1) {
              // Extract state as the part after the last comma in the second line
              const stateMatch = addressLines[1].match(/,([^,]+)$/);
              if (stateMatch && stateMatch[1]) {
                parsedState = stateMatch[1].trim();
              } else {
                // fallback: if no comma, use the whole line
                parsedState = addressLines[1].trim();
              }
            }
            setInvoiceData((prev) => ({
              ...prev,
              companyName: orgData.organizationname || prev.companyName,
              addressLine1: addressLines[0] || prev.addressLine1,
              addressLine2:
                addressLines.slice(1).join("\n") || prev.addressLine2,
              mobile: orgData.phone || prev.mobile,
              companyState: parsedState || prev.companyState, // Use parsed state
              authorisedSignatory:
                orgData.organizationname || prev.authorisedSignatory,
              upload_seal: orgData.upload_seal || "",
            }));
            setOrganizationEmail(orgData.email || "");
            setUser((prev) => ({
              ...prev,
              profile_pic: orgData.profile_image || prev.profile_pic,
            }));
          }
        } else if (!data.data.success) {
          // Handle API success: false case
          console.error("API returned success: false", data.data.message);
          Swal.fire({
            icon: "error",
            title: "Error!",
            text: data.data.message || "Failed to load organization data.",
            confirmButtonColor: "#3085d6",
          });
        }
      } catch (error) {
        console.error("Error fetching organization data:", error);
        Swal.fire({
          icon: "error",
          title: "Error!",
          text: "Failed to load organization data.",
          confirmButtonColor: "#3085d6",
        });
      }
    };

    fetchOrganizationData();

    // Set default country to India for Bill To and Ship To
    const india = Country.getAllCountries().find(
      (country) => country.name === "India"
    );
    if (india) {
      setFormData((prev) => ({ ...prev, country: india.name }));
      setSelectedCountryObj(india);
      setFilteredStates(State.getStatesOfCountry(india.isoCode));

      setShipToFormData((prev) => ({ ...prev, country: india.name }));
      setShipToSelectedCountryObj(india);
      setShipToFilteredStates(State.getStatesOfCountry(india.isoCode));
    }
  }, []); // Run once on component mount

  // Effect to resize textareas when entering edit mode or terms change
  useEffect(() => {
    if (isEditMode) {
      const textareas = document.querySelectorAll(".terms-textarea");
      textareas.forEach((textarea) => {
        autoResizeTextarea(textarea);
      });
    }
  }, [isEditMode, invoiceData.termsAndConditions]);

  // Effect to recalculate GST when companyState or billToState changes
  useEffect(() => {
    const updatedServiceItems = serviceItems.map((item) => {
      const baseAmount = item.quantity * item.rate;
      const { taxAmount, cgstAmount, sgstAmount, igstAmount, amount } =
        calculateItemGST(
          baseAmount,
          item.taxRate,
          invoiceData.companyState,
          invoiceData.billToState
        );
      return {
        ...item,
        taxAmount,
        cgstAmount,
        sgstAmount,
        igstAmount,
        amount,
      };
    });
    setServiceItems(updatedServiceItems);
  }, [invoiceData.companyState, invoiceData.billToState]);

  const validateGstin = (gstin) => {
    if (!gstin) {
      // Optional field
      setGstinError("");
      return true;
    }
    const gstinRegex =
      /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;
    if (gstinRegex.test(gstin)) {
      setGstinError("");
      return true;
    } else {
      setGstinError("Invalid GSTIN format.");
      return false;
    }
  };

  // Handlers for address fields
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    if (
      [
        "blockUnitStreetName",
        "state",
        "city",
        "pincode",
        "country",
        "gstin",
      ].includes(name)
    ) {
      const updatedValue = name === "gstin" ? value.toUpperCase() : value;
      setFormData((prev) => ({ ...prev, [name]: updatedValue }));
      // Update invoiceData.billToState when formData.state changes
      if (name === "state") {
        setInvoiceData((prev) => ({ ...prev, billToState: updatedValue }));
        // Also try to set selectedStateObj if state is manually entered
        if (selectedCountryObj) {
          const foundState = State.getStatesOfCountry(
            selectedCountryObj.isoCode
          ).find((s) => s.name.toLowerCase() === updatedValue.toLowerCase());
          setSelectedStateObj(foundState || null);
          // Reset cities if state changes
          setFilteredCities(
            foundState
              ? City.getCitiesOfState(
                  selectedCountryObj.isoCode,
                  foundState.isoCode
                )
              : []
          );
        }
      } else if (name === "country") {
        // Try to set selectedCountryObj if country is manually entered
        const foundCountry = Country.getAllCountries().find(
          (c) => c.name.toLowerCase() === updatedValue.toLowerCase()
        );
        setSelectedCountryObj(foundCountry || null);
        // Reset states and cities if country changes
        setFilteredStates(
          foundCountry ? State.getStatesOfCountry(foundCountry.isoCode) : []
        );
        setFilteredCities([]);
        setSelectedStateObj(null);
      }

      if (name === "gstin") {
        validateGstin(updatedValue);
      }
    } else {
      setInvoiceData((prev) => ({ ...prev, [name]: value }));
    }
  };

  // Country search and select
  const handleCountrySearchChange = (e) => {
    setCountrySearchTerm(e.target.value);
    const filtered = Country.getAllCountries().filter((country) =>
      country.name.toLowerCase().includes(e.target.value.toLowerCase())
    );
    setFilteredCountries(filtered);
  };
  const handleCountrySelect = (country) => {
    setFormData((prev) => ({
      ...prev,
      country: country.name,
      state: "",
      city: "",
    }));
    setSelectedCountryObj(country);
    setCountryDropdownOpen(false);
    setFilteredStates(State.getStatesOfCountry(country.isoCode));
    setSelectedStateObj(null);
    setFilteredCities([]);
  };

  // State search and select
  const handleStateSearchChange = (e) => {
    setStateSearchTerm(e.target.value);
    if (selectedCountryObj) {
      const filtered = State.getStatesOfCountry(
        selectedCountryObj.isoCode
      ).filter((state) =>
        state.name.toLowerCase().includes(e.target.value.toLowerCase())
      );
      setFilteredStates(filtered);
    }
  };
  const handleStateSelect = (state) => {
    setFormData((prev) => ({ ...prev, state: state.name, city: "" }));
    setSelectedStateObj(state);
    setStateDropdownOpen(false);
    setFilteredCities(
      City.getCitiesOfState(selectedCountryObj.isoCode, state.isoCode)
    );
    setInvoiceData((prev) => ({ ...prev, billToState: state.name }));
  };

  // City search and select
  const handleCitySearchChange = (e) => {
    setCitySearchTerm(e.target.value);
    if (selectedCountryObj && selectedStateObj) {
      const filtered = City.getCitiesOfState(
        selectedCountryObj.isoCode,
        selectedStateObj.isoCode
      ).filter((city) =>
        city.name.toLowerCase().includes(e.target.value.toLowerCase())
      );
      setFilteredCities(filtered);
    }
  };
  const handleCitySelect = (city) => {
    setFormData((prev) => ({ ...prev, city: city.name }));
    setCityDropdownOpen(false);
  };

  // Close dropdowns on outside click
  useEffect(() => {
    function handleClickOutside(event) {
      if (
        countryDropdownRef.current &&
        !countryDropdownRef.current.contains(event.target)
      ) {
        setCountryDropdownOpen(false);
      }
      if (
        stateDropdownRef.current &&
        !stateDropdownRef.current.contains(event.target)
      ) {
        setStateDropdownOpen(false);
      }
      if (
        cityDropdownRef.current &&
        !cityDropdownRef.current.contains(event.target)
      ) {
        setCityDropdownOpen(false);
      }
      if (
        leadDropdownRef.current &&
        !leadDropdownRef.current.contains(event.target)
      ) {
        setLeadDropdownOpen(false);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, []);

  const calculateItemGST = (baseAmount, taxRate, companyState, billToState) => {
    let cgstAmount = 0;
    let sgstAmount = 0;
    let igstAmount = 0;

    const companyStateClean = companyState
      ? companyState.toLowerCase().trim()
      : "";
    const billToStateClean = billToState
      ? billToState.toLowerCase().trim()
      : "";

    if (companyStateClean === billToStateClean) {
      const halfTaxRate = taxRate / 2;
      cgstAmount = baseAmount * (halfTaxRate / 100);
      sgstAmount = baseAmount * (halfTaxRate / 100);
    } else {
      igstAmount = baseAmount * (taxRate / 100);
    }

    const taxAmount = cgstAmount + sgstAmount + igstAmount;
    const amount = baseAmount + taxAmount;

    return {
      taxAmount,
      cgstAmount,
      sgstAmount,
      igstAmount,
      amount,
    };
  };

  const handleServiceItemChange = (index, field, value) => {
    const newServiceItems = [...serviceItems];
    newServiceItems[index][field] = value;

    if (field === "quantity" || field === "rate" || field === "taxRate") {
      const qty = parseFloat(newServiceItems[index].quantity) || 0;
      const rate = parseFloat(newServiceItems[index].rate) || 0;
      const taxRate = parseFloat(newServiceItems[index].taxRate) || 0;

      const baseAmount = qty * rate;
      const { taxAmount, cgstAmount, sgstAmount, igstAmount, amount } =
        calculateItemGST(
          baseAmount,
          taxRate,
          invoiceData.companyState,
          invoiceData.billToState
        );

      newServiceItems[index].taxAmount = taxAmount;
      newServiceItems[index].amount = amount;
      newServiceItems[index].cgstAmount = cgstAmount;
      newServiceItems[index].sgstAmount = sgstAmount;
      newServiceItems[index].igstAmount = igstAmount;
    }
    setServiceItems(newServiceItems);
    // Clear any manual override for this item's amount if quantity, rate, or taxRate changed
    if (field === "quantity" || field === "rate" || field === "taxRate") {
      setEditedServiceItemAmounts((prev) => {
        const newEditedAmounts = { ...prev };
        delete newEditedAmounts[index];
        return newEditedAmounts;
      });
    }
  };

  const addServiceItem = () => {
    setServiceItems([
      ...serviceItems,
      {
        description: "",
        quantity: 0,
        rate: 0,
        taxRate: 0,
        amount: 0,
        taxAmount: 0,
        cgstAmount: 0,
        sgstAmount: 0,
        igstAmount: 0,
      },
    ]);
  };

  const removeServiceItem = (index) => {
    if (serviceItems.length === 1) {
      Swal.fire(
        "Cannot Delete Last Item",
        "At least one service item is required.",
        "error"
      );
      return;
    }

    Swal.fire({
      title: "Are you sure?",
      text: "You won't be able to revert this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, delete it!",
    }).then((result) => {
      if (result.isConfirmed) {
        const newServiceItems = serviceItems.filter((_, i) => i !== index);
        setServiceItems(newServiceItems);
        Swal.fire("Deleted!", "Your service item has been deleted.", "success");
      }
    });
  };

  const handleEditedTotalChange = (field, value) => {
    const parsedValue = parseFloat(value) || 0;
    switch (field) {
      case "subTotal":
        setEditedSubTotal(parsedValue);
        break;
      case "cgstTotal":
        setEditedCgstTotal(parsedValue);
        break;
      case "sgstTotal":
        setEditedSgstTotal(parsedValue);
        break;
      case "igstTotal":
        setEditedIgstTotal(parsedValue);
        break;
      default:
        break;
    }
  };

  const handleEditedOverallTotalChange = (field, value) => {
    const parsedValue = parseFloat(value) || 0;
    switch (field) {
      case "grandTotal":
        setEditedGrandTotal(parsedValue);
        break;
      case "balance":
        setEditedBalance(parsedValue);
        break;
      default:
        break;
    }
  };

  const calculateSubTotal = () => {
    return editedSubTotal !== null && editedSubTotal !== ""
      ? parseFloat(editedSubTotal)
      : serviceItems.reduce(
          (sum, item) => sum + item.amount - item.taxAmount,
          0
        ); // Corrected to exclude taxAmount from subtotal
  };

  const calculateGrandTotal = () => {
    // Sum the effective subtotal and effective GST totals
    const effectiveSubTotal = calculateSubTotal();
    const effectiveCgstTotal = calculateCgstTotal();
    const effectiveSgstTotal = calculateSgstTotal();
    const effectiveIgstTotal = calculateIgstTotal();

    return (
      effectiveSubTotal +
      effectiveCgstTotal +
      effectiveSgstTotal +
      effectiveIgstTotal
    );
  };

  const calculateCgstTotal = () => {
    return editedCgstTotal !== null && editedCgstTotal !== ""
      ? parseFloat(editedCgstTotal)
      : serviceItems.reduce((sum, item) => sum + item.cgstAmount, 0);
  };

  const calculateSgstTotal = () => {
    return editedSgstTotal !== null && editedSgstTotal !== ""
      ? parseFloat(editedSgstTotal)
      : serviceItems.reduce((sum, item) => sum + item.sgstAmount, 0);
  };

  const calculateIgstTotal = () => {
    return editedIgstTotal !== null && editedIgstTotal !== ""
      ? parseFloat(editedIgstTotal)
      : serviceItems.reduce((sum, item) => sum + item.igstAmount, 0);
  };

  // Derived state for grand total and balance
  const displayedGrandTotal = calculateGrandTotal();
  const displayedBalance = displayedGrandTotal - receivedAmount;

  const toggleMode = () => {
    if (isEditMode) {
      Swal.fire({
        title: "Are you sure?",
        text: "All unsaved changes will be lost!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, exit!",
      }).then((result) => {
        if (result.isConfirmed) {
          setInvoiceData(originalInvoiceData);
          setServiceItems(originalServiceItems);
          setFormData(originalInvoiceData.billToAddress || formData);
          setShipToFormData(
            originalInvoiceData.shipToAddress || shipToFormData
          );
          setIsEditMode(false);
          setReceivedAmount(0); // Reset received amount on exit if not saved
        }
      });
    } else {
      setOriginalInvoiceData(invoiceData);
      setOriginalServiceItems(serviceItems);
      setFormData(invoiceData.billToAddress || formData);
      setShipToFormData(invoiceData.shipToAddress || shipToFormData);
      setIsEditMode(true);
      // setOriginalReceivedAmount(receivedAmount); // If you want to revert received amount
    }
  };

  const saveChanges = () => {
    if (formData.gstin && gstinError) {
      Swal.fire({
        icon: "error",
        title: "Invalid Input",
        text: "Please correct the invalid GSTIN before saving.",
        confirmButtonColor: "#3085d6",
      });
      return;
    }
    if (shipToFormData.gstin && shipToGstinError) {
      Swal.fire({
        icon: "error",
        title: "Invalid Input",
        text: "Please correct the invalid Ship To GSTIN before saving.",
        confirmButtonColor: "#3085d6",
      });
      return;
    }
    const newInvoiceData = {
      ...invoiceData,
      billToAddress: { ...formData },
      shipToAddress: { ...shipToFormData },
      receivedAmount: receivedAmount,
      grandTotal: displayedGrandTotal, // Save the calculated grand total
      balance: displayedBalance, // Save the calculated balance
    };
    setInvoiceData(newInvoiceData); // This might cause issues if invoiceData still has these keys, consider separate save data
    setOriginalInvoiceData(newInvoiceData); // Set original to the new saved state
    setOriginalServiceItems(serviceItems);
    setIsEditMode(false);
    setFormData(newInvoiceData.billToAddress);
    setShipToFormData(newInvoiceData.shipToAddress);
    console.log("Saving changes:", newInvoiceData, serviceItems);
    Swal.fire({
      icon: "success",
      title: "Success!",
      text: "Changes saved successfully!",
      confirmButtonColor: "#3085d6",
    });
  };

  const submitInvoice = () => {
    if (formData.gstin && gstinError) {
      Swal.fire({
        icon: "error",
        title: "Invalid Input",
        text: "Please correct the invalid GSTIN before submitting.",
        confirmButtonColor: "#3085d6",
      });
      return;
    }
    console.log("Submitting invoice:", invoiceData, serviceItems, formData);
    Swal.fire({
      icon: "success",
      title: "Invoice Submitted!",
      text: "Your invoice has been successfully submitted.",
      confirmButtonColor: "#3085d6",
    });
  };

  // Fetch leads when dropdown is opened
  useEffect(() => {
    if (leadDropdownOpen && leads.length === 0) {
      setLeadsLoading(true);
      api
        .get("/showlead")
        .then((res) => {
          if (res.data.success) {
            setLeads(res.data.result);
          }
        })
        .catch(() => {})
        .finally(() => setLeadsLoading(false));
    }
  }, [leadDropdownOpen]);

  // Filtered leads based on search
  const filteredLeads = leads.filter((lead) => {
    const term = leadSearchTerm.toLowerCase();
    return (
      lead.customer_name.toLowerCase().includes(term) ||
      lead.email.toLowerCase().includes(term) ||
      lead.contact.toLowerCase().includes(term)
    );
  });

  // Parse address helper
  function parseLeadAddress(addressString) {
    const lines = addressString.split(/\r?\n/);
    let blockUnitStreetName = lines[0] || "";
    let city = "";
    let state = "";
    let country = "";
    let pincode = "";

    if (lines.length > 1) {
      // Try to extract city, state from the second line
      const cityStateMatch = lines[1].match(/^(.*?),\s*([A-Za-z ]+)$/);
      if (cityStateMatch) {
        city = cityStateMatch[1].trim();
        state = cityStateMatch[2].trim();
      } else {
        // If no comma, assume it's just city or part of street
        city = lines[1].trim();
      }
    }

    if (lines.length > 2) {
      // Try to extract country and pincode from the third line
      const countryPinMatch = lines[2].match(/^(.*)\s*-\s*(\d{6})$/);
      if (countryPinMatch) {
        country = countryPinMatch[1].trim();
        pincode = countryPinMatch[2];
      } else {
        country = lines[2].trim();
      }
    }

    return { blockUnitStreetName, city, state, country, pincode };
  }

  // Autofill Bill To fields from lead
  const handleLeadSelect = (lead) => {
    const parsedAddress = parseLeadAddress(lead.city || "");
    setInvoiceData((prev) => ({
      ...prev,
      billToName: lead.customer_name || prev.billToName,
      billToPhone: lead.contact || prev.billToPhone,
      billToEmail: lead.email || prev.billToEmail,
      billToState: parsedAddress.state || prev.billToState, // Set billToState from parsed address
      shipToName: lead.customer_name || prev.shipToName,
      shipToPhone: lead.contact || prev.shipToPhone,
      shipToEmail: lead.email || prev.shipToEmail, // Add this line to populate shipToEmail
      shipToState: parsedAddress.state || prev.shipToState, // Set shipToState from parsed address
    }));
    setFormData((prev) => ({
      ...prev,
      ...parsedAddress,
    }));

    // Set selectedCountryObj and selectedStateObj after autofilling from lead
    const countryFromParsed = Country.getAllCountries().find(
      (c) => c.name.toLowerCase() === parsedAddress.country.toLowerCase()
    );
    setSelectedCountryObj(countryFromParsed || null);
    if (countryFromParsed && parsedAddress.state) {
      const stateFromParsed = State.getStatesOfCountry(
        countryFromParsed.isoCode
      ).find((s) => s.name.toLowerCase() === parsedAddress.state.toLowerCase());
      setSelectedStateObj(stateFromParsed || null);
    }

    setShipToFormData((prev) => ({
      ...prev,
      ...parsedAddress,
    }));
    setLeadDropdownOpen(false);
    setLeadSearchTerm("");
    setShipToLeadDropdownOpen(false);
    setShipToLeadSearchTerm("");
  };

  // Ship To lead select (independent)
  const handleShipToLeadSelect = (lead) => {
    const parsedAddress = parseLeadAddress(lead.city || "");
    setInvoiceData((prev) => ({
      ...prev,
      shipToName: lead.customer_name || prev.shipToName,
      shipToPhone: lead.contact || prev.shipToPhone,
      shipToEmail: lead.email || prev.shipToEmail, // Add this line to populate shipToEmail
      shipToState: parsedAddress.state || prev.shipToState, // Set shipToState from parsed address
    }));
    setShipToFormData((prev) => ({
      ...prev,
      ...parsedAddress,
    }));
    // Set shipToSelectedCountryObj and shipToSelectedStateObj after autofilling from lead
    const countryFromParsed = Country.getAllCountries().find(
      (c) => c.name.toLowerCase() === parsedAddress.country.toLowerCase()
    );
    setShipToSelectedCountryObj(countryFromParsed || null);
    if (countryFromParsed && parsedAddress.state) {
      const stateFromParsed = State.getStatesOfCountry(
        countryFromParsed.isoCode
      ).find((s) => s.name.toLowerCase() === parsedAddress.state.toLowerCase());
      setShipToSelectedStateObj(stateFromParsed || null);
    }
    setShipToLeadDropdownOpen(false);
    setShipToLeadSearchTerm("");
  };

  // Ship To input change
  const handleShipToInputChange = (e) => {
    const { name, value } = e.target;
    if (
      [
        "blockUnitStreetName",
        "state",
        "city",
        "pincode",
        "country",
        "gstin",
      ].includes(name)
    ) {
      const updatedValue = name === "gstin" ? value.toUpperCase() : value;
      setShipToFormData((prev) => ({ ...prev, [name]: updatedValue }));
      // Update invoiceData.shipToState when shipToFormData.state changes
      if (name === "state") {
        setInvoiceData((prev) => ({ ...prev, shipToState: updatedValue }));
        // Also try to set shipToSelectedStateObj if state is manually entered
        if (shipToSelectedCountryObj) {
          const foundState = State.getStatesOfCountry(
            shipToSelectedCountryObj.isoCode
          ).find((s) => s.name.toLowerCase() === updatedValue.toLowerCase());
          setShipToSelectedStateObj(foundState || null);
          // Reset cities if state changes
          setShipToFilteredCities(
            foundState
              ? City.getCitiesOfState(
                  shipToSelectedCountryObj.isoCode,
                  foundState.isoCode
                )
              : []
          );
        }
      } else if (name === "country") {
        // Try to set shipToSelectedCountryObj if country is manually entered
        const foundCountry = Country.getAllCountries().find(
          (c) => c.name.toLowerCase() === updatedValue.toLowerCase()
        );
        setShipToSelectedCountryObj(foundCountry || null);
        // Reset states and cities if country changes
        setShipToFilteredStates(
          foundCountry ? State.getStatesOfCountry(foundCountry.isoCode) : []
        );
        setShipToFilteredCities([]);
        setShipToSelectedStateObj(null);
      }
      if (name === "gstin") {
        if (!updatedValue) {
          setShipToGstinError("");
        } else {
          const gstinRegex =
            /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;
          setShipToGstinError(
            gstinRegex.test(updatedValue) ? "" : "Invalid GSTIN format."
          );
        }
      }
    } else {
      setInvoiceData((prev) => ({ ...prev, [name]: value }));
    }
  };

  // Ship To dropdown outside click
  useEffect(() => {
    function handleClickOutside(event) {
      if (
        shipToDropdownRef.current &&
        !shipToDropdownRef.current.contains(event.target)
      ) {
        setShipToLeadDropdownOpen(false);
      }
      if (
        shipToCountryDropdownRef.current &&
        !shipToCountryDropdownRef.current.contains(event.target)
      ) {
        setShipToCountryDropdownOpen(false);
      }
      if (
        shipToStateDropdownRef.current &&
        !shipToStateDropdownRef.current.contains(event.target)
      ) {
        setShipToStateDropdownOpen(false);
      }
      if (
        shipToCityDropdownRef.current &&
        !shipToCityDropdownRef.current.contains(event.target)
      ) {
        setShipToCityDropdownOpen(false);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, []);

  // Handlers for Ship To address fields
  const handleShipToCountrySearchChange = (e) => {
    setShipToCountrySearchTerm(e.target.value);
    const filtered = Country.getAllCountries().filter((country) =>
      country.name.toLowerCase().includes(e.target.value.toLowerCase())
    );
    setShipToFilteredCountries(filtered);
  };
  const handleShipToCountrySelect = (country) => {
    setShipToFormData((prev) => ({
      ...prev,
      country: country.name,
      state: "",
      city: "",
    }));
    setShipToSelectedCountryObj(country);
    setShipToCountryDropdownOpen(false);
    setShipToFilteredStates(State.getStatesOfCountry(country.isoCode));
    setShipToSelectedStateObj(null);
    setShipToFilteredCities([]);
  };

  const handleShipToStateSearchChange = (e) => {
    setShipToStateSearchTerm(e.target.value);
    if (shipToSelectedCountryObj) {
      const filtered = State.getStatesOfCountry(
        shipToSelectedCountryObj.isoCode
      ).filter((state) =>
        state.name.toLowerCase().includes(e.target.value.toLowerCase())
      );
      setShipToFilteredStates(filtered);
    }
  };
  const handleShipToStateSelect = (state) => {
    setShipToFormData((prev) => ({ ...prev, state: state.name, city: "" }));
    setShipToSelectedStateObj(state);
    setShipToStateDropdownOpen(false);
    setShipToFilteredCities(
      City.getCitiesOfState(shipToSelectedCountryObj.isoCode, state.isoCode)
    );
    setInvoiceData((prev) => ({ ...prev, shipToState: state.name }));
  };

  const handleShipToCitySearchChange = (e) => {
    setShipToCitySearchTerm(e.target.value);
    if (shipToSelectedCountryObj && shipToSelectedStateObj) {
      const filtered = City.getCitiesOfState(
        shipToSelectedCountryObj.isoCode,
        shipToSelectedStateObj.isoCode
      ).filter((city) =>
        city.name.toLowerCase().includes(e.target.value.toLowerCase())
      );
      setShipToFilteredCities(filtered);
    }
  };
  const handleShipToCitySelect = (city) => {
    setShipToFormData((prev) => ({ ...prev, city: city.name }));
    setShipToCityDropdownOpen(false);
  };

  const handleEditedItemAmountChange = (index, value) => {
    const newServiceItems = [...serviceItems];
    const parsedValue = parseFloat(value);

    // Update the item's amount directly
    newServiceItems[index].amount = parsedValue;

    if (
      !isNaN(parsedValue) &&
      parsedValue >= 0 &&
      newServiceItems[index].taxRate > 0
    ) {
      // Calculate base amount from the edited total amount and tax rate
      const taxRate = newServiceItems[index].taxRate;
      const baseAmount = parsedValue / (1 + taxRate / 100);

      // Recalculate GST components using the base amount
      const { taxAmount, cgstAmount, sgstAmount, igstAmount } =
        calculateItemGST(
          baseAmount,
          taxRate,
          invoiceData.companyState,
          invoiceData.billToState
        );

      newServiceItems[index].taxAmount = taxAmount;
      newServiceItems[index].cgstAmount = cgstAmount;
      newServiceItems[index].sgstAmount = sgstAmount;
      newServiceItems[index].igstAmount = igstAmount;
      // Note: quantity and rate are not updated by editing the final amount
    } else if (isNaN(parsedValue) || parsedValue === null || parsedValue < 0) {
      // If the input is invalid or cleared, reset tax amounts to 0
      newServiceItems[index].amount = 0;
      newServiceItems[index].taxAmount = 0;
      newServiceItems[index].cgstAmount = 0;
      newServiceItems[index].sgstAmount = 0;
      newServiceItems[index].igstAmount = 0;
    }

    setServiceItems(newServiceItems);

    // Clear any manual override for this item's amount to allow calculated values to take over if input is cleared
    setEditedServiceItemAmounts((prev) => {
      const newEditedAmounts = { ...prev };
      if (value === "" || isNaN(parsedValue)) {
        delete newEditedAmounts[index];
      } else {
        newEditedAmounts[index] = parsedValue;
      }
      return newEditedAmounts;
    });
  };

  const handleEditedGstLabelChange = (field, value) => {
    switch (field) {
      case "cgstLabel":
        setEditedCgstLabel(value);
        break;
      case "sgstLabel":
        setEditedSgstLabel(value);
        break;
      case "igstLabel":
        setEditedIgstLabel(value);
        break;
      default:
        break;
    }
  };

  const handleEditedGstPercentageChange = (field, value) => {
    const parsedValue = parseFloat(value) || null;
    switch (field) {
      case "cgstPercentage":
        setEditedCgstPercentage(parsedValue);
        break;
      case "sgstPercentage":
        setEditedSgstPercentage(parsedValue);
        break;
      case "igstPercentage":
        setEditedIgstPercentage(parsedValue);
        break;
      default:
        break;
    }
  };

  return (
    <div className="w-full lg:w-[70%] h-auto bg-white p-4 sm:p-6 lg:p-[23px] min-h-screen rounded-2xl flex flex-col relative">
      {/* Header */}
      <div className="flex justify-between items-center mb-8">
        <div className="flex items-center">
          {user?.profile_pic && ( // Conditionally render image
            <img
              src={user?.profile_pic}
              alt="Logo"
              className="h-24 w-24 mr-4"
            />
          )}{" "}
          {/* Placeholder for logo */}
          <div>
            {isEditMode ? (
              <input
                type="text"
                name="companyName"
                placeholder="Enter Company Name"
                value={invoiceData.companyName}
                onChange={handleInputChange}
                className="text-[rgb(39,152,255)] mb-1 text-2xl sm:text-3xl lg:text-[32px] font-bold w-full px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
              />
            ) : (
              <h1 className="text-[rgb(39,152,255)] text-2xl sm:text-3xl lg:text-[32px] font-bold">
                {invoiceData.companyName}
              </h1>
            )}

            {isEditMode ? (
              <>
                <input
                  type="text"
                  name="addressLine1"
                  placeholder="Enter Address Line 1"
                  value={invoiceData.addressLine1}
                  onChange={handleInputChange}
                  className="text-sm text-[rgb(31,41,55)] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] mb-1"
                />
                <input
                  type="text"
                  name="addressLine2"
                  value={invoiceData.addressLine2}
                  placeholder="Enter Address Line 2"
                  onChange={handleInputChange}
                  className="text-sm text-[rgb(31,41,55)] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] mb-1"
                />
                <div className="flex gap-2">
                  <input
                    type="email"
                    name="organizationEmail"
                    value={organizationEmail}
                    placeholder="Enter Organization Email"
                    onChange={(e) => setOrganizationEmail(e.target.value)}
                    className="text-sm text-[rgb(31,41,55)] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] mb-1"
                  />
                  <input
                    type="text"
                    name="mobile"
                    value={invoiceData.mobile}
                    onChange={handleInputChange}
                    placeholder="Enter Mobile Number"
                    className="text-sm text-[rgb(31,41,55)] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                  />
                </div>
              </>
            ) : (
              <>
                {/* Display each address line separately */}
                {invoiceData.addressLine1 && (
                  <p className="text-sm text-[rgb(31,41,55)]">
                    {invoiceData.addressLine1}
                  </p>
                )}
                {invoiceData.addressLine2 &&
                  invoiceData.addressLine2.split("\n").map((line, idx) => (
                    <p className="text-sm text-[rgb(31,41,55)]" key={idx}>
                      {line}
                    </p>
                  ))}
                <div className="flex gap-2">
                  {organizationEmail && (
                    <p className="text-sm text-[rgb(31,41,55)]">
                      Email: {organizationEmail}
                    </p>
                  )}
                  <p className="text-sm text-[rgb(31,41,55)]">
                    Mobile: {invoiceData.mobile}
                  </p>
                </div>
              </>
            )}
          </div>
        </div>
        <div className="text-right">
          <h2 className="text-[rgb(39,152,255)] text-2xl sm:text-3xl lg:text-[32px] font-bold">
            INVOICE
          </h2>
        </div>
      </div>

      <hr className="border-t-2 border-[rgb(39,152,255)] mb-6" />

      {/* Invoice Details */}
      <div className="flex justify-between mb-6 text-sm text-[#4B5563]">
        <div>
          Invoice No.:{" "}
          {isEditMode ? (
            <input
              type="text"
              name="invoiceNo"
              value={invoiceData.invoiceNo}
              onChange={handleInputChange}
              placeholder="Enter Invoice No."
              className="w-24 px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
            />
          ) : (
            invoiceData.invoiceNo
          )}
        </div>
        <div>
          Invoice Date:{" "}
          {isEditMode ? (
            <input
              type="date"
              name="invoiceDate"
              value={invoiceData.invoiceDate}
              onChange={handleInputChange}
              placeholder="Select Date"
              className="w-32 px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
            />
          ) : (
            invoiceData.invoiceDate
          )}
        </div>
      </div>

      <hr className="border-t border-[#E5E7EB] mb-6" />

      {/* Bill To / Ship To */}
      <div className="flex justify-between mb-8">
        <div className="w-1/2 pr-4">
          <h3 className="font-bold text-lg mb-2 text-[#4B5563]">BILL TO</h3>
          {/* Lead Search & Dropdown */}
          {isEditMode && (
            <div className="mb-2 relative" ref={leadDropdownRef}>
              <input
                type="text"
                placeholder="Search customer by name, email, or phone..."
                value={leadSearchTerm}
                onChange={(e) => {
                  setLeadSearchTerm(e.target.value);
                  setLeadDropdownOpen(true);
                }}
                onFocus={() => setLeadDropdownOpen(true)}
                className="w-full px-3 py-2 rounded-[12px] border border-[#E7EFF8] bg-[#F8FAFC] text-[#545454] focus:ring-2 focus:ring-[#0e4053] outline-none mb-1"
              />
              {leadDropdownOpen && (
                <div className="absolute z-20 w-full bg-white rounded-xl shadow-2xl border border-gray-200 mt-1 max-h-72 overflow-y-auto animate-fade-in">
                  {leadsLoading ? (
                    <div className="flex flex-col items-center justify-center p-6 text-gray-500">
                      <svg
                        className="animate-spin h-6 w-6 mb-2 text-blue-400"
                        fill="none"
                        viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <circle
                          className="opacity-25"
                          cx="12"
                          cy="12"
                          r="10"
                          stroke="currentColor"
                          strokeWidth="4"
                        ></circle>
                        <path
                          className="opacity-75"
                          fill="currentColor"
                          d="M4 12a8 8 0 018-8v8z"
                        ></path>
                      </svg>
                      Loading...
                    </div>
                  ) : filteredLeads.length > 0 ? (
                    filteredLeads.map((lead, idx) => (
                      <div
                        key={lead.customer_id}
                        className="flex items-center gap-3 px-4 py-3 cursor-pointer transition-colors hover:bg-blue-50/80 group"
                        style={{
                          borderBottom:
                            idx !== filteredLeads.length - 1
                              ? "1px solid #F1F5F9"
                              : "none",
                        }}
                        onClick={() => handleLeadSelect(lead)}
                      >
                        <img
                          src={lead.profile_pic}
                          alt="pic"
                          className="h-9 w-9 rounded-full object-cover border border-gray-200 shadow-sm"
                        />
                        <div className="flex flex-col flex-1 min-w-0">
                          <span className="font-semibold text-gray-800 truncate group-hover:text-blue-700">
                            {lead.customer_name}
                          </span>
                          <span className="text-xs text-gray-500 truncate">
                            {lead.email}
                          </span>
                          <span className="text-xs text-gray-400 truncate">
                            {lead.contact}
                          </span>
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="flex flex-col items-center justify-center p-6 text-gray-400">
                      <svg
                        className="h-8 w-8 mb-2"
                        fill="none"
                        stroke="currentColor"
                        strokeWidth="1.5"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-3A2.25 2.25 0 008.25 5.25V9m10.5 0A2.25 2.25 0 0121 11.25v7.5A2.25 2.25 0 0118.75 21H5.25A2.25 2.25 0 013 18.75v-7.5A2.25 2.25 0 015.25 9m13.5 0h-13.5"
                        />
                      </svg>
                      No leads found
                    </div>
                  )}
                </div>
              )}
            </div>
          )}
          {isEditMode ? (
            <>
              <div className="space-y-1">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Organisation
                </label>
                <div>
                  <input
                    type="text"
                    name="billToName"
                    value={invoiceData.billToName}
                    onChange={handleInputChange}
                    placeholder="Enter Bill To Name"
                    className="font-semibold text-[#1F2837] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] mb-1"
                  />
                  <div className="flex gap-2"></div>
                </div>
              </div>

              {/* Address */}
              <div className="space-y-1 mt-2">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Address
                </label>
                <div className="w-full rounded-[12px]  border border-white/20 flex flex-col">
                  <input
                    type="text"
                    name="blockUnitStreetName"
                    value={formData.blockUnitStreetName}
                    onChange={handleInputChange}
                    className="w-full h-[44px] px-3 flex items-center text-[#545454] border-b  bg-[#E7EFF8]/60 border border-white/20 outline-none rounded-t-[12px]"
                    placeholder="Block/Unit/Street Name"
                  />
                  {/* State and City Dropdowns */}
                  <div className="grid grid-cols-2  w-full">
                    {/* State Dropdown */}
                    <div className="relative" ref={stateDropdownRef}>
                      <input
                        type="text"
                        name="stateSearch"
                        value={formData.state || stateSearchTerm}
                        onChange={handleStateSearchChange}
                        onFocus={() => setStateDropdownOpen(true)}
                        className="w-full h-[44px] px-4 bg-[#E7EFF8]/60 border border-white/20 outline-none text-[#545454] placeholder-[#545454] text-[16px]"
                        placeholder="Select State"
                        disabled={!selectedCountryObj}
                        autoComplete="off"
                      />
                      {formData.state && isEditMode && (
                        <button
                          type="button"
                          onClick={() => {
                            setFormData((prev) => ({ ...prev, state: "" }));
                            setStateSearchTerm("");
                            setSelectedStateObj(null);
                            setFilteredCities([]);
                            setInvoiceData((prev) => ({
                              ...prev,
                              billToState: "",
                            })); // Clear billToState
                          }}
                          className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            className="h-4 w-4"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M6 18L18 6M6 6l12 12"
                            />
                          </svg>
                        </button>
                      )}
                      {stateDropdownOpen && (
                        <div className="absolute z-10 w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                          {filteredStates.length > 0 ? (
                            filteredStates.map((state) => (
                              <div
                                key={state.isoCode}
                                className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                onClick={() => handleStateSelect(state)}
                                onMouseDown={(e) => e.preventDefault()}
                              >
                                {state.name}
                              </div>
                            ))
                          ) : (
                            <div className="p-3 text-gray-500">
                              No states found
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                    {/* City Dropdown */}
                    <div className="relative" ref={cityDropdownRef}>
                      <input
                        type="text"
                        name="citySearch"
                        value={formData.city || citySearchTerm}
                        onChange={handleCitySearchChange}
                        onFocus={() => setCityDropdownOpen(true)}
                        className="w-full h-[44px] px-4 bg-[#E7EFF8]/60 border border-white/20  outline-none text-[#545454] placeholder-[#545454] text-[16px]"
                        placeholder="Select City"
                        disabled={!selectedStateObj}
                        autoComplete="off"
                      />
                      {formData.city && isEditMode && (
                        <button
                          type="button"
                          onClick={() => {
                            setFormData((prev) => ({ ...prev, city: "" }));
                            setCitySearchTerm("");
                          }}
                          className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            className="h-4 w-4"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M6 18L18 6M6 6l12 12"
                            />
                          </svg>
                        </button>
                      )}
                      {cityDropdownOpen && (
                        <div className="absolute z-10 w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                          {filteredCities.length > 0 ? (
                            filteredCities.map((city) => (
                              <div
                                key={city.name}
                                className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                onClick={() => handleCitySelect(city)}
                                onMouseDown={(e) => e.preventDefault()}
                              >
                                {city.name}
                              </div>
                            ))
                          ) : (
                            <div className="p-3 text-gray-500">
                              No cities found
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                  {/* Pincode and Country */}
                  <div className="grid grid-cols-2  w-full">
                    {/* Pincode Input */}
                    <input
                      type="text"
                      name="pincode"
                      value={formData.pincode}
                      onChange={handleInputChange}
                      className="w-full h-[44px] px-3 flex items-center text-[#545454] bg-[#E7EFF8]/60 border border-white/20 rounded-bl-[12px] outline-none"
                      placeholder="Pincode"
                    />
                    {/* Country Dropdown */}
                    <div className="relative" ref={countryDropdownRef}>
                      <input
                        type="text"
                        name="countrySearch"
                        value={formData.country || countrySearchTerm}
                        onChange={handleCountrySearchChange}
                        onFocus={() => setCountryDropdownOpen(true)}
                        className="w-full h-[44px] px-4 bg-[#E7EFF8]/60 border border-white/20  outline-none text-[#545454] placeholder-[#545454] rounded-br-[12px] text-[16px]"
                        placeholder="Select Country"
                        autoComplete="off"
                      />
                      {formData.country && isEditMode && (
                        <button
                          type="button"
                          onClick={() => {
                            setFormData((prev) => ({
                              ...prev,
                              country: "",
                              state: "",
                              city: "",
                            }));
                            setCountrySearchTerm("");
                            setSelectedCountryObj(null);
                            setSelectedStateObj(null);
                            setFilteredStates([]);
                            setFilteredCities([]);
                            setInvoiceData((prev) => ({
                              ...prev,
                              billToState: "",
                            })); // Clear billToState
                          }}
                          className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            className="h-4 w-4"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M6 18L18 6M6 6l12 12"
                            />
                          </svg>
                        </button>
                      )}
                      {countryDropdownOpen && (
                        <div className="absolute z-10 w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                          {filteredCountries.length > 0 ? (
                            filteredCountries.map((country) => (
                              <div
                                key={country.isoCode}
                                className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                onClick={() => handleCountrySelect(country)}
                                onMouseDown={(e) => e.preventDefault()}
                              >
                                {country.name}
                              </div>
                            ))
                          ) : (
                            <div className="p-3 text-gray-500">
                              No countries found
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>

              <div className="space-y-1 mt-2">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Contact
                </label>
                <div>
                  <div className="flex gap-2">
                    <input
                      type="email"
                      name="billToEmail"
                      value={invoiceData.billToEmail}
                      onChange={handleInputChange}
                      placeholder="Enter Bill To Email"
                      className="text-[#545454] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none placeholder-[#545454]"
                    />
                    <input
                      type="text"
                      name="billToPhone"
                      value={invoiceData.billToPhone}
                      onChange={handleInputChange}
                      placeholder="Enter Bill To Phone"
                      className="text-[#545454] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                    />
                  </div>
                </div>
              </div>

              <div className="space-y-1 mt-2">
                <label className="block text-[#4B5563] text-sm font-medium">
                  GST
                </label>
                <input
                  type="text"
                  name="gstin"
                  value={formData.gstin}
                  onChange={handleInputChange}
                  placeholder="Enter GSTIN (Optional)"
                  className={`text-[#545454] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border ${
                    gstinError ? "border-red-500" : "border-white/20"
                  } focus:ring-2 focus:ring-[#0e4053] outline-none placeholder-[#545454]`}
                />
                {gstinError && (
                  <p className="text-red-500 text-xs mt-1">{gstinError}</p>
                )}
              </div>
            </>
          ) : (
            <>
              {/* Organisation Name */}
              <p className="font-semibold text-[#1F2837]">
                {invoiceData.billToName}
              </p>
              {/* Address first line */}
              {invoiceData.billToAddress?.blockUnitStreetName && (
                <p className="text-[#545454]">
                  {invoiceData.billToAddress.blockUnitStreetName}
                </p>
              )}
              {/* State and City (comma separated) */}
              {(invoiceData.billToAddress?.state ||
                invoiceData.billToAddress?.city) && (
                <p className="text-[#545454]">
                  {invoiceData.billToAddress?.state}
                  {invoiceData.billToAddress?.state &&
                  invoiceData.billToAddress?.city
                    ? ", "
                    : ""}
                  {invoiceData.billToAddress?.city}
                </p>
              )}
              {/* Pincode and Country (comma separated) */}
              {(invoiceData.billToAddress?.pincode ||
                invoiceData.billToAddress?.country) && (
                <p className="text-[#545454]">
                  {invoiceData.billToAddress?.pincode}
                  {invoiceData.billToAddress?.pincode &&
                  invoiceData.billToAddress?.country
                    ? ", "
                    : ""}
                  {invoiceData.billToAddress?.country}
                </p>
              )}
              {/* Email and Phone (on separate lines) */}
              {invoiceData.billToEmail && (
                <p className="text-[#545454]">
                  Email: {invoiceData.billToEmail}
                </p>
              )}
              {invoiceData.billToPhone && (
                <p className="text-[#545454]">
                  Mobile: {invoiceData.billToPhone}
                </p>
              )}
              {/* GST number */}
              {invoiceData.billToAddress?.gstin && (
                <p className="text-[#545454]">
                  GSTIN: {invoiceData.billToAddress.gstin}
                </p>
              )}
            </>
          )}
        </div>
        <div className="w-1/2 pl-4">
          <h3 className="font-bold text-lg mb-2 text-[#4B5563]">SHIP TO</h3>
          {/* Ship To Lead Search & Dropdown */}
          {isEditMode && (
            <div className="mb-2 relative" ref={shipToDropdownRef}>
              <input
                type="text"
                placeholder="Search customer by name, email, or phone..."
                value={shipToLeadSearchTerm}
                onChange={(e) => {
                  setShipToLeadSearchTerm(e.target.value);
                  setShipToLeadDropdownOpen(true);
                }}
                onFocus={() => setShipToLeadDropdownOpen(true)}
                className="w-full px-3 py-2 rounded-[12px] border border-[#E7EFF8] bg-[#F8FAFC] text-[#545454] focus:ring-2 focus:ring-[#0e4053] outline-none mb-1"
              />
              {shipToLeadDropdownOpen && (
                <div className="absolute z-20 w-full bg-white rounded-xl shadow-2xl border border-gray-200 mt-1 max-h-72 overflow-y-auto animate-fade-in">
                  {leadsLoading ? (
                    <div className="flex flex-col items-center justify-center p-6 text-gray-500">
                      <svg
                        className="animate-spin h-6 w-6 mb-2 text-blue-400"
                        fill="none"
                        viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <circle
                          className="opacity-25"
                          cx="12"
                          cy="12"
                          r="10"
                          stroke="currentColor"
                          strokeWidth="4"
                        ></circle>
                        <path
                          className="opacity-75"
                          fill="currentColor"
                          d="M4 12a8 8 0 018-8v8z"
                        ></path>
                      </svg>
                      Loading...
                    </div>
                  ) : filteredLeads.length > 0 ? (
                    filteredLeads.map((lead, idx) => (
                      <div
                        key={lead.customer_id}
                        className="flex items-center gap-3 px-4 py-3 cursor-pointer transition-colors hover:bg-blue-50/80 group"
                        style={{
                          borderBottom:
                            idx !== filteredLeads.length - 1
                              ? "1px solid #F1F5F9"
                              : "none",
                        }}
                        onClick={() => handleShipToLeadSelect(lead)}
                      >
                        <img
                          src={lead.profile_pic}
                          alt="pic"
                          className="h-9 w-9 rounded-full object-cover border border-gray-200 shadow-sm"
                        />
                        <div className="flex flex-col flex-1 min-w-0">
                          <span className="font-semibold text-gray-800 truncate group-hover:text-blue-700">
                            {lead.customer_name}
                          </span>
                          <span className="text-xs text-gray-500 truncate">
                            {lead.email}
                          </span>
                          <span className="text-xs text-gray-400 truncate">
                            {lead.contact}
                          </span>
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="flex flex-col items-center justify-center p-6 text-gray-400">
                      <svg
                        className="h-8 w-8 mb-2"
                        fill="none"
                        stroke="currentColor"
                        strokeWidth="1.5"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-3A2.25 2.25 0 008.25 5.25V9m10.5 0A2.25 2.25 0 0121 11.25v7.5A2.25 2.25 0 0118.75 21H5.25A2.25 2.25 0 013 18.75v-7.5A2.25 2.25 0 015.25 9m13.5 0h-13.5"
                        />
                      </svg>
                      No leads found
                    </div>
                  )}
                </div>
              )}
            </div>
          )}
          {isEditMode ? (
            <>
              <div className="space-y-1">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Organisation
                </label>
                <div>
                  <input
                    type="text"
                    name="shipToName"
                    value={invoiceData.shipToName}
                    onChange={handleShipToInputChange}
                    placeholder="Enter Ship To Name"
                    className="font-semibold text-[#1F2837] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] mb-1"
                  />
                </div>
              </div>
              {/* Address */}
              <div className="space-y-1 mt-2">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Address
                </label>
                <div className="w-full rounded-[12px] border border-white/20 flex flex-col">
                  <input
                    type="text"
                    name="blockUnitStreetName"
                    value={shipToFormData.blockUnitStreetName}
                    onChange={handleShipToInputChange}
                    className="w-full h-[44px] px-3 flex items-center text-[#545454] border-b bg-[#E7EFF8]/60 border border-white/20 outline-none rounded-t-[12px]"
                    placeholder="Block/Unit/Street Name"
                  />
                  <div className="grid grid-cols-2 w-full">
                    {/* State Dropdown for Ship To */}
                    <div className="relative" ref={shipToStateDropdownRef}>
                      <input
                        type="text"
                        name="shipToStateSearch"
                        value={shipToFormData.state || shipToStateSearchTerm}
                        onChange={handleShipToStateSearchChange}
                        onFocus={() => setShipToStateDropdownOpen(true)}
                        className="w-full h-[44px] px-4 bg-[#E7EFF8]/60 border border-white/20 outline-none text-[#545454] placeholder-[#545454] text-[16px]"
                        placeholder="Select State"
                        disabled={!shipToSelectedCountryObj}
                        autoComplete="off"
                      />
                      {shipToFormData.state && isEditMode && (
                        <button
                          type="button"
                          onClick={() => {
                            setShipToFormData((prev) => ({
                              ...prev,
                              state: "",
                            }));
                            setShipToStateSearchTerm("");
                            setShipToSelectedStateObj(null);
                            setShipToFilteredCities([]);
                            setInvoiceData((prev) => ({
                              ...prev,
                              shipToState: "",
                            })); // Clear shipToState
                          }}
                          className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            className="h-4 w-4"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M6 18L18 6M6 6l12 12"
                            />
                          </svg>
                        </button>
                      )}
                      {shipToStateDropdownOpen && (
                        <div className="absolute z-10 w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                          {shipToFilteredStates.length > 0 ? (
                            shipToFilteredStates.map((state) => (
                              <div
                                key={state.isoCode}
                                className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                onClick={() => handleShipToStateSelect(state)}
                                onMouseDown={(e) => e.preventDefault()}
                              >
                                {state.name}
                              </div>
                            ))
                          ) : (
                            <div className="p-3 text-gray-500">
                              No states found
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                    {/* City Dropdown for Ship To */}
                    <div className="relative" ref={shipToCityDropdownRef}>
                      <input
                        type="text"
                        name="shipToCitySearch"
                        value={shipToFormData.city || shipToCitySearchTerm}
                        onChange={handleShipToCitySearchChange}
                        onFocus={() => setShipToCityDropdownOpen(true)}
                        className="w-full h-[44px] px-4 bg-[#E7EFF8]/60 border border-white/20 outline-none text-[#545454] placeholder-[#545454] text-[16px]"
                        placeholder="Select City"
                        disabled={!shipToSelectedStateObj}
                        autoComplete="off"
                      />
                      {shipToFormData.city && isEditMode && (
                        <button
                          type="button"
                          onClick={() => {
                            setShipToFormData((prev) => ({
                              ...prev,
                              city: "",
                            }));
                            setShipToCitySearchTerm("");
                          }}
                          className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            className="h-4 w-4"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M6 18L18 6M6 6l12 12"
                            />
                          </svg>
                        </button>
                      )}
                      {shipToCityDropdownOpen && (
                        <div className="absolute z-10 w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                          {shipToFilteredCities.length > 0 ? (
                            shipToFilteredCities.map((city) => (
                              <div
                                key={city.name}
                                className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                onClick={() => handleShipToCitySelect(city)}
                                onMouseDown={(e) => e.preventDefault()}
                              >
                                {city.name}
                              </div>
                            ))
                          ) : (
                            <div className="p-3 text-gray-500">
                              No cities found
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                  <div className="grid grid-cols-2 w-full">
                    {/* Pincode Input for Ship To */}
                    <input
                      type="text"
                      name="pincode"
                      value={shipToFormData.pincode}
                      onChange={handleShipToInputChange}
                      className="w-full h-[44px] px-3 flex items-center text-[#545454] bg-[#E7EFF8]/60 border border-white/20 rounded-bl-[12px] outline-none"
                      placeholder="Pincode"
                    />
                    {/* Country Dropdown for Ship To */}
                    <div className="relative" ref={shipToCountryDropdownRef}>
                      <input
                        type="text"
                        name="shipToCountrySearch"
                        value={
                          shipToFormData.country || shipToCountrySearchTerm
                        }
                        onChange={handleShipToCountrySearchChange}
                        onFocus={() => setShipToCountryDropdownOpen(true)}
                        className="w-full h-[44px] px-4 bg-[#E7EFF8]/60 border border-white/20 outline-none text-[#545454] placeholder-[#545454] rounded-br-[12px] text-[16px]"
                        placeholder="Select Country"
                        autoComplete="off"
                      />
                      {shipToFormData.country && isEditMode && (
                        <button
                          type="button"
                          onClick={() => {
                            setShipToFormData((prev) => ({
                              ...prev,
                              country: "",
                              state: "",
                              city: "",
                            }));
                            setShipToCountrySearchTerm("");
                            setShipToSelectedCountryObj(null);
                            setShipToSelectedStateObj(null);
                            setShipToFilteredStates([]);
                            setShipToFilteredCities([]);
                            setInvoiceData((prev) => ({
                              ...prev,
                              shipToState: "",
                            })); // Clear shipToState
                          }}
                          className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            className="h-4 w-4"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth="2"
                              d="M6 18L18 6M6 6l12 12"
                            />
                          </svg>
                        </button>
                      )}
                      {shipToCountryDropdownOpen && (
                        <div className="absolute z-10 w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                          {shipToFilteredCountries.length > 0 ? (
                            shipToFilteredCountries.map((country) => (
                              <div
                                key={country.isoCode}
                                className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                onClick={() =>
                                  handleShipToCountrySelect(country)
                                }
                                onMouseDown={(e) => e.preventDefault()}
                              >
                                {country.name}
                              </div>
                            ))
                          ) : (
                            <div className="p-3 text-gray-500">
                              No countries found
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>

              <div className="space-y-1 mt-2">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Contact
                </label>
                <div>
                  <div className="flex gap-2">
                    <input
                      type="text"
                      name="shipToPhone"
                      value={invoiceData.shipToPhone}
                      onChange={handleShipToInputChange}
                      placeholder="Enter Ship To Phone"
                      className="text-[#545454] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none placeholder-[#545454]"
                    />
                    <input
                      type="email"
                      name="shipToEmail"
                      value={invoiceData.shipToEmail}
                      onChange={handleShipToInputChange}
                      placeholder="Enter Ship To Email"
                      className="text-[#545454] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none placeholder-[#545454]"
                    />
                  </div>
                </div>
              </div>

              <div className="space-y-1 mt-2">
                <label className="block text-[#4B5563] text-sm font-medium">
                  GST
                </label>
                <input
                  type="text"
                  name="gstin"
                  value={shipToFormData.gstin}
                  onChange={handleShipToInputChange}
                  placeholder="Enter GSTIN (Optional)"
                  className={`text-[#545454] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border ${
                    shipToGstinError ? "border-red-500" : "border-white/20"
                  } focus:ring-2 focus:ring-[#0e4053] outline-none placeholder-[#545454]`}
                />
                {shipToGstinError && (
                  <p className="text-red-500 text-xs mt-1">
                    {shipToGstinError}
                  </p>
                )}
              </div>
            </>
          ) : (
            <>
              {/* Organisation Name */}
              <p className="font-semibold text-[#1F2837]">
                {invoiceData.shipToName}
              </p>
              {/* Address first line */}
              {invoiceData.shipToAddress?.blockUnitStreetName && (
                <p className="text-[#545454]">
                  {invoiceData.shipToAddress.blockUnitStreetName}
                </p>
              )}
              {/* State and City (comma separated) */}
              {(invoiceData.shipToAddress?.state ||
                invoiceData.shipToAddress?.city) && (
                <p className="text-[#545454]">
                  {invoiceData.shipToAddress?.state}
                  {invoiceData.shipToAddress?.state &&
                  invoiceData.shipToAddress?.city
                    ? ", "
                    : ""}
                  {invoiceData.shipToAddress?.city}
                </p>
              )}
              {/* Pincode and Country (comma separated) */}
              {(invoiceData.shipToAddress?.pincode ||
                invoiceData.shipToAddress?.country) && (
                <p className="text-[#545454]">
                  {invoiceData.shipToAddress?.pincode}
                  {invoiceData.shipToAddress?.pincode &&
                  invoiceData.shipToAddress?.country
                    ? ", "
                    : ""}
                  {invoiceData.shipToAddress?.country}
                </p>
              )}
              {/* Email and Phone (on separate lines) */}
              {invoiceData.shipToEmail && (
                <p className="text-[#545454]">
                  Email: {invoiceData.shipToEmail}
                </p>
              )}
              {invoiceData.shipToPhone && (
                <p className="text-[#545454]">
                  Mobile: {invoiceData.shipToPhone}
                </p>
              )}
              {/* GST number */}
              {invoiceData.shipToAddress?.gstin && (
                <p className="text-[#545454]">
                  GSTIN: {invoiceData.shipToAddress.gstin}
                </p>
              )}
            </>
          )}
        </div>
      </div>

      {/* Items Table */}
      <div className="mb-8">
        <table className="w-full border-collapse table-fixed">
          <thead>
            <tr className="bg-[#E7EFF8]/30 text-left text-[#4B5563]">
              <th className="border border-[#E5E7EB] p-2 text-left w-1/2 font-medium text-sm">
                ITEMS
              </th>
              <th
                className={`border border-[#E5E7EB] p-2 text-center font-medium text-sm ${
                  isEditMode ? "w-1/10" : ""
                }`}
              >
                QTY
              </th>
              <th
                className={`border border-[#E5E7EB] p-2 text-center font-medium text-sm ${
                  isEditMode ? "w-20" : "w-1/6"
                }`}
              >
                RATE
              </th>
              <th
                className={`border border-[#E5E7EB] p-2 text-center font-medium text-sm ${
                  isEditMode ? "w-1/10" : ""
                }`}
              >
                GST
              </th>
              <th className="border border-[#E5E7EB] p-2 text-right font-medium text-sm w-20">
                AMOUNT
              </th>
              {isEditMode && (
                <th className="border border-[#E5E7EB] p-0 text-center font-medium text-sm w-6"></th>
              )}
            </tr>
          </thead>
          <tbody>
            {serviceItems.map((item, index) => (
              <tr key={index} className={isEditMode ? "group relative" : ""}>
                <td className="border border-[#E5E7EB] p-2 text-[#545454] align-middle">
                  {isEditMode ? (
                    <textarea
                      value={item.description}
                      onChange={(e) =>
                        handleServiceItemChange(
                          index,
                          "description",
                          e.target.value
                        )
                      }
                      placeholder="Enter Description"
                      className="w-full min-h-[44px] px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] resize-y"
                      style={{ resize: "vertical" }}
                    />
                  ) : (
                    item.description
                  )}
                </td>
                <td
                  className={`border border-[#E5E7EB] p-2 text-center text-[#545454] align-middle ${
                    isEditMode ? "w-1/10" : ""
                  }`}
                >
                  {isEditMode ? (
                    <input
                      type="number"
                      value={item.quantity}
                      onChange={(e) =>
                        handleServiceItemChange(
                          index,
                          "quantity",
                          e.target.value
                        )
                      }
                      placeholder="0"
                      className="w-full text-xs px-3 py-2 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] text-center"
                    />
                  ) : (
                    item.quantity
                  )}
                </td>
                <td
                  className={`border border-[#E5E7EB] p-2 text-right text-[#545454] align-middle ${
                    isEditMode ? "w-3/20" : "w-1/6"
                  }`}
                >
                  {isEditMode ? (
                    <input
                      type="number"
                      value={item.rate}
                      onChange={(e) =>
                        handleServiceItemChange(index, "rate", e.target.value)
                      }
                      placeholder="0"
                      className="w-full px-3 py-2 text-xs rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] text-right"
                    />
                  ) : (
                    item.rate
                  )}
                </td>
                <td
                  className={`border border-[#E5E7EB] p-2 text-center text-[#545454] align-middle ${
                    isEditMode ? "w-1/10" : ""
                  }`}
                >
                  {isEditMode ? (
                    <input
                      type="number"
                      value={item.taxRate}
                      onChange={(e) =>
                        handleServiceItemChange(
                          index,
                          "taxRate",
                          e.target.value
                        )
                      }
                      placeholder="0"
                      className="w-full px-3 py-2 rounded-[12px] text-xs bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] text-center"
                    />
                  ) : (
                    item.taxRate
                  )}
                </td>
                <td className="border border-[#E5E7EB] p-2 text-right text-[#545454] align-middle w-1/12">
                  {isEditMode ? (
                    <input
                      type="number"
                      value={
                        editedServiceItemAmounts[index] !== undefined &&
                        editedServiceItemAmounts[index] !== null
                          ? editedServiceItemAmounts[index]
                          : item.amount
                      }
                      onChange={(e) =>
                        handleEditedItemAmountChange(index, e.target.value)
                      }
                      placeholder="0"
                      className="w-full px-3 py-2 rounded-[12px] text-xs bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] text-right"
                    />
                  ) : (
                    item.amount
                  )}
                </td>
                {isEditMode && (
                  <td className="border border-[#E5E7EB] p-0 text-center align-middle w-6">
                    <button
                      onClick={() => removeServiceItem(index)}
                      className="flex items-center justify-center w-6 h-6 rounded-full hover:bg-red-100"
                      title="Delete"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        strokeWidth={2}
                        stroke="currentColor"
                        className="w-4 h-4 text-red-500 group-hover:text-red-700"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          d="M6 18L18 6M6 6l12 12"
                        />
                      </svg>
                    </button>
                  </td>
                )}
              </tr>
            ))}
            {isEditMode && (
              <tr>
                <td colSpan="6" className="p-2">
                  <button
                    onClick={addServiceItem}
                    className="h-[44px] px-10 rounded-[12px] bg-[#ef7e1b] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-white w-full"
                  >
                    Add Item
                  </button>
                </td>
              </tr>
            )}
            <tr>
              <td
                className="border border-[#E5E7EB] py-2 px-2 text-right font-bold text-[#1F2837] leading-tight h-6"
                colSpan={isEditMode ? "3" : "4"}
              >
                SUB TOTAL
              </td>
              <td
                className="border border-[#E5E7EB] py-0.5 px-2 text-right font-bold text-[#1F2837] leading-tight h-6"
                colSpan={isEditMode ? "2" : "1"}
              >
                {isEditMode ? (
                  <input
                    type="number"
                    value={
                      editedSubTotal !== null
                        ? editedSubTotal
                        : calculateSubTotal()
                    }
                    onChange={(e) =>
                      handleEditedTotalChange("subTotal", e.target.value)
                    }
                    placeholder="0"
                    className="w-full px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] text-right"
                  />
                ) : (
                  calculateSubTotal()
                )}
              </td>
              {isEditMode && <td className="border-none"></td>}
            </tr>
            <tr>
              <td
                className="border border-[#E5E7EB] py-0.5 px-2 text-right text-[0.625rem] font-medium text-[#1F2837] leading-tight h-6"
                colSpan={isEditMode ? "4" : "4"}
              >
                {isEditMode ? (
                  <input
                    type="text"
                    value={
                      editedCgstLabel !== null ? editedCgstLabel : "CGST AMOUNT"
                    }
                    onChange={(e) =>
                      handleEditedGstLabelChange("cgstLabel", e.target.value)
                    }
                    className="text-right  bg-transparent border-none outline-none font-medium text-[0.625rem] text-[#1F2837] w-24"
                  />
                ) : (
                  <span>CGST AMOUNT</span>
                )}
                {serviceItems.length > 0 &&
                  (isEditMode ? (
                    <input
                      type="number"
                      value={
                        editedCgstPercentage !== null
                          ? editedCgstPercentage
                          : ""
                      }
                      onChange={(e) =>
                        handleEditedGstPercentageChange(
                          "cgstPercentage",
                          e.target.value
                        )
                      }
                      className="ml-1 text-right bg-transparent border-none outline-none text-[0.625rem] font-medium text-[#1F2837] w-8"
                    />
                  ) : (
                    <span className="ml-1"></span>
                  ))}
              </td>
              <td className="border border-[#E5E7EB] py-0.5 px-2 text-right  text-[#1F2837] leading-tight h-6">
                {isEditMode ? (
                  <input
                    type="number"
                    value={
                      editedCgstTotal !== null
                        ? editedCgstTotal
                        : calculateCgstTotal()
                    }
                    onChange={(e) =>
                      handleEditedTotalChange("cgstTotal", e.target.value)
                    }
                    placeholder="0"
                    className="w-full px-3 py-1 text-xs rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] text-right"
                  />
                ) : (
                  calculateCgstTotal()
                )}
              </td>
              {isEditMode && <td className="border-none"></td>}
            </tr>
            <tr>
              <td
                className="border border-[#E5E7EB] py-0.5 px-2 text-right text-[0.625rem] font-medium text-[#1F2837] leading-tight h-6"
                colSpan={isEditMode ? "4" : "4"}
              >
                {isEditMode ? (
                  <input
                    type="text"
                    value={
                      editedSgstLabel !== null ? editedSgstLabel : "SGST AMOUNT"
                    }
                    onChange={(e) =>
                      handleEditedGstLabelChange("sgstLabel", e.target.value)
                    }
                    className="text-right bg-transparent border-none outline-none font-medium text-[0.625rem] text-[#1F2837] w-24"
                  />
                ) : (
                  <span>SGST AMOUNT</span>
                )}
                {serviceItems.length > 0 &&
                  (isEditMode ? (
                    <input
                      type="number"
                      value={
                        editedSgstPercentage !== null
                          ? editedSgstPercentage
                          : ""
                      }
                      onChange={(e) =>
                        handleEditedGstPercentageChange(
                          "sgstPercentage",
                          e.target.value
                        )
                      }
                      className="ml-1 text-right bg-transparent border-none outline-none text-[0.625rem] font-medium text-[#1F2837] w-8"
                    />
                  ) : (
                    <span className="ml-1"></span>
                  ))}
              </td>
              <td className="border border-[#E5E7EB] py-0.5 px-2 text-right  text-[#1F2837] leading-tight h-6">
                {isEditMode ? (
                  <input
                    type="number"
                    value={
                      editedSgstTotal !== null
                        ? editedSgstTotal
                        : calculateSgstTotal()
                    }
                    onChange={(e) =>
                      handleEditedTotalChange("sgstTotal", e.target.value)
                    }
                    placeholder="0"
                    className="w-full px-3 py-1 text-xs rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] text-right"
                  />
                ) : (
                  calculateSgstTotal()
                )}
              </td>
              {isEditMode && <td className="border-none"></td>}
            </tr>
            <tr>
              <td
                className="border border-[#E5E7EB] py-0.5 px-2 text-right font-medium text-[0.625rem] text-[#1F2837] leading-tight h-6"
                colSpan={isEditMode ? "4" : "4"}
              >
                {isEditMode ? (
                  <input
                    type="text"
                    value={
                      editedIgstLabel !== null ? editedIgstLabel : "IGST AMOUNT"
                    }
                    onChange={(e) =>
                      handleEditedGstLabelChange("igstLabel", e.target.value)
                    }
                    className="text-right bg-transparent border-none outline-none font-medium text-[0.625rem] text-[#1F2837] w-24"
                  />
                ) : (
                  <span>IGST AMOUNT</span>
                )}
                {serviceItems.length > 0 &&
                  (isEditMode ? (
                    <input
                      type="number"
                      value={
                        editedIgstPercentage !== null
                          ? editedIgstPercentage
                          : ""
                      }
                      onChange={(e) =>
                        handleEditedGstPercentageChange(
                          "igstPercentage",
                          e.target.value
                        )
                      }
                      className="ml-1 text-right bg-transparent border-none outline-none text-[0.625rem] font-medium text-[#1F2837] w-8"
                    />
                  ) : (
                    <span className="ml-1"></span>
                  ))}
              </td>
              <td className="border border-[#E5E7EB] py-0.5 px-2 text-right  text-[#1F2837] leading-tight h-6">
                {isEditMode ? (
                  <input
                    type="number"
                    value={
                      editedIgstTotal !== null
                        ? editedIgstTotal
                        : calculateIgstTotal()
                    }
                    onChange={(e) =>
                      handleEditedTotalChange("igstTotal", e.target.value)
                    }
                    placeholder="0"
                    className="w-full px-3 py-1 text-xs rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] text-right"
                  />
                ) : (
                  calculateIgstTotal()
                )}
              </td>
              {isEditMode && <td className="border-none"></td>}
            </tr>
          </tbody>
        </table>
      </div>

      {/* Bank Details and Totals */}
      <div className="flex justify-between mb-8 text-sm text-[#4B5563]">
        <div className="w-1/2 pr-4">
          <div className="flex mb-1">
            <span className="w-32 font-semibold">Bank Name:</span>
            {isEditMode ? (
              <input
                type="text"
                name="bankName"
                value={invoiceData.bankName}
                onChange={handleInputChange}
                placeholder="Enter Bank Name"
                className="flex-grow px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
              />
            ) : (
              <span className="text-[#545454]">{invoiceData.bankName}</span>
            )}
          </div>
          <div className="flex mb-1">
            <span className="w-32 font-semibold">Account Name:</span>
            {isEditMode ? (
              <input
                type="text"
                name="accountName"
                value={invoiceData.accountName}
                onChange={handleInputChange}
                placeholder="Enter Account Name"
                className="flex-grow px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
              />
            ) : (
              <span className="text-[#545454]">{invoiceData.accountName}</span>
            )}
          </div>
          <div className="flex mb-1">
            <span className="w-32 font-semibold">IFSC Code:</span>
            {isEditMode ? (
              <input
                type="text"
                name="ifscCode"
                value={invoiceData.ifscCode}
                onChange={handleInputChange}
                placeholder="Enter IFSC Code"
                className="flex-grow px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
              />
            ) : (
              <span className="text-[#545454]">{invoiceData.ifscCode}</span>
            )}
          </div>
          <div className="flex mb-1">
            <span className="w-32 font-semibold">Account No:</span>
            {isEditMode ? (
              <input
                type="text"
                name="accountNo"
                value={invoiceData.accountNo}
                onChange={handleInputChange}
                placeholder="Enter Account No."
                className="flex-grow px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
              />
            ) : (
              <span className="text-[#545454]">{invoiceData.accountNo}</span>
            )}
          </div>
          <div className="flex mb-1">
            <span className="w-32 font-semibold">Bank Branch:</span>
            {isEditMode ? (
              <input
                type="text"
                name="bankBranch"
                value={invoiceData.bankBranch}
                onChange={handleInputChange}
                placeholder="Enter Bank Branch"
                className="flex-grow px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
              />
            ) : (
              <span className="text-[#545454]">{invoiceData.bankBranch}</span>
            )}
          </div>
        </div>
        <div className="w-1/2 pl-4 text-right">
          <div className="flex justify-end items-center mb-2">
            <span className="font-bold mr-4 text-[#1F2837]">GRAND TOTAL</span>
            {isEditMode ? (
              <input
                type="number"
                value={displayedGrandTotal}
                onChange={(e) =>
                  handleEditedOverallTotalChange("grandTotal", e.target.value)
                }
                placeholder="0"
                className="border-b border-[#E5E7EB] text-xs pb-1 w-24 text-right font-bold text-[#1F2837] px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
              />
            ) : (
              <span className="border-b border-[#E5E7EB] pb-1 w-24 text-right font-bold text-[#1F2837]">
                {displayedGrandTotal}
              </span>
            )}
          </div>
          <div className="flex justify-end items-center mb-2">
            <span className="font-bold mr-4 text-[#1F2837]">
              Received Amount
            </span>
            {isEditMode ? (
              <input
                type="number"
                name="receivedAmount"
                value={receivedAmount}
                onChange={(e) =>
                  setReceivedAmount(parseFloat(e.target.value) || 0)
                }
                placeholder="0"
                className="border-b border-[#E5E7EB] text-xs pb-1 w-24 text-right text-[#545454] px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none placeholder-[#545454]"
              />
            ) : (
              <span className="border-b border-[#E5E7EB] pb-1 w-24 text-right text-[#545454]">
                {receivedAmount}
              </span>
            )}
          </div>
          <div className="flex justify-end items-center">
            <span className="font-bold mr-4 text-[#1F2837]">Balance</span>
            {isEditMode ? (
              <input
                type="number"
                value={displayedBalance}
                onChange={(e) =>
                  handleEditedOverallTotalChange("balance", e.target.value)
                }
                placeholder="0"
                className="border-b border-[#E5E7EB] pb-1 text-xs w-24 text-right text-[#545454] px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none placeholder-[#545454]"
              />
            ) : (
              <span className="border-b border-[#E5E7EB] pb-1 w-24 text-right text-[#545454]">
                {displayedBalance}
              </span>
            )}
          </div>
        </div>
      </div>

      {/* Terms and Conditions and Signature */}
      <div className="flex justify-between items-end">
        <div className="w-1/2 text-sm pr-4 text-[#4B5563]">
          <h3 className="font-bold mb-2">TERMS AND CONDITIONS:</h3>
          <ol className="list-decimal list-outside space-y-1 pl-5 text-xs">
            {isEditMode ? (
              <>
                {invoiceData.termsAndConditions.map((term, index) => (
                  <li key={index}>
                    <textarea
                      value={term}
                      onChange={(e) => {
                        const newTerms = [...invoiceData.termsAndConditions];
                        newTerms[index] = e.target.value;
                        setInvoiceData((prev) => ({
                          ...prev,
                          termsAndConditions: newTerms,
                        }));
                        autoResizeTextarea(e); // Call auto-resize function
                      }}
                      onInput={autoResizeTextarea} // Auto-resize on initial load and input
                      placeholder="Enter Term"
                      className="w-full px-3 py-1 overflow-y-hidden rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] resize-y terms-textarea"
                    />
                  </li>
                ))}
                <li>
                  <button
                    onClick={() =>
                      setInvoiceData((prev) => ({
                        ...prev,
                        termsAndConditions: [...prev.termsAndConditions, ""],
                      }))
                    }
                    className="text-blue-500 hover:text-blue-700 mt-2"
                  >
                    Add Term
                  </button>
                </li>
              </>
            ) : (
              invoiceData.termsAndConditions.map((term, index) => (
                <li key={index}>{term}</li>
              ))
            )}
          </ol>
        </div>
        <div className="w-1/2 text-center pl-4">
          {invoiceData.upload_seal && (
            <img
              src={invoiceData.upload_seal}
              alt="Authorised Seal"
              className="mx-auto mb-2 h-20"
            />
          )}
          <p className="font-bold text-[#1F2837]">AUTHORISED SIGNATORY FOR</p>
          {isEditMode ? (
            <input
              type="text"
              name="authorisedSignatory"
              value={invoiceData.authorisedSignatory}
              onChange={handleInputChange}
              placeholder="Enter Authorised Signatory"
              className="text-[#545454] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none placeholder-[#545454]"
            />
          ) : (
            <p className="text-[#545454]">{invoiceData.authorisedSignatory}</p>
          )}
        </div>
      </div>

      {/* Calculation Breakdown (Edit Mode Only) */}
      {isEditMode && (
        <div className="mt-9 p-3 bg-[#F8FAFC] rounded-xl border border-[#E7EFF8] text-xs text-[#545454]">
          <h3 className="font-bold mb-2 text-base text-[#1F2837]">
            Calculation Breakdown
          </h3>
          <div className="space-y-2">
            {serviceItems.map((item, index) => {
              const baseAmount = item.quantity * item.rate;
              const halfTaxRate = item.taxRate / 2;
              const companyStateClean = invoiceData.companyState
                ? invoiceData.companyState.toLowerCase().trim()
                : "";
              const billToStateClean = invoiceData.billToState
                ? invoiceData.billToState.toLowerCase().trim()
                : "";

              return (
                <div
                  key={index}
                  className="border-b border-[#E7EFF8] pb-2 mb-2 last:border-b-0 last:pb-0 last:mb-0"
                >
                  <p className="font-semibold mb-1 text-sm">
                    Item {index + 1}: {item.description || "New Item"}
                  </p>
                  <div className="flex justify-between items-center">
                    <span>
                      Base Amount: {item.quantity} (Qty) x {item.rate} (Rate)
                    </span>
                    <span className="font-medium">
                      = {baseAmount.toFixed(2)}
                    </span>
                  </div>
                  {companyStateClean === billToStateClean ? (
                    <>
                      <div className="flex justify-between items-center pl-4">
                        <span>
                          CGST ({halfTaxRate.toFixed(2)}%):{" "}
                          {baseAmount.toFixed(2)} x {halfTaxRate.toFixed(2)}%
                        </span>
                        <span className="font-medium">
                          = {item.cgstAmount.toFixed(2)}
                        </span>
                      </div>
                      <div className="flex justify-between items-center pl-4">
                        <span>
                          SGST ({halfTaxRate.toFixed(2)}%):{" "}
                          {baseAmount.toFixed(2)} x {halfTaxRate.toFixed(2)}%
                        </span>
                        <span className="font-medium">
                          = {item.sgstAmount.toFixed(2)}
                        </span>
                      </div>
                    </>
                  ) : (
                    <div className="flex justify-between items-center pl-4">
                      <span>
                        IGST ({item.taxRate.toFixed(2)}%):{" "}
                        {baseAmount.toFixed(2)} x {item.taxRate.toFixed(2)}%
                      </span>
                      <span className="font-medium">
                        = {item.igstAmount.toFixed(2)}
                      </span>
                    </div>
                  )}
                  <div className="flex justify-between items-center font-medium mt-1 pt-1 border-t border-gray-200">
                    <span>
                      Total for item: {baseAmount.toFixed(2)} +{" "}
                      {item.taxAmount.toFixed(2)} (GST)
                    </span>
                    <span className="text-[#1F2837]">
                      = {item.amount.toFixed(2)}
                    </span>
                  </div>
                </div>
              );
            })}

            <div className="pt-3 border-t border-[#E7EFF8] space-y-1 mt-3">
              <div className="flex justify-between items-center">
                <span className="font-semibold">Overall Subtotal:</span>
                <span className="text-[#1F2837]">
                  {calculateSubTotal().toFixed(2)}
                </span>
              </div>
              <div className="flex justify-between items-center">
                <span className="font-semibold">Overall CGST:</span>
                <span className="text-[#1F2837]">
                  {calculateCgstTotal().toFixed(2)}
                </span>
              </div>
              <div className="flex justify-between items-center">
                <span className="font-semibold">Overall SGST:</span>
                <span className="text-[#1F2837]">
                  {calculateSgstTotal().toFixed(2)}
                </span>
              </div>
              <div className="flex justify-between items-center">
                <span className="font-semibold">Overall IGST:</span>
                <span className="text-[#1F2837]">
                  {calculateIgstTotal().toFixed(2)}
                </span>
              </div>
              <div className="flex justify-between items-center pt-2 border-t border-gray-300">
                <span className="font-bold text-[#1F2837]">Grand Total:</span>
                <span className="font-bold text-[#1F2837]">
                  {displayedGrandTotal.toFixed(2)}
                </span>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Action Buttons */}
      <div className="flex flex-col sm:flex-row justify-between items-center gap-4 mt-14">
        <div className="flex flex-col sm:flex-row gap-2 sm:gap-[10px] w-full sm:w-auto">
          {isEditMode ? (
            <>
              <button
                onClick={toggleMode}
                className="w-full sm:w-[150px] h-[40px] border border-[rgb(39,152,255)] rounded-[10px] text-[rgb(39,152,255)] text-[16px] font-semibold flex items-center justify-center hover:text-white hover:bg-[rgb(39,152,255)] mb-3"
              >
                Exit Edit Mode
              </button>
              <button
                onClick={saveChanges}
                className="w-full sm:w-[150px] h-[40px] bg-[rgb(39,152,255)] rounded-[10px] text-white text-[16px] font-semibold flex items-center justify-center hover:bg-[#ee7f1b]"
              >
                Save Changes
              </button>
            </>
          ) : (
            <>
              <button
                onClick={toggleMode}
                className="w-full sm:w-[150px] h-[40px] border border-[rgb(39,152,255)] rounded-[10px] text-[rgb(39,152,255)] text-[16px] font-semibold flex items-center justify-center hover:text-white hover:bg-[rgb(39,152,255)]"
              >
                Enter Edit Mode
              </button>
              <button
                onClick={submitInvoice}
                className="w-full sm:w-[150px] h-[40px] bg-[rgb(39,152,255)] rounded-[10px] text-white text-[16px] font-semibold flex items-center justify-center hover:bg-[#ee7f1b]"
              >
                Submit Invoice
              </button>
            </>
          )}
        </div>

        {!isEditMode && (
          <PDFDownloadLink
            document={
              <InvoicePDF
                invoiceData={invoiceData}
                serviceItems={serviceItems}
                organizationEmail={organizationEmail}
                user={user}
              />
            }
            fileName={`invoice-${invoiceData.invoiceNo || "export"}.pdf`}
            style={{ textDecoration: "none" }}
          >
            {({ loading }) =>
              loading ? (
                <div className="hidden lg:flex justify-end items-center hover:bg-gray-100 p-4 rounded-full">
                  <p className="mr-4 text-[#8B8B8B] text-sm">
                    Generating PDF...
                  </p>
                </div>
              ) : (
                <div className="hidden lg:flex justify-end items-center hover:bg-gray-100 p-4 rounded-full">
                  <p className="mr-4 text-[#8B8B8B] text-sm">Export to</p>
                  <svg
                    width="30"
                    height="30"
                    viewBox="0 0 100 100"
                    fill="#727A90"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M12.5 90.625H21.875V100H12.5C5.60547 100 0 94.3945 0 87.5V12.5C0 5.60547 5.60547 0 12.5 0H44.8242C48.1445 0 51.3281 1.30859 53.6719 3.65234L71.3477 21.3281C73.6914 23.6719 75 26.8555 75 30.1758V59.375H65.625V31.25H50C46.543 31.25 43.75 28.457 43.75 25V9.375H12.5C10.7812 9.375 9.375 10.7812 9.375 12.5V87.5C9.375 89.2188 10.7812 90.625 12.5 90.625ZM34.375 68.75H40.625C46.6602 68.75 51.5625 73.6523 51.5625 79.6875C51.5625 85.7227 46.6602 90.625 40.625 90.625H37.5V96.875C37.5 98.5938 36.0938 100 34.375 100C32.6562 100 31.25 98.5938 31.25 96.875V71.875C31.25 70.1562 32.6562 68.75 34.375 68.75ZM40.625 84.375C43.2227 84.375 45.3125 82.2852 45.3125 79.6875C45.3125 77.0898 43.2227 75 40.625 75H37.5V84.375H40.625ZM59.375 68.75H65.625C70.8008 68.75 75 72.9492 75 78.125V90.625C75 95.8008 70.8008 100 65.625 100H59.375C57.6562 100 56.25 98.5938 56.25 96.875V71.875C56.25 70.1562 57.6562 68.75 59.375 68.75ZM65.625 93.75C67.3438 93.75 68.75 92.3438 68.75 90.625V78.125C68.75 76.4062 67.3438 75 65.625 75H62.5V93.75H65.625ZM81.25 71.875C81.25 70.1562 82.6562 68.75 84.375 68.75H93.75C95.4688 68.75 96.875 70.1562 96.875 71.875C96.875 73.5938 95.4688 75 93.75 75H87.5V81.25H93.75C95.4688 81.25 96.875 82.6562 96.875 84.375C96.875 86.0938 95.4688 87.5 93.75 87.5H87.5V96.875C87.5 98.5938 86.0938 100 84.375 100C82.6562 100 81.25 98.5938 81.25 96.875V71.875Z"
                      fill="#727A90"
                    />
                  </svg>
                </div>
              )
            }
          </PDFDownloadLink>
        )}
      </div>
    </div>
  );
};

export default invoiceComponent;
</file>

<file path="src/pages/logout/logout.jsx">
// src/pages/logout/logout.jsx
import { useEffect } from 'react';
import { useAuth } from '../../auth/AuthContext';

export default function Logout() {
  const { logout } = useAuth();
  useEffect(() => { logout(); }, [logout]);
  return null; // or a loader/spinner while redirecting
}
</file>

<file path="src/pages/payment/CreatePayment.jsx">
import React from 'react'

const CreatePayment = () => {
  return (
    <div>CreatePayment</div>
  )
}

export default CreatePayment
</file>

<file path="src/pages/payment/ViewPayment.jsx">
import React from 'react'

const ViewPayment = () => {
  return (
    <div>ViewPayment</div>
  )
}

export default ViewPayment
</file>

<file path="src/pages/settings/UpdateProfile.jsx">
import React, { useState, useEffect, useRef, useMemo } from "react";
import { useAuth } from "../../auth/AuthContext"; // adjust path as needed
import api from "../../api";
import Swal from "sweetalert2";
import { Country, State, City } from "country-state-city";

const EditIcon = (props) => (
  <svg
    width="22"
    height="22"
    viewBox="0 0 22 22"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
    {...props}
  >
    <rect width="22" height="22" rx="3" fill="#2798FF" />
    <path
      d="M2.75 19.25V15.3542L14.85 3.27708C15.0334 3.10903 15.2359 2.97917 15.4578 2.8875C15.6796 2.79583 15.9124 2.75 16.1563 2.75C16.4001 2.75 16.6369 2.79583 16.8667 2.8875C17.0965 2.97917 17.2951 3.11667 17.4625 3.3L18.7229 4.58334C18.9063 4.75139 19.0401 4.95 19.1244 5.17917C19.2088 5.40834 19.2506 5.6375 19.25 5.86667C19.25 6.11112 19.2082 6.34426 19.1244 6.56609C19.0407 6.78792 18.9069 6.9902 18.7229 7.17292L6.64584 19.25H2.75ZM16.1334 7.15001L17.4167 5.86667L16.1334 4.58334L14.85 5.86667L16.1334 7.15001Z"
      fill="white"
    />
  </svg>
);

const UpdateProfile = () => {
  const { user, updateUser } = useAuth();

  console.log(JSON.stringify(user), "user saved in context is here");
  // State for profile fields
  const [profileData, setProfileData] = useState({
    name: "",
    email: "",
    contact: "",
    address: "",
    pincode: "",
    avatar: null, // File object if user chooses a new file
  });
  const [avatarPreview, setAvatarPreview] = useState(null);

  // State for change-password section (unchanged)
  const [passwordFormData, setPasswordFormData] = useState({
    currentPassword: "",
    newPassword: "",
    newPasswordConfirmation: "",
  });

  // Optional: error/success state if you display inline messages
  const [error, setError] = useState("");
  const [success, setSuccess] = useState("");

  // Country, State, City state variables
  const [countries, setCountries] = useState([]);
  const [states, setStates] = useState([]);
  const [cities, setCities] = useState([]);
  const [selectedCountryObj, setSelectedCountryObj] = useState(null);
  const [selectedStateObj, setSelectedStateObj] = useState(null);
  const [selectedCityObj, setSelectedCityObj] = useState(null);

  const [countrySearchTerm, setCountrySearchTerm] = useState("");
  const [stateSearchTerm, setStateSearchTerm] = useState("");
  const [citySearchTerm, setCitySearchTerm] = useState("");

  const [countryDropdownOpen, setCountryDropdownOpen] = useState(false);
  const [stateDropdownOpen, setStateDropdownOpen] = useState(false);
  const [cityDropdownOpen, setCityDropdownOpen] = useState(false);

  const countryDropdownRef = useRef(null);
  const stateDropdownRef = useRef(null);
  const cityDropdownRef = useRef(null);

  // Filtered lists for country, state, city
  const filteredCountries = useMemo(
    () =>
      countries.filter((country) =>
        country.name.toLowerCase().includes(countrySearchTerm.toLowerCase())
      ),
    [countries, countrySearchTerm]
  );

  const filteredStates = useMemo(
    () =>
      states.filter((state) =>
        state.name.toLowerCase().includes(stateSearchTerm.toLowerCase())
      ),
    [states, stateSearchTerm]
  );

  const filteredCities = useMemo(
    () =>
      cities.filter((city) =>
        city.name.toLowerCase().includes(citySearchTerm.toLowerCase())
      ),
    [cities, citySearchTerm]
  );

  // 1. Populate profile form when `user` becomes available
  useEffect(() => {
    if (user) {
      setProfileData({
        name: user.username || "",
        email: user.email || "",
        // If your API uses `contact` or `phoneno`, pick accordingly:
        contact: user.contact || user.phoneno || "",
        address: "",
        pincode: "",
        avatar: null, // leave null until new upload
      });
      // For avatar preview: use existing avatar URL if available, else default
      console.log(user.profile_pic, "user profile pic is here");
      if (user.profile_pic) {
        setAvatarPreview(user.profile_pic);
      } else {
        // Default placeholder if none in user object
        setAvatarPreview("/Avatar2.png");
      }

      // Parse address if it exists and populate country, state, city fields
      if (user.address && typeof user.address === "string") {
        try {
          const parsedAddress = JSON.parse(user.address);
          if (parsedAddress) {
            // Set address field
            if (parsedAddress.blockUnitStreetName) {
              setProfileData((prev) => ({
                ...prev,
                address: parsedAddress.blockUnitStreetName,
              }));
            }

            // Set pincode
            if (parsedAddress.pincode) {
              setProfileData((prev) => ({
                ...prev,
                pincode: parsedAddress.pincode,
              }));
            }

            // Set country
            if (parsedAddress.country) {
              const countryObj = Country.getAllCountries().find(
                (c) => c.name === parsedAddress.country
              );
              if (countryObj) {
                setSelectedCountryObj(countryObj);
                setCountrySearchTerm(parsedAddress.country);
                setStates(State.getStatesOfCountry(countryObj.isoCode));

                // Set state after country is set
                if (parsedAddress.state) {
                  const stateObj = State.getStatesOfCountry(
                    countryObj.isoCode
                  ).find((s) => s.name === parsedAddress.state);
                  if (stateObj) {
                    setSelectedStateObj(stateObj);
                    setStateSearchTerm(parsedAddress.state);
                    setCities(
                      City.getCitiesOfState(
                        stateObj.countryCode,
                        stateObj.isoCode
                      )
                    );

                    // Set city after state is set
                    if (parsedAddress.city) {
                      const cityObj = City.getCitiesOfState(
                        stateObj.countryCode,
                        stateObj.isoCode
                      ).find((c) => c.name === parsedAddress.city);
                      if (cityObj) {
                        setSelectedCityObj(cityObj);
                        setCitySearchTerm(parsedAddress.city);
                      }
                    }
                  }
                }
              }
            }
          }
        } catch (e) {
          console.error("Error parsing address JSON:", e);
        }
      }
    }
  }, [user]);

  // Load countries on component mount
  useEffect(() => {
    const allCountries = Country.getAllCountries();
    setCountries(allCountries);
  }, []);

  // Add useEffect for country dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        countryDropdownRef.current &&
        !countryDropdownRef.current.contains(event.target)
      ) {
        setCountryDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for state dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        stateDropdownRef.current &&
        !stateDropdownRef.current.contains(event.target)
      ) {
        setStateDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for city dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        cityDropdownRef.current &&
        !cityDropdownRef.current.contains(event.target)
      ) {
        setCityDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Handlers for Country, State, City pickers
  const handleCountrySearchChange = (e) => {
    const value = e.target.value;
    setCountrySearchTerm(value);
    setCountryDropdownOpen(true);

    // Clear dependent selections if country changes
    if (value === "") {
      setSelectedStateObj(null);
      setSelectedCityObj(null);
      setStates([]);
      setCities([]);
      setStateSearchTerm("");
      setCitySearchTerm("");
    }
  };

  const handleCountrySelect = (country) => {
    setSelectedCountryObj(country);
    setCountrySearchTerm(country.name);
    setCountryDropdownOpen(false);
    setStates(State.getStatesOfCountry(country.isoCode));

    // Clear dependent selections
    setSelectedStateObj(null);
    setSelectedCityObj(null);
    setCities([]);
    setStateSearchTerm("");
    setCitySearchTerm("");
  };

  const handleStateSearchChange = (e) => {
    // Prevent state search if no country is selected
    if (!countrySearchTerm) {
      return;
    }

    const value = e.target.value;
    setStateSearchTerm(value);
    setStateDropdownOpen(true);

    // Clear dependent selections if state changes
    if (value === "") {
      setSelectedCityObj(null);
      setCities([]);
      setCitySearchTerm("");
    }
  };

  const handleStateSelect = (state) => {
    setSelectedStateObj(state);
    setStateSearchTerm(state.name);
    setStateDropdownOpen(false);
    setCities(City.getCitiesOfState(state.countryCode, state.isoCode));

    // Clear dependent selections
    setSelectedCityObj(null);
    setCitySearchTerm("");
  };

  const handleCitySearchChange = (e) => {
    // Prevent city search if no state is selected
    if (!stateSearchTerm) {
      return;
    }

    const value = e.target.value;
    setCitySearchTerm(value);
    setCityDropdownOpen(true);
  };

  const handleCitySelect = (city) => {
    setSelectedCityObj(city);
    setCitySearchTerm(city.name);
    setCityDropdownOpen(false);
  };

  // Handlers for profile fields
  const handleProfileChange = (e) => {
    const { name, value } = e.target;
    setProfileData((prev) => ({
      ...prev,
      [name]: value,
    }));
  };

  const handleAvatarChange = (e) => {
    const file = e.target.files && e.target.files[0];
    if (file) {
      setProfileData((prev) => ({ ...prev, avatar: file }));
      // Revoke previous preview URL if desired (cleanup) - optional
      if (avatarPreview && avatarPreview.startsWith("blob:")) {
        URL.revokeObjectURL(avatarPreview);
      }
      setAvatarPreview(URL.createObjectURL(file));
    }
  };

  const handleImageError = (e) => {
    console.error("Image failed to load:", e);
    // If the avatar preview is already the fallback, do nothing
    if (avatarPreview !== "/Avatar2.png") {
      console.log("Falling back to default avatar");
      setAvatarPreview("/Avatar2.png");
    }
  };

  // 2. Submit updated profile
  const handleProfileSubmit = async (e) => {
    e.preventDefault();

    // --- Validations ---
    const { name, email, contact, address, avatar } = profileData;

    if (!name || !name.trim()) {
      Swal.fire({
        icon: "error",
        title: "Validation Error",
        text: "Name is required.",
        confirmButtonColor: "#278AFF",
      });
      return;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!email || !emailRegex.test(email)) {
      Swal.fire({
        icon: "error",
        title: "Validation Error",
        text: "Please enter a valid email address.",
        confirmButtonColor: "#278AFF",
      });
      return;
    }

    const contactRegex = /^\+?[0-9\s-()]{10,}$/;
    if (!contact || !contactRegex.test(contact)) {
      Swal.fire({
        icon: "error",
        title: "Validation Error",
        text: "Please enter a valid contact number (at least 10 digits).",
        confirmButtonColor: "#278AFF",
      });
      return;
    }

    // Address field validations removed as per request

    if (avatar instanceof File) {
      const allowedTypes = ["image/jpeg", "image/png"];
      if (!allowedTypes.includes(avatar.type)) {
        Swal.fire({
          icon: "error",
          title: "Validation Error",
          text: "Invalid file type. Please upload a PNG or JPG image.",
          confirmButtonColor: "#278AFF",
        });
        return;
      }
    }

    // Clear previous messages
    setError("");
    setSuccess("");
    try {
      Swal.fire({
        title: "Loading...",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      // Create address object with country, state, city
      const addressObject = {
        blockUnitStreetName: address,
        country: countrySearchTerm || "",
        state: stateSearchTerm || "",
        city: citySearchTerm || "",
        pincode: profileData.pincode || "",
      };

      // Build payload. If avatar file present, use FormData; else JSON is fine.
      let response;
      if (profileData.avatar instanceof File) {
        const formPayload = new FormData();
        formPayload.append("name", profileData.name);
        formPayload.append("email", profileData.email);
        formPayload.append("phoneno", profileData.contact);
        formPayload.append("address", JSON.stringify(addressObject));
        formPayload.append("profile_image", profileData.avatar);
        response = await api.post("/updateuserprofile", formPayload, {
          headers: { "Content-Type": "multipart/form-data" },
        });
      } else {
        // No new avatar: send JSON
        const payload = {
          name: profileData.name,
          email: profileData.email,
          phoneno: profileData.contact,
          address: JSON.stringify(addressObject),
        };
        response = await api.post("/updateuserprofile", payload);
      }

      // Adjust according to your API response structure
      if (response.data && (response.data.success || response.data.status)) {
        console.log("API Response:", response.data);

        // API was successful, create payload for context update
        // Match the structure that login API returns
        const updatedUserData = {
          username: profileData.name,
          email: profileData.email,
          phoneno: profileData.contact,
          address: JSON.stringify(addressObject),
        };

        // Conditionally add avatar URL if API provides it
        // Check different possible response structures
        if (response.data.result?.profile_pic) {
          updatedUserData.profile_pic = response.data.result.profile_pic;
        } else if (response.data.user?.profile_image) {
          updatedUserData.profile_pic = response.data.user.profile_image;
        } else if (response.data.user?.profile_pic) {
          updatedUserData.profile_pic = response.data.user.profile_pic;
        } else if (response.data.profile_pic) {
          updatedUserData.profile_pic = response.data.profile_pic;
        }

        console.log("Updated User Data:", updatedUserData);

        // Update context and localStorage via AuthContext
        updateUser(updatedUserData);

        Swal.fire({
          icon: "success",
          title: "Success!",
          text: "Profile updated successfully",
          confirmButtonColor: "#278AFF",
        }).then(() => {
          window.location.reload();
        });
      } else {
        const msg =
          response.data?.message ||
          response.data?.error ||
          "Failed to update profile";
        Swal.fire({
          icon: "error",
          title: "Error",
          text: msg,
          confirmButtonColor: "#278AFF",
        });
      }
    } catch (err) {
      console.error("Error updating profile:", err);
      const errorMessage =
        err.response?.data?.message ||
        err.response?.data?.error ||
        "Error updating profile. Please try again.";
      Swal.fire({
        icon: "error",
        title: "Error",
        text: errorMessage,
        confirmButtonColor: "#278AFF",
      });
    }
  };

  // Handlers for Change Password (kept intact from your original)
  const handlePasswordChange = (e) => {
    setPasswordFormData({
      ...passwordFormData,
      [e.target.name]: e.target.value,
    });
    setError("");
    setSuccess("");
  };

  const handlePasswordSubmit = async (e) => {
    e.preventDefault();

    // Validate password length
    if (passwordFormData.newPassword.length < 8) {
      Swal.fire({
        icon: "error",
        title: "Validation Error",
        text: "New password must be at least 8 characters long.",
        confirmButtonColor: "#278AFF",
      });
      return;
    }

    // Validate passwords match
    if (
      passwordFormData.newPassword !== passwordFormData.newPasswordConfirmation
    ) {
      Swal.fire({
        icon: "error",
        title: "Error",
        text: "Passwords do not match",
        confirmButtonColor: "#278AFF",
      });
      return;
    }

    // Confirmation dialog
    const result = await Swal.fire({
      title: "Are you sure?",
      text: "You want to update your password?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#278AFF",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, update it!",
    });

    if (!result.isConfirmed) {
      return;
    }

    const payload = {
      current_password: passwordFormData.currentPassword,
      new_password: passwordFormData.newPassword,
      new_password_confirmation: passwordFormData.newPasswordConfirmation,
    };

    try {
      Swal.fire({
        title: "Loading...",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      const response = await api.post("/changePassword", payload);
      console.log("Response:", response);

      if (response.data) {
        Swal.fire({
          icon: "success",
          title: "Success!",
          text: "Password changed successfully",
          confirmButtonColor: "#278AFF",
        });
        setPasswordFormData({
          currentPassword: "",
          newPassword: "",
          newPasswordConfirmation: "",
        });
      }
    } catch (err) {
      console.error("Error details:", {
        message: err.message,
        response: err.response,
        config: err.config,
      });

      const errorMessage =
        err.response?.data?.message ||
        err.response?.data?.error ||
        "Error changing password. Please try again.";

      Swal.fire({
        icon: "error",
        title: "Error",
        text: errorMessage,
        confirmButtonColor: "#278AFF",
      });
    }
  };

  const isDummyImage = !avatarPreview || avatarPreview.endsWith("/Avatar2.png");

  // Render
  return (
    <>
      {/* ===== Profile Information Section (refactored) ===== */}
      <div className="flex bg-gradient-to-br from-white to-[#E7F4FF] rounded-[10px] shadow-[2px_2px_6px_rgba(24,95,235,0.1)] mb-5">
        <div className="w-full mx-auto p-4 md:p-6 rounded-[15.5px] relative">
          <h2 className="text-[20px] md:text-[22px] font-medium text-[#1F2837] whitespace-nowrap mb-4">
            Profile Information
          </h2>

          <form onSubmit={handleProfileSubmit}>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              {/* Avatar */}
              <div className="md:col-span-3 flex flex-col md:flex-row items-center gap-4 md:gap-6">
                <div className="relative flex-shrink-0">
                  {avatarPreview ? (
                    <>
                      <div
                        className={`w-24 h-24 rounded-full overflow-hidden flex items-center justify-center ${
                          isDummyImage ? "bg-[#8CBFEC]" : ""
                        }`}
                      >
                        <img
                          src={avatarPreview}
                          alt="Avatar"
                          className="w-full h-full object-cover"
                          onError={handleImageError}
                          onLoad={() =>
                            console.log(
                              "Image loaded successfully:",
                              avatarPreview
                            )
                          }
                        />
                      </div>
                      <label
                        htmlFor="avatar-upload"
                        className="absolute bottom-0 right-0 cursor-pointer"
                      >
                        <EditIcon />
                        <input
                          id="avatar-upload"
                          name="avatar"
                          type="file"
                          accept="image/png, image/jpeg"
                          className="hidden"
                          onChange={handleAvatarChange}
                        />
                      </label>
                    </>
                  ) : (
                    <div className="w-24 h-24 rounded-full bg-gray-300 animate-pulse" />
                  )}
                </div>
                <div className="text-xs md:text-sm text-[#4B5563] text-center md:text-left">
                  <p>Update your avatar by clicking the image beside.</p>
                  <p>288x288 px size recommended in PNG or JPG format only.</p>
                </div>
              </div>

              {/* Name */}
              <div className="space-y-1">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Username
                </label>
                <input
                  type="text"
                  name="name"
                  value={profileData.name}
                  onChange={handleProfileChange}
                  className="w-full h-[44px] px-3 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                  placeholder="Enter your name"
                  required
                />
              </div>

              {/* Email */}
              <div className="space-y-1">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Email
                </label>
                <input
                  type="email"
                  name="email"
                  value={profileData.email}
                  onChange={handleProfileChange}
                  className="w-full h-[44px] px-3 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                  placeholder="Enter your email"
                  required
                />
              </div>

              {/* Contact Info */}
              <div className="space-y-1">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Contact Info
                </label>
                <input
                  type="text"
                  name="contact"
                  value={profileData.contact}
                  onChange={handleProfileChange}
                  className="w-full h-[44px] px-3 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                  placeholder="Enter your contact number"
                  required
                />
              </div>

              {/* Address */}
              <div className="md:col-span-3">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Address
                </label>

                {/* Street Address */}
                <input
                  type="text"
                  name="address"
                  value={profileData.address}
                  onChange={handleProfileChange}
                  className="w-full h-[44px] px-3 rounded-t-[12px] bg-[#E7EFF8]/60 border border-white/20 outline-none text-[#545454] placeholder-[#545454]"
                  placeholder="Block/Unit/Street Name"

                />

                {/* State and City Dropdowns */}
                <div className="grid grid-cols-2 w-full">
                  {/* State Dropdown */}
                  <div className="relative" ref={stateDropdownRef}>
                    <input
                      type="text"
                      name="stateSearch"
                      value={stateSearchTerm}
                      onChange={handleStateSearchChange}
                      onFocus={() =>
                        countrySearchTerm && setStateDropdownOpen(true)
                      }
                      onBlur={() => setStateDropdownOpen(false)}
                      className={`w-full h-[44px] px-4 border border-white/20 outline-none text-[#545454] placeholder-[#545454] text-[16px] ${
                        !countrySearchTerm
                          ? "bg-gray-300 cursor-not-allowed opacity-60"
                          : "bg-[#E7EFF8]/60"
                      }`}
                      placeholder="Select State"
                      disabled={!countrySearchTerm}
                      readOnly={!countrySearchTerm}
                      autoComplete="off"
                    />
                    {stateDropdownOpen && countrySearchTerm && (
                      <div className="absolute z-10 custom-scrollbar w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                        {filteredStates.length > 0 ? (
                          filteredStates.map((state) => (
                            <div
                              key={state.isoCode}
                              className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                              onClick={() => handleStateSelect(state)}
                              onMouseDown={(e) => e.preventDefault()}
                            >
                              {state.name}
                            </div>
                          ))
                        ) : (
                          <div className="p-3 text-gray-500">
                            No states found
                          </div>
                        )}
                      </div>
                    )}
                  </div>

                  {/* City Dropdown */}
                  <div className="relative" ref={cityDropdownRef}>
                    <input
                      type="text"
                      name="citySearch"
                      value={citySearchTerm}
                      onChange={handleCitySearchChange}
                      onFocus={() =>
                        stateSearchTerm && setCityDropdownOpen(true)
                      }
                      onBlur={() => setCityDropdownOpen(false)}
                      className={`w-full h-[44px] px-4 border border-white/20 outline-none text-[#545454] placeholder-[#545454] text-[16px] ${
                        !stateSearchTerm
                          ? "bg-gray-300 cursor-not-allowed opacity-60"
                          : "bg-[#E7EFF8]/60"
                      }`}
                      placeholder="Select City"
                      disabled={!stateSearchTerm}
                      readOnly={!stateSearchTerm}
                      autoComplete="off"
                    />
                    {cityDropdownOpen && stateSearchTerm && (
                      <div className="absolute z-10 custom-scrollbar w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                        {filteredCities.length > 0 ? (
                          filteredCities.map((city) => (
                            <div
                              key={city.name}
                              className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                              onClick={() => handleCitySelect(city)}
                              onMouseDown={(e) => e.preventDefault()}
                            >
                              {city.name}
                            </div>
                          ))
                        ) : (
                          <div className="p-3 text-gray-500">
                            No cities found
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>

                {/* Pincode and Country */}
                <div className="grid grid-cols-2 w-full">
                  {/* Pincode Input */}
                  <input
                    type="text"
                    name="pincode"
                    value={profileData.pincode}
                    onChange={handleProfileChange}
                    className="w-full h-[44px] px-3 flex items-center text-[#545454] bg-[#E7EFF8]/60 border border-white/20 rounded-bl-[12px] outline-none"
                    placeholder="Pincode"
                  />
                  {/* Country Dropdown */}
                  <div className="relative" ref={countryDropdownRef}>
                    <input
                      type="text"
                      name="countrySearch"
                      value={countrySearchTerm}
                      onChange={handleCountrySearchChange}
                      onFocus={() => setCountryDropdownOpen(true)}
                      onBlur={() => setCountryDropdownOpen(false)}
                      className="w-full h-[44px] px-4 bg-[#E7EFF8]/60 border border-white/20 outline-none text-[#545454] placeholder-[#545454] rounded-br-[12px] text-[16px]"
                      placeholder="Select Country"
                      autoComplete="off"
                    />
                    {countryDropdownOpen && (
                      <div className="absolute z-10 custom-scrollbar w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                        {filteredCountries.length > 0 ? (
                          filteredCountries.map((country) => (
                            <div
                              key={country.isoCode}
                              className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                              onClick={() => handleCountrySelect(country)}
                              onMouseDown={(e) => e.preventDefault()}
                            >
                              {country.name}
                            </div>
                          ))
                        ) : (
                          <div className="p-3 text-gray-500">
                            No countries found
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>

            {/* Save button */}
            <div className="mt-6 flex justify-start">
              <button
                type="submit"
                className="w-full md:w-[207px] h-[44px] bg-[#ef7e1b] text-white rounded-[10px] hover:bg-[#ee7f1b] transition-colors"
              >
                Update Profile
              </button>
            </div>
          </form>
        </div>
      </div>

      {/* ===== Change Password Section (unchanged) ===== */}
      <div className="flex bg-gradient-to-br from-white to-[#E7F4FF] rounded-[10px] shadow-[2px_2px_6px_rgba(24,95,235,0.1)]">
        <div className="w-full mx-auto p-4 md:p-6 rounded-[15.5px] relative">
          <h2 className="text-[20px] md:text-[22px] font-medium text-[#1F2837] whitespace-nowrap mb-4">
            Change Password
          </h2>

          <form onSubmit={handlePasswordSubmit}>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* Current Password */}
              <div className="space-y-1">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Current Password
                </label>
                <input
                  type="password"
                  name="currentPassword"
                  value={passwordFormData.currentPassword}
                  onChange={handlePasswordChange}
                  className="w-full h-[44px] px-3 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                  placeholder="Enter current password"
                  required
                />
              </div>

              {/* Empty div for spacing */}
              <div />

              {/* New Password */}
              <div className="space-y-1">
                <label className="block text-[#4B5563] text-sm font-medium">
                  New Password
                </label>
                <input
                  type="password"
                  name="newPassword"
                  value={passwordFormData.newPassword}
                  onChange={handlePasswordChange}
                  className="w-full h-[44px] px-3 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                  placeholder="Enter new password (At least 8 characters)"
                  required
                  minLength="8"
                />
              </div>

              {/* Confirm New Password */}
              <div className="space-y-1">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Confirm New Password
                </label>
                <input
                  type="password"
                  name="newPasswordConfirmation"
                  value={passwordFormData.newPasswordConfirmation}
                  onChange={handlePasswordChange}
                  className="w-full h-[44px] px-3 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                  placeholder="Confirm new password"
                  required
                  minLength="8"
                />
              </div>
            </div>

            {/* Save button */}
            <div className="mt-6 flex justify-start">
              <button
                type="submit"
                className="w-full md:w-[207px] h-[44px] bg-[#ef7e1b] text-white rounded-[10px] hover:bg-[#ee7f1b] transition-colors"
              >
                Update Password
              </button>
            </div>
          </form>
        </div>
      </div>
    </>
  );
};

export default UpdateProfile;
</file>

<file path="src/styles/_keyframe-animations.scss">
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes fadeOut {
  from {
    opacity: 1;
  }
  to {
    opacity: 0;
  }
}

@keyframes zoomIn {
  from {
    transform: scale(0.95);
  }
  to {
    transform: scale(1);
  }
}

@keyframes zoomOut {
  from {
    transform: scale(1);
  }
  to {
    transform: scale(0.95);
  }
}

@keyframes zoom {
  0% {
    opacity: 0;
    transform: scale(0.95);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes slideFromTop {
  from {
    transform: translateY(-0.5rem);
  }
  to {
    transform: translateY(0);
  }
}

@keyframes slideFromRight {
  from {
    transform: translateX(0.5rem);
  }
  to {
    transform: translateX(0);
  }
}

@keyframes slideFromLeft {
  from {
    transform: translateX(-0.5rem);
  }
  to {
    transform: translateX(0);
  }
}

@keyframes slideFromBottom {
  from {
    transform: translateY(0.5rem);
  }
  to {
    transform: translateY(0);
  }
}

@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}
</file>

<file path="src/styles/_variables.scss">
:root {
  /****************** 
  Basics
  ******************/

  overflow-wrap: break-word;
  text-size-adjust: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;

  /****************** 
  Colors variables
  ******************/

  /* Gray alpha (light mode) */
  --tt-gray-light-a-50: rgba(56, 56, 56, 0.04);
  --tt-gray-light-a-100: rgba(15, 22, 36, 0.05);
  --tt-gray-light-a-200: rgba(37, 39, 45, 0.1);
  --tt-gray-light-a-300: rgba(47, 50, 55, 0.2);
  --tt-gray-light-a-400: rgba(40, 44, 51, 0.42);
  --tt-gray-light-a-500: rgba(52, 55, 60, 0.64);
  --tt-gray-light-a-600: rgba(36, 39, 46, 0.78);
  --tt-gray-light-a-700: rgba(35, 37, 42, 0.87);
  --tt-gray-light-a-800: rgba(30, 32, 36, 0.95);
  --tt-gray-light-a-900: rgba(29, 30, 32, 0.98);

  /* Gray (light mode) */
  --tt-gray-light-50: rgba(250, 250, 250, 1);
  --tt-gray-light-100: rgba(244, 244, 245, 1);
  --tt-gray-light-200: rgba(234, 234, 235, 1);
  --tt-gray-light-300: rgba(213, 214, 215, 1);
  --tt-gray-light-400: rgba(166, 167, 171, 1);
  --tt-gray-light-500: rgba(125, 127, 130, 1);
  --tt-gray-light-600: rgba(83, 86, 90, 1);
  --tt-gray-light-700: rgba(64, 65, 69, 1);
  --tt-gray-light-800: rgba(44, 45, 48, 1);
  --tt-gray-light-900: rgba(34, 35, 37, 1);

  /* Gray alpha (dark mode) */
  --tt-gray-dark-a-50: rgba(232, 232, 253, 0.05);
  --tt-gray-dark-a-100: rgba(231, 231, 243, 0.07);
  --tt-gray-dark-a-200: rgba(238, 238, 246, 0.11);
  --tt-gray-dark-a-300: rgba(239, 239, 245, 0.22);
  --tt-gray-dark-a-400: rgba(244, 244, 255, 0.37);
  --tt-gray-dark-a-500: rgba(236, 238, 253, 0.5);
  --tt-gray-dark-a-600: rgba(247, 247, 253, 0.64);
  --tt-gray-dark-a-700: rgba(251, 251, 254, 0.75);
  --tt-gray-dark-a-800: rgba(253, 253, 253, 0.88);
  --tt-gray-dark-a-900: rgba(255, 255, 255, 0.96);

  /* Gray (dark mode) */
  --tt-gray-dark-50: rgba(25, 25, 26, 1);
  --tt-gray-dark-100: rgba(32, 32, 34, 1);
  --tt-gray-dark-200: rgba(45, 45, 47, 1);
  --tt-gray-dark-300: rgba(70, 70, 73, 1);
  --tt-gray-dark-400: rgba(99, 99, 105, 1);
  --tt-gray-dark-500: rgba(124, 124, 131, 1);
  --tt-gray-dark-600: rgba(163, 163, 168, 1);
  --tt-gray-dark-700: rgba(192, 192, 195, 1);
  --tt-gray-dark-800: rgba(224, 224, 225, 1);
  --tt-gray-dark-900: rgba(245, 245, 245, 1);

  /* Brand colors */
  --tt-brand-color-50: rgba(239, 238, 255, 1);
  --tt-brand-color-100: rgba(222, 219, 255, 1);
  --tt-brand-color-200: rgba(195, 189, 255, 1);
  --tt-brand-color-300: rgba(157, 138, 255, 1);
  --tt-brand-color-400: rgba(122, 82, 255, 1);
  --tt-brand-color-500: rgba(98, 41, 255, 1);
  --tt-brand-color-600: rgba(84, 0, 229, 1);
  --tt-brand-color-700: rgba(75, 0, 204, 1);
  --tt-brand-color-800: rgba(56, 0, 153, 1);
  --tt-brand-color-900: rgba(43, 25, 102, 1);
  --tt-brand-color-950: hsla(257, 100%, 9%, 1);

  /* Green */
  --tt-color-green-inc-5: hsla(129, 100%, 97%, 1);
  --tt-color-green-inc-4: hsla(129, 100%, 92%, 1);
  --tt-color-green-inc-3: hsla(131, 100%, 86%, 1);
  --tt-color-green-inc-2: hsla(133, 98%, 78%, 1);
  --tt-color-green-inc-1: hsla(137, 99%, 70%, 1);
  --tt-color-green-base: hsla(147, 99%, 50%, 1);
  --tt-color-green-dec-1: hsla(147, 97%, 41%, 1);
  --tt-color-green-dec-2: hsla(146, 98%, 32%, 1);
  --tt-color-green-dec-3: hsla(146, 100%, 24%, 1);
  --tt-color-green-dec-4: hsla(144, 100%, 16%, 1);
  --tt-color-green-dec-5: hsla(140, 100%, 9%, 1);

  /* Yellow */
  --tt-color-yellow-inc-5: hsla(50, 100%, 97%, 1);
  --tt-color-yellow-inc-4: hsla(50, 100%, 91%, 1);
  --tt-color-yellow-inc-3: hsla(50, 100%, 84%, 1);
  --tt-color-yellow-inc-2: hsla(50, 100%, 77%, 1);
  --tt-color-yellow-inc-1: hsla(50, 100%, 68%, 1);
  --tt-color-yellow-base: hsla(52, 100%, 50%, 1);
  --tt-color-yellow-dec-1: hsla(52, 100%, 41%, 1);
  --tt-color-yellow-dec-2: hsla(52, 100%, 32%, 1);
  --tt-color-yellow-dec-3: hsla(52, 100%, 24%, 1);
  --tt-color-yellow-dec-4: hsla(51, 100%, 16%, 1);
  --tt-color-yellow-dec-5: hsla(50, 100%, 9%, 1);

  /* Red */
  --tt-color-red-inc-5: hsla(11, 100%, 96%, 1);
  --tt-color-red-inc-4: hsla(11, 100%, 88%, 1);
  --tt-color-red-inc-3: hsla(10, 100%, 80%, 1);
  --tt-color-red-inc-2: hsla(9, 100%, 73%, 1);
  --tt-color-red-inc-1: hsla(7, 100%, 64%, 1);
  --tt-color-red-base: hsla(7, 100%, 54%, 1);
  --tt-color-red-dec-1: hsla(7, 100%, 41%, 1);
  --tt-color-red-dec-2: hsla(5, 100%, 32%, 1);
  --tt-color-red-dec-3: hsla(4, 100%, 24%, 1);
  --tt-color-red-dec-4: hsla(3, 100%, 16%, 1);
  --tt-color-red-dec-5: hsla(1, 100%, 9%, 1);

  /* Basic colors */
  --white: rgba(255, 255, 255, 1);
  --black: rgba(14, 14, 17, 1);
  --transparent: rgba(255, 255, 255, 0);

  /****************** 
  Shadow variables
  ******************/

  /* Shadows Light */
  --tt-shadow-elevated-md:
    0px 16px 48px 0px rgba(17, 24, 39, 0.04),
    0px 12px 24px 0px rgba(17, 24, 39, 0.04),
    0px 6px 8px 0px rgba(17, 24, 39, 0.02),
    0px 2px 3px 0px rgba(17, 24, 39, 0.02);

  /************************************************** 
       Radius variables 
    **************************************************/

  --tt-radius-xxs: 0.125rem; /* 2px */
  --tt-radius-xs: 0.25rem; /* 4px */
  --tt-radius-sm: 0.375rem; /* 6px */
  --tt-radius-md: 0.5rem; /* 8px */
  --tt-radius-lg: 0.75rem; /* 12px */
  --tt-radius-xl: 1rem; /* 16px */

  /************************************************** 
       Transition variables 
    **************************************************/

  --tt-transition-duration-short: 0.1s;
  --tt-transition-duration-default: 0.2s;
  --tt-transition-duration-long: 0.64s;
  --tt-transition-easing-default: cubic-bezier(0.46, 0.03, 0.52, 0.96);
  --tt-transition-easing-cubic: cubic-bezier(0.65, 0.05, 0.36, 1);
  --tt-transition-easing-quart: cubic-bezier(0.77, 0, 0.18, 1);
  --tt-transition-easing-circ: cubic-bezier(0.79, 0.14, 0.15, 0.86);
  --tt-transition-easing-back: cubic-bezier(0.68, -0.55, 0.27, 1.55);

  /****************** 
  Contrast variables
  ******************/

  --tt-accent-contrast: 8%;
  --tt-destructive-contrast: 8%;
  --tt-foreground-contrast: 8%;

  &,
  *,
  ::before,
  ::after {
    box-sizing: border-box;
    transition: none var(--tt-transition-duration-default)
      var(--tt-transition-easing-default);
  }
}

:root {
  /************************************************** 
      Global colors 
  **************************************************/

  /* Global colors - Light mode */
  --tt-bg-color: var(--white);
  --tt-border-color: var(--tt-gray-light-a-200);
  --tt-border-color-tint: var(--tt-gray-light-a-100);
  --tt-sidebar-bg-color: var(--tt-gray-light-100);
  --tt-scrollbar-color: var(--tt-gray-light-a-200);
  --tt-cursor-color: var(--tt-brand-color-500);
  --tt-selection-color: rgba(157, 138, 255, 0.2);
  --tt-card-bg-color: var(--white);
  --tt-card-border-color: var(--tt-gray-light-a-100);
}

/* Global colors - Dark mode */
.dark {
  --tt-bg-color: var(--black);
  --tt-border-color: var(--tt-gray-dark-a-200);
  --tt-border-color-tint: var(--tt-gray-dark-a-100);
  --tt-sidebar-bg-color: var(--tt-gray-dark-100);
  --tt-scrollbar-color: var(--tt-gray-dark-a-200);
  --tt-cursor-color: var(--tt-brand-color-400);
  --tt-selection-color: rgba(122, 82, 255, 0.2);
  --tt-card-bg-color: var(--tt-gray-dark-50);
  --tt-card-border-color: var(--tt-gray-dark-a-50);

  --tt-shadow-elevated-md:
    0px 16px 48px 0px rgba(0, 0, 0, 0.5), 0px 12px 24px 0px rgba(0, 0, 0, 0.24),
    0px 6px 8px 0px rgba(0, 0, 0, 0.22), 0px 2px 3px 0px rgba(0, 0, 0, 0.12);
}

/* Text colors */
:root {
  --tt-color-text-gray: hsl(45, 2%, 46%);
  --tt-color-text-brown: hsl(19, 31%, 47%);
  --tt-color-text-orange: hsl(30, 89%, 45%);
  --tt-color-text-yellow: hsl(38, 62%, 49%);
  --tt-color-text-green: hsl(148, 32%, 39%);
  --tt-color-text-blue: hsl(202, 54%, 43%);
  --tt-color-text-purple: hsl(274, 32%, 54%);
  --tt-color-text-pink: hsl(328, 49%, 53%);
  --tt-color-text-red: hsl(2, 62%, 55%);

  --tt-color-text-gray-contrast: hsla(39, 26%, 26%, 0.15);
  --tt-color-text-brown-contrast: hsla(18, 43%, 69%, 0.35);
  --tt-color-text-orange-contrast: hsla(24, 73%, 55%, 0.27);
  --tt-color-text-yellow-contrast: hsla(44, 82%, 59%, 0.39);
  --tt-color-text-green-contrast: hsla(126, 29%, 60%, 0.27);
  --tt-color-text-blue-contrast: hsla(202, 54%, 59%, 0.27);
  --tt-color-text-purple-contrast: hsla(274, 37%, 64%, 0.27);
  --tt-color-text-pink-contrast: hsla(331, 60%, 71%, 0.27);
  --tt-color-text-red-contrast: hsla(8, 79%, 79%, 0.4);
}

.dark {
  --tt-color-text-gray: hsl(0, 0%, 61%);
  --tt-color-text-brown: hsl(18, 35%, 58%);
  --tt-color-text-orange: hsl(25, 53%, 53%);
  --tt-color-text-yellow: hsl(36, 54%, 55%);
  --tt-color-text-green: hsl(145, 32%, 47%);
  --tt-color-text-blue: hsl(202, 64%, 52%);
  --tt-color-text-purple: hsl(270, 55%, 62%);
  --tt-color-text-pink: hsl(329, 57%, 58%);
  --tt-color-text-red: hsl(1, 69%, 60%);

  --tt-color-text-gray-contrast: hsla(0, 0%, 100%, 0.09);
  --tt-color-text-brown-contrast: hsla(17, 45%, 50%, 0.25);
  --tt-color-text-orange-contrast: hsla(27, 82%, 53%, 0.2);
  --tt-color-text-yellow-contrast: hsla(35, 49%, 47%, 0.2);
  --tt-color-text-green-contrast: hsla(151, 55%, 39%, 0.2);
  --tt-color-text-blue-contrast: hsla(202, 54%, 43%, 0.2);
  --tt-color-text-purple-contrast: hsla(271, 56%, 60%, 0.18);
  --tt-color-text-pink-contrast: hsla(331, 67%, 58%, 0.22);
  --tt-color-text-red-contrast: hsla(0, 67%, 60%, 0.25);
}

/* Highlight colors */
:root {
  --tt-color-highlight-yellow: #fef9c3;
  --tt-color-highlight-green: #dcfce7;
  --tt-color-highlight-blue: #e0f2fe;
  --tt-color-highlight-purple: #f3e8ff;
  --tt-color-highlight-red: #ffe4e6;
  --tt-color-highlight-gray: rgb(248, 248, 247);
  --tt-color-highlight-brown: rgb(244, 238, 238);
  --tt-color-highlight-orange: rgb(251, 236, 221);
  --tt-color-highlight-pink: rgb(252, 241, 246);

  --tt-color-highlight-yellow-contrast: #fbe604;
  --tt-color-highlight-green-contrast: #c7fad8;
  --tt-color-highlight-blue-contrast: #ceeafd;
  --tt-color-highlight-purple-contrast: #e4ccff;
  --tt-color-highlight-red-contrast: #ffccd0;
  --tt-color-highlight-gray-contrast: rgba(84, 72, 49, 0.15);
  --tt-color-highlight-brown-contrast: rgba(210, 162, 141, 0.35);
  --tt-color-highlight-orange-contrast: rgba(224, 124, 57, 0.27);
  --tt-color-highlight-pink-contrast: rgba(225, 136, 179, 0.27);
}

.dark {
  --tt-color-highlight-yellow: #6b6524;
  --tt-color-highlight-green: #509568;
  --tt-color-highlight-blue: #6e92aa;
  --tt-color-highlight-purple: #583e74;
  --tt-color-highlight-red: #743e42;
  --tt-color-highlight-gray: rgb(47, 47, 47);
  --tt-color-highlight-brown: rgb(74, 50, 40);
  --tt-color-highlight-orange: rgb(92, 59, 35);
  --tt-color-highlight-pink: rgb(78, 44, 60);

  --tt-color-highlight-yellow-contrast: #58531e;
  --tt-color-highlight-green-contrast: #47855d;
  --tt-color-highlight-blue-contrast: #5e86a1;
  --tt-color-highlight-purple-contrast: #4c3564;
  --tt-color-highlight-red-contrast: #643539;
  --tt-color-highlight-gray-contrast: rgba(255, 255, 255, 0.094);
  --tt-color-highlight-brown-contrast: rgba(184, 101, 69, 0.25);
  --tt-color-highlight-orange-contrast: rgba(233, 126, 37, 0.2);
  --tt-color-highlight-pink-contrast: rgba(220, 76, 145, 0.22);
}
</file>

<file path="src/styles/scrollbar.css">
.custom-scrollbar::-webkit-scrollbar {
  background-color: transparent;
  width: 4px;
  height: 4px;
border-radius: 3px;

}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background-color: #2798FF;
  border-radius: 3px;


}
</file>

<file path="vite.config.js">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { fileURLToPath, URL } from 'url'
import path from 'path'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, 'src'),
    },
  },
})
</file>

<file path="index.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/logo.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Royal House Design</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
</file>

<file path="package.json">
{
  "name": "enquiry-crm",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@floating-ui/react": "^0.27.12",
    "@react-pdf/renderer": "^4.3.0",
    "@tiptap/extension-character-count": "^2.22.3",
    "@tiptap/extension-highlight": "^2.22.3",
    "@tiptap/extension-image": "^2.22.3",
    "@tiptap/extension-link": "^2.22.3",
    "@tiptap/extension-placeholder": "^2.22.3",
    "@tiptap/extension-subscript": "^2.22.3",
    "@tiptap/extension-superscript": "^2.22.3",
    "@tiptap/extension-task-item": "^2.22.3",
    "@tiptap/extension-task-list": "^2.22.3",
    "@tiptap/extension-text-align": "^2.22.3",
    "@tiptap/extension-typography": "^2.22.3",
    "@tiptap/extension-underline": "^2.22.3",
    "@tiptap/pm": "^2.22.3",
    "@tiptap/react": "^2.22.3",
    "@tiptap/starter-kit": "^2.22.3",
    "axios": "^1.9.0",
    "buffer": "^6.0.3",
    "chart.js": "^4.5.0",
    "country-state-city": "^3.2.1",
    "dotenv": "^16.5.0",
    "framer-motion": "^12.18.1",
    "html2pdf.js": "^0.9.0",
    "motion": "^12.18.1",
    "react": "^19.1.0",
    "react-chartjs-2": "^5.3.0",
    "react-dom": "^19.1.0",
    "react-icons": "^5.5.0",
    "react-pdf": "^9.2.1",
    "react-pdf-tailwind": "^2.3.0",
    "react-router-dom": "^6.30.1",
    "sweetalert2": "^11.22.0"
  },
  "devDependencies": {
    "@eslint/js": "^9.25.0",
    "@tailwindcss/postcss": "^4.1.8",
    "@types/react": "^19.1.2",
    "@types/react-dom": "^19.1.2",
    "@vitejs/plugin-react": "^4.4.1",
    "autoprefixer": "^10.4.21",
    "eslint": "^9.25.0",
    "eslint-plugin-react-hooks": "^5.2.0",
    "eslint-plugin-react-refresh": "^0.4.19",
    "globals": "^16.0.0",
    "postcss": "^8.5.4",
    "sass": "^1.89.2",
    "tailwindcss": "^4.1.8",
    "vite": "^6.3.5"
  }
}
</file>

<file path="src/App.css">
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}

button {
  cursor: pointer;
}
</file>

<file path="src/pages/dashboard/AvgLeads.jsx">
import React from "react";
import { BsThreeDotsVertical } from "react-icons/bs";

const AvgLeads = ({
  leads = 200,
  newToday = 15,
  increasePercent = "2.50%",
  gradient = "linear-gradient(45deg, white, #e6f4fb)",
}) => {
  return (
    <div
      className="relative inline-block p-[3px] rounded-2xl overflow-hidden w-[23%] min-w-[510px] mx-[0.5%]"
      style={{
        backgroundImage: `
          linear-gradient(to right, white, #0e4053),
          linear-gradient(to bottom, #0e4053, #a3c9f1),
          linear-gradient(to right, white, #a3c9f1),
          linear-gradient(to bottom, white, white)
        `,
        backgroundPosition: `
          top left,
          top right,
          bottom left,
          top left
        `,
        backgroundSize: `
          100% 2px,
          2px 100%,
          100% 2px,
          2px 100%
        `,
      }}
    >
      {/* Glow effect */}
      <div className="absolute bottom-0 right-0 w-[500px] h-[100px] bg-[#a3c9f1] rounded-full blur-[30px] pointer-events-none z-0" />

      {/* Inner content */}
      <div
        className="relative z-10 rounded-[14px] min-h-[240px] px-5 pt-5 pb-3 flex flex-col -ml-1.5"
        style={{ background: gradient }}
      >
        <div style={{ display: "flex", justifyContent: "space-around" }}>
          <div>Average Leads</div>
          <div>
            <BsThreeDotsVertical />
          </div>
        </div>
        <div>
          <div>Number ofLeds per week</div>
        </div>
      </div>
    </div>
  );
};

export default AvgLeads;
</file>

<file path="src/pages/dashboard/ContainerBackup.jsx">
import React from "react";
import { BsCardChecklist } from "react-icons/bs";

const Container1 = ({
  leads,
  newToday,
  increasePercent,
  gradient = "linear-gradient(45deg, white, #e6f4fb)",
  iconSrc = "/task-square.png",
}) => {
  return (
    <div
      className="relative inline-block p-[3px] rounded-2xl overflow-hidden w-[23%] min-w-[220px] mx-[0.5%]"
      style={{
        backgroundImage: `linear-gradient(to top right, transparent 70%, #0e4053)`,
        backgroundPosition: ``, // Removed, as no longer needed
        backgroundSize: ``, // Removed, as no longer needed
      }}
    >
      {/* Glow effect */}
      <div className="absolute bottom-0 right-0 w-[100px] h-[100px] bg-[#a3c9f1] rounded-full blur-[30px] pointer-events-none z-0" />

      {/* Inner content */}
      <div
        className="relative z-10 rounded-[14px] min-h-[130px] px-5 pt-5 pb-3 flex flex-col -ml-1.5"
        style={{ background: gradient }}
      >
        {/* Top Content */}
        <div>
          <div className="flex justify-between">
            <div>
              {leads !== undefined && leads !== null && (
                <>
                  <div className="text-[#ef7e1b] text-[25px] font-extrabold font-quicksand">
                    {leads}+
                  </div>
                  <div className="text-black font-semibold">Total Leads</div>
                </>
              )}
            </div>
            <div className="bg-[rgba(52,152,219,0.2)] rounded-full w-[60px] h-[60px] flex justify-center items-center -mt-1.5">
              <img
                src={iconSrc}
                alt="task icon"
                className="w-[30px] h-[30px] object-contain"
              />
            </div>
          </div>

          {/* New Today */}
          {newToday !== undefined && newToday !== null && (
            <div className="text-gray-500 text-xs mt-1">{`New Today: ${newToday}`}</div>
          )}
        </div>

        {/* Bottom Increase Percent */}
        <div className="flex-1 relative">
          {increasePercent !== undefined && increasePercent !== null && (
            <div className="absolute bottom-0 flex items-center gap-2 text-xs -mb-1.5">
              <span className="text-green-500 font-medium flex items-center text-xs">
                <span
                  className="inline-block mr-1"
                  style={{ transform: "rotate(30deg)", fontSize: "12px" }}
                >
                  ↑
                </span>
                {increasePercent}%
              </span>
              <span className="text-gray-500 text-xs">from last week</span>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default Container1;
</file>

<file path="src/pages/dashboard/listhere.jsx">
import React, { useEffect, useState } from "react";
import axios from "axios";
import Container1 from "./Container1";
import Container2 from "./Container2";
import Container3 from "./Container3";
import Container4 from "./Container4";
// import AvgLeads from "./AvgLeads";
// import Quotation from "./Quotation";

const Dashboard = () => {
  const [dashboardData, setDashboardData] = useState({});
  const [error, setError] = useState(null);

  const fetchAllData = async () => {
    try {
      const token = localStorage.getItem("token");
      if (!token) {
        setError("No token found. Please login.");
        return;
      }

      const headers = { Authorization: `Bearer ${token}` };

      const [leadsByStatusRes, followUpRes, newTodayRes, quotationRes] =
        await Promise.all([
          axios.get("https://inquiry.questdigiflex.in/public/api/totalleads", {
            headers,
          }),
          axios.get(
            "https://inquiry.questdigiflex.in/public/api/leadscountperweek/2",
            { headers }
          ),
          axios.get("https://inquiry.questdigiflex.in/public/api/todayleads", {
            headers,
          }),
          axios.get(
            "https://inquiry.questdigiflex.in/public/api/totalleadslw",
            { headers }
          ),
        ]);

      console.log("➡ leadsByStatus:", leadsByStatusRes.data);
      console.log("➡ Follow Ups:", followUpRes.data);
      console.log("➡ Today Leads:", newTodayRes.data);
      console.log(
        "➡ Quotation Last Week %:",
        quotationRes.data?.percentage_last_week
      );

      setDashboardData({
        leadsByStatus: leadsByStatusRes.data,
        followUp: followUpRes.data,
        newToday: newTodayRes.data,
        quotationData: quotationRes.data,
      });
    } catch (err) {
      console.error("❌ Error fetching dashboard data:", err);
      setError("Failed to load dashboard data.");
    }
  };

  useEffect(() => {
    fetchAllData();
  }, []);

  return (
    <div className="px-5">
      {error && <div className="text-red-500">{error}</div>}

      {/* Top Lead Status Cards */}
      <div className="flex flex-wrap justify-between">
        <Container1
          leads={dashboardData?.leadsByStatus?.total_leads || 0}
          newToday={dashboardData?.newToday?.today_leads || 0}
          increasePercent={
            dashboardData?.quotationData?.percentage_last_week || "0%"
          }
        />

        <Container2 />

        <Container3
          followUpRes={dashboardData?.followUpRes?.total_leads || 0}
        />

        <Container4
        // You can include customer enquiry count here when added back
        />
      </div>

      {/* Bottom Section (Optional) */}
      {/*
      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mt-6">
        <AvgLeads leads={dashboardData?.followUp?.average || 0} />
        <Quotation data={dashboardData?.quotationData} />
      </div>
      */}
    </div>
  );
};

export default Dashboard;
//dashboard backup
</file>

<file path="src/pages/dashboard/Quotation.jsx">
import React from "react";
import { BsThreeDotsVertical } from "react-icons/bs";

const Quotation = ({
  leads = 200,
  newToday = 15,
  increasePercent = "2.50%",
  gradient = "linear-gradient(45deg, white, #e6f4fb)",
}) => {
  return (
    <div
      className="relative inline-block p-[3px] rounded-2xl overflow-hidden w-[23%] min-w-[240px] mx-[0.5%]"
      style={{
        backgroundImage: `
          linear-gradient(to right, white, #0e4053),
          linear-gradient(to bottom, #0e4053, #a3c9f1),
          linear-gradient(to right, white, #a3c9f1),
          linear-gradient(to bottom, white, white)
        `,
        backgroundPosition: `
          top left,
          top right,
          bottom left,
          top left
        `,
        backgroundSize: `
          100% 2px,
          2px 100%,
          100% 2px,
          2px 100%
        `,
      }}
    >
      {/* Glow effect */}
      <div className="absolute bottom-0 right-0 w-[500px] h-[100px] bg-[#a3c9f1] rounded-full blur-[30px] pointer-events-none z-0" />

      {/* Inner content */}
      <div
        className="relative z-10 rounded-[14px] min-h-[240px] px-5 pt-5 pb-3 flex flex-col -ml-1.5"
        style={{ background: gradient }}
      >
        <div style={{ display: "flex", justifyContent: "space-around" }}>
          <div>Average Leads</div>
          <div>
            <BsThreeDotsVertical />
          </div>
        </div>
        <div>
          <div>Number ofLeds per week</div>
        </div>
      </div>
    </div>
  );
};

export default Quotation;
</file>

<file path="src/pages/settings/RolesPermissions.jsx">
import React, { useState, useEffect, useContext } from "react";
import { FiChevronDown } from "react-icons/fi";
import { TbDotsVertical } from "react-icons/tb";
import { FiEdit } from "react-icons/fi";
import api from "../../api";
import Swal from "sweetalert2";
import dummyAvatar from "/dummyavatar.jpeg";
import { SidebarContext } from "../../components/Layout";


// Helper to format role names (capitalize, snake_case to space, capitalize after space)
export function formatRoleName(roleName) {
  if (!roleName || typeof roleName !== "string") return roleName;
  return roleName
    .split("_")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(" ");
}

// Define all modules and permissions to always show
const ALL_MODULES = ["Invoice", "Leads", "Quotation"];
const ALL_PERMISSIONS = ["view", "create", "edit", "delete"];

const RolesPermissions = () => {
  const { isCollapsed } = useContext(SidebarContext);

  const [users, setUsers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [activeDropdown, setActiveDropdown] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingUser, setEditingUser] = useState(null);
  const [formData, setFormData] = useState({
    name: "",
    email: "",
    phoneno: "",
    address: "",
  });

  // State for active screen and role dropdown
  const [activeScreen, setActiveScreen] = useState("roles"); // 'roles' or 'permissions'
  const [isRoleDropdownOpen, setIsRoleDropdownOpen] = useState(false);
  const [selectedRole, setSelectedRole] = useState(null);

  // State for Add Role Modal
  const [isAddRoleModalOpen, setIsAddRoleModalOpen] = useState(false);
  const [newRoleData, setNewRoleData] = useState({
    name: "",
    email: "",
    phoneno: "",
    password: "",
    address: "",
    description: "",
    image: null,
  });
  const [imagePreview, setImagePreview] = useState(null);

  // --- Permissions State ---
  const initialPermissions = {
    Leads: { view: true, create: true, edit: true, delete: false },
    Quotation: { view: true, create: true, edit: true, delete: false },
    Invoice: { view: true, create: true, edit: true, delete: false },
  };

  const [permissions, setPermissions] = useState(initialPermissions);
  const [moduleIdMap, setModuleIdMap] = useState({});
  const [modulesLoading, setModulesLoading] = useState(true);

  // Fetch module IDs on mount
  useEffect(() => {
    const fetchModules = async () => {
      try {
        const response = await api.get("/getmodules");
        if (response.data.status === "true" || response.data.success) {
          // Map module name to id
          const idMap = {};
          response.data.data.forEach((mod) => {
            idMap[mod.name] = mod.id;
          });
          setModuleIdMap(idMap);
        }
      } catch (err) {
        // Optionally handle error
      } finally {
        setModulesLoading(false);
      }
    };
    fetchModules();
  }, []);

  // Helper to transform API permissions response to UI state
  function transformPermissions(apiData) {
    const result = {};
    // Start with all modules and all permissions set to false
    ALL_MODULES.forEach((module) => {
      result[module] = {};
      ALL_PERMISSIONS.forEach((perm) => {
        result[module][perm] = false;
      });
    });
    // Overlay API response
    apiData.forEach(({ module, permissions }) => {
      if (!result[module]) {
        result[module] = {};
        ALL_PERMISSIONS.forEach((perm) => {
          result[module][perm] = false;
        });
      }
      // Filter out empty strings before setting permissions
      permissions.filter(Boolean).forEach((perm) => {
        result[module][perm] = true;
      });
    });
    return result;
  }

  // Fetch permissions when selectedRole changes (in permissions screen)
  useEffect(() => {
    if (!selectedRole || !selectedRole.id || activeScreen !== "permissions")
      return;
    setLoading(true);
    const fetchPermissions = async () => {
      try {
        const response = await api.get(
          `/role/${selectedRole.id}/module-permissions`
        );
        if (response.data.success) {
          setPermissions(transformPermissions(response.data.data));
        }
      } catch (err) {
        // Optionally handle error
      } finally {
        setLoading(false);
      }
    };
    fetchPermissions();
    // eslint-disable-next-line
  }, [selectedRole, activeScreen]);

  const handlePermissionChange = async (module, permission) => {
    if (!selectedRole || !selectedRole.id) return;
    if (!moduleIdMap[module]) {
      Swal.fire({
        icon: "error",
        title: "Module ID Missing",
        text: `Module ID for '${module}' is missing. Cannot update permission.`,
        confirmButtonColor: "#DD6B55",
      });
      return;
    }
    const action = permissions[module][permission] ? "disable" : "enable";
    const result = await Swal.fire({
      title: "Are you sure?",
      text: `You are about to ${action} the '${permission}' permission for the '${module}' module. This will reflect in 60 seconds and affect all users with this role.`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#2798FF",
      cancelButtonColor: "#aaa",
      confirmButtonText: "Yes, proceed",
      cancelButtonText: "Cancel",
    });
    if (!result.isConfirmed) return;
    // Optimistically update UI
    setPermissions((prev) => ({
      ...prev,
      [module]: {
        ...prev[module],
        [permission]: !prev[module][permission],
      },
    }));

    // Build the full permissions array reflecting the new toggle
    const newPermissions = {
      ...permissions,
      [module]: {
        ...permissions[module],
        [permission]: !permissions[module][permission],
      },
    };
    const permissionsPayload = Object.entries(moduleIdMap).map(
      ([mod, module_id]) => {
        const perms = newPermissions[mod] || {};
        const arr = Object.keys(perms).filter((perm) => perms[perm]);
        return {
          module_id,
          permission_names: arr.length === 0 ? [""] : arr,
        };
      }
    );

    const loadingAlert = Swal.fire({
      title: "Updating Permission...",
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      },
    });
    try {
      const response = await api.post(
        `/role/${selectedRole.id}/update-permissions`,
        { permissions: permissionsPayload }
      );
      await loadingAlert.close();
      if (response.data.success) {
        Swal.fire({
          icon: "info",
          title: "Permission Updated",
          text: `The '${permission}' permission for '${module}' has been ${
            action === "enable" ? "enabled" : "disabled"
          }.`,
          confirmButtonColor: "#2798FF",
          timer: 1500,
          showConfirmButton: false,
        });
      } else {
        throw new Error(
          response.data.message || "Failed to update permission."
        );
      }
    } catch (err) {
      await loadingAlert.close();
      // Revert UI on error
      setPermissions((prev) => ({
        ...prev,
        [module]: {
          ...prev[module],
          [permission]: permissions[module][permission],
        },
      }));
      Swal.fire({
        icon: "error",
        title: "Update Failed",
        text: err.message || "An error occurred while updating permission.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  const handleSaveChanges = async () => {
    if (!selectedRole) {
      Swal.fire({
        icon: "warning",
        title: "No Role Selected",
        text: "Please select a role before saving permissions.",
        confirmButtonColor: "#2798FF",
      });
      return;
    }

    // Build the permissions array as required by the API
    const permissionsPayload = Object.entries(moduleIdMap).map(
      ([mod, module_id]) => {
        const perms = permissions[mod] || {};
        const arr = Object.keys(perms).filter((perm) => perms[perm]);
        return {
          module_id,
          permission_names: arr.length === 0 ? [""] : arr,
        };
      }
    );

    const loadingAlert = Swal.fire({
      title: "Saving Permissions...",
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      },
    });

    try {
      const response = await api.post(
        `/role/${selectedRole.id}/update-permissions`,
        { permissions: permissionsPayload }
      );
      await loadingAlert.close();

      if (response.data.success) {
        await Swal.fire({
          icon: "success",
          title: "Permissions Saved!",
          text: `Permissions for ${selectedRole.name} have been updated successfully.`,
          confirmButtonColor: "#2798FF",
        });
      } else {
        throw new Error(response.data.message || "Failed to save permissions.");
      }
    } catch (err) {
      await loadingAlert.close();
      Swal.fire({
        icon: "error",
        title: "Save Failed",
        text: err.message || "An error occurred while saving permissions.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };
  // --- End of Permissions State ---

  useEffect(() => {
    const fetchUsers = async () => {
      try {
        const response = await api.get("/roles");
        if (response.data.success) {
          setUsers([...response.data.data]);
        } else {
          console.error("Failed to fetch users");
        }
      } catch (err) {
        console.error("Error fetching users" + err.message);
      } finally {
        setLoading(false);
      }
    };

    fetchUsers();
  }, []);

  const resetForm = () => {
    if (imagePreview) {
      URL.revokeObjectURL(imagePreview);
    }
    setImagePreview(null);
    setNewRoleData({
      name: "",
      email: "",
      phoneno: "",
      password: "",
      address: "",
      description: "",
      image: null,
    });
  };



  const handleCloseModal = () => {
    setIsAddRoleModalOpen(false);
    resetForm();
  };

  const toggleDropdown = (userId) => {
    setActiveDropdown(activeDropdown === userId ? null : userId);
  };

  const handleEdit = (role) => {
    setEditingUser(role);
    setFormData({
      role: formatRoleName(role.name),
    });
    setIsModalOpen(true);
    setActiveDropdown(null);
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData((prev) => ({
      ...prev,
      [name]: value,
    }));
  };

  const handleNewRoleChange = (e) => {
    const { name, value, files } = e.target;
    if (name === "image") {
      const file = files[0];
      if (file) {
        setNewRoleData((prev) => ({ ...prev, image: file }));
        if (imagePreview) {
          URL.revokeObjectURL(imagePreview); // Revoke old one
        }
        setImagePreview(URL.createObjectURL(file));
      }
    } else {
      setNewRoleData((prev) => ({ ...prev, [name]: value }));
    }
  };

  const handleAddRoleSubmit = async (e) => {
    e.preventDefault();

    // Only send the role name to /addroles
    const payload = {
      name: newRoleData.role,
    };

    try {
      // Show loading state
      const loadingAlert = Swal.fire({
        title: "Creating Role...",
        html: "<div style='color:#555;font-size:15px;margin-top:10px;'></div>",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      // API call to create role
      const response = await api.post("/roles/addroles", payload);

      await loadingAlert.close();

      if (response.data.success || response.data.status) {
        // Optionally, you may want to update the roles list here if needed
        setIsAddRoleModalOpen(false);
        resetForm();

        await Swal.fire({
          icon: "success",
          title: "Role Created!",
          html: `Role "${newRoleData.role}" has been successfully created.<br><br><b>Note:</b> Roles cannot import/export CSVs.`,
          confirmButtonColor: "#2798FF",
        });
        window.location.reload();
      } else {
        throw new Error("Failed to create role");
      }
    } catch (err) {
      Swal.fire({
        icon: "error",
        title: "Creation Failed",
        text: err.message || "An error occurred while creating the role.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  // DELETE
  const handleDelete = async (id) => {
    const result = await Swal.fire({
      title: "Are you sure?",
      text: "This cannot be undone. This will reflect in 60 seconds and affect all users with this role.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#DD6B55",
      cancelButtonColor: "#aaa",
      confirmButtonText: "Yes, delete it!",
    });
    if (result.isConfirmed) {
      try {
        const response = await api.delete(`/roles/${id}`);
        if (response.data.success) {
          setUsers((prev) => prev.filter((u) => u.id !== id));
          await Swal.fire({
            icon: "success",
            title: "Deleted!",
            text: "User has been removed.",
            confirmButtonColor: "#2798FF",
          });
        } else {
          throw new Error("Server rejected delete");
        }
      } catch (err) {
        Swal.fire({
          icon: "error",
          title: "Delete Failed",
          text: err.message,
          confirmButtonColor: "#DD6B55",
        });
      }
    }
    setActiveDropdown(null);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      // Only send the 'name' field for update
      const formattedPayloadUpdate = { name: formData.role };
      const response = await api.post(
        `/roles/update/${editingUser.id}`,
        formattedPayloadUpdate
      );
      if (
        response.data.success ||
        response.data.status === true ||
        response.status === 200
      ) {
        // Update the users list with the edited user
        setUsers(
          users.map((user) =>
            user.id === editingUser.id ? { ...user, ...formData } : user
          )
        );
        setIsModalOpen(false);
        await Swal.fire({
          icon: "success",
          title: "User Updated",
          text: `User was successfully updated.`,
          confirmButtonColor: "#2798FF",
        });
        window.location.reload();
      } else {
        Swal.fire({
          icon: "error",
          title: "Update Failed",
          text: "Failed to update user.",
          confirmButtonColor: "#DD6B55",
        });
      }
    } catch (err) {
      Swal.fire({
        icon: "error",
        title: "Update Failed",
        text: err.message,
        confirmButtonColor: "#DD6B55",
      });
    }
    setActiveDropdown(null);
  };

  const formatAddress = (address) => {
    try {
      const parsedAddress = JSON.parse(address);
      if (parsedAddress && typeof parsedAddress === "object") {
        const { blockUnitStreetName, city, state, country, pincode } =
          parsedAddress;
        return (
          <>
            <span className="font-bold">{blockUnitStreetName}</span>
            <br />
            {city}, {state}, {country}
            <br />
            {pincode}, {country}
          </>
        );
      }
    } catch (e) {
      // Not a JSON string, treat as plain text
    }
    return address;
  };

  if (loading) {
    return (
      <div className="w-full min-h-[797px] flex items-center justify-center">
        Loading...
      </div>
    );
  }

  return (
    <div
    className={`min-h-[440px] p-4 md:p-6 relative bg-gradient-to-br from-white to-[#E7F4FF] rounded-[10px] shadow-[2px_2px_6px_rgba(24,95,235,0.1)] flex flex-col w-full   ${
        isCollapsed ? "lg:max-w-[85vw] md:w-[85vw]" : "lg:max-w-[75vw] md:w-[80vw]"
      } md:mx-auto`}
      >
      {/* Header Section */}
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8 ">
        {/* Title */}
        <div className="flex gap-6 mb-2 md:mb-0">
          <button
            onClick={() => setActiveScreen("roles")}
            className="focus:outline-none"
          >
            <h2
              className={`text-[20px] md:text-[22px] font-medium text-[#1F2837] whitespace-nowrap pb-1 ${
                activeScreen === "roles"
                  ? "border-b-2 border-[#2798FF]"
                  : "border-b-2 border-transparent"
              }`}
            >
              Roles
            </h2>
          </button>
          <button
            onClick={() => setActiveScreen("permissions")}
            className="focus:outline-none"
          >
            <h2
              className={`text-[20px] md:text-[22px] font-medium text-[#1F2837] whitespace-nowrap pb-1 ${
                activeScreen === "permissions"
                  ? "border-b-2 border-[#2798FF]"
                  : "border-b-2 border-transparent"
              }`}
            >
              Permissions
            </h2>
          </button>
        </div>

        <div className="flex items-center gap-3 md:gap-4">
          {activeScreen === "roles" ? (
            <button
              onClick={() => setIsAddRoleModalOpen(true)}
              className=" hover:bg-blue-500
        bg-[#ef7e1b] text-white
        h-[44px] px-8
        rounded-[8px]
        flex items-center justify-center
      "
            >
              Add Role
            </button>
          ) : (
            <div className="relative">
              <button
                onClick={() => setIsRoleDropdownOpen((prev) => !prev)}
                className="bg-[#ef7e1b] text-white h-[44px] px-4 rounded-[8px] flex items-center justify-center gap-2"
              >
                <span>{selectedRole?.name || "Select Role Name"}</span>
                <FiChevronDown />
              </button>
              {isRoleDropdownOpen && (
                <div className="absolute right-0 mt-2 w-48 rounded-md shadow-md bg-gradient-to-br from-white to-[#E7F4FF] z-10 overflow-hidden">
                  <div>
                    {selectedRole && (
                      <>
                        <button
                          onClick={(e) => {
                            e.preventDefault();
                            setSelectedRole(null);
                            setIsRoleDropdownOpen(false);
                          }}
                          className="group flex items-center px-4 py-2 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors"
                        >
                          <span className="group-hover:text-white transition-colors">
                            Select Role Name
                          </span>
                        </button>
                        <svg
                          className="w-full h-[1px]"
                          viewBox="0 0 100 1"
                          preserveAspectRatio="none"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <polygon points="0,0 50,1 100,0" fill="#E5E7EB" />
                        </svg>
                      </>
                    )}
                    {users.map((role, idx) => (
                      <React.Fragment key={role.id}>
                        <button
                          onClick={(e) => {
                            e.preventDefault();
                            setSelectedRole({
                              id: role.id,
                              name: formatRoleName(role.name),
                            });
                            setIsRoleDropdownOpen(false);
                          }}
                          className="group flex items-center px-4 py-2 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors"
                        >
                          <span className="group-hover:text-white transition-colors">
                            {formatRoleName(role.name)}
                          </span>
                        </button>
                        {idx < users.length - 1 && (
                          <svg
                            className="w-full h-[1px]"
                            viewBox="0 0 100 1"
                            preserveAspectRatio="none"
                            xmlns="http://www.w3.org/2000/svg"
                          >
                            <polygon points="0,0 50,1 100,0" fill="#E5E7EB" />
                          </svg>
                        )}
                      </React.Fragment>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      </div>

      {activeScreen === "roles" ? (
        <>
          {/* User List Table */}
          <div className="w-full flex-grow ">
            <table className="w-full  border-collapse">
              <colgroup>
                <col style={{ width: "12.5%" }} />
                <col style={{ width: "12.5%" }} />
                <col style={{ width: "75%" }} />
              </colgroup>
              <thead>
                <tr className="text-left text-[#4B5563]">
                  {/* <th className="py-4 px-6 font-medium text-sm">Name</th> */}
                  {/* <th className="py-4 px-6 font-medium text-sm">Email</th> */}
                  <th className="py-4 px-6 font-medium text-sm">Role</th>
                  {/* <th className="py-4 px-6 font-medium text-sm">Descriptions</th> */}
                  <th className="py-4 px-6 font-medium text-sm">Actions</th>
                  <th className="py-4 px-6 font-medium text-sm" />
                </tr>
              </thead>
              <tbody>
                {users.length === 0 ? (
                  <tr>
                    <td
                      colSpan="3"
                      className="py-8 px-6 text-center text-[#4B5563]"
                    >
                      No users available.
                    </td>
                  </tr>
                ) : (
                  users.map((role) => {
                    return (
                      <tr key={role.id} className="border-t border-[#E5E7EB]">
                        {/* <td className="py-4 px-6 text-sm text-[#4B5563]">
                          <div className="flex items-center gap-3">
                            <img
                              src={user.image || dummyAvatar}
                              alt={user.name}
                              className="w-10 h-10 rounded-full"
                            />
                            <span>{user.name}</span>
                          </div>
                        </td> */}
                        {/* <td className="py-4 px-6 text-sm text-[#4B5563]">
                          {user.email}
                        </td> */}
                        <td className="py-4 px-6 text-sm text-[#4B5563] whitespace-nowrap">
                          {formatRoleName(role.name) || "N/A"}
                        </td>
                        {/* <td className="py-4 px-6 text-sm text-[#4B5563]">
                          {formatAddress(user.address)}
                        </td> */}
                        <td className="py-4 px-6 relative">
                          <button
                            onClick={() => toggleDropdown(role.id)}
                            className="p-2 text-[#4B5563] hover:bg-blue-200 hover:text-white rounded-full transition-colors "
                          >
                            <TbDotsVertical className="w-4 h-4" />
                          </button>
                          {activeDropdown === role.id && (
                            <div className="relative">
                              {/* Trigger, etc. */}
                              <div className="absolute left-3 w-24 rounded-md shadow-md bg-gradient-to-br from-white to-[#E7F4FF] z-10 overflow-hidden">
                                <div className="">
                                  {/* EDIT button */}
                                  <button
                                    onClick={() => handleEdit(role)}
                                    className="group flex items-center px-2 py-1 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors first:rounded-t-md"
                                  >
                                    <svg
                                      xmlns="http://www.w3.org/2000/svg"
                                      width="24"
                                      height="24"
                                      viewBox="0 0 24 24"
                                      className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                    >
                                      <path
                                        fill="currentColor"
                                        d="M4 14v-2h7v2zm0-4V8h11v2zm0-4V4h11v2zm9 14v-3.075l6.575-6.55l3.075 3.05L16.075 20zm7.5-6.575l-.925-.925zm-6 5.075h.95l3.025-3.05l-.45-.475l-.475-.45l-3.05 3.025zm3.525-3.525l-.475-.45l.925.925z"
                                      />
                                    </svg>
                                    <span className="group-hover:text-white transition-colors">
                                      Edit
                                    </span>
                                  </button>
                                  {/* Tapered separator (geometric taper) */}
                                  <svg
                                    className="w-full h-[1px]" // adjust h-1 or h-2 as needed
                                    viewBox="0 0 100 1"
                                    preserveAspectRatio="none"
                                    xmlns="http://www.w3.org/2000/svg"
                                  >
                                    <polygon
                                      points="0,0 50,1 100,0"
                                      fill="#E5E7EB"
                                    />
                                  </svg>
                                  {/* DELETE button */}
                                  <button
                                    onClick={() => handleDelete(role.id)}
                                    className="group flex items-center px-2 py-1 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors last:rounded-b-md"
                                  >
                                    <svg
                                      xmlns="http://www.w3.org/2000/svg"
                                      width="24"
                                      height="24"
                                      viewBox="0 0 24 24"
                                      className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                    >
                                      <path
                                        fill="currentColor"
                                        d="M7.616 20q-.672 0-1.144-.472T6 18.385V6H5V5h4v-.77h6V5h4v1h-1v12.385q0 .69-.462 1.153T16.384 20zM17 6H7v12.385q0 .269.173.442t.443.173h8.769q.23 0 .423-.192t.192-.424zM9.808 17h1V8h-1zm3.384 0h1V8h-1zM7 6v13z"
                                      />
                                    </svg>
                                    <span className="group-hover:text-white transition-colors">
                                      Delete
                                    </span>
                                  </button>
                                </div>
                              </div>
                            </div>
                          )}
                        </td>
                        <td>
                          <span style={{ opacity: 0, pointerEvents: "none" }}>
                            spacer
                          </span>
                        </td>
                      </tr>
                    );
                  })
                )}
              </tbody>
            </table>
          </div>
        </>
      ) : (
        <div className="w-full flex-grow">
          {selectedRole == null ? (
            <div className="flex flex-col items-center justify-center min-h-[300px] w-full">
              <svg
                width="64"
                height="64"
                fill="none"
                viewBox="0 0 64 64"
                className="mb-4"
              >
                <rect width="64" height="64" rx="16" fill="#E7F4FF" />
                <path
                  d="M32 20a12 12 0 1 1 0 24a12 12 0 0 1 0-24zm0 2a10 10 0 1 0 0 20a10 10 0 0 0 0-20zm0 24c7.732 0 14 2.239 14 5v1a1 1 0 0 1-1 1H19a1 1 0 0 1-1-1v-1c0-2.761 6.268-5 14-5zm0 2c-7.18 0-12 2.09-12 3v.5h24V49c0-.91-4.82-3-12-3z"
                  fill="#2798FF"
                />
              </svg>
              <div className="text-lg md:text-xl font-medium text-[#4B5563] text-center">
                Please select a role to manage permissions
              </div>
              <div className="text-sm text-[#6B7280] mt-2 text-center">
                Use the{" "}
                <span className="font-semibold text-[#2798FF]">
                  Select Role Name
                </span>{" "}
                dropdown above to choose a role.
              </div>
            </div>
          ) : (
            <div>
              <PermissionsTable
                permissions={permissions}
                onPermissionChange={handlePermissionChange}
              />
            </div>
          )}
        </div>
      )}

      {/* Edit Modal */}
      {isModalOpen && (
        <div className="fixed inset-0 flex items-center justify-center z-50">
          {/* Frosted overlay */}
          <div
            className="absolute inset-0 bg-gray-50/10 backdrop-blur-sm border border-white/30"
            onClick={() => setIsModalOpen(false)}
          />

          {/* Glassmorphism modal container */}
          <div
            className="
    w-11/12 max-w-[800px] max-h-[90vh] overflow-y-auto p-6 md:p-8
    rounded-2xl
    bg-gradient-to-br from-[#FFFFFF] to-[#E6F4FF]
    shadow-lg
    relative z-10
  "
          >
            {/* Close button */}
            <button
              onClick={() => setIsModalOpen(false)}
              className="absolute top-6 right-6 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13 1L1 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M1 1L13 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Modal title */}
            <h2 className="text-[29px] font-medium text-[#1F2837] mb-8">
              Edit Role
            </h2>

            {/* Only Role Field */}
            <form onSubmit={handleSubmit}>
              <div className="space-y-2">
                <label className="block text-[#4B5563] text-[16px] mb-2">
                  Role Name
                </label>
                <input
                  type="text"
                  name="role"
                  value={formData.role || ""}
                  onChange={handleInputChange}
                  className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454]"
                  required
                />
              </div>
              <div className="mt-10 flex justify-center">
                <button
                  type="submit"
                  className="w-[207px] h-[46px] bg-[#ef7e1b] text-white rounded-[10px] hover:bg-[#ee7f1b] transition-colors"
                >
                  Save
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Add Role Modal */}
      {isAddRoleModalOpen && (
        <div className="fixed inset-0 flex items-center justify-center z-50">
          <div
            className="absolute inset-0 bg-gray-50/10 backdrop-blur-sm"
            onClick={handleCloseModal}
          />
          <div className="w-11/12 max-w-[800px] max-h-[90vh] overflow-y-auto p-6 md:p-8 rounded-2xl bg-gradient-to-br from-white to-[#E6F4FF] shadow-lg relative z-10">
            <button
              onClick={handleCloseModal}
              className="absolute top-6 right-6 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13 1L1 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M1 1L13 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>
            <h2 className="text-[29px] font-medium text-[#1F2837] mb-8">
              Add New Role
            </h2>
            <form onSubmit={handleAddRoleSubmit}>
              <div className="space-y-2">
                <label className="block text-[#4B5563] text-[16px] mb-2">
                  Role Name
                </label>
                <input
                  type="text"
                  name="role"
                  value={newRoleData.role || ""}
                  onChange={handleNewRoleChange}
                  className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454]"
                  required
                />
              </div>
              <div className="mt-10 flex justify-center">
                <button
                  type="submit"
                  className="w-[207px] h-[46px] bg-[#ef7e1b] text-white rounded-[10px] hover:bg-[#ee7f1b] transition-colors"
                >
                  Create Role
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
};

// --- Sub-components for Permissions ---

const PermissionToggle = ({ checked, onChange }) => {
  return (
    <button
      type="button"
      onClick={onChange}
      className={`relative inline-flex items-center h-6 rounded-full w-11 transition-colors ${
        checked ? "bg-[#ef7e1b]" : "bg-gray-300"
      }`}
    >
      <span
        className={`inline-block w-4 h-4 transform bg-white rounded-full transition-transform ${
          checked ? "translate-x-6" : "translate-x-1"
        }`}
      />
    </button>
  );
};

const PermissionsTable = ({ permissions, onPermissionChange }) => {
  const headers = ["Module", "View", "Create", "Edit", "Delete"];

  return (
    <div className="w-full rounded-lg  overflow-hidden">
      {/* Header */}
      <div className="grid grid-cols-[2fr_0.75fr_0.75fr_0.75fr_0.75fr_2fr] gap-x-4 px-6 py-4 border-b border-gray-200 ">
        {headers.map((header, index) => (
          <div
            key={header}
            className={`font-medium text-sm text-[#4B5563] ${
              index > 0 ? "text-center" : "text-left"
            }`}
          >
            {header}
          </div>
        ))}
        <div /> {/* Empty header for spacing */}
      </div>

      {/* Body */}
      <div>
        {Object.entries(permissions).map(([moduleName, modulePermissions]) => (
          <div
            key={moduleName}
            className="grid grid-cols-[2fr_0.75fr_0.75fr_0.75fr_0.75fr_2fr] gap-x-4 px-6 py-4 border-b border-gray-200 items-center last:border-b-0 hover:bg-gray-50/30 transition-colors"
          >
            <div className="font-medium text-sm text-[#4B5563]">
              {moduleName}
            </div>
            {Object.keys(modulePermissions).map((permission) => (
              <div key={permission} className="flex justify-center">
                <PermissionToggle
                  checked={modulePermissions[permission]}
                  onChange={() => onPermissionChange(moduleName, permission)}
                />
              </div>
            ))}
            <div /> {/* Empty cell for spacing */}
          </div>
        ))}
      </div>
    </div>
  );
};

export default RolesPermissions;
</file>

<file path="src/routes/AppRoutes.jsx">
// src/routes/AppRoutes.jsx
import { Routes, Route, Navigate } from "react-router-dom";
import Layout from "../components/Layout";
import { useAuth } from "../auth/AuthContext";

// Page imports
import Dashboard from "../pages/dashboard/dashboard";
import LeadsAll from "../pages/leads/AllLeads";
import QuotationCreate from "../pages/quotation/CreateQuotation";
import QuotationView from "../pages/quotation/View";

import CustomerInquiry from "../pages/customer inquiry/Customer";
import RolesPermissions from "../pages/settings/RolesPermissions";
import CreateUser from "../pages/settings/CreateNewUser";
import OrgInfo from "../pages/settings/OrganisationInfo";
import Logout from "../pages/logout/logout";
import Login from "../pages/login/Login";
import UpdateProfile from "../pages/settings/UpdateProfile";
import CustomLeadsComponent from "../pages/leads/CustomLeadsComponent";
import LeadsSettings from "../pages/settings/LeadsSettings";
import CreatePayment from "../pages/payment/CreatePayment";
import ViewPayment from "../pages/payment/ViewPayment";
import ViewInvoice from "../pages/invoice/ViewInvoice";
import CreateInvoice from "../pages/invoice/CreateInvoice";

function PrivateRoute({ children, roles }) {
  const { user, loading, rolePermissions } = useAuth();
  if (loading) {
    return null;
  }
  if (!user) return <Navigate to="/login" replace />;
  if (roles && !roles.includes(user.role))
    return <Navigate to="/dashboard" replace />;
  return children;
}

// PermissionRoute: checks for 'view' permission on a module
function PermissionRoute({ moduleName, children }) {
  const { rolePermissions, loading } = useAuth();
  if (loading) return null;

  // If rolePermissions is "ALL", allow access to everything
  if (
    typeof rolePermissions === "string" &&
    rolePermissions.trim().toUpperCase() === "ALL"
  ) {
    return children;
  }

  const modulePerm = rolePermissions?.find(
    (perm) => perm.module.toLowerCase() === moduleName.toLowerCase()
  );
  const hasView = modulePerm?.permissions?.includes("view");
  if (!hasView) return <Navigate to="/dashboard" replace />;
  return children;
}

// PermissionActionRoute: checks for a specific action permission on a module
function PermissionActionRoute({ moduleName, action, children }) {
  const { rolePermissions, loading } = useAuth();
  if (loading) return null;

  // If rolePermissions is "ALL", allow access to everything
  if (
    typeof rolePermissions === "string" &&
    rolePermissions.trim().toUpperCase() === "ALL"
  ) {
    return children;
  }

  const modulePerm = rolePermissions?.find(
    (perm) => perm.module.toLowerCase() === moduleName.toLowerCase()
  );
  const hasAction = modulePerm?.permissions?.includes(action);
  if (!hasAction) return <Navigate to="/dashboard" replace />;
  return children;
}

export default function AppRoutes() {
  return (
    <Routes>
      {/* Public login route */}
      <Route path="/login" element={<Login />} />

      {/* Redirect root to dashboard */}
      <Route path="/" element={<Navigate to="/dashboard" replace />} />

      {/* Protected routes under Layout */}
      <Route
        path="/"
        element={
          <PrivateRoute>
            <Layout />
          </PrivateRoute>
        }
      >
        <Route index element={<Navigate to="dashboard" replace />} />
        <Route path="dashboard" element={<Dashboard />} />

        {/* Leads routes (flattened) */}
        <Route
          path="leads/all"
          element={
            <PrivateRoute>
              <PermissionRoute moduleName="Leads">
                <LeadsAll />
              </PermissionRoute>
            </PrivateRoute>
          }
        />
        <Route
          path="leads/:statusId/:statusName"
          element={
            <PrivateRoute>
              <PermissionRoute moduleName="Leads">
                <CustomLeadsComponent
                  apiEndpoint="/leadstatus/:statusId"
                  headerTitle="All :statusName Items"
                  modalTitle="Edit :statusName Item"
                />
              </PermissionRoute>
            </PrivateRoute>
          }
        />

        {/* Quotation routes (flattened) */}
        <Route
          path="quotation/create"
          element={
            <PrivateRoute>
              <PermissionRoute moduleName="Quotation">
                <PermissionActionRoute moduleName="Quotation" action="create">
                  <QuotationCreate />
                </PermissionActionRoute>
              </PermissionRoute>
            </PrivateRoute>
          }
        />
        <Route
          path="quotation/view"
          element={
            <PrivateRoute>
              <PermissionRoute moduleName="Quotation">
                <QuotationView />
              </PermissionRoute>
            </PrivateRoute>
          }
        />

        {/* Invoice routes (flattened) */}
        <Route
          path="invoice/create"
          element={
            <PrivateRoute>
              <PermissionRoute moduleName="Invoice">
                <PermissionActionRoute moduleName="Invoice" action="create">
                  <CreateInvoice />
                </PermissionActionRoute>
              </PermissionRoute>
            </PrivateRoute>
          }
        />
        <Route
          path="invoice/view"
          element={
            <PrivateRoute>
              <PermissionRoute moduleName="Invoice">
                <ViewInvoice />
              </PermissionRoute>
            </PrivateRoute>
          }
        />

        {/* Payment routes (flattened) */}
        <Route
          path="payment/create"
          element={
            <PrivateRoute>
              <CreatePayment />
            </PrivateRoute>
          }
        />
        <Route
          path="payment/view"
          element={
            <PrivateRoute>
              <ViewPayment />
            </PrivateRoute>
          }
        />

        {/* Customer Inquiry */}
        <Route
          path="customer-inquiry"
          element={
            <PrivateRoute>
              <CustomerInquiry />
            </PrivateRoute>
          }
        />

        {/* Settings (admin only, flattened) */}
        <Route
          path="settings/roles"
          element={
            <PrivateRoute roles={["admin"]}>
              <RolesPermissions />
            </PrivateRoute>
          }
        />
        <Route
          path="settings/users"
          element={
            <PrivateRoute roles={["admin"]}>
              <CreateUser />
            </PrivateRoute>
          }
        />
        <Route
          path="settings/org"
          element={
            <PrivateRoute roles={["admin"]}>
              <OrgInfo />
            </PrivateRoute>
          }
        />
        <Route
          path="settings/update-profile"
          element={
            <PrivateRoute>
              <UpdateProfile />
            </PrivateRoute>
          }
        />
        <Route
          path="settings/leads-settings"
          element={
            <PrivateRoute roles={["admin"]}>
              <LeadsSettings />
            </PrivateRoute>
          }
        />

        {/* Logout route */}
        <Route path="logout" element={<Logout />} />
      </Route>

      {/* Fallback 404 */}
      <Route path="*" element={<h1>404 - Not Found</h1>} />
    </Routes>
  );
}
</file>

<file path="tailwind.config.js">
// tailwind.config.js
module.exports = {
  content: [
    "./index.html",
    "./src/**/*.{js,jsx,ts,tsx,css}",
    "./src/components/tiptap-templates/simple/**/*.{js,jsx}"
  ],
  theme: {
    extend: {
       screens: {
      custom: '1322px', // your custom breakpoint
    },
      fontFamily: {
        sans: ['"SF Pro Display"', 'Montserrat', 'ui-sans-serif', 'system-ui'],
        sfpro: ['"SF Pro Display"', 'sans-serif'],
        mont: ['Montserrat', 'sans-serif'],
         quicksand: ['Quicksand', 'sans-serif'],
      },

    },
  },
  plugins: [],
}
</file>

<file path="src/components/Sidebar.jsx">
// src/components/Sidebar.jsx

import { NavLink } from "react-router-dom";
import { useAuth } from "../auth/AuthContext";
import { useState, useEffect } from "react";
import api from "../api";

const initialMenu = [
  {
    label: "Dashboard",
    path: "/dashboard",
    icon: (
      <div className="w-6 h-6 flex items-center justify-center">
        <img
          src="/dashboard.svg"
          alt="Dashboard"
          className="w-5 h-5 transition-all [filter:invert(35%)_sepia(6%)_saturate(285%)_hue-rotate(353deg)_brightness(94%)_contrast(89%)] group-[.active]:brightness-0 group-[.active]:invert"
        />
      </div>
    ),
  },
  {
    label: "Leads",
    icon: (
      <div className="w-6 h-6 flex items-center justify-center">
        <img
          src="/leadicon.png"
          alt="leads"
          className="w-5 h-5 transition-all [filter:invert(12%)_sepia(6%)_saturate(285%)_hue-rotate(353deg)_brightness(94%)_contrast(89%)] group-[.active]:brightness-0 group-[.active]:invert"
        />
      </div>
    ),
    children: [
      { label: "All Leads", path: "/leads/all" },
      // Dynamic lead statuses will be inserted here
    ],
  },
  {
    label: "Quotation",
    icon: (
      <div className="w-6 h-6 flex items-center justify-center">
        <img
          src="/quotation.svg"
          alt="Quotation"
          className="w-6 h-6 transition-all [filter:invert(12%)_sepia(6%)_saturate(285%)_hue-rotate(353deg)_brightness(94%)_contrast(89%)] group-[.active]:brightness-0 group-[.active]:invert"
        />
      </div>
    ),
    children: [
      { label: "All Quotation", path: "/quotation/view" },
      { label: "Create New", path: "/quotation/create" },
    ],
  },
  {
    label: "Invoice",
    icon: (
      <div className="w-6 h-6 flex items-center justify-center">
        <img
          src="/Invoice.svg"
          alt="Invoice"
          className="w-5 h-5 transition-all [filter:invert(12%)_sepia(6%)_saturate(285%)_hue-rotate(353deg)_brightness(94%)_contrast(89%)] group-[.active]:brightness-0 group-[.active]:invert"
        />
      </div>
    ),
    children: [
      { label: "All Invoices", path: "/invoice/view" },
      { label: "Create New", path: "/invoice/create" },
    ],
  },
  // {
  //   label: "Payment",
  //   path: "/payment",
  //   icon: (
  //     <div className="w-6 h-6 flex items-center justify-center">
  //       <img
  //         src="/payments.svg"
  //         alt="Payment"
  //         className="w-5 h-5 transition-all [filter:invert(12%)_sepia(6%)_saturate(285%)_hue-rotate(353deg)_brightness(94%)_contrast(89%)] group-[.active]:brightness-0 group-[.active]:invert"
  //       />
  //     </div>
  //   ),
  // },
  // {
  //   label: "Customer Inquiry",
  //   path: "/customer-inquiry",
  //   icon: (
  //     <div className="w-6 h-6 flex items-center justify-center">
  //       <img
  //         src="/CustomerInquiry.png"
  //         alt="Customer Inquiry"
  //         className="w-4.5 h-4.5 transition-all [filter:invert(12%)_sepia(6%)_saturate(285%)_hue-rotate(353deg)_brightness(94%)_contrast(89%)] group-[.active]:brightness-0 group-[.active]:invert"
  //       />
  //     </div>
  //   ),
  // },
  {
    label: "Settings",
    icon: (
      <div className="w-6 h-6 flex items-center justify-center">
        <img
          src="/setting-2.png"
          alt="settings"
          className="w-5 h-5 transition-all [filter:invert(12%)_sepia(6%)_saturate(285%)_hue-rotate(353deg)_brightness(94%)_contrast(89%)] group-[.active]:brightness-0 group-[.active]:invert"
        />
      </div>
    ),
    children: [
      { label: "Roles & Permission", path: "/settings/roles" },
      { label: "Create New User", path: "/settings/users" },
      { label: "Organization Info", path: "/settings/org" },
      { label: "Update Profile", path: "/settings/update-profile" },
      { label: "Leads Settings", path: "/settings/leads-settings" },
    ],
  },
  {
    label: "Log Out",
    path: "/logout",
    icon: (
      <div className="w-6 h-6 flex items-center justify-center">
        <img
          src="/logout.png"
          alt="logout"
          className="w-5 h-5 ml-1 transition-all [filter:invert(12%)_sepia(6%)_saturate(285%)_hue-rotate(353deg)_brightness(98%)_contrast(89%)] group-[.active]:brightness-0 group-[.active]:invert"
        />
      </div>
    ),
  },
];

function formatRoleName(roleName) {
  if (!roleName || typeof roleName !== "string") return roleName;
  return roleName
    .split("_")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(" ");
}

export default function Sidebar({ isCollapsed, setIsCollapsed, isMobile }) {
  const { user, rolePermissions } = useAuth();
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  const [isMobileCollapsed, setIsMobileCollapsed] = useState(false);
  const [profilePicError, setProfilePicError] = useState(false);
  const [leadStatuses, setLeadStatuses] = useState([]);
  const [sidebarMenu, setSidebarMenu] = useState(initialMenu);

  console.log("user", user);
  console.log("rolePermissions", rolePermissions);

  useEffect(() => {
    if (user?.profile_pic) {
      setProfilePicError(false);
    }
  }, [user]);

  useEffect(() => {
    const fetchLeadStatuses = async () => {
      try {
        const response = await api.get("/showleadstatus");
        if (response.data.success) {
          setLeadStatuses(response.data.data);
        }
      } catch (error) {
        console.error("Error fetching lead statuses:", error);
      }
    };

    fetchLeadStatuses();
  }, []);

  useEffect(() => {
    if (leadStatuses?.length > 0) {
      const updatedMenu = initialMenu.map((item) => {
        if (item.label === "Leads") {
          const dynamicChildren = leadStatuses.map((status) => ({
            label: status.status_name,
            path: `/leads/${status.status_id}/${encodeURIComponent(
              status.status_name
            )}`,
          }));
          const staticChildren = item.children.filter(
            (child) => child.label === "All Leads"
          );
          return {
            ...item,
            children: [...staticChildren, ...dynamicChildren],
          };
        }
        return item;
      });
      setSidebarMenu(updatedMenu);
    }
  }, [leadStatuses]);

  // Close mobile menu when clicking outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        isMobile &&
        isMobileMenuOpen &&
        !event.target.closest(".mobile-sidebar") &&
        !event.target.closest(".hamburger-button")
      ) {
        setIsMobileMenuOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [isMobile, isMobileMenuOpen]);

  // Helper: Check if user has "view" permission for a module
  function hasViewPermission(moduleLabel) {
    if (rolePermissions === "ALL") return true;
    if (!Array.isArray(rolePermissions)) return false;
    // Only check for objects, skip string entries like "noBulkAssign"
    return rolePermissions.some(
      (perm) =>
        perm &&
        typeof perm === "object" &&
        perm.module === moduleLabel &&
        Array.isArray(perm.permissions) &&
        perm.permissions.includes("view")
    );
  }

  // Helper: Check if user has "create" permission for a module
  function hasCreatePermission(moduleLabel) {
    if (rolePermissions === "ALL") return true;
    if (!Array.isArray(rolePermissions)) return false;
    return rolePermissions.some(
      (perm) =>
        perm &&
        typeof perm === "object" &&
        perm.module === moduleLabel &&
        Array.isArray(perm.permissions) &&
        perm.permissions.includes("create")
    );
  }

  // Filter menu items based on role and permissions
  const items = sidebarMenu.reduce((acc, item) => {
    if (item.label === "Settings") {
      if (user.role === "admin") {
        acc.push(item);
      } else {
        const filteredChildren = item.children.filter(
          (sub) => sub.path === "/settings/update-profile"
        );
        if (filteredChildren.length > 0) {
          acc.push({
            ...item,
            children: filteredChildren,
          });
        }
      }
    } else if (["Leads", "Quotation", "Invoice"].includes(item.label)) {
      // Only show if user has "view" permission for this module
      if (hasViewPermission(item.label)) {
        // For Invoice and Quotation, filter 'Create New' child if no create permission
        if (
          (item.label === "Invoice" || item.label === "Quotation") &&
          Array.isArray(item.children)
        ) {
          const filteredChildren = item.children.filter(
            (child) =>
              child.label !== "Create New" || hasCreatePermission(item.label)
          );
          acc.push({ ...item, children: filteredChildren });
        } else {
          acc.push(item);
        }
      }
    } else {
      acc.push(item);
    }
    return acc;
  }, []);

  // Role mapping for display
  const roleDisplayMap = {
    admin: "Administrator",
    user: "User",
    manager: "Manager",
    // etc.
  };
  const roleLabel =
    user && user.role
      ? formatRoleName(roleDisplayMap[user.role] || user.role)
      : "";

  // Compute displayName: prefer username, else email prefix
  let displayName = "";
  if (user) {
    if (user.username && user.username.trim() !== "") {
      displayName = user.username;
    } else if (user.email) {
      displayName = user.email.split("@")[0];
    }
  }

  // Hamburger button component for mobile
  const HamburgerButton = () => (
    <button
      onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
      className="hamburger-button fixed top-4 left-4 z-50 md:hidden w-10 h-10 flex flex-col items-center justify-center bg-white/95 backdrop-blur-[160px] border border-[#F5EFE9] rounded-lg shadow-sm"
    >
      <span
        className={`block w-6 h-0.5 bg-[#242220] transition-all duration-300 ${
          isMobileMenuOpen ? "rotate-45 translate-y-1.5" : ""
        }`}
      ></span>
      <span
        className={`block w-6 h-0.5 bg-[#242220] mt-1 transition-all duration-300 ${
          isMobileMenuOpen ? "opacity-0" : ""
        }`}
      ></span>
      <span
        className={`block w-6 h-0.5 bg-[#242220] mt-1 transition-all duration-300 ${
          isMobileMenuOpen ? "-rotate-45 -translate-y-1.5" : ""
        }`}
      ></span>
    </button>
  );

  // Mobile overlay when sidebar is open
  const MobileOverlay = () => (
    <div
      className={`fixed inset-0 bg-black/50 z-40 md:hidden transition-opacity duration-300 ${
        isMobileMenuOpen ? "opacity-100" : "opacity-0 pointer-events-none"
      }`}
    />
  );

  const handleCollapseToggle = () => {
    if (isMobile) {
      if (!isMobileMenuOpen) {
        setIsMobileMenuOpen(true);
        setIsMobileCollapsed(true);
      } else {
        setIsMobileCollapsed(!isMobileCollapsed);
      }
    } else {
      setIsCollapsed(!isCollapsed);
    }
  };

  return (
    <>
      {/* Hamburger button for mobile */}
      <HamburgerButton />

      {/* Mobile overlay */}
      <MobileOverlay />

      {/* Sidebar */}
      <nav
        className={`rounded-3xl mobile-sidebar bg-white/95 backdrop-blur-[160px] border-r border-[#F5EFE9] transition-all duration-300
          ${
            isMobile
              ? `fixed left-0 top-0 h-screen overflow-y-auto z-50 ${
                  isMobileMenuOpen
                    ? isMobileCollapsed
                      ? "w-[80px] translate-x-0"
                      : "w-[270px] translate-x-0"
                    : "-translate-x-full w-[270px]"
                }`
              : `relative z-10 min-h-screen flex-shrink-0 ${
                  isCollapsed ? "w-[80px]" : "w-[270px]"
                }`
          }`}
      >
        {/* Traffic lights (shown when expanded) */}
        {((!isCollapsed && !isMobile) || (!isMobileCollapsed && isMobile)) && (
          <div className="flex gap-2 p-6">
            <div className="w-3 h-3 rounded-full bg-[#FF5A52]" />
            <div className="w-3 h-3 rounded-full bg-[#E0B42F]" />
            <div className="w-3 h-3 rounded-full bg-[#53C22B]" />
          </div>
        )}

        {/* User profile */}
        <div
          className={`px-4 py-4 ${
            (isCollapsed && !isMobile) || (isMobileCollapsed && isMobile)
              ? "px-4"
              : ""
          }`}
        >
          <div className="flex items-center gap-4">
            {user?.profile_pic && !profilePicError ? (
              <img
                src={user.profile_pic}
                alt="User Avatar"
                className="w-12 h-12 rounded-full object-cover flex-shrink-0"
                onError={() => setProfilePicError(true)}
              />
            ) : (
              <div className="w-12 h-12 rounded-full bg-[#8CBFEC] overflow-hidden flex items-center justify-center flex-shrink-0">
                <img
                  src="/Avatar.png"
                  alt="User Avatar"
                  className="w-full h-full object-cover"
                />
              </div>
            )}
            {((!isCollapsed && !isMobile) ||
              (!isMobileCollapsed && isMobile)) && (
              <div>
                <h3 className="text-[#241B1B] font-medium">
                  {displayName || "User"}
                </h3>
                <p className="text-[#241B1B]/50 text-sm">{roleLabel}</p>
              </div>
            )}
          </div>
          {((!isCollapsed && !isMobile) ||
            (!isMobileCollapsed && isMobile)) && (
            <div className="w-full flex items-center justify-center mt-4">
              <div
                className="w-full bg-gray-300"
                style={{
                  height: "1px",
                  clipPath:
                    "polygon(0% 50%, 20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%)",
                  maxHeight: "20px",
                }}
              />
            </div>
          )}
        </div>

        {/* Menu items */}
        <div
          className={`px-4 py-4 ${
            (isCollapsed && !isMobile) || (isMobileCollapsed && isMobile)
              ? "px-2"
              : ""
          }`}
        >
          {((!isCollapsed && !isMobile) ||
            (!isMobileCollapsed && isMobile)) && (
            <h4 className="text-[#242220]/40 text-xs font-medium mb-2 ml-5">
              MAIN MENU
            </h4>
          )}
          <ul className="space-y-2">
            {items.map((item) => (
              <li key={item.label}>
                {/* Spacer above Settings */}
                {item.label === "Settings" &&
                  ((!isCollapsed && !isMobile) ||
                    (!isMobileCollapsed && isMobile)) && (
                    <div className="w-full flex items-center justify-center mt-2 mb-2">
                      <div
                        className="w-full bg-gray-300"
                        style={{
                          height: "1px",
                          clipPath:
                            "polygon(0% 50%, 20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%)",
                          maxHeight: "20px",
                        }}
                      />
                    </div>
                  )}

                {item.children &&
                ((!isCollapsed && !isMobile) ||
                  (!isMobileCollapsed && isMobile)) ? (
                  <details className="group" open>
                    <summary className="flex items-center px-5 py-4 text-[#242220] hover:bg-[#242220]/5 rounded-xl cursor-pointer transition-colors">
                      <span className="mr-3">{item.icon}</span>
                      <span className="text-base text-[#242220]">
                        {item.label}
                      </span>
                      <svg
                        className="ml-auto w-6 h-6 transition-transform group-open:rotate-180 [filter:invert(35%)_sepia(6%)_saturate(285%)_hue-rotate(353deg)_brightness(94%)_contrast(89%)]"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={1.5}
                          d="M6 9l6 6 6-6"
                        />
                      </svg>
                    </summary>
                    {/* Removed overflow-hidden so expanded items push sidebar height */}
                    <ul className="pl-4 relative overflow-hidden">
                      {item.children.map((sub) => (
                        <li key={sub.path} className="flex items-center">
                          <div className="flex-shrink-0 w-7 h-7 relative z-10">
                            <img
                              src="/Vector.svg"
                              alt="Back"
                              className="w-18 h-18 -mt-14 ml-1 [filter:invert(85%)_sepia(11%)_saturate(0%)_hue-rotate(175deg)_brightness(89%)_contrast(90%)]"
                            />
                          </div>
                          <NavLink
                            to={sub.path}
                            onClick={() =>
                              isMobile && setIsMobileMenuOpen(false)
                            }
                            className={({ isActive }) =>
                              `flex items-center px-5 py-4 text-sm -ml-1 rounded-xl transition-all flex-grow ${
                                isActive
                                  ? "bg-[#ef7e1b] text-white active shadow-[0_3px_6px_rgba(124,123,135,0.15),0_6px_10px_rgba(124,123,135,0.12),0_8px_12px_rgba(124,123,135,0.08)]"
                                  : "text-[#242220] hover:bg-[#242220]/5"
                              }`
                            }
                          >
                            {sub.label}
                          </NavLink>
                        </li>
                      ))}
                    </ul>
                  </details>
                ) : (
                  <div className="relative group">
                    <NavLink
                      to={
                        item.path ||
                        (item.children ? item.children[0].path : "#")
                      }
                      onClick={() => isMobile && setIsMobileMenuOpen(false)}
                      className={({ isActive }) =>
                        `flex items-center ${
                          (isCollapsed && !isMobile) ||
                          (isMobileCollapsed && isMobile)
                            ? "px-3 py-4 justify-center"
                            : "px-5 py-4"
                        } rounded-xl transition-all group ${
                          isActive
                            ? "bg-[#ef7e1b] text-white active shadow-[0_3px_6px_rgba(124,123,135,0.15),0_6px_10px_rgba(124,123,135,0.12),0_8px_12px_rgba(124,123,135,0.08)]"
                            : "text-[#242220] hover:bg-[#242220]/5"
                        }`
                      }
                    >
                      <span
                        className={
                          (isCollapsed && !isMobile) ||
                          (isMobileCollapsed && isMobile)
                            ? ""
                            : "mr-3"
                        }
                      >
                        {item.icon}
                      </span>
                      {((!isCollapsed && !isMobile) ||
                        (!isMobileCollapsed && isMobile)) && (
                        <span className="text-base">{item.label}</span>
                      )}
                    </NavLink>

                    {/* Tooltip for collapsed state */}
                    {((isCollapsed && !isMobile) ||
                      (isMobileCollapsed && isMobile)) && (
                      <div className="absolute left-full ml-2 top-1/2 transform -translate-y-1/2 bg-gray-800 text-white text-sm px-2 py-1 rounded opacity-0 pointer-events-none group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap z-50">
                        {item.label}
                      </div>
                    )}
                  </div>
                )}
              </li>
            ))}
          </ul>
        </div>

        {/* Collapse/Expand button */}
        <button
          onClick={handleCollapseToggle}
          className={`absolute -right-3 top-[102px] w-6 h-6 rounded-full flex items-center justify-center transform transition-transform hover:scale-110 ${
            (isCollapsed && !isMobile) || (isMobileCollapsed && isMobile)
              ? "rotate-180"
              : ""
          }`}
        >
          <img src="/Arrow.svg" alt="Back" className="w-7 h-7" />
        </button>
      </nav>
    </>
  );
}
</file>

<file path="src/components/tiptap-templates/simple/simple-editor.jsx">
import * as React from "react";
import { EditorContent, EditorContext, useEditor } from "@tiptap/react";

// --- Tiptap Core Extensions ---
import { StarterKit } from "@tiptap/starter-kit";
import { Image } from "@tiptap/extension-image";
import { TaskItem } from "@tiptap/extension-task-item";
import { TaskList } from "@tiptap/extension-task-list";
import { TextAlign } from "@tiptap/extension-text-align";
import { Typography } from "@tiptap/extension-typography";
import { Highlight } from "@tiptap/extension-highlight";
import { Subscript } from "@tiptap/extension-subscript";
import { Superscript } from "@tiptap/extension-superscript";
import { Underline } from "@tiptap/extension-underline";

// --- Custom Extensions ---
import { Link } from "@/components/tiptap-extension/link-extension";
import { Selection } from "@/components/tiptap-extension/selection-extension";
import { TrailingNode } from "@/components/tiptap-extension/trailing-node-extension";

// --- UI Primitives ---
import { Button } from "@/components/tiptap-ui-primitive/button";
import { Spacer } from "@/components/tiptap-ui-primitive/spacer";
import {
  Toolbar,
  ToolbarGroup,
  ToolbarSeparator,
} from "@/components/tiptap-ui-primitive/toolbar";

// --- Tiptap Node ---
import { ImageUploadNode } from "@/components/tiptap-node/image-upload-node/image-upload-node-extension";
import "@/components/tiptap-node/code-block-node/code-block-node.scss";
import "@/components/tiptap-node/list-node/list-node.scss";
import "@/components/tiptap-node/image-node/image-node.scss";
import "@/components/tiptap-node/paragraph-node/paragraph-node.scss";

// --- Tiptap UI ---
import { HeadingDropdownMenu } from "@/components/tiptap-ui/heading-dropdown-menu";
import { ImageUploadButton } from "@/components/tiptap-ui/image-upload-button";
import { ListDropdownMenu } from "@/components/tiptap-ui/list-dropdown-menu";
import { BlockquoteButton } from "@/components/tiptap-ui/blockquote-button";
import { CodeBlockButton } from "@/components/tiptap-ui/code-block-button";
import {
  ColorHighlightPopover,
  ColorHighlightPopoverContent,
  ColorHighlightPopoverButton,
} from "@/components/tiptap-ui/color-highlight-popover";
import {
  LinkPopover,
  LinkContent,
  LinkButton,
} from "@/components/tiptap-ui/link-popover";
import { MarkButton } from "@/components/tiptap-ui/mark-button";
import { TextAlignButton } from "@/components/tiptap-ui/text-align-button";
import { UndoRedoButton } from "@/components/tiptap-ui/undo-redo-button";

// --- Icons ---
import { ArrowLeftIcon } from "@/components/tiptap-icons/arrow-left-icon";
import { HighlighterIcon } from "@/components/tiptap-icons/highlighter-icon";
import { LinkIcon } from "@/components/tiptap-icons/link-icon";

// --- Hooks ---
import { useMobile } from "@/hooks/use-mobile";
import { useWindowSize } from "@/hooks/use-window-size";
import { useCursorVisibility } from "@/hooks/use-cursor-visibility";

// --- Components ---
import { ThemeToggle } from "@/components/tiptap-templates/simple/theme-toggle";

// --- Lib ---
import { handleImageUpload, MAX_FILE_SIZE } from "@/lib/tiptap-utils";

// --- Styles ---
import "@/components/tiptap-templates/simple/simple-editor.scss";

import content from "@/components/tiptap-templates/simple/data/content.json";

const MainToolbarContent = ({ onHighlighterClick, onLinkClick, isMobile }) => {
  return (
    <>
      <Spacer />
      <ToolbarGroup className="bg-white rounded-md p-1 shadow-sm">
        <UndoRedoButton
          action="undo"
          className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md"
        />
        <UndoRedoButton
          action="redo"
          className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md"
        />
      </ToolbarGroup>
      <ToolbarSeparator className="bg-gray-300" />
      <ToolbarGroup className="bg-white rounded-md p-1 shadow-sm">
        <HeadingDropdownMenu
          levels={[1, 2, 3, 4]}
          className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md"
        />
        <ListDropdownMenu
          types={["bulletList", "orderedList", "taskList"]}
          className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md"
        />
        <BlockquoteButton className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md" />
        <CodeBlockButton className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md" />
      </ToolbarGroup>
      <ToolbarSeparator className="bg-gray-300" />
      <ToolbarGroup className="bg-white rounded-md p-1 shadow-sm">
        <MarkButton
          type="bold"
          className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md"
        />
        <MarkButton
          type="italic"
          className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md"
        />
        <MarkButton
          type="strike"
          className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md"
        />
        <MarkButton
          type="code"
          className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md"
        />
        <MarkButton
          type="underline"
          className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md"
        />
        {!isMobile ? (
          <ColorHighlightPopover />
        ) : (
          <ColorHighlightPopoverButton
            onClick={onHighlighterClick}
            className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md"
          />
        )}
        {!isMobile ? (
          <LinkPopover />
        ) : (
          <LinkButton
            onClick={onLinkClick}
            className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md"
          />
        )}
      </ToolbarGroup>
      <ToolbarSeparator className="bg-gray-300" />
      <ToolbarGroup className="bg-white rounded-md p-1 shadow-sm">
        <MarkButton
          type="superscript"
          className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md"
        />
        <MarkButton
          type="subscript"
          className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md"
        />
      </ToolbarGroup>
      <ToolbarSeparator className="bg-gray-300" />
      <ToolbarGroup className="bg-white rounded-md p-1 shadow-sm">
        <TextAlignButton
          align="left"
          className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md"
        />
        <TextAlignButton
          align="center"
          className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md"
        />
        <TextAlignButton
          align="right"
          className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md"
        />
        <TextAlignButton
          align="justify"
          className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md"
        />
      </ToolbarGroup>
      <ToolbarSeparator className="bg-gray-300" />
      <ToolbarGroup className="bg-white rounded-md p-1 shadow-sm">
        <ImageUploadButton
          text="Add"
          className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md"
        />
      </ToolbarGroup>
      <Spacer />
      {isMobile && <ToolbarSeparator className="bg-gray-300" />}
      <ToolbarGroup className="bg-white rounded-md p-1 shadow-sm">
        <ThemeToggle className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md" />
      </ToolbarGroup>
    </>
  );
};

const MobileToolbarContent = ({ type, onBack }) => (
  <>
    <ToolbarGroup className="bg-white rounded-md p-1 shadow-sm">
      <Button
        data-style="ghost"
        onClick={onBack}
        className="text-[#2798FF] hover:bg-gray-100 p-2 rounded-md"
      >
        <ArrowLeftIcon className="tiptap-button-icon" />
        {type === "highlighter" ? (
          <HighlighterIcon className="tiptap-button-icon" />
        ) : (
          <LinkIcon className="tiptap-button-icon" />
        )}
      </Button>
    </ToolbarGroup>

    <ToolbarSeparator className="bg-gray-300" />

    {type === "highlighter" ? (
      <ColorHighlightPopoverContent />
    ) : (
      <LinkContent />
    )}
  </>
);

export function SimpleEditor({ initialContent, onUpdate }) {

  const isMobile = useMobile();
  const windowSize = useWindowSize();
  const [mobileView, setMobileView] = React.useState("main");
  const toolbarRef = React.useRef(null);

  const editor = useEditor({
    immediatelyRender: false,
    editorProps: {
      attributes: {
        autocomplete: "off",
        autocorrect: "off",
        autocapitalize: "off",
        "aria-label": "Main content area, start typing to enter text.",
      },
    },
    extensions: [
      StarterKit,
      TextAlign.configure({ types: ["heading", "paragraph"] }),
      Underline,
      TaskList,
      TaskItem.configure({ nested: true }),
      Highlight.configure({ multicolor: true }),
      Image,
      Typography,
      Superscript,
      Subscript,

      Selection,
      ImageUploadNode.configure({
        accept: "image/*",
        maxSize: MAX_FILE_SIZE,
        limit: 3,
        upload: handleImageUpload,
        onError: (error) => console.error("Upload failed:", error),
      }),
      TrailingNode,
      Link.configure({ openOnClick: false }),
    ],
    content: initialContent || content, // Use initialContent if provided, otherwise fallback to default
    onUpdate: ({ editor }) => {
      onUpdate({ html: editor.getHTML(), json: editor.getJSON() });
    },
  });

  const bodyRect = useCursorVisibility({
    editor,
    overlayHeight: toolbarRef.current?.getBoundingClientRect().height ?? 0,
  });

  React.useEffect(() => {
    if (!isMobile && mobileView !== "main") {
      setMobileView("main");
    }
  }, [isMobile, mobileView]);

  return (
    <EditorContext.Provider value={{ editor }}>
      <Toolbar
        ref={toolbarRef}
        className="bg-[#ef7e1b] rounded-t-lg p-2 shadow-md z-10 "
        style={
          isMobile
            ? {
                bottom: `calc(100% - ${windowSize.height - bodyRect.y}px)`,
              }
            : {}
        }
      >
        {mobileView === "main" ? (
          <MainToolbarContent
            onHighlighterClick={() => setMobileView("highlighter")}
            onLinkClick={() => setMobileView("link")}
            isMobile={isMobile}
          />
        ) : (
          <MobileToolbarContent
            type={mobileView === "highlighter" ? "highlighter" : "link"}
            onBack={() => setMobileView("main")}
          />
        )}
      </Toolbar>
      <div className="content-wrapper md:p-4  rounded-b-lg border border-gray-200">
        <EditorContent
          editor={editor}

          className="simple-editor-content"
        />
      </div>
    </EditorContext.Provider>
  );
}
//before changing anything
</file>

<file path="src/components/tiptap-templates/simple/simple-editor.scss">
@import url("https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap");

body {
  --tt-toolbar-height: 44px;
  --tt-theme-text: var(--tt-gray-light-900);

  .dark & {
    --tt-theme-text: var(--tt-gray-dark-900);
  }
}

body {
  font-family: "Inter", sans-serif;
  color: var(--tt-theme-text);
  font-optical-sizing: auto;
  font-weight: 400;
  font-style: normal;
  padding: 0;
}

html,
body,
#root,
#app {
  height: 100%;
  background-color: var(--tt-bg-color);
}

// body {
//   overflow: hidden;
// }

.tiptap.ProseMirror {
  font-family: "DM Sans", sans-serif;
}

// Add text selection styles for TipTap editor
.tiptap.ProseMirror::selection {
  background-color: #2798ff;
  color: white;
}

.tiptap.ProseMirror::-moz-selection {
  background-color: #2798ff;
  color: white;
}

.tiptap.ProseMirror *::selection {
  background-color: #2798ff;
  color: white;
}

.tiptap.ProseMirror *::-moz-selection {
  background-color: #2798ff;
  color: white;
}

.content-wrapper {
  height: calc(100% - var(--tt-toolbar-height));
  overflow-y: auto;

  &::-webkit-scrollbar {
    display: block;
    width: 0.5rem;
  }

  &::-webkit-scrollbar-track {
    background: transparent;
  }

  &::-webkit-scrollbar-thumb {
    background-color: var(--tt-scrollbar-color);
    border-radius: 4px;
  }

  /* Firefox scrollbar */
  scrollbar-width: thin;
  scrollbar-color: var(--tt-scrollbar-color) transparent;
}

.simple-editor-content {
  width: 100%;
  margin: 0;
}

// .simple-editor-content .tiptap.ProseMirror {
//   padding: 1rem 1rem;
// }

@media screen and (max-width: 480px) {
  .simple-editor-content .tiptap.ProseMirror {
    padding: 1rem 1.5rem;
  }
}

// ... existing code ...
@media screen and (max-width: 768px) {
  .content-wrapper {
    width: 80vw !important;
    min-width: 0;
    max-width: 80vw;
    margin-left: auto;
    margin-right: auto;
    box-sizing: border-box;
  }
  .simple-editor-content {
    width: 100% !important;
    min-width: 0;
    max-width: 100vw;
    font-size: small;
  }

}
</file>

<file path="src/components/tiptap-ui-primitive/toolbar/toolbar.scss">
:root {
  --tt-toolbar-height: 2.75rem;
  --tt-safe-area-bottom: env(safe-area-inset-bottom, 0px);
  --tt-toolbar-bg-color: var(--white);
  --tt-toolbar-border-color: var(--tt-gray-light-a-100);
}

.dark {
  --tt-toolbar-bg-color: var(--black);
  --tt-toolbar-border-color: var(--tt-gray-dark-a-50);
}

.tiptap-toolbar {
  display: flex;
  align-items: center;
  gap: 0.25rem;


  &-group {
    display: flex;
    align-items: center;
    gap: 0.125rem;

    &:empty {
      display: none;
    }

    &:empty + .tiptap-separator,
    .tiptap-separator + &:empty {
      display: none;
    }
  }

  &[data-variant="fixed"] {
    position: sticky;
    top: 0;
    z-index: 10;
    width: 100%;
    min-height: var(--tt-toolbar-height);
    background: var(--tt-toolbar-bg-color);
    border-bottom: 1px solid var(--tt-toolbar-border-color);
    padding: 0 0.5rem;
    overflow-x: auto;
    overscroll-behavior-x: contain;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;

    &::-webkit-scrollbar {
      display: none;
    }


  }

  &[data-variant="floating"] {
    --tt-toolbar-padding: 0.125rem;
    --tt-toolbar-border-width: 1px;

    padding: 0.188rem;
    border-radius: calc(
      var(--tt-toolbar-padding) + var(--tt-radius-lg) +
        var(--tt-toolbar-border-width)
    );
    border: var(--tt-toolbar-border-width) solid var(--tt-toolbar-border-color);
    background-color: var(--tt-toolbar-bg-color);
    box-shadow: var(--tt-shadow-elevated-md);
    outline: none;
    overflow: hidden;

    &[data-plain="true"] {
      padding: 0;
      border-radius: 0;
      border: none;
      box-shadow: none;
      background-color: transparent;
    }

    @media screen and (max-width: 768px) {
      width: 100%;
      border-radius: 0;
      border: none;
      box-shadow: none;
    }
  }
}
</file>

<file path="src/pages/settings/LeadsSettings.jsx">
import React, { useState, useEffect, useCallback } from "react";
import { TbDotsVertical } from "react-icons/tb";
import { FiEdit } from "react-icons/fi";
import api from "../../api";
import Swal from "sweetalert2";

const LeadSettings = () => {
  const [activeScreen, setActiveScreen] = useState("status"); // 'status' or 'googleSheet'
  const [leadStatuses, setLeadStatuses] = useState([]);
  const [loading, setLoading] = useState(true);
  const [activeDropdown, setActiveDropdown] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingStatus, setEditingStatus] = useState(null);
  const [formData, setFormData] = useState({
    status_name: "",
  });
  const [googleSheetLink, setGoogleSheetLink] = useState("");

  // State for Add Status Modal
  const [isAddStatusModalOpen, setIsAddStatusModalOpen] = useState(false);
  const [newStatusData, setNewStatusData] = useState({
    status_name: "",
  });

  const fetchLeadStatuses = useCallback(async () => {
    try {
      const response = await api.get("/showleadstatus");
      if (response.data.success) {
        setLeadStatuses(response.data.data);
      } else {
        console.error("Failed to fetch lead statuses:", response.data.message);
      }
    } catch (err) {
      console.error("Error fetching lead statuses:", err.message);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchLeadStatuses();
  }, [fetchLeadStatuses]);

  const toggleDropdown = (statusId) => {
    setActiveDropdown(activeDropdown === statusId ? null : statusId);
  };

  const handleEdit = (status) => {
    setEditingStatus(status);
    setFormData({
      status_name: status.status_name,
    });
    setIsModalOpen(true);
    setActiveDropdown(null);
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData((prev) => ({
      ...prev,
      [name]: value,
    }));
  };

  const handleNewStatusChange = (e) => {
    const { name, value } = e.target;
    setNewStatusData((prev) => ({
      ...prev,
      [name]: value,
    }));
  };

  const handleCloseAddStatusModal = () => {
    setIsAddStatusModalOpen(false);
    setNewStatusData({ status_name: "" }); // Reset the form data
  };

  const handleAddStatusSubmit = async (e) => {
    e.preventDefault();
    const loadingAlert = Swal.fire({
      title: "Adding Status...",
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      },
    });

    const formattedData = {
      name: newStatusData.status_name,
    };

    try {
      const response = await api.post("/addleadstatus", formattedData);
      await loadingAlert.close();

      if (response.data.success) {
        handleCloseAddStatusModal();
        await Swal.fire({
          icon: "success",
          title: "Status Added!",
          text: `${newStatusData.status_name} has been successfully added.`, // Corrected text
          confirmButtonColor: "#2798FF",
        });
        fetchLeadStatuses(); // Refetch statuses after adding
      } else {
        throw new Error(response.data.message || "Failed to add status.");
      }
    } catch (err) {
      await loadingAlert.close();
      Swal.fire({
        icon: "error",
        title: "Add Failed",
        text: err.message || "An error occurred while adding the status.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  const handleDelete = async (statusId) => {
    const result = await Swal.fire({
      title: "Are you sure?",
      text: "This status will be deleted permanently.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#DD6B55",
      cancelButtonColor: "#aaa",
      confirmButtonText: "Yes, delete it!",
    });

    if (result.isConfirmed) {
      try {
        const response = await api.get(`/deletestatus/${statusId}`);
        if (!response.data.success) {
          await Swal.fire({
            icon: "success",
            title: "Deleted!",
            text: "Status has been removed.",
            confirmButtonColor: "#2798FF",
          });
          fetchLeadStatuses(); // Refetch statuses after deleting
        } else {
          throw new Error(response.data.message || "Failed to delete status.");
        }
      } catch (err) {
        Swal.fire({
          icon: "error",
          title: "Delete Failed",
          text: err.message || "An error occurred while deleting the status.",
          confirmButtonColor: "#DD6B55",
        });
      }
    }
    setActiveDropdown(null);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!editingStatus) return;

    const formattedData = {
      name: formData.status_name,
    };

    try {
      const response = await api.post(
        `/updateleadstatus/${editingStatus.status_id}`,
        formattedData
      );
      if (response.data.success) {
        setIsModalOpen(false);
        await Swal.fire({
          icon: "success",
          title: "Status Updated",
          text: `${formData.status_name} was successfully updated.`,
          confirmButtonColor: "#2798FF",
        });
        fetchLeadStatuses(); // Refetch statuses after updating
      } else {
        Swal.fire({
          icon: "error",
          title: "Update Failed",
          text: response.data.message || "Failed to update status.",
          confirmButtonColor: "#DD6B55",
        });
      }
    } catch (err) {
      Swal.fire({
        icon: "error",
        title: "Update Failed",
        text: err.message || "An error occurred while updating the status.",
        confirmButtonColor: "#DD6B55",
      });
    }
    setActiveDropdown(null);
  };

  const handleGoogleSheetSubmit = async (e) => {
    e.preventDefault();
    const loadingAlert = Swal.fire({
      title: "Importing Google Sheet...",
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      },
    });

    try {
      const response = await api.post("/google-sheet", {
        sheet_url: googleSheetLink,
      });
      await loadingAlert.close();

      if (response.data.success) {
        await Swal.fire({
          icon: "success",
          title: "Sheet Imported!",
          text: response.data.message || "Google Sheet imported successfully.",
          confirmButtonColor: "#2798FF",
        });
        setGoogleSheetLink(""); // Clear the input
      } else {
        throw new Error(response.data.message || "Failed to import sheet.");
      }
    } catch (err) {
      await loadingAlert.close();
      Swal.fire({
        icon: "error",
        title: "Import Failed",
        text: err.message || "An error occurred while importing the sheet.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  const handleDownloadSample = async () => {
    const loadingAlert = Swal.fire({
      title: "Downloading Sample...",
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      },
    });
    try {
      const response = await api.get("/sheet-sample-download", {
        responseType: "blob", // Important for downloading files
      });
      await loadingAlert.close();

      const url = window.URL.createObjectURL(new Blob([response.data]));
      const link = document.createElement("a");
      link.href = url;
      link.setAttribute("download", "sample_sheet.csv"); // Or get filename from Content-Disposition header
      document.body.appendChild(link);
      link.click();
      link.remove();

      Swal.fire({
        icon: "success",
        title: "Download Initiated",
        text: "Your sample file download should begin shortly.",
        confirmButtonColor: "#2798FF",
      });
    } catch (err) {
      await loadingAlert.close();
      Swal.fire({
        icon: "error",
        title: "Download Failed",
        text:
          err.response?.data?.message ||
          "An error occurred while downloading the sample file.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  if (loading) {
    return (
      <div className="w-full min-h-[797px] flex items-center justify-center">
        Loading...
      </div>
    );
  }

  return (
    <div className="w-full h-auto min-h-[300px] p-4 md:p-6 relative bg-gradient-to-br from-white to-[#E7F4FF] rounded-[10px] shadow-[2px_2px_6px_rgba(24,95,235,0.1)] flex flex-col">
      {/* Header Section */}
      <div className="flex flex-wrap items-center justify-between gap-4 mb-8">
        {/* Title */}
        <div className="flex gap-6">
          <button
            onClick={() => setActiveScreen("status")}
            className="focus:outline-none"
          >
            <h2
              className={`text-[20px] md:text-[22px] font-medium text-[#1F2837] whitespace-nowrap pb-1 ${
                activeScreen === "status"
                  ? "border-b-2 border-[#2798FF]"
                  : "border-b-2 border-transparent"
              }`}
            >
              Status
            </h2>
          </button>
          <button
            onClick={() => setActiveScreen("googleSheet")}
            className="focus:outline-none"
          >
            <h2
              className={`text-[20px] md:text-[22px] font-medium text-[#1F2837] whitespace-nowrap pb-1 ${
                activeScreen === "googleSheet"
                  ? "border-b-2 border-[#2798FF]"
                  : "border-b-2 border-transparent"
              }`}
            >
              Google Sheet
            </h2>
          </button>
        </div>

        {activeScreen === "status" ? (
          <div className="flex items-center gap-3 md:gap-4">
            {/* Add Status button - user didn't specify, but often needed */}
            <button
              onClick={() => setIsAddStatusModalOpen(true)}
              className="hover:bg-blue-500 bg-[#ef7e1b] text-white h-[44px] px-8 rounded-[8px] flex items-center justify-center"
            >
              Add Status
            </button>
          </div>
        ) : (
          <div className="flex items-center gap-3 md:gap-4">
            {/* No additional buttons needed for Google Sheet view */}
          </div>
        )}
      </div>

      {activeScreen === "status" ? (
        <>
          {/* Status List Table (Desktop) */}
          <div className="hidden md:block w-full flex-grow">
            <div className="w-full rounded-lg overflow-hidden">
              {/* Header */}
              <div className="grid md:grid-cols-[1fr_1fr_1fr_1fr_auto_1fr] gap-x-4 px-6 py-4 border-b border-gray-200 text-[#4B5563]">
                <div className="font-medium text-sm text-left">Status ID</div>
                <div className="font-medium text-sm text-left">Status Name</div>
                <div className="font-medium text-sm text-left">Actions</div>
                <div /> {/* Empty header for spacing */}
                <div /> {/* New empty column */}
              </div>

              {/* Body */}
              <div className="pb-20">
                {leadStatuses?.length === 0 ? (
                  <div className="grid md:grid-cols-[1fr_1fr_1fr_1fr_auto_1fr] gap-x-4 px-6 py-8 text-center text-[#4B5563] border-b border-gray-200 items-center last:border-b-0 hover:bg-gray-50/30 transition-colors">
                    <div className="lg:col-span-5">
                      No lead statuses available.
                    </div>{" "}
                    {/* Adjusted colspan for the new grid */}
                  </div>
                ) : (
                  leadStatuses?.map((status) => (
                    <div
                      key={status.status_id}
                      className="grid md:grid-cols-[1fr_1fr_1fr_1fr_auto_1fr] gap-x-4 px-6 py-4 border-b border-gray-200 items-center last:border-b-0 hover:bg-gray-50/30 transition-colors"
                    >
                      <div className="text-sm text-[#4B5563] text-left">
                        {status.status_id}
                      </div>
                      <div className="text-sm text-[#4B5563] text-left whitespace-nowrap">
                        {status.status_name}
                      </div>
                      <div className="relative text-left">
                        {" "}
                        {/* Removed flex justify-center for left alignment */}
                        <button
                          onClick={() => toggleDropdown(status.status_id)}
                          className="p-2 text-[#4B5563] hover:bg-blue-200 hover:text-white rounded-full transition-colors"
                        >
                          <TbDotsVertical className="w-4 h-4" />
                        </button>
                        {activeDropdown === status.status_id && (
                          <div className="relative">
                            <div
                              ref={(el) => {
                                if (el) {
                                  el.scrollIntoView({
                                    behavior: "smooth",
                                    block: "nearest",
                                  });
                                }
                              }}
                              className="absolute left-0 w-24 rounded-md shadow-md bg-gradient-to-br from-white to-[#E7F4FF] z-10 overflow-hidden"
                            >
                              {" "}
                              {/* Aligned dropdown to the left */}
                              <button
                                onClick={() => handleEdit(status)}
                                className="group flex items-center px-2 py-1 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors first:rounded-t-md"
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="24"
                                  height="24"
                                  viewBox="0 0 24 24"
                                  className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                >
                                  <path
                                    fill="currentColor"
                                    d="M4 14v-2h7v2zm0-4V8h11v2zm0-4V4h11v2zm9 14v-3.075l6.575-6.55l3.075 3.05L16.075 20zm7.5-6.575l-.925-.925zm-6 5.075h.95l3.025-3.05l-.45-.475l-.475-.45l-3.05 3.025zm3.525-3.525l-.475-.45l.925.925z"
                                  />
                                </svg>
                                <span className="group-hover:text-white transition-colors">
                                  Edit
                                </span>
                              </button>
                              <svg
                                className="w-full h-[1px]"
                                viewBox="0 0 100 1"
                                preserveAspectRatio="none"
                                xmlns="http://www.w3.org/2000/svg"
                              >
                                <polygon
                                  points="0,0 50,1 100,0"
                                  fill="#E5E7EB"
                                />
                              </svg>
                              <button
                                onClick={() => handleDelete(status.status_id)}
                                className="group flex items-center px-2 py-1 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors last:rounded-b-md"
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="24"
                                  height="24"
                                  viewBox="0 0 24 24"
                                  className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                >
                                  <path
                                    fill="currentColor"
                                    d="M7.616 20q-.672 0-1.144-.472T6 18.385V6H5V5h4v-.77h6V5h4v1h-1v12.385q0 .69-.462 1.153T16.384 20zM17 6H7v12.385q0 .269.173.442t.443.173h8.769q.23 0 .423-.192t.192-.424zM9.808 17h1V8h-1zm3.384 0h1V8h-1zM7 6v13z"
                                  />
                                </svg>
                                <span className="group-hover:text-white transition-colors">
                                  Delete
                                </span>
                              </button>
                            </div>
                          </div>
                        )}
                      </div>
                      <div /> {/* New empty column */}
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>

          {/* Status List Cards (Mobile) */}
          <div className="md:hidden w-full space-y-4 pb-32 flex-grow">
            {leadStatuses?.length === 0 ? (
              <div className="py-8 px-6 text-center text-[#4B5563]">
                No lead statuses available.
              </div>
            ) : (
              leadStatuses?.map((status) => (
                <div
                  key={status.status_id}
                  className="rounded-lg shadow p-4 border border-gray-200/80"
                >
                  <div className="flex justify-between items-start">
                    <div className="flex items-center gap-3">
                      <div className="space-y-1 pr-2">
                        <p className="font-bold text-lg text-[#1F2837]">
                          {status.status_name}
                        </p>
                        <p className="text-sm text-gray-500 break-all">
                          ID: {status.status_id}
                        </p>
                      </div>
                    </div>
                    <div className="relative">
                      <button
                        onClick={() => toggleDropdown(status.status_id)}
                        className="p-2 text-[#4B5563] rounded-full hover:bg-gray-100"
                      >
                        <TbDotsVertical className="w-5 h-5" />
                      </button>
                      {activeDropdown === status.status_id && (
                        <div className="absolute right-0 mt-1 w-28 rounded-md shadow-md bg-gradient-to-br from-white to-[#E7F4FF] z-20 overflow-hidden">
                          <div
                            ref={(el) => {
                              if (el) {
                                el.scrollIntoView({
                                  behavior: "smooth",
                                  block: "nearest",
                                });
                              }
                            }}
                          >
                            <button
                              onClick={() => handleEdit(status)}
                              className="group flex items-center px-3 py-2 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors first:rounded-t-md"
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="24"
                                height="24"
                                viewBox="0 0 24 24"
                                className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                              >
                                <path
                                  fill="currentColor"
                                  d="M4 14v-2h7v2zm0-4V8h11v2zm0-4V4h11v2zm9 14v-3.075l6.575-6.55l3.075 3.05L16.075 20zm7.5-6.575l-.925-.925zm-6 5.075h.95l3.025-3.05l-.45-.475l-.475-.45l-3.05 3.025zm3.525-3.525l-.475-.45l.925.925z"
                                />
                              </svg>
                              <span className="group-hover:text-white transition-colors">
                                Edit
                              </span>
                            </button>
                            <svg
                              className="w-full h-[1px]"
                              viewBox="0 0 100 1"
                              preserveAspectRatio="none"
                              xmlns="http://www.w3.org/2000/svg"
                            >
                              <polygon points="0,0 50,1 100,0" fill="#E5E7EB" />
                            </svg>
                            <button
                              onClick={() => handleDelete(status.status_id)}
                              className="group flex items-center px-3 py-2 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors last:rounded-b-md"
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="24"
                                height="24"
                                viewBox="0 0 24 24"
                                className="mr-2 w-4 h-4 fill-current text-[#4B5463] group-hover:text-white transition-colors"
                              >
                                <path
                                  fill="currentColor"
                                  d="M7.616 20q-.672 0-1.144-.472T6 18.385V6H5V5h4v-.77h6V5h4v1h-1v12.385q0 .69-.462 1.153T16.384 20zM17 6H7v12.385q0 .269.173.442t.443.173h8.769q.23 0 .423-.192t.192-.424zM9.808 17h1V8h-1zm3.384 0h1V8h-1zM7 6v13z"
                                />
                              </svg>
                              <span className="group-hover:text-white transition-colors">
                                Delete
                              </span>
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              ))
            )}
          </div>
        </>
      ) : (
        <div className="w-full flex-grow">
          <form onSubmit={handleGoogleSheetSubmit} className="space-y-5">
            <label
              htmlFor="googleSheetLink"
              className="block text-[#4B5563] text-[16px] mb-2"
            >
              Google Sheet Link
            </label>
            <input
              type="url"
              id="googleSheetLink"
              name="googleSheetLink"
              value={googleSheetLink}
              onChange={(e) => setGoogleSheetLink(e.target.value)}
              placeholder="https://docs.google.com/spreadsheets/d/e/2PACX-XXXXX/pub?output=csv"
              className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
              required
            />
            <div className="flex justify-between items-center ">
              <p className="text-[10px] sm:text-sm lg:text-sm text-gray-500 w- ">
                Publish your spreadsheet to the web in CSV format (e.g., File →
                Share → Publish to web → Select CSV) <br /> and ensure it’s
                publicly viewable or shared with the service account.
              </p>
              <button
                type="button"
                onClick={handleDownloadSample}
                className="text-[11px] sm:text-sm lg:text-base text-[#2798FF] hover:underline focus:outline-none focus:ring-2 focus:ring-[#2798FF] rounded-md px-2 py-1 transition-colors duration-200 whitespace-nowrap"
              >
                Download Sample File
              </button>
            </div>
            <button
              type="submit"
              className="w-[207px] h-[46px] bg-[#ef7e1b] text-white rounded-[10px] hover:bg-[#ee7f1b] transition-colors"
            >
              Import Sheet
            </button>
          </form>
        </div>
      )}

      {/* Edit Status Modal */}
      {isModalOpen && (
        <div className="fixed inset-0 flex items-center justify-center z-50">
          <div
            className="absolute inset-0 bg-gray-50/10 backdrop-blur-sm border border-white/30"
            onClick={() => setIsModalOpen(false)}
          />
          <div className="w-11/12 max-w-[600px] max-h-[90vh] overflow-y-auto p-6 md:p-8 rounded-2xl bg-gradient-to-br from-[#FFFFFF] to-[#E6F4FF] shadow-lg relative z-10">
            <button
              onClick={() => setIsModalOpen(false)}
              className="absolute top-6 right-6 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13 1L1 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M1 1L13 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>
            <h2 className="text-[29px] font-medium text-[#1F2837] mb-8">
              Edit Status
            </h2>
            <form onSubmit={handleSubmit}>
              <div className="grid grid-cols-1 gap-6">
                <div className="space-y-2">
                  <label className="block text-[#4B5563] text-[16px] mb-2">
                    Status ID
                  </label>
                  <input
                    type="text"
                    value={editingStatus?.status_id || ""}
                    className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 text-[#545454] focus:ring-2 focus:ring-[#0e4053] outline-none cursor-not-allowed"
                    readOnly
                  />
                </div>
                <div className="space-y-2">
                  <label className="block text-[#4B5563] text-[16px] mb-2">
                    Status Name
                  </label>
                  <div className="relative">
                    <input
                      type="text"
                      name="status_name"
                      value={formData.status_name}
                      onChange={handleInputChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                    />
                    <button className="absolute right-3 top-1/2 -translate-y-1/2">
                      <FiEdit className="w-5 h-5 text-gray-500" />
                    </button>
                  </div>
                </div>
              </div>
              <div className="mt-10 flex justify-center">
                <button
                  type="submit"
                  className="w-[207px] h-[46px] bg-[#ef7e1b] text-white rounded-[10px] hover:bg-[#ee7f1b] transition-colors"
                >
                  Save
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Add Status Modal */}
      {isAddStatusModalOpen && (
        <div className="fixed inset-0 flex items-center justify-center z-50">
          <div
            className="absolute inset-0 bg-gray-50/10 backdrop-blur-sm border border-white/30"
            onClick={handleCloseAddStatusModal}
          />
          <div className="w-11/12 max-w-[600px] max-h-[90vh] overflow-y-auto p-6 md:p-8 rounded-2xl bg-gradient-to-br from-[#FFFFFF] to-[#E6F4FF] shadow-lg relative z-10">
            <button
              onClick={handleCloseAddStatusModal}
              className="absolute top-6 right-6 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13 1L1 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M1 1L13 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>
            <h2 className="text-[29px] font-medium text-[#1F2837] mb-8">
              Add New Status
            </h2>
            <form onSubmit={handleAddStatusSubmit}>
              <div className="grid grid-cols-1 gap-6">
                <div className="space-y-2">
                  <label className="block text-[#4B5563] text-[16px] mb-2">
                    Status Name
                  </label>
                  <input
                    type="text"
                    name="status_name"
                    value={newStatusData.status_name}
                    onChange={handleNewStatusChange}
                    placeholder="Enter new status name"
                    className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                    required
                  />
                </div>
              </div>
              <div className="mt-10 flex justify-center">
                <button
                  type="submit"
                  className="w-[207px] h-[46px] bg-[#ef7e1b] text-white rounded-[10px] hover:bg-[#ee7f1b] transition-colors"
                >
                  Add Status
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
};

export default LeadSettings;
</file>

<file path="src/index.css">
/* src/index.css */

/* 1) Single Tailwind import for v4 */
@import "tailwindcss";

@font-face {
  font-family: Quicksand;
  src: url("../public/fonts/Quicksand/Quicksand-Medium.ttf");
}

@theme {
  --font-quicksand: Quicksand, "sans-serif";
  --font-sfpro: "SF Pro Display", "sans-serif";
  --font-mont: "Montserrat", "sans-serif";
}

/* 2) Base layer: register your fonts and default stack */
@layer base {
  /* — RESET: border-box + zero margins/padding — */
  *,
  *::before,
  *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  /* Firefox */
  /* Apply to html/body or all elements to make scrollbars thin with matching thumb color */

  /* — SF Pro Display — */
  @font-face {
    font-family: "SF Pro Display";
    font-weight: 400;
    font-style: normal;
    font-display: swap;
    src: url("/fonts/SF-Pro-Display/SF-Pro-Display-Regular.otf")
      format("opentype");
  }
  @font-face {
    font-family: "SF Pro Display";
    font-weight: 500;
    font-style: normal;
    font-display: swap;
    src: url("/fonts/SF-Pro-Display/SF-Pro-Display-Medium.otf")
      format("opentype");
  }
  @font-face {
    font-family: "SF Pro Display";
    font-weight: 600;
    font-style: normal;
    font-display: swap;
    src: url("/fonts/SF-Pro-Display/SF-Pro-Display-Semibold.otf")
      format("opentype");
  }
  @font-face {
    font-family: "SF Pro Display";
    font-weight: 700;
    font-style: normal;
    font-display: swap;
    src: url("/fonts/SF-Pro-Display/SF-Pro-Display-Bold.otf") format("opentype");
  }

  /* — Montserrat — */
  @font-face {
    font-family: "Montserrat";
    font-weight: 400;
    font-style: normal;
    font-display: swap;
    src: url("../public/fonts/Montserrat/Montserrat-Regular.ttf");
  }
  @font-face {
    font-family: "Montserrat";
    font-weight: 500;
    font-style: normal;
    font-display: swap;
    src: url("/fonts/Montserrat/Montserrat-Medium.ttf") format("truetype");
  }
  @font-face {
    font-family: "Montserrat";
    font-weight: 600;
    font-style: normal;
    font-display: swap;
    src: url("/fonts/Montserrat/Montserrat-SemiBold.ttf") format("truetype");
  }
  @font-face {
    font-family: "Montserrat";
    font-weight: 700;
    font-style: normal;
    font-display: swap;
    src: url("/fonts/Montserrat/Montserrat-Bold.ttf") format("truetype");
  }

  /* set your default stack on <html> */
  html {
    font-family: theme("fontFamily.sans");
  }
}

/* 3) component layer (your sidebar styles, etc) */
@layer components {
  .sidebar details > summary {
    list-style: none;
  }
  .sidebar details > summary::marker,
  .sidebar details > summary::-webkit-details-marker {
    display: none;
  }
  .sidebar details > summary::after {
    content: "›";
    float: right;
    transform: rotate(90deg);
    transition: transform 0.2s ease;
  }
  .sidebar details[open] > summary::after {
    transform: rotate(-90deg);
  }
}

/* 4) global font-smoothing */
:root {
  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}


@media (max-width: 890px) {
  .user-activity-container {
    gap: 6px !important; /* or whatever smaller gap you want */
  }
  .user-activity-card {
    min-width: 80px !important;
    max-width: 100px !important;
    padding-left: 2px !important;
    padding-right: 2px !important;
  }
}


@media (min-width: 1322px) {
  .custom-1322 {

    max-width: 1100px;
  }
}
@media (min-width: 1470px) {
  .custom-1400 {
    max-width: 100%;
  }
}


@media (min-width: 1470px) {
  .custom-1300 {

    width: 100%;
  }
}

button {
  cursor: pointer;
}
</file>

<file path="src/pages/login/Login.jsx">
import { useState } from "react";
import { useAuth } from "../../auth/AuthContext";
import Swal from "sweetalert2";

export default function Login() {
  const { login } = useAuth();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      await login(email, password);
    } catch (err) {
      const apiMessage = err.response?.data?.message || err.message;
      Swal.fire({
        icon: "error",
        title: "Login Failed",
        text: apiMessage,
        confirmButtonColor: "#278AFF",
      });
    }
  };

  return (
    <div className="flex flex-col lg:flex-row min-h-screen">
      {/* Left Side - Login Form */}
      <div className="flex flex-col justify-center w-full lg:w-1/2 px-6 sm:px-8 md:px-12 py-8 lg:py-0 bg-white">
        <div className="max-w-md mx-auto w-full">
          {/* Centered Logo */}
          <div className="flex justify-center mb-12">
            <img src="/logo.png" alt="logo" height={20} width={200} />
          </div>
          {/* Title */}
          <h1 className="text-3xl sm:text-4xl font-bold text-gray-900 mb-4 sm:mb-5">
            Welcome back 👋
          </h1>

          {/* Description */}
          <p className="text-gray-600 mb-8 sm:mb-9 text-base sm:text-lg leading-relaxed whitespace-nowrap">
            Today is a new day. It's your day. You shape it.
            <br />
            Sign in to start managing your projects.
          </p>

          <div className="space-y-6">
            {/* Email Field */}
            <div>
              <label
                htmlFor="email"
                className="block text-sm font-medium text-gray-700 mb-2"
              >
                Email
              </label>
              <input
                id="email"
                type="email"
                placeholder="Example@email.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="w-full h-[44px] px-3 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
              />
            </div>

            {/* Password Field */}
            <div>
              <label
                htmlFor="password"
                className="block text-sm font-medium text-gray-700 mb-2"
              >
                Password
              </label>
              <input
                id="password"
                type="password"
                placeholder="At least 8 characters"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full h-[44px] px-3 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] mb-3"
              />
            </div>

            {/* Sign In Button */}
            <button
              onClick={handleSubmit}
              className="w-full py-3 px-4 bg-[#ef7e1b] hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 outline-none"
            >
              Sign In
            </button>
          </div>

          {/* Copyright */}
          <div className="mt-12 sm:mt-16">
            <p className="text-sm text-[#959CB6] text-center">
              © 2025 ALL RIGHTS RESERVED
            </p>
          </div>
        </div>
      </div>

      {/* Right Side - Image */}
      <div className="w-full lg:w-1/2 lg:h-screen p-6 sm:p-8 lg:p-10 order-first lg:order-last">
        <div className="h-64 sm:h-80 lg:h-full rounded-2xl overflow-hidden">
          <img
            src="/Login Art.png"
            alt="Modern office workspace"
            className="w-full h-full object-cover"
          />
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/Layout.jsx">
// src/components/Layout.jsx

import Sidebar from "./Sidebar";
import { Outlet, useLocation } from "react-router-dom";
import { useState, useEffect, createContext } from "react";

export const SidebarContext = createContext(null);

export default function Layout() {
  // Responsive sidebar state
  const [isCollapsed, setIsCollapsed] = useState(() => {
    const width = window.innerWidth;
    if (width < 768) return false; // mobile: not collapsed (handled as mobile)
    if (width < 1280) return true; // tablet & small desktop: collapsed by default
    return false; // large desktop: not collapsed
  });
  const [isMobile, setIsMobile] = useState(() => window.innerWidth < 768);
  const [isTablet, setIsTablet] = useState(
    () => window.innerWidth >= 768 && window.innerWidth < 1280
  );
  const [isSearchExpanded, setIsSearchExpanded] = useState(false);
  const location = useLocation();
  const isDashboard = location.pathname.startsWith("/dashboard");

  useEffect(() => {
    const handleResize = () => {
      const width = window.innerWidth;
      setIsMobile(width < 768);
      setIsTablet(width >= 768 && width < 1280);
      // Collapse sidebar on tablet & small desktop, expand on large desktop, keep as is on mobile
      if (width < 768) {
        setIsCollapsed(false);
      } else if (width < 1280) {
        setIsCollapsed(true);
      } else {
        setIsCollapsed(false);
      }
      // Reset search expansion when switching to desktop
      if (width >= 768) {
        setIsSearchExpanded(false);
      }
    };
    window.addEventListener("resize", handleResize);
    // Initial check
    handleResize();
    return () => window.removeEventListener("resize", handleResize);
  }, []);

  const handleSearchToggle = () => {
    setIsSearchExpanded(!isSearchExpanded);
  };

  const handleSearchBlur = () => {
    // Only collapse on mobile when losing focus
    if (isMobile) {
      setIsSearchExpanded(false);
    }
  };

  return (
    // Use flex so sidebar and main sit side by side on desktop
    // Use min-h-screen so page can grow taller if sidebar/content expands
    <div className="app-container flex flex-col min-h-screen bg-[linear-gradient(to_bottom_right,_#FFFFFF_0%,_#EDF4FA_26%,_#DEEAF6_98%)] overflow-hidden">
      {/*
        Main wrapper: flex-1 so it grows to fill available space.
        Removed internal overflow-auto: when sidebar expands, page scroll appears.
      */}
      <div className="flex flex-1 w-full pr-4 ">
        <Sidebar
          isCollapsed={isCollapsed}
          setIsCollapsed={setIsCollapsed}
          isMobile={isMobile}
        />
        <SidebarContext.Provider value={{ isCollapsed }}>
          <main className="flex-1 transition-all duration-300 rounded-3xl ml-4 min-h-full">
            <div
              className={`flex items-center justify-between mt-4 w-full ${
                isMobile ? "px-4" : "p-5"
              }`}
            >
              {/* Left side: Search bar (conditionally rendered) */}
              <div className={`flex-shrink-0 ${!isDashboard && "invisible"}`}>
                {/* Mobile: Show only icon or expanded search */}
                {/* {isMobile ? (
                  <div className="relative p-1">
                    {!isSearchExpanded ? (
                      // Collapsed state: just the search icon
                      <button
                        onClick={handleSearchToggle}
                        className="w-10 h-10 flex items-center justify-center rounded-[6px]  hover:bg-gray-50 transition-colors ml-8"
                      >
                        <svg
                          width="22"
                          height="22"
                          viewBox="0 0 22 22"
                          fill="none"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <path
                            d="M10.5417 19.25C15.3512 19.25 19.25 15.3512 19.25 10.5417C19.25 5.73223 15.3512 1.83334 10.5417 1.83334C5.73223 1.83334 1.83334 5.73223 1.83334 10.5417C1.83334 15.3512 5.73223 19.25 10.5417 19.25Z"
                            stroke="#787374"
                            strokeWidth="1.5"
                            strokeLinecap="round"
                            strokeLinejoin="round"
                          />
                          <path
                            d="M18.3333 18.3333L20.1667 20.1667"
                            stroke="#787374"
                            strokeWidth="1.5"
                            strokeLinecap="round"
                            strokeLinejoin="round"
                          />
                        </svg>
                      </button>
                    ) : (
                      // Expanded state: full search bar
                      <div className="relative w-[190px] h-[35px] ml-8">
                        <div className="absolute inset-y-0 left-[16.8px] flex items-center pointer-events-none">
                          <svg
                            width="22"
                            height="22"
                            viewBox="0 0 22 22"
                            fill="none"
                            xmlns="http://www.w3.org/2000/svg"
                          >
                            <path
                              d="M10.5417 19.25C15.3512 19.25 19.25 15.3512 19.25 10.5417C19.25 5.73223 15.3512 1.83334 10.5417 1.83334C5.73223 1.83334 1.83334 5.73223 1.33334 10.5417C1.83334 15.3512 5.73223 19.25 10.5417 19.25Z"
                              stroke="#787374"
                              strokeWidth="1.5"
                              strokeLinecap="round"
                              strokeLinejoin="round"
                            />
                            <path
                              d="M18.3333 18.3333L20.1667 20.1667"
                              stroke="#787374"
                              strokeWidth="1.5"
                              strokeLinecap="round"
                              strokeLinejoin="round"
                            />
                          </svg>
                        </div>
                        <input
                          type="search"
                          placeholder="Search here..."
                          className="w-full h-full pl-12 pr-4 rounded-[6px] bg-white text-[#787374] placeholder-[#787374] focus:outline-none focus:ring-2 focus:ring-blue-500"
                          style={{
                            fontSize: "14px",
                            lineHeight: "17px",
                          }}
                          onBlur={handleSearchBlur}
                          autoFocus
                        />
                      </div>
                    )}
                  </div>
                ) : (
                  // Desktop: Always show full search bar
                  <div className="relative w-[417px] h-[44px]">
                    <div className="absolute inset-y-0 left-[16.8px] flex items-center pointer-events-none">
                      <svg
                        width="22"
                        height="22"
                        viewBox="0 0 22 22"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          d="M10.5417 19.25C15.3512 19.25 19.25 15.3512 19.25 10.5417C19.25 5.73223 15.3512 1.83334 10.5417 1.83334C5.73223 1.83334 1.83334 5.73223 1.83334 10.5417C1.83334 15.3512 5.73223 19.25 10.5417 19.25Z"
                          stroke="#787374"
                          strokeWidth="1.5"
                          strokeLinecap="round"
                          strokeLinejoin="round"
                        />
                        <path
                          d="M18.3333 18.3333L20.1667 20.1667"
                          stroke="#787374"
                          strokeWidth="1.5"
                          strokeLinecap="round"
                          strokeLinejoin="round"
                        />
                      </svg>
                    </div>
                    <input
                      type="search"
                      placeholder="Search here..."
                      className="w-full h-full pl-12 pr-4 rounded-[6px] bg-white text-[#787374] placeholder-[#787374] focus:outline-none focus:ring-2 focus:ring-blue-500"
                      style={{
                        fontSize: "14px",
                        lineHeight: "17px",
                      }}
                    />
                  </div>
                )} */}
              </div>
              {/* Right side: Icons container */}
              {/* <div
                className={`flex items-center gap-2 ${isMobile ? "" : "mr-5"}`}
              >
                <img src="/calendar-2.svg" alt="Calendar" className="w-6 h-6" />
                <img
                  src="/message-question.svg"
                  alt="Message"
                  className="w-6 h-6"
                />
                <img
                  src="/notification.svg"
                  alt="Notification"
                  className="w-6 h-6"
                />
              </div> */}
            </div>

            <div  className={`py-4 md:py-6 lg:py-8 w-full mt-14 ${
    isCollapsed ? "lg:pr-12" : "lg:pr-2"
  }`}>
              <Outlet />
            </div>
          </main>
        </SidebarContext.Provider>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/dashboard/Container1.jsx">
import React from "react";
import { BsCardChecklist } from "react-icons/bs";

const Container1 = ({
  leads,
  newToday,
  increasePercent,
  gradient = "linear-gradient(45deg, white, #e6f4fb)",
  icon, // Accept a React element for the icon
  totalLeadsLabel = "Total Leads",
}) => {
  return (
    <div
      className="relative inline-block p-[3px] mx-auto md:mx-0 rounded-2xl overflow-hidden w-[23%] min-w-[260px] "
      style={{
        backgroundImage: `linear-gradient(to top right, transparent 70%, #0e4053)`,
        backgroundPosition: ``, // Removed, as no longer needed
        backgroundSize: ``, // Removed, as no longer needed
      }}
    >
      {/* Glow effect */}
      <div className="absolute bottom-0 right-0 w-[100px] h-[100px] bg-[#a3c9f1] rounded-full blur-[30px] pointer-events-none z-0" />

      {/* Inner content */}
      <div
        className="relative z-10 rounded-[14px] min-h-[130px] px-5 pt-5 pb-3 flex flex-col -ml-1.5 justify-center "
        style={{ background: gradient }}
      >
        {/* Top Content */}
        <div>
          <div className="flex justify-between">
            <div>
              {leads !== undefined && leads !== null && (
                <>
                  <div className="text-[#ef7e1b] text-[25px] font-extrabold font-quicksand">
                    {leads}+
                  </div>
                  <div className="text-black font-semibold">
                    {totalLeadsLabel}
                  </div>
                </>
              )}
            </div>
            <div className="bg-[#3498DB33] rounded-full w-[60px] h-[60px] flex justify-center items-center -mt-1.5">
              {icon && (
                <span className="w-[30px] h-[30px] flex items-center justify-center text-[30px] text-[#ef7e1b]">
                  {icon}
                </span>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Container1;
</file>

<file path="src/pages/invoice/ViewInvoice.jsx">
import React, { useState, useEffect, useRef, useContext } from "react";
import {
  FiChevronDown,
  FiEdit,
  FiUpload,
  FiDownload,
  FiTrash2,
} from "react-icons/fi";
import { TbDotsVertical } from "react-icons/tb";
import api from "../../api";
import Swal from "sweetalert2";
import { FaCheck } from "react-icons/fa6";
import { useParams, useNavigate, useLocation } from "react-router-dom"; // Import useParams, useNavigate, and useLocation
import { useAuth } from "../../auth/AuthContext";
import { RxCross2 } from "react-icons/rx";

import "../../styles/scrollbar.css";
import { form } from "motion/react-client";
import { SidebarContext } from "../../components/Layout";

const ViewInvoice = () => {
  const { statusId, statusName } = useParams(); // Get statusId and statusName from URL
  const navigate = useNavigate(); // Add useNavigate
  const location = useLocation();

  const dynamicApiEndpoint = statusId
    ? `/leadstatus/${statusId}`
    : "/showinvoice";
  const dynamicHeaderTitle = "All Invoice List";
  const dynamicModalTitle = statusName
    ? `Edit ${decodeURIComponent(statusName)} Item`
    : "Edit Invoice";

  // Mobile detection and search state
  const [isMobile, setIsMobile] = useState(() => window.innerWidth < 768);
  const [isSearchExpanded, setIsSearchExpanded] = useState(false);
  const [invoices, setInvoices] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // Consume SidebarContext
  const { isCollapsed } = useContext(SidebarContext);

  // Search, filter, and pagination state
  const [searchTerm, setSearchTerm] = useState("");
  const [filters, setFilters] = useState({
    payment: "all", // New payment filter
    itemCount: "all", // New item count filter
    invoiceDateRange: "all", // Changed from invoiceDate to invoiceDateRange
    expiryDate: "all", // New Expiry Date filter
    billTo: "all", // New Bill To filter
    shipTo: "all", // New Ship To filter
  });
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10);

  // Checkbox selection state for bulk operations
  const [selectedLeads, setSelectedLeads] = useState([]);
  const [isBulkEditModalOpen, setIsBulkEditModalOpen] = useState(false);
  const [bulkStatus, setBulkStatus] = useState("Inprogress"); // Add bulk status state

  // New state for dropdown and modal
  const [activeDropdown, setActiveDropdown] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingInvoice, setEditingInvoice] = useState(null);
  const [formData, setFormData] = useState({
    customer_name: "",
    contact: "",
    address: "",
    company_name: "",
    status: "",
    invoice_date: "",
    expiry_date: "",
  });

  const [serviceItems, setServiceItems] = useState([
    {
      serviceName: "",
      quantity: 1,
      totalItemPrice: 0,
    },
  ]);

  // Add state for expanded row to show all items
  const [expandedInvoiceId, setExpandedInvoiceId] = useState(null);

  // New state for modal to display items and calculate net total for each invoice
  const [selectedItems, setSelectedItems] = useState(null);
  const [isItemsModalOpen, setIsItemsModalOpen] = useState(false);

  // State for Created Date Range Filter
  const [createdTimeRange, setCreatedTimeRange] = useState("all"); // 'all', '7days', '30days', '90days', 'custom'
  const [customCreatedDateRange, setCustomCreatedDateRange] = useState({
    fromDate: new Date(),
    toDate: new Date(),
  });
  const [createdDateRangeDropdownOpen, setCreatedDateRangeDropdownOpen] =
    useState(false);
  const [isItemsPerPageDropdownOpen, setIsItemsPerPageDropdownOpen] =
    useState(false);

  // Ref for created date range dropdown
  const createdDateRangeDropdownRef = useRef(null);
  const itemsPerPageDropdownRef = useRef(null); // Add this ref

  // Refs for filter dropdowns
  const billToDropdownRef = useRef(null);
  const shipToDropdownRef = useRef(null);
  const paymentDropdownRef = useRef(null);
  const invoiceDateRangeDropdownRef = useRef(null);

  // State and callback ref for the currently open action dropdown
  const [actionDropdownNode, setActionDropdownNode] = useState(null);

  const { user, rolePermissions } = useAuth();

  // Extract module name from URL (e.g., 'invoice' from '/invoice/all')
  const pathParts = location.pathname.split("/").filter(Boolean);
  const moduleNameFromUrl = pathParts[0] ? pathParts[0].toLowerCase() : null;

  // Find permissions for the module from rolePermissions
  const permissionsForInvoiceModule = React.useMemo(() => {
    if (rolePermissions === "ALL") {
      // Grant all positive permissions, do NOT include any inverse permissions
      return ["create", "edit", "delete", "view"];
    }
    if (!moduleNameFromUrl || !Array.isArray(rolePermissions)) return [];
    const found = rolePermissions.find(
      (perm) => perm.module && perm.module.toLowerCase() === moduleNameFromUrl
    );
    return found ? found.permissions : [];
  }, [rolePermissions, moduleNameFromUrl]);

  // Permission checks for bulk actions (optional, for future use)
  const hasBulkDeletePermission =
    rolePermissions === "ALL" || !rolePermissions?.includes("noBulkDelete");

  const getInvoiceStatus = (invoice) => {
    if (!invoice) return null;
    const balance = parseFloat(invoice.balance);
    const received = parseFloat(invoice.received_amount);

    if (isNaN(balance) || isNaN(received)) {
      return "Unknown"; // or some default
    }

    if (balance <= 0) {
      return "Paid";
    }
    if (received > 0) {
      return "Partially Paid";
    }
    return "Unpaid";
  };

  useEffect(() => {
    const fetchInvoices = async () => {
      try {
        const response = await api.get(dynamicApiEndpoint); // Use dynamicApiEndpoint
        if (response.data.success) {
          setInvoices(response.data.data); // Access data.data for invoices
        } else {
          setError("Failed to fetch invoices");
        }
      } catch (err) {
        setError("Error fetching invoices: " + err.message);
      } finally {
        setLoading(false);
      }
    };

    fetchInvoices();
  }, [dynamicApiEndpoint]); // Depend on dynamicApiEndpoint

  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth < 768);
      if (window.innerWidth >= 768) {
        setIsSearchExpanded(false);
      }
    };
    checkMobile();
    window.addEventListener("resize", checkMobile);
    return () => window.removeEventListener("resize", checkMobile);
  }, []);

  const handleSearchToggle = () => {
    setIsSearchExpanded(!isSearchExpanded);
  };

  // Helper function to recursively search all fields in an object for a search term
  const objectContainsSearchTerm = (obj, searchLower) => {
    if (obj == null) return false;
    if (typeof obj === "string" || typeof obj === "number") {
      return String(obj).toLowerCase().includes(searchLower);
    }
    if (Array.isArray(obj)) {
      return obj.some((item) => objectContainsSearchTerm(item, searchLower));
    }
    if (typeof obj === "object") {
      return Object.values(obj).some((value) =>
        objectContainsSearchTerm(value, searchLower)
      );
    }
    return false;
  };

  // Helper to format date for display
  const formatDateForDisplay = (date) => {
    if (!date) return "";
    return new Date(date).toLocaleDateString("en-US", {
      month: "short",
      day: "numeric",
      year: "numeric",
    });
  };

  // Handle created time range change
  const handleCreatedTimeRangeChange = (range) => {
    setCreatedTimeRange(range);
    setCreatedDateRangeDropdownOpen(false); // Close dropdown after selection
    if (range === "custom") {
      // Keep custom range dates if already set, otherwise null
      setCustomCreatedDateRange((prev) => ({
        fromDate: prev.fromDate,
        toDate: prev.toDate,
      }));
    } else {
      setCustomCreatedDateRange({ fromDate: null, toDate: null }); // Clear custom range if a predefined range is selected
    }
  };

  // Handle custom created date changes
  const handleCustomCreatedDateChange = (field, dateString) => {
    setCustomCreatedDateRange((prev) => ({
      ...prev,
      [field]: dateString ? new Date(dateString) : null,
    }));
    setCreatedTimeRange("custom"); // Set to custom when dates are picked
  };

  // Apply custom created date range
  const applyCustomCreatedDateRange = () => {
    setCreatedTimeRange("custom");
    setCreatedDateRangeDropdownOpen(false);
  };

  // Filter invoices based on search term and filter criteria
  const filteredInvoices = invoices.filter((invoice) => {
    const searchLower = searchTerm.toLowerCase();

    // Calculate net total for this invoice
    const netTotal = parseFloat(
      invoice.items && invoice.items.length > 0
        ? invoice.items.reduce(
            (sum, item) => sum + parseFloat(item.total_price || 0),
            0
          )
        : 0
    );

    // Search across all fields using the helper, and also check net total
    const matchesSearch =
      !searchTerm ||
      objectContainsSearchTerm(invoice, searchLower) ||
      String(netTotal).toLowerCase().includes(searchLower);

    // Payment filter logic
    let matchesPayment = true;
    switch (filters.payment) {
      case "lt50000":
        matchesPayment = netTotal < 50000;
        break;
      case "50001-100000":
        matchesPayment = netTotal >= 50001 && netTotal <= 100000;
        break;
      case "100001-400000":
        matchesPayment = netTotal >= 100001 && netTotal <= 400000;
        break;
      case "400001-500000":
        matchesPayment = netTotal >= 400001 && netTotal <= 500000;
        break;
      case "gt500000":
        matchesPayment = netTotal > 500000;
        break;
      default:
        matchesPayment = true;
    }

    // Item count filter logic
    const itemCount = invoice.items ? invoice.items.length : 0;
    let matchesItemCount = true;
    switch (filters.itemCount) {
      case "1-5":
        matchesItemCount = itemCount >= 1 && itemCount <= 5;
        break;
      case "6-20":
        matchesItemCount = itemCount >= 6 && itemCount <= 20;
        break;
      case "21-50":
        matchesItemCount = itemCount >= 21 && itemCount <= 50;
        break;
      case "51-100":
        matchesItemCount = itemCount >= 51 && itemCount <= 100;
        break;
      case "gt100":
        matchesItemCount = itemCount > 100;
        break;
      default:
        matchesItemCount = true;
    }

    // New Expiry Date filter logic
    const matchesExpiryDate =
      filters.expiryDate === "all" ||
      (invoice?.expiry_date
        ? new Date(invoice.expiry_date).toISOString().split("T")[0] ===
          filters.expiryDate
        : false);

    // New Invoice Date Range filter logic
    let matchesInvoiceDateRange = true;
    if (filters.invoiceDateRange !== "all") {
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Normalize to start of day
      const updatedAtDate = invoice.updated_at
        ? new Date(invoice.updated_at)
        : null;
      if (updatedAtDate) {
        updatedAtDate.setHours(0, 0, 0, 0); // Normalize updated_at date

        switch (filters.invoiceDateRange) {
          case "today":
            matchesInvoiceDateRange =
              updatedAtDate.getTime() === today.getTime();
            break;
          case "last7days":
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);
            matchesInvoiceDateRange =
              updatedAtDate >= sevenDaysAgo && updatedAtDate <= today;
            break;
          case "last30days":
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);
            matchesInvoiceDateRange =
              updatedAtDate >= thirtyDaysAgo && updatedAtDate <= today;
            break;
          case "last6months":
            const sixMonthsAgo = new Date(today);
            sixMonthsAgo.setMonth(today.getMonth() - 6);
            matchesInvoiceDateRange =
              updatedAtDate >= sixMonthsAgo && updatedAtDate <= today;
            break;
          case "last12months":
            const twelveMonthsAgo = new Date(today);
            twelveMonthsAgo.setFullYear(today.getFullYear() - 1);
            matchesInvoiceDateRange =
              updatedAtDate >= twelveMonthsAgo && updatedAtDate <= today;
            break;
          default:
            matchesInvoiceDateRange = true;
        }
      } else {
        matchesInvoiceDateRange = false; // If no updated_at date, it can't match any date range
      }
    }

    // New Created Date Range filter logic
    let matchesCreatedDate = true;
    if (createdTimeRange !== "all") {
      const createdAtDate = new Date(invoice.created_at);
      const now = new Date();

      if (createdTimeRange === "custom") {
        const from = customCreatedDateRange.fromDate;
        const to = customCreatedDateRange.toDate;
        if (from && to) {
          matchesCreatedDate =
            createdAtDate >= from &&
            createdAtDate <= new Date(to.setHours(23, 59, 59, 999)); // End of day
        } else if (from) {
          matchesCreatedDate = createdAtDate >= from;
        } else if (to) {
          matchesCreatedDate =
            createdAtDate <= new Date(to.setHours(23, 59, 59, 999));
        }
      } else {
        let daysAgo;
        if (createdTimeRange === "7days") daysAgo = 7;
        else if (createdTimeRange === "30days") daysAgo = 30;
        else if (createdTimeRange === "90days") daysAgo = 90;

        if (daysAgo) {
          const cutoffDate = new Date(now);
          cutoffDate.setDate(now.getDate() - daysAgo);
          matchesCreatedDate = createdAtDate >= cutoffDate;
        }
      }
    }

    // New Bill To filter logic
    const matchesBillTo =
      filters.billTo === "all" ||
      invoice?.bill_to_name
        ?.toLowerCase()
        .includes(filters.billTo.toLowerCase());

    // New Ship To filter logic
    const matchesShipTo =
      filters.shipTo === "all" ||
      invoice?.ship_to_name
        ?.toLowerCase()
        .includes(filters.shipTo.toLowerCase());

    return (
      matchesSearch &&
      matchesPayment &&
      matchesItemCount &&
      matchesInvoiceDateRange && // Updated to use new filter
      matchesExpiryDate &&
      matchesCreatedDate && // Add new created date filter
      matchesBillTo &&
      matchesShipTo
    );
  });

  // Helper function for form validation
  const validateFormData = (data) => {
    const errors = [];

    if (!data.customer_name || data.customer_name.trim() === "") {
      errors.push("Customer Name is required.");
    }
    if (!data.contact || data.contact.trim() === "") {
      errors.push("Contact Number is required.");
    } else if (!/^\d{10}$/.test(data.contact)) {
      errors.push("Contact Number must be 10 digits.");
    }
    if (!data.address || data.address.trim() === "") {
      errors.push("Address is required.");
    }
    if (!data.company_name || data.company_name.trim() === "") {
      errors.push("Company Name is required.");
    }
    if (!data.status || data.status.trim() === "") {
      errors.push("Status is required.");
    }
    if (!data.invoice_date || data.invoice_date.trim() === "") {
      errors.push("Invoice Date is required.");
    }
    if (!data.expiry_date || data.expiry_date.trim() === "") {
      errors.push("Expiry Date is required.");
    }

    return errors;
  };

  // Calculate pagination
  const totalPages = Math.ceil(filteredInvoices.length / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const currentInvoices = filteredInvoices.slice(startIndex, endIndex);

  // Reset to first page when search term or filters change
  useEffect(() => {
    setCurrentPage(1);
  }, [
    searchTerm,
    filters,
    createdTimeRange,
    customCreatedDateRange,
    filters.billTo,
    filters.shipTo,
  ]);

  // Close created date range dropdown when clicking outside
  useEffect(() => {
    function handleClickOutside(event) {
      const refs = [
        billToDropdownRef,
        shipToDropdownRef,
        paymentDropdownRef,
        invoiceDateRangeDropdownRef,
        itemsPerPageDropdownRef, // Add this ref
      ];
      const isClickInsideAny = refs.some(
        (ref) => ref.current && ref.current.contains(event.target)
      );
      if (!isClickInsideAny && activeDropdown) {
        setActiveDropdown(null);
      }
      if (
        createdDateRangeDropdownOpen &&
        createdDateRangeDropdownRef.current &&
        !createdDateRangeDropdownRef.current.contains(event.target)
      ) {
        setCreatedDateRangeDropdownOpen(false);
      }
      // Close items per page dropdown
      if (
        isItemsPerPageDropdownOpen &&
        itemsPerPageDropdownRef.current &&
        !itemsPerPageDropdownRef.current.contains(event.target)
      ) {
        setIsItemsPerPageDropdownOpen(false);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [
    activeDropdown,
    createdDateRangeDropdownOpen,
    isItemsPerPageDropdownOpen,
  ]); // Add isItemsPerPageDropdownOpen to dependencies

  // Close filter dropdowns on click outside (for action dropdown only)
  useEffect(() => {
    const handleMouseDownOutside = (event) => {
      console.log("Document mousedown", event.target);
      if (
        activeDropdown &&
        actionDropdownNode &&
        !actionDropdownNode.contains(event.target)
      ) {
        setActiveDropdown(null);
      }
    };
    document.addEventListener("mousedown", handleMouseDownOutside);
    return () =>
      document.removeEventListener("mousedown", handleMouseDownOutside);
  }, [activeDropdown, actionDropdownNode]);

  const handleSearchBlur = () => {
    if (isMobile) {
      setIsSearchExpanded(false);
    }
  };

  const handleSearchChange = (e) => {
    setSearchTerm(e.target.value);
  };

  const handlePreviousPage = () => {
    if (currentPage > 1) {
      setCurrentPage(currentPage - 1);
    }
  };

  const handleNextPage = () => {
    if (currentPage < totalPages) {
      setCurrentPage(currentPage + 1);
    }
  };

  const handleItemsPerPageChange = (newItemsPerPage) => {
    setItemsPerPage(newItemsPerPage);
    setCurrentPage(1);
  };

  // Checkbox handlers for bulk selection
  const toggleInvoiceSelection = (invoiceId) => {
    setSelectedLeads((prev) =>
      prev.includes(invoiceId)
        ? prev.filter((id) => id !== invoiceId)
        : [...prev, invoiceId]
    );
  };

  const toggleSelectAll = () => {
    if (selectedLeads.length === currentInvoices.length) {
      setSelectedLeads([]);
    } else {
      setSelectedLeads(currentInvoices.map((invoice) => invoice.id));
    }
  };

  const handleBulkDelete = async () => {
    const result = await Swal.fire({
      title: "Are you sure?",
      text: `You are about to delete ${selectedLeads.length} invoice(s). This cannot be undone.`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#DD6B55",
      cancelButtonColor: "#aaa",
      confirmButtonText: "Yes, delete them!",
    });
    if (result.isConfirmed) {
      let deletedCount = 0;
      let failedCount = 0;
      let failedIds = [];
      Swal.fire({
        title: "Deleting...",
        html: `Deleting <b>0</b>/${selectedLeads.length} invoices...`,
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });
      for (let i = 0; i < selectedLeads.length; i++) {
        const id = selectedLeads[i];
        try {
          const response = await api.delete(`/deleteinvoice/${id}`);
          if (response.data.status || response.data.success) {
            setInvoices((prev) => prev.filter((q) => q.id !== id));
            deletedCount++;
          } else {
            failedCount++;
            failedIds.push(id);
          }
        } catch (err) {
          failedCount++;
          failedIds.push(id);
        }
        Swal.update({
          html: `Deleting <b>${i + 1}</b>/${selectedLeads.length} invoices...`,
        });
      }
      setSelectedLeads([]);
      Swal.close();
      if (failedCount === 0) {
        await Swal.fire({
          icon: "success",
          title: " Deleted!",
          text: "Selected invoices have been removed.",
          confirmButtonColor: "#2798FF",
        });
      } else {
        await Swal.fire({
          icon: "error",
          title: "Some Deletes Failed",
          html: `Deleted: ${deletedCount}<br>Failed: ${failedCount}<br>Failed IDs: ${failedIds.join(
            ", "
          )}`,
          confirmButtonColor: "#DD6B55",
        });
      }
    }
  };

  // Filter handlers
  const handleFilterChange = (filterName, value) => {
    setFilters((prev) => ({
      ...prev,
      [filterName]: value,
    }));
    setCurrentPage(1);
  };

  // New handlers for dropdown and modal
  const toggleDropdown = (invoiceId) => {
    setActiveDropdown(activeDropdown === invoiceId ? null : invoiceId);

    // If we're opening the dropdown, scroll it into view
    if (activeDropdown !== invoiceId) {
      // Use setTimeout to ensure the dropdown is rendered before scrolling
      setTimeout(() => {
        const dropdownElement = document.querySelector(
          `[data-dropdown-id="${invoiceId}"]`
        );
        if (dropdownElement) {
          dropdownElement.scrollIntoView({
            behavior: "smooth",
            block: "nearest",
          });
        }
      }, 0);
    }
  };

  const handleEdit = (invoice) => {
    navigate("/invoice/create", { state: { invoice, mode: "edit" } });
  };

  const handleInputChange = (field, value) => {
    setFormData((prev) => ({
      ...prev,
      [field]: value,
    }));
  };

  // DELETE
  const handleDelete = async (id) => {
    const result = await Swal.fire({
      title: "Are you sure?",
      text: "This cannot be undone.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#DD6B55",
      cancelButtonColor: "#aaa",
      confirmButtonText: "Yes, delete it!",
    });
    if (result.isConfirmed) {
      try {
        const response = await api.delete(`/deleteinvoice/${id}`); // Changed endpoint to deleteinvoice
        if (response.data.status || response.data.success) {
          setInvoices((prev) => prev.filter((q) => q.id !== id));
          await Swal.fire({
            icon: "success",
            title: "Invoice Deleted!",
            text: response.data.message || "Invoice has been removed.",
            confirmButtonColor: "#2798FF",
          });
        } else {
          throw new Error(response.data.message || "Server rejected delete");
        }
      } catch (err) {
        Swal.fire({
          icon: "error",
          title: "Delete Invoice Failed",
          text: err.message,
          confirmButtonColor: "#DD6B55",
        });
      }
    }
    setActiveDropdown(null);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    const errors = validateFormData(formData);

    if (errors.length > 0) {
      Swal.fire({
        icon: "error",
        title: "Validation Error",
        html: errors.join("<br>"),
        confirmButtonColor: "#DD6B55",
      });
      return;
    }

    try {
      const response = await api.post(`/updateinvoice/${editingInvoice.id}`, {
        ...formData,
        items: serviceItems.map((item) => ({
          service: item.serviceName,
          quantity: item.quantity,
          total_price: parseFloat(item.totalItemPrice).toFixed(2),
        })),
        totalAmount: calculateTotalServiceCharge(),
      });

      if (response.status === 200) {
        // Update the invoices list with the edited data
        setInvoices(
          invoices.map((q) =>
            q.id === editingInvoice.id
              ? {
                  ...q,
                  ...formData,
                  items: serviceItems.map((item) => ({
                    service: item.serviceName,
                    quantity: item.quantity,
                    total_price: parseFloat(item.totalItemPrice).toFixed(2),
                  })),
                  totalAmount: calculateTotalServiceCharge(),
                }
              : q
          )
        );
        setIsModalOpen(false);
        Swal.fire({
          icon: "success",
          title: "Invoice Updated",
          text:
            response.data.message ||
            `${formData.customer_name} was successfully updated.`,
          confirmButtonColor: "#2798FF",
        });
      } else {
        throw new Error(response.data.message || "Failed to update invoice");
      }
    } catch (err) {
      let errorTitle = "Error Updating Invoice";
      let errorMessage =
        "An error occurred while updating the invoice. Please try again.";

      if (err.response) {
        if (err.response.status === 422) {
          const errors = err.response.data.errors;
          if (errors) {
            const firstError = Object.values(errors)[0];
            if (Array.isArray(firstError) && firstError.length > 0) {
              errorMessage = firstError[0];
            }
          }
        } else if (err.response.data?.message) {
          errorMessage = err.response.data.message;
        }
      } else if (err.request) {
        errorTitle = "Network Error";
        errorMessage =
          "Unable to connect to the server. Please check your internet connection.";
      } else {
        errorMessage = err.message;
      }

      await Swal.fire({
        icon: "error",
        title: errorTitle,
        text: errorMessage,
        confirmButtonColor: "#DD6B55",
      });
    }
    setActiveDropdown(null);
  };

  // Cleanup image preview URLs when component unmounts - Removed as per new requirements
  useEffect(() => {
    // No image preview to clean up
    return () => {};
  }, []);

  // Helper function to calculate net total
  const calculateNetTotal = (items) => {
    if (Array.isArray(items)) {
      return items
        .reduce((sum, item) => sum + parseFloat(item.amount || 0), 0)
        .toFixed(2);
    }
    return (0).toFixed(2);
  };

  // Function to open items modal
  const handleShowItems = (items, e) => {
    e.stopPropagation();
    setSelectedItems(items);
    setIsItemsModalOpen(true);
  };

  // Handle service item changes
  const handleServiceItemChange = (index, field, value) => {
    const updatedItems = [...serviceItems];
    if (field === "quantity") {
      updatedItems[index][field] = Math.max(0, parseInt(value) || 0);
    } else if (field === "totalItemPrice") {
      updatedItems[index][field] = Math.max(0, parseFloat(value) || 0);
    } else {
      updatedItems[index][field] = value;
    }
    setServiceItems(updatedItems);
  };

  // Add new service item
  const addServiceItem = () => {
    setServiceItems([
      ...serviceItems,
      {
        serviceName: "",
        quantity: 1,
        totalItemPrice: 0,
      },
    ]);
  };

  // Remove service item
  const removeServiceItem = (index) => {
    const updatedItems = serviceItems.filter((_, i) => i !== index);
    setServiceItems(updatedItems);
  };

  // Calculate total service charge
  const calculateTotalServiceCharge = () => {
    return serviceItems.reduce((total, item) => {
      const itemTotal = parseFloat(item.totalItemPrice) || 0;
      return total + itemTotal;
    }, 0);
  };

  if (loading) {
    return (
      <div className="w-full min-h-[797px] flex items-center justify-center">
        Loading Invoices...
      </div>
    );
  }

  return (
    <div
      className={`min-h-[797px] p-4 md:p-6 relative bg-gradient-to-br from-white to-[#E7F4FF] rounded-[10px] shadow-[2px_2px_6px_rgba(24,95,235,0.1)] flex flex-col w-full   ${
        isCollapsed
          ? "lg:max-w-[85vw] md:w-[85vw]"
          : "lg:max-w-[75vw] md:w-[80vw]"
      } md:mx-auto`}
    >
      {/* Header Section */}
      <div className="flex flex-wrap items-center justify-between gap-4 mb-8">
        {/* Title */}
        <h1 className="text-[20px] md:text-[22px] font-medium text-[#1F2837] whitespace-nowrap">
          {dynamicHeaderTitle}
        </h1>

        {/* Search Container */}
        <div className="flex-1 max-w-[400px] mx-1">
          {isMobile && !isSearchExpanded ? (
            <button
              onClick={handleSearchToggle}
              className="
          w-10 h-10
          flex items-center
          rounded-[6px]
          hover:bg-gray-50 transition-colors
        "
            >
              {/* search icon SVG */}
              <svg
                width="20"
                height="20"
                viewBox="0 0 22 22"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M10.5417 19.25C15.3512 19.25 19.25 15.3512 19.25 10.5417C19.25 5.73223 15.3512 1.83334 10.5417 1.83334C5.73223 1.83334 1.83334 5.73223 1.33334 10.5417C1.83334 15.3512 5.73223 19.25 10.5417 19.25Z"
                  stroke="#787374"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M18.3333 18.3333L20.1667 20.1667"
                  stroke="#787374"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>
          ) : (
            <div className="relative w-full">
              {/* Search icon inside input */}
              <div className="absolute left-4 top-1/2 -translate-y-1/2 pointer-events-none">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 22 22"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M10.5417 19.25C15.3512 19.25 19.25 15.3512 19.25 10.5417C19.25 5.73223 15.3512 1.83334 10.5417 1.83334C5.73223 1.83334 1.83334 5.73223 1.33334 10.5417C1.83334 15.3512 5.73223 19.25 10.5417 19.25Z"
                    stroke="#787374"
                    strokeWidth="1.5"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                  <path
                    d="M18.3333 18.3333L20.1667 20.1667"
                    stroke="#787374"
                    strokeWidth="1.5"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                </svg>
              </div>
              <input
                type="search"
                placeholder={isMobile ? "Search" : "Search by Name, Contact"}
                value={searchTerm}
                onChange={handleSearchChange}
                className="
            w-full
            h-[44px]
            pl-12 pr-4
            bg-[#E9F1F9]
            rounded-[6px]
            text-[#787374] placeholder-[#787374]
            focus:outline-none
            text-sm md:text-base lg:text-base
          "
                onBlur={handleSearchBlur}
                autoFocus={isMobile && isSearchExpanded}
              />
            </div>
          )}
        </div>

        {/* Actions: Create Lead + Display Dropdown + Bulk Actions */}
        <div className="flex flex-wrap items-center gap-3 md:gap-4 lg:gap-4">
          {selectedLeads.length > 0 && (
            <>
              <button
                className="hover:bg-red-500
            bg-[#DD6B55] text-white
            h-[44px] px-5
            rounded-[8px]
            flex items-center justify-center
          "
                onClick={handleBulkDelete}
              >
                Bulk Delete
              </button>
            </>
          )}
          <span className="text-[#727A90] text-xs sm:text-sm md:text-base lg:text-base whitespace-nowrap">
            Show
          </span>
          <div className="relative" ref={itemsPerPageDropdownRef}>
            {" "}
            {/* Add ref here */}
            <button
              type="button"
              className="
                relative appearance-none h-[32px] sm:h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-8 sm:pr-10 md:pr-15 lg:pr-15 w-full min-w-[56px] sm:min-w-[72px] md:min-w-[88px] lg:min-w-[88px] bg-white border border-[#E9EAEA] rounded-[8px]  text-[#242729] text-[10px] sm:text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center box-border
              "
              onClick={() =>
                setIsItemsPerPageDropdownOpen(!isItemsPerPageDropdownOpen)
              }
            >
              <span>{itemsPerPage}</span>
               <img
                  src="/caret-down.svg"
                  alt=""
                  aria-hidden="true"
                  className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
                />
            </button>
            {isItemsPerPageDropdownOpen && (
              <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar box-border">
                {[5, 10, 20, 50].map((num) => (
                  <button
                    key={num}
                    type="button"
                    className={`w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-xs sm:text-sm md:text-base lg:text-base ${
                      itemsPerPage === num
                        ? "bg-[#E7EFF8] font-bold text-[#ef7e1b]"
                        : "text-[#545454]"
                    }`}
                    onClick={() => {
                      handleItemsPerPageChange(num);
                      setIsItemsPerPageDropdownOpen(false);
                    }}
                  >
                    {num}
                  </button>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      {/* Filter Section */}
      <div className="w-full grid grid-cols-2 gap-3 mb-2 lg:grid-cols-5 md:gap-6">
        {/* Bill To Dropdown */}
        <div className="relative" ref={billToDropdownRef}>
          <button
            type="button"
            className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[120px] lg:min-w-[120px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center cursor-pointer"
            onClick={() =>
              setActiveDropdown(activeDropdown === "billTo" ? null : "billTo")
            }
          >
            <span className="truncate text-left flex-1">
              {filters.billTo === "all" ? "Bill To" : filters.billTo}
            </span>
            {/* Cross to clear filter */}
            {filters.billTo !== "all" && (
              <button
                type="button"
                className="absolute right-7 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 text-lg font-bold focus:outline-none"
                style={{ padding: 0, lineHeight: 1 }}
                tabIndex={-1}
                title="Clear filter"
                onClick={(e) => {
                  e.stopPropagation();
                  handleFilterChange("billTo", "all");
                }}
              >
                <RxCross2 />
              </button>
            )}
            <img
              src="/caret-down.svg"
              alt=""
              aria-hidden="true"
              className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
            />
          </button>
          {activeDropdown === "billTo" && (
            <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
              {Array.from(
                new Set(
                  invoices
                    .map((invoice) => invoice.bill_to_name)
                    .filter(Boolean)
                    .map((name) => name.toLowerCase().trim())
                )
              ).map((name) => (
                <button
                  key={name}
                  type="button"
                  onClick={() => {
                    handleFilterChange("billTo", name);
                    setActiveDropdown(null);
                  }}
                  className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer"
                >
                  {name}
                </button>
              ))}
            </div>
          )}
        </div>
        {/* Ship To Dropdown */}
        <div className="relative" ref={shipToDropdownRef}>
          <button
            type="button"
            className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[120px] lg:min-w-[120px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center cursor-pointer"
            onClick={() =>
              setActiveDropdown(activeDropdown === "shipTo" ? null : "shipTo")
            }
          >
            <span className="truncate text-left flex-1">
              {filters.shipTo === "all" ? "Ship To" : filters.shipTo}
            </span>
            {/* Cross to clear filter */}
            {filters.shipTo !== "all" && (
              <button
                type="button"
                className="absolute right-7 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 text-lg font-bold focus:outline-none"
                style={{ padding: 0, lineHeight: 1 }}
                tabIndex={-1}
                title="Clear filter"
                onClick={(e) => {
                  e.stopPropagation();
                  handleFilterChange("shipTo", "all");
                }}
              >
                <RxCross2 />
              </button>
            )}
            <img
              src="/caret-down.svg"
              alt=""
              aria-hidden="true"
              className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
            />
          </button>
          {activeDropdown === "shipTo" && (
            <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
              {Array.from(
                new Set(
                  invoices
                    .map((invoice) => invoice.ship_to_name)
                    .filter(Boolean)
                    .map((name) => name.toLowerCase().trim())
                )
              ).map((name) => (
                <button
                  key={name}
                  type="button"
                  onClick={() => {
                    handleFilterChange("shipTo", name);
                    setActiveDropdown(null);
                  }}
                  className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer"
                >
                  {name}
                </button>
              ))}
            </div>
          )}
        </div>
        {/* Payment Dropdown */}
        <div className="relative" ref={paymentDropdownRef}>
          <button
            type="button"
            className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[120px] lg:min-w-[120px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center cursor-pointer"
            onClick={() =>
              setActiveDropdown(activeDropdown === "payment" ? null : "payment")
            }
          >
            <span className="truncate text-left flex-1">
              {(() => {
                switch (filters.payment) {
                  case "lt50000":
                    return "< ₹50,000";
                  case "50001-100000":
                    return "₹50,001-1,00,000";
                  case "100001-400000":
                    return "₹1,00,001-4,00,000";
                  case "400001-500000":
                    return "₹4,00,001-5,00,000";
                  case "gt500000":
                    return "> ₹5,00,000";
                  default:
                    return "All Payments";
                }
              })()}
            </span>
            {/* Cross to clear filter */}
            {filters.payment !== "all" && (
              <button
                type="button"
                className="absolute right-7 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 text-lg font-bold focus:outline-none"
                style={{ padding: 0, lineHeight: 1 }}
                tabIndex={-1}
                title="Clear filter"
                onClick={(e) => {
                  e.stopPropagation();
                  handleFilterChange("payment", "all");
                }}
              >
                <RxCross2 />
              </button>
            )}
            <img
              src="/caret-down.svg"
              alt=""
              aria-hidden="true"
              className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
            />
          </button>
          {activeDropdown === "payment" && (
            <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
              <button
                className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                onClick={() => {
                  handleFilterChange("payment", "all");
                  setActiveDropdown(null);
                }}
              >
                All Payments
              </button>
              <button
                className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                onClick={() => {
                  handleFilterChange("payment", "lt50000");
                  setActiveDropdown(null);
                }}
              >
                {"< ₹50,000"}
              </button>
              <button
                className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                onClick={() => {
                  handleFilterChange("payment", "50001-100000");
                  setActiveDropdown(null);
                }}
              >
                {"₹50,001-1,00,000"}
              </button>
              <button
                className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                onClick={() => {
                  handleFilterChange("payment", "100001-400000");
                  setActiveDropdown(null);
                }}
              >
                {"₹1,00,001-4,00,000"}
              </button>
              <button
                className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                onClick={() => {
                  handleFilterChange("payment", "400001-500000");
                  setActiveDropdown(null);
                }}
              >
                {"₹4,00,001-5,00,000"}
              </button>
              <button
                className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                onClick={() => {
                  handleFilterChange("payment", "gt500000");
                  setActiveDropdown(null);
                }}
              >
                {"> ₹5,00,000"}
              </button>
            </div>
          )}
        </div>
        {/* Updated At Date Range Filter (was Invoice Date) */}
        <div className="relative" ref={invoiceDateRangeDropdownRef}>
          <button
            className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[120px] lg:min-w-[120px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center cursor-pointer"
            onClick={() =>
              setActiveDropdown(
                activeDropdown === "invoiceDateRange"
                  ? null
                  : "invoiceDateRange"
              )
            }
          >
            <span className="truncate text-left flex-1">
              {(() => {
                switch (filters.invoiceDateRange) {
                  case "today":
                    return "Updated Today";
                  case "last7days":
                    return "Updated Last 7 Days";
                  case "last30days":
                    return "Updated Last 30 Days";
                  case "last6months":
                    return "Updated Last 6 Months";
                  case "last12months":
                    return "Updated Last 12 Months";
                  default:
                    return "Updated At";
                }
              })()}
            </span>
            {/* Cross to clear filter */}
            {filters.invoiceDateRange !== "all" && (
              <button
                type="button"
                className="absolute right-7 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 text-lg font-bold focus:outline-none"
                style={{ padding: 0, lineHeight: 1 }}
                tabIndex={-1}
                title="Clear filter"
                onClick={(e) => {
                  e.stopPropagation();
                  handleFilterChange("invoiceDateRange", "all");
                }}
              >
                <RxCross2 />
              </button>
            )}
            <img
              src="/caret-down.svg"
              alt=""
              aria-hidden="true"
              className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
            />
          </button>
          {activeDropdown === "invoiceDateRange" && (
            <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
              <button
                className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                onClick={() => {
                  handleFilterChange("invoiceDateRange", "all");
                  setActiveDropdown(null);
                }}
              >
                All Dates
              </button>
              <button
                className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                onClick={() => {
                  handleFilterChange("invoiceDateRange", "today");
                  setActiveDropdown(null);
                }}
              >
                Today
              </button>
              <button
                className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                onClick={() => {
                  handleFilterChange("invoiceDateRange", "last7days");
                  setActiveDropdown(null);
                }}
              >
                Last 7 Days
              </button>
              <button
                className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                onClick={() => {
                  handleFilterChange("invoiceDateRange", "last30days");
                  setActiveDropdown(null);
                }}
              >
                Last 30 Days
              </button>
              <button
                className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                onClick={() => {
                  handleFilterChange("invoiceDateRange", "last6months");
                  setActiveDropdown(null);
                }}
              >
                Last 6 Months
              </button>
              <button
                className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                onClick={() => {
                  handleFilterChange("invoiceDateRange", "last12months");
                  setActiveDropdown(null);
                }}
              >
                Last 12 Months
              </button>
            </div>
          )}
        </div>
        {/* Created Date Range Filter */}
        <div
          className="relative col-span-2 lg:col-span-1"
          ref={createdDateRangeDropdownRef}
        >
          <button
            className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[120px] lg:min-w-[120px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center cursor-pointer"
            onClick={() =>
              setCreatedDateRangeDropdownOpen(!createdDateRangeDropdownOpen)
            }
          >
            <span className="truncate text-left flex-1">
              {createdTimeRange === "all" && "Created At"}
              {createdTimeRange === "7days" && "Last 7 Days"}
              {createdTimeRange === "30days" && "Last 30 Days"}
              {createdTimeRange === "90days" && "Last 90 Days"}
              {createdTimeRange === "custom" && (
                <span className="text-[10px] whitespace-nowrap">
                  {`${formatDateForDisplay(
                    customCreatedDateRange.fromDate
                  )} - ${formatDateForDisplay(customCreatedDateRange.toDate)}`}
                </span>
              )}
            </span>
            <img
              src="/caret-down.svg"
              alt=""
              aria-hidden="true"
              className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
            />
          </button>
          {createdDateRangeDropdownOpen && (
            <div className="absolute right-0 mt-2 w-72 bg-white border border-gray-200 rounded-lg shadow-lg z-10 cursor-pointer">
              <div className="px-4 pt-3  text-[#4B5563]">
                <p className="text-sm font-medium">Select Range</p>
              </div>
              <div className="p-2">
                {/* Predefined ranges */}
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    createdTimeRange === "all"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  }`}
                  onClick={() => handleCreatedTimeRangeChange("all")}
                >
                  {" "}
                  <span>All Dates</span>{" "}
                  {createdTimeRange === "all" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}{" "}
                </button>
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    createdTimeRange === "7days"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  }`}
                  onClick={() => handleCreatedTimeRangeChange("7days")}
                >
                  {" "}
                  <span>Last 7 Days</span>{" "}
                  {createdTimeRange === "7days" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}{" "}
                </button>
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    createdTimeRange === "30days"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  }`}
                  onClick={() => handleCreatedTimeRangeChange("30days")}
                >
                  {" "}
                  <span>Last 30 Days</span>{" "}
                  {createdTimeRange === "30days" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}{" "}
                </button>
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    createdTimeRange === "90days"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  }`}
                  onClick={() => handleCreatedTimeRangeChange("90days")}
                >
                  {" "}
                  <span>Last 90 Days</span>{" "}
                  {createdTimeRange === "90days" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}{" "}
                </button>
                <div className="border-t border-gray-200 my-2"></div>
                {/* Custom date range */}
                <div className="px-3 py-2">
                  <p className="text-sm font-medium text-[#4B5563] mb-2">
                    Custom Range
                  </p>
                  <div className="grid grid-cols-2 gap-2 mb-3">
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">
                        From
                      </label>
                      <input
                        type="date"
                        className="w-full h-[48px] text-sm px-2 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                        value={
                          customCreatedDateRange.fromDate
                            ? customCreatedDateRange.fromDate
                                .toISOString()
                                .split("T")[0]
                            : ""
                        }
                        onChange={(e) =>
                          handleCustomCreatedDateChange(
                            "fromDate",
                            e.target.value
                          )
                        }
                        max={
                          customCreatedDateRange.toDate
                            ? customCreatedDateRange.toDate
                                .toISOString()
                                .split("T")[0]
                            : new Date().toISOString().split("T")[0]
                        }
                      />
                    </div>
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">
                        To
                      </label>
                      <input
                        type="date"
                        className="w-full h-[48px] text-sm px-2 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                        value={
                          customCreatedDateRange.toDate
                            ? customCreatedDateRange.toDate
                                .toISOString()
                                .split("T")[0]
                            : ""
                        }
                        onChange={(e) =>
                          handleCustomCreatedDateChange(
                            "toDate",
                            e.target.value
                          )
                        }
                        min={
                          customCreatedDateRange.fromDate
                            ? customCreatedDateRange.fromDate
                                .toISOString()
                                .split("T")[0]
                            : ""
                        }
                        max={new Date().toISOString().split("T")[0]}
                      />
                    </div>
                  </div>
                  <button
                    className="hover:bg-blue-500 bg-[#ef7e1b] text-white h-[44px] px-5 rounded-[8px] flex items-center justify-center w-full"
                    onClick={applyCustomCreatedDateRange}
                  >
                    Apply Custom Range
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
      {/* Search Results Info */}
      {searchTerm && (
        <div className="mb-4 text-sm text-[#4B5563]">
          Showing {filteredInvoices.length} results for "{searchTerm}"
        </div>
      )}
      {/* Invoice List Table */}
      <div className="hidden md:block w-full flex-grow overflow-x-auto overflow-y-hidden relative custom-scrollbar">
        <table className="w-full min-w-[1000px] border-collapse">
          <thead>
            <tr className="text-left text-[#4B5563]">
              <th className="py-4 px-3 font-medium text-sm w-12">
                <input
                  type="checkbox"
                  checked={
                    selectedLeads.length === currentInvoices.length &&
                    currentInvoices.length > 0
                  }
                  onChange={toggleSelectAll}
                  className="w-4 h-4 rounded border-[#E9EAEA] cursor-pointer"
                />
              </th>
              <th className="py-4 px-3 font-medium text-sm whitespace-nowrap w-[120px]">
                Invoice No
              </th>
              <th className="py-4 px-3 font-medium text-sm whitespace-nowrap w-[150px]">
                Bill To
              </th>
              <th className="py-4 px-3 font-medium text-sm whitespace-nowrap w-[150px]">
                Ship To
              </th>
              <th className="py-4 px-3 font-medium text-sm whitespace-nowrap w-[180px]">
                Total
              </th>
              <th className="py-4 px-3 font-medium text-sm whitespace-nowrap w-[120px]">
                Created At
              </th>
              <th className="py-4 px-3 font-medium text-sm whitespace-nowrap w-[120px]">
                Updated At
              </th>
              <th className="py-4 px-3 font-medium text-sm w-12 text-right">
                Action
              </th>
            </tr>
          </thead>
          <tbody>
            {currentInvoices.length === 0 ? (
              <tr>
                <td
                  colSpan="7"
                  className="py-8 px-3 text-center text-[#4B5563]"
                >
                  {searchTerm
                    ? "No invoices found matching your search."
                    : "No invoices available."}
                </td>
              </tr>
            ) : (
              currentInvoices.map((invoice) => (
                <React.Fragment key={invoice.id}>
                  <tr className="border-t border-[#E5E7EB]">
                    <td className="py-4 px-3 w-12">
                      <input
                        type="checkbox"
                        checked={selectedLeads.includes(invoice.id)}
                        onChange={() => toggleInvoiceSelection(invoice.id)}
                        className="w-4 h-4 rounded border-[#E9EAEA] cursor-pointer bg-[#E9EAEA]"
                      />
                    </td>
                    <td className="py-4 px-3 text-sm text-[#4B5563] overflow-hidden truncate">
                      {invoice.invoice_no}
                    </td>
                    <td className="py-4 px-3 text-sm text-[#4B5563] overflow-hidden truncate">
                      <span className="text-[#1F2837] font-medium">
                        {invoice.bill_to_name}
                      </span>
                    </td>
                    <td className="py-4 px-3 text-sm text-[#4B5563] overflow-hidden truncate">
                      <span className="text-[#1F2837] font-medium">
                        {invoice.ship_to_name}
                      </span>
                    </td>
                    <td className="py-4 px-3 text-sm text-[#4B5563]">
                      <div
                        className="inline-flex items-center gap-2 bg-blue-50 px-3 py-1.5 rounded-full hover:bg-blue-100 transition-colors cursor-pointer"
                        onClick={(e) => handleShowItems(invoice.items, e)}
                      >
                        <span className="font-medium text-[#1F2837]">
                          Rs {invoice.grand_total}
                        </span>
                        <div className="h-3.5 w-[1px] bg-blue-200"></div>
                        <span className="text-xs text-blue-600">
                          {invoice.items?.length} items
                        </span>
                      </div>
                    </td>
                    <td className="py-4 px-3 text-sm text-[#4B5563] overflow-hidden truncate">
                      {invoice.created_at ? (
                        <>
                          <span className="block text-sm">
                            {new Date(invoice.created_at).toLocaleTimeString(
                              "en-US",
                              {
                                hour: "2-digit",
                                minute: "2-digit",
                                hour12: true,
                              }
                            )}
                          </span>
                          <span className="block text-blue-600 text-xs mt-1">
                            {formatDateForDisplay(invoice.created_at)}
                          </span>
                        </>
                      ) : (
                        ""
                      )}
                    </td>
                    <td className="py-4 px-3 text-sm text-[#4B5563] overflow-hidden truncate">
                      {invoice.updated_at ? (
                        <>
                          <span className="block text-sm">
                            {new Date(invoice.updated_at).toLocaleTimeString(
                              "en-US",
                              {
                                hour: "2-digit",
                                minute: "2-digit",
                                hour12: true,
                              }
                            )}
                          </span>
                          <span className="block text-blue-600 text-xs mt-1">
                            {formatDateForDisplay(invoice.updated_at)}
                          </span>
                        </>
                      ) : (
                        ""
                      )}
                    </td>
                    <td className="py-4 px-3 relative">
                      <button
                        onClick={() => toggleDropdown(invoice.id)}
                        className="p-2 text-[#4B5563] hover:bg-blue-200 hover:text-white rounded-full transition-colors "
                      >
                        <TbDotsVertical className="w-4 h-4" />
                      </button>
                      {activeDropdown === invoice.id && (
                        <div className="relative">
                          <div
                            ref={
                              activeDropdown === invoice.id
                                ? setActionDropdownNode
                                : null
                            }
                            data-dropdown-id={invoice.id}
                            className="absolute left-3 w-24 rounded-md shadow-md bg-gradient-to-br from-white to-[#E7F4FF] z-10 overflow-hidden"
                            onMouseDown={(e) => {
                              console.log("Dropdown mousedown", invoice.id);
                              e.stopPropagation();
                            }} // Prevent dropdown from closing
                          >
                            {/* EDIT button - only if permission */}
                            {permissionsForInvoiceModule.includes("edit") && (
                              <button
                                onClick={() => {
                                  console.log("Edit clicked", invoice);
                                  handleEdit(invoice);
                                }}
                                className="group flex items-center px-2 py-1 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors first:rounded-t-md"
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="24"
                                  height="24"
                                  viewBox="0 0 24 24"
                                  className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                >
                                  <path
                                    fill="currentColor"
                                    d="M4 14v-2h7v2zm0-4V8h11v2zm0-4V4h11v2zm9 14v-3.075l6.575-6.55l3.075 3.05L16.075 20zm7.5-6.575l-.925-.925zm-6 5.075h.95l3.025-3.05l-.45-.475l-.475-.45l-3.05 3.025zm3.525-3.525l-.475-.45l.925.925z"
                                  />
                                </svg>
                                <span className="group-hover:text-white transition-colors">
                                  Edit
                                </span>
                              </button>
                            )}
                            {/* Separator if both buttons shown */}
                            {permissionsForInvoiceModule.includes("edit") &&
                              permissionsForInvoiceModule.includes(
                                "delete"
                              ) && (
                                <svg
                                  className="w-full h-[1px]"
                                  viewBox="0 0 100 1"
                                  preserveAspectRatio="none"
                                  xmlns="http://www.w3.org/2000/svg"
                                >
                                  <polygon
                                    points="0,0 50,1 100,0"
                                    fill="#E5E7EB"
                                  ></polygon>
                                </svg>
                              )}
                            {/* DELETE button - only if permission */}
                            {permissionsForInvoiceModule.includes("delete") && (
                              <button
                                onClick={() => {
                                  console.log("Delete clicked", invoice.id);
                                  handleDelete(invoice.id);
                                }}
                                className="group flex items-center px-2 py-1 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors last:rounded-b-md"
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="24"
                                  height="24"
                                  viewBox="0 0 24 24"
                                  className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                >
                                  <path
                                    fill="currentColor"
                                    d="M7.616 20q-.672 0-1.144-.472T6 18.385V6H5V5h4v-.77h6V5h4v1h-1v12.385q0 .69-.462 1.153T16.384 20zM17 6H7v12.385q0 .269.173.442t.443.173h8.769q.23 0 .423-.192t.192-.424zM9.808 17h1V8h-1zm3.384 0h1V8h-1zM7 6v13z"
                                  />
                                </svg>
                                <span className="group-hover:text-white transition-colors">
                                  Delete
                                </span>
                              </button>
                            )}
                          </div>
                        </div>
                      )}
                    </td>
                  </tr>
                </React.Fragment>
              ))
            )}
          </tbody>
        </table>
      </div>
      {/* Invoice List Cards for Mobile */}
      <div className="md:hidden w-full space-y-6 pb-24 flex-grow overflow-x-auto">
        {currentInvoices.length === 0 ? (
          <div className="py-12 px-6 text-center">
            <div className="w-16 h-16 mx-auto mb-4  rounded-full flex items-center justify-center">
              <svg
                className="w-8 h-8 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth="1.5"
                  d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-5.5a2.5 2.5 0 00-2.5 2.5v.5a2 2 0 01-2 2h-3a2 2 0 01-2-2v-.5a2.5 2.5 0 00-2.5-2.5H4"
                />
              </svg>
            </div>
            <p className="text-gray-500 font-medium">
              {searchTerm
                ? "No invoices found matching your search."
                : "No invoices available."}
            </p>
          </div>
        ) : (
          currentInvoices.map((invoice) => {
            return (
              <div
                key={invoice.id}
                className="bg-white rounded-2xl border border-gray-100 hover:border-gray-200 transition-all duration-300 hover:shadow-lg"
              >
                {/* Header Section */}
                <div className="p-4 sm:p-6 border-b border-gray-50">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-2 sm:space-x-4">
                      <input
                        type="checkbox"
                        checked={selectedLeads.includes(invoice.id)}
                        onChange={() => toggleInvoiceSelection(invoice.id)}
                        className="w-5 h-5 rounded border-gray-300 text-gray-900 focus:ring-gray-500 focus:ring-2"
                      />

                      <div className="flex items-center space-x-3">
                        <div className="w-12 h-12 rounded-full bg-gray-100 overflow-hidden ring-1 ring-gray-200">
                          {/* Removed profile_pic rendering */}
                          <img
                            src="/dummyavatar.jpeg"
                            alt={invoice.customer_name}
                            className="w-full h-full object-cover"
                          />
                        </div>

                        <div>
                          {/* Invoice ID */}
                          <div className="text-xs text-blue-600 font-semibold ">
                            Invoice No: {invoice.invoice_no}
                          </div>
                          <h3 className="text-base font-semibold text-gray-900 whitespace-nowrap">
                            {invoice.company_name || invoice.customer_name}
                          </h3>
                          <p className="text-xs text-gray-400 mt-1">
                            {formatDateForDisplay(invoice.created_at)}
                          </p>
                        </div>
                      </div>
                    </div>

                    {/* Actions Menu */}
                    <div className="relative">
                      <button
                        onClick={() => toggleDropdown(invoice.id)}
                        className="p-1 text-[#4B5563] rounded-full hover:bg-gray-100"
                      >
                        <TbDotsVertical className="w-4 h-4" />
                      </button>

                      {activeDropdown === invoice.id && (
                        <div
                          ref={
                            activeDropdown === invoice.id
                              ? setActionDropdownNode
                              : null
                          }
                          className="absolute right-0 mt-1 w-24 sm:w-28 rounded-md shadow-md bg-gradient-to-br from-white to-[#E7F4FF] z-20 overflow-hidden"
                          onMouseDown={(e) => {
                            console.log("Dropdown mousedown", invoice.id);
                            e.stopPropagation();
                          }} // Prevent dropdown from closing
                        >
                          <div>
                            {/* EDIT button - only if permission */}
                            {permissionsForInvoiceModule.includes("edit") && (
                              <button
                                onClick={() => {
                                  console.log("Edit clicked (mobile)", invoice);
                                  handleEdit(invoice);
                                }}
                                className="group flex items-center px-3 py-2 text-xs text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors first:rounded-t-md"
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="16"
                                  height="16"
                                  viewBox="0 0 24 24"
                                  className="mr-2 w-3 h-3 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                >
                                  <path
                                    fill="currentColor"
                                    d="M4 14v-2h7v2zm0-4V8h11v2zm0-4V4h11v2zm9 14v-3.075l6.575-6.55l3.075 3.05L16.075 20zm7.5-6.575l-.925-.925zm-6 5.075h.95l3.025-3.05l-.45-.475l-.475-.45l-3.05 3.025zm3.525-3.525l-.475-.45l.925.925z"
                                  />
                                </svg>
                                <span className="group-hover:text-white transition-colors">
                                  Edit
                                </span>
                              </button>
                            )}
                            {/* Separator if both buttons shown */}
                            {permissionsForInvoiceModule.includes("edit") &&
                              permissionsForInvoiceModule.includes(
                                "delete"
                              ) && (
                                <svg
                                  className="w-full h-[1px]"
                                  viewBox="0 0 100 1"
                                  preserveAspectRatio="none"
                                  xmlns="http://www.w3.org/2000/svg"
                                >
                                  <polygon
                                    points="0,0 50,1 100,0"
                                    fill="#E5E7EB"
                                  />
                                </svg>
                              )}
                            {/* DELETE button - only if permission */}
                            {permissionsForInvoiceModule.includes("delete") && (
                              <button
                                onClick={() => {
                                  console.log(
                                    "Delete clicked (mobile)",
                                    invoice.id
                                  );
                                  handleDelete(invoice.id);
                                }}
                                className="group flex items-center px-3 py-2 text-xs text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors last:rounded-b-md"
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="16"
                                  height="16"
                                  viewBox="0 0 24 24"
                                  className="mr-2 w-3 h-3 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                >
                                  <path
                                    fill="currentColor"
                                    d="M7.616 20q-.672 0-1.144-.472T6 18.385V6H5V5h4v-.77h6V5h4v1h-1v12.385q0 .69-.462 1.153T16.384 20zM17 6H7v12.385q0 .269.173.442t.443.173h8.769q.23 0 .423-.192t.192-.424zM9.808 17h1V8h-1zm3.384 0h1V8h-1zM7 6v13z"
                                  />
                                </svg>
                                <span className="group-hover:text-white transition-colors">
                                  Delete
                                </span>
                              </button>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* Details Section */}
                <div className="p-3 sm:p-4 space-y-3">
                  {/* Total Row (matches desktop, clickable for items modal) */}
                  <div
                    className="flex items-center space-x-1 p-2 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors duration-200 mb-2 cursor-pointer"
                    onClick={(e) => handleShowItems(invoice.items, e)}
                  >
                    <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                      <svg
                        className="w-5 h-5 text-blue-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="1.5"
                          d="M12 8v8m0 0l-3-3m3 3l3-3"
                        />
                      </svg>
                    </div>
                    <div className="min-w-0 flex-1 ">
                      <p className="text-[10px] ml-1 font-medium text-blue-600 uppercase tracking-wide">
                        Total
                      </p>
                      <div className="flex items-center gap-2">
                        <p className="text-[13px] ml-1 text-blue-900 font-bold">
                          Rs {invoice.grand_total}
                        </p>
                        <span className="text-xs text-blue-600">
                          ({invoice?.items?.length} items)
                        </span>
                      </div>
                    </div>
                  </div>
                  {/* Company Name Row */}
                  <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                      <svg
                        className="w-3 h-3 text-gray-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="1.5"
                          d="M19 21v-2a2 2 0 00-2-2H7a2 2 0 00-2 2v2m7-8v-1a2 2 0 00-2-2H9a2 2 0 00-2 2v1m-4 0h14a2 2 0 012 2v5a2 2 0 01-2 2H3a2 2 0 01-2-2v-5a2 2 0 012-2z"
                        />
                      </svg>
                    </div>
                    <div className="min-w-0 flex-1 ">
                      <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                        Bill To
                      </p>
                      <p className="text-[10px] ml-1 text-gray-900">
                        {invoice.bill_to_name}
                      </p>
                    </div>
                  </div>
                  {/* Contact Number Row */}
                  <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                      <svg
                        className="w-3 h-3 text-gray-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="1.5"
                          d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                        />
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="1.5"
                          d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                        />
                      </svg>
                    </div>
                    <div className="min-w-0 flex-1 ">
                      <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                        Ship To
                      </p>
                      <p className="text-[10px] ml-1 text-gray-900">
                        {invoice.ship_to_name}
                      </p>
                    </div>
                  </div>
                  {/* Invoice Date Row */}
                  <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                      <svg
                        className="w-3 h-3 text-gray-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="1.5"
                          d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                        />
                      </svg>
                    </div>
                    <div className="min-w-0 flex-1 ">
                      <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                        Invoice Date
                      </p>
                      <p className="text-[10px] ml-1 text-gray-900">
                        {invoice.invoice_date
                          ? formatDateForDisplay(invoice.invoice_date)
                          : ""}
                      </p>
                    </div>
                  </div>
                  {/* Expiry Date Row */}
                  <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                      <svg
                        className="w-3 h-3 text-gray-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="1.5"
                          d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                        />
                      </svg>
                    </div>
                    <div className="min-w-0 flex-1 ">
                      <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                        Expiry Date
                      </p>
                      <p className="text-[10px] ml-1 text-gray-900">
                        {invoice.expiry_date
                          ? new Date(invoice.expiry_date).toLocaleDateString()
                          : ""}
                      </p>
                    </div>
                  </div>
                  {/* Created At Row */}
                  <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                      <svg
                        className="w-3 h-3 text-gray-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="1.5"
                          d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                    </div>
                    <div className="min-w-0 flex-1 ">
                      <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                        Created At
                      </p>
                      <p className="text-[10px] ml-1 text-gray-900">
                        {invoice.created_at ? (
                          <>
                            <span className="block text-xs">
                              {new Date(invoice.created_at).toLocaleTimeString(
                                "en-US",
                                {
                                  hour: "2-digit",
                                  minute: "2-digit",
                                  hour12: true,
                                }
                              )}
                            </span>
                            <span className="block text-blue-600 text-xs mt-1">
                              {formatDateForDisplay(invoice.created_at)}
                            </span>
                          </>
                        ) : (
                          ""
                        )}
                      </p>
                    </div>
                  </div>
                  {/* Updated At Row */}
                  <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                      <svg
                        className="w-3 h-3 text-gray-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="1.5"
                          d="M4 4v5h.582m15.356-2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m0 0H15"
                        />
                      </svg>
                    </div>
                    <div className="min-w-0 flex-1 ">
                      <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                        Updated At
                      </p>
                      <p className="text-[10px] ml-1 text-gray-900">
                        {invoice.updated_at ? (
                          <>
                            <span className="block text-xs">
                              {new Date(invoice.updated_at).toLocaleTimeString(
                                "en-US",
                                {
                                  hour: "2-digit",
                                  minute: "2-digit",
                                  hour12: true,
                                }
                              )}
                            </span>
                            <span className="block text-blue-600 text-xs mt-1">
                              {formatDateForDisplay(invoice.updated_at)}
                            </span>
                          </>
                        ) : (
                          ""
                        )}
                      </p>
                    </div>
                  </div>
                  {/* Removed WhatsApp, Status, and old items table UI */}
                </div>
              </div>
            );
          })
        )}
      </div>{" "}
      {/* Edit Modal */}
      {isModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center overflow-y-auto bg-gray-50/10 backdrop-blur-sm border border-white/30">
          <div className="w-11/12 max-w-[900px] max-h-[90vh] overflow-y-auto p-6 md:p-8 rounded-2xl bg-gradient-to-br from-[#FFFFFF] to-[#E6F4FF] shadow-lg relative z-10 custom-scrollbar">
            <h2 className="text-[24px] sm:text-[29px] font-medium text-[#1F2837] mb-8">
              {dynamicModalTitle}
            </h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              {" "}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-2">
                  <label className="block text-[#4B5563] text-[16px]">
                    Customer Name
                  </label>
                  <input
                    type="text"
                    name="customer_name"
                    value={formData.customer_name}
                    onChange={(e) =>
                      handleInputChange("customer_name", e.target.value)
                    }
                    className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454]"
                  />
                </div>
                <div className="space-y-2">
                  <label className="block text-[#4B5563] text-[16px]">
                    Company Name
                  </label>
                  <input
                    type="text"
                    name="company_name"
                    value={formData.company_name}
                    onChange={(e) =>
                      handleInputChange("company_name", e.target.value)
                    }
                    className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454]"
                  />
                </div>
                <div className="space-y-2">
                  <label className="block text-[#4B5563] text-[16px]">
                    Contact Number
                  </label>
                  <input
                    type="tel"
                    name="contact"
                    value={formData.contact}
                    onChange={(e) =>
                      handleInputChange("contact", e.target.value)
                    }
                    className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454]"
                  />
                </div>
                <div className="space-y-2">
                  <label className="block text-[#4B5563] text-[16px]">
                    Address
                  </label>
                  <input
                    type="text"
                    name="address"
                    value={formData.address}
                    onChange={(e) =>
                      handleInputChange("address", e.target.value)
                    }
                    className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454]"
                  />
                </div>
                <div className="space-y-2">
                  <label className="block text-[#4B5563] text-[16px]">
                    Status
                  </label>
                  <input
                    type="text"
                    name="status"
                    value={formData.status}
                    onChange={(e) =>
                      handleInputChange("status", e.target.value)
                    }
                    className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454]"
                  />
                </div>
                <div className="space-y-2">
                  <label className="block text-[#4B5563] text-[16px]">
                    Invoice Date
                  </label>
                  <input
                    type="date"
                    name="invoice_date"
                    value={formData.invoice_date}
                    onChange={(e) =>
                      handleInputChange("invoice_date", e.target.value)
                    }
                    className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454]"
                  />
                </div>
                <div className="space-y-2">
                  <label className="block text-[#4B5563] text-[16px]">
                    Expiry Date
                  </label>
                  <input
                    type="date"
                    name="expiry_date"
                    value={formData.expiry_date}
                    onChange={(e) =>
                      handleInputChange("expiry_date", e.target.value)
                    }
                    className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454]"
                  />
                </div>
              </div>{" "}
              <div className="mt-8">
                <h3 className="text-[20px] font-medium text-[#1F2837] mb-4">
                  Service Items
                </h3>

                {/* Table Headers */}
                <div className="grid grid-cols-[0.4fr_3fr_1fr_1fr] gap-4 text-[#8B8B8B] text-[10px] font-bold mb-1">
                  <div className="whitespace-nowrap">Sr. No.</div>
                  <div>Service</div>
                  <div className="whitespace-nowrap">Quantity</div>
                  <div className="whitespace-nowrap">Total Price</div>
                </div>

                <div className="w-full h-[1px] bg-gray-200 my-4"></div>

                {/* Service Items */}
                {serviceItems.map((item, index) => (
                  <div
                    key={index}
                    className="grid grid-cols-[0.4fr_3fr_1fr_1fr] gap-4 items-center mb-4 relative group"
                  >
                    <div className="w-full h-[44px] px-3 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 flex items-center text-[#545454]">
                      {index + 1}
                    </div>
                    <div>
                      <textarea
                        placeholder="Detailed Service Description"
                        className="w-full px-3 py-2 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] resize-y overflow-hidden h-auto min-h-[44px]"
                        value={item.serviceName}
                        onChange={(e) =>
                          handleServiceItemChange(
                            index,
                            "serviceName",
                            e.target.value
                          )
                        }
                        rows={1}
                        onInput={(e) => {
                          e.target.style.height = "auto";
                          e.target.style.height = e.target.scrollHeight + "px";
                        }}
                      />
                    </div>
                    <div>
                      <input
                        type="number"
                        placeholder="1"
                        className="w-full h-[44px] px-3 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                        value={item.quantity}
                        onChange={(e) =>
                          handleServiceItemChange(
                            index,
                            "quantity",
                            e.target.value
                          )
                        }
                      />
                    </div>
                    <div className="flex items-center gap-2">
                      <input
                        type="number"
                        placeholder="0.00"
                        className="w-full h-[44px] px-3 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                        value={item.totalItemPrice}
                        onChange={(e) =>
                          handleServiceItemChange(
                            index,
                            "totalItemPrice",
                            e.target.value
                          )
                        }
                      />
                      <button
                        onClick={() => removeServiceItem(index)}
                        className="absolute cursor-pointer -right-4 text-red-500  transition-opacity"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          strokeWidth={2}
                          stroke="currentColor"
                          className="w-3 h-3"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            d="M6 18L18 6M6 6l12 12"
                          />
                        </svg>
                      </button>
                    </div>
                  </div>
                ))}

                <div className="flex justify-end mb-4">
                  <button
                    type="button"
                    onClick={addServiceItem}
                    className="h-[44px] px-10 rounded-[12px] bg-[#ef7e1b] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-white hover:bg-[#ee7f1b]"
                  >
                    Add
                  </button>
                </div>

                <div className="w-full h-[1px] bg-gray-200 my-4"></div>

                <div className="flex items-center justify-end gap-8 lg:gap-56 mb-14">
                  <div className="text-[#2798FF] text-lg sm:text-xl lg:text-[20px] font-bold">
                    Total
                  </div>
                  <div className="text-[#2798FF] text-lg sm:text-xl lg:text-[20px] font-bold">
                    Rs {calculateTotalServiceCharge().toFixed(2)}
                  </div>
                </div>
              </div>
              <div className="flex justify-end gap-4 mt-8">
                <button
                  type="button"
                  onClick={() => setIsModalOpen(false)}
                  className="h-[46px] px-8 text-[#545454] bg-[#E7EFF8] hover:bg-[#d3e5f7] rounded-[12px] transition-colors font-medium"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  className="h-[46px] px-4 text-white bg-[#ef7e1b] hover:bg-[#ee7f1b] rounded-[12px] transition-colors font-medium"
                >
                  Save Changes
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
      {/* Items Modal */}
      {isItemsModalOpen && selectedItems && (
        <div className="fixed inset-0 flex items-center justify-center z-50">
          {/* Frosted overlay */}
          <div
            className="absolute inset-0 bg-gray-50/10 backdrop-blur-sm border border-white/30"
            onClick={() => setIsItemsModalOpen(false)}
          />

          {/* Glassmorphism modal container */}
          <div
            className="w-11/12 max-w-[1000px] max-h-[90vh] overflow-y-auto p-6 md:p-8
              rounded-2xl
              bg-gradient-to-br from-[#FFFFFF] to-[#E6F4FF]
              shadow-lg
              relative z-10 custom-scrollbar"
          >
            {/* Close button */}
            <button
              onClick={() => setIsItemsModalOpen(false)}
              className="absolute top-6 right-6 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13 1L1 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M1 1L13 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Modal title */}
            <h2 className="text-[24px] sm:text-[29px] font-medium text-[#1F2837] mb-8">
              Items Details
            </h2>

            {/* Items Table */}
            <div className=" rounded-[12px] overflow-hidden">
              <table className="min-w-full divide-y divide-[#E5E7EB]">
                <thead className="">
                  <tr>
                    <th
                      scope="col"
                      className="px-6 py-4 text-left text-sm font-medium text-[#4B5563] uppercase tracking-wider"
                    >
                      Product/Service
                    </th>
                    <th
                      scope="col"
                      className="px-6 py-4 text-center text-sm font-medium text-[#4B5563] uppercase tracking-wider"
                    >
                      Quantity
                    </th>
                    <th
                      scope="col"
                      className="px-6 py-4 text-left text-sm font-medium text-[#4B5563] uppercase tracking-wider"
                    >
                      Price
                    </th>
                    <th
                      scope="col"
                      className="px-6 py-4 text-center text-sm font-medium text-[#4B5563] uppercase tracking-wider"
                    >
                      GST (%)
                    </th>
                    <th
                      scope="col"
                      className="px-6 py-4 text-left text-sm font-medium text-[#4B5563] uppercase tracking-wider"
                    >
                      Total
                    </th>
                  </tr>
                </thead>
                <tbody className=" divide-y divide-[#E5E7EB]">
                  {selectedItems.map((item, index) => (
                    <tr key={index} className="">
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-[#545454]">
                        {item.item_name}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-[#545454] text-center">
                        {item.qty}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-[#545454]">
                        Rs {parseFloat(item.rate).toFixed(2)}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-[#545454] text-center">
                        {item.gst}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-[#545454]">
                        Rs {parseFloat(item.amount).toFixed(2)}
                      </td>
                    </tr>
                  ))}
                  <tr className=" font-medium">
                    <td
                      colSpan="4"
                      className="px-6 py-4 text-right text-sm text-[#1F2837]"
                    >
                      Net Total:
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-[#1F2837]">
                      Rs {calculateNetTotal(selectedItems)}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            {/* Close button */}
            <div className="mt-10 flex justify-center">
              <button
                onClick={() => setIsItemsModalOpen(false)}
                className="w-full md:w-[207px] h-[46px] bg-[#ef7e1b] text-white rounded-[10px] hover:bg-[#ee7f1b] transition-colors"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}
      {/* Pagination Controls */}
      {filteredInvoices.length > 0 && (
        <div className="flex justify-center pt-7 mt-auto">
          <div className="flex items-center gap-2 lg:gap-3">
            {/* Previous Page */}
            <button
              onClick={handlePreviousPage}
              disabled={currentPage === 1}
              className={`w-[44px] h-[44px] lg:w-[52px] lg:h-[52px]
          rounded-full border border-[#7E7B7B]
          flex items-center justify-center transition-colors
          ${
            currentPage === 1
              ? "opacity-50 cursor-not-allowed"
              : "group hover:bg-blue-200 hover:border-white hover:text-white"
          }
        `}
            >
              <svg
                width="33"
                height="32"
                viewBox="0 0 33 32"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                className={`stroke-current text-[#7E7B7B]
            ${currentPage === 1 ? "" : "group-hover"}
          `}
              >
                <path
                  d="M23.1667 5.33398L12.06 13.3873C9.09198 15.5407 9.09198 16.462 12.06 18.614L23.1667 26.6673"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M18.3333 18.3333L20.1667 20.1667"
                  stroke="#787374"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Page Info */}
            <div className="flex items-center gap-2 text-sm lg:text-base text-[#4B5563]">
              <span>
                Page {currentPage} of {totalPages}
              </span>
              <span>({filteredInvoices.length} total)</span>
            </div>

            {/* Next Page */}
            <button
              onClick={handleNextPage}
              disabled={currentPage === totalPages}
              className={`w-[44px] h-[44px] lg:w-[52px] lg:h-[52px]
          rounded-full border border-[#7E7B7B]
          flex items-center justify-center transition-colors
          ${
            currentPage === totalPages
              ? "opacity-50 cursor-not-allowed"
              : "group hover:bg-blue-200 hover:border-white hover:text-white"
          }
        `}
            >
              <svg
                width="52"
                height="52"
                viewBox="0 0 52 52"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                className={`stroke-current text-[#7E7B7B]
            ${currentPage === totalPages ? "" : "group-hover:text-white"}
          `}
              >
                <circle cx="26" cy="26" r="25.5" strokeWidth="1" />
                <path
                  d="M20.8333 15.334L31.94 23.3873C34.908 25.5407 34.908 26.462 31.94 28.614L20.8333 36.6673"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

export default ViewInvoice;
</file>

<file path="src/pages/settings/CreateNewUser.jsx">
import React, { useState, useEffect, useRef, useContext } from "react";
import { FiChevronDown } from "react-icons/fi";
import { TbDotsVertical } from "react-icons/tb";
import { FiEdit } from "react-icons/fi";
import api from "../../api";
import Swal from "sweetalert2";
import { Country, State, City } from "country-state-city";
import { SidebarContext } from "../../components/Layout";


// Helper to format role names (capitalize, snake_case to space, capitalize after space)
export function formatRoleName(roleName) {
  if (!roleName || typeof roleName !== "string") return roleName;
  return roleName
    .split("_")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(" ");
}

const formatAddress = (address) => {
  try {
    const parsedAddress = JSON.parse(address);

    // Check if all fields are empty
    const allFieldsEmpty =
      !parsedAddress.blockUnitStreetName &&
      !parsedAddress.country &&
      !parsedAddress.state &&
      !parsedAddress.city &&
      !parsedAddress.pincode;

    if (allFieldsEmpty) {
      return null; // Don't show anything if all fields are empty
    }

    // Build address parts array
    const addressParts = [];

    // Add street name if present
    if (
      parsedAddress.blockUnitStreetName &&
      parsedAddress.blockUnitStreetName.trim()
    ) {
      addressParts.push(
        <strong key="street">{parsedAddress.blockUnitStreetName}</strong>
      );
    }

    // Build location line (city, state, country)
    const locationParts = [];
    if (parsedAddress.city && parsedAddress.city.trim()) {
      locationParts.push(parsedAddress.city);
    }
    if (parsedAddress.state && parsedAddress.state.trim()) {
      locationParts.push(parsedAddress.state);
    }
    if (parsedAddress.country && parsedAddress.country.trim()) {
      locationParts.push(parsedAddress.country);
    }

    if (locationParts.length > 0) {
      addressParts.push(<span key="location">{locationParts.join(", ")}</span>);
    }

    // Add pincode if present
    if (parsedAddress.pincode && parsedAddress.pincode.trim()) {
      addressParts.push(<span key="pincode">{parsedAddress.pincode}</span>);
    }

    // If we have any parts, render them
    if (addressParts.length > 0) {
      return (
        <>
          {addressParts.map((part, index) => (
            <React.Fragment key={index}>
              {part}
              {index < addressParts.length - 1 && <br />}
            </React.Fragment>
          ))}
        </>
      );
    }

    return null; // Don't show anything if no valid parts
  } catch (e) {
    // Not a JSON string, or not in the expected format
    // Check if it's a plain string and not empty
    if (
      address &&
      address.trim() &&
      address !== "null" &&
      address !== "undefined"
    ) {
      return address;
    }
    return null; // Don't show anything for invalid/empty addresses
  }
};

// Validation helper for create and edit
function validateUserForm(
  { name, email, password },
  roleObj,
  isCreate = false
) {
  if (!name || name.trim() === "") {
    Swal.fire({
      icon: "error",
      title: "Validation Error",
      text: "Name is required.",
      confirmButtonColor: "#DD6B55",
    });
    return false;
  }
  if (!email || email.trim() === "") {
    Swal.fire({
      icon: "error",
      title: "Validation Error",
      text: "Email is required.",
      confirmButtonColor: "#DD6B55",
    });
    return false;
  }
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    Swal.fire({
      icon: "error",
      title: "Validation Error",
      text: "Please enter a valid email address.",
      confirmButtonColor: "#DD6B55",
    });
    return false;
  }
  if (isCreate && (!password || password.trim() === "")) {
    Swal.fire({
      icon: "error",
      title: "Validation Error",
      text: "Password is required.",
      confirmButtonColor: "#DD6B55",
    });
    return false;
  }
  if (!roleObj) {
    Swal.fire({
      icon: "error",
      title: "Validation Error",
      text: "Please select a Role.",
      confirmButtonColor: "#DD6B55",
    });
    return false;
  }
  return true;
}

const CreateUser = () => {
  // Mobile detection and search state
  const [isMobile, setIsMobile] = useState(() => window.innerWidth < 768);
  const [isSearchExpanded, setIsSearchExpanded] = useState(false);
  const [users, setUsers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [isModalOpenCreate, setIsModalOpenCreate] = useState(false);

  // Search and pagination state
  const [searchTerm, setSearchTerm] = useState("");
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10);

  // New state for dropdown and modal
  const [activeDropdown, setActiveDropdown] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingUser, setEditingUser] = useState(null);
  const [openStatusMenu, setOpenStatusMenu] = useState(null);
  const [showPassword, setShowPassword] = useState(false);
  const [formData, setFormData] = useState({
    name: "",
    email: "",
    phoneno: "",
    is_approved: false,
    blockUnitStreetName: "",
    pincode: "",
    password: "",
  });

  // For create: separate state
  const [createFormData, setCreateFormData] = useState({
    name: "",
    email: "",
    phoneno: "",
    password: "",
    blockUnitStreetName: "",
    pincode: "",
    role: "User", // fixed
    is_approved: false, // if needed
  });

  // New state for create role dropdown
  const [createSelectedRole, setCreateSelectedRole] = useState(null);
  const [createRoleDropdownOpen, setCreateRoleDropdownOpen] = useState(false);
  const [createRoleSearchTerm, setCreateRoleSearchTerm] = useState("");

  // Add state for custom pagination dropdown
  const [isItemsPerPageDropdownOpen, setIsItemsPerPageDropdownOpen] =
    useState(false);
  const itemsPerPageDropdownRef = useRef(null);

  // Address Field States
  const [selectedCountryObj, setSelectedCountryObj] = useState(null);
  const [selectedStateObj, setSelectedStateObj] = useState(null);
  const [selectedCityObj, setSelectedCityObj] = useState(null);
  const [countrySearchTerm, setCountrySearchTerm] = useState("");
  const [stateSearchTerm, setStateSearchTerm] = useState("");
  const [citySearchTerm, setCitySearchTerm] = useState("");
  const [countries, setCountries] = useState([]);
  const [states, setStates] = useState([]);
  const [cities, setCities] = useState([]);
  const [countryDropdownOpen, setCountryDropdownOpen] = useState(false);
  const [stateDropdownOpen, setStateDropdownOpen] = useState(false);
  const [cityDropdownOpen, setCityDropdownOpen] = useState(false);
  // New state for roles
  const [roles, setRoles] = useState([]);
  const [selectedRole, setSelectedRole] = useState(null);
  const [roleDropdownOpen, setRoleDropdownOpen] = useState(false);
  const [roleSearchTerm, setRoleSearchTerm] = useState("");

  const countryDropdownRef = useRef(null);
  const stateDropdownRef = useRef(null);
  const cityDropdownRef = useRef(null);
  const roleDropdownRef = useRef(null);

  // Variables to check disabled state for address fields
  const isStateFieldDisabled = !selectedCountryObj;
  const isCityFieldDisabled = !selectedStateObj;

  useEffect(() => {
    setCountries(Country.getAllCountries());
  }, []);

  // Fetch roles on component mount
  useEffect(() => {
    const fetchRoles = async () => {
      try {
        const response = await api.get("/roles");
        if (response.data.success) {
          setRoles(response.data.data);
        } else {
          console.error("Failed to fetch roles:", response.data.message);
        }
      } catch (err) {
        console.error("Error fetching roles:", err);
      }
    };
    fetchRoles();
  }, []);

  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        countryDropdownRef.current &&
        !countryDropdownRef.current.contains(event.target)
      ) {
        setCountryDropdownOpen(false);
      }
      if (
        stateDropdownRef.current &&
        !stateDropdownRef.current.contains(event.target)
      ) {
        setStateDropdownOpen(false);
      }
      if (
        cityDropdownRef.current &&
        !cityDropdownRef.current.contains(event.target)
      ) {
        setCityDropdownOpen(false);
      }
      if (
        roleDropdownRef.current &&
        !roleDropdownRef.current.contains(event.target)
      ) {
        setRoleDropdownOpen(false);
      }
      if (
        itemsPerPageDropdownRef.current &&
        !itemsPerPageDropdownRef.current.contains(event.target)
      ) {
        setIsItemsPerPageDropdownOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, []);

  useEffect(() => {
    const fetchUsers = async () => {
      try {
        const response = await api.get("/userlist");
        if (response.data.success) {
          setUsers(response.data.result);
        } else {
          setError("Failed to fetch users");
        }
      } catch (err) {
        setError("Error fetching users: " + err.message);
      } finally {
        setLoading(false);
      }
    };

    fetchUsers();
  }, []);

  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth < 768);
      if (window.innerWidth >= 768) {
        setIsSearchExpanded(false);
      }
    };
    checkMobile();
    window.addEventListener("resize", checkMobile);
    return () => window.removeEventListener("resize", checkMobile);
  }, []);

  // Filter users based on search term
  const filteredUsers = users.filter((user) => {
    const searchLower = searchTerm.toLowerCase();
    return (
      user?.name?.toLowerCase()?.includes(searchLower) ||
      user?.email?.toLowerCase()?.includes(searchLower) ||
      user?.phoneno?.toLowerCase()?.includes(searchLower) ||
      user?.address?.toLowerCase()?.includes(searchLower)
    );
  });

  // Open create modal: reset createFormData
  const openCreateModal = () => {
    setEditingUser(null);
    setCreateFormData({
      name: "",
      email: "",
      phoneno: "",
      password: "",
      blockUnitStreetName: "",
      pincode: "",
      role: "User",
      is_approved: false,
    });
    clearAddressFields();
    // Reset create role selection
    setCreateSelectedRole(null);
    setCreateRoleSearchTerm("");
    setCreateRoleDropdownOpen(false);
    setIsModalOpenCreate(true);
  };

  // Function to handle submission of the Create User form:
  const handleCreateSubmit = async (e) => {
    e.preventDefault();

    // Validation
    if (!validateUserForm(createFormData, createSelectedRole, true)) {
      return;
    }

    // Declare loadingAlert outside try block
    let loadingAlert;

    try {
      const payload = {
        name: createFormData.name,
        email: createFormData.email,
        phoneno: createFormData.phoneno,
        password: createFormData.password,
        address: JSON.stringify({
          blockUnitStreetName: createFormData.blockUnitStreetName,
          country: selectedCountryObj?.name || "",
          state: selectedStateObj?.name || "",
          city: selectedCityObj?.name || "",
          pincode: createFormData.pincode,
        }),
        role: createSelectedRole.name,
        role_id: createSelectedRole.id,
      };

      // Show loading state
      loadingAlert = Swal.fire({
        title: "Creating User...",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });
      console.log(payload, "sending this in api");

      const response = await api.post("/users", payload);

      if (response.data.status) {
        const newUser = response.data.result;
        // Update the users list with the new user
        setUsers((prev) => [...prev, newUser]);
        setIsModalOpenCreate(false);

        // Close loading alert
        await loadingAlert.close();

        // Show success message
        await Swal.fire({
          icon: "success",
          title: "User Created Successfully",
          text: `User has been added to the system.`,
          confirmButtonColor: "#2798FF",
        });

        // Reset form data
        setCreateFormData({
          name: "",
          email: "",
          phoneno: "",
          password: "",
          blockUnitStreetName: "",
          pincode: "",
          role: "User",
          is_approved: false,
        });
        clearAddressFields();
        setCreateSelectedRole(null); // Clear selected role after creation
        setCreateRoleSearchTerm(""); // Clear search term after creation

        // Refresh the users list
        const refreshResponse = await api.get("/userlist");
        if (refreshResponse.data.success) {
          setUsers(refreshResponse.data.result);
        }
      } else {
        throw new Error("Failed to create user");
      }
    } catch (err) {
      // Close loading alert if it exists
      if (loadingAlert) {
        await loadingAlert.close();
      }

      let errorTitle = "Error Creating User";
      let errorMessage =
        "An error occurred while creating the user. Please try again.";

      if (err.response) {
        // The request was made and the server responded with a status code
        // that falls out of the range of 2xx
        if (err.response.status === 422) {
          // Validation error
          const errors = err.response.data.errors;
          if (errors) {
            // Get the first error message from any field
            const firstError = Object.values(errors)[0];
            if (Array.isArray(firstError) && firstError.length > 0) {
              errorMessage = firstError[0];
            }
          }
        } else if (err.response.data?.message) {
          // Server returned an error message
          errorMessage = err.response.data.message;
        }
      } else if (err.request) {
        // The request was made but no response was received
        errorTitle = "Network Error";
        errorMessage =
          "Unable to connect to the server. Please check your internet connection.";
      } else {
        // Something happened in setting up the request that triggered an Error
        errorMessage = err.message;
      }

      // Show error message
      await Swal.fire({
        icon: "error",
        title: errorTitle,
        text: errorMessage,
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  // Calculate pagination
  const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const currentUsers = filteredUsers.slice(startIndex, endIndex);

  // Reset to first page when search term changes
  useEffect(() => {
    setCurrentPage(1);
  }, [searchTerm]);

  const handleSearchToggle = () => {
    setIsSearchExpanded(!isSearchExpanded);
  };

  const handleSearchBlur = () => {
    if (isMobile) {
      setIsSearchExpanded(false);
    }
  };

  const handleSearchChange = (e) => {
    setSearchTerm(e.target.value);
  };

  const handlePreviousPage = () => {
    if (currentPage > 1) {
      setCurrentPage(currentPage - 1);
    }
  };

  const handleNextPage = () => {
    if (currentPage < totalPages) {
      setCurrentPage(currentPage + 1);
    }
  };

  const handleItemsPerPageChange = (newItemsPerPage) => {
    setItemsPerPage(newItemsPerPage);
    setCurrentPage(1);
  };

  // New handlers for dropdown and modal
  const toggleDropdown = (userId) => {
    setActiveDropdown(activeDropdown === userId ? null : userId);
  };

  const handleCopyPassword = async (password) => {
    try {
      await navigator.clipboard.writeText(password);
      Swal.fire({
        icon: "success",
        title: "Copied!",
        text: "Password copied to clipboard.",
        showConfirmButton: false,
        timer: 1500,
      });
    } catch (err) {
      Swal.fire({
        icon: "error",
        title: "Copy Failed",
        text: "Failed to copy password.",
      });
    }
  };

  const handleEdit = (user) => {
    clearAddressFields(); // Clear previous selections
    setEditingUser(user);

    // Always hide password when opening edit modal
    setShowPassword(false);

    let parsedAddress = {};
    try {
      parsedAddress = JSON.parse(user.address);
    } catch (e) {
      // If parsing fails, it might be the old plain string format
      parsedAddress.blockUnitStreetName = user.address;
    }

    setFormData({
      name: user.name,
      email: user.email,
      phoneno: user.phoneno,
      is_approved: user.is_approved,
      blockUnitStreetName: parsedAddress.blockUnitStreetName || "",
      pincode: parsedAddress.pincode || "",
      password: user.password || "",
    });

    // Set selected role for editing
    const role = roles.find((r) => r.name === user.role);
    setSelectedRole(role || null);
    setRoleSearchTerm(role?.name || "");

    // Set country, state, city for editing
    const country = countries.find((c) => c.name === parsedAddress.country);
    setSelectedCountryObj(country || null);
    setCountrySearchTerm(country?.name || "");

    if (country) {
      const statesOfCountry = State.getStatesOfCountry(country.isoCode);
      setStates(statesOfCountry);
      const state = statesOfCountry.find((s) => s.name === parsedAddress.state);
      setSelectedStateObj(state || null);
      setStateSearchTerm(state?.name || "");

      if (state) {
        const citiesOfState = City.getCitiesOfState(
          state.countryCode,
          state.isoCode
        );
        setCities(citiesOfState);
        const city = citiesOfState.find((c) => c.name === parsedAddress.city);
        setSelectedCityObj(city || null);
        setCitySearchTerm(city?.name || "");
      } else {
        setCities([]);
        setSelectedCityObj(null);
        setCitySearchTerm("");
      }
    } else {
      setStates([]);
      setCities([]);
      setSelectedStateObj(null);
      setSelectedCityObj(null);
      setStateSearchTerm("");
      setCitySearchTerm("");
    }

    setIsModalOpen(true);
    setActiveDropdown(null);
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData((prev) => ({
      ...prev,
      [name]: name === "is_approved" ? value === "true" : value,
    }));
  };

  // Common input-change handler for edit
  const handleEditInputChange = (e) => {
    const { name, value } = e.target;
    setFormData((prev) => ({
      ...prev,
      [name]: name === "is_approved" ? value === "true" : value,
    }));
  };

  const handleCreateInputChange = (e) => {
    const { name, value } = e.target;
    setCreateFormData((prev) => ({
      ...prev,
      [name]: value,
    }));
  };

  // Handlers for Country, State, City pickers
  const handleCountrySearchChange = (e) => {
    const value = e.target.value;
    setCountrySearchTerm(value);
    setCountryDropdownOpen(true);
    // Clear dependent selections if country changes
    if (value === "") {
      setSelectedCountryObj(null);
      setSelectedStateObj(null);
      setSelectedCityObj(null);
      setStates([]);
      setCities([]);
      setStateSearchTerm("");
      setCitySearchTerm("");
      setFormData((prev) => ({ ...prev, country: "", state: "", city: "" }));
    }
  };

  const handleCountryClear = () => {
    setSelectedCountryObj(null);
    setSelectedStateObj(null);
    setSelectedCityObj(null);
    setStates([]);
    setCities([]);
    setCountrySearchTerm("");
    setStateSearchTerm("");
    setCitySearchTerm("");
    setFormData((prev) => ({ ...prev, country: "", state: "", city: "" }));
    setCreateFormData((prev) => ({
      ...prev,
      country: "",
      state: "",
      city: "",
    }));
  };

  const handleCountrySelect = (country) => {
    setSelectedCountryObj(country);
    setCountrySearchTerm(country.name);
    setCountryDropdownOpen(false);
    setStates(State.getStatesOfCountry(country.isoCode));
    // Clear dependent selections
    setSelectedStateObj(null);
    setSelectedCityObj(null);
    setCities([]);
    setStateSearchTerm("");
    setCitySearchTerm("");
    setFormData((prev) => ({
      ...prev,
      country: country.name,
      state: "",
      city: "",
    }));
  };

  const handleStateSearchChange = (e) => {
    if (!selectedCountryObj) return;
    const value = e.target.value;
    setStateSearchTerm(value);
    setStateDropdownOpen(true);
    // Clear dependent selections if state changes
    if (value === "") {
      setSelectedStateObj(null);
      setSelectedCityObj(null);
      setCities([]);
      setCitySearchTerm("");
      setFormData((prev) => ({ ...prev, state: "", city: "" }));
    }
  };

  const handleStateSelect = (state) => {
    setSelectedStateObj(state);
    setStateSearchTerm(state.name);
    setStateDropdownOpen(false);
    setCities(City.getCitiesOfState(state.countryCode, state.isoCode));
    // Clear dependent selections
    setSelectedCityObj(null);
    setCitySearchTerm("");
    setFormData((prev) => ({ ...prev, state: state.name, city: "" }));
  };

  const handleStateClear = () => {
    setSelectedStateObj(null);
    setSelectedCityObj(null);
    setCities([]);
    setStateSearchTerm("");
    setCitySearchTerm("");
    setFormData((prev) => ({ ...prev, state: "", city: "" }));
    setCreateFormData((prev) => ({ ...prev, state: "", city: "" }));
  };

  const handleCitySearchChange = (e) => {
    if (!selectedStateObj) return;
    const value = e.target.value;
    setCitySearchTerm(value);
    setCityDropdownOpen(true);
    if (value === "") {
      setSelectedCityObj(null);
      setFormData((prev) => ({ ...prev, city: "" }));
    }
  };

  const handleCitySelect = (city) => {
    setSelectedCityObj(city);
    setCitySearchTerm(city.name);
    setCityDropdownOpen(false);
    setFormData((prev) => ({ ...prev, city: city.name }));
  };

  const handleCityClear = () => {
    setSelectedCityObj(null);
    setCitySearchTerm("");
    setFormData((prev) => ({ ...prev, city: "" }));
    setCreateFormData((prev) => ({ ...prev, city: "" }));
  };

  // Helper function to clear address fields
  const clearAddressFields = () => {
    setSelectedCountryObj(null);
    setSelectedStateObj(null);
    setSelectedCityObj(null);
    setStates([]);
    setCities([]);
    setCountrySearchTerm("");
    setStateSearchTerm("");
    setCitySearchTerm("");
    setCountryDropdownOpen(false);
    setStateDropdownOpen(false);
    setCityDropdownOpen(false);
  };

  // DELETE
  const handleDelete = async (id) => {
    const result = await Swal.fire({
      title: "Are you sure?",
      text: "This cannot be undone.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#DD6B55",
      cancelButtonColor: "#aaa",
      confirmButtonText: "Yes, delete it!",
    });
    if (result.isConfirmed) {
      try {
        const response = await api.delete(`/deleteuser/${id}`);
        if (response.data.success) {
          setUsers((prev) => prev.filter((u) => u.id !== id));
          await Swal.fire({
            icon: "success",
            title: "Deleted!",
            text: "User has been removed.",
            confirmButtonColor: "#2798FF",
          });
        } else {
          throw new Error("Server rejected delete");
        }
      } catch (err) {
        Swal.fire({
          icon: "error",
          title: "Delete Failed",
          text: err.message,
          confirmButtonColor: "#DD6B55",
        });
      }
    }
    setOpenStatusMenu(null);
    setActiveDropdown(null);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    // Validation
    if (!validateUserForm(formData, selectedRole, false)) {
      return;
    }
    try {
      const payload = {
        ...formData,
        address: JSON.stringify({
          blockUnitStreetName: formData.blockUnitStreetName,
          country: selectedCountryObj?.name || "",
          state: selectedStateObj?.name || "",
          city: selectedCityObj?.name || "",
          pincode: formData.pincode,
        }),
        role: selectedRole.name,
        role_id: selectedRole.id,
      };
      const response = await api.post(`/updateuser/${editingUser.id}`, payload);
      if (response.data.success) {
        // Update the users list with the edited user
        setUsers(
          users.map((user) =>
            user.id === editingUser.id
              ? {
                  ...user,
                  ...formData,
                  address: payload.address,
                  role: payload.role,
                } // Update address and role
              : user
          )
        );
        setIsModalOpen(false);
        await Swal.fire({
          icon: "success",
          title: "User Updated",
          text: `${formData.name} was successfully updated.`,
          confirmButtonColor: "#2798FF",
        });
      } else {
        setError("Failed to update user");
      }
    } catch (err) {
      setError("Error updating user: " + err.message);
    }
    setOpenStatusMenu(null);
    setActiveDropdown(null);
  };

  const handleStatusToggle = async (user) => {
    const newIsApproved = !user.is_approved;
    try {
      const response = await api.post(`/approval/${user.id}`, {
        is_approved: newIsApproved ? 1 : 0,
      });
      if (response.data.success || response.data.status) {
        setUsers((prev) =>
          prev.map((u) =>
            u.id === user.id ? { ...u, is_approved: newIsApproved } : u
          )
        );
        await Swal.fire({
          icon: "success",
          title: "Status Updated",
          text: `${user.name} is now ${
            newIsApproved ? "Approved" : "Blocked"
          }.`,
          confirmButtonColor: "#2798FF",
        });
      } else {
        throw new Error(
          response.data.message || "Server did not confirm status update"
        );
      }
    } catch (err) {
      Swal.fire({
        icon: "error",
        title: "Failed to update status",
        text: err.message || "An error occurred",
        confirmButtonColor: "#DD6B55",
      });
    }
    setOpenStatusMenu(null);
    setActiveDropdown(null);
  };

  const handleRoleSearchChange = (e) => {
    const value = e.target.value;
    setRoleSearchTerm(value);
    setRoleDropdownOpen(true);
  };

  const handleRoleSelect = (role) => {
    setSelectedRole(role);
    setRoleSearchTerm(role.name);
    setRoleDropdownOpen(false);
  };

  const handleRoleClear = () => {
    setSelectedRole(null);
    setRoleSearchTerm("");
    setRoleDropdownOpen(false);
  };

  // Handlers for Create User Role Dropdown
  const handleCreateRoleSearchChange = (e) => {
    const value = e.target.value;
    setCreateRoleSearchTerm(value);
    setCreateRoleDropdownOpen(true);
  };

  const handleCreateRoleSelect = (role) => {
    setCreateSelectedRole(role);
    setCreateRoleSearchTerm(role.name);
    setCreateRoleDropdownOpen(false);
  };

  const handleCreateRoleClear = () => {
    setCreateSelectedRole(null);
    setCreateRoleSearchTerm("");
    setCreateRoleDropdownOpen(false);
  };

  if (loading) {
    return (
      <div className="w-full min-h-[797px] flex items-center justify-center">
        Loading...
      </div>
    );
  }

  // Consume SidebarContext
  const { isCollapsed } = useContext(SidebarContext);


  return (
    <div

    className={`min-h-[797px] p-4 md:p-6 relative bg-gradient-to-br from-white to-[#E7F4FF] rounded-[10px] shadow-[2px_2px_6px_rgba(24,95,235,0.1)] flex flex-col w-full   ${
        isCollapsed ? "lg:max-w-[85vw] md:w-[85vw]" : "lg:max-w-[78vw] md:w-[80vw]"
      } md:mx-auto  `}
    >


      {/* Header Section */}
      <div className="flex flex-wrap items-center justify-between gap-4 mb-8">
        {/* Title */}
        <h1 className="text-[20px] md:text-[22px] font-medium text-[#1F2837] whitespace-nowrap">
          Create New User
        </h1>

        {/* Search Container */}
        <div className="flex-1 max-w-[400px] mx-1">
          {isMobile && !isSearchExpanded ? (
            <button
              onClick={handleSearchToggle}
              className="
          w-10 h-10
          flex items-center
          rounded-[6px]
          hover:bg-gray-50 transition-colors
        "
            >
              {/* search icon SVG */}
              <svg
                width="20"
                height="20"
                viewBox="0 0 22 22"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M10.5417 19.25C15.3512 19.25 19.25 15.3512 19.25 10.5417C19.25 5.73223 15.3512 1.83334 10.5417 1.83334C5.73223 1.83334 1.83334 5.73223 1.33334 10.5417C1.83334 15.3512 5.73223 19.25 10.5417 19.25Z"
                  stroke="#787374"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M18.3333 18.3333L20.1667 20.1667"
                  stroke="#787374"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>
          ) : (
            <div className="relative w-full">
              {/* Search icon inside input */}
              <div className="absolute left-4 top-1/2 -translate-y-1/2 pointer-events-none">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 22 22"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M10.5417 19.25C15.3512 19.25 19.25 15.3512 19.25 10.5417C19.25 5.73223 15.3512 1.83334 10.5417 1.83334C5.73223 1.83334 1.83334 5.73223 1.33334 10.5417C1.83334 15.3512 5.73223 19.25 10.5417 19.25Z"
                    stroke="#787374"
                    strokeWidth="1.5"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                  <path
                    d="M18.3333 18.3333L20.1667 20.1667"
                    stroke="#787374"
                    strokeWidth="1.5"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                </svg>
              </div>
              <input
                type="search"
                placeholder={isMobile ? "Search" : "Search by Name, Contact"}
                value={searchTerm}
                onChange={handleSearchChange}
                className="
            w-full
            h-[44px]
            pl-12 pr-4
            bg-[#E9F1F9]
            rounded-[6px]
            text-[#787374] placeholder-[#787374]
            focus:outline-none
            text-sm md:text-base
          "
                onBlur={handleSearchBlur}
                autoFocus={isMobile && isSearchExpanded}
              />
            </div>
          )}
        </div>

        {/* Actions: Create User + Display Dropdown */}
        <div className="flex items-center gap-3 md:gap-4">
          <button
            className=" hover:bg-blue-500
        bg-[#ef7e1b] text-white
        h-[44px] px-5
        rounded-[8px]
        flex items-center justify-center
        cursor-pointer
      "
            onClick={openCreateModal}
          >
            Create User
          </button>
          <span className="text-[#727A90] text-sm md:text-base lg:text-base whitespace-nowrap">
            Show
          </span>
          {/* Items per page custom dropdown */}
          <div className="relative min-w-[88px]" ref={itemsPerPageDropdownRef}>
            <button
              type="button"
              className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full min-w-[72px] md:min-w-[88px] lg:min-w-[88px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center"
              onClick={() => setIsItemsPerPageDropdownOpen((open) => !open)}
            >
              <span className="truncate text-left flex-1">{itemsPerPage}</span>
              <img
                src="/caret-down.svg"
                alt=""
                aria-hidden="true"
                className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
              />
            </button>
            {isItemsPerPageDropdownOpen && (
              <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
                {[5, 10, 20, 50].map((option) => (
                  <button
                    key={option}
                    type="button"
                    onClick={() => {
                      handleItemsPerPageChange(option);
                      setIsItemsPerPageDropdownOpen(false);
                    }}
                    className={`w-full px-3 py-2 text-left hover:bg-[#E7EFF8] ${
                      itemsPerPage === option
                        ? "bg-[#E7EFF8] font-bold text-[#ef7e1b]"
                        : "text-[#545454]"
                    }`}
                  >
                    {option}
                  </button>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Search Results Info */}
      {searchTerm && (
        <div className="mb-4 text-sm text-[#4B5563]">
          Showing {filteredUsers.length} results for "{searchTerm}"
        </div>
      )}

      {/* User List Table */}
      <div className="hidden md:block w-full flex-grow overflow-y-hidden  custom-scrollbar pb-11">
        <table className="w-full min-w-[1000px] border-collapse">
          <thead>
            <tr className="text-left text-[#4B5563]">
              <th className="py-4 px-6 font-medium text-sm">Name</th>
              <th className="py-4 px-6 font-medium text-sm">Email</th>
              <th className="py-4 px-6 font-medium text-sm">Role</th>
              <th className="py-4 px-6 font-medium text-sm">Address</th>
              <th className="py-4 px-6 font-medium text-sm whitespace-nowrap">Contact Number</th>
              <th className="py-4 px-6 font-medium text-sm">Status</th>
              <th className="py-4 px-6 font-medium text-sm">Actions</th>
            </tr>
          </thead>
          <tbody className="">
            {currentUsers.length === 0 ? (
              <tr>
                <td
                  colSpan="6"
                  className="py-8 px-6 text-center text-[#4B5563]"
                >
                  {searchTerm
                    ? "No users found matching your search."
                    : "No users available."}
                </td>
              </tr>
            ) : (
              currentUsers.map((user) => {
                const isStatusMenuOpen = openStatusMenu === user.id;

                return (
                  <tr key={user.id} className="border-t border-[#E5E7EB]">
                    <td className="py-4 px-6 text-sm text-[#4B5563]">
                      {user.name}
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563]">
                      {user.email}
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563]">
                      {formatRoleName(user.role)}
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563]">
                      {formatAddress(user.address)}
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563]">
                      {user.phoneno}
                    </td>
                    <td className="py-4 px-6 ">
                      <div className="relative inline-block group">
                        {/* Status Badge with improved styling */}
                        <div
                          className="flex items-center gap-2"
                          onClick={
                            isMobile
                              ? () =>
                                  setOpenStatusMenu(
                                    isStatusMenuOpen ? null : user.id
                                  )
                              : undefined
                          }
                        >
                          <span
                            className={`
                              px-3 py-1 rounded-lg text-sm
                              flex items-center gap-2 transition-all duration-200
                              cursor-pointer select-none
                              ${
                                user.is_approved
                                  ? "bg-[#27AE60] text-white"
                                  : "bg-[#ef7e1b] text-white"
                              }
                              hover:scale-105 transform
                            `}
                          >
                            {user.is_approved ? "Approved" : "Blocked"}

                            {/* Dropdown arrow */}
                            <svg
                              className={`w-3 h-3 ml-1 transition-transform duration-200 ${
                                isMobile
                                  ? isStatusMenuOpen
                                    ? "rotate-180"
                                    : ""
                                  : "group-hover:rotate-180"
                              }`}
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth={2}
                                d="M19 9l-7 7-7-7"
                              />
                            </svg>
                          </span>
                        </div>

                        {/* Common Dropdown for both mobile and desktop */}
                        <div
                          className={`
                            absolute left-0 top-full mt-2 z-50
                            transition-all duration-200 ease-out
                            ${
                              isMobile
                                ? isStatusMenuOpen
                                  ? "opacity-100 visible translate-y-0"
                                  : "opacity-0 invisible translate-y-2"
                                : `opacity-0 invisible group-hover:opacity-100 group-hover:visible
                                   transform translate-y-2 group-hover:translate-y-0`
                            }
                          `}
                        >
                          <button
                            onClick={() => handleStatusToggle(user)}
                            className="
                              whitespace-nowrap cursor-pointer
                              bg-white border border-gray-200/60
                              text-gray-700 text-sm font-medium
                              px-4 py-3 rounded-xl shadow-xl
                              hover:bg-gray-50 hover:border-gray-300
                              hover:shadow-2xl hover:scale-105
                              transition-all duration-200
                              backdrop-blur-sm
                              flex items-center gap-2
                              min-w-max
                            "
                          >
                            {/* Action icon */}
                            <div
                              className={`
                                w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold
                                ${
                                  user.is_approved
                                    ? "bg-blue-100 text-blue-600"
                                    : "bg-green-100 text-green-600"
                                }
                              `}
                            >
                              {user.is_approved ? "P" : "A"}
                            </div>

                            <span className="text-xs">
                              {user.is_approved
                                ? "Change to Blocked"
                                : "Change to Approved"}
                            </span>

                            {/* Arrow indicator */}
                            <svg
                              className="w-3 h-3 opacity-60"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth={2}
                                d="M9 5l7 7-7 7"
                              />
                            </svg>
                          </button>

                          {/* Dropdown arrow pointer */}
                          <div className="absolute -top-1 left-4 w-2 h-2 bg-white border-l border-t border-gray-200/60 rotate-45 z-40"></div>
                        </div>
                      </div>
                    </td>
                    <td className="py-4 px-6 relative">
                      <button
                        onClick={() => toggleDropdown(user.id)}
                        className="p-2 text-[#4B5563] hover:bg-blue-200 hover:text-white rounded-full transition-colors cursor-pointer"
                      >
                        <TbDotsVertical className="w-4 h-4" />
                      </button>
                      {activeDropdown === user.id && (
                        <div className="relative">
                          {/* Trigger, etc. */}
                          <div className="absolute -left-4 w-24 rounded-md shadow-md bg-gradient-to-br from-white to-[#E7F4FF] z-10 overflow-hidden">
                            <div className="">
                              {/* EDIT button */}
                              <button
                                onClick={() => handleEdit(user)}
                                className="group flex items-center px-2 py-1 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors first:rounded-t-md cursor-pointer"
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="24"
                                  height="24"
                                  viewBox="0 0 24 24"
                                  className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors cursor-pointer"
                                >
                                  <path
                                    fill="currentColor"
                                    d="M4 14v-2h7v2zm0-4V8h11v2zm0-4V4h11v2zm9 14v-3.075l6.575-6.55l3.075 3.05L16.075 20zm7.5-6.575l-.925-.925zm-6 5.075h.95l3.025-3.05l-.45-.475l-.475-.45l-3.05 3.025zm3.525-3.525l-.475-.45l.925.925z"
                                  />
                                </svg>
                                <span className="group-hover:text-white transition-colors cursor-pointer">
                                  Edit
                                </span>
                              </button>

                              {/* Tapered separator (geometric taper) */}
                              <svg
                                className="w-full h-[1px]" // adjust h-1 or h-2 as needed
                                viewBox="0 0 100 1"
                                preserveAspectRatio="none"
                                xmlns="http://www.w3.org/2000/svg"
                              >
                                <polygon
                                  points="0,0 50,1 100,0"
                                  fill="#E5E7EB"
                                />
                              </svg>

                              {/* DELETE button */}
                              <button
                                onClick={() => handleDelete(user.id)}
                                className="group flex items-center px-2 py-1 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors last:rounded-b-md cursor-pointer"
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="24"
                                  height="24"
                                  viewBox="0 0 24 24"
                                  className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors cursor-pointer"
                                >
                                  <path
                                    fill="currentColor"
                                    d="M7.616 20q-.672 0-1.144-.472T6 18.385V6H5V5h4v-.77h6V5h4v1h-1v12.385q0 .69-.462 1.153T16.384 20zM17 6H7v12.385q0 .269.173.442t.443.173h8.769q.23 0 .423-.192t.192-.424zM9.808 17h1V8h-1zm3.384 0h1V8h-1zM7 6v13z"
                                  />
                                </svg>
                                <span className="group-hover:text-white transition-colors cursor-pointer">
                                  Delete
                                </span>
                              </button>
                            </div>
                          </div>
                        </div>
                      )}
                    </td>
                  </tr>
                );
              })
            )}
          </tbody>
        </table>
      </div>

      {/* User List Cards for Mobile */}
      <div className="md:hidden w-full space-y-4 pb-24 flex-grow">
        {currentUsers.length === 0 ? (
          <div className="py-8 px-6 text-center text-[#4B5563]">
            {searchTerm
              ? "No users found matching your search."
              : "No users available."}
          </div>
        ) : (
          currentUsers.map((user) => {
            const isStatusMenuOpen = openStatusMenu === user.id;
            return (
              <div
                key={user.id}
                className=" rounded-lg shadow p-4 border border-gray-200/80"
              >
                <div className="flex justify-between items-start">
                  <div className="space-y-1 pr-2">
                    <p className="font-bold text-lg text-[#1F2837]">
                      {user.name}
                    </p>
                    <p className="text-sm text-gray-500 break-all">
                      {user.email}
                    </p>
                    <p className="text-sm text-gray-700">
                      <span className="font-medium">Role: </span>
                      {formatRoleName(user.role)}
                    </p>
                  </div>
                  {/* Actions button */}
                  <div className="relative">
                    <button
                      onClick={() => toggleDropdown(user.id)}
                      className="p-2 text-[#4B5563] rounded-full hover:bg-gray-100 cursor-pointer"
                    >
                      <TbDotsVertical className="w-5 h-5" />
                    </button>
                    {activeDropdown === user.id && (
                      <div className="absolute right-0 mt-1 w-28 rounded-md shadow-md bg-gradient-to-br from-white to-[#E7F4FF] z-20 overflow-hidden">
                        <div>
                          {/* EDIT button */}
                          <button
                            onClick={() => handleEdit(user)}
                            className="group flex items-center px-3 py-2 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors first:rounded-t-md cursor-pointer"
                          >
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              width="24"
                              height="24"
                              viewBox="0 0 24 24"
                              className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors cursor-pointer"
                            >
                              <path
                                fill="currentColor"
                                d="M4 14v-2h7v2zm0-4V8h11v2zm0-4V4h11v2zm9 14v-3.075l6.575-6.55l3.075 3.05L16.075 20zm7.5-6.575l-.925-.925zm-6 5.075h.95l3.025-3.05l-.45-.475l-.475-.45l-3.05 3.025zm3.525-3.525l-.475-.45l.925.925z"
                              />
                            </svg>
                            <span className="group-hover:text-white transition-colors cursor-pointer">
                              Edit
                            </span>
                          </button>

                          {/* Tapered separator */}
                          <svg
                            className="w-full h-[1px]"
                            viewBox="0 0 100 1"
                            preserveAspectRatio="none"
                            xmlns="http://www.w3.org/2000/svg"
                          >
                            <polygon points="0,0 50,1 100,0" fill="#E5E7EB" />
                          </svg>

                          {/* DELETE button */}
                          <button
                            onClick={() => handleDelete(user.id)}
                            className="group flex items-center px-3 py-2 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors last:rounded-b-md cursor-pointer"
                          >
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              width="24"
                              height="24"
                              viewBox="0 0 24 24"
                              className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors cursor-pointer"
                            >
                              <path
                                fill="currentColor"
                                d="M7.616 20q-.672 0-1.144-.472T6 18.385V6H5V5h4v-.77h6V5h4v1h-1v12.385q0 .69-.462 1.153T16.384 20zM17 6H7v12.385q0 .269.173.442t.443.173h8.769q.23 0 .423-.192t.192-.424zM9.808 17h1V8h-1zm3.384 0h1V8h-1zM7 6v13z"
                              />
                            </svg>
                            <span className="group-hover:text-white transition-colors cursor-pointer">
                              Delete
                            </span>
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
                <div className="mt-4 space-y-3 text-sm">
                  <div>
                    <span className="font-medium text-gray-600">Address: </span>
                    <span className="text-gray-800">
                      {formatAddress(user.address)}
                    </span>
                  </div>
                  <div>
                    <span className="font-medium text-gray-600">Contact: </span>
                    <span className="text-gray-800">{user.phoneno}</span>
                  </div>
                </div>
                <div className="mt-4 pt-4 border-t border-gray-200/80 flex justify-between items-center">
                  <span className="text-sm font-medium text-gray-600">
                    Status
                  </span>
                  {/* Status Dropdown */}
                  <div className="relative inline-block">
                    <div
                      className="flex items-center gap-2 cursor-pointer"
                      onClick={() =>
                        setOpenStatusMenu(isStatusMenuOpen ? null : user.id)
                      }
                    >
                      <span
                        className={`
                          px-3 py-1 rounded-lg text-sm
                          flex items-center gap-2 transition-all duration-200
                          select-none
                          ${
                            user.is_approved
                              ? "bg-[#27AE60] text-white"
                              : "bg-[#ef7e1b] text-white"
                          }
                        `}
                      >
                        {user.is_approved ? "Approved" : "Blocked"}
                        <svg
                          className={`w-3 h-3 ml-1 transition-transform duration-200 ${
                            isStatusMenuOpen ? "rotate-180" : ""
                          }`}
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M19 9l-7 7-7-7"
                          />
                        </svg>
                      </span>
                    </div>

                    <div
                      className={`
                        absolute right-0 top-full mt-2 z-50
                        transition-all duration-200 ease-out
                        ${
                          isStatusMenuOpen
                            ? "opacity-100 visible translate-y-0"
                            : "opacity-0 invisible -translate-y-2"
                        }
                      `}
                    >
                      <button
                        onClick={() => handleStatusToggle(user)}
                        className="
                          whitespace-nowrap cursor-pointer
                          bg-white border border-gray-200/60
                          text-gray-700 text-sm font-medium
                          px-4 py-3 rounded-xl shadow-xl
                          hover:bg-gray-50
                          transition-all duration-200
                          flex items-center gap-2
                          min-w-max
                        "
                      >
                        <div
                          className={`
                            w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold
                            ${
                              user.is_approved
                                ? "bg-blue-100 text-blue-600"
                                : "bg-green-100 text-green-600"
                            }
                          `}
                        >
                          {user.is_approved ? "P" : "A"}
                        </div>
                        <span className="text-xs">
                          {user.is_approved
                            ? "Change to Blocked"
                            : "Change to Approved"}
                        </span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          })
        )}
      </div>

      {/* Edit Modal */}
      {isModalOpen && (
        <div className="fixed inset-0 flex items-center justify-center z-50">
          {/* Frosted overlay */}
          <div
            className="absolute inset-0 bg-gray-50/10 backdrop-blur-sm border border-white/30"
            onClick={() => {
              setIsModalOpen(false);
              clearAddressFields();
            }}
          />

          {/* Glassmorphism modal container */}
          <div
            className="
    w-11/12 max-w-[800px] max-h-[90vh] overflow-y-auto p-6 md:p-8
    rounded-2xl
    bg-gradient-to-br from-[#FFFFFF] to-[#E6F4FF]
    shadow-lg
    relative z-10
  "
          >
            {/* Close button */}
            <button
              onClick={() => {
                setIsModalOpen(false);
                clearAddressFields();
              }}
              className="absolute top-6 right-6 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors cursor-pointer"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13 1L1 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M1 1L13 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Modal title */}
            <h2 className="text-[29px] font-medium text-[#1F2837] mb-8">
              Edit User
            </h2>

            {/* Form grid */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
              {/* Customer Name */}
              <div className="space-y-2 md:col-start-1 md:row-start-1">
                <label className="block text-[#4B5563] text-[16px] mb-2">
                  Name
                </label>
                <div className="relative">
                  <input
                    type="text"
                    name="name"
                    value={formData.name}
                    onChange={handleInputChange}
                    className="
          w-full h-[48px] px-3 rounded-[12px]
          bg-[#E7EFF8] border border-white/20
          focus:ring-2 focus:ring-[#0e4053] outline-none
          text-[#545454] placeholder-[#545454]
        "
                  />
                  <button className="absolute right-3 top-1/2 -translate-y-1/2 cursor-pointer">
                    <FiEdit className="w-5 h-5 text-gray-500" />
                  </button>
                </div>
              </div>

              {/* Contact (Phone Number) */}
              <div className="space-y-2 md:col-start-2 md:row-start-1">
                <label className="block text-[#4B5563] text-[16px] mb-2">
                  Contact
                </label>
                <input
                  type="text"
                  name="phoneno"
                  value={formData.phoneno}
                  onChange={handleInputChange}
                  className="
        w-full h-[48px] px-3 rounded-[12px]
        bg-[#E7EFF8] border border-white/20
        focus:ring-2 focus:ring-[#0e4053] outline-none
        text-[#545454] placeholder-[#545454]
      "
                />
              </div>

              {/* Address */}
              <div className="space-y-1 md:col-span-2 md:row-start-2">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Address
                </label>
                <div className="w-full rounded-[12px] border border-white/20 flex flex-col">
                  <input
                    type="text"
                    name="blockUnitStreetName"
                    value={formData.blockUnitStreetName}
                    onChange={handleInputChange}
                    className="w-full h-[44px] px-3 flex items-center text-[#545454] bg-[#E7EFF8]/60 border-t border-r border-l border-white/20 outline-none rounded-t-[12px]"
                    placeholder="Block/Unit/Street Name"
                  />
                  <div className="grid grid-cols-2 w-full">
                    {/* State Dropdown */}
                    <div className="relative" ref={stateDropdownRef}>
                      <input
                        type="text"
                        value={stateSearchTerm}
                        onChange={handleStateSearchChange}
                        onFocus={() =>
                          selectedCountryObj && setStateDropdownOpen(true)
                        }
                        placeholder="Select State"
                        className={`w-full h-[44px] px-4 bg-[#E7EFF8]/60 border border-white/20 border-t-0 border-r outline-none text-[#545454] placeholder-[#545454] text-[16px] ${
                          isStateFieldDisabled
                            ? "bg-gray-300 cursor-not-allowed opacity-60"
                            : ""
                        }`}
                        disabled={isStateFieldDisabled}
                        readOnly={isStateFieldDisabled}
                        autoComplete="off"
                      />
                      {stateDropdownOpen && !isStateFieldDisabled && (
                        <div className="absolute z-10 custom-scrollbar w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                          {states
                            .filter((state) =>
                              state.name
                                .toLowerCase()
                                .includes(stateSearchTerm.toLowerCase())
                            )
                            .map((state) => (
                              <div
                                key={state.isoCode}
                                onClick={() => handleStateSelect(state)}
                                className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                onMouseDown={(e) => e.preventDefault()}
                              >
                                {state.name}
                              </div>
                            ))}
                        </div>
                      )}
                    </div>
                    {/* City Dropdown */}
                    <div className="relative" ref={cityDropdownRef}>
                      <input
                        type="text"
                        value={citySearchTerm}
                        onChange={handleCitySearchChange}
                        onFocus={() =>
                          selectedStateObj && setCityDropdownOpen(true)
                        }
                        placeholder="Select City"
                        className={`w-full h-[44px] px-4 bg-[#E7EFF8]/60 border border-white/20 border-t-0 outline-none text-[#545454] placeholder-[#545454] text-[16px] ${
                          isCityFieldDisabled
                            ? "bg-gray-300 cursor-not-allowed opacity-60"
                            : ""
                        }`}
                        disabled={isCityFieldDisabled}
                        readOnly={isCityFieldDisabled}
                        autoComplete="off"
                      />
                      {cityDropdownOpen && !isCityFieldDisabled && (
                        <div className="absolute z-10 custom-scrollbar w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                          {cities
                            .filter((city) =>
                              city.name
                                .toLowerCase()
                                .includes(citySearchTerm.toLowerCase())
                            )
                            .map((city) => (
                              <div
                                key={city.name}
                                onClick={() => handleCitySelect(city)}
                                className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                onMouseDown={(e) => e.preventDefault()}
                              >
                                {city.name}
                              </div>
                            ))}
                        </div>
                      )}
                    </div>
                  </div>
                  <div className="grid grid-cols-2 w-full">
                    {/* Pincode Input */}
                    <input
                      type="text"
                      name="pincode"
                      value={formData.pincode}
                      onChange={handleInputChange}
                      className="w-full h-[44px] px-3 flex items-center text-[#545454] bg-[#E7EFF8]/60 border border-white/20 border-t-0 border-r rounded-bl-[12px] outline-none"
                      placeholder="Pincode"
                    />
                    {/* Country Dropdown */}
                    <div className="relative" ref={countryDropdownRef}>
                      <input
                        type="text"
                        value={countrySearchTerm}
                        onChange={handleCountrySearchChange}
                        onFocus={() => setCountryDropdownOpen(true)}
                        placeholder="Select Country"
                        className="w-full h-[44px] px-4 bg-[#E7EFF8]/60 border border-white/20 border-t-0 rounded-br-[12px] outline-none text-[#545454] placeholder-[#545454] text-[16px]"
                        autoComplete="off"
                      />
                      {countryDropdownOpen && (
                        <div className="absolute z-10 custom-scrollbar w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                          {countries
                            .filter((country) =>
                              country.name
                                .toLowerCase()
                                .includes(countrySearchTerm.toLowerCase())
                            )
                            .map((country) => (
                              <div
                                key={country.isoCode}
                                onClick={() => handleCountrySelect(country)}
                                className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                onMouseDown={(e) => e.preventDefault()}
                              >
                                {country.name}
                              </div>
                            ))}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>

              {/* Email */}
              <div className="space-y-2 md:col-start-1 md:row-start-4 ">
                <label className="block text-[#4B5563] text-[16px] mb-2">
                  Email
                </label>
                <input
                  type="email"
                  name="email"
                  value={formData.email}
                  onChange={handleInputChange}
                  className="
        w-full h-[48px] px-3 rounded-[12px]
        bg-[#E7EFF8] border border-white/20
        focus:ring-2 focus:ring-[#0e4053] outline-none
        text-[#545454] placeholder-[#545454]
      "
                />
              </div>

              {/* Role Dropdown (new) */}
              <div
                className="space-y-2 md:col-span-2 md:row-start-3 relative"
                ref={roleDropdownRef}
              >
                <label className="block text-[#4B5563] text-[16px] mb-2">
                  Role
                </label>
                <div className="relative">
                  <button
                    type="button"
                    className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] text-left flex items-center justify-between cursor-pointer"
                    onClick={() => setRoleDropdownOpen((open) => !open)}
                  >
                    <span>
                      {selectedRole
                        ? formatRoleName(selectedRole.name)
                        : "Select Role"}
                    </span>
                    <svg
                      className={`w-4 h-4 transition-transform ${
                        roleDropdownOpen ? "rotate-180" : ""
                      }`}
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M19 9l-7 7-7-7"
                      />
                    </svg>
                  </button>
                  {roleDropdownOpen && (
                    <div className="absolute custom-scrollbar top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto">
                      {roles.map((role) => (
                        <button
                          type="button"
                          key={role.id}
                          className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                          onClick={() => {
                            setSelectedRole(role);
                            setRoleDropdownOpen(false);
                          }}
                        >
                          {formatRoleName(role.name)}
                        </button>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              {/* Password field */}
              <div className="space-y-2 md:col-start-2 md:row-start-4">
                <label className="block text-[#4B5563] text-[16px] mb-2">
                  Password
                </label>
                <div className="relative flex items-center">
                  <input
                    type={showPassword ? "text" : "password"}
                    name="password"
                    value={formData.password}
                    onChange={handleInputChange}
                    className="
                      w-full h-[48px] px-3 rounded-[12px]
                      bg-[#E7EFF8] border border-white/20
                      focus:ring-2 focus:ring-[#0e4053] outline-none
                      text-[#545454] placeholder-[#545454]
                    "
                    placeholder="Enter new password to change"
                  />
                  <button
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute right-12 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 cursor-pointer"
                  >
                    {showPassword ? (
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        className="bg-[#E7EFF8]"
                      >
                        <path
                          fill="currentColor"
                          d="M6 23H3q-.825 0-1.412-.587T1 21v-3h2v3h3zm12 0v-2h3v-3h2v3q0 .825-.587 1.413T21 23zm-6-4.5q-3 0-5.437-1.775T3 12q1.125-2.95 3.563-4.725T12 5.5t5.438 1.775T21 12q-1.125 2.95-3.562 4.725T12 18.5m0-2q2.2 0 4.025-1.2t2.8-3.3q-.975-2.1-2.8-3.3T12 7.5T7.975 8.7t-2.8 3.3q.975 2.1 2.8 3.3T12 16.5m0-1q1.45 0 2.475-1.025T15.5 12t-1.025-2.475T12 8.5T9.525 9.525T8.5 12t1.025 2.475T12 15.5m0-2q-.625 0-1.063-.437T10.5 12t.438-1.062T12 10.5t1.063.438T13.5 12t-.437 1.063T12 13.5M1 6V3q0-.825.588-1.412T3 1h3v2H3v3zm20 0V3h-3V1h3q.825 0 1.413.588T23 3v3zm-9 6"
                        />
                      </svg>
                    ) : (
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        strokeWidth="1.5"
                        stroke="currentColor"
                        className="w-5 h-5 cursor-pointer"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"
                        />
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                        />
                      </svg>
                    )}
                  </button>
                  <button
                    type="button"
                    onClick={() => handleCopyPassword(formData.password)}
                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 cursor-pointer"
                    title="Copy password to clipboard"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      className="bg-[#E7EFF8] cursor-pointer"
                    >
                      <path
                        fill="currentColor"
                        d="M9 18q-.825 0-1.412-.587T7 16V4q0-.825.588-1.412T9 2h9q.825 0 1.413.588T20 4v12q0 .825-.587 1.413T18 18zm0-2h9V4H9zm-4 6q-.825 0-1.412-.587T3 20V6h2v14h11v2zm4-6V4z"
                      />
                    </svg>
                  </button>
                </div>
                <div className="flex justify-end gap-2 ">
                  <button
                    type="button"
                    onClick={async () => {
                      if (!formData.password) {
                        Swal.fire({
                          icon: "error",
                          title: "Error",
                          text: "Please enter a new password.",
                          confirmButtonColor: "#DD6B55",
                        });
                        return;
                      }

                      const result = await Swal.fire({
                        title: "Are you sure?",
                        text: "This will change the user's password.",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#2798FF",
                        cancelButtonColor: "#aaa",
                        confirmButtonText: "Yes, change it!",
                      });

                      if (result.isConfirmed) {
                        try {
                          const response = await api.post(
                            `/updatepassword/${editingUser.id}`,
                            {
                              password: formData.password,
                            }
                          );
                          if (response.data.success) {
                            Swal.fire({
                              icon: "success",
                              title: "Password Changed",
                              text: "User password has been updated.",
                              confirmButtonColor: "#2798FF",
                            });
                          } else {
                            throw new Error(
                              response.data.message ||
                                "Failed to change password"
                            );
                          }
                        } catch (err) {
                          Swal.fire({
                            icon: "error",
                            title: "Error Changing Password",
                            text:
                              err.response?.data?.message ||
                              err.message ||
                              "An error occurred.",
                            confirmButtonColor: "#DD6B55",
                          });
                        }
                      }
                    }}
                    className="text-[10px] text-[#ef7e1b] hover:underline cursor-pointer  flex whitespace-nowrap cursor-pointer"
                  >
                    Click to change user's password{" "}
                  </button>
                  <p className="text-[10px] text-[#545454] whitespace-nowrap cursor-pointer">
                    {/* Note: User will be logged out */}
                  </p>
                </div>
              </div>
            </div>

            {/* Save button */}
            <div className="mt-10 flex justify-center">
              <button
                type="submit"
                onClick={handleSubmit}
                className="w-[207px] h-[46px] bg-[#ef7e1b] text-white rounded-[10px] hover:bg-[#ee7f1b] transition-colors cursor-pointer"
              >
                Save
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Create Modal */}

      {isModalOpenCreate && (
        <div className="fixed inset-0 flex items-center justify-center z-50">
          {/* Frosted overlay */}
          <div
            className="absolute inset-0 bg-gray-50/10 backdrop-blur-sm border border-white/30"
            onClick={() => {
              setIsModalOpenCreate(false);
              clearAddressFields();
            }}
          />

          {/* Glassmorphism modal container */}
          <div
            className="
    w-11/12 max-w-[800px] max-h-[90vh] overflow-y-auto p-6 md:p-8
    rounded-2xl
    bg-gradient-to-br from-[#FFFFFF] to-[#E6F4FF]
    shadow-lg
    relative z-10
  "
          >
            {/* Close button */}
            <button
              onClick={() => {
                setIsModalOpenCreate(false);
                clearAddressFields();
              }}
              className="absolute top-6 right-6 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors cursor-pointer"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13 1L1 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M1 1L13 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Modal title */}
            <h2 className="text-[29px] font-medium text-[#1F2837] mb-8">
              Create User
            </h2>

            {/* Form grid */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
              {/* Customer Name */}
              <div className="space-y-2 md:col-start-1 md:row-start-1">
                <label className="block text-[#4B5563] text-[16px] mb-2">
                  Name
                </label>
                <div className="relative">
                  <input
                    type="text"
                    name="name"
                    value={createFormData.name}
                    onChange={handleCreateInputChange}
                    className="
          w-full h-[48px] px-3 rounded-[12px]
          bg-[#E7EFF8] border border-white/20
          focus:ring-2 focus:ring-[#0e4053] outline-none
          text-[#545454] placeholder-[#545454]
        "
                    required
                  />
                  <button
                    type="button"
                    className="absolute right-3 top-1/2 -translate-y-1/2 cursor-pointer"
                  >
                    <FiEdit className="w-5 h-5 text-gray-500" />
                  </button>
                </div>
              </div>

              {/* Contact (Phone Number) */}
              <div className="space-y-2 md:col-start-2 md:row-start-1">
                <label className="block text-[#4B5563] text-[16px] mb-2">
                  Contact
                </label>
                <input
                  type="text"
                  name="phoneno"
                  value={createFormData.phoneno}
                  onChange={handleCreateInputChange}
                  className="
        w-full h-[48px] px-3 rounded-[12px]
        bg-[#E7EFF8] border border-white/20
        focus:ring-2 focus:ring-[#0e4053] outline-none
        text-[#545454] placeholder-[#545454]
      "
                  required
                />
              </div>

              {/* Address */}
              <div className="space-y-1 md:col-span-2 md:row-start-2">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Address
                </label>
                <div className="w-full rounded-[12px] border border-white/20 flex flex-col">
                  <input
                    type="text"
                    name="blockUnitStreetName"
                    value={createFormData.blockUnitStreetName}
                    onChange={handleCreateInputChange}
                    className="w-full h-[44px] px-3 flex items-center text-[#545454] bg-[#E7EFF8]/60 border-t border-r border-l border-white/20 outline-none rounded-t-[12px]"
                    placeholder="Block/Unit/Street Name"
                    required
                  />

                  {/* State and City Dropdowns */}
                  <div className="grid grid-cols-2 w-full">
                    {/* State Dropdown */}
                    <div className="relative" ref={stateDropdownRef}>
                      <input
                        type="text"
                        value={stateSearchTerm}
                        onChange={handleStateSearchChange}
                        onFocus={() =>
                          selectedCountryObj && setStateDropdownOpen(true)
                        }
                        placeholder="Select State"
                        className={`w-full h-[44px] px-4 bg-[#E7EFF8]/60 border border-white/20 border-t-0 border-r outline-none text-[#545454] placeholder-[#545454] text-[16px] ${
                          !selectedCountryObj
                            ? "bg-gray-300 cursor-not-allowed opacity-60"
                            : ""
                        }`}
                        disabled={!selectedCountryObj}
                        readOnly={!selectedCountryObj}
                        autoComplete="off"
                      />
                      {stateDropdownOpen && (
                        <div className="absolute z-10 custom-scrollbar w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                          {states
                            .filter((state) =>
                              state.name
                                .toLowerCase()
                                .includes(stateSearchTerm.toLowerCase())
                            )
                            .map((state) => (
                              <div
                                key={state.isoCode}
                                onClick={() => handleStateSelect(state)}
                                className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                onMouseDown={(e) => e.preventDefault()}
                              >
                                {state.name}
                              </div>
                            ))}
                        </div>
                      )}
                    </div>

                    {/* City Dropdown */}
                    <div className="relative" ref={cityDropdownRef}>
                      <input
                        type="text"
                        value={citySearchTerm}
                        onChange={handleCitySearchChange}
                        onFocus={() =>
                          selectedStateObj && setCityDropdownOpen(true)
                        }
                        placeholder="Select City"
                        className={`w-full h-[44px] px-4 bg-[#E7EFF8]/60 border border-white/20 border-t-0 outline-none text-[#545454] placeholder-[#545454] text-[16px] ${
                          !selectedStateObj
                            ? "cursor-not-allowed opacity-60 bg-gray-300"
                            : ""
                        }`}
                        disabled={!selectedStateObj}
                        readOnly={!selectedStateObj}
                        autoComplete="off"
                      />
                      {cityDropdownOpen && (
                        <div className="absolute z-10 custom-scrollbar w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                          {cities
                            .filter((city) =>
                              city.name
                                .toLowerCase()
                                .includes(citySearchTerm.toLowerCase())
                            )
                            .map((city) => (
                              <div
                                key={city.name}
                                onClick={() => handleCitySelect(city)}
                                className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                onMouseDown={(e) => e.preventDefault()}
                              >
                                {city.name}
                              </div>
                            ))}
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Pincode and Country */}
                  <div className="grid grid-cols-2 w-full">
                    {/* Pincode Input */}
                    <input
                      type="text"
                      name="pincode"
                      value={createFormData.pincode}
                      onChange={handleCreateInputChange}
                      className="w-full h-[44px] px-3 flex items-center text-[#545454] bg-[#E7EFF8]/60 border border-white/20 border-t-0 border-r rounded-bl-[12px] outline-none"
                      placeholder="Pincode"
                    />
                    {/* Country Dropdown */}
                    <div className="relative" ref={countryDropdownRef}>
                      <input
                        type="text"
                        value={countrySearchTerm}
                        onChange={handleCountrySearchChange}
                        onFocus={() => setCountryDropdownOpen(true)}
                        placeholder="Select Country"
                        className="w-full h-[44px] px-4 bg-[#E7EFF8]/60 border border-white/20 border-t-0 rounded-br-[12px] outline-none text-[#545454] placeholder-[#545454] text-[16px]"
                        autoComplete="off"
                      />
                      {countryDropdownOpen && (
                        <div className="absolute z-10 custom-scrollbar w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                          {countries
                            .filter((country) =>
                              country.name
                                .toLowerCase()
                                .includes(countrySearchTerm.toLowerCase())
                            )
                            .map((country) => (
                              <div
                                key={country.isoCode}
                                onClick={() => handleCountrySelect(country)}
                                className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                onMouseDown={(e) => e.preventDefault()}
                              >
                                {country.name}
                              </div>
                            ))}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>

              {/* Email */}
              <div className="space-y-2 md:col-start-1 md:row-start-4 ">
                <label className="block text-[#4B5563] text-[16px] mb-2">
                  Email
                </label>
                <input
                  type="email"
                  name="email"
                  value={createFormData.email}
                  onChange={handleCreateInputChange}
                  className="
        w-full h-[48px] px-3 rounded-[12px]
        bg-[#E7EFF8] border border-white/20
        focus:ring-2 focus:ring-[#0e4053] outline-none
        text-[#545454] placeholder-[#545454]
      "
                  required
                />
              </div>

              {/* Role Dropdown (new) */}
              <div
                className="space-y-2 md:col-span-2 md:row-start-3 relative"
                ref={roleDropdownRef}
              >
                <label className="block text-[#4B5563] text-[16px] mb-2">
                  Role
                </label>
                <div className="relative">
                  <button
                    type="button"
                    className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] text-left flex items-center justify-between cursor-pointer"
                    onClick={() => setCreateRoleDropdownOpen((open) => !open)}
                  >
                    <span>
                      {createSelectedRole
                        ? formatRoleName(createSelectedRole.name)
                        : "Select Role"}
                    </span>
                    <svg
                      className={`w-4 h-4 transition-transform ${
                        createRoleDropdownOpen ? "rotate-180" : ""
                      }`}
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M19 9l-7 7-7-7"
                      />
                    </svg>
                  </button>
                  {createRoleDropdownOpen && (
                    <div className="absolute custom-scrollbar top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto">
                      {roles.map((role) => (
                        <button
                          type="button"
                          key={role.id}
                          className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                          onClick={() => {
                            setCreateSelectedRole(role);
                            setCreateRoleDropdownOpen(false);
                          }}
                        >
                          {formatRoleName(role.name)}
                        </button>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              {/* Password field */}
              <div className="space-y-2 md:col-start-2 md:row-start-4">
                <label className="block text-[#4B5563] text-[16px] mb-2">
                  Password
                </label>
                <div className="relative flex items-center">
                  <input
                    type="password"
                    name="password"
                    value={createFormData.password}
                    onChange={handleCreateInputChange}
                    className="
                      w-full h-[48px] px-3 rounded-[12px]
                      bg-[#E7EFF8] border border-white/20
                      focus:ring-2 focus:ring-[#0e4053] outline-none
                      text-[#545454] placeholder-[#545454]
                    "
                    placeholder="Enter password"
                    required
                  />
                </div>
              </div>
            </div>

            {/* Save button */}
            <div className="mt-10 flex justify-center">
              <button
                type="button"
                onClick={handleCreateSubmit}
                className="w-[207px] h-[46px] bg-[#ef7e1b] text-white rounded-[10px] hover:bg-[#ee7f1b] transition-colors cursor-pointer"
              >
                Save
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Pagination Controls */}
      {filteredUsers.length > 0 && (
        <div className="flex justify-center pt-7 mt-auto">
          <div className="flex items-center gap-2 lg:gap-3">
            {/* Previous Page */}
            <button
              onClick={handlePreviousPage}
              disabled={currentPage === 1}
              className={`w-[44px] h-[44px] lg:w-[52px] lg:h-[52px]
          rounded-full border border-[#7E7B7B]
          flex items-center justify-center transition-colors
          ${
            currentPage === 1
              ? "opacity-50 cursor-not-allowed"
              : "group hover:bg-blue-200 hover:border-white hover:text-white"
          }
        `}
            >
              <svg
                width="33"
                height="32"
                viewBox="0 0 33 32"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                className={`stroke-current text-[#7E7B7B]
            ${currentPage === 1 ? "" : "group-hover"}
          `}
              >
                <path
                  d="M23.1667 5.33398L12.06 13.3873C9.09198 15.5407 9.09198 16.462 12.06 18.614L23.1667 26.6673"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Page Info */}
            <div className="flex items-center gap-2 text-sm lg:text-base text-[#4B5563]">
              <span>
                Page {currentPage} of {totalPages}
              </span>
              <span>({filteredUsers.length} total)</span>
            </div>

            {/* Next Page */}
            <button
              onClick={handleNextPage}
              disabled={currentPage === totalPages}
              className={`w-[44px] h-[44px] lg:w-[52px] lg:h-[52px]
          rounded-full border border-[#7E7B7B]
          flex items-center justify-center transition-colors
          ${
            currentPage === totalPages
              ? "opacity-50 cursor-not-allowed"
              : "group hover:bg-blue-200 hover:border-white hover:text-white"
          }
        `}
            >
              <svg
                width="52"
                height="52"
                viewBox="0 0 52 52"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                className={`stroke-current text-[#7E7B7B]
            ${currentPage === totalPages ? "" : "group-hover:text-white"}
          `}
              >
                <circle cx="26" cy="26" r="25.5" strokeWidth="1" />
                <path
                  d="M20.8333 15.334L31.94 23.3873C34.908 25.5407 34.908 26.462 31.94 28.614L20.8333 36.6673"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

export default CreateUser;
//before new changes
</file>

<file path="src/pages/settings/OrganisationInfo.jsx">
import React, { useState, useEffect, useRef, useMemo, useContext } from "react";
import { FiEdit } from "react-icons/fi";
import api from "../../api";
import Swal from "sweetalert2";
import { City, State, Country } from "country-state-city";
import { RxCross2 } from "react-icons/rx";
import { SidebarContext } from "../../components/Layout";


const EditIcon = (props) => (
  <svg
    width="22"
    height="22"
    viewBox="0 0 22 22"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
    {...props}
  >
    <rect width="22" height="22" rx="3" fill="#2798FF" />
    <path
      d="M2.75 19.25V15.3542L14.85 3.27708C15.0334 3.10903 15.2359 2.97917 15.4578 2.8875C15.6796 2.79583 15.9124 2.75 16.1563 2.75C16.4001 2.75 16.6369 2.79583 16.8667 2.8875C17.0965 2.97917 17.2951 3.11667 17.4625 3.3L18.7229 4.58334C18.9063 4.75139 19.0401 4.95 19.1244 5.17917C19.2088 5.40834 19.2506 5.6375 19.25 5.86667C19.25 6.11112 19.2082 6.34426 19.1244 6.56609C19.0407 6.78792 18.9069 6.9902 18.7229 7.17292L6.64584 19.25H2.75ZM16.1334 7.15001L17.4167 5.86667L16.1334 4.58334L14.85 5.86667L16.1334 7.15001Z"
      fill="white"
    />
  </svg>
);

const OrganisationInfo = () => {
  // Mobile detection
  const [isMobile, setIsMobile] = useState(() => window.innerWidth < 768);

  // Hardcoded data for the single list item, now in state
  const [organisation, setOrganisation] = useState({
    id: null,
    name: "",
    email: "",
    address: "",
    phoneno: "",
    organizationimage: null,
    profile_image: null,
    blockUnitStreetName: "",
    city: "",
    state: "",
    country: "",
    pincode: "",
    digital_seal: null,
    bankName: "",
    accountName: "",
    ifscCode: "",
    accountNo: "",
    bankBranch: "",
    terms: [],
  });

  // State for the form data
  const [formData, setFormData] = useState({ ...organisation });
  const [imagePreview, setImagePreview] = useState(null);
  const [digitalSeal, setDigitalSeal] = useState(null); // New state for digital seal file
  const [digitalSealPreview, setDigitalSealPreview] = useState(null); // New state for digital seal preview

  // New state for adding terms
  const [newTerm, setNewTerm] = useState("");

  // States for country-state-city data
  const [allCountries, setAllCountries] = useState([]);
  const [allStates, setAllStates] = useState([]);
  const [allCities, setAllCities] = useState([]);

  // States to hold the selected country, state, city objects
  const [selectedCountryObj, setSelectedCountryObj] = useState(null);
  const [selectedStateObj, setSelectedStateObj] = useState(null);
  const [selectedCityObj, setSelectedCityObj] = useState(null);

  // New states for search functionality
  const [countryDropdownOpen, setCountryDropdownOpen] = useState(false);
  const [filteredCountries, setFilteredCountries] = useState([]);

  // New states for search functionality for State and City
  const [stateDropdownOpen, setStateDropdownOpen] = useState(false);
  const [filteredStates, setFilteredStates] = useState([]);
  const [cityDropdownOpen, setCityDropdownOpen] = useState(false);
  const [filteredCities, setFilteredCities] = useState([]);

  // New states for search functionality, similar to UpdateProfile
  const [countrySearchTerm, setCountrySearchTerm] = useState("");
  const [stateSearchTerm, setStateSearchTerm] = useState("");
  const [citySearchTerm, setCitySearchTerm] = useState("");

  // Refs for dropdowns to handle outside clicks
  const countryDropdownRef = useRef(null);
  const stateDropdownRef = useRef(null);
  const cityDropdownRef = useRef(null);

  // Filtered lists for country, state, city (using useMemo for performance)
  const filteredCountriesMemo = useMemo(
    () =>
      allCountries.filter((country) =>
        country.name.toLowerCase().includes(countrySearchTerm.toLowerCase())
      ),
    [allCountries, countrySearchTerm]
  );

  const filteredStatesMemo = useMemo(
    () =>
      allStates.filter((state) =>
        state.name.toLowerCase().includes(stateSearchTerm.toLowerCase())
      ),
    [allStates, stateSearchTerm]
  );

  const filteredCitiesMemo = useMemo(
    () =>
      allCities.filter((city) =>
        city.name.toLowerCase().includes(citySearchTerm.toLowerCase())
      ),
    [allCities, citySearchTerm]
  );

  // Effect to initialize countries and set default India
  useEffect(() => {
    const countries = Country.getAllCountries();
    setAllCountries(countries);
    // Removed setFilteredCountries(countries) as useMemo will handle it
    // No default India here, let the fetch populate if it exists
  }, []);

  // Effect to handle city change
  useEffect(() => {
    if (selectedCityObj) {
      setFormData((prev) => ({ ...prev, city: selectedCityObj.name }));
    }
  }, [selectedCityObj]);

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData((prev) => ({
      ...prev,
      [name]: value,
    }));
  };

  // Handler for adding a new term
  const handleAddTerm = (e) => {
    e.preventDefault();
    if (newTerm.trim() !== "") {
      setFormData((prev) => ({
        ...prev,
        terms: [...(prev.terms || []), newTerm.trim()],
      }));
      setNewTerm("");
    }
  };

  // Handler for removing a term
  const handleRemoveTerm = (idx) => {
    setFormData((prev) => ({
      ...prev,
      terms: prev.terms.filter((_, i) => i !== idx),
    }));
  };

  const handleCountrySearchChange = (e) => {
    const query = e.target.value;
    setCountrySearchTerm(query); // Update search term
    setFormData((prev) => ({ ...prev, country: query }));
    setCountryDropdownOpen(true);
    if (query.trim() === "") {
      setSelectedCountryObj(null); // Clear selected country
      setSelectedStateObj(null); // Clear dependent states
      setSelectedCityObj(null);
      setAllStates([]);
      setAllCities([]);
      setStateSearchTerm(""); // Clear dependent search terms
      setCitySearchTerm("");
    }
  };

  const handleCountrySelect = (country) => {
    setSelectedCountryObj(country);
    setCountrySearchTerm(country.name); // Set search term from selected country
    setFormData((prev) => ({ ...prev, country: country.name }));
    setCountryDropdownOpen(false);

    // When country changes, reset states and cities
    const states = State.getStatesOfCountry(country.isoCode);
    setAllStates(states);
    setSelectedStateObj(null);
    setSelectedCityObj(null);
    setAllCities([]);
    setStateSearchTerm("");
    setCitySearchTerm("");
    setFormData((prev) => ({ ...prev, state: "", city: "" })); // Clear form data as well
  };

  const handleStateSearchChange = (e) => {
    if (!countrySearchTerm) {
      // Prevent state search if no country is selected based on search term
      return;
    }
    const query = e.target.value;
    setStateSearchTerm(query); // Update search term
    setFormData((prev) => ({ ...prev, state: query }));
    setStateDropdownOpen(true);
    if (query.trim() === "") {
      setSelectedStateObj(null); // Clear selected state
      setSelectedCityObj(null); // Clear dependent cities
      setAllCities([]);
      setCitySearchTerm(""); // Clear dependent search term
    }
  };

  const handleStateSelect = (state) => {
    setSelectedStateObj(state);
    setStateSearchTerm(state.name); // Set search term from selected state
    setFormData((prev) => ({ ...prev, state: state.name }));
    setStateDropdownOpen(false);

    // When state changes, reset cities
    const cities = City.getCitiesOfState(state.countryCode, state.isoCode);
    setAllCities(cities);
    setSelectedCityObj(null);
    setCitySearchTerm("");
    setFormData((prev) => ({ ...prev, city: "" })); // Clear form data as well
  };

  const handleCitySearchChange = (e) => {
    if (!stateSearchTerm) {
      // Prevent city search if no state is selected based on search term
      return;
    }
    const query = e.target.value;
    setCitySearchTerm(query); // Update search term
    setFormData((prev) => ({ ...prev, city: query }));
    setCityDropdownOpen(true);
    if (query.trim() === "") {
      setSelectedCityObj(null); // Clear selected city
    }
  };

  const handleCitySelect = (city) => {
    setSelectedCityObj(city);
    setCitySearchTerm(city.name); // Set search term from selected city
    setFormData((prev) => ({ ...prev, city: city.name }));
    setCityDropdownOpen(false);
  };

  const handleImageChange = (e) => {
    const file = e.target.files && e.target.files[0];
    if (file) {
      setFormData((prev) => ({ ...prev, organizationimage: file }));
      if (imagePreview && imagePreview.startsWith("blob:")) {
        URL.revokeObjectURL(imagePreview);
      }
      setImagePreview(URL.createObjectURL(file));
    }
  };

  const handleDigitalSealChange = (e) => {
    const file = e.target.files && e.target.files[0];
    if (file) {
      setDigitalSeal(file);
      if (digitalSealPreview && digitalSealPreview.startsWith("blob:")) {
        URL.revokeObjectURL(digitalSealPreview);
      }
      setDigitalSealPreview(URL.createObjectURL(file));
    }
  };

  const handleImageError = (e) => {
    console.error("Image failed to load:", e);
    if (imagePreview !== "/dummyavatar.jpeg") {
      console.log("Falling back to default avatar");
      setImagePreview("/dummyavatar.jpeg");
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();

    // Input Validation
    if (!formData.name.trim()) {
      Swal.fire({
        icon: "error",
        title: "Validation Error",
        text: "Company Name cannot be empty.",
        confirmButtonColor: "#0e4053",
      });
      return;
    }

    if (!formData.email.trim()) {
      Swal.fire({
        icon: "error",
        title: "Validation Error",
        text: "Email cannot be empty.",
        confirmButtonColor: "#0e4053",
      });
      return;
    }

    const emailRegex = /^[\w-]+(?:\.[\w-]+)*@(?:[\w-]+\.)+[a-zA-Z]{2,7}$/;
    if (!emailRegex.test(formData.email)) {
      Swal.fire({
        icon: "error",
        title: "Validation Error",
        text: "Please enter a valid email address.",
        confirmButtonColor: "#0e4053",
      });
      return;
    }

    if (!formData.phoneno.trim()) {
      Swal.fire({
        icon: "error",
        title: "Validation Error",
        text: "Contact Number cannot be empty.",
        confirmButtonColor: "#0e4053",
      });
      return;
    }

    const phoneRegex = /^[0-9]{10}$/;
    if (!phoneRegex.test(formData.phoneno)) {
      Swal.fire({
        icon: "error",
        title: "Validation Error",
        text: "Please enter a valid 10-digit phone number.",
        confirmButtonColor: "#0e4053",
      });
      return;
    }

    if (!formData.blockUnitStreetName.trim()) {
      Swal.fire({
        icon: "error",
        title: "Validation Error",
        text: "Block/Unit/Street Name cannot be empty.",
        confirmButtonColor: "#0e4053",
      });
      return;
    }

    if (!selectedCountryObj) {
      // Validate country selection
      Swal.fire({
        icon: "error",
        title: "Validation Error",
        text: "Please select a Country.",
        confirmButtonColor: "#0e4053",
      });
      return;
    }

    if (!selectedStateObj) {
      // Validate state selection
      Swal.fire({
        icon: "error",
        title: "Validation Error",
        text: "Please select a State.",
        confirmButtonColor: "#0e4053",
      });
      return;
    }

    if (!formData.pincode.trim()) {
      Swal.fire({
        icon: "error",
        title: "Validation Error",
        text: "Pincode cannot be empty.",
        confirmButtonColor: "#0e4053",
      });
      return;
    }

    const pincodeRegex = /^[0-9]{6}$/;
    if (formData.pincode.trim() && !pincodeRegex.test(formData.pincode)) {
      Swal.fire({
        icon: "error",
        title: "Validation Error",
        text: "Please enter a valid 6-digit Pincode.",
        confirmButtonColor: "#0e4053",
      });
      return;
    }

    // Add validation for bank fields if needed

    const result = await Swal.fire({
      title: "Are you sure?",
      text: "You want to update the organisation details?",
      icon: "question",
      showCancelButton: true,
      confirmButtonColor: "#0e4053",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, update it!",
      cancelButtonText: "No, cancel!",
    });

    if (!result.isConfirmed) {
      return;
    }

    try {
      let response;
      // Construct address object for payload, similar to updateprofile.jsx
      const addressObject = {
        blockUnitStreetName: formData.blockUnitStreetName,
        city: formData.city,
        state: formData.state,
        country: formData.country,
        pincode: formData.pincode,
      };
      const fullAddressJsonString = JSON.stringify(addressObject);
      // Add bank and terms to payload
      const bankDetails = {
        bankName: formData.bankName,
        accountName: formData.accountName,
        ifscCode: formData.ifscCode,
        accountNo: formData.accountNo,
        bankBranch: formData.bankBranch,
      };
      const terms = formData.terms || [];

      // Check if either image is a new File
      const isOrganizationImageNew = formData.organizationimage instanceof File;
      const isDigitalSealNew = digitalSeal instanceof File;

      if (isOrganizationImageNew || isDigitalSealNew) {
        const formPayload = new FormData();
        formPayload.append("organizationname", formData.name);
        formPayload.append("phone", formData.phoneno);
        formPayload.append("email", formData.email);
        formPayload.append("address", fullAddressJsonString);
        formPayload.append("aid", formData.id);
        formPayload.append("bank_name", formData.bankName);
        formPayload.append("account_name", formData.accountName);
        formPayload.append("ifsc_code", formData.ifscCode);
        formPayload.append("account_no", formData.accountNo);
        formPayload.append("bank_branch", formData.bankBranch);
        formPayload.append(
          "term_info",
          JSON.stringify(
            Object.fromEntries(
              (formData.terms || []).map((term, idx) => [
                `bulletpoint${idx + 1}`,
                term,
              ])
            )
          )
        );
        // Always send profile_image (file if new, else URL)
        if (isOrganizationImageNew) {
          formPayload.append("profile_image", formData.organizationimage);
        } else if (formData.profile_image) {
          formPayload.append("profile_image", formData.profile_image);
        }
        // Always send upload_seal (file if new, else URL)
        if (isDigitalSealNew) {
          formPayload.append("upload_seal", digitalSeal);
        } else if (formData.digital_seal) {
          formPayload.append("upload_seal", formData.digital_seal);
        }
        console.log(
          "new post here, formPayload",
          Array.from(formPayload.entries())
        );
        response = await api.post("/updateorganization", formPayload, {
          headers: { "Content-Type": "multipart/form-data" },
        });
      } else {
        // Always send all fields, even if not changed
        const formattedData = {
          organizationname: formData.name,
          phone: formData.phoneno,
          email: formData.email,
          address: fullAddressJsonString,
          aid: formData.id,
          bank_name: formData.bankName,
          account_name: formData.accountName,
          ifsc_code: formData.ifscCode,
          account_no: formData.accountNo,
          bank_branch: formData.bankBranch,
          term_info: JSON.stringify(
            Object.fromEntries(
              (formData.terms || []).map((term, idx) => [
                `bulletpoint${idx + 1}`,
                term,
              ])
            )
          ),
        };
        if (formData.profile_image) {
          formattedData.profile_image = formData.profile_image;
        }
        if (formData.digital_seal) {
          formattedData.upload_seal = formData.digital_seal;
        }
        response = await api.post("/updateorganization", formattedData);
      }

      if (response.status === 200) {
        setOrganisation((prevOrg) => ({
          ...prevOrg,
          ...formData,
          address: fullAddressJsonString, // Update organisation state with JSON string
        }));
        Swal.fire({
          title: "Success!",
          text: "Organisation details updated successfully!",
          icon: "success",
          confirmButtonColor: "#0e4053",
        }).then(() => {});
      } else {
        Swal.fire({
          title: "Error!",
          text: "Failed to update organisation details.",
          icon: "error",
          confirmButtonColor: "#0e4053",
        });
      }
    } catch (error) {
      console.error("Error updating organisation:", error);
      Swal.fire({
        title: "Error!",
        text: "An error occurred while updating.",
        icon: "error",
        confirmButtonColor: "#0e4053",
      });
    }
  };

  useEffect(() => {
    const fetchOrganisationData = async () => {
      try {
        const response = await api.get("/orglist");
        const result = response.data.result;

        // If result is an object, get the first value (organization)
        let orgData = null;
        if (result && typeof result === "object" && !Array.isArray(result)) {
          const orgArray = Object.values(result);
          orgData = orgArray.length > 0 ? orgArray[0] : null;
        } else if (Array.isArray(result)) {
          orgData = result[0];
        }

        if (orgData) {
          // Parse address
          let parsedAddress = {};
          if (orgData.address && typeof orgData.address === "string") {
            try {
              parsedAddress = JSON.parse(orgData.address);
            } catch (e) {
              console.error(
                "Error parsing address JSON from orgData.address:",
                e
              );
              // Fallback for old format or invalid JSON, splitting by '\r' for the provided API response
              const addressParts = orgData.address.split("\r");
              parsedAddress.blockUnitStreetName = addressParts[0] || "";
              const cityStatePart = addressParts[1] || "";
              const cityStateArray = cityStatePart.split(", ");
              if (cityStateArray.length === 2) {
                parsedAddress.city = cityStateArray[0];
                parsedAddress.state = cityStateArray[1];
              } else if (cityStateArray.length === 1) {
                parsedAddress.state = cityStateArray[0];
              }
              const countryPincodePart = addressParts[2] || "";
              const countryPincodeArray = countryPincodePart.split(" - ");
              if (countryPincodeArray.length === 2) {
                parsedAddress.country = countryPincodeArray[0];
                parsedAddress.pincode = countryPincodeArray[1];
              } else {
                parsedAddress.country = countryPincodePart;
              }
            }
          }

          const blockUnitStreetName = parsedAddress.blockUnitStreetName || "";
          const city = parsedAddress.city || "";
          const state = parsedAddress.state || "";
          const country = parsedAddress.country || "";
          const pincode = parsedAddress.pincode || "";

          // Always set search terms from parsed address first
          setCountrySearchTerm(country);
          setStateSearchTerm(state);
          setCitySearchTerm(city);

          // Update organisation and formData state
          setOrganisation({
            id: orgData.id,
            name: orgData.organizationname,
            email: orgData.email,
            address: orgData.address,
            phoneno: orgData.phone,
            organizationimage: null,
            profile_image: orgData.profile_image,
            blockUnitStreetName: blockUnitStreetName,
            city: city,
            state: state,
            country: country,
            pincode: pincode,
            digital_seal: orgData.upload_seal,
            bankName: orgData.bank_name || "",
            accountName: orgData.account_name || "",
            ifscCode: orgData.ifsc_code || "",
            accountNo: orgData.account_no || "",
            bankBranch: orgData.bank_branch || "",
            terms: (() => {
              if (orgData.term_info) {
                try {
                  let termsObj = orgData.term_info;
                  if (typeof termsObj === "string") {
                    termsObj = JSON.parse(termsObj); // first parse
                    if (typeof termsObj === "string") {
                      termsObj = JSON.parse(termsObj); // second parse if still string
                    }
                  }
                  return Object.values(termsObj);
                } catch {
                  return [];
                }
              }
              return [];
            })(),
          });

          setFormData({
            id: orgData.id,
            name: orgData.organizationname,
            email: orgData.email,
            address: orgData.address,
            phoneno: orgData.phone,
            organizationimage: null,
            profile_image: orgData.profile_image,
            blockUnitStreetName: blockUnitStreetName,
            city: city,
            state: state,
            country: country,
            pincode: pincode,
            digital_seal: orgData.upload_seal,
            bankName: orgData.bank_name || "",
            accountName: orgData.account_name || "",
            ifscCode: orgData.ifsc_code || "",
            accountNo: orgData.account_no || "",
            bankBranch: orgData.bank_branch || "",
            terms: (() => {
              if (orgData.term_info) {
                try {
                  let termsObj = orgData.term_info;
                  if (typeof termsObj === "string") {
                    termsObj = JSON.parse(termsObj); // first parse
                    if (typeof termsObj === "string") {
                      termsObj = JSON.parse(termsObj); // second parse if still string
                    }
                  }
                  return Object.values(termsObj);
                } catch {
                  return [];
                }
              }
              return [];
            })(),
          });

          setImagePreview(orgData.profile_image || "/dummyavatar.jpeg");
          setDigitalSealPreview(orgData.upload_seal || null);

          // Attempt to find Country, State, City objects from library and set selected objects
          const countryObj = allCountries.find(
            (c) => c.name.toLowerCase() === country.toLowerCase().trim()
          );

          if (countryObj) {
            setSelectedCountryObj(countryObj);
            const statesForCountry = State.getStatesOfCountry(
              countryObj.isoCode
            );
            setAllStates(statesForCountry); // Populate all states for this country

            const stateObj = statesForCountry.find(
              (s) => s.name.toLowerCase() === state.toLowerCase().trim()
            );

            if (stateObj) {
              setSelectedStateObj(stateObj);
              const citiesForState = City.getCitiesOfState(
                stateObj.countryCode,
                stateObj.isoCode
              );
              setAllCities(citiesForState); // Populate all cities for this state

              const cityObj = citiesForState.find(
                (c) => c.name.toLowerCase() === city.toLowerCase().trim()
              );

              if (cityObj) {
                setSelectedCityObj(cityObj);
              } else {
                setSelectedCityObj(null); // No city match in library
              }
            } else {
              setSelectedStateObj(null); // No state match in library
              setAllCities([]); // Clear cities dropdown if no state match
            }
          } else {
            setSelectedCountryObj(null); // No country match in library
            setAllStates([]); // Clear states dropdown if no country match
            setSelectedStateObj(null);
            setAllCities([]); // Clear cities dropdown if no country match
            setSelectedCityObj(null);
          }
        } else {
          // No orgData found - reset all states, including search terms
          setOrganisation({
            id: null,
            name: "",
            email: "",
            address: "",
            phoneno: "",
            organizationimage: null,
            profile_image: null,
            blockUnitStreetName: "",
            city: "",
            state: "",
            country: "",
            pincode: "",
            digital_seal: null,
            bankName: "",
            accountName: "",
            ifscCode: "",
            accountNo: "",
            bankBranch: "",
            terms: [],
          });
          setFormData({
            id: null,
            name: "",
            email: "",
            address: "",
            phoneno: "",
            organizationimage: null,
            profile_image: null,
            blockUnitStreetName: "",
            city: "",
            state: "",
            country: "",
            pincode: "",
            digital_seal: null,
            bankName: "",
            accountName: "",
            ifscCode: "",
            accountNo: "",
            bankBranch: "",
            terms: [],
          });
          setImagePreview("/dummyavatar.jpeg");
          setDigitalSealPreview(null);
          setSelectedCountryObj(null);
          setSelectedStateObj(null);
          setSelectedCityObj(null);
          setAllStates([]);
          setAllCities([]);
          setCountrySearchTerm("");
          setStateSearchTerm("");
          setCitySearchTerm("");
        }
      } catch (error) {
        console.error("Failed to fetch organisation data:", error);
        // Error handling: reset to default empty states rather than "Failed to load"
        setOrganisation({
          id: null,
          name: "",
          email: "",
          address: "",
          phoneno: "",
          organizationimage: null,
          profile_image: null,
          blockUnitStreetName: "",
          city: "",
          state: "",
          country: "",
          pincode: "",
          digital_seal: null,
          bankName: "",
          accountName: "",
          ifscCode: "",
          accountNo: "",
          bankBranch: "",
          terms: [],
        });
        setFormData({
          id: null,
          name: "",
          email: "",
          address: "",
          phoneno: "",
          organizationimage: null,
          profile_image: null,
          blockUnitStreetName: "",
          city: "",
          state: "",
          country: "",
          pincode: "",
          digital_seal: null,
          bankName: "",
          accountName: "",
          ifscCode: "",
          accountNo: "",
          bankBranch: "",
          terms: [],
        });
        setImagePreview("/dummyavatar.jpeg");
        setDigitalSealPreview(null);
        setSelectedCountryObj(null);
        setSelectedStateObj(null);
        setSelectedCityObj(null);
        setAllStates([]);
        setAllCities([]);
        setCountrySearchTerm("");
        setStateSearchTerm("");
        setCitySearchTerm("");
      }
    };
    // Only fetch data if countries are loaded
    if (allCountries.length > 0) {
      fetchOrganisationData();
    }
  }, [allCountries]);

  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth < 768);
    };
    // Initial check
    checkMobile();
    // Add event listener for resize
    window.addEventListener("resize", checkMobile);
    // Cleanup event listener on component unmount
    return () => {
      window.removeEventListener("resize", checkMobile);
      // Cleanup blob URL when component unmounts
      if (imagePreview && imagePreview.startsWith("blob:")) {
        URL.revokeObjectURL(imagePreview);
      }
    };
  }, [imagePreview]);

  // New useEffect for digitalSealPreview cleanup
  useEffect(() => {
    return () => {
      if (digitalSealPreview && digitalSealPreview.startsWith("blob:")) {
        URL.revokeObjectURL(digitalSealPreview);
      }
    };
  }, [digitalSealPreview]);

  // Add useEffect for country dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        countryDropdownRef.current &&
        !countryDropdownRef.current.contains(event.target)
      ) {
        setCountryDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for state dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        stateDropdownRef.current &&
        !stateDropdownRef.current.contains(event.target)
      ) {
        setStateDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for city dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        cityDropdownRef.current &&
        !cityDropdownRef.current.contains(event.target)
      ) {
        setCityDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const isDummyImage =
    !imagePreview || imagePreview.endsWith("/dummyavatar.jpeg");


  // Consume SidebarContext
  const { isCollapsed } = useContext(SidebarContext);


  return (
    <div className="">
      {/* Edit Form Section */}
      <div className={`mb-6 p-4 md:p-6 bg-gradient-to-br from-white to-[#E7F4FF] rounded-[10px] shadow-[2px_2px_6px_rgba(24,95,235,0.1)] ${
        isCollapsed ? "lg:max-w-[85vw] md:w-[85vw]" : "lg:max-w-[75vw] md:w-[80vw]"
      } `}>
        <h2 className="text-[22px] font-medium text-[#1F2837] mb-4">
          Edit Details
        </h2>
        <form onSubmit={handleSubmit}>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {/* Organization Image */}
            <div className="md:col-span-2 flex flex-col md:flex-row items-center gap-4 md:gap-6 mb-4">
              <div className="relative flex-shrink-0">
                {imagePreview ? (
                  <>
                    <div
                      className={`w-24 h-24 rounded-full overflow-hidden flex items-center justify-center ${
                        isDummyImage ? "bg-[#8CBFEC]" : ""
                      }`}
                    >
                      <img
                        src={imagePreview}
                        alt="Organisation Image"
                        className="w-full h-full object-cover"
                        onError={handleImageError}
                      />
                    </div>
                    <label
                      htmlFor="image-upload"
                      className="absolute bottom-0 right-0 cursor-pointer"
                    >
                      <EditIcon />
                      <input
                        id="image-upload"
                        name="organizationimage"
                        type="file"
                        accept="image/png, image/jpeg"
                        className="hidden"
                        onChange={handleImageChange}
                      />
                    </label>
                  </>
                ) : (
                  <div className="w-24 h-24 rounded-full bg-gray-300 animate-pulse" />
                )}
              </div>
              <div className="text-xs md:text-sm text-[#4B5563] text-center md:text-left">
                <p>
                  Update your organisation image by clicking the image beside.
                </p>
                <p>288x288 px size recommended in PNG or JPG format only.</p>
              </div>
            </div>

            {/* Company Name */}
            <div className="space-y-1">
              <label className="block text-[#4B5563] text-sm font-medium">
                Company Name
              </label>
              <div className="relative">
                <input
                  type="text"
                  name="name"
                  value={formData.name}
                  onChange={handleInputChange}
                  className="w-full h-[44px] px-3 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                />
                <FiEdit className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
              </div>
            </div>

            {/* Email */}
            <div className="space-y-1">
              <label className="block text-[#4B5563] text-sm font-medium">
                Email
              </label>
              <input
                type="email"
                name="email"
                value={formData.email}
                onChange={handleInputChange}
                className="w-full h-[44px] px-3 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
              />
            </div>

            {/* Contact Number */}
            <div className="space-y-1">
              <label className="block text-[#4B5563] text-sm font-medium">
                Contact Number
              </label>
              <input
                type="text"
                name="phoneno"
                value={formData.phoneno}
                onChange={handleInputChange}
                className="w-full h-[44px] px-3 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
              />
            </div>

            {/* Empty div for spacing */}
            <div />

            {/* Address */}
            <div className="space-y-1 md:col-span-2">
              <label className="block text-[#4B5563] text-sm font-medium">
                Address
              </label>
              <div className="w-full rounded-[12px]  border border-white/20 flex flex-col">
                <input
                  type="text"
                  name="blockUnitStreetName"
                  value={formData.blockUnitStreetName}
                  onChange={handleInputChange}
                  className="w-full h-[44px] px-3 flex items-center text-[#545454] border-b  bg-[#E7EFF8]/60 border border-white/20 outline-none rounded-t-[12px]"
                  placeholder="Block/Unit/Street Name"
                />

                {/* State and City Dropdowns */}
                <div className="grid grid-cols-2  w-full">
                  {/* State Dropdown */}
                  <div className="relative" ref={stateDropdownRef}>
                    <input
                      type="text"
                      name="stateSearch"
                      value={stateSearchTerm}
                      onChange={handleStateSearchChange}
                      onFocus={() =>
                        countrySearchTerm && setStateDropdownOpen(true)
                      }
                      onBlur={() => setStateDropdownOpen(false)}
                      className={`w-full h-[44px] px-4 border border-white/20 outline-none text-[#545454] placeholder-[#545454] text-[16px] ${
                        countrySearchTerm
                          ? "bg-[#E7EFF8]/60"
                          : "bg-gray-300 cursor-not-allowed opacity-60"
                      }`}
                      placeholder="Select State"
                      disabled={!countrySearchTerm}
                      readOnly={!countrySearchTerm}
                      autoComplete="off"
                    />
                    {stateDropdownOpen && countrySearchTerm && (
                      <div className="absolute z-10 custom-scrollbar w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                        {filteredStatesMemo.length > 0 ? (
                          filteredStatesMemo.map((state) => (
                            <div
                              key={state.isoCode}
                              className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                              onClick={() => handleStateSelect(state)}
                              onMouseDown={(e) => e.preventDefault()}
                            >
                              {state.name}
                            </div>
                          ))
                        ) : (
                          <div className="p-3 text-gray-500">
                            No states found
                          </div>
                        )}
                      </div>
                    )}
                  </div>

                  {/* City Dropdown */}
                  <div className="relative" ref={cityDropdownRef}>
                    <input
                      type="text"
                      name="citySearch"
                      value={citySearchTerm}
                      onChange={handleCitySearchChange}
                      onFocus={() =>
                        stateSearchTerm && setCityDropdownOpen(true)
                      }
                      onBlur={() => setCityDropdownOpen(false)}
                      className={`w-full h-[44px] px-4 border border-white/20 outline-none text-[#545454] placeholder-[#545454] text-[16px] ${
                        stateSearchTerm
                          ? "bg-[#E7EFF8]/60"
                          : "bg-gray-300 cursor-not-allowed opacity-60"
                      }`}
                      placeholder="Select City"
                      disabled={!stateSearchTerm}
                      readOnly={!stateSearchTerm}
                      autoComplete="off"
                    />
                    {cityDropdownOpen && stateSearchTerm && (
                      <div className="absolute custom-scrollbar z-10 w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                        {filteredCitiesMemo.length > 0 ? (
                          filteredCitiesMemo.map((city) => (
                            <div
                              key={city.name}
                              className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                              onClick={() => handleCitySelect(city)}
                              onMouseDown={(e) => e.preventDefault()}
                            >
                              {city.name}
                            </div>
                          ))
                        ) : (
                          <div className="p-3 text-gray-500">
                            No cities found
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>

                {/* Pincode and Country */}
                <div className="grid grid-cols-2  w-full">
                  {/* Pincode Input */}
                  <input
                    type="text"
                    name="pincode"
                    value={formData.pincode}
                    onChange={handleInputChange}
                    className="w-full h-[44px] px-3 flex items-center text-[#545454] bg-[#E7EFF8]/60 border border-white/20 rounded-bl-[12px] outline-none"
                    placeholder="Pincode"
                  />
                  {/* Country Dropdown */}
                  <div className="relative" ref={countryDropdownRef}>
                    <input
                      type="text"
                      name="countrySearch"
                      value={countrySearchTerm}
                      onChange={handleCountrySearchChange}
                      onFocus={() => setCountryDropdownOpen(true)}
                      onBlur={() => setCountryDropdownOpen(false)}
                      className="w-full h-[44px] px-4 bg-[#E7EFF8]/60 border border-white/20  outline-none text-[#545454] placeholder-[#545454] rounded-br-[12px] text-[16px]"
                      placeholder="Select Country"
                      autoComplete="off"
                    />
                    {countryDropdownOpen && ( // Show dropdown when open
                      <div className="absolute z-10 custom-scrollbar w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                        {filteredCountriesMemo.length > 0 ? (
                          filteredCountriesMemo.map((country) => (
                            <div
                              key={country.isoCode}
                              className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                              onClick={() => handleCountrySelect(country)}
                              onMouseDown={(e) => e.preventDefault()}
                            >
                              {country.name}
                            </div>
                          ))
                        ) : (
                          <div className="p-3 text-gray-500">
                            No countries found
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>

            {/* Bank Details Section (styled like Address) */}
            <div className="space-y-1 md:col-span-2">
              <label className="block text-[#4B5563] text-sm font-medium">
                Bank Details
              </label>
              <div className="w-full rounded-[12px] border border-white/20 flex flex-col">
                <input
                  type="text"
                  name="bankName"
                  value={formData.bankName}
                  onChange={handleInputChange}
                  className="w-full h-[44px] px-3 flex items-center text-[#545454] border-b bg-[#E7EFF8]/60 border border-white/20 outline-none rounded-t-[12px]"
                  placeholder="Bank Name"
                />
                {/* Two-column grid for Account Name/IFSC and Account No/Bank Branch */}
                <div className="grid grid-cols-2  w-full">
                  <input
                    type="text"
                    name="accountName"
                    value={formData.accountName}
                    onChange={handleInputChange}
                    className="w-full h-[44px] px-3 flex items-center text-[#545454] border-b bg-[#E7EFF8]/60 border border-white/20 outline-none rounded-none "
                    placeholder="Account Name"
                    style={{ borderTopLeftRadius: 0, borderTopRightRadius: 0 }}
                  />
                  <input
                    type="text"
                    name="ifscCode"
                    value={formData.ifscCode}
                    onChange={handleInputChange}
                    className="w-full h-[44px] px-3 rounded-br-[12px] flex items-center text-[#545454] bg-[#E7EFF8]/60 border border-white/20 outline-none rounded-none"
                    placeholder="IFSC Code"
                  />
                </div>
                <div className="grid grid-cols-2 w-full">
                  <input
                    type="text"
                    name="accountNo"
                    value={formData.accountNo}
                    onChange={handleInputChange}
                    className="w-full h-[44px] px-3 rounded-bl-[12px] flex items-center text-[#545454] bg-[#E7EFF8]/60 border border-white/20 outline-none rounded-none"
                    placeholder="Account Number"
                  />
                  <input
                    type="text"
                    name="bankBranch"
                    value={formData.bankBranch}
                    onChange={handleInputChange}
                    className="w-full h-[44px] px-3 rounded-br-[12px] flex items-center text-[#545454] bg-[#E7EFF8]/60 border border-white/20 outline-none rounded-none"
                    placeholder="Bank Branch"
                  />
                </div>
              </div>
            </div>
            {/* Terms and Conditions Section */}
            <div className="md:col-span-2 space-y-1 mb-5">
              <label className="block text-[#4B5563] text-sm font-medium">
                Terms and Conditions
              </label>
              <div className="flex gap-2 mb-2">
                <textarea
                  value={newTerm}
                  onChange={(e) => setNewTerm(e.target.value)}
                  className="flex-1 h-[44px] px-3 py-2 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 outline-none text-[#545454] placeholder-[#545454] resize"
                  placeholder="Add a term and press +"
                />
                <button
                  type="button"
                  onClick={handleAddTerm}
                  className={`h-[44px] px-4 bg-[#ef7e1b] text-white rounded-[10px] transition-colors ${
                    !newTerm.trim()
                      ? "opacity-50 cursor-not-allowed bg-[#ef7e1b]" // disabled look
                      : "hover:bg-[#ee7f1b]"
                  }`}
                  title="Add Term"
                  disabled={!newTerm.trim()}
                >
                  +
                </button>
              </div>
              <div className="space-y-2">
                {(formData.terms || []).map((term, idx) => (
                  <div key={idx} className="flex gap-2 items-start">
                    <textarea
                      value={term}
                      onChange={(e) => {
                        const updatedTerms = [...formData.terms];
                        updatedTerms[idx] = e.target.value;
                        setFormData((prev) => ({
                          ...prev,
                          terms: updatedTerms,
                        }));
                      }}
                      className="flex-1 min-h-[44px] px-3 py-2 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 outline-none text-[#545454] placeholder-[#545454] resize"
                    />
                    <button
                      type="button"
                      onClick={() => handleRemoveTerm(idx)}
                      className="h-[44px] px-3 text-red-500 rounded-[10px] hover:bg-red-700 hover:text-white transition-colors text-xs "
                      title="Remove"
                    >
                      <RxCross2 size={18} />
                    </button>
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Digital Seal Upload */}
          <div className="md:col-span-2 flex flex-col md:flex-row items-center gap-4 md:gap-6 mb-4">
            <div className="relative flex-shrink-0">
              {digitalSealPreview ? (
                <div
                  className={`w-24 h-24 rounded-md overflow-hidden flex items-center justify-center ${
                    digitalSealPreview.endsWith("/dummyavatar.jpeg")
                      ? "bg-[#8CBFEC]"
                      : ""
                  }`}
                >
                  <img
                    src={digitalSealPreview}
                    alt="Digital Seal Preview"
                    className="w-full h-full object-cover"
                    onError={handleImageError}
                  />
                </div>
              ) : (
                <div className="w-24 h-24 rounded-md bg-gray-300 animate-pulse" />
              )}
              <label
                htmlFor="digital-seal-upload"
                className="absolute bottom-0 right-0 cursor-pointer"
              >
                <EditIcon />
                <input
                  id="digital-seal-upload"
                  name="upload_seal"
                  type="file"
                  accept="image/png, image/jpeg"
                  className="hidden"
                  onChange={handleDigitalSealChange}
                />
              </label>
            </div>
            <div className="text-xs md:text-sm text-[#4B5563] text-center md:text-left">
              <p>Upload your Digital Seal by clicking the image beside.</p>
              <p>Recommended size: 288x288 px in PNG or JPG format only.</p>
            </div>
          </div>

          {/* Save button */}
          <div className="mt-6 flex justify-end">
            <button
              type="submit"
              className="w-full md:w-[207px] h-[44px] bg-[#ef7e1b] text-white rounded-[10px] hover:bg-[#ee7f1b] transition-colors"
            >
              Update Details
            </button>
          </div>
        </form>
      </div>

      {/* Header Section */}
      <div className={`p-4 md:p-6 bg-gradient-to-br from-white to-[#E7F4FF] rounded-[10px] shadow-[2px_2px_6px_rgba(24,95,235,0.1)] mb-8 ${
        isCollapsed ? "lg:max-w-[85vw] md:w-[85vw]" : "lg:max-w-[75vw] md:w-[80vw]"
      }`}>
        <h2 className="text-[22px] font-medium text-[#1F2837] mb-4">
          Organisation Details
        </h2>

        {/* Organisation List Table for Desktop */}
        <div className="hidden md:block w-full overflow-x-auto custom-scrollbar">
          <table className="w-full min-w-[1000px] border-collapse  ">
            <thead>
              <tr className="text-left text-[#4B5563]">
                <th className="py-4 px-6 font-medium text-sm">Company</th>
                {/* Removed Address column header */}
                <th className="py-4 px-6 font-medium text-sm">Bank Details</th>
                <th className="py-4 px-6 font-medium text-sm">
                  Terms & Conditions
                </th>
                <th className="py-4 px-6 font-medium text-sm">Digital Seal</th>
              </tr>
            </thead>
            <tbody>
              <tr className="border-t border-[#E5E7EB]">
                <td className="py-4 px-6 text-sm text-[#4B5563] flex flex-col gap-2 items-start">
                  <div className="flex items-center gap-3">
                    {organisation.profile_image ? (
                      <img
                        src={organisation.profile_image}
                        alt="Organisation Logo"
                        className="w-10 h-10 rounded-full object-cover flex-shrink-0 items-center"
                      />
                    ) : (
                      <div className="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-gray-500 text-xs flex-shrink-0">
                        No Logo
                      </div>
                    )}
                    <div>
                      <span className="whitespace-nowrap font-semibold block">
                        {organisation.name}
                      </span>
                      <span className="block text-xs text-gray-500 break-all">
                        {organisation.email}
                      </span>
                      <span className="block text-xs text-gray-500">
                        {organisation.phoneno}
                      </span>
                    </div>
                  </div>
                  {/* Address below company info */}
                  <div className="text-xs text-gray-600 mt-2 ml-14">
                    {(() => {
                      try {
                        const addressObj = JSON.parse(organisation.address);
                        return (
                          <>
                            <span className="block">
                              {addressObj.blockUnitStreetName}
                            </span>
                            <span>
                              {addressObj.city && `${addressObj.city}, `}
                              {addressObj.state}
                            </span>
                            <br />
                            <span>
                              {addressObj.pincode}
                              {addressObj.country && `, ${addressObj.country}`}
                            </span>
                          </>
                        );
                      } catch (e) {
                        console.error("Error parsing address for display:", e);
                        return organisation.address; // Fallback to original if parsing fails
                      }
                    })()}
                  </div>
                </td>
                {/* Removed Address <td> */}
                {/* Bank Details column */}
                <td className="py-4 px-6 text-sm text-[#4B5563]">
                  {organisation.bankName || organisation.bank_name ? (
                    <div className="grid grid-cols-[max-content_1fr] gap-x-2">
                      <strong>Bank Name:</strong>
                      <span>
                        {organisation.bankName || organisation.bank_name}
                      </span>
                      <strong>Account Name:</strong>
                      <span>
                        {organisation.accountName || organisation.account_name}
                      </span>
                      <strong>IFSC Code:</strong>
                      <span>
                        {organisation.ifscCode || organisation.ifsc_code}
                      </span>
                      <strong>Account No:</strong>
                      <span>
                        {organisation.accountNo || organisation.account_no}
                      </span>
                      <strong>Branch:</strong>
                      <span>
                        {organisation.bankBranch || organisation.bank_branch}
                      </span>
                    </div>
                  ) : (
                    <span className="text-gray-500">No Bank Details</span>
                  )}
                </td>
                {/* Terms & Conditions column */}
                <td className="py-4 px-6 text-sm text-[#4B5563] whitespace-pre-wrap">
                  {(() => {
                    let terms = [];
                    if (organisation.terms && organisation.terms.length > 0) {
                      terms = organisation.terms;
                    } else if (organisation.term_info) {
                      try {
                        let termsObj = organisation.term_info;
                        if (typeof termsObj === "string") {
                          termsObj = JSON.parse(termsObj);
                          if (typeof termsObj === "string") {
                            termsObj = JSON.parse(termsObj);
                          }
                        }
                        terms = Object.values(termsObj);
                      } catch {}
                    }
                    return terms.length > 0 ? (
                      <ul className="list-disc pl-4">
                        {terms.map((term, idx) => (
                          <li key={idx}>{term}</li>
                        ))}
                      </ul>
                    ) : (
                      <span className="text-gray-500">No Terms</span>
                    );
                  })()}
                </td>
                <td className="py-4 px-6 text-sm text-[#4B5563]">
                  {organisation.digital_seal ? (
                    <img
                      src={organisation.digital_seal}
                      alt="Digital Seal"
                      className="h-16 w-auto object-contain"
                    />
                  ) : (
                    <span className="text-gray-500">No Seal</span>
                  )}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        {/* Organisation Card for Mobile */}
        <div className="md:hidden w-full space-y-4 pb-24">
          <div className=" rounded-lg shadow p-4 border border-gray-200/80 ">
            <div className="flex justify-between items-start">
              {/* Combined Logo and Name */}
              <div className="flex items-center gap-3 pr-2 flex-grow">
                {organisation.profile_image ? (
                  <img
                    src={organisation.profile_image}
                    alt="Organisation Logo"
                    className="w-16 h-16 rounded-full object-cover flex-shrink-0"
                  />
                ) : (
                  <div className="w-16 h-16 rounded-full bg-gray-300 flex items-center justify-center text-gray-500 text-xs flex-shrink-0">
                    No Logo
                  </div>
                )}
                <div className="space-y-1">
                  <p className="font-bold text-lg text-[#1F2837]">
                    {organisation.name}
                  </p>
                  <p className="text-sm text-gray-500 break-all">
                    {organisation.email}
                  </p>
                  <p className="text-sm text-gray-500">
                    {organisation.phoneno}
                  </p>
                </div>
              </div>
            </div>
            <div className="mt-4 space-y-8 text-sm">
              <div>
                <span className="font-medium text-gray-600">Address: </span>
                <span className="text-gray-800 whitespace-pre-wrap">
                  {(() => {
                    try {
                      const addressObj = JSON.parse(organisation.address);
                      return (
                        <>
                          <strong className="block">
                            {addressObj.blockUnitStreetName}
                          </strong>
                          <span>
                            {addressObj.city && `${addressObj.city}, `}
                            {addressObj.state}
                          </span>
                          <br />
                          <span>
                            {addressObj.pincode}
                            {addressObj.country && `, ${addressObj.country}`}
                          </span>
                        </>
                      );
                    } catch (e) {
                      console.error("Error parsing address for display:", e);
                      return organisation.address; // Fallback to original if parsing fails
                    }
                  })()}
                </span>
              </div>
              {/* Bank Details for mobile */}
              <div>
                <span className="font-medium text-gray-600">
                  Bank Details:{" "}
                </span>
                <div className="text-gray-800 mt-1">
                  {organisation.bankName || organisation.bank_name ? (
                    <div className="grid grid-cols-[max-content_1fr] gap-x-2">
                      <strong>Bank Name:</strong>
                      <span>
                        {organisation.bankName || organisation.bank_name}
                      </span>
                      <strong>Account Name:</strong>
                      <span>
                        {organisation.accountName || organisation.account_name}
                      </span>
                      <strong>IFSC:</strong>
                      <span>
                        {organisation.ifscCode || organisation.ifsc_code}
                      </span>
                      <strong>Account No:</strong>
                      <span>
                        {organisation.accountNo || organisation.account_no}
                      </span>
                      <strong>Branch:</strong>
                      <span>
                        {organisation.bankBranch || organisation.bank_branch}
                      </span>
                    </div>
                  ) : (
                    <span className="text-gray-500">No Bank Details</span>
                  )}
                </div>
              </div>
              {/* Terms & Conditions for mobile */}
              <div>
                <span className="font-medium text-gray-600">
                  Terms & Conditions:{" "}
                </span>
                <span className="text-gray-800 whitespace-pre-wrap">
                  {(() => {
                    let terms = [];
                    if (organisation.terms && organisation.terms.length > 0) {
                      terms = organisation.terms;
                    } else if (organisation.term_info) {
                      try {
                        let termsObj = organisation.term_info;
                        if (typeof termsObj === "string") {
                          termsObj = JSON.parse(termsObj);
                          if (typeof termsObj === "string") {
                            termsObj = JSON.parse(termsObj);
                          }
                        }
                        terms = Object.values(termsObj);
                      } catch {}
                    }
                    return terms.length > 0 ? (
                      <ul className="list-disc pl-4">
                        {terms.map((term, idx) => (
                          <li key={idx}>{term}</li>
                        ))}
                      </ul>
                    ) : (
                      <span className="text-gray-500">No Terms</span>
                    );
                  })()}
                </span>
              </div>
              <div>
                <span className="font-medium text-gray-600">
                  Digital Seal:{" "}
                </span>
                {organisation.digital_seal ? (
                  <img
                    src={organisation.digital_seal}
                    alt="Digital Seal"
                    className="h-16 w-auto object-contain inline-block ml-2"
                  />
                ) : (
                  <span className="text-gray-800">No Seal</span>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default OrganisationInfo;
</file>

<file path="src/pages/quotation/View.jsx">
import React, { useState, useEffect, useRef, useContext } from "react";
import {
  FiChevronDown,
  FiEdit,
  FiUpload,
  FiDownload,
  FiTrash2,
} from "react-icons/fi";
import { TbDotsVertical } from "react-icons/tb";
import api from "../../api";
import Swal from "sweetalert2";
import { FaCheck } from "react-icons/fa6";
import { useParams, useNavigate } from "react-router-dom"; // Import useParams and useNavigate
import { RxCross2 } from "react-icons/rx";

import "../../styles/scrollbar.css";
import { form } from "motion/react-client";
import { SidebarContext } from "../../components/Layout";

const ViewQuotation = () => {
  const { statusId, statusName } = useParams(); // Get statusId and statusName from URL
  const navigate = useNavigate(); // Initialize navigate

  const dynamicApiEndpoint = statusId
    ? `/leadstatus/${statusId}`
    : "/showquotation";
  const dynamicHeaderTitle = "All Quotation List";
  const dynamicModalTitle = statusName
    ? `Edit ${decodeURIComponent(statusName)} Item`
    : "Edit Quotation";

  // Mobile detection and search state
  const [isMobile, setIsMobile] = useState(() => window.innerWidth < 768);
  const [isSearchExpanded, setIsSearchExpanded] = useState(false);
  const [quotations, setQuotations] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // Consume SidebarContext
  const { isCollapsed } = useContext(SidebarContext);

  // Search, filter, and pagination state
  const [searchTerm, setSearchTerm] = useState("");
  const [filters, setFilters] = useState({
    customerName: "all",
    email: "all",
    payment: "all", // New payment filter
    itemCount: "all", // New item count filter
    createdDateRange: "all", // New Created Date Range Filter
    updatedDateRange: "all", // New Updated At Date Range Filter
  });
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10);

  // Checkbox selection state for bulk operations
  const [selectedLeads, setSelectedLeads] = useState([]);
  const [isBulkEditModalOpen, setIsBulkEditModalOpen] = useState(false);
  const [bulkStatus, setBulkStatus] = useState("Inprogress"); // Add bulk status state

  // New state for dropdown and modal
  const [activeDropdown, setActiveDropdown] = useState(null);
  const [editingQuotation, setEditingQuotation] = useState(null);
  const [formData, setFormData] = useState({
    client_name: "",
    client_address: "",
    package_type: "",
    plot_size: "",
  });

  const [serviceItems, setServiceItems] = useState([
    {
      item_name: "",
      qty: 1,
      amount: 0,
    },
  ]);

  // Add state for expanded row to show all items
  const [expandedQuotationId, setExpandedQuotationId] = useState(null);

  // New state for modal to display items and calculate net total for each quotation
  const [selectedItems, setSelectedItems] = useState(null);
  const [isItemsModalOpen, setIsItemsModalOpen] = useState(false);

  // New state for "Created" date filter
  const [createdDateRangeDropdownOpen, setCreatedDateRangeDropdownOpen] =
    useState(false);
  const [createdTimeRange, setCreatedTimeRange] = useState("all"); // 'all', '7days', '30days', '90days', 'custom'
  const [customCreatedDateRange, setCustomCreatedDateRange] = useState({
    fromDate: null,
    toDate: null,
  });

  // New state for "Updated At" date filter
  const [updatedDateRangeDropdownOpen, setUpdatedDateRangeDropdownOpen] =
    useState(false);
  const [updatedTimeRange, setUpdatedTimeRange] = useState("all"); // 'all', '7days', '30days', '90days', 'custom'
  const [customUpdatedDateRange, setCustomUpdatedDateRange] = useState({
    fromDate: null,
    toDate: null,
  });

  // Ref for the Created date range dropdown
  const createdDateRangeDropdownRef = useRef(null);

  // Ref for the Updated At date range dropdown
  const updatedDateRangeDropdownRef = useRef(null);

  // Add refs and state for custom dropdowns (for UI only)
  const customerNameDropdownRef = useRef(null);
  const emailDropdownRef = useRef(null);
  const paymentDropdownRef = useRef(null);
  const itemCountDropdownRef = useRef(null);
  const [activeFilterDropdown, setActiveFilterDropdown] = useState(null);
  const itemsPerPageDropdownRef = useRef(null);
  const [isItemsPerPageDropdownOpen, setIsItemsPerPageDropdownOpen] =
    useState(false);

  useEffect(() => {
    const fetchQuotations = async () => {
      try {
        const response = await api.get(dynamicApiEndpoint); // Use dynamicApiEndpoint
        if (response.data.success) {
          setQuotations(response.data.data); // Access data.data for quotations
        } else {
          setError("Failed to fetch ");
        }
      } catch (err) {
        setError("Error fetching : " + err.message);
      } finally {
        setLoading(false);
      }
    };

    fetchQuotations();
  }, [dynamicApiEndpoint]); // Depend on dynamicApiEndpoint

  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth < 768);
      if (window.innerWidth >= 768) {
        setIsSearchExpanded(false);
      }
    };
    checkMobile();
    window.addEventListener("resize", checkMobile);
    return () => window.removeEventListener("resize", checkMobile);
  }, []);

  // Helper function to recursively search all fields in an object for a search term
  const objectContainsSearchTerm = (obj, searchLower) => {
    if (obj == null) return false;
    if (typeof obj === "string" || typeof obj === "number") {
      return String(obj).toLowerCase().includes(searchLower);
    }
    if (Array.isArray(obj)) {
      return obj.some((item) => objectContainsSearchTerm(item, searchLower));
    }
    if (typeof obj === "object") {
      return Object.values(obj).some((value) =>
        objectContainsSearchTerm(value, searchLower)
      );
    }
    return false;
  };

  // Helper function to format date for display
  const formatDateForDisplay = (date) => {
    if (!date) return "";
    return new Date(date).toLocaleDateString("en-US", {
      month: "short",
      day: "numeric",
      year: "numeric",
    });
  };

  // Helper function to calculate days remaining until valid_until
  const calculateDaysRemaining = (validUntilDate) => {
    if (!validUntilDate) return "";
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const validDate = new Date(validUntilDate);
    validDate.setHours(0, 0, 0, 0);
    const diffTime = validDate.getTime() - today.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays < 0) {
      return "Expired";
    } else if (diffDays === 0) {
      return "Today";
    } else if (diffDays === 1) {
      return "1 day remaining";
    } else {
      return `${diffDays} days remaining`;
    }
  };

  // Handler for predefined date range selection
  const handleCreatedTimeRangeChange = (range) => {
    setCreatedTimeRange(range);
    setCreatedDateRangeDropdownOpen(false);
    if (range === "custom") {
      // Keep custom range dates if already set, otherwise null
      setCustomCreatedDateRange((prev) => ({
        fromDate: prev.fromDate,
        toDate: prev.toDate,
      }));
    } else {
      setCustomCreatedDateRange({ fromDate: null, toDate: null });
    }
  };

  // Handler for custom date input changes
  const handleCustomCreatedDateChange = (field, value) => {
    setCustomCreatedDateRange((prev) => ({
      ...prev,
      [field]: value ? new Date(value) : null,
    }));
  };

  // Apply custom date range
  const applyCustomCreatedDateRange = () => {
    setCreatedTimeRange("custom");
    setCreatedDateRangeDropdownOpen(false);
  };

  // Handler for predefined updated date range selection
  const handleUpdatedTimeRangeChange = (range) => {
    setUpdatedTimeRange(range);
    setUpdatedDateRangeDropdownOpen(false);
    if (range === "custom") {
      setCustomUpdatedDateRange((prev) => ({
        fromDate: prev.fromDate,
        toDate: prev.toDate,
      }));
    } else {
      setCustomUpdatedDateRange({ fromDate: null, toDate: null });
    }
  };

  // Handler for custom updated date input changes
  const handleCustomUpdatedDateChange = (field, value) => {
    setCustomUpdatedDateRange((prev) => ({
      ...prev,
      [field]: value ? new Date(value) : null,
    }));
  };

  // Apply custom updated date range
  const applyCustomUpdatedDateRange = () => {
    setUpdatedTimeRange("custom");
    setUpdatedDateRangeDropdownOpen(false);
  };

  // Close dropdown on outside click
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        createdDateRangeDropdownRef.current &&
        !createdDateRangeDropdownRef.current.contains(event.target)
      ) {
        setCreatedDateRangeDropdownOpen(false);
      }
      // Close updated date range dropdown
      if (
        updatedDateRangeDropdownRef.current &&
        !updatedDateRangeDropdownRef.current.contains(event.target)
      ) {
        setUpdatedDateRangeDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [createdDateRangeDropdownRef, updatedDateRangeDropdownRef]);

  // Filter quotations based on search term and filter criteria
  const filteredQuotations = quotations.filter((quotation) => {
    const searchLower = searchTerm.toLowerCase();

    // Calculate net total for this quotation
    const netTotal = parseFloat(quotation.grand_total || 0); // Use grand_total directly

    // Search across all fields using the helper, and also check net total
    const matchesSearch =
      !searchTerm ||
      objectContainsSearchTerm(quotation, searchLower) ||
      String(netTotal).toLowerCase().includes(searchLower);

    const matchesCustomerName =
      filters.customerName === "all" ||
      quotation?.client_name
        ?.toLowerCase()
        ?.includes(filters.customerName.toLowerCase());

    const matchesEmail =
      filters.email === "all" ||
      quotation?.client_address
        ?.toLowerCase()
        ?.includes(filters.email.toLowerCase());

    // Created date filter logic
    let matchesCreatedDate = true;
    if (createdTimeRange !== "all") {
      const createdAtDate = new Date(quotation.created_at);
      const now = new Date();

      if (createdTimeRange === "custom") {
        const from = customCreatedDateRange.fromDate;
        const to = customCreatedDateRange.toDate;
        if (from && to) {
          matchesCreatedDate =
            createdAtDate >= from &&
            createdAtDate <= new Date(to.setHours(23, 59, 59, 999)); // End of day
        } else if (from) {
          matchesCreatedDate = createdAtDate >= from;
        } else if (to) {
          matchesCreatedDate =
            createdAtDate <= new Date(to.setHours(23, 59, 59, 999));
        }
      } else {
        let daysAgo;
        if (createdTimeRange === "7days") daysAgo = 7;
        else if (createdTimeRange === "30days") daysAgo = 30;
        else if (createdTimeRange === "90days") daysAgo = 90;

        if (daysAgo) {
          const cutoffDate = new Date(now);
          cutoffDate.setDate(now.getDate() - daysAgo);
          matchesCreatedDate = createdAtDate >= cutoffDate;
        }
      }
    }

    // Updated At date filter logic
    let matchesUpdatedDate = true;
    if (updatedTimeRange !== "all") {
      const updatedAtDate = new Date(quotation.updated_at);
      const now = new Date();

      if (updatedTimeRange === "custom") {
        const from = customUpdatedDateRange.fromDate;
        const to = customUpdatedDateRange.toDate;
        if (from && to) {
          matchesUpdatedDate =
            updatedAtDate >= from &&
            updatedAtDate <= new Date(to.setHours(23, 59, 59, 999)); // End of day
        } else if (from) {
          matchesUpdatedDate = updatedAtDate >= from;
        } else if (to) {
          matchesUpdatedDate =
            updatedAtDate <= new Date(to.setHours(23, 59, 59, 999));
        }
      } else {
        let daysAgo;
        if (updatedTimeRange === "7days") daysAgo = 7;
        else if (updatedTimeRange === "30days") daysAgo = 30;
        else if (updatedTimeRange === "90days") daysAgo = 90;

        if (daysAgo) {
          const cutoffDate = new Date(now);
          cutoffDate.setDate(now.getDate() - daysAgo);
          matchesUpdatedDate = updatedAtDate >= cutoffDate;
        }
      }
    }

    // Payment filter logic
    let matchesPayment = true;
    switch (filters.payment) {
      case "lt50000":
        matchesPayment = netTotal < 50000;
        break;
      case "50001-100000":
        matchesPayment = netTotal >= 50001 && netTotal <= 100000;
        break;
      case "100001-400000":
        matchesPayment = netTotal >= 100001 && netTotal <= 400000;
        break;
      case "400001-500000":
        matchesPayment = netTotal >= 400001 && netTotal <= 500000;
        break;
      case "gt500000":
        matchesPayment = netTotal > 500000;
        break;
      default:
        matchesPayment = true;
    }

    // Item count filter logic
    const itemCount = quotation.items ? quotation.items.length : 0;
    let matchesItemCount = true;
    switch (filters.itemCount) {
      case "1-5":
        matchesItemCount = itemCount >= 1 && itemCount <= 5;
        break;
      case "6-20":
        matchesItemCount = itemCount >= 6 && itemCount <= 20;
        break;
      case "21-50":
        matchesItemCount = itemCount >= 21 && itemCount <= 50;
        break;
      case "51-100":
        matchesItemCount = itemCount >= 51 && itemCount <= 100;
        break;
      case "gt100":
        matchesItemCount = itemCount > 100;
        break;
      default:
        matchesItemCount = true;
    }

    return (
      matchesSearch &&
      matchesCustomerName &&
      matchesEmail &&
      matchesPayment &&
      matchesItemCount &&
      matchesCreatedDate &&
      matchesUpdatedDate
    );
  });

  // Helper function for form validation
  const validateFormData = (data) => {
    const errors = [];

    if (!data.customer_name || data.customer_name.trim() === "") {
      errors.push("Customer Name is required.");
    }
    if (!data.email || data.email.trim() === "") {
      errors.push("Email is required.");
    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
      errors.push("Please enter a valid email address.");
    }
    if (!data.contact_number || data.contact_number.trim() === "") {
      errors.push("Contact Number is required.");
    } else if (!/^\d{10}$/.test(data.contact_number)) {
      errors.push("Contact Number must be 10 digits.");
    }
    if (!data.address || data.address.trim() === "") {
      errors.push("Address is required.");
    }

    return errors;
  };

  // Calculate pagination
  const totalPages = Math.ceil(filteredQuotations.length / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const currentQuotations = filteredQuotations.slice(startIndex, endIndex);

  // Reset to first page when search term or filters change
  useEffect(() => {
    setCurrentPage(1);
  }, [searchTerm, filters, createdTimeRange, customCreatedDateRange]);

  const handleSearchToggle = () => {
    setIsSearchExpanded(!isSearchExpanded);
  };

  const handleSearchBlur = () => {
    if (isMobile) {
      setIsSearchExpanded(false);
    }
  };

  const handleSearchChange = (e) => {
    setSearchTerm(e.target.value);
  };

  const handlePreviousPage = () => {
    if (currentPage > 1) {
      setCurrentPage(currentPage - 1);
    }
  };

  const handleNextPage = () => {
    if (currentPage < totalPages) {
      setCurrentPage(currentPage + 1);
    }
  };

  const handleItemsPerPageChange = (newItemsPerPage) => {
    setItemsPerPage(newItemsPerPage);
    setCurrentPage(1);
  };

  // Checkbox handlers for bulk selection
  const toggleQuotationSelection = (quotationId) => {
    setSelectedLeads((prev) =>
      prev.includes(quotationId)
        ? prev.filter((id) => id !== quotationId)
        : [...prev, quotationId]
    );
  };

  const toggleSelectAll = () => {
    if (selectedLeads.length === currentQuotations.length) {
      setSelectedLeads([]);
    } else {
      setSelectedLeads(currentQuotations.map((quotation) => quotation.id));
    }
  };

  const handleBulkDelete = async () => {
    const result = await Swal.fire({
      title: "Are you sure?",
      text: `You are about to delete ${selectedLeads.length} quotation(s). This cannot be undone.`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#DD6B55",
      cancelButtonColor: "#aaa",
      confirmButtonText: "Yes, delete them!",
    });
    if (result.isConfirmed) {
      try {
        // Simulate bulk delete API call; adjust based on actual API
        await Promise.all(
          selectedLeads.map((id) => api.get(`/deletequotation/${id}`)) // Changed endpoint to deletequotation
        );
        setQuotations((prev) =>
          prev.filter((quotation) => !selectedLeads.includes(quotation.id))
        );
        setSelectedLeads([]);
        await Swal.fire({
          icon: "success",
          title: "Quotations Deleted!",
          text: "Selected  have been removed.",
          confirmButtonColor: "#2798FF",
        });
      } catch (err) {
        Swal.fire({
          icon: "error",
          title: "Bulk Delete Failed",
          text: err.message || "An error occurred during deletion.",
          confirmButtonColor: "#DD6B55",
        });
      }
    }
  };

  // Filter handlers
  const handleFilterChange = (filterName, value) => {
    setFilters((prev) => ({
      ...prev,
      [filterName]: value,
    }));
    setCurrentPage(1);
  };

  // New handlers for dropdown and modal
  const toggleDropdown = (quotationId) => {
    setActiveDropdown(activeDropdown === quotationId ? null : quotationId);

    // If we're opening the dropdown, scroll it into view
    if (activeDropdown !== quotationId) {
      // Use setTimeout to ensure the dropdown is rendered before scrolling
      setTimeout(() => {
        const dropdownElement = document.querySelector(
          `[data-dropdown-id="${quotationId}"]`
        );
        if (dropdownElement) {
          dropdownElement.scrollIntoView({
            behavior: "smooth",
            block: "nearest",
          });
        }
      }, 0);
    }
  };

  const handleEdit = (quotation) => {
    // Navigate to QuotationCreate.jsx with the quotation data (deep clone to ensure serializability)
    navigate("/quotation/create", {
      state: { quotation: JSON.parse(JSON.stringify(quotation)) },
    });
  };

  const handleInputChange = (field, value) => {
    setFormData((prev) => ({
      ...prev,
      [field]: value,
    }));
  };

  // DELETE
  const handleDelete = async (id) => {
    const result = await Swal.fire({
      title: "Are you sure?",
      text: "This cannot be undone.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#DD6B55",
      cancelButtonColor: "#aaa",
      confirmButtonText: "Yes, delete it!",
    });
    if (result.isConfirmed) {
      try {
        const response = await api.get(`/deletequotation/${id}`); // Changed endpoint to deletequotation
        if (response.data.status || response.data.success) {
          setQuotations((prev) => prev.filter((q) => q.id !== id));
          await Swal.fire({
            icon: "success",
            title: "Quotation Deleted!",
            text: response.data.message || "Quotation has been removed.",
            confirmButtonColor: "#2798FF",
          });
        } else {
          throw new Error(response.data.message || "Server rejected delete");
        }
      } catch (err) {
        Swal.fire({
          icon: "error",
          title: "Delete Quotation Failed",
          text: err.message,
          confirmButtonColor: "#DD6B55",
        });
      }
    }
    setActiveDropdown(null);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      // Assuming the API for update expects the new field names directly or maps them internally
      const response = await api.post(
        `/updatequotation/${editingQuotation.id}`,
        {
          client_name: formData.client_name,
          client_address: formData.client_address,
          package_type: formData.package_type,
          plot_size: formData.plot_size,
          items: serviceItems.map((item) => ({
            item_name: item.item_name,
            qty: item.qty,
            rate: parseFloat(item.amount / item.qty).toFixed(2), // Calculate rate from amount and qty
            amount: parseFloat(item.amount).toFixed(2),
          })),
          grand_total: calculateTotalServiceCharge(), // Assuming this maps to grand_total
        }
      );

      if (response.status === 200) {
        // Update the quotations list with the edited data
        setQuotations(
          quotations.map((q) =>
            q.id === editingQuotation.id
              ? {
                  ...q,
                  ...formData,
                  // Update items and grand_total for the displayed quotation
                  items: serviceItems.map((item) => ({
                    item_name: item.item_name,
                    qty: item.qty,
                    rate: parseFloat(item.amount / item.qty).toFixed(2),
                    amount: parseFloat(item.amount).toFixed(2),
                  })),
                  grand_total: calculateTotalServiceCharge().toFixed(2),
                }
              : q
          )
        );
        Swal.fire({
          icon: "success",
          title: "Quotation Updated",
          text:
            response.data.message ||
            `${formData.client_name} was successfully updated.`,
          confirmButtonColor: "#2798FF",
        });
      } else {
        throw new Error(response.data.message || "Failed to update");
      }
    } catch (err) {
      let errorTitle = "Error Updating Quotation";
      let errorMessage =
        "An error occurred while updating the quotation. Please try again.";

      if (err.response) {
        if (err.response.status === 422) {
          const errors = err.response.data.errors;
          if (errors) {
            const firstError = Object.values(errors)[0];
            if (Array.isArray(firstError) && firstError.length > 0) {
              errorMessage = firstError[0];
            }
          }
        } else if (err.response.data?.message) {
          errorMessage = err.response.data.message;
        }
      } else if (err.request) {
        errorTitle = "Network Error";
        errorMessage =
          "Unable to connect to the server. Please check your internet connection.";
      } else {
        errorMessage = err.message;
      }

      await Swal.fire({
        icon: "error",
        title: errorTitle,
        text: errorMessage,
        confirmButtonColor: "#DD6B55",
      });
    }
    setActiveDropdown(null);
  };

  // Cleanup image preview URLs when component unmounts - Removed as per new requirements
  useEffect(() => {
    // No image preview to clean up
    return () => {};
  }, []);

  // Helper function to calculate net total
  const calculateNetTotal = (items) => {
    return items
      .reduce((sum, item) => sum + parseFloat(item.amount || 0), 0)
      .toFixed(2);
  };

  // Function to open items modal
  const handleShowItems = (items, e) => {
    e.stopPropagation();
    setSelectedItems(items);
    setIsItemsModalOpen(true);
  };

  // Handle service item changes
  const handleServiceItemChange = (index, field, value) => {
    const updatedItems = [...serviceItems];
    if (field === "qty") {
      updatedItems[index][field] = Math.max(0, parseInt(value) || 0);
    } else if (field === "amount") {
      updatedItems[index][field] = Math.max(0, parseFloat(value) || 0);
    } else {
      updatedItems[index][field] = value;
    }
    setServiceItems(updatedItems);
  };

  // Add new service item
  const addServiceItem = () => {
    setServiceItems([
      ...serviceItems,
      {
        item_name: "",
        qty: 1,
        amount: 0,
      },
    ]);
  };

  // Remove service item
  const removeServiceItem = (index) => {
    const updatedItems = serviceItems.filter((_, i) => i !== index);
    setServiceItems(updatedItems);
  };

  // Calculate total service charge
  const calculateTotalServiceCharge = () => {
    return serviceItems.reduce((total, item) => {
      const itemTotal = parseFloat(item.amount) || 0;
      return total + itemTotal;
    }, 0);
  };

  useEffect(() => {
    const handleClickOutside = (event) => {
      // Filters
      if (
        activeFilterDropdown === "customerName" &&
        customerNameDropdownRef.current &&
        !customerNameDropdownRef.current.contains(event.target)
      ) {
        setActiveFilterDropdown(null);
      }
      if (
        activeFilterDropdown === "email" &&
        emailDropdownRef.current &&
        !emailDropdownRef.current.contains(event.target)
      ) {
        setActiveFilterDropdown(null);
      }
      if (
        activeFilterDropdown === "payment" &&
        paymentDropdownRef.current &&
        !paymentDropdownRef.current.contains(event.target)
      ) {
        setActiveFilterDropdown(null);
      }
      if (
        activeFilterDropdown === "itemCount" &&
        itemCountDropdownRef.current &&
        !itemCountDropdownRef.current.contains(event.target)
      ) {
        setActiveFilterDropdown(null);
      }
      // Pagination dropdown
      if (
        isItemsPerPageDropdownOpen &&
        itemsPerPageDropdownRef.current &&
        !itemsPerPageDropdownRef.current.contains(event.target)
      ) {
        setIsItemsPerPageDropdownOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [activeFilterDropdown, isItemsPerPageDropdownOpen]);

  if (loading) {
    return (
      <div className="w-full min-h-[797px] flex items-center justify-center">
        Loading Quotations...
      </div>
    );
  }

  return (
    <div
      className={`min-h-[797px] p-4 md:p-6 relative bg-gradient-to-br from-white to-[#E7F4FF] rounded-[10px] shadow-[2px_2px_6px_rgba(24,95,235,0.1)] flex flex-col w-full   ${
        isCollapsed ? "lg:max-w-[85vw] md:w-[85vw]" : "lg:max-w-[75vw] md:w-[80vw]"
      } md:mx-auto`}
    >
      {/* Header Section */}
      <div className="flex flex-wrap items-center justify-between gap-4 mb-8">
        {/* Title */}
        <h1 className="text-[20px] md:text-[22px] font-medium text-[#1F2837] whitespace-nowrap">
          {dynamicHeaderTitle}
        </h1>

        {/* Search Container */}
        <div className="flex-1 max-w-[400px] mx-1">
          {isMobile && !isSearchExpanded ? (
            <button
              onClick={handleSearchToggle}
              className="
          w-10 h-10
          flex items-center
          rounded-[6px]
          hover:bg-gray-50 transition-colors
        "
            >
              {/* search icon SVG */}
              <svg
                width="20"
                height="20"
                viewBox="0 0 22 22"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M10.5417 19.25C15.3512 19.25 19.25 15.3512 19.25 10.5417C19.25 5.73223 15.3512 1.83334 10.5417 1.83334C5.73223 1.83334 1.83334 5.73223 1.33334 10.5417C1.83334 15.3512 5.73223 19.25 10.5417 19.25Z"
                  stroke="#787374"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M18.3333 18.3333L20.1667 20.1667"
                  stroke="#787374"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>
          ) : (
            <div className="relative w-full">
              {/* Search icon inside input */}
              <div className="absolute left-4 top-1/2 -translate-y-1/2 pointer-events-none">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 22 22"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M10.5417 19.25C15.3512 19.25 19.25 15.3512 19.25 10.5417C19.25 5.73223 15.3512 1.83334 10.5417 1.83334C5.73223 1.83334 1.83334 5.73223 1.33334 10.5417C1.83334 15.3512 5.73223 19.25 10.5417 19.25Z"
                    stroke="#787374"
                    strokeWidth="1.5"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                  <path
                    d="M18.3333 18.3333L20.1667 20.1667"
                    stroke="#787374"
                    strokeWidth="1.5"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                </svg>
              </div>
              <input
                type="search"
                placeholder={isMobile ? "Search" : "Search by Name, Contact"}
                value={searchTerm}
                onChange={handleSearchChange}
                className="
            w-full
            h-[44px]
            pl-12 pr-4
            bg-[#E9F1F9]
            rounded-[6px]
            text-[#787374] placeholder-[#787374]
            focus:outline-none
            text-sm md:text-base lg:text-base
          "
                onBlur={handleSearchBlur}
                autoFocus={isMobile && isSearchExpanded}
              />
            </div>
          )}
        </div>

        {/* Actions: Create Lead + Display Dropdown + Bulk Actions */}
        <div className="flex flex-wrap items-center gap-3 md:gap-4 lg:gap-4">
          {selectedLeads.length > 0 && (
            <>
              <button
                className="hover:bg-red-500
            bg-[#DD6B55] text-white
            h-[44px] px-5
            rounded-[8px]
            flex items-center justify-center
          "
                onClick={handleBulkDelete}
              >
                Bulk Delete
              </button>
            </>
          )}
          <span className="text-[#727A90] text-sm md:text-base lg:text-base whitespace-nowrap">
            Show
          </span>
          <div className="relative min-w-[88px]" ref={itemsPerPageDropdownRef}>
            <button
              type="button"
              className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full min-w-[72px] md:min-w-[88px] lg:min-w-[88px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center"
              onClick={() => setIsItemsPerPageDropdownOpen((open) => !open)}
            >
              <span className="truncate text-left flex-1">{itemsPerPage}</span>
              <img
                src="/caret-down.svg"
                alt=""
                aria-hidden="true"
                className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
              />
            </button>
            {isItemsPerPageDropdownOpen && (
              <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
                {[5, 10, 20, 50].map((option) => (
                  <button
                    key={option}
                    type="button"
                    onClick={() => {
                      handleItemsPerPageChange(option);
                      setIsItemsPerPageDropdownOpen(false);
                    }}
                    className={`w-full px-3 py-2 text-left hover:bg-[#E7EFF8] ${
                      itemsPerPage === option
                        ? "bg-[#E7EFF8] font-bold text-[#ef7e1b]"
                        : "text-[#545454]"
                    }`}
                  >
                    {option}
                  </button>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      {/* Filter Section */}
      <div className="grid grid-cols-2 gap-3 mb-2 md:grid-cols-2 lg:grid-cols-4 md:gap-6 w-full">
        {/* Customer Name Dropdown */}
        <div className="relative" ref={customerNameDropdownRef}>
          <button
            type="button"
            className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[120px] lg:min-w-[120px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center"
            onClick={() =>
              setActiveFilterDropdown(
                activeFilterDropdown === "customerName" ? null : "customerName"
              )
            }
          >
            <span className="truncate text-left flex-1">
              {filters.customerName === "all"
                ? "Customer Name"
                : filters.customerName}
            </span>
            {filters.customerName !== "all" && (
              <button
                type="button"
                className="absolute right-7 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 text-lg font-bold focus:outline-none"
                style={{ padding: 0, lineHeight: 1 }}
                tabIndex={-1}
                title="Clear filter"
                onClick={(e) => {
                  e.stopPropagation();
                  handleFilterChange("customerName", "all");
                }}
              >
                <RxCross2 />
              </button>
            )}
            <img
              src="/caret-down.svg"
              alt=""
              aria-hidden="true"
              className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
            />
          </button>
          {activeFilterDropdown === "customerName" && (
            <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
              {Array.from(
                new Set(
                  quotations
                    .map((q) => q.client_name)
                    .filter(Boolean)
                    .map((name) => name.toLowerCase().trim())
                )
              ).map((name) => (
                <button
                  key={name}
                  type="button"
                  onClick={() => {
                    handleFilterChange("customerName", name);
                    setActiveFilterDropdown(null);
                  }}
                  className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer"
                >
                  {name}
                </button>
              ))}
            </div>
          )}
        </div>

        {/* Payment Dropdown */}
        <div className="relative" ref={paymentDropdownRef}>
          <button
            type="button"
            className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[160px] lg:min-w-[160px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center"
            onClick={() =>
              setActiveFilterDropdown(
                activeFilterDropdown === "payment" ? null : "payment"
              )
            }
          >
            <span className="truncate text-left flex-1">
              {filters.payment === "all"
                ? "All Payments"
                : {
                    lt50000: "Less than ₹50,000",
                    "50001-100000": "Between ₹50,001 and ₹1,00,000",
                    "100001-400000": "Between ₹1,00,001 and ₹4,00,000",
                    "400001-500000": "Between ₹4,00,001 and ₹5,00,000",
                    gt500000: "Greater than ₹5,00,000",
                  }[filters.payment]}
            </span>
            {filters.payment !== "all" && (
              <button
                type="button"
                className="absolute right-7 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 text-lg font-bold focus:outline-none"
                style={{ padding: 0, lineHeight: 1 }}
                tabIndex={-1}
                title="Clear filter"
                onClick={(e) => {
                  e.stopPropagation();
                  handleFilterChange("payment", "all");
                }}
              >
                <RxCross2 />
              </button>
            )}
            <img
              src="/caret-down.svg"
              alt=""
              aria-hidden="true"
              className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
            />
          </button>
          {activeFilterDropdown === "payment" && (
            <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
              {[
                { value: "all", label: "All Payments" },
                { value: "lt50000", label: "Less than ₹50,000" },
                {
                  value: "50001-100000",
                  label: "Between ₹50,001 and ₹1,00,000",
                },
                {
                  value: "100001-400000",
                  label: "Between ₹1,00,001 and ₹4,00,000",
                },
                {
                  value: "400001-500000",
                  label: "Between ₹4,00,001 and ₹5,00,000",
                },
                { value: "gt500000", label: "Greater than ₹5,00,000" },
              ].map((option) => (
                <button
                  key={option.value}
                  type="button"
                  onClick={() => {
                    handleFilterChange("payment", option.value);
                    setActiveFilterDropdown(null);
                  }}
                  className={`w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer ${
                    filters.payment === option.value
                      ? "bg-[#E7EFF8] text-[#ef7e1b] font-bold"
                      : ""
                  }`}
                >
                  {option.label}
                </button>
              ))}
            </div>
          )}
        </div>
        {/* Created Date Range Filter */}
        <div className="relative" ref={createdDateRangeDropdownRef}>
          <button
            className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[120px] lg:min-w-[120px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center cursor-pointer"
            onClick={() =>
              setCreatedDateRangeDropdownOpen(!createdDateRangeDropdownOpen)
            }
          >
            <span className="truncate text-left flex-1">
              {createdTimeRange === "all" && "Created At"}
              {createdTimeRange === "7days" && "Last 7 Days"}
              {createdTimeRange === "30days" && "Last 30 Days"}
              {createdTimeRange === "90days" && "Last 90 Days"}
              {createdTimeRange === "custom" && (
                <span className="text-[10px] whitespace-nowrap">
                  {`${formatDateForDisplay(
                    customCreatedDateRange.fromDate
                  )} - ${formatDateForDisplay(customCreatedDateRange.toDate)}`}
                </span>
              )}
            </span>
            <img
              src="/caret-down.svg"
              alt=""
              aria-hidden="true"
              className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
            />
          </button>
          {createdDateRangeDropdownOpen && (
            <div className="absolute right-0 mt-2 w-72 bg-white border border-gray-200 rounded-lg shadow-lg z-10 cursor-pointer">
              <div className="px-4 pt-3  text-[#4B5563]">
                <p className="text-sm font-medium">Select Range</p>
              </div>
              <div className="p-2">
                {/* Predefined ranges */}
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    createdTimeRange === "all"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  }`}
                  onClick={() => handleCreatedTimeRangeChange("all")}
                >
                  {" "}
                  <span>All Dates</span>{" "}
                  {createdTimeRange === "all" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}{" "}
                </button>
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    createdTimeRange === "7days"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  }`}
                  onClick={() => handleCreatedTimeRangeChange("7days")}
                >
                  {" "}
                  <span>Last 7 Days</span>{" "}
                  {createdTimeRange === "7days" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}{" "}
                </button>
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    createdTimeRange === "30days"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  }`}
                  onClick={() => handleCreatedTimeRangeChange("30days")}
                >
                  {" "}
                  <span>Last 30 Days</span>{" "}
                  {createdTimeRange === "30days" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}{" "}
                </button>
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    createdTimeRange === "90days"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  }`}
                  onClick={() => handleCreatedTimeRangeChange("90days")}
                >
                  {" "}
                  <span>Last 90 Days</span>{" "}
                  {createdTimeRange === "90days" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}{" "}
                </button>
                <div className="border-t border-gray-200 my-2"></div>
                {/* Custom date range */}
                <div className="px-3 py-2">
                  <p className="text-sm font-medium text-[#4B5563] mb-2">
                    Custom Range
                  </p>
                  <div className="grid grid-cols-2 gap-2 mb-3">
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">
                        From
                      </label>
                      <input
                        type="date"
                        className="w-full h-[48px] text-sm px-2 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                        value={
                          customCreatedDateRange.fromDate
                            ? customCreatedDateRange.fromDate
                                .toISOString()
                                .split("T")[0]
                            : ""
                        }
                        onChange={(e) =>
                          handleCustomCreatedDateChange(
                            "fromDate",
                            e.target.value
                          )
                        }
                        max={
                          customCreatedDateRange.toDate
                            ? customCreatedDateRange.toDate
                                .toISOString()
                                .split("T")[0]
                            : new Date().toISOString().split("T")[0]
                        }
                      />
                    </div>
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">
                        To
                      </label>
                      <input
                        type="date"
                        className="w-full h-[48px] text-sm px-2 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                        value={
                          customCreatedDateRange.toDate
                            ? customCreatedDateRange.toDate
                                .toISOString()
                                .split("T")[0]
                            : ""
                        }
                        onChange={(e) =>
                          handleCustomCreatedDateChange(
                            "toDate",
                            e.target.value
                          )
                        }
                        min={
                          customCreatedDateRange.fromDate
                            ? customCreatedDateRange.fromDate
                                .toISOString()
                                .split("T")[0]
                            : ""
                        }
                        max={new Date().toISOString().split("T")[0]}
                      />
                    </div>
                  </div>
                  <button
                    className="hover:bg-blue-500 bg-[#ef7e1b] text-white h-[44px] px-5 rounded-[8px] flex items-center justify-center w-full"
                    onClick={applyCustomCreatedDateRange}
                  >
                    Apply Custom Range
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
        {/* Updated Date Range Filter */}
        <div className="relative" ref={updatedDateRangeDropdownRef}>
          <button
            className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[120px] lg:min-w-[120px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center cursor-pointer"
            onClick={() =>
              setUpdatedDateRangeDropdownOpen(!updatedDateRangeDropdownOpen)
            }
          >
            <span className="truncate text-left flex-1">
              {updatedTimeRange === "all" && "Updated At"}
              {updatedTimeRange === "7days" && "Last 7 Days"}
              {updatedTimeRange === "30days" && "Last 30 Days"}
              {updatedTimeRange === "90days" && "Last 90 Days"}
              {updatedTimeRange === "custom" && (
                <span className="text-[10px] whitespace-nowrap">
                  {`${formatDateForDisplay(
                    customUpdatedDateRange.fromDate
                  )} - ${formatDateForDisplay(customUpdatedDateRange.toDate)}`}
                </span>
              )}
            </span>
            <img
              src="/caret-down.svg"
              alt=""
              aria-hidden="true"
              className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
            />
          </button>
          {updatedDateRangeDropdownOpen && (
            <div className="absolute right-0 mt-2 w-72 bg-white border border-gray-200 rounded-lg shadow-lg z-10 cursor-pointer">
              <div className="px-4 pt-3  text-[#4B5563]">
                <p className="text-sm font-medium">Select Range</p>
              </div>
              <div className="p-2">
                {/* Predefined ranges */}
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    updatedTimeRange === "all"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  }`}
                  onClick={() => handleUpdatedTimeRangeChange("all")}
                >
                  {" "}
                  <span>All Dates</span>{" "}
                  {updatedTimeRange === "all" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}{" "}
                </button>
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    updatedTimeRange === "7days"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  }`}
                  onClick={() => handleUpdatedTimeRangeChange("7days")}
                >
                  {" "}
                  <span>Last 7 Days</span>{" "}
                  {updatedTimeRange === "7days" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}{" "}
                </button>
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    updatedTimeRange === "30days"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  }`}
                  onClick={() => handleUpdatedTimeRangeChange("30days")}
                >
                  {" "}
                  <span>Last 30 Days</span>{" "}
                  {updatedTimeRange === "30days" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}{" "}
                </button>
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    updatedTimeRange === "90days"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  }`}
                  onClick={() => handleUpdatedTimeRangeChange("90days")}
                >
                  {" "}
                  <span>Last 90 Days</span>{" "}
                  {updatedTimeRange === "90days" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}{" "}
                </button>
                <div className="border-t border-gray-200 my-2"></div>
                {/* Custom date range */}
                <div className="px-3 py-2">
                  <p className="text-sm font-medium text-[#4B5563] mb-2">
                    Custom Range
                  </p>
                  <div className="grid grid-cols-2 gap-2 mb-3">
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">
                        From
                      </label>
                      <input
                        type="date"
                        className="w-full h-[48px] text-sm px-2 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                        value={
                          customUpdatedDateRange.fromDate
                            ? customUpdatedDateRange.fromDate
                                .toISOString()
                                .split("T")[0]
                            : ""
                        }
                        onChange={(e) =>
                          handleCustomUpdatedDateChange(
                            "fromDate",
                            e.target.value
                          )
                        }
                        max={
                          customUpdatedDateRange.toDate
                            ? customUpdatedDateRange.toDate
                                .toISOString()
                                .split("T")[0]
                            : new Date().toISOString().split("T")[0]
                        }
                      />
                    </div>
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">
                        To
                      </label>
                      <input
                        type="date"
                        className="w-full h-[48px] text-sm px-2 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                        value={
                          customUpdatedDateRange.toDate
                            ? customUpdatedDateRange.toDate
                                .toISOString()
                                .split("T")[0]
                            : ""
                        }
                        onChange={(e) =>
                          handleCustomUpdatedDateChange(
                            "toDate",
                            e.target.value
                          )
                        }
                        min={
                          customUpdatedDateRange.fromDate
                            ? customUpdatedDateRange.fromDate
                                .toISOString()
                                .split("T")[0]
                            : ""
                        }
                        max={new Date().toISOString().split("T")[0]}
                      />
                    </div>
                  </div>
                  <button
                    className="hover:bg-blue-500 bg-[#ef7e1b] text-white h-[44px] px-5 rounded-[8px] flex items-center justify-center w-full"
                    onClick={applyCustomUpdatedDateRange}
                  >
                    Apply Custom Range
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
      {/* Search Results Info */}
      {searchTerm && (
        <div className="mb-4 text-sm text-[#4B5563]">
          Showing {filteredQuotations.length} results for "{searchTerm}"
        </div>
      )}
      {/* Quotation List Table */}
      <div className="hidden md:block w-full flex-grow overflow-x-auto overflow-y-hidden relative custom-scrollbar">
        <table className="w-full min-w-[1000px] border-collapse">
          <thead>
            <tr className="text-left text-[#4B5563]">
              <th className="py-4 px-3 font-medium text-sm w-12">
                <input
                  type="checkbox"
                  checked={
                    selectedLeads.length === currentQuotations.length &&
                    currentQuotations.length > 0
                  }
                  onChange={toggleSelectAll}
                  className="w-4 h-4 rounded border-[#E9EAEA] cursor-pointer"
                />
              </th>
              <th className="py-4 px-3 font-medium text-sm whitespace-nowrap w-[120px]">
                Quotation No.
              </th>
              <th className="py-4 px-3 font-medium text-sm whitespace-nowrap w-[150px]">
                Customer Name
              </th>

              <th className="py-4 px-3 font-medium text-sm w-[120px] whitespace-nowrap">
                Package
              </th>
              <th className="py-4 px-3 font-medium text-sm whitespace-nowrap w-[180px]">
                Total
              </th>
              <th className="py-4 px-3 font-medium text-sm whitespace-nowrap w-[150px]">
                Created
              </th>
              <th className="py-4 px-3 font-medium text-sm whitespace-nowrap w-[150px]">
                Updated At
              </th>
              <th className="py-4 px-3 font-medium text-sm whitespace-nowrap w-[150px]">
                Valid Until
              </th>
              <th className="py-4 px-3 font-medium text-sm w-12">Action</th>
            </tr>
          </thead>
          <tbody>
            {currentQuotations.length === 0 ? (
              <tr>
                <td
                  colSpan="9"
                  className="py-8 px-3 text-center text-[#4B5563]"
                >
                  {searchTerm
                    ? "No quotations found matching your search."
                    : "No quotations available."}
                </td>
              </tr>
            ) : (
              currentQuotations.map((quotation) => (
                <React.Fragment key={quotation.id}>
                  <tr className="border-t border-[#E5E7EB]">
                    <td className="py-4 px-3 w-12">
                      <input
                        type="checkbox"
                        checked={selectedLeads.includes(quotation.id)}
                        onChange={() => toggleQuotationSelection(quotation.id)}
                        className="w-4 h-4 rounded border-[#E9EAEA] cursor-pointer bg-[#E9EAEA]"
                      />
                    </td>
                    <td className="py-4 px-3 text-sm text-[#4B5563] overflow-hidden truncate">
                      {quotation.quote_no}
                    </td>
                    <td className="py-4 px-3 text-sm text-[#4B5563] overflow-hidden truncate">
                      <span className="text-[#1F2837] font-medium">
                        {quotation.client_name}
                      </span>
                    </td>

                    <td className="py-4 px-3 text-sm text-[#4B5563] overflow-hidden truncate">
                      {quotation.package_type}
                    </td>
                    <td className="py-4 px-3 text-sm text-[#4B5563]">
                      <div
                        className="inline-flex items-center gap-2 bg-blue-50 px-3 py-1.5 rounded-full hover:bg-blue-100 transition-colors cursor-pointer"
                        onClick={(e) => handleShowItems(quotation.items, e)}
                      >
                        <span className="font-medium text-[#1F2837] whitespace-nowrap">
                          Rs {parseFloat(quotation.grand_total).toFixed(2)}
                        </span>
                        <div className="h-3.5 w-[1px] bg-blue-200 "></div>
                        <span className="text-xs text-blue-600 whitespace-nowrap">
                          {quotation.items.length} items
                        </span>
                      </div>
                    </td>
                    <td className="py-4 px-3 text-sm text-[#4B5563] overflow-hidden truncate">
                      {quotation.created_at ? (
                        <>
                          <span className="block text-sm">
                            {new Date(quotation.created_at).toLocaleTimeString(
                              "en-US",
                              {
                                hour: "2-digit",
                                minute: "2-digit",
                                hour12: true,
                              }
                            )}
                          </span>
                          <span className="block text-blue-600 text-xs mt-1">
                            {formatDateForDisplay(quotation.created_at)}
                          </span>
                        </>
                      ) : (
                        ""
                      )}
                    </td>
                    <td className="py-4 px-3 text-sm text-[#4B5563] overflow-hidden truncate">
                      {quotation.updated_at ? (
                        <>
                          <span className="block text-sm">
                            {new Date(quotation.updated_at).toLocaleTimeString(
                              "en-US",
                              {
                                hour: "2-digit",
                                minute: "2-digit",
                                hour12: true,
                              }
                            )}
                          </span>
                          <span className="block text-blue-600 text-xs mt-1">
                            {formatDateForDisplay(quotation.updated_at)}
                          </span>
                        </>
                      ) : (
                        ""
                      )}
                    </td>
                    <td className="py-4 px-3 text-sm text-[#4B5563] overflow-hidden truncate">
                      {quotation.valid_until ? (
                        <>
                          <span className="block text-sm">
                            {formatDateForDisplay(quotation.valid_until)}
                          </span>
                          <span
                            className={`block text-xs mt-1 ${
                              calculateDaysRemaining(quotation.valid_until) ===
                              "Expired"
                                ? "text-red-600"
                                : "text-green-600"
                            }`}
                          >
                            ({calculateDaysRemaining(quotation.valid_until)})
                          </span>
                        </>
                      ) : (
                        ""
                      )}
                    </td>
                    <td className="py-4 px-3 relative">
                      <button
                        onClick={() => toggleDropdown(quotation.id)}
                        className="p-2 text-[#4B5563] hover:bg-blue-200 hover:text-white rounded-full transition-colors "
                      >
                        <TbDotsVertical className="w-4 h-4" />
                      </button>
                      {activeDropdown === quotation.id && (
                        <div className="relative">
                          <div
                            data-dropdown-id={quotation.id}
                            className="absolute left-3 w-24 rounded-md shadow-md bg-gradient-to-br from-white to-[#E7F4FF] z-10 overflow-hidden"
                          >
                            <button
                              onClick={() => handleEdit(quotation)}
                              className="group flex items-center px-2 py-1 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors first:rounded-t-md"
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="24"
                                height="24"
                                viewBox="0 0 24 24"
                                className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                              >
                                <path
                                  fill="currentColor"
                                  d="M4 14v-2h7v2zm0-4V8h11v2zm0-4V4h11v2zm9 14v-3.075l6.575-6.55l3.075 3.05L16.075 20zm7.5-6.575l-.925-.925zm-6 5.075h.95l3.025-3.05l-.45-.475l-.475-.45l-3.05 3.025zm3.525-3.525l-.475-.45l.925.925z"
                                />
                              </svg>
                              <span className="group-hover:text-white transition-colors">
                                Edit
                              </span>
                            </button>
                            <svg
                              className="w-full h-[1px]"
                              viewBox="0 0 100 1"
                              preserveAspectRatio="none"
                              xmlns="http://www.w3.org/2000/svg"
                            >
                              <polygon
                                points="0,0 50,1 100,0"
                                fill="#E5E7EB"
                              ></polygon>
                            </svg>
                            <button
                              onClick={() => handleDelete(quotation.id)}
                              className="group flex items-center px-2 py-1 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors last:rounded-b-md"
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="24"
                                height="24"
                                viewBox="0 0 24 24"
                                className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                              >
                                <path
                                  fill="currentColor"
                                  d="M7.616 20q-.672 0-1.144-.472T6 18.385V6H5V5h4v-.77h6V5h4v1h-1v12.385q0 .69-.462 1.153T16.384 20zM17 6H7v12.385q0 .269.173.442t.443.173h8.769q.23 0 .423-.192t.192-.424zM9.808 17h1V8h-1zm3.384 0h1V8h-1zM7 6v13z"
                                />
                              </svg>
                              <span className="group-hover:text-white transition-colors">
                                Delete
                              </span>
                            </button>
                          </div>
                        </div>
                      )}
                    </td>
                  </tr>
                </React.Fragment>
              ))
            )}
          </tbody>
        </table>
      </div>
      {/* Quotation List Cards for Mobile */}
      <div className="md:hidden w-full space-y-6 pb-24 flex-grow overflow-x-auto">
        {currentQuotations.length === 0 ? (
          <div className="py-12 px-6 text-center">
            <div className="w-16 h-16 mx-auto mb-4  rounded-full flex items-center justify-center">
              <svg
                className="w-8 h-8 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth="1.5"
                  d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-5.5a2.5 2.5 0 00-2.5 2.5v.5a2 2 0 01-2 2h-3a2 2 0 01-2-2v-.5a2.5 2.5 0 00-2.5-2.5H4"
                />
              </svg>
            </div>
            <p className="text-gray-500 font-medium">
              {searchTerm
                ? "No quotations found matching your search."
                : "No quotations available."}
            </p>
          </div>
        ) : (
          currentQuotations.map((quotation) => {
            return (
              <div
                key={quotation.id}
                className="bg-white rounded-2xl border border-gray-100 hover:border-gray-200 transition-all duration-300 hover:shadow-lg"
              >
                {/* Header Section */}
                <div className="p-4 sm:p-6 border-b border-gray-50">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-2 sm:space-x-4">
                      <input
                        type="checkbox"
                        checked={selectedLeads.includes(quotation.id)}
                        onChange={() => toggleQuotationSelection(quotation.id)}
                        className="w-5 h-5 rounded border-gray-300 text-gray-900 focus:ring-gray-500 focus:ring-2"
                      />

                      <div className="flex items-center space-x-3">
                        <div className="w-12 h-12 rounded-full bg-gray-100 overflow-hidden ring-1 ring-gray-200">
                          {/* Removed profile_pic rendering */}
                          <img
                            src="/dummyavatar.jpeg"
                            alt={quotation.client_name}
                            className="w-full h-full object-cover"
                          />
                        </div>

                        <div>
                          {/* Quotation ID */}
                          <div className="text-xs text-blue-600 font-semibold ">
                            Quotation No: {quotation.quote_no}
                          </div>
                          <h3 className="text-base font-semibold text-gray-900 whitespace-nowrap">
                            {quotation.client_name}
                          </h3>
                          <p className="text-xs text-gray-500">
                            {quotation.client_address}
                          </p>
                          <p className="text-xs text-gray-400 mt-1">
                            {quotation.created_at ? (
                              <>
                                <span className="block text-xs">
                                  {new Date(
                                    quotation.created_at
                                  ).toLocaleTimeString("en-US", {
                                    hour: "2-digit",
                                    minute: "2-digit",
                                    hour12: true,
                                  })}
                                </span>
                                <span className="block text-blue-600 text-xs mt-1">
                                  {formatDateForDisplay(quotation.created_at)}
                                </span>
                              </>
                            ) : (
                              ""
                            )}
                          </p>
                        </div>
                      </div>
                    </div>

                    {/* Actions Menu */}
                    <div className="relative">
                      <button
                        onClick={() => toggleDropdown(quotation.id)}
                        className="p-1 text-[#4B5563] rounded-full hover:bg-gray-100"
                      >
                        <TbDotsVertical className="w-4 h-4" />
                      </button>

                      {activeDropdown === quotation.id && (
                        <div className="absolute right-0 mt-1 w-24 sm:w-28 rounded-md shadow-md bg-gradient-to-br from-white to-[#E7F4FF] z-20 overflow-hidden">
                          <div>
                            {/* EDIT button */}
                            <button
                              onClick={() => handleEdit(quotation)}
                              className="group flex items-center px-3 py-2 text-xs text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors first:rounded-t-md"
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                className="mr-2 w-3 h-3 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                              >
                                <path
                                  fill="currentColor"
                                  d="M4 14v-2h7v2zm0-4V8h11v2zm0-4V4h11v2zm9 14v-3.075l6.575-6.55l3.075 3.05L16.075 20zm7.5-6.575l-.925-.925zm-6 5.075h.95l3.025-3.05l-.45-.475l-.475-.45l-3.05 3.025zm3.525-3.525l-.475-.45l.925.925z"
                                />
                              </svg>
                              <span className="group-hover:text-white transition-colors">
                                Edit
                              </span>
                            </button>

                            {/* Tapered separator */}
                            <svg
                              className="w-full h-[1px]"
                              viewBox="0 0 100 1"
                              preserveAspectRatio="none"
                              xmlns="http://www.w3.org/2000/svg"
                            >
                              <polygon points="0,0 50,1 100,0" fill="#E5E7EB" />
                            </svg>

                            {/* DELETE button */}
                            <button
                              onClick={() => handleDelete(quotation.id)}
                              className="group flex items-center px-3 py-2 text-xs text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors last:rounded-b-md"
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                className="mr-2 w-3 h-3 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                              >
                                <path
                                  fill="currentColor"
                                  d="M7.616 20q-.672 0-1.144-.472T6 18.385V6H5V5h4v-.77h6V5h4v1h-1v12.385q0 .69-.462 1.153T16.384 20zM17 6H7v12.385q0 .269.173.442t.443.173h8.769q.23 0 .423-.192t.192-.424zM9.808 17h1V8h-1zm3.384 0h1V8h-1zM7 6v13z"
                                />
                              </svg>
                              <span className="group-hover:text-white transition-colors">
                                Delete
                              </span>
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* Details Section */}
                <div className="p-3 sm:p-4 space-y-3">
                  {/* Total Row (matches desktop, clickable for items modal) */}
                  <div
                    className="flex items-center space-x-1 p-2 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors duration-200 mb-2 cursor-pointer"
                    onClick={(e) => handleShowItems(quotation.items, e)}
                  >
                    <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                      <svg
                        className="w-5 h-5 text-blue-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="1.5"
                          d="M12 8v8m0 0l-3-3m3 3l3-3"
                        />
                      </svg>
                    </div>
                    <div className="min-w-0 flex-1 ">
                      <p className="text-[10px] ml-1 font-medium text-blue-600 uppercase tracking-wide">
                        Total
                      </p>
                      <div className="flex items-center gap-2">
                        <p className="text-[13px] ml-1 text-blue-900 font-bold">
                          Rs {parseFloat(quotation.grand_total).toFixed(2)}
                        </p>
                        <span className="text-xs text-blue-600">
                          ({quotation.items.length} items)
                        </span>
                      </div>
                    </div>
                  </div>
                  {/* Contact Number Row */}
                  <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                      <svg
                        className="w-3 h-3 text-gray-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="1.5"
                          d="M3 5a2 2 0 002-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                        />
                      </svg>
                    </div>
                    <div className="min-w-0 flex-1 ">
                      <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                        Package Type
                      </p>
                      <p className="text-[10px] ml-1 text-gray-900">
                        {quotation.package_type}
                      </p>
                    </div>
                  </div>
                  {/* Created At Row */}
                  <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                      <svg
                        className="w-3 h-3 text-gray-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="1.5"
                          d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                    </div>
                    <div className="min-w-0 flex-1 ">
                      <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                        Created At
                      </p>
                      <p className="text-[10px] ml-1 text-gray-900">
                        {quotation.created_at ? (
                          <>
                            <span className="block text-xs">
                              {new Date(
                                quotation.created_at
                              ).toLocaleTimeString("en-US", {
                                hour: "2-digit",
                                minute: "2-digit",
                                hour12: true,
                              })}
                            </span>
                            <span className="block text-blue-600 text-xs mt-1">
                              {formatDateForDisplay(quotation.created_at)}
                            </span>
                          </>
                        ) : (
                          ""
                        )}
                      </p>
                    </div>
                  </div>
                  {/* Updated At Row */}
                  <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                      <svg
                        className="w-3 h-3 text-gray-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="1.5"
                          d="M4 4v5h.582m15.356-2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m0 0H15"
                        />
                      </svg>
                    </div>
                    <div className="min-w-0 flex-1 ">
                      <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                        Updated At
                      </p>
                      <p className="text-[10px] ml-1 text-gray-900">
                        {quotation.updated_at ? (
                          <>
                            <span className="block text-xs">
                              {new Date(
                                quotation.updated_at
                              ).toLocaleTimeString("en-US", {
                                hour: "2-digit",
                                minute: "2-digit",
                                hour12: true,
                              })}
                            </span>
                            <span className="block text-blue-600 text-xs mt-1">
                              {formatDateForDisplay(quotation.updated_at)}
                            </span>
                          </>
                        ) : (
                          ""
                        )}
                      </p>
                    </div>
                  </div>
                  {/* Valid Until Row */}
                  <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                      <svg
                        className="w-3 h-3 text-gray-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="1.5"
                          d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                        />
                      </svg>
                    </div>
                    <div className="min-w-0 flex-1 ">
                      <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                        Valid Until
                      </p>
                      <p className="text-[10px] ml-1 text-gray-900">
                        {quotation.valid_until ? (
                          <>
                            <span className="block text-xs">
                              {formatDateForDisplay(quotation.valid_until)}
                            </span>
                            <span
                              className={`block text-xs mt-1 ${
                                calculateDaysRemaining(
                                  quotation.valid_until
                                ) === "Expired"
                                  ? "text-red-600"
                                  : "text-green-600"
                              }`}
                            >
                              ({calculateDaysRemaining(quotation.valid_until)})
                            </span>
                          </>
                        ) : (
                          ""
                        )}
                      </p>
                    </div>
                  </div>
                  {/* Removed WhatsApp, Status, and old items table UI */}
                </div>
              </div>
            );
          })
        )}
      </div>{" "}
      {/* Items Modal */}
      {isItemsModalOpen && selectedItems && (
        <div className="fixed inset-0 flex items-center justify-center z-50">
          {/* Frosted overlay */}
          <div
            className="absolute inset-0 bg-gray-50/10 backdrop-blur-sm border border-white/30"
            onClick={() => setIsItemsModalOpen(false)}
          />

          {/* Glassmorphism modal container */}
          <div
            className="w-11/12 max-w-[1000px] max-h-[90vh] overflow-y-auto p-6 md:p-8
              rounded-2xl
              bg-gradient-to-br from-[#FFFFFF] to-[#E6F4FF]
              shadow-lg
              relative z-10 custom-scrollbar"
          >
            {/* Close button */}
            <button
              onClick={() => setIsItemsModalOpen(false)}
              className="absolute top-6 right-6 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13 1L1 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M1 1L13 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Modal title */}
            <h2 className="text-[24px] sm:text-[29px] font-medium text-[#1F2837] mb-8">
              Items Details
            </h2>

            {/* Items Table */}
            <div className=" rounded-[12px] overflow-hidden">
              <table className="min-w-full divide-y divide-[#E5E7EB]">
                <thead className="">
                  <tr>
                    <th
                      scope="col"
                      className="px-6 py-4 text-left text-sm font-medium text-[#4B5563] uppercase tracking-wider"
                    >
                      Item Name
                    </th>
                    <th
                      scope="col"
                      className="px-6 py-4 text-left text-sm font-medium text-[#4B5563] uppercase tracking-wider"
                    >
                      Quantity
                    </th>
                    <th
                      scope="col"
                      className="px-6 py-4 text-left text-sm font-medium text-[#4B5563] uppercase tracking-wider"
                    >
                      Rate
                    </th>
                    <th
                      scope="col"
                      className="px-6 py-4 text-left text-sm font-medium text-[#4B5563] uppercase tracking-wider"
                    >
                      Amount
                    </th>
                  </tr>
                </thead>
                <tbody className=" divide-y divide-[#E5E7EB]">
                  {selectedItems.map((item, index) => (
                    <tr key={index} className="">
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-[#545454]">
                        {item.item_name}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-[#545454]">
                        {item.qty}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-[#545454]">
                        Rs {parseFloat(item.rate).toFixed(2)}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-[#545454]">
                        Rs {parseFloat(item.amount).toFixed(2)}
                      </td>
                    </tr>
                  ))}
                  <tr className=" font-medium">
                    <td
                      colSpan="3"
                      className="px-6 py-4 text-right text-sm text-[#1F2837]"
                    >
                      Net Total:
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-[#1F2837]">
                      Rs {calculateNetTotal(selectedItems)}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            {/* Close button */}
            <div className="mt-10 flex justify-center">
              <button
                onClick={() => setIsItemsModalOpen(false)}
                className="w-full md:w-[207px] h-[46px] bg-[#ef7e1b] text-white rounded-[10px] hover:bg-[#ee7f1b] transition-colors"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}
      {/* Pagination Controls */}
      {filteredQuotations.length > 0 && (
        <div className="flex justify-center pt-7 mt-auto">
          <div className="flex items-center gap-2 lg:gap-3">
            {/* Previous Page */}
            <button
              onClick={handlePreviousPage}
              disabled={currentPage === 1}
              className={`w-[44px] h-[44px] lg:w-[52px] lg:h-[52px]
          rounded-full border border-[#7E7B7B]
          flex items-center justify-center transition-colors
          ${
            currentPage === 1
              ? "opacity-50 cursor-not-allowed"
              : "group hover:bg-blue-200 hover:border-white hover:text-white"
          }
        `}
            >
              <svg
                width="33"
                height="32"
                viewBox="0 0 33 32"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                className={`stroke-current text-[#7E7B7B]
            ${currentPage === 1 ? "" : "group-hover"}
          `}
              >
                <path
                  d="M23.1667 5.33398L12.06 13.3873C9.09198 15.5407 9.09198 16.462 12.06 18.614L23.1667 26.6673"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Page Info */}
            <div className="flex items-center gap-2 text-sm lg:text-base text-[#4B5563]">
              <span>
                Page {currentPage} of {totalPages}
              </span>
              <span>({filteredQuotations.length} total)</span>
            </div>

            {/* Next Page */}
            <button
              onClick={handleNextPage}
              disabled={currentPage === totalPages}
              className={`w-[44px] h-[44px] lg:w-[52px] lg:h-[52px]
          rounded-full border border-[#7E7B7B]
          flex items-center justify-center transition-colors
          ${
            currentPage === totalPages
              ? "opacity-50 cursor-not-allowed"
              : "group hover:bg-blue-200 hover:border-white hover:text-white"
          }
        `}
            >
              <svg
                width="52"
                height="52"
                viewBox="0 0 52 52"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                className={`stroke-current text-[#7E7B7B]
            ${currentPage === totalPages ? "" : "group-hover:text-white"}
          `}
              >
                <circle cx="26" cy="26" r="25.5" strokeWidth="1" />
                <path
                  d="M20.8333 15.334L31.94 23.3873C34.908 25.5407 34.908 26.462 31.94 28.614L20.8333 36.6673"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

export default ViewQuotation;
//before making responsive
</file>

<file path="src/pages/leads/CustomLeadsComponent.jsx">
import React, { useState, useEffect, useRef, useContext, useMemo } from "react";
import { FiChevronDown, FiEdit, FiUpload, FiDownload } from "react-icons/fi";
import { TbDotsVertical } from "react-icons/tb";
import api from "../../api";
import Swal from "sweetalert2";
import { FaCheck } from "react-icons/fa6";
import { BsFiletypeCsv } from "react-icons/bs";
import { useParams, useLocation } from "react-router-dom"; // Import useParams and useLocation
import { Country, State, City } from "country-state-city";

import { RxCross2 } from "react-icons/rx";

import "../../styles/scrollbar.css";
import { form } from "motion/react-client";
import { SidebarContext } from "../../components/Layout";
import { useAuth } from "../../auth/AuthContext";

const CustomLeadManager = () => {
  const { statusId, statusName } = useParams(); // Get statusId and statusName from URL

  const [bulkDeleteMessage, setBulkDeleteMessage] = useState(false);
  const [bulkDeleteFollowUp, setBulkDeleteFollowUp] = useState(false);

  // New state variables for bulk edit checkboxes
  const [bulkAssignUser, setBulkAssignUser] = useState(false);
  const [bulkChangeStatus, setBulkChangeStatus] = useState(false);

  const handleBulkActionsSubmit = async () => {
    if (selectedLeads.length === 0) {
      Swal.fire({
        icon: "info",
        title: "No Leads Selected",
        text: "Please select leads to perform bulk actions.",
        confirmButtonColor: "#2798FF",
      });
      return;
    }

    if (
      !bulkDeleteMessage &&
      !bulkDeleteFollowUp &&
      !bulkAssignUser &&
      !bulkChangeStatus
    ) {
      Swal.fire({
        icon: "info",
        title: "No Action Selected",
        text: "Please check an action to perform.",
        confirmButtonColor: "#2798FF",
      });
      return;
    }

    // Validate required selections for each action
    if (bulkAssignUser && !selectedAssignee) {
      Swal.fire({
        icon: "error",
        title: "User Not Selected",
        text: "Please select a user to assign leads to.",
        confirmButtonColor: "#DD6B55",
      });
      return;
    }

    if (bulkChangeStatus && !bulkEditSelectedStatus) {
      Swal.fire({
        icon: "error",
        title: "Status Not Selected",
        text: "Please select a status to change leads to.",
        confirmButtonColor: "#DD6B55",
      });
      return;
    }

    let loadingAlert;
    try {
      loadingAlert = Swal.fire({
        title: `Performing bulk actions for ${selectedLeads.length} leads...`,
        html: "Please wait, this may take a moment.",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      const successfulUpdates = [];
      const failedUpdates = [];

      // Use the current state, but don't rely on it changing mid-function
      const currentLeadsState = [...leads];

      for (const leadId of selectedLeads) {
        try {
          const leadToUpdate = currentLeadsState.find(
            (lead) => lead.customer_id === leadId
          );

          if (!leadToUpdate) {
            failedUpdates.push({ id: leadId, reason: "Lead not found." });
            continue;
          }

          const formDataToSend = new FormData();

          // Append all existing lead data that isn't changing
          safeAppend(
            formDataToSend,
            "customer_name",
            leadToUpdate.customer_name
          );
          safeAppend(formDataToSend, "email", leadToUpdate.email);
          safeAppend(formDataToSend, "contact_number", leadToUpdate.contact);
          safeAppend(formDataToSend, "city", leadToUpdate.city);
          safeAppend(
            formDataToSend,
            "whatsapp_number",
            leadToUpdate.whatsapp_number
          );
          safeAppend(formDataToSend, "requirements", leadToUpdate.requirements);
          safeAppend(formDataToSend, "source", leadToUpdate.source);
          safeAppend(formDataToSend, "status", leadToUpdate.status_name);
          safeAppend(formDataToSend, "status_id", leadToUpdate.status_id);

          // Handle assigned_to field
          let assignedToId = leadToUpdate.assigned_to;
          if (bulkAssignUser && selectedAssignee) {
            // Use the selected assignee
            const userObj = users.find((u) => u.name === selectedAssignee);
            assignedToId = userObj ? userObj.id : "";
          } else if (
            typeof assignedToId === "string" &&
            isNaN(Number(assignedToId))
          ) {
            // Use existing assignee if not changing
            const userObj = users.find((u) => u.name === assignedToId);
            assignedToId = userObj ? userObj.id : "";
          }
          safeAppend(
            formDataToSend,
            "assigned_to",
            parseInt(assignedToId, 10) || 0
          );

          // Handle status field
          let statusToUse = leadToUpdate.status_name;
          let statusIdToUse = leadToUpdate.status_id;
          if (bulkChangeStatus && bulkEditSelectedStatus) {
            statusToUse = bulkEditSelectedStatus.status_name;
            statusIdToUse = bulkEditSelectedStatus.status_id;
          }
          safeAppend(formDataToSend, "status", statusToUse);
          safeAppend(formDataToSend, "status_id", statusIdToUse);

          // Handle delete operations
          safeAppend(
            formDataToSend,
            "message",
            bulkDeleteMessage ? "" : leadToUpdate.message
          );
          safeAppend(
            formDataToSend,
            "follow_up_date",
            bulkDeleteFollowUp ? "" : leadToUpdate.follow_up_date_input
          );
          safeAppend(
            formDataToSend,
            "follow_up_time",
            bulkDeleteFollowUp ? "" : leadToUpdate.follow_up_time_input
          );

          const response = await api.post(
            `/udateleads/${leadId}`,
            formDataToSend,
            { headers: { "Content-Type": "multipart/form-data" } }
          );

          if (response.data.status || response.data.success) {
            successfulUpdates.push(leadId);
          } else {
            failedUpdates.push({
              id: leadId,
              reason: response.data.message || "Unknown error",
            });
          }
        } catch (err) {
          failedUpdates.push({
            id: leadId,
            reason: err.message || "Network error",
          });
        }
      }

      await loadingAlert.close();

      // Show a summary of results
      const actionsPerformed = [];
      if (bulkAssignUser) actionsPerformed.push("User Assignment");
      if (bulkChangeStatus) actionsPerformed.push("Status Change");
      if (bulkDeleteMessage) actionsPerformed.push("Message Deletion");
      if (bulkDeleteFollowUp) actionsPerformed.push("Follow-up Date Deletion");

      await Swal.fire({
        icon: successfulUpdates.length > 0 ? "success" : "error",
        title: "Bulk Actions Complete",
        html: `Successfully updated ${successfulUpdates.length} lead(s).<br/>
        Actions performed: ${actionsPerformed.join(", ")}<br/>${
          failedUpdates.length > 0
            ? `<span class="text-red-500">${failedUpdates.length} lead(s) failed.</span>`
            : ""
        }`,
        confirmButtonColor: "#2798FF",
      });

      // Fetch fresh data once at the end
      await fetchLeads();
    } catch (err) {
      if (loadingAlert) await loadingAlert.close();
      Swal.fire({
        icon: "error",
        title: "Bulk Actions Error",
        text: err.message || "An unexpected error occurred.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  const dynamicApiEndpoint = statusId ? `/leadstatus/${statusId}` : "/showlead";
  const dynamicHeaderTitle = statusName
    ? `All ${decodeURIComponent(statusName)} Items`
    : "All Leads";
  const dynamicModalTitle = statusName
    ? `Edit ${decodeURIComponent(statusName)} Item`
    : "Edit Lead";

  // Helper function to format date for display
  const formatDateForDisplay = (date) => {
    if (!date) return "";
    const d = new Date(date);
    return d.toLocaleDateString("en-GB"); // Adjust locale as needed
  };

  // Helper function to format date in "Jun 23, 2025" format
  const formatDateForTable = (date) => {
    if (!date) return "";
    const d = new Date(date);
    return d.toLocaleDateString("en-US", {
      month: "short",
      day: "numeric",
      year: "numeric",
    });
  };

  // New helper function to format date and time for table display (time above, date below)
  const formatDateTimeForTable = (dateString) => {
    if (!dateString) return "";
    const d = new Date(dateString);
    const time = d.toLocaleTimeString("en-US", {
      hour: "2-digit",
      minute: "2-digit",
      hour12: true,
    });
    const date = d.toLocaleDateString("en-US", {
      month: "short",
      day: "numeric",
      year: "numeric",
    });
    return (
      <div className="flex flex-col">
        <span>{time}</span>
        <span className="text-xs text-blue-600">{date}</span>
      </div>
    );
  };

  // Handler for predefined time range changes
  const handleTimeRangeChange = (range) => {
    setTimeRange(range);
    setDateRangeDropdownOpen(false);
    // The filtering logic will be in filteredLeads based on timeRange
  };

  // Handler for custom date range input changes
  const handleCustomDateChange = (type, dateString) => {
    setCustomDateRange((prev) => ({
      ...prev,
      [type]: new Date(dateString),
    }));
  };

  // Handler to apply custom date range
  const applyCustomDateRange = () => {
    if (customDateRange.fromDate && customDateRange.toDate) {
      setTimeRange("custom");
      setDateRangeDropdownOpen(false);
    } else {
      Swal.fire({
        icon: "error",
        title: "Invalid Date Range",
        text: "Please select both a start and end date for the custom range.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  // Handler for predefined time range changes for created date
  const handleCreatedTimeRangeChange = (range) => {
    setCreatedTimeRange(range);
    setCreatedDateRangeDropdownOpen(false);
  };

  // Handler for custom created date range input changes
  const handleCustomCreatedDateChange = (type, dateString) => {
    setCustomCreatedDateRange((prev) => ({
      ...prev,
      [type]: new Date(dateString),
    }));
  };

  // Handler to apply custom created date range
  const applyCustomCreatedDateRange = () => {
    if (customCreatedDateRange.fromDate && customCreatedDateRange.toDate) {
      setCreatedTimeRange("custom");
      setCreatedDateRangeDropdownOpen(false);
    } else {
      Swal.fire({
        icon: "error",
        title: "Invalid Date Range",
        text: "Please select both a start and end date for the custom range.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  // Mobile detection and search state
  const [isMobile, setIsMobile] = useState(() => window.innerWidth < 768);
  const [isSearchExpanded, setIsSearchExpanded] = useState(false);
  const [leads, setLeads] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const [statuses, setStatuses] = useState([]);
  // Add new state for status dropdown
  const [isStatusDropdownOpen, setIsStatusDropdownOpen] = useState(false);
  const statusDropdownRef = useRef(null);
  // Add new state for assign to dropdown
  const [isAssignToDropdownOpen, setIsAssignToDropdownOpen] = useState(false);
  const assignToDropdownRef = useRef(null);
  // Add new state for CSV dropdown
  const [isCsvDropdownOpen, setIsCsvDropdownOpen] = useState(false);
  const csvDropdownRef = useRef(null);
  // New state for follow up date range filter
  const [dateRangeDropdownOpen, setDateRangeDropdownOpen] = useState(false);
  const dateRangeDropdownRef = useRef(null);
  const [timeRange, setTimeRange] = useState("all"); // "all", "7days", "30days", "90days", "custom"
  const [customDateRange, setCustomDateRange] = useState({
    fromDate: new Date(),
    toDate: new Date(),
  });

  // New state for created date range filter
  const [createdDateRangeDropdownOpen, setCreatedDateRangeDropdownOpen] =
    useState(false);
  const createdDateRangeDropdownRef = useRef(null);
  const [createdTimeRange, setCreatedTimeRange] = useState("all"); // "all", "7days", "30days", "90days", "custom"
  const [customCreatedDateRange, setCustomCreatedDateRange] = useState({
    fromDate: new Date(),
    toDate: new Date(),
  });

  // New state for Bulk Assign Modal
  const [isBulkAssignModalOpen, setIsBulkAssignModalOpen] = useState(false);
  const [selectedAssignee, setSelectedAssignee] = useState("");
  const [assigneeSearchTerm, setAssigneeSearchTerm] = useState("");
  const [isAssigneeDropdownOpen, setIsAssigneeDropdownOpen] = useState(false);
  const assigneeDropdownRef = useRef(null);

  // New state for Country, State, City pickers
  const [countries, setCountries] = useState([]);
  const [states, setStates] = useState([]);
  const [cities, setCities] = useState([]);
  const [selectedCountryObj, setSelectedCountryObj] = useState(null);
  const [selectedStateObj, setSelectedStateObj] = useState(null);
  const [selectedCityObj, setSelectedCityObj] = useState(null);

  const [countrySearchTerm, setCountrySearchTerm] = useState("");
  const [stateSearchTerm, setStateSearchTerm] = useState("");
  const [citySearchTerm, setCitySearchTerm] = useState("");

  const [countryDropdownOpen, setCountryDropdownOpen] = useState(false);
  const [stateDropdownOpen, setStateDropdownOpen] = useState(false);
  const [cityDropdownOpen, setCityDropdownOpen] = useState(false);

  const countryDropdownRef = useRef(null);
  const stateDropdownRef = useRef(null);
  const cityDropdownRef = useRef(null);

  // Consume SidebarContext
  const { isCollapsed } = useContext(SidebarContext);

  // New state for Import CSV Modal and file upload
  const [isImportModalOpen, setIsImportModalOpen] = useState(false);
  const [selectedFile, setSelectedFile] = useState(null);

  // Search, filter, and pagination state
  const [searchTerm, setSearchTerm] = useState("");
  const [filters, setFilters] = useState({
    customerName: "all",
    city: "all",
    requirements: "all",
    source: "all",
    assignedTo: "all",
    followUp: "all",
  });
  const [currentPage, setCurrentPage] = useState(1);
  // Add state and ref for custom items per page dropdown
  const [isItemsPerPageDropdownOpen, setIsItemsPerPageDropdownOpen] =
    useState(false);
  const itemsPerPageDropdownRef = useRef(null);
  const [itemsPerPage, setItemsPerPage] = useState(10);

  useEffect(() => {
    function handleClickOutside(event) {
      if (
        itemsPerPageDropdownRef.current &&
        !itemsPerPageDropdownRef.current.contains(event.target)
      ) {
        setIsItemsPerPageDropdownOpen(false);
      }
    }

    document.addEventListener("mousedown", handleClickOutside);
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [itemsPerPageDropdownRef]);

  // Checkbox selection state for bulk operations
  const [selectedLeads, setSelectedLeads] = useState([]);

  // New state for dropdown and modal
  const [activeDropdown, setActiveDropdown] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingLead, setEditingLead] = useState(null);
  const [openStatusMenu, setOpenStatusMenu] = useState(null);
  const [formData, setFormData] = useState({
    name: "",
    email: "",
    phoneno: "",
    city: "",
    whatsapp: "",
    requirements: "",
    source: "",
    assigned_to: "",
    follow_up: "",
    status: "new",
    message: "",
    role: "User",
    is_approved: false,
    profile_pic: null,
    // New address fields
    blockUnitStreetName: "",
    state: "",
    country: "",
    pincode: "",
  });
  const [imagePreview, setImagePreview] = useState(null);

  // Add state for users
  const [users, setUsers] = useState([]);

  // Add refs for each dropdown (desktop and mobile)
  const dropdownRefs = useRef({});

  // Add a ref for the currently open dropdown node (desktop/mobile)
  const [dropdownNode, setDropdownNode] = useState(null);

  // Add refs for all dropdowns
  const customerNameDropdownRef = useRef(null);
  const cityFilterDropdownRef = useRef(null);
  const sourceFilterDropdownRef = useRef(null);
  const assignedToFilterDropdownRef = useRef(null);

  // Add function to fetch users
  const fetchUsers = async () => {
    try {
      const response = await api.get("/userlist");
      if (response.data.success) {
        // Filter users where is_approved is true
        const approvedUsers = response.data.result.filter(
          (user) => user.is_approved
        );
        setUsers(approvedUsers);
      }
    } catch (err) {
      console.error("Error fetching users:", err);
    }
  };

  // Add function to fetch statuses
  const fetchStatuses = async () => {
    try {
      const response = await api.get("/showleadstatus");
      console.log(response.data, "response.data");
      if (response.data.success) {
        setStatuses(response.data.data);
      }
    } catch (err) {
      console.error("Error fetching statuses:", err);
    }
  };

  // 1. Define fetchLeads as a reusable function at the top (after useEffect)
  const fetchLeads = async () => {
    try {
      setLoading(true);
      const response = await api.get(dynamicApiEndpoint); // Use dynamicApiEndpoint
      if (response.data.success) {
        setLeads(response.data.result);
      } else {
        setError("Failed to fetch leads");
      }
    } catch (err) {
      setError("Error fetching leads: " + err.message);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchLeads();
    fetchUsers();
    fetchStatuses(); // Add this line to fetch statuses
    setCountries(Country.getAllCountries());
  }, [dynamicApiEndpoint]); // Depend on dynamicApiEndpoint

  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth < 768);
      if (window.innerWidth >= 768) {
        setIsSearchExpanded(false);
      }
    };
    checkMobile();
    window.addEventListener("resize", checkMobile);
    return () => window.removeEventListener("resize", checkMobile);
  }, []);

  // Add useEffect for status dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        statusDropdownRef.current &&
        !statusDropdownRef.current.contains(event.target)
      ) {
        setIsStatusDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for CSV dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        csvDropdownRef.current &&
        !csvDropdownRef.current.contains(event.target)
      ) {
        setIsCsvDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for date range dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        dateRangeDropdownRef.current &&
        !dateRangeDropdownRef.current.contains(event.target)
      ) {
        setDateRangeDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for created date range dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        createdDateRangeDropdownRef.current &&
        !createdDateRangeDropdownRef.current.contains(event.target)
      ) {
        setCreatedDateRangeDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for assignee dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        assigneeDropdownRef.current &&
        !assigneeDropdownRef.current.contains(event.target)
      ) {
        setIsAssigneeDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // useEffect for country-state-city dropdowns
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        countryDropdownRef.current &&
        !countryDropdownRef.current.contains(event.target)
      ) {
        setCountryDropdownOpen(false);
      }
      if (
        stateDropdownRef.current &&
        !stateDropdownRef.current.contains(event.target)
      ) {
        setStateDropdownOpen(false);
      }
      if (
        cityDropdownRef.current &&
        !cityDropdownRef.current.contains(event.target)
      ) {
        setCityDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add this ref for filter dropdowns
  const filterDropdownRef = useRef(null);

  // Filtered lists for country, state, city
  const filteredCountries = useMemo(
    () =>
      countries.filter((country) =>
        country.name.toLowerCase().includes(countrySearchTerm.toLowerCase())
      ),
    [countries, countrySearchTerm]
  );

  const filteredStates = useMemo(
    () =>
      states.filter((state) =>
        state.name.toLowerCase().includes(stateSearchTerm.toLowerCase())
      ),
    [states, stateSearchTerm]
  );

  const filteredCities = useMemo(
    () =>
      cities.filter((city) =>
        city.name.toLowerCase().includes(citySearchTerm.toLowerCase())
      ),
    [cities, citySearchTerm]
  );

  // Helper function to extract city name from address
  const extractCityFromAddress = (address) => {
    if (!address) return "";

    try {
      // Try to parse as JSON first
      const parsedAddress = JSON.parse(address);
      return parsedAddress.city || "";
    } catch (e) {
      // If not JSON, try the old format (line breaks)
      const addressParts = address.split(/\r?\n/);
      if (addressParts.length >= 2) {
        const cityStatePart = addressParts[1].split(", ");
        return cityStatePart[0] || "";
      }
      return address;
    }
  };

  // Filter leads based on search term and filter criteria
  const filteredLeads = leads.filter((lead) => {
    const searchLower = searchTerm.toLowerCase();

    // Search across all relevant fields
    const matchesSearch =
      // Basic info
      lead?.customer_name?.toLowerCase()?.includes(searchLower) ||
      lead?.email?.toLowerCase()?.includes(searchLower) ||
      lead?.contact?.toLowerCase()?.includes(searchLower) ||
      lead?.address?.toLowerCase()?.includes(searchLower) ||
      // Additional fields
      lead?.city?.toLowerCase()?.includes(searchLower) ||
      lead?.whatsapp_number?.toLowerCase()?.includes(searchLower) ||
      lead?.requirements?.toLowerCase()?.includes(searchLower) ||
      lead?.source?.toLowerCase()?.includes(searchLower) ||
      lead?.assigned_to?.toLowerCase()?.includes(searchLower) ||
      lead?.follow_up_date?.toLowerCase()?.includes(searchLower) ||
      // Status
      lead?.status_name?.toLowerCase()?.includes(searchLower) ||
      // Created date
      lead?.created?.toLowerCase()?.includes(searchLower) ||
      // Customer ID (convert to string for searching)
      String(lead?.customer_id)?.includes(searchLower);

    const matchesCustomerName =
      filters.customerName === "all" ||
      lead?.customer_name
        ?.toLowerCase()
        ?.includes(filters.customerName.toLowerCase());

    const matchesCity =
      filters.city === "all" ||
      extractCityFromAddress(lead?.city)
        ?.toLowerCase()
        ?.includes(filters.city.toLowerCase());

    const matchesRequirements =
      filters.requirements === "all" ||
      lead?.requirements
        ?.toLowerCase()
        ?.includes(filters.requirements.toLowerCase());

    const matchesSource =
      filters.source === "all" ||
      lead?.source?.toLowerCase()?.includes(filters.source.toLowerCase());

    const matchesAssignedTo =
      filters.assignedTo === "all" ||
      lead?.assigned_to
        ?.toLowerCase()
        ?.includes(filters.assignedTo.toLowerCase());

    const matchesFollowUp =
      filters.followUp === "all" ||
      lead?.follow_up_date
        ?.toLowerCase()
        ?.includes(filters.followUp.toLowerCase());

    // New logic for date range filtering
    const matchesFollowUpDateRange = () => {
      if (timeRange === "all") return true;
      if (!lead.follow_up_date) return false; // Leads without follow_up_date won't match for specific ranges
      const followUpDate = new Date(lead.follow_up_date);
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Normalize to start of day

      switch (timeRange) {
        case "7days":
          const sevenDaysAgo = new Date(today);
          sevenDaysAgo.setDate(today.getDate() - 7);
          return followUpDate >= sevenDaysAgo && followUpDate <= today;
        case "30days":
          const thirtyDaysAgo = new Date(today);
          thirtyDaysAgo.setDate(today.getDate() - 30);
          return followUpDate >= thirtyDaysAgo && followUpDate <= today;
        case "90days":
          const ninetyDaysAgo = new Date(today);
          ninetyDaysAgo.setDate(today.getDate() - 90);
          return followUpDate >= ninetyDaysAgo && followUpDate <= today;
        case "custom":
          const from = new Date(customDateRange.fromDate);
          from.setHours(0, 0, 0, 0);
          const to = new Date(customDateRange.toDate);
          to.setHours(23, 59, 59, 999);
          return followUpDate >= from && followUpDate <= to;
        default:
          return true;
      }
    };

    // New logic for created date range filtering
    const matchesCreatedDateRange = () => {
      if (!lead.created) return false; // Leads without created date won't match

      // Parse the created date string (format: "YYYY-MM-DD")
      const createdDateParts = lead.created.split("-");
      if (createdDateParts.length !== 3) return false;

      const createdDate = new Date(
        parseInt(createdDateParts[0]), // year
        parseInt(createdDateParts[1]) - 1, // month (0-indexed)
        parseInt(createdDateParts[2]) // day
      );

      const today = new Date();
      today.setHours(0, 0, 0, 0); // Normalize to start of day

      switch (createdTimeRange) {
        case "7days":
          const sevenDaysAgo = new Date(today);
          sevenDaysAgo.setDate(today.getDate() - 7);
          return createdDate >= sevenDaysAgo && createdDate <= today;
        case "30days":
          const thirtyDaysAgo = new Date(today);
          thirtyDaysAgo.setDate(today.getDate() - 30);
          return createdDate >= thirtyDaysAgo && createdDate <= today;
        case "90days":
          const ninetyDaysAgo = new Date(today);
          ninetyDaysAgo.setDate(today.getDate() - 90);
          return createdDate >= ninetyDaysAgo && createdDate <= today;
        case "custom":
          const from = new Date(customCreatedDateRange.fromDate);
          from.setHours(0, 0, 0, 0);
          const to = new Date(customCreatedDateRange.toDate);
          to.setHours(23, 59, 59, 999);
          return createdDate >= from && createdDate <= to;
        case "all":
        default:
          return true;
      }
    };

    return (
      matchesSearch &&
      matchesCustomerName &&
      matchesCity &&
      matchesRequirements &&
      matchesSource &&
      matchesAssignedTo &&
      matchesFollowUp &&
      matchesFollowUpDateRange() &&
      matchesCreatedDateRange()
    );
  });

  // Helper function for form validation
  const validateFormData = (data) => {
    const errors = [];

    if (!data.name || data.name.trim() === "") {
      errors.push("Lead Name is required.");
    }
    if (!data.phoneno || data.phoneno.trim() === "") {
      errors.push("Contact is required.");
    }
    return errors;
  };

  // Calculate pagination
  const totalPages = Math.ceil(filteredLeads.length / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const currentLeads = filteredLeads.slice(startIndex, endIndex);

  // Reset to first page when search term or filters change
  useEffect(() => {
    setCurrentPage(1);
  }, [searchTerm, filters]);

  const handleSearchToggle = () => {
    setIsSearchExpanded(!isSearchExpanded);
  };

  const handleSearchBlur = () => {
    if (isMobile) {
      setIsSearchExpanded(false);
    }
  };

  const handleSearchChange = (e) => {
    setSearchTerm(e.target.value);
  };

  const handlePreviousPage = () => {
    if (currentPage > 1) {
      setCurrentPage(currentPage - 1);
    }
  };

  const handleNextPage = () => {
    if (currentPage < totalPages) {
      setCurrentPage(currentPage + 1);
    }
  };

  const handleItemsPerPageChange = (newItemsPerPage) => {
    setItemsPerPage(newItemsPerPage);
    setCurrentPage(1);
  };

  // Checkbox handlers for bulk selection
  const toggleLeadSelection = (leadId) => {
    setSelectedLeads((prev) =>
      prev.includes(leadId)
        ? prev.filter((id) => id !== leadId)
        : [...prev, leadId]
    );
  };

  const toggleSelectAll = () => {
    if (selectedLeads.length === currentLeads.length) {
      setSelectedLeads([]);
    } else {
      setSelectedLeads(currentLeads.map((lead) => lead.customer_id));
    }
  };

  const handleBulkDelete = async () => {
    const result = await Swal.fire({
      title: "Are you sure?",
      text: `You are about to delete ${selectedLeads.length} lead(s). This cannot be undone.`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#DD6B55",
      cancelButtonColor: "#aaa",
      confirmButtonText: "Yes, delete them!",
    });
    if (result.isConfirmed) {
      try {
        // Simulate bulk delete API call; adjust based on actual API
        await Promise.all(
          selectedLeads.map((id) => api.delete(`/deletelead/${id}`))
        );
        setLeads((prev) =>
          prev.filter((lead) => !selectedLeads.includes(lead.customer_id))
        );
        setSelectedLeads([]);
        await Swal.fire({
          icon: "success",
          title: "Deleted!",
          text: "Selected leads have been removed.",
          confirmButtonColor: "#2798FF",
        });
      } catch (err) {
        Swal.fire({
          icon: "error",
          title: "Bulk Delete Failed",
          text: err.message || "An error occurred during deletion.",
          confirmButtonColor: "#DD6B55",
        });
      }
    }
  };

  // Filter handlers
  const handleFilterChange = (filterName, value) => {
    setFilters((prev) => ({
      ...prev,
      [filterName]: value,
    }));
    setCurrentPage(1);
  };

  // New handlers for dropdown and modal
  const toggleDropdown = (userId) => {
    setActiveDropdown(activeDropdown === userId ? null : userId);

    // If we're opening the dropdown, scroll it into view
    if (activeDropdown !== userId) {
      // Use setTimeout to ensure the dropdown is rendered before scrolling
      setTimeout(() => {
        const dropdownElement = document.querySelector(
          `[data-dropdown-id="${userId}"]`
        );
        if (dropdownElement) {
          dropdownElement.scrollIntoView({
            behavior: "smooth",
            block: "nearest",
          });
        }
      }, 0);
    }
  };

  const handleEdit = (lead) => {
    setEditingLead(lead);

    // Reset country-state-city related states
    setSelectedCountryObj(null);
    setSelectedStateObj(null);
    setSelectedCityObj(null);
    setCountries(Country.getAllCountries()); // Re-fetch all countries
    setStates([]);
    setCities([]);
    setCountrySearchTerm("");
    setStateSearchTerm("");
    setCitySearchTerm("");

    let followUpDate = "";
    let followUpTime = "";
    if (lead.follow_up_date) {
      const dateObj = new Date(lead.follow_up_date);
      followUpDate = dateObj.toLocaleDateString("en-CA", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
      }); // YYYY-MM-DD
      followUpTime = dateObj.toLocaleTimeString("en-US", {
        hour: "2-digit",
        minute: "2-digit",
        hour12: false,
      }); // HH:MM
    }

    // Parse the address from lead.city (which contains the full address as JSON)
    let blockUnitStreetName = "";
    let stateName = "";
    let countryName = "";
    let pincode = "";
    let cityName = "";

    let parsedAddress = null;
    if (lead.city && typeof lead.city === "string") {
      try {
        parsedAddress = JSON.parse(lead.city);
      } catch (e) {
        console.error("Error parsing lead.city JSON:", e);
      }
    } else if (lead.city && typeof lead.city === "object") {
      // If it's already an object (e.g., from an older API response or direct setting)
      parsedAddress = lead.city;
    }

    if (parsedAddress) {
      blockUnitStreetName = parsedAddress.name || "";
      cityName = parsedAddress.city || "";
      stateName = parsedAddress.state || "";
      countryName = parsedAddress.country || "";
      pincode = parsedAddress.pin || "";
    }

    setFormData({
      name: lead.customer_name,
      email: lead.email,
      phoneno: lead.contact,
      city: cityName, // Set the actual city name here
      whatsapp: lead.whatsapp_number,
      requirements: lead.requirements,
      source: lead.source,
      assigned_to:
        users.find((user) => user.name === lead.assigned_to)?.name || "",
      follow_up_date_input: followUpDate, // Set parsed date
      follow_up_time_input: followUpTime, // Set parsed time
      status: lead.status_name.toLowerCase().replace(/\s+/g, "_"),
      message: lead.message || "",
      role: lead.role || "User",
      is_approved: lead.is_approved,
      profile_pic: null,
      blockUnitStreetName: blockUnitStreetName,
      state: stateName,
      country: countryName,
      pincode: pincode,
    });
    setImagePreview(lead.profile_pic || null);
    setIsModalOpen(true);
    setActiveDropdown(null);

    // Also need to set selectedCountryObj and selectedStateObj for the dropdowns to work correctly on edit
    if (countryName) {
      const countryObj = Country.getAllCountries().find(
        (c) => c.name === countryName
      );
      if (countryObj) {
        setSelectedCountryObj(countryObj);
        setStates(State.getStatesOfCountry(countryObj.isoCode));
        setCountrySearchTerm(countryName); // Set search term so input shows name

        if (stateName) {
          const stateObj = State.getStatesOfCountry(countryObj.isoCode).find(
            (s) => s.name === stateName
          );
          if (stateObj) {
            setSelectedStateObj(stateObj);
            setCities(
              City.getCitiesOfState(stateObj.countryCode, stateObj.isoCode)
            );
            setStateSearchTerm(stateName); // Set search term so input shows name

            if (cityName) {
              const cityObj = City.getCitiesOfState(
                stateObj.countryCode,
                stateObj.isoCode
              ).find((c) => c.name === cityName);
              if (cityObj) {
                setSelectedCityObj(cityObj);
                setCitySearchTerm(cityName); // Set search term so input shows name
              }
            }
          }
        }
      }
    }
  };

  const handleInputChange = (e) => {
    const { name, value, files } = e.target;
    if (name === "profile_pic") {
      const file = files[0];
      if (file) {
        setFormData((prev) => ({
          ...prev,
          profile_pic: file,
        }));
        if (imagePreview) {
          URL.revokeObjectURL(imagePreview);
        }
        setImagePreview(URL.createObjectURL(file));
      }
    } else {
      setFormData((prev) => ({
        ...prev,
        [name]: value,
      }));
    }
  };

  // Handlers for Country, State, City pickers
  const handleCountrySearchChange = (e) => {
    const value = e.target.value;
    setCountrySearchTerm(value);
    setCountryDropdownOpen(true);

    // Clear dependent selections if country changes
    if (value === "") {
      setSelectedStateObj(null);
      setSelectedCityObj(null);
      setStates([]);
      setCities([]);
      setStateSearchTerm("");
      setCitySearchTerm("");
      setFormData((prev) => ({ ...prev, country: "", state: "", city: "" }));
    }
  };

  const handleCountrySelect = (country) => {
    setSelectedCountryObj(country);
    setCountrySearchTerm(country.name);
    setCountryDropdownOpen(false);
    setStates(State.getStatesOfCountry(country.isoCode));

    // Clear dependent selections
    setSelectedStateObj(null);
    setSelectedCityObj(null);
    setCities([]);
    setStateSearchTerm("");
    setCitySearchTerm("");

    setFormData((prev) => ({
      ...prev,
      country: country.name,
      state: "",
      city: "",
    }));
  };

  const handleStateSearchChange = (e) => {
    // Prevent state search if no country is selected
    if (!countrySearchTerm) {
      return;
    }

    const value = e.target.value;
    setStateSearchTerm(value);
    setStateDropdownOpen(true);

    // Clear dependent selections if state changes
    if (value === "") {
      setSelectedCityObj(null);
      setCities([]);
      setCitySearchTerm("");
      setFormData((prev) => ({ ...prev, state: "", city: "" }));
    }
  };

  const handleStateSelect = (state) => {
    setSelectedStateObj(state);
    setStateSearchTerm(state.name);
    setStateDropdownOpen(false);
    setCities(City.getCitiesOfState(state.countryCode, state.isoCode));

    // Clear dependent selections
    setSelectedCityObj(null);
    setCitySearchTerm("");

    setFormData((prev) => ({ ...prev, state: state.name, city: "" }));
  };

  const handleCitySearchChange = (e) => {
    // Prevent city search if no state is selected
    if (!stateSearchTerm) {
      return;
    }

    const value = e.target.value;
    setCitySearchTerm(value);
    setCityDropdownOpen(true);

    if (value === "") {
      setFormData((prev) => ({ ...prev, city: "" }));
    }
  };

  const handleCitySelect = (city) => {
    setSelectedCityObj(city);
    setCitySearchTerm(city.name);
    setCityDropdownOpen(false);
    setFormData((prev) => ({ ...prev, city: city.name }));
  };

  // Handle Bulk Assign
  const [isBulkAssignLoading, setIsBulkAssignLoading] = useState(false);
  // Add this ref to keep modal open after bulk assign or bulk edit
  const bulkEditJustSubmittedRef = useRef(false);
  const handleBulkAssign = async () => {
    console.log("handleBulkAssign called");
    if (selectedLeads.length === 0 || !selectedAssignee) {
      Swal.fire({
        icon: "error",
        title: "Selection Error",
        text: "Please select leads and an assignee to proceed.",
        confirmButtonColor: "#DD6B55",
      });
      return;
    }

    const assignedToUser = users.find((user) => user.name === selectedAssignee);

    if (!assignedToUser) {
      Swal.fire({
        icon: "error",
        title: "User Not Found",
        text: "Selected assignee not found in the user list.",
        confirmButtonColor: "#DD6B55",
      });
      return;
    }

    const assigneeId = assignedToUser.id;

    setIsBulkAssignLoading(true); // Set loading state
    bulkEditJustSubmittedRef.current = true; // <-- Set ref before operation

    let loadingAlert;
    try {
      loadingAlert = Swal.fire({
        title: `Assigning ${selectedLeads.length} Leads...`,
        html: "Please wait, this may take a moment.",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      const successfulAssignments = [];
      const failedAssignments = [];

      for (const leadId of selectedLeads) {
        try {
          const leadToUpdate = leads.find(
            (lead) => lead.customer_id === leadId
          );
          if (!leadToUpdate) {
            failedAssignments.push({
              id: leadId,
              reason: "Lead not found locally.",
            });
            continue;
          }

          const formDataToSend = new FormData();
          // Populate formDataToSend with existing lead data (excluding profile_image if not changed)
          // Ensure all required fields are sent, even if only assigned_to is changing
          const bulkData = {
            customer_name: leadToUpdate.customer_name,
            email: leadToUpdate.email,
            contact_number: leadToUpdate.contact,
            city: leadToUpdate.city,
            whatsapp_number: leadToUpdate.whatsapp_number,
            requirements: leadToUpdate.requirements,
            source: leadToUpdate.source,
            follow_up_date: leadToUpdate.follow_up_date,
            status: leadToUpdate.status_name, // Use existing status name
            status_id: leadToUpdate.status_id, // Use existing status ID
            message: leadToUpdate.message || "",
            assigned_to: assigneeId,
          };
          Object.keys(bulkData).forEach((key) => {
            const value = bulkData[key];
            if (value !== null && value !== undefined) {
              formDataToSend.append(key, value);
            }
          });

          const response = await api.post(
            `/udateleads/${leadId}`,
            formDataToSend,
            {
              headers: {
                "Content-Type": "multipart/form-data",
              },
            }
          );

          if (response.data.status || response.data.success) {
            successfulAssignments.push(leadId);
          } else {
            failedAssignments.push({
              id: leadId,
              reason: response.data.message || "Unknown error",
            });
          }
        } catch (err) {
          failedAssignments.push({
            id: leadId,
            reason: err.message || "Network error",
          });
        }
      }

      await loadingAlert.close();

      if (successfulAssignments.length > 0) {
        await Swal.fire({
          icon: "success",
          title: "Bulk Assignment Complete!",
          html: `Successfully assigned ${
            successfulAssignments.length
          } lead(s).<br/>${
            failedAssignments.length > 0
              ? `<span class=\"text-red-500\">${failedAssignments.length} lead(s) failed to assign.</span>`
              : ""
          }`,
          confirmButtonColor: "#2798FF",
        });
      } else if (failedAssignments.length > 0) {
        await Swal.fire({
          icon: "error",
          title: "Bulk Assignment Failed",
          html: `Failed to assign all leads. ${failedAssignments.length} lead(s) encountered errors.`, // You might show more details here if needed
          confirmButtonColor: "#DD6B55",
        });
      } else {
        // Should not happen if selectedLeads is not empty
        await Swal.fire({
          icon: "info",
          title: "No Leads Assigned",
          text: "No leads were assigned.",
          confirmButtonColor: "#DD6B55",
        });
      }

      // Refresh leads and reset state
      await fetchLeads();
      setSelectedAssignee("");
      setAssigneeSearchTerm("");
      // Do NOT close the modal here if bulkEditJustSubmittedRef.current is true
      // Only close when user explicitly closes
      console.log("handleBulkAssign completed");
    } catch (err) {
      if (loadingAlert) {
        await loadingAlert.close();
      }
      Swal.fire({
        icon: "error",
        title: "Bulk Assignment Error",
        text:
          err.message || "An unexpected error occurred during bulk assignment.",
        confirmButtonColor: "#DD6B55",
      });
    } finally {
      setIsBulkAssignLoading(false); // Unset loading state
      bulkEditJustSubmittedRef.current = false; // Reset ref after operation
    }
  };

  // DELETE
  const handleDelete = async (id) => {
    const result = await Swal.fire({
      title: "Are you sure?",
      text: "This cannot be undone.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#DD6B55",
      cancelButtonColor: "#aaa",
      confirmButtonText: "Yes, delete it!",
    });
    if (result.isConfirmed) {
      try {
        const response = await api.delete(`/deletelead/${id}`);
        if (response.data.status || response.data.success) {
          setLeads((prev) => prev.filter((l) => l.customer_id !== id));
          await Swal.fire({
            icon: "success",
            title: "Lead Deleted!",
            text: response.data.message || "Lead has been removed.",
            confirmButtonColor: "#2798FF",
          });
        } else {
          throw new Error(response.data.message || "Server rejected delete");
        }
      } catch (err) {
        Swal.fire({
          icon: "error",
          title: "Delete Lead Failed",
          text: err.message,
          confirmButtonColor: "#DD6B55",
        });
      }
    }
    setOpenStatusMenu(null);
    setActiveDropdown(null);
  };

  const handleSubmit = async (e, action = "save") => {
    console.log("button pressed");
    if (e && e.preventDefault) e.preventDefault();
    console.log(formData, "formData");
    console.log(statuses, "statuses");
    const validationErrors = validateFormData(formData);
    if (validationErrors.length > 0) {
      await Swal.fire({
        icon: "error",
        title: "Validation Error",
        html: validationErrors.map((err) => `<div>${err}</div>`).join(""),
        confirmButtonColor: "#DD6B55",
      });
      return false; // Return false on validation error
    }

    try {
      const formDataToSend = new FormData();
      // Find the selected status object from statuses array
      const selectedStatus = statuses.find(
        (status) =>
          status &&
          status.status_name &&
          status.status_name.toLowerCase().replace(/\s+/g, "_") ===
            formData.status
      );

      if (!selectedStatus) {
        throw new Error("Invalid status selected");
      }

      // --- FIX: Convert assigned_to (name) to user ID (int) with role check ---
      let assignedToId;
      if (user?.role === "admin") {
        // If admin, find user by name from the form data
        const assignedUser = users.find((u) => u.name === formData.assigned_to);
        assignedToId = assignedUser ? assignedUser.id : 0; // Default to 0 if not found
      } else {
        // If not admin, force assignment to the current user
        assignedToId = user.id;
      }

      // Construct full address as JSON object
      const addressObject = {
        name: formData.blockUnitStreetName,
        city: formData.city,
        state: formData.state,
        country: formData.country,
        pin: formData.pincode,
      };

      // Combine follow_up_date_input and follow_up_time_input
      let combinedFollowUpDate = null;
      if (formData.follow_up_date_input) {
        const datePart = formData.follow_up_date_input;
        const timePart = formData.follow_up_time_input
          ? formData.follow_up_time_input + ":00"
          : formData.follow_up_time_input;
        combinedFollowUpDate = `${datePart} ${timePart}`;
      }
      // Format the data to match API keys
      const formattedData = {
        customer_name: formData.name,
        email: formData.email,
        contact_number: formData.phoneno,
        city: JSON.stringify(addressObject),
        whatsapp_number: formData.whatsapp,
        requirements: formData.requirements,
        source: formData.source,
        assigned_to: parseInt(assignedToId, 10) || 0, // Ensure it's an integer
        follow_up_date: combinedFollowUpDate,
        status: selectedStatus.status_name,
        status_id: selectedStatus.status_id,
        message: formData.message,
        profile_image: formData.profile_pic,
      };

      // Append all formatted fields, but skip null/undefined values
      Object.keys(formattedData).forEach((key) => {
        const value = formattedData[key];
        if (key === "profile_image" && value) {
          formDataToSend.append("profile_image", value);
        } else if (value !== null && value !== undefined) {
          formDataToSend.append(key, value);
        }
      });

      const prevStatus = editingLead.status_name;
      const response = await api.post(
        `/udateleads/${editingLead.customer_id}`,
        formDataToSend,
        {
          headers: {
            "Content-Type": "multipart/form-data",
          },
        }
      );
      if (response.data.status || response.data.success) {
        // Update the leads list with the edited lead
        setLeads((prevLeads) =>
          prevLeads.map((lead) =>
            lead.customer_id === editingLead.customer_id
              ? {
                  ...lead,
                  customer_name: response.data.lead.customer_name,
                  email: response.data.lead.email,
                  contact: response.data.lead.contact_number,
                  city: response.data.lead.city,
                  whatsapp_number: response.data.lead.whatsapp_number,
                  requirements: response.data.lead.requirements,
                  source: response.data.lead.source,
                  assigned_to:
                    users.find(
                      (user) => user.id == response.data.lead.assigned_to
                    )?.name || response.data.lead.assigned_to,
                  follow_up_date: response.data.lead.follow_up_date,
                  status_name: response.data.lead.status,
                  message: response.data.lead.message,
                  profile_pic: response.data.lead.profile_image, // Use profile_image from response
                }
              : lead
          )
        );
        if (action === "save") {
          setIsModalOpen(false); // Only close modal on Save
        }
        await Swal.fire({
          icon: "success",
          title: "Lead Updated",
          text:
            response.data.message ||
            `${formData.name} was successfully updated.`,
          confirmButtonColor: "#2798FF",
        });
        await fetchLeads(); // Instead of window.location.reload()

        // Update editingLead and formData with fresh data only for navigation scenarios
        if (action === "next" || action === "back") {
          const updatedLead = leads.find(
            (l) => l.customer_id === editingLead.customer_id
          );

          if (updatedLead) {
            setEditingLead(updatedLead); // Crucially update editingLead with fresh data

            // Re-populate formData with the fresh lead data
            let followUpDate = "";
            let followUpTime = "";
            if (updatedLead.follow_up_date) {
              const dateObj = new Date(updatedLead.follow_up_date);
              followUpDate = dateObj.toLocaleDateString("en-CA", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
              }); // YYYY-MM-DD format for input type="date"
              followUpTime = dateObj.toLocaleTimeString("en-US", {
                hour: "2-digit",
                minute: "2-digit",
                hour12: false,
              }); // HH:MM format for input type="time"
            }

            let blockUnitStreetName = "";
            let stateName = "";
            let countryName = "";
            let pincode = "";
            let cityName = "";
            let parsedAddress = null;

            if (updatedLead.city && typeof updatedLead.city === "string") {
              try {
                parsedAddress = JSON.parse(updatedLead.city);
              } catch (e) {
                console.error("Error parsing lead.city JSON:", e);
              }
            } else if (
              updatedLead.city &&
              typeof updatedLead.city === "object"
            ) {
              parsedAddress = updatedLead.city;
            }

            if (parsedAddress) {
              blockUnitStreetName = parsedAddress.name || "";
              cityName = parsedAddress.city || "";
              stateName = parsedAddress.state || "";
              countryName = parsedAddress.country || "";
              pincode = parsedAddress.pin || "";
            }

            setFormData({
              name: updatedLead.customer_name,
              email: updatedLead.email,
              phoneno: updatedLead.contact,
              city: cityName,
              whatsapp: updatedLead.whatsapp_number,
              requirements: updatedLead.requirements,
              source: updatedLead.source,
              assigned_to:
                users.find((user) => user.name === updatedLead.assigned_to)
                  ?.name || "",
              follow_up_date_input: followUpDate,
              follow_up_time_input: followUpTime,
              status: updatedLead.status_name
                .toLowerCase()
                .replace(/\s+/g, "_"),
              message: updatedLead.message || "",
              role: updatedLead.role || "User",
              is_approved: updatedLead.is_approved,
              profile_pic: null,
              blockUnitStreetName: blockUnitStreetName,
              state: stateName,
              country: countryName,
              pincode: pincode,
            });
            setImagePreview(updatedLead.profile_pic || null);
          }
        }

        setOpenStatusMenu(null);
        setActiveDropdown(null);
        const newStatus = response.data.lead.status;
        // If status changed, remove from editableLeads and show SweetAlert
        if (prevStatus !== newStatus) {
          console.log(
            "[DEBUG] Removing item from editableLeads due to status change:",
            {
              customer_id: editingLead.customer_id,
              prevStatus,
              newStatus,
              lead: response.data.lead,
            }
          );
          setEditableLeads((prev) =>
            prev.filter((l) => l.customer_id !== editingLead.customer_id)
          );
          await Swal.fire({
            icon: "info",
            title: "Item Removed",
            text: "This item is out of view because its status has changed.",
            confirmButtonColor: "#2798FF",
          });
          // After removal, modal navigation is handled by useEffect below
          return true;
        }
        return true; // Return true on success
      } else {
        throw new Error(response.data.message || "Failed to update lead");
      }
    } catch (err) {
      let errorTitle = "Error Updating Lead";
      let errorMessage =
        "An error occurred while updating the lead. Please try again.";

      if (err.response) {
        if (err.response.status === 422) {
          const errors = err.response.data.errors;
          if (errors) {
            const firstError = Object.values(errors)[0];
            if (Array.isArray(firstError) && firstError.length > 0) {
              errorMessage = firstError[0];
            }
          }
        } else if (err.response.data?.message) {
          errorMessage = err.response.data.message;
        }
      } else if (err.request) {
        errorTitle = "Network Error";
        errorMessage =
          "Unable to connect to the server. Please check your internet connection.";
      } else {
        errorMessage = err.message;
      }

      await Swal.fire({
        icon: "error",
        title: errorTitle,
        text: errorMessage,
        confirmButtonColor: "#DD6B55",
      });
      setOpenStatusMenu(null);
      setActiveDropdown(null);
      return false; // Return false on error
    }
  };

  const handleStatusToggle = async (lead) => {
    const newIsApproved = !lead.is_approved;
    try {
      const response = await api.post(`/approval/${lead.customer_id}`, {
        is_approved: newIsApproved ? 1 : 0,
      });
      if (response.data.status || response.data.success) {
        setLeads((prev) =>
          prev.map((l) =>
            l.customer_id === lead.customer_id
              ? { ...l, is_approved: newIsApproved }
              : l
          )
        );
        await Swal.fire({
          icon: "success",
          title: "Status Updated",
          text:
            response.data.message ||
            `${lead.customer_name} is now ${
              newIsApproved ? "Approved" : "Pending"
            }.`,
          confirmButtonColor: "#2798FF",
        });
      } else {
        throw new Error(
          response.data.message || "Server did not confirm status update"
        );
      }
    } catch (err) {
      Swal.fire({
        icon: "error",
        title: "Failed to update lead status",
        text: err.message || "An error occurred",
        confirmButtonColor: "#DD6B55",
      });
    }
    setOpenStatusMenu(null);
    setActiveDropdown(null);
  };

  // Replace renderAssignToDropdown with the version from createLeads.jsx
  const renderAssignToDropdown = (currentValue, onValueChange) => (
    <div className="relative" ref={assignToDropdownRef}>
      <button
        type="button"
        onClick={() => setIsAssignToDropdownOpen(!isAssignToDropdownOpen)}
        className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] text-left flex items-center justify-between cursor-pointer"
      >
        <span>
          {users.find((user) => user.name === currentValue)?.name ||
            "Select User"}
        </span>
        <svg
          className={`w-4 h-4 transition-transform ${
            isAssignToDropdownOpen ? "rotate-180" : ""
          }`}
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M19 9l-7 7-7-7"
          />
        </svg>
      </button>
      {isAssignToDropdownOpen && (
        <div className="absolute custom-scrollbar top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto cursor-pointer">
          {users.map((user) => (
            <button
              key={user.id}
              type="button"
              onClick={() => {
                onValueChange(user.name); // Pass the user's name
                setIsAssignToDropdownOpen(false);
              }}
              className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
            >
              {user.name}
            </button>
          ))}
        </div>
      )}
    </div>
  );

  // Cleanup image preview URLs when component unmounts
  useEffect(() => {
    return () => {
      if (imagePreview) {
        URL.revokeObjectURL(imagePreview);
      }
    };
  }, [imagePreview]);

  // Function to handle submission of the Create Lead form:

  // New handler for file selection (drag/drop or input)
  const handleFileChange = (e) => {
    const file = e.target.files ? e.target.files[0] : e.dataTransfer.files[0];
    if (file && file.type === "text/csv") {
      setSelectedFile(file);
    } else {
      Swal.fire({
        icon: "error",
        title: "Invalid File Type",
        text: "Please upload a CSV file.",
        confirmButtonColor: "#DD6B55",
      });
      setSelectedFile(null);
    }
  };

  // Function to handle the actual CSV file upload
  const uploadCsvFile = async () => {
    if (!selectedFile) {
      Swal.fire({
        icon: "error",
        title: "No File Selected",
        text: "Please select a CSV file to import.",
        confirmButtonColor: "#DD6B55",
      });
      return;
    }

    setIsImportModalOpen(false);
    let loadingAlert;
    try {
      loadingAlert = Swal.fire({
        title: "Importing Leads...",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      const formData = new FormData();
      formData.append("csv_file", selectedFile);

      const response = await api.post("/leads-import", formData, {
        headers: {
          "Content-Type": "multipart/form-data",
        },
      });

      await loadingAlert.close();
      if (response.data.success) {
        await Swal.fire({
          icon: "success",
          title: "Import Successful!",
          text:
            response.data.message ||
            `Successfully imported ${response.data.imported} leads.`,
          confirmButtonColor: "#2798FF",
        });
        await fetchLeads(); // Instead of page reload
      } else {
        throw new Error(response.data.message || "Failed to import leads.");
      }
    } catch (err) {
      if (loadingAlert) {
        await loadingAlert.close();
      }
      Swal.fire({
        icon: "error",
        title: "Import Failed",
        text: err.message || "An error occurred during import.",
        confirmButtonColor: "#DD6B55",
      });
    }
    setSelectedFile(null); // Clear the selected file
  };

  // Add handlers for CSV import and export
  const handleImportCsv = () => {
    setSelectedFile(null); // Clear any previously selected file
    setIsImportModalOpen(true);
  };

  const handleExportCsv = async () => {
    setIsCsvDropdownOpen(false);
    let loadingAlert;
    try {
      loadingAlert = Swal.fire({
        title: "Exporting Leads...",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });
      const response = await api.get("/leads-export", {
        responseType: "blob", // Important for file downloads
      });
      await loadingAlert.close();
      if (response.data) {
        const url = window.URL.createObjectURL(new Blob([response.data]));
        const link = document.createElement("a");
        link.href = url;
        link.setAttribute("download", "leads.csv");
        document.body.appendChild(link);
        link.click();
        link.parentNode.removeChild(link);
        await Swal.fire({
          icon: "success",
          title: "Export Successful!",
          text: "Leads exported to leads.csv.",
          confirmButtonColor: "#2798FF",
        });
      } else {
        throw new Error("Failed to export leads: No data received.");
      }
    } catch (err) {
      if (loadingAlert) {
        await loadingAlert.close();
      }
      Swal.fire({
        icon: "error",
        title: "Export Failed",
        text: err.message || "An error occurred during export.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  const handleDownloadSample = async () => {
    let loadingAlert;
    try {
      loadingAlert = Swal.fire({
        title: "Downloading Sample...",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      const response = await api.get("/leads-sample-download", {
        responseType: "blob", // Important for file downloads
      });

      await loadingAlert.close();

      if (response.data) {
        const url = window.URL.createObjectURL(new Blob([response.data]));
        const link = document.createElement("a");
        link.href = url;
        link.setAttribute("download", "sample_leads.csv");
        document.body.appendChild(link);
        link.click();
        link.parentNode.removeChild(link);
        await Swal.fire({
          icon: "success",
          title: "Download Successful!",
          text: "Sample leads CSV downloaded.",
          confirmButtonColor: "#2798FF",
        });
      } else {
        throw new Error("Failed to download sample: No data received.");
      }
    } catch (err) {
      if (loadingAlert) {
        await loadingAlert.close();
      }
      Swal.fire({
        icon: "error",
        title: "Download Failed",
        text: err.message || "An error occurred during download.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  // Place this useEffect after other useEffects
  useEffect(() => {
    const handleClickOutside = (event) => {
      // Debug log for document event
      console.log("Document onMouseDown", event.target);
      if (
        activeDropdown &&
        dropdownNode &&
        !dropdownNode.contains(event.target)
      ) {
        setActiveDropdown(null);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [activeDropdown, dropdownNode]);

  const { user, rolePermissions } = useAuth();
  const location = useLocation();

  // Extract module name from URL (e.g., 'leads' from '/leads/all')
  const pathParts = location.pathname.split("/").filter(Boolean);
  const moduleNameFromUrl = pathParts[0] ? pathParts[0].toLowerCase() : null;

  // Find permissions for the module from rolePermissions
  const permissionsForLeadsModule = useMemo(() => {
    if (rolePermissions === "ALL") return ["view", "create", "edit", "delete"];
    if (!moduleNameFromUrl || !Array.isArray(rolePermissions)) return [];
    const found = rolePermissions.find(
      (perm) => perm.module && perm.module.toLowerCase() === moduleNameFromUrl
    );
    return found ? found.permissions : [];
  }, [rolePermissions, moduleNameFromUrl]);

  // Permission checks for bulk assign and CSV
  const hasBulkAssignPermission =
    rolePermissions === "ALL" || !rolePermissions?.includes("noBulkAssign");
  const hasCsvPermission =
    rolePermissions === "ALL" || !rolePermissions?.includes("noCsv");

  // Bulk Edit state and refs
  const [bulkEditStatusSearch, setBulkEditStatusSearch] = useState("");
  const [isBulkEditStatusDropdownOpen, setIsBulkEditStatusDropdownOpen] =
    useState(false);
  const [bulkEditSelectedStatus, setBulkEditSelectedStatus] = useState(null);
  const bulkEditStatusDropdownRef = useRef(null);
  const bulkEditAssigneeDropdownRef = useRef(null);

  // Add useEffect for bulk edit assignee dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        bulkEditAssigneeDropdownRef.current &&
        !bulkEditAssigneeDropdownRef.current.contains(event.target)
      ) {
        setIsAssigneeDropdownOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for bulk edit status dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        bulkEditStatusDropdownRef.current &&
        !bulkEditStatusDropdownRef.current.contains(event.target)
      ) {
        setIsBulkEditStatusDropdownOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Utility function for safe appending to FormData (used in bulk edit)
  const safeAppend = (formData, key, value) => {
    formData.append(key, value === null || value === undefined ? "" : value);
  };

  // Bulk Edit: Change Status for selected leads
  const handleBulkChangeStatus = async () => {
    if (!bulkEditSelectedStatus || selectedLeads.length === 0) return;
    let loadingAlert;
    try {
      loadingAlert = Swal.fire({
        title: `Updating Status for ${selectedLeads.length} Leads...`,
        html: "Please wait, this may take a moment.",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });
      const successfulUpdates = [];
      const failedUpdates = [];
      for (const leadId of selectedLeads) {
        try {
          const leadToUpdate = leads.find(
            (lead) => lead.customer_id === leadId
          );
          if (!leadToUpdate) {
            failedUpdates.push({
              id: leadId,
              reason: "Lead not found locally.",
            });
            continue;
          }
          const formDataToSend = new FormData();
          safeAppend(
            formDataToSend,
            "customer_name",
            leadToUpdate.customer_name
          );
          safeAppend(formDataToSend, "email", leadToUpdate.email);
          safeAppend(formDataToSend, "contact_number", leadToUpdate.contact);
          safeAppend(formDataToSend, "city", leadToUpdate.city);
          safeAppend(
            formDataToSend,
            "whatsapp_number",
            leadToUpdate.whatsapp_number
          );
          safeAppend(formDataToSend, "requirements", leadToUpdate.requirements);
          safeAppend(formDataToSend, "source", leadToUpdate.source);
          safeAppend(
            formDataToSend,
            "follow_up_date",
            leadToUpdate.follow_up_date
          );
          safeAppend(
            formDataToSend,
            "status",
            bulkEditSelectedStatus.status_name
          );
          safeAppend(
            formDataToSend,
            "status_id",
            bulkEditSelectedStatus.status_id
          );
          safeAppend(formDataToSend, "message", leadToUpdate.message);
          // Ensure assigned_to is always an integer user ID
          let assignedToId = leadToUpdate.assigned_to;
          if (typeof assignedToId === "string" && isNaN(Number(assignedToId))) {
            const userObj = users.find((u) => u.name === assignedToId);
            assignedToId = userObj ? userObj.id : "";
          }
          if (!assignedToId || isNaN(Number(assignedToId))) {
            assignedToId = 0;
          }
          safeAppend(formDataToSend, "assigned_to", parseInt(assignedToId, 10));
          const response = await api.post(
            `/udateleads/${leadId}`,
            formDataToSend,
            {
              headers: {
                "Content-Type": "multipart/form-data",
              },
            }
          );
          if (response.data.status || response.data.success) {
            successfulUpdates.push(leadId);
          } else {
            failedUpdates.push({
              id: leadId,
              reason: response.data.message || "Unknown error",
            });
          }
        } catch (err) {
          failedUpdates.push({
            id: leadId,
            reason: err.message || "Network error",
          });
        }
      }
      await loadingAlert.close();
      if (successfulUpdates.length > 0) {
        await Swal.fire({
          icon: "success",
          title: "Bulk Status Update Complete!",
          html: `Successfully updated status for ${
            successfulUpdates.length
          } lead(s).<br/>${
            failedUpdates.length > 0
              ? `<span class=\"text-red-500\">${failedUpdates.length} lead(s) failed to update.</span>`
              : ""
          }`,
          confirmButtonColor: "#2798FF",
        });
      } else if (failedUpdates.length > 0) {
        await Swal.fire({
          icon: "error",
          title: "Bulk Status Update Failed",
          html: `Failed to update status for all leads. ${failedUpdates.length} lead(s) encountered errors.`,
          confirmButtonColor: "#DD6B55",
        });
      } else {
        await Swal.fire({
          icon: "info",
          title: "No Status Updated",
          text: "No leads were updated.",
          confirmButtonColor: "#DD6B55",
        });
      }
      await fetchLeads();
      setBulkEditStatusSearch("");
      setBulkEditSelectedStatus(null);
      setIsBulkEditStatusDropdownOpen(false);
      setSelectedLeads([]); // Clear selectedLeads after status change
    } catch (err) {
      if (loadingAlert) {
        await loadingAlert.close();
      }
      Swal.fire({
        icon: "error",
        title: "Bulk Status Update Error",
        text:
          err.message ||
          "An unexpected error occurred during bulk status update.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  const handleBulkDeleteMessage = async () => {
    if (selectedLeads.length === 0) return;
    let loadingAlert;
    try {
      loadingAlert = Swal.fire({
        title: `Deleting Message for ${selectedLeads.length} Leads...`,
        html: "Please wait, this may take a moment.",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });
      const successfulUpdates = [];
      const failedUpdates = [];
      for (const leadId of selectedLeads) {
        try {
          const leadToUpdate = leads.find(
            (lead) => lead.customer_id === leadId
          );
          if (!leadToUpdate) {
            failedUpdates.push({
              id: leadId,
              reason: "Lead not found locally.",
            });
            continue;
          }
          const formDataToSend = new FormData();
          safeAppend(
            formDataToSend,
            "customer_name",
            leadToUpdate.customer_name
          );
          safeAppend(formDataToSend, "email", leadToUpdate.email);
          safeAppend(formDataToSend, "contact_number", leadToUpdate.contact);
          safeAppend(formDataToSend, "city", leadToUpdate.city);
          safeAppend(
            formDataToSend,
            "whatsapp_number",
            leadToUpdate.whatsapp_number
          );
          safeAppend(formDataToSend, "requirements", leadToUpdate.requirements);
          safeAppend(formDataToSend, "source", leadToUpdate.source);

          let combinedFollowUpDate = "";
          if (leadToUpdate.follow_up_date_input) {
            const datePart = leadToUpdate.follow_up_date_input;
            const timePart = leadToUpdate.follow_up_time_input || "00:00:00";
            combinedFollowUpDate = `${datePart} ${timePart}:00`;
          }
          safeAppend(formDataToSend, "follow_up_date", combinedFollowUpDate);
          // Do NOT send follow_up_time as a separate field

          safeAppend(formDataToSend, "status", leadToUpdate.status_name);
          safeAppend(formDataToSend, "status_id", leadToUpdate.status_id);
          safeAppend(formDataToSend, "message", ""); // Clear message
          let assignedToId = leadToUpdate.assigned_to;
          if (typeof assignedToId === "string" && isNaN(Number(assignedToId))) {
            const userObj = users.find((u) => u.name === assignedToId);
            assignedToId = userObj ? userObj.id : "";
          }
          if (!assignedToId || isNaN(Number(assignedToId))) {
            assignedToId = 0;
          }
          safeAppend(formDataToSend, "assigned_to", parseInt(assignedToId, 10));
          const response = await api.post(
            `/udateleads/${leadId}`,
            formDataToSend,
            { headers: { "Content-Type": "multipart/form-data" } }
          );
          if (response.data.status || response.data.success) {
            successfulUpdates.push(leadId);
          } else {
            failedUpdates.push({
              id: leadId,
              reason: response.data.message || "Unknown error",
            });
          }
        } catch (err) {
          failedUpdates.push({
            id: leadId,
            reason: err.message || "Network error",
          });
        }
      }
      await loadingAlert.close();
      if (successfulUpdates.length > 0) {
        await Swal.fire({
          icon: "success",
          title: "Bulk Message Delete Complete!",
          html: `Successfully deleted message for ${
            successfulUpdates.length
          } lead(s).<br/>${
            failedUpdates.length > 0
              ? `<span class=\"text-red-500\">${failedUpdates.length} lead(s) failed.</span>`
              : ""
          }`,
          confirmButtonColor: "#2798FF",
        });
      } else if (failedUpdates.length > 0) {
        await Swal.fire({
          icon: "error",
          title: "Bulk Message Delete Failed",
          html: `Failed to delete message for all leads. ${failedUpdates.length} lead(s) encountered errors.`,
          confirmButtonColor: "#DD6B55",
        });
      }
      const refreshResponse = await api.get("/showlead");
      if (refreshResponse.data.success) {
        setLeads(
          Array.isArray(refreshResponse.data.result)
            ? refreshResponse.data.result
            : []
        );
      } else {
        setLeads([]);
      }
    } catch (err) {
      if (loadingAlert) await loadingAlert.close();
      Swal.fire({
        icon: "error",
        title: "Bulk Message Delete Error",
        text: err.message || "An unexpected error occurred.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  const handleBulkDeleteFollowUpDate = async (isMessageDeleted = false) => {
    if (selectedLeads.length === 0) return;
    let loadingAlert;
    try {
      loadingAlert = Swal.fire({
        title: `Deleting Follow Up Date for ${selectedLeads.length} Leads...`,
        html: "Please wait, this may take a moment.",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });
      const successfulUpdates = [];
      const failedUpdates = [];
      for (const leadId of selectedLeads) {
        try {
          const leadToUpdate = leads.find(
            (lead) => lead.customer_id === leadId
          );
          if (!leadToUpdate) {
            failedUpdates.push({
              id: leadId,
              reason: "Lead not found locally.",
            });
            continue;
          }
          const formDataToSend = new FormData();
          safeAppend(
            formDataToSend,
            "customer_name",
            leadToUpdate.customer_name
          );
          safeAppend(formDataToSend, "email", leadToUpdate.email);
          safeAppend(formDataToSend, "contact_number", leadToUpdate.contact);
          safeAppend(formDataToSend, "city", leadToUpdate.city);
          safeAppend(
            formDataToSend,
            "whatsapp_number",
            leadToUpdate.whatsapp_number
          );
          safeAppend(formDataToSend, "requirements", leadToUpdate.requirements);
          safeAppend(formDataToSend, "source", leadToUpdate.source);
          safeAppend(formDataToSend, "follow_up_date", ""); // Clear follow up date
          safeAppend(formDataToSend, "follow_up_time", ""); // Clear follow up time
          safeAppend(formDataToSend, "status", leadToUpdate.status_name);
          safeAppend(formDataToSend, "status_id", leadToUpdate.status_id);
          if (!isMessageDeleted) {
            safeAppend(formDataToSend, "message", leadToUpdate.message);
          }
          let assignedToId = leadToUpdate.assigned_to;
          if (typeof assignedToId === "string" && isNaN(Number(assignedToId))) {
            const userObj = users.find((u) => u.name === assignedToId);
            assignedToId = userObj ? userObj.id : "";
          }
          if (!assignedToId || isNaN(Number(assignedToId))) {
            assignedToId = 0;
          }
          safeAppend(formDataToSend, "assigned_to", parseInt(assignedToId, 10));
          const response = await api.post(
            `/udateleads/${leadId}`,
            formDataToSend,
            { headers: { "Content-Type": "multipart/form-data" } }
          );
          if (response.data.status || response.data.success) {
            successfulUpdates.push(leadId);
          } else {
            failedUpdates.push({
              id: leadId,
              reason: response.data.message || "Unknown error",
            });
          }
        } catch (err) {
          failedUpdates.push({
            id: leadId,
            reason: err.message || "Network error",
          });
        }
      }
      await loadingAlert.close();
      if (successfulUpdates.length > 0) {
        await Swal.fire({
          icon: "success",
          title: "Bulk Follow Up Date Delete Complete!",
          html: `Successfully deleted follow up date for ${
            successfulUpdates.length
          } lead(s).<br/>${
            failedUpdates.length > 0
              ? `<span class=\"text-red-500\">${failedUpdates.length} lead(s) failed.</span>`
              : ""
          }`,
          confirmButtonColor: "#2798FF",
        });
      } else if (failedUpdates.length > 0) {
        await Swal.fire({
          icon: "error",
          title: "Bulk Follow Up Date Delete Failed",
          html: `Failed to delete follow up date for all leads. ${failedUpdates.length} lead(s) encountered errors.`,
          confirmButtonColor: "#DD6B55",
        });
      }
      const refreshResponse = await api.get("/showlead");
      if (refreshResponse.data.success) {
        setLeads(
          Array.isArray(refreshResponse.data.result)
            ? refreshResponse.data.result
            : []
        );
      } else {
        setLeads([]);
      }
    } catch (err) {
      if (loadingAlert) await loadingAlert.close();
      Swal.fire({
        icon: "error",
        title: "Bulk Follow Up Date Delete Error",
        text: err.message || "An unexpected error occurred.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  // Add state for Bulk Edit Modal
  const [isBulkEditModalOpen, setIsBulkEditModalOpen] = useState(false);

  // Add useEffect for filter dropdowns click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        activeDropdown === "customerName" &&
        customerNameDropdownRef.current &&
        !customerNameDropdownRef.current.contains(event.target)
      ) {
        setActiveDropdown(null);
      }
      if (
        activeDropdown === "city" &&
        cityFilterDropdownRef.current &&
        !cityFilterDropdownRef.current.contains(event.target)
      ) {
        setActiveDropdown(null);
      }
      if (
        activeDropdown === "source" &&
        sourceFilterDropdownRef.current &&
        !sourceFilterDropdownRef.current.contains(event.target)
      ) {
        setActiveDropdown(null);
      }
      if (
        activeDropdown === "assignedTo" &&
        assignedToFilterDropdownRef.current &&
        !assignedToFilterDropdownRef.current.contains(event.target)
      ) {
        setActiveDropdown(null);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [activeDropdown]);

  // Add state for editing lead index
  // const [editingLeadIndex, setEditingLeadIndex] = useState(null);

  // Add navigation handlers for Save and Next
  const handleEditBack = async (e) => {
    const success = await handleSubmit(e, "back");
    if (!success) return; // Only proceed if save was successful

    const currentLeadId = editingLead?.customer_id;
    const currentLeadIndex = filteredLeads.findIndex(
      (l) => l.customer_id === currentLeadId
    );

    console.log("[DEBUG] handleEditBack", { currentLeadIndex, filteredLeads });

    if (currentLeadIndex > 0) {
      const prevLead = filteredLeads[currentLeadIndex - 1];
      console.log("[DEBUG] Navigating to previous lead:", prevLead);
      handleEditWithIndex(prevLead);
    } else {
      closeModal();
    }
  };

  const handleEditNext = async (e) => {
    const success = await handleSubmit(e, "next");
    if (!success) return; // Only proceed if save was successful

    const currentLeadId = editingLead?.customer_id;
    const currentLeadIndex = filteredLeads.findIndex(
      (l) => l.customer_id === currentLeadId
    );

    console.log("[DEBUG] handleEditNext", { currentLeadIndex, filteredLeads });

    if (currentLeadIndex < filteredLeads.length - 1) {
      const nextLead = filteredLeads[currentLeadIndex + 1];
      console.log("[DEBUG] Navigating to next lead:", nextLead);
      handleEditWithIndex(nextLead);
    } else {
      closeModal();
    }
  };

  // Update handleEdit to set editingLeadIndex
  const originalHandleEdit = handleEdit;
  const handleEditWithIndex = (lead) => {
    console.log("[DEBUG] handleEditWithIndex called for lead:", lead);
    originalHandleEdit(lead);
    // Only set editableLeads if modal session not started
    if (!modalSessionStartedRef.current) {
      setEditableLeads([...filteredLeads]);
      modalSessionStartedRef.current = true;
      // No setEditingLeadIndex here!
    }
    // No setEditingLeadIndex here!
    // All index logic is now handled by currentIndex
  };

  // Fix: Assign To dropdown click outside handler
  useEffect(() => {
    if (!isAssignToDropdownOpen) return;
    const handleClickOutside = (event) => {
      if (
        assignToDropdownRef.current &&
        !assignToDropdownRef.current.contains(event.target)
      ) {
        setIsAssignToDropdownOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [isAssignToDropdownOpen]);

  useEffect(() => {
    console.log("CustomLeadManager mounted");
    return () => {
      console.log("CustomLeadManager unmounted");
    };
  }, []);

  useEffect(() => {
    console.log("isBulkAssignModalOpen:", isBulkAssignModalOpen);
  }, [isBulkAssignModalOpen]);

  // Add editableLeads state for modal navigation
  const [editableLeads, setEditableLeads] = useState([]);
  const modalSessionStartedRef = useRef(false); // <-- Fix: add this line

  // Helper useEffect: if current editingLead is not in editableLeads, auto-navigate or close modal
  useEffect(() => {
    if (!isModalOpen || !editingLead) return;
    const stillExists = editableLeads.some(
      (l) => l.customer_id === editingLead.customer_id
    );
    if (!stillExists) {
      console.log("[DEBUG] Current editingLead not found in editableLeads:", {
        editingLead,
        editableLeads,
        currentIndex,
      });
      // Try to move to next, then previous, else close modal
      const idx = currentIndex;
      if (editableLeads.length === 0) {
        closeModal();
      } else if (idx < editableLeads.length) {
        handleEditWithIndex(
          editableLeads[idx] || editableLeads[editableLeads.length - 1]
        );
      } else if (idx > 0) {
        handleEditWithIndex(editableLeads[idx - 1]);
      } else {
        closeModal();
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [editableLeads, isModalOpen, editingLead]);

  // Add closeModal helper
  const closeModal = () => {
    setIsModalOpen(false);
    setEditingLead(null);
    setEditableLeads([]); // Clear for next session
    modalSessionStartedRef.current = false;
  };

  // Compute currentIndex for navigation and disables
  const currentIndex = editableLeads.findIndex(
    (l) => l.customer_id === editingLead?.customer_id
  );
  console.log(
    "[DEBUG] currentIndex:",
    currentIndex,
    "editableLeads:",
    editableLeads
  );

  if (loading) {
    return (
      <div className="w-full min-h-[797px] flex items-center justify-center">
        Loading Leads...
      </div>
    );
  }

  return (
    <div
      className={`min-h-[797px] p-4 md:p-6 relative bg-gradient-to-br from-white to-[#E7F4FF] rounded-[10px] shadow-[2px_2px_6px_rgba(24,95,235,0.1)] flex flex-col w-full   ${
        isCollapsed
          ? "lg:max-w-[85vw] md:w-[85vw]"
          : "lg:max-w-[75vw] md:w-[80vw]"
      } md:mx-auto`}
    >
      {/* Header Section */}
      <div className="flex flex-wrap items-center justify-between gap-4 mb-8">
        {/* Title */}
        <h1 className="text-[20px] md:text-[22px] font-medium text-[#1F2837] whitespace-nowrap">
          {dynamicHeaderTitle}
        </h1>

        {/* Search Container */}
        <div className="flex-1 max-w-[400px] mx-1">
          {isMobile && !isSearchExpanded ? (
            <button
              onClick={handleSearchToggle}
              className="
          w-10 h-10
          flex items-center
          rounded-[6px]
          hover:bg-gray-50 transition-colors
        "
            >
              {/* search icon SVG */}
              <svg
                width="20"
                height="20"
                viewBox="0 0 22 22"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M10.5417 19.25C15.3512 19.25 19.25 15.3512 19.25 10.5417C19.25 5.73223 15.3512 1.83334 10.5417 1.83334C5.73223 1.83334 1.83334 5.73223 1.33334 10.5417C1.83334 15.3512 5.73223 19.25 10.5417 19.25Z"
                  stroke="#787374"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M18.3333 18.3333L20.1667 20.1667"
                  stroke="#787374"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>
          ) : (
            <div className="relative w-full">
              {/* Search icon inside input */}
              <div className="absolute left-4 top-1/2 -translate-y-1/2 pointer-events-none">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 22 22"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M10.5417 19.25C15.3512 19.25 19.25 15.3512 19.25 10.5417C19.25 5.73223 15.3512 1.83334 10.5417 1.83334C5.73223 1.83334 1.83334 5.73223 1.33334 10.5417C1.83334 15.3512 5.73223 19.25 10.5417 19.25Z"
                    stroke="#787374"
                    strokeWidth="1.5"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                  <path
                    d="M18.3333 18.3333L20.1667 20.1667"
                    stroke="#787374"
                    strokeWidth="1.5"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                </svg>
              </div>
              <input
                type="search"
                placeholder={isMobile ? "Search" : "Search by Name, Contact"}
                value={searchTerm}
                onChange={handleSearchChange}
                className="
            w-full
            h-[44px]
            pl-12 pr-4
            bg-[#E9F1F9]
            rounded-[6px]
            text-[#787374] placeholder-[#787374]
            focus:outline-none
            text-sm md:text-base lg:text-base
          "
                onBlur={handleSearchBlur}
                autoFocus={isMobile && isSearchExpanded}
              />
            </div>
          )}
        </div>

        {/* Actions: Create Lead + Display Dropdown + Bulk Actions */}
        <div className="flex flex-wrap items-center gap-3 md:gap-4 lg:gap-4">
          {hasBulkAssignPermission &&
            selectedLeads.length > 0 &&
            permissionsForLeadsModule.includes("edit") && (
              <button
                className="hover:bg-blue-500 bg-[#ef7e1b] text-white h-[44px] px-5 rounded-[8px] flex items-center justify-center"
                onClick={() => setIsBulkEditModalOpen(true)}
              >
                Bulk Edit
              </button>
            )}
          {hasBulkAssignPermission &&
            selectedLeads.length > 0 &&
            permissionsForLeadsModule.includes("delete") && (
              <button
                className="hover:bg-red-500 bg-[#DD6B55] text-white h-[44px] px-5 rounded-[8px] flex items-center justify-center"
                onClick={handleBulkDelete}
              >
                Bulk Delete
              </button>
            )}
          {/* CSV Import/Export Buttons - Permission Controlled */}
          {/* Uncomment and wrap your CSV dropdown here if you want to show/hide based on hasCsvPermission */}
          {/* {hasCsvPermission && (
            <div className="relative" ref={csvDropdownRef}>
              ...CSV Dropdown code...
            </div>
          )} */}
          <span className="text-[#727A90] text-sm md:text-base lg:text-base whitespace-nowrap">
            Show
          </span>
          <div className="relative min-w-[88px]" ref={itemsPerPageDropdownRef}>
            <button
              type="button"
              className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full min-w-[72px] md:min-w-[88px] lg:min-w-[88px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center"
              onClick={() => setIsItemsPerPageDropdownOpen((open) => !open)}
            >
              <span className="truncate text-left flex-1">{itemsPerPage}</span>
              <img
                src="/caret-down.svg"
                alt=""
                aria-hidden="true"
                className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
              />
            </button>
            {isItemsPerPageDropdownOpen && (
              <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
                {[5, 10, 20, 50].map((option) => (
                  <button
                    key={option}
                    type="button"
                    onClick={() => {
                      handleItemsPerPageChange(option);
                      setIsItemsPerPageDropdownOpen(false);
                    }}
                    className={`w-full px-3 py-2 text-left hover:bg-[#E7EFF8] ${
                      itemsPerPage === option
                        ? "bg-[#E7EFF8] font-bold text-[#ef7e1b]"
                        : "text-[#545454]"
                    }`}
                  >
                    {option}
                  </button>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Filter Section */}
      <div
        ref={filterDropdownRef}
        className={`grid grid-cols-2 gap-3 mb-2 ${
          rolePermissions === "ALL"
            ? "md:grid-cols-2 lg:grid-cols-6"
            : "md:grid-cols-2 lg:grid-cols-5"
        }`}
      >
        {/* Customer Name Dropdown */}
        <div className="relative" ref={customerNameDropdownRef}>
          <button
            type="button"
            className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[120px] lg:min-w-[120px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center cursor-pointer"
            onClick={() =>
              setActiveDropdown(
                activeDropdown === "customerName" ? null : "customerName"
              )
            }
          >
            <span className="truncate text-left flex-1">
              {filters.customerName === "all"
                ? "Lead Name"
                : filters.customerName}
            </span>
            {filters.customerName !== "all" && (
              <button
                type="button"
                className="absolute right-7 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 text-lg font-bold focus:outline-none"
                style={{ padding: 0, lineHeight: 1 }}
                tabIndex={-1}
                title="Clear filter"
                onClick={(e) => {
                  e.stopPropagation();
                  handleFilterChange("customerName", "all");
                }}
              >
                <RxCross2 />
              </button>
            )}
            <img
              src="/caret-down.svg"
              alt=""
              aria-hidden="true"
              className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
            />
          </button>
          {activeDropdown === "customerName" && (
            <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
              {Array.from(
                new Set(
                  leads
                    .map((lead) => lead.customer_name)
                    .filter(Boolean)
                    .map((name) => name.toLowerCase().trim())
                )
              ).map((name) => (
                <button
                  key={name}
                  type="button"
                  onClick={() => {
                    handleFilterChange("customerName", name);
                    setActiveDropdown(null);
                  }}
                  className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer"
                >
                  {name}
                </button>
              ))}
            </div>
          )}
        </div>
        {/* City Dropdown */}
        <div className="relative" ref={cityFilterDropdownRef}>
          <button
            type="button"
            className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[120px] lg:min-w-[120px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center cursor-pointer"
            onClick={() =>
              setActiveDropdown(activeDropdown === "city" ? null : "city")
            }
          >
            <span className="truncate text-left flex-1">
              {filters.city === "all"
                ? "City"
                : filters.city.charAt(0).toUpperCase() + filters.city.slice(1)}
            </span>
            {filters.city !== "all" && (
              <button
                type="button"
                className="absolute right-7 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 text-lg font-bold focus:outline-none"
                style={{ padding: 0, lineHeight: 1 }}
                tabIndex={-1}
                title="Clear filter"
                onClick={(e) => {
                  e.stopPropagation();
                  handleFilterChange("city", "all");
                }}
              >
                <RxCross2 />
              </button>
            )}
            <img
              src="/caret-down.svg"
              alt=""
              aria-hidden="true"
              className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
            />
          </button>
          {activeDropdown === "city" && (
            <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
              {Array.from(
                new Set(
                  leads
                    .map((lead) => {
                      // Extract city name from the address using helper function
                      return extractCityFromAddress(lead.city)
                        .toLowerCase()
                        .trim();
                    })
                    .filter((city) => city)
                )
              ).map((city) => (
                <button
                  key={city}
                  type="button"
                  onClick={() => {
                    handleFilterChange("city", city);
                    setActiveDropdown(null);
                  }}
                  className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer"
                >
                  {city.charAt(0).toUpperCase() + city.slice(1)}
                </button>
              ))}
            </div>
          )}
        </div>
        {/* Source Dropdown */}
        <div className="relative" ref={sourceFilterDropdownRef}>
          <button
            type="button"
            className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[120px] lg:min-w-[120px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center cursor-pointer"
            onClick={() =>
              setActiveDropdown(activeDropdown === "source" ? null : "source")
            }
          >
            <span className="truncate text-left flex-1">
              {filters.source === "all" ? "Source" : filters.source}
            </span>
            {filters.source !== "all" && (
              <button
                type="button"
                className="absolute right-7 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 text-lg font-bold focus:outline-none"
                style={{ padding: 0, lineHeight: 1 }}
                tabIndex={-1}
                title="Clear filter"
                onClick={(e) => {
                  e.stopPropagation();
                  handleFilterChange("source", "all");
                }}
              >
                <RxCross2 />
              </button>
            )}
            <img
              src="/caret-down.svg"
              alt=""
              aria-hidden="true"
              className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
            />
          </button>
          {activeDropdown === "source" && (
            <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
              {Array.from(
                new Set(
                  leads
                    .map((lead) => lead.source)
                    .filter(Boolean)
                    .map((source) => source.toLowerCase().trim())
                )
              ).map((source) => (
                <button
                  key={source}
                  type="button"
                  onClick={() => {
                    handleFilterChange("source", source);
                    setActiveDropdown(null);
                  }}
                  className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer"
                >
                  {source}
                </button>
              ))}
            </div>
          )}
        </div>
        {/* Assigned User Dropdown */}
        <div className="relative" ref={assignedToFilterDropdownRef}>
          <button
            type="button"
            className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[120px] lg:min-w-[120px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center cursor-pointer"
            onClick={() =>
              setActiveDropdown(
                activeDropdown === "assignedTo" ? null : "assignedTo"
              )
            }
          >
            <span className="truncate text-left flex-1">
              {filters.assignedTo === "all"
                ? "Assigned User"
                : filters.assignedTo}
            </span>
            {filters.assignedTo !== "all" && (
              <button
                type="button"
                className="absolute right-7 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 text-lg font-bold focus:outline-none"
                style={{ padding: 0, lineHeight: 1 }}
                tabIndex={-1}
                title="Clear filter"
                onClick={(e) => {
                  e.stopPropagation();
                  handleFilterChange("assignedTo", "all");
                }}
              >
                <RxCross2 />
              </button>
            )}
            <img
              src="/caret-down.svg"
              alt=""
              aria-hidden="true"
              className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
            />
          </button>
          {activeDropdown === "assignedTo" && (
            <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
              {Array.from(
                new Set(
                  leads
                    .map((lead) => lead.assigned_to)
                    .filter(Boolean)
                    .map((assigned) => assigned.toLowerCase().trim())
                )
              ).map((assigned) => (
                <button
                  key={assigned}
                  type="button"
                  onClick={() => {
                    handleFilterChange("assignedTo", assigned);
                    setActiveDropdown(null);
                  }}
                  className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer"
                >
                  {assigned}
                </button>
              ))}
            </div>
          )}
        </div>
        {/* New Follow Up Date Range Filter */}
        <div
          className={`relative ${
            rolePermissions !== "ALL" ? "col-span-2 md:col-span-1" : ""
          }`}
          ref={dateRangeDropdownRef}
        >
          <button
            className="relative
          appearance-none
          h-[36px] md:h-[44px] lg:h-[44px]
          pl-2 pr-10 md:pr-15 lg:pr-15
          w-full md:min-w-[120px] lg:min-w-[120px]
          bg-white border border-[#E9EAEA]
          rounded-[8px]
          cursor-pointer
          text-[#242729] text-[8px] md:text-base lg:text-sm
          focus:outline-none cursor-pointer"
            onMouseDown={(e) => {
              e.stopPropagation();
              setDateRangeDropdownOpen((open) => !open);
            }}
          >
            <div className="flex items-center">
              {timeRange === "all" && "Follow Up"}
              {timeRange === "7days" && "Last 7 Days"}
              {timeRange === "30days" && "Last 30 Days"}
              {timeRange === "90days" && "Last 90 Days"}
              {timeRange === "custom" && (
                <span className="text-[10px] whitespace-nowrap">
                  {`${formatDateForDisplay(
                    customDateRange.fromDate
                  )} - ${formatDateForDisplay(customDateRange.toDate)}`}
                </span>
              )}
            </div>
            <img
              src="/caret-down.svg"
              alt=""
              aria-hidden="true"
              className="
          pointer-events-none
          absolute right-2 md:right-3 lg:right-3
          top-1/2 -translate-y-1/2
          w-4 h-4
        "
            />
          </button>

          {dateRangeDropdownOpen && (
            <div className="absolute right-0 mt-2 w-72 bg-white border border-gray-200 rounded-lg shadow-lg z-10 cursor-pointer">
              <div className="px-4 pt-3  text-[#4B5563]">
                <p className="text-sm font-medium">Select Range</p>
              </div>

              <div className="p-2">
                {/* Predefined ranges */}
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    timeRange === "all"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  } cursor-pointer`}
                  onClick={() => handleTimeRangeChange("all")}
                >
                  <span>All Dates</span>
                  {timeRange === "all" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}
                </button>
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    timeRange === "7days"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  } cursor-pointer`}
                  onClick={() => handleTimeRangeChange("7days")}
                >
                  <span>Last 7 Days</span>
                  {timeRange === "7days" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}
                </button>
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    timeRange === "30days"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  } cursor-pointer`}
                  onClick={() => handleTimeRangeChange("30days")}
                >
                  <span>Last 30 Days</span>
                  {timeRange === "30days" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}
                </button>
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    timeRange === "90days"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  } cursor-pointer`}
                  onClick={() => handleTimeRangeChange("90days")}
                >
                  <span>Last 90 Days</span>
                  {timeRange === "90days" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}
                </button>

                <div className="border-t border-gray-200 my-2"></div>

                {/* Custom date range */}
                <div className="px-3 py-2">
                  <p className="text-sm font-medium text-[#4B5563] mb-2">
                    Custom Range
                  </p>
                  <div className="grid grid-cols-2 gap-2 mb-3">
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">
                        From
                      </label>
                      <input
                        type="date"
                        className="w-full h-[48px] text-sm px-2 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                        value={
                          customDateRange.fromDate
                            ? customDateRange.fromDate
                                .toISOString()
                                .split("T")[0]
                            : ""
                        }
                        onChange={(e) =>
                          handleCustomDateChange("fromDate", e.target.value)
                        }
                        max={
                          customDateRange.toDate
                            ? customDateRange.toDate.toISOString().split("T")[0]
                            : new Date().toISOString().split("T")[0]
                        }
                      />
                    </div>
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">
                        To
                      </label>
                      <input
                        type="date"
                        className="w-full h-[48px] text-sm px-2 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                        value={
                          customDateRange.toDate
                            ? customDateRange.toDate.toISOString().split("T")[0]
                            : ""
                        }
                        onChange={(e) =>
                          handleCustomDateChange("toDate", e.target.value)
                        }
                        min={
                          customDateRange.fromDate
                            ? customDateRange.fromDate
                                .toISOString()
                                .split("T")[0]
                            : ""
                        }
                        max={new Date().toISOString().split("T")[0]}
                      />
                    </div>
                  </div>
                  <button
                    className="hover:bg-blue-500
        bg-[#ef7e1b] text-white
        h-[44px] px-5
        rounded-[8px]
        flex items-center justify-center
        w-full
      "
                    onClick={applyCustomDateRange}
                  >
                    Apply Custom Range
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
        {/* New Created Date Range Filter */}
        {rolePermissions === "ALL" && (
          <div className="relative" ref={createdDateRangeDropdownRef}>
            <button
              className="relative
          appearance-none
          h-[36px] md:h-[44px] lg:h-[44px]
          pl-2 pr-10 md:pr-15 lg:pr-15
          w-full md:min-w-[120px] lg:min-w-[120px]
          bg-white border border-[#E9EAEA]
          rounded-[8px]
          cursor-pointer
          text-[#242729] text-[8px] md:text-base lg:text-sm
          focus:outline-none cursor-pointer"
              onMouseDown={(e) => {
                e.stopPropagation();
                setCreatedDateRangeDropdownOpen((open) => !open);
              }}
            >
              <div className="flex items-center whitespace-nowrap ">
                {createdTimeRange === "all" && "Created"}
                {createdTimeRange === "7days" && "Last 7 Days"}
                {createdTimeRange === "30days" && "Last 30 Days"}
                {createdTimeRange === "90days" && "Last 90 Days"}
                {createdTimeRange === "custom" && (
                  <span className="text-[10px] whitespace-nowrap">
                    {`${formatDateForDisplay(
                      customCreatedDateRange.fromDate
                    )} - ${formatDateForDisplay(
                      customCreatedDateRange.toDate
                    )}`}
                  </span>
                )}
              </div>
              <img
                src="/caret-down.svg"
                alt=""
                aria-hidden="true"
                className="
          pointer-events-none
          absolute right-2 md:right-3 lg:right-3
          top-1/2 -translate-y-1/2
          w-4 h-4
        "
              />
            </button>

            {createdDateRangeDropdownOpen && (
              <div className="absolute right-0 mt-2 w-72 bg-white border border-gray-200 rounded-lg shadow-lg z-10 cursor-pointer">
                <div className="px-4 pt-3  text-[#4B5563]">
                  <p className="text-sm font-medium">Select Range</p>
                </div>

                <div className="p-2">
                  {/* Predefined ranges */}
                  <button
                    className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                      createdTimeRange === "all"
                        ? "bg-[#E7EFF8] text-[#ef7e1b]"
                        : "hover:bg-gray-100"
                    } cursor-pointer`}
                    onClick={() => handleCreatedTimeRangeChange("all")}
                  >
                    <span>All Dates</span>
                    {createdTimeRange === "all" && (
                      <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                    )}
                  </button>
                  <button
                    className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                      createdTimeRange === "7days"
                        ? "bg-[#E7EFF8] text-[#ef7e1b]"
                        : "hover:bg-gray-100"
                    } cursor-pointer`}
                    onClick={() => handleCreatedTimeRangeChange("7days")}
                  >
                    <span>Last 7 Days</span>
                    {createdTimeRange === "7days" && (
                      <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                    )}
                  </button>
                  <button
                    className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                      createdTimeRange === "30days"
                        ? "bg-[#E7EFF8] text-[#ef7e1b]"
                        : "hover:bg-gray-100"
                    } cursor-pointer`}
                    onClick={() => handleCreatedTimeRangeChange("30days")}
                  >
                    <span>Last 30 Days</span>
                    {createdTimeRange === "30days" && (
                      <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                    )}
                  </button>
                  <button
                    className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                      createdTimeRange === "90days"
                        ? "bg-[#E7EFF8] text-[#ef7e1b]"
                        : "hover:bg-gray-100"
                    } cursor-pointer`}
                    onClick={() => handleCreatedTimeRangeChange("90days")}
                  >
                    <span>Last 90 Days</span>
                    {createdTimeRange === "90days" && (
                      <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                    )}
                  </button>

                  <div className="border-t border-gray-200 my-2"></div>

                  {/* Custom date range */}
                  <div className="px-3 py-2">
                    <p className="text-sm font-medium text-[#4B5563] mb-2">
                      Custom Range
                    </p>
                    <div className="grid grid-cols-2 gap-2 mb-3">
                      <div>
                        <label className="block text-xs text-gray-500 mb-1">
                          From
                        </label>
                        <input
                          type="date"
                          className="w-full h-[48px] text-sm px-2 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                          value={
                            customCreatedDateRange.fromDate
                              ? customCreatedDateRange.fromDate
                                  .toISOString()
                                  .split("T")[0]
                              : ""
                          }
                          onChange={(e) =>
                            handleCustomCreatedDateChange(
                              "fromDate",
                              e.target.value
                            )
                          }
                          max={
                            customCreatedDateRange.toDate
                              ? customCreatedDateRange.toDate
                                  .toISOString()
                                  .split("T")[0]
                              : new Date().toISOString().split("T")[0]
                          }
                        />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-500 mb-1">
                          To
                        </label>
                        <input
                          type="date"
                          className="w-full h-[48px] text-sm px-2 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                          value={
                            customCreatedDateRange.toDate
                              ? customCreatedDateRange.toDate
                                  .toISOString()
                                  .split("T")[0]
                              : ""
                          }
                          onChange={(e) =>
                            handleCustomCreatedDateChange(
                              "toDate",
                              e.target.value
                            )
                          }
                          min={
                            customCreatedDateRange.fromDate
                              ? customCreatedDateRange.fromDate
                                  .toISOString()
                                  .split("T")[0]
                              : ""
                          }
                          max={new Date().toISOString().split("T")[0]}
                        />
                      </div>
                    </div>
                    <button
                      className="hover:bg-blue-500
        bg-[#ef7e1b] text-white
        h-[44px] px-5
        rounded-[8px]
        flex items-center justify-center
        w-full
      "
                      onClick={applyCustomCreatedDateRange}
                    >
                      Apply Custom Range
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}
      </div>

      {/* Search Results Info */}
      {searchTerm && (
        <div className="mb-4 text-sm text-[#4B5563]">
          Showing {filteredLeads.length} results for "{searchTerm}"
        </div>
      )}

      {/* Lead List Table */}
      <div className="hidden md:block w-full flex-grow overflow-x-auto overflow-y-hidden relative custom-scrollbar">
        <table className="w-full min-w-[1800px] border-collapse">
          <thead>
            <tr className="text-left text-[#4B5563]">
              {/* Bulk Selection Checkbox - Permission Controlled */}
              {hasBulkAssignPermission && (
                <th className="py-4 px-6 font-medium text-sm w-12">
                  <input
                    type="checkbox"
                    checked={
                      selectedLeads.length === currentLeads.length &&
                      currentLeads.length > 0
                    }
                    onChange={toggleSelectAll}
                    className="w-4 h-4 rounded border-[#E9EAEA] cursor-pointer"
                  />
                </th>
              )}
              <th className="py-4 px-6 font-medium text-sm whitespace-nowrap">
                Lead ID
              </th>
              <th className="py-4 px-6 font-medium text-sm whitespace-nowrap">
                Lead Name
              </th>
              <th className="py-4 px-6 font-medium text-sm">Email</th>
              <th className="py-4 px-6 font-medium text-sm">Contact</th>
              <th className="py-4 px-6 font-medium text-sm">City</th>
              <th className="py-4 px-6 font-medium text-sm">WhatsApp</th>
              <th className="py-4 px-6 font-medium text-sm">Requirements</th>
              <th className="py-4 px-6 font-medium text-sm">Source</th>
              <th className="py-4 px-6 font-medium text-sm">Status</th>
              <th className="py-4 px-6 font-medium text-sm whitespace-nowrap">
                Assigned User
              </th>
              <th className="py-4 px-6 font-medium text-sm whitespace-nowrap">
                Follow Up
              </th>
              {rolePermissions === "ALL" && (
                <th className="py-4 px-6 font-medium text-sm">Created</th>
              )}
              {/* Action Column - Permission Controlled */}
              {(permissionsForLeadsModule.includes("edit") ||
                permissionsForLeadsModule.includes("delete")) && (
                <th className="py-4 px-6 font-medium text-sm">Action</th>
              )}
            </tr>
          </thead>
          <tbody>
            {currentLeads.length === 0 ? (
              <tr>
                <td
                  colSpan="14"
                  className="py-8 px-6 text-center text-[#4B5563]"
                >
                  {searchTerm
                    ? "No leads found matching your search."
                    : "No leads available."}
                </td>
              </tr>
            ) : (
              currentLeads.map((lead) => {
                const isStatusMenuOpen = openStatusMenu === lead.customer_id;
                return (
                  <tr
                    key={lead.customer_id}
                    className="border-t border-[#E5E7EB]"
                  >
                    {/* Bulk Selection Checkbox - Permission Controlled */}
                    {hasBulkAssignPermission && (
                      <td className="py-4 px-6 w-12">
                        <input
                          type="checkbox"
                          checked={selectedLeads.includes(lead.customer_id)}
                          onChange={() => toggleLeadSelection(lead.customer_id)}
                          className="w-4 h-4 rounded border-[#E9EAEA] cursor-pointer bg-[#E9EAEA]"
                        />
                      </td>
                    )}
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.customer_id}
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      <div
                        className="flex items-center gap-3 group cursor-pointer"
                        onClick={() => handleEditWithIndex(lead)}
                      >
                        <div className="w-9 h-9 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden group-hover:bg-blue-100 group-hover:shadow-md group-hover:shadow-blue-300 transition-all duration-200">
                          {lead.profile_pic ? (
                            <img
                              src={lead.profile_pic}
                              alt={lead.customer_name}
                              className="w-full h-full object-cover"
                              onError={(e) => {
                                e.target.onerror = null;
                                e.target.src = "/dummyavatar.jpeg";
                              }}
                            />
                          ) : (
                            <img
                              src="/dummyavatar.jpeg"
                              alt={lead.customer_name}
                              className="w-full h-full object-cover"
                            />
                          )}
                        </div>
                        <div className="flex flex-col">
                          <span className="text-[#1F2837] font-medium group-hover:text-blue-600 transition-colors">
                            {lead.customer_name}
                          </span>
                        </div>
                      </div>
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.email}
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.contact}
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {/* Extract and display only the city name from the full address */}
                      {extractCityFromAddress(lead.city)}
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.whatsapp_number}
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.requirements}
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.source}
                    </td>
                    <td className="py-4 px-6 max-w-xs overflow-hidden truncate">
                      <div className="relative inline-block">
                        <span
                          className={`
                            px-3 py-1 rounded-lg text-sm
                            flex items-center gap-2
                            ${
                              lead.status_name === "Fresh List"
                                ? "bg-[#27AE60] text-white"
                                : lead.status_name === "Follow Up"
                                ? "bg-[#ef7e1b] text-white"
                                : lead.status_name === "Get Call Back Us"
                                ? "bg-[#FFFBEB] text-[#D97706]"
                                : lead.status_name === "Contact In Future"
                                ? "bg-[#FFF8DD] text-[#F1C40F]"
                                : lead.status_name === "Next Day Payments"
                                ? "bg-[#27AE60] text-white"
                                : lead.status_name === "Quote Send"
                                ? "bg-[#ef7e1b] text-white"
                                : lead.status_name === "Call Back"
                                ? "bg-[#FFFBEB] text-[#D97706]"
                                : lead.status_name === "Construction"
                                ? "bg-[#FFF8DD] text-[#F1C40F]"
                                : lead.status_name === "NPC"
                                ? "bg-[#27AE60] text-white"
                                : lead.status_name === "Switch off"
                                ? "bg-[#ef7e1b] text-white"
                                : lead.status_name === "Not Reachable"
                                ? "bg-[#FFFBEB] text-[#D97706]"
                                : lead.status_name === "Quotation"
                                ? "bg-[#FFF8DD] text-[#ff0000]"
                                : lead.status_name === "Converted Client"
                                ? "bg-[#093d6e] text-white"
                                : "bg-[#173f12] text-white"
                            }
                          `}
                        >
                          {lead.status_name}
                        </span>
                      </div>
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.assigned_to}
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {formatDateTimeForTable(lead.follow_up_date)}
                    </td>
                    {rolePermissions === "ALL" && (
                      <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                        <div className="flex flex-col">
                          <span>{formatDateTimeForTable(lead.created)}</span>
                        </div>
                      </td>
                    )}
                    {/* Action Buttons - Permission Controlled */}
                    {(permissionsForLeadsModule.includes("edit") ||
                      permissionsForLeadsModule.includes("delete")) && (
                      <td className="py-4 px-6 relative">
                        <button
                          onMouseDown={(e) => {
                            e.stopPropagation();
                            toggleDropdown(lead.customer_id);
                          }}
                          className="p-2 text-[#4B5563] hover:bg-blue-200 hover:text-white rounded-full transition-colors "
                        >
                          <TbDotsVertical className="w-4 h-4" />
                        </button>
                        {activeDropdown === lead.customer_id && (
                          <div
                            ref={
                              activeDropdown === lead.customer_id
                                ? setDropdownNode
                                : null
                            }
                            data-dropdown-id={lead.customer_id}
                            className="absolute left-3 w-24 rounded-md shadow-md bg-gradient-to-br from-white to-[#E7F4FF] z-10 overflow-hidden"
                            onMouseDown={(e) => {
                              e.stopPropagation();
                            }}
                          >
                            <div className="">
                              {/* Edit Button - Permission Controlled */}
                              {permissionsForLeadsModule.includes("edit") && (
                                <button
                                  onClick={() => handleEditWithIndex(lead)}
                                  className="group flex items-center px-2 py-1 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors first:rounded-t-md"
                                >
                                  <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="24"
                                    height="24"
                                    viewBox="0 0 24 24"
                                    className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                  >
                                    <path
                                      fill="currentColor"
                                      d="M4 14v-2h7v2zm0-4V8h11v2zm0-4V4h11v2zm9 14v-3.075l6.575-6.55l3.075 3.05L16.075 20zm7.5-6.575l-.925-.925zm-6 5.075h.95l3.025-3.05l-.45-.475l-.475-.45l-3.05 3.025zm3.525-3.525l-.475-.45l.925.925z"
                                    />
                                  </svg>
                                  <span className="group-hover:text-white transition-colors">
                                    Edit
                                  </span>
                                </button>
                              )}

                              <svg
                                className="w-full h-[1px]"
                                viewBox="0 0 100 1"
                                preserveAspectRatio="none"
                                xmlns="http://www.w3.org/2000/svg"
                              >
                                <polygon
                                  points="0,0 50,1 100,0"
                                  fill="#E5E7EB"
                                />
                              </svg>

                              {/* Delete Button - Permission Controlled */}
                              {permissionsForLeadsModule.includes("delete") && (
                                <button
                                  onClick={() => handleDelete(lead.customer_id)}
                                  className="group flex items-center px-2 py-1 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors last:rounded-b-md"
                                >
                                  <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="24"
                                    height="24"
                                    viewBox="0 0 24 24"
                                    className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                  >
                                    <path
                                      fill="currentColor"
                                      d="M7.616 20q-.672 0-1.144-.472T6 18.385V6H5V5h4v-.77h6V5h4v1h-1v12.385q0 .69-.462 1.153T16.384 20zM17 6H7v12.385q0 .269.173.442t.443.173h8.769q.23 0 .423-.192t.192-.424zM9.808 17h1V8h-1zm3.384 0h1V8h-1zM7 6v13z"
                                    />
                                  </svg>
                                  <span className="group-hover:text-white transition-colors">
                                    Delete
                                  </span>
                                </button>
                              )}
                            </div>
                          </div>
                        )}
                      </td>
                    )}
                  </tr>
                );
              })
            )}
          </tbody>
        </table>
      </div>

      {/* Lead List Cards for Mobile */}
      <div className="md:hidden w-full space-y-6 pb-24 flex-grow overflow-x-auto">
        {currentLeads.length === 0 ? (
          <div className="py-12 px-6 text-center">
            <div className="w-16 h-16 mx-auto mb-4  rounded-full flex items-center justify-center">
              <svg
                className="w-8 h-8 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth="1.5"
                  d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-5.5a2.5 2.5 0 00-2.5 2.5v.5a2 2 0 01-2 2h-3a2 2 0 01-2-2v-.5a2.5 2.5 0 00-2.5-2.5H4"
                />
              </svg>
            </div>
            <p className="text-gray-500 font-medium">
              {searchTerm
                ? "No leads found matching your search."
                : "No leads available."}
            </p>
          </div>
        ) : (
          currentLeads.map((lead) => {
            const isStatusMenuOpen = openStatusMenu === lead.customer_id;
            return (
              <div
                key={lead.customer_id}
                className="bg-white rounded-2xl border border-gray-100 hover:border-gray-200 transition-all duration-300 hover:shadow-lg"
              >
                {/* Header Section */}
                <div className="p-4 sm:p-6 border-b border-gray-50">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-2 sm:space-x-4">
                      {/* Bulk Selection Checkbox - Permission Controlled */}
                      {hasBulkAssignPermission && (
                        <input
                          type="checkbox"
                          checked={selectedLeads.includes(lead.customer_id)}
                          onChange={() => toggleLeadSelection(lead.customer_id)}
                          className="w-5 h-5 rounded border-gray-300 text-gray-900 focus:ring-gray-500 focus:ring-2"
                        />
                      )}

                      <div
                        className="flex items-center space-x-3 group cursor-pointer"
                        onClick={() => handleEditWithIndex(lead)}
                      >
                        <div className="w-12 h-12 rounded-full bg-gray-100 overflow-hidden ring-1 ring-gray-200 group-hover:bg-blue-100 group-hover:shadow-md group-hover:shadow-blue-300 transition-all duration-200">
                          {lead.profile_pic ? (
                            <img
                              src={lead.profile_pic}
                              alt={lead.customer_name}
                              className="w-full h-full object-cover"
                              onError={(e) => {
                                e.target.onerror = null;
                                e.target.src = "/dummyavatar.jpeg";
                              }}
                            />
                          ) : (
                            <img
                              src="/dummyavatar.jpeg"
                              alt={lead.customer_name}
                              className="w-full h-full object-cover"
                            />
                          )}
                        </div>

                        <div>
                          <h3 className="text-base font-semibold text-gray-900 whitespace-nowrap group-hover:text-blue-600 transition-colors">
                            {lead.customer_name}
                          </h3>
                          <p className="text-xs text-gray-500">{lead.email}</p>
                          {rolePermissions === "ALL" && (
                            <p className="text-xs text-gray-400 mt-1">
                              {formatDateTimeForTable(lead.created)}
                            </p>
                          )}
                        </div>
                      </div>
                    </div>

                    {/* Actions Menu - Permission Controlled */}
                    {(permissionsForLeadsModule.includes("edit") ||
                      permissionsForLeadsModule.includes("delete")) && (
                      <div className="relative">
                        <button
                          onMouseDown={(e) => {
                            e.stopPropagation();
                            toggleDropdown(lead.customer_id);
                          }}
                          className="p-1 text-[#4B5563] rounded-full hover:bg-gray-100"
                        >
                          <TbDotsVertical className="w-4 h-4" />
                        </button>

                        {activeDropdown === lead.customer_id && (
                          <div
                            ref={
                              activeDropdown === lead.customer_id
                                ? setDropdownNode
                                : null
                            }
                            className="absolute right-0 mt-1 w-24 sm:w-28 rounded-md shadow-md bg-gradient-to-br from-white to-[#E7F4FF] z-20 overflow-hidden"
                            onMouseDown={(e) => {
                              e.stopPropagation();
                            }}
                          >
                            <div>
                              {/* EDIT button - Permission Controlled */}
                              {permissionsForLeadsModule.includes("edit") && (
                                <button
                                  onClick={() => handleEditWithIndex(lead)}
                                  className="group flex items-center px-3 py-2 text-xs text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors first:rounded-t-md"
                                >
                                  <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="16"
                                    height="16"
                                    viewBox="0 0 24 24"
                                    className="mr-2 w-3 h-3 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                  >
                                    <path
                                      fill="currentColor"
                                      d="M4 14v-2h7v2zm0-4V8h11v2zm0-4V4h11v2zm9 14v-3.075l6.575-6.55l3.075 3.05L16.075 20zm7.5-6.575l-.925-.925zm-6 5.075h.95l3.025-3.05l-.45-.475l-.475-.45l-3.05 3.025zm3.525-3.525l-.475-.45l.925.925z"
                                    />
                                  </svg>
                                  <span className="group-hover:text-white transition-colors">
                                    Edit
                                  </span>
                                </button>
                              )}

                              {/* Tapered separator */}
                              <svg
                                className="w-full h-[1px]"
                                viewBox="0 0 100 1"
                                preserveAspectRatio="none"
                                xmlns="http://www.w3.org/2000/svg"
                              >
                                <polygon
                                  points="0,0 50,1 100,0"
                                  fill="#E5E7EB"
                                />
                              </svg>

                              {/* DELETE button - Permission Controlled */}
                              {permissionsForLeadsModule.includes("delete") && (
                                <button
                                  onClick={() => handleDelete(lead.customer_id)}
                                  className="group flex items-center px-3 py-2 text-xs text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors last:rounded-b-md"
                                >
                                  <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="16"
                                    height="16"
                                    viewBox="0 0 24 24"
                                    className="mr-2 w-3 h-3 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                  >
                                    <path
                                      fill="currentColor"
                                      d="M7.616 20q-.672 0-1.144-.472T6 18.385V6H5V5h4v-.77h6V5h4v1h-1v12.385q0 .69-.462 1.153T16.384 20zM17 6H7v12.385q0 .269.173.442t.443.173h8.769q.23 0 .423-.192t.192-.424zM9.808 17h1V8h-1zm3.384 0h1V8h-1zM7 6v13z"
                                    />
                                  </svg>
                                  <span className="group-hover:text-white transition-colors">
                                    Delete
                                  </span>
                                </button>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>

                {/* Details Section */}
                <div className="p-3 sm:p-4 space-y-3">
                  {/* Contact & WhatsApp Row */}
                  <div className="grid grid-cols-2 gap-2">
                    <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                      <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                        <svg
                          className="w-3 h-3 text-gray-600"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="1.5"
                            d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                          />
                        </svg>
                      </div>
                      <div className="min-w-0 flex-1 ">
                        <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                          Contact
                        </p>
                        <p className="text-[10px] ml-1 text-gray-900">
                          {lead.contact}
                        </p>
                      </div>
                    </div>

                    <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                      <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                        <svg
                          className="w-3 h-3 text-gray-600"
                          fill="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.465 3.488" />
                        </svg>
                      </div>
                      <div className="min-w-0 flex-1">
                        <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide ">
                          WhatsApp
                        </p>
                        <p className="text-[10px] ml-1 text-gray-900">
                          {lead.whatsapp_number}
                        </p>
                      </div>
                    </div>
                  </div>

                  {/* City & Source Row */}
                  <div className="grid grid-cols-2 gap-2">
                    <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                      <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                        <svg
                          className="w-3 h-3 text-gray-600"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="1.5"
                            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                          />
                        </svg>
                      </div>
                      <div className="min-w-0 flex-1">
                        <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide ">
                          City
                        </p>
                        <p className="text-[10px] ml-1 text-gray-900">
                          {/* Extract and display only the city name from the full address */}
                          {extractCityFromAddress(lead.city)}
                        </p>
                      </div>
                    </div>

                    <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                      <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                        <svg
                          className="w-3 h-3 text-gray-600"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="1.5"
                            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
                          />
                        </svg>
                      </div>
                      <div className="min-w-0 flex-1">
                        <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide ">
                          Source
                        </p>
                        <p className="text-[10px] ml-1 text-gray-900">
                          {lead.source}
                        </p>
                      </div>
                    </div>
                  </div>

                  {/* Assigned To & Follow Up Row */}
                  <div className="grid grid-cols-2 gap-2">
                    <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                      <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                        <svg
                          className="w-3 h-3 text-gray-600"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="1.5"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                          />
                        </svg>
                      </div>
                      <div className="min-w-0 flex-1">
                        <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide ">
                          Assigned User
                        </p>
                        <p className="text-[10px] ml-1 text-gray-900 whitespace-nowrap">
                          {lead.assigned_to}
                        </p>
                      </div>
                    </div>

                    <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                      <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                        <svg
                          className="w-3 h-3 text-gray-600"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="1.5"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                          />
                        </svg>
                      </div>
                      <div className="min-w-0 flex-1">
                        <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                          Follow Up
                        </p>
                        <p className="text-[10px] ml-1 text-gray-900 whitespace-nowrap">
                          {formatDateTimeForTable(lead.follow_up_date)}
                        </p>
                      </div>
                    </div>
                  </div>
                  {/* Requirements */}
                  <div className="flex items-start space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                      <svg
                        className="w-3 h-3 text-gray-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="1.5"
                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                        />
                      </svg>
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                        Requirements
                      </p>
                      <p className="text-[10px] ml-1 text-gray-900 leading-relaxed">
                        {lead.requirements}
                      </p>
                    </div>
                  </div>
                </div>

                {/* Status Footer */}
                <div className="px-3 sm:px-4 py-3  border-t border-gray-100 rounded-b-2xl">
                  <div className="flex items-center justify-between">
                    <span className="text-xs font-medium text-gray-600">
                      Status
                    </span>
                    <span
                      className={`
                  px-3 py-1 rounded-full text-xs font-medium
                  ${
                    lead.status_name === "Fresh List"
                      ? "bg-emerald-100 text-emerald-800"
                      : lead.status_name === "Follow Up"
                      ? "bg-blue-100 text-blue-800"
                      : lead.status_name === "Get Call Back Us"
                      ? "bg-amber-100 text-amber-800"
                      : lead.status_name === "Contact In Future"
                      ? "bg-yellow-100 text-yellow-800"
                      : lead.status_name === "Next Day Payments"
                      ? "bg-emerald-100 text-emerald-800"
                      : lead.status_name === "Quote Send"
                      ? "bg-blue-100 text-blue-800"
                      : lead.status_name === "Call Back"
                      ? "bg-amber-100 text-amber-800"
                      : lead.status_name === "Construction"
                      ? "bg-yellow-100 text-yellow-800"
                      : lead.status_name === "NPC"
                      ? "bg-emerald-100 text-emerald-800"
                      : lead.status_name === "Switch off"
                      ? "bg-blue-100 text-blue-800"
                      : lead.status_name === "Not Reachable"
                      ? "bg-amber-100 text-amber-800"
                      : lead.status_name === "Quotation"
                      ? "bg-red-100 text-red-800"
                      : lead.status_name === "Converted Client"
                      ? "bg-[#093d6e] text-white"
                      : "bg-[#173f12] text-white"
                  }
                `}
                    >
                      {lead.status_name}
                    </span>
                  </div>
                </div>
              </div>
            );
          })
        )}
      </div>
      {/* Edit Modal */}
      {isModalOpen && (
        <div className="fixed inset-0 flex items-center justify-center z-50">
          {/* Frosted overlay */}
          <div
            className="absolute inset-0 bg-gray-50/10 backdrop-blur-sm border border-white/30"
            onClick={() => setIsModalOpen(false)}
          />

          {/* Glassmorphism modal container */}
          <div
            className="
       w-11/12 max-w-[1000px] max-h-[90vh] overflow-y-auto p-6 md:p-8
        rounded-2xl
        bg-gradient-to-br from-[#FFFFFF] to-[#E6F4FF]
        shadow-lg
        relative z-10 custom-scrollbar
      "
          >
            {/* Close button */}
            <button
              onClick={closeModal}
              className="absolute top-6 right-6 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13 1L1 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M1 1L13 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Modal title */}
            <h2 className="text-[24px] sm:text-[29px] font-medium text-[#1F2837] mb-8">
              {dynamicModalTitle}
            </h2>

            {/* Form */}
            <form onSubmit={handleSubmit}>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                {/* Profile Picture Upload */}
                <div className="md:col-span-1 flex flex-col items-center">
                  <label className="block text-[#4B5563] text-[16px] mb-4 w-full">
                    Profile Picture
                  </label>
                  <div className="relative w-32 h-32">
                    <img
                      src={
                        imagePreview ||
                        editingLead?.profile_pic ||
                        "/dummyavatar.jpeg"
                      }
                      alt="Profile Preview"
                      className="w-32 h-32 rounded-full object-cover border-2 border-white shadow-md"
                    />
                    <label
                      htmlFor="edit-file-upload"
                      className="absolute bottom-1 right-1 bg-[#ef7e1b] text-white rounded-full p-2 cursor-pointer hover:bg-blue-600 transition-colors"
                    >
                      <FiEdit className="w-4 h-4" />
                      <input
                        type="file"
                        name="profile_pic"
                        id="edit-file-upload"
                        onChange={handleInputChange}
                        className="hidden"
                        accept="image/*"
                      />
                    </label>
                  </div>
                  <p className="text-xs text-gray-500 mt-2">
                    PNG, JPG, GIF up to 10MB
                  </p>
                </div>

                {/* Customer Name and Details */}
                <div className="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                  {/* Customer Name */}
                  <div className="space-y-2 md:col-start-1 md:row-start-1">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Lead Name
                    </label>
                    <div className="relative">
                      <input
                        type="text"
                        name="name"
                        value={formData.name}
                        onChange={handleInputChange}
                        className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                        required
                      />
                    </div>
                  </div>

                  {/* Email */}
                  <div className="space-y-2 md:col-start-2 md:row-start-1">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Email
                    </label>
                    <input
                      type="email"
                      name="email"
                      value={formData.email}
                      onChange={handleInputChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                    />
                  </div>

                  {/* Contact */}
                  <div className="space-y-2 md:col-start-1 md:row-start-2">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Contact
                    </label>
                    <input
                      type="text"
                      name="phoneno"
                      value={formData.phoneno}
                      onChange={handleInputChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                      required
                    />
                  </div>

                  {/* WhatsApp */}
                  <div className="space-y-2 md:col-start-2 md:row-start-2">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      WhatsApp
                    </label>
                    <input
                      type="text"
                      name="whatsapp"
                      value={formData.whatsapp}
                      onChange={handleInputChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                    />
                  </div>

                  {/* Requirements */}
                  <div className="space-y-2 md:col-start-2 md:row-start-3">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Requirements
                    </label>
                    <input
                      type="text"
                      name="requirements"
                      value={formData.requirements}
                      onChange={handleInputChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                    />
                  </div>

                  {/* Source */}
                  <div className="space-y-2 md:col-start-1 md:row-start-3">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Source
                    </label>
                    <input
                      type="text"
                      name="source"
                      value={formData.source}
                      onChange={handleInputChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                    />
                  </div>

                  {/* Follow Up */}
                  <div className="space-y-2 md:col-start-1 md:row-start-4">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Follow Up
                    </label>
                    <div className="flex gap-2">
                      <input
                        type="date"
                        name="follow_up_date_input"
                        value={formData.follow_up_date_input}
                        onChange={handleInputChange}
                        className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] placeholder:text-sm"
                      />
                      <input
                        type="time"
                        name="follow_up_time_input"
                        value={formData.follow_up_time_input}
                        onChange={handleInputChange}
                        className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] placeholder:text-sm"
                      />
                    </div>
                  </div>

                  {/* Status */}
                  <div className="space-y-2 md:col-start-2 md:row-start-4">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Status
                    </label>
                    <div className="relative" ref={statusDropdownRef}>
                      <button
                        type="button"
                        onClick={() =>
                          setIsStatusDropdownOpen(!isStatusDropdownOpen)
                        }
                        className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] text-left flex items-center justify-between cursor-pointer"
                      >
                        <span>
                          {statuses.find(
                            (status) =>
                              status.status_name
                                .toLowerCase()
                                .replace(/\s+/g, "_") === formData.status
                          )?.status_name || "Select Status"}
                        </span>
                        <svg
                          className={`w-4 h-4 transition-transform ${
                            isStatusDropdownOpen ? "rotate-180" : ""
                          }`}
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M19 9l-7 7-7-7"
                          />
                        </svg>
                      </button>
                      {isStatusDropdownOpen && (
                        <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar cursor-pointer">
                          {statuses.map((status) => (
                            <button
                              key={status.status_id}
                              type="button"
                              onClick={() => {
                                handleInputChange({
                                  target: {
                                    name: "status",
                                    value: status.status_name
                                      .toLowerCase()
                                      .replace(/\s+/g, "_"),
                                  },
                                });
                                setIsStatusDropdownOpen(false);
                              }}
                              className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer"
                            >
                              {status.status_name}
                            </button>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Assigned To */}
                  <div className="space-y-2 md:col-span-2 md:row-start-5">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Assigned User
                    </label>
                    {renderAssignToDropdown(formData.assigned_to, (value) =>
                      handleInputChange({
                        target: { name: "assigned_to", value },
                      })
                    )}
                  </div>

                  {/* Message */}
                  <div className="space-y-2 md:col-start-1 md:col-span-2 md:row-start-6">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Message
                    </label>
                    <textarea
                      name="message"
                      value={formData.message}
                      onChange={handleInputChange}
                      rows="2"
                      className="w-full min-h-[58px] p-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] resize-none"
                    />
                  </div>

                  {/* Address */}
                  <div className="space-y-1 md:col-span-2 md:row-start-7">
                    <label className="block text-[#4B5563] text-sm font-medium">
                      Address
                    </label>
                    <div className="w-full rounded-[12px]  border border-white/20 flex flex-col">
                      <input
                        type="text"
                        name="blockUnitStreetName"
                        value={formData.blockUnitStreetName}
                        onChange={handleInputChange}
                        className="w-full h-[44px] px-3 flex items-center text-[#545454] border-b  bg-[#E7EFF8]/60 border border-white/20 outline-none rounded-t-[12px]"
                        placeholder="Block/Unit/Street Name"
                      />

                      {/* State and City Dropdowns */}
                      <div className="grid grid-cols-2  w-full">
                        {/* State Dropdown */}
                        <div className="relative" ref={stateDropdownRef}>
                          <input
                            type="text"
                            name="stateSearch"
                            value={formData.state || stateSearchTerm}
                            onChange={handleStateSearchChange}
                            onFocus={() =>
                              countrySearchTerm && setStateDropdownOpen(true)
                            }
                            onBlur={() => setStateDropdownOpen(false)}
                            className={`w-full h-[44px] px-4 border border-white/20 outline-none text-[#545454] placeholder-[#545454] text-[16px] ${
                              !countrySearchTerm
                                ? "bg-gray-300 cursor-not-allowed opacity-60"
                                : "bg-[#E7EFF8]/60"
                            }`}
                            placeholder="Select State"
                            disabled={!countrySearchTerm}
                            readOnly={!countrySearchTerm}
                            autoComplete="off"
                          />
                          {stateDropdownOpen && countrySearchTerm && (
                            <div className="absolute z-10 custom-scrollbar w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                              {filteredStates.length > 0 ? (
                                filteredStates.map((state) => (
                                  <div
                                    key={state.isoCode}
                                    className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                    onClick={() => handleStateSelect(state)}
                                    onMouseDown={(e) => e.preventDefault()}
                                  >
                                    {state.name}
                                  </div>
                                ))
                              ) : (
                                <div className="p-3 text-gray-500">
                                  No states found
                                </div>
                              )}
                            </div>
                          )}
                        </div>

                        {/* City Dropdown */}
                        <div className="relative" ref={cityDropdownRef}>
                          <input
                            type="text"
                            name="citySearch"
                            value={formData.city || citySearchTerm}
                            onChange={handleCitySearchChange}
                            onFocus={() =>
                              stateSearchTerm && setCityDropdownOpen(true)
                            }
                            onBlur={() => setCityDropdownOpen(false)}
                            className={`w-full h-[44px] px-4 border border-white/20 outline-none text-[#545454] placeholder-[#545454] text-[16px] ${
                              !stateSearchTerm
                                ? "bg-gray-300 cursor-not-allowed opacity-60"
                                : "bg-[#E7EFF8]/60"
                            }`}
                            placeholder="Select City"
                            disabled={!stateSearchTerm}
                            readOnly={!stateSearchTerm}
                            autoComplete="off"
                          />
                          {cityDropdownOpen && stateSearchTerm && (
                            <div className="absolute custom-scrollbar z-10 w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                              {filteredCities.length > 0 ? (
                                filteredCities.map((city) => (
                                  <div
                                    key={city.name}
                                    className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                    onClick={() => handleCitySelect(city)}
                                    onMouseDown={(e) => e.preventDefault()}
                                  >
                                    {city.name}
                                  </div>
                                ))
                              ) : (
                                <div className="p-3 text-gray-500">
                                  No cities found
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Pincode and Country */}
                      <div className="grid grid-cols-2  w-full">
                        {/* Pincode Input */}
                        <input
                          type="text"
                          name="pincode"
                          value={formData.pincode}
                          onChange={handleInputChange}
                          className="w-full h-[44px] px-3 flex items-center text-[#545454] bg-[#E7EFF8]/60 border border-white/20 rounded-bl-[12px] outline-none"
                          placeholder="Pincode"
                        />
                        {/* Country Dropdown */}
                        <div className="relative" ref={countryDropdownRef}>
                          <input
                            type="text"
                            name="countrySearch"
                            value={formData.country || countrySearchTerm}
                            onChange={handleCountrySearchChange}
                            onFocus={() => setCountryDropdownOpen(true)}
                            onBlur={() => setCountryDropdownOpen(false)}
                            className="w-full h-[44px] px-4 bg-[#E7EFF8]/60 border border-white/20  outline-none text-[#545454] placeholder-[#545454] rounded-br-[12px] text-[16px]"
                            placeholder="Select Country"
                          />
                          {countryDropdownOpen && (
                            <div className="absolute custom-scrollbar z-10 w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                              {filteredCountries.length > 0 ? (
                                filteredCountries.map((country) => (
                                  <div
                                    key={country.isoCode}
                                    className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                    onClick={() => handleCountrySelect(country)}
                                    onMouseDown={(e) => e.preventDefault()}
                                  >
                                    {country.name}
                                  </div>
                                ))
                              ) : (
                                <div className="p-3 text-gray-500">
                                  No countries found
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Save button */}
              <div className="mt-10 flex justify-center gap-2 lg:ml-64 items-center">
                {/* Back Button */}
                <button
                  type="button"
                  onClick={(e) => handleEditBack(e)}
                  className={`flex items-center justify-center w-10 h-[46px] rounded-[10px] border border-gray-300
                    ${
                      currentIndex === 0 ||
                      currentIndex === -1 ||
                      editableLeads.length === 0
                        ? " text-gray-400 cursor-not-allowed border border-gray-300"
                        : "bg-[#ef7e1b] text-white hover:bg-[#ee7f1b] transition-colors"
                    }
                  `}
                  disabled={
                    currentIndex === 0 ||
                    currentIndex === -1 ||
                    editableLeads.length === 0
                  }
                  title="Back"
                >
                  <svg
                    width="18"
                    height="18"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    viewBox="0 0 24 24"
                  >
                    <path d="M15 18l-6-6 6-6" />
                  </svg>
                </button>
                {/* Cancel button (existing) */}
                <button
                  type="button"
                  onClick={closeModal}
                  className="w-full md:w-[207px] h-[46px] text-[#ef7e1b] border border-[#0e4053] rounded-[10px] hover:bg-[#ee7f1b] hover:text-white transition-colors cursor-pointer"
                >
                  Cancel
                </button>
                {/* Save button (existing) */}
                <button
                  type="submit"
                  className="w-full md:w-[207px] h-[46px] bg-[#ef7e1b] text-white rounded-[10px] hover:bg-[#ee7f1b] transition-colors cursor-pointer"
                  onClick={(e) => handleSubmit(e, "save")}
                >
                  Save
                </button>
                {/* Save and Next Button */}
                <button
                  type="button"
                  onClick={(e) => handleEditNext(e)}
                  className={`flex items-center justify-center w-14 h-[46px] rounded-[10px]
                    ${
                      currentIndex === -1 ||
                      currentIndex === editableLeads.length - 1 ||
                      editableLeads.length === 0
                        ? " text-gray-400 cursor-not-allowed border border-gray-300"
                        : "bg-[#ef7e1b] text-white hover:bg-[#ee7f1b] transition-colors"
                    }
                  `}
                  title="Save and next"
                  disabled={
                    currentIndex === -1 ||
                    currentIndex === editableLeads.length - 1 ||
                    editableLeads.length === 0
                  }
                >
                  <span className="sr-only">Save and next</span>
                  <svg
                    width="18"
                    height="18"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    viewBox="0 0 24 24"
                  >
                    <path d="M9 6l6 6-6 6" />
                  </svg>
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Pagination Controls */}
      {filteredLeads.length > 0 && (
        <div className="flex justify-center pt-7 mt-auto">
          <div className="flex items-center gap-2 lg:gap-3">
            {/* Previous Page */}
            <button
              onClick={handlePreviousPage}
              disabled={currentPage === 1}
              className={`w-[44px] h-[44px] lg:w-[52px] lg:h-[52px]
          rounded-full border border-[#7E7B7B]
          flex items-center justify-center transition-colors
          ${
            currentPage === 1
              ? "opacity-50 cursor-not-allowed"
              : "group hover:bg-blue-200 hover:border-white hover:text-white"
          }
        `}
            >
              <svg
                width="33"
                height="32"
                viewBox="0 0 33 32"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                className={`stroke-current text-[#7E7B7B]
            ${currentPage === 1 ? "" : "group-hover"}
          `}
              >
                <path
                  d="M23.1667 5.33398L12.06 13.3873C9.09198 15.5407 9.09198 16.462 12.06 18.614L23.1667 26.6673"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Page Info */}
            <div className="flex items-center gap-2 text-sm lg:text-base text-[#4B5563]">
              <span>
                Page {currentPage} of {totalPages}
              </span>
              <span>({filteredLeads.length} total)</span>
            </div>

            {/* Next Page */}
            <button
              onClick={handleNextPage}
              disabled={currentPage === totalPages}
              className={`w-[44px] h-[44px] lg:w-[52px] lg:h-[52px]
          rounded-full border border-[#7E7B7B]
          flex items-center justify-center transition-colors
          ${
            currentPage === totalPages
              ? "opacity-50 cursor-not-allowed"
              : "group hover:bg-blue-200 hover:border-white hover:text-white"
          }
        `}
            >
              <svg
                width="52"
                height="52"
                viewBox="0 0 52 52"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                className={`stroke-current text-[#7E7B7B]
            ${currentPage === totalPages ? "" : "group-hover:text-white"}
          `}
              >
                <circle cx="26" cy="26" r="25.5" strokeWidth="1" />
                <path
                  d="M20.8333 15.334L31.94 23.3873C34.908 25.5407 34.908 26.462 31.94 28.614L20.8333 36.6673"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>
          </div>
        </div>
      )}

      {/* Import CSV Modal */}
      {isImportModalOpen && (
        <div className="fixed inset-0 flex items-center justify-center z-50">
          {/* Frosted overlay */}
          <div
            className="absolute inset-0 bg-gray-50/10 backdrop-blur-sm border border-white/30"
            onClick={() => {
              setIsImportModalOpen(false);
              setSelectedFile(null); // Clear selected file on modal close
            }}
          />

          {/* Glassmorphism modal container */}
          <div
            className="
              w-11/12 max-w-[500px] max-h-[90vh] overflow-y-auto p-6 md:p-8
              rounded-2xl
              bg-gradient-to-br from-[#FFFFFF] to-[#E6F4FF]
              shadow-lg
              relative z-10 custom-scrollbar
            "
          >
            {/* Close button */}
            <button
              onClick={() => {
                setIsImportModalOpen(false);
                setSelectedFile(null); // Clear selected file on modal close
              }}
              className="absolute top-6 right-6 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13 1L1 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M1 1L13 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Modal title */}
            <h2 className="text-[24px] font-medium text-[#1F2837] mb-6">
              Import Leads from CSV
            </h2>

            {/* File Upload Area */}
            <div
              className="border-2 border-dashed border-[#A0AEC0] rounded-lg p-6 text-center cursor-pointer hover:border-[#2798FF] transition-colors"
              onDragOver={(e) => e.preventDefault()} // Prevent default to allow drop
              onDrop={(e) => {
                e.preventDefault();
                handleFileChange(e);
              }}
              onClick={() => document.getElementById("csv-file-upload").click()}
            >
              <input
                type="file"
                id="csv-file-upload"
                accept=".csv"
                className="hidden"
                onChange={handleFileChange}
              />
              <FiUpload className="mx-auto w-10 h-10 text-[#A0AEC0] mb-3" />
              <p className="text-[#4B5563] text-sm">
                {selectedFile
                  ? `Selected file: ${selectedFile.name}`
                  : "Drag & drop your CSV file here, or click to browse"}
              </p>
              <p className="text-xs text-gray-500 mt-1">
                Only .csv files are supported
              </p>
            </div>
            <h6 className="text-xs text-right text-[#1F2837] mt-3">
              <button
                type="button"
                onClick={handleDownloadSample}
                className="text-[#2798FF] hover:underline focus:outline-none focus:ring-2 focus:ring-[#2798FF] rounded-md px-2 py-1 -mr-2 transition-colors duration-200"
              >
                View Sample File
              </button>
            </h6>
            {/* Submit button */}
            <div className="mt-8 flex justify-center">
              <button
                onClick={uploadCsvFile}
                disabled={!selectedFile}
                className={`w-full md:w-[207px] h-[46px] bg-[#ef7e1b] text-white rounded-[10px] transition-colors ${
                  !selectedFile
                    ? "opacity-50 cursor-not-allowed"
                    : "hover:bg-[#ee7f1b]"
                }`}
              >
                Import
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Bulk Assign Modal */}
      {isBulkAssignModalOpen && (
        <div className="fixed inset-0 flex items-center justify-center z-50">
          {/* Frosted overlay */}
          <div
            className="absolute inset-0 bg-gray-50/10 backdrop-blur-sm border border-white/30"
            onClick={() => {
              setIsBulkAssignModalOpen(false);
              setSelectedAssignee("");
              setAssigneeSearchTerm("");
            }}
          />

          {/* Glassmorphism modal container */}
          <div
            className="
              w-11/12 max-w-[700px] max-h-[98vh] p-6 md:p-8
              rounded-2xl
              bg-gradient-to-br from-[#FFFFFF] to-[#E6F4FF]
              shadow-lg
              relative z-10 custom-scrollbar
            "
          >
            {/* Close button */}
            <button
              onClick={() => {
                setIsBulkAssignModalOpen(false);
                setSelectedAssignee("");
                setAssigneeSearchTerm("");
              }}
              className="absolute top-6 right-6 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13 1L1 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M1 1L13 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Modal title */}
            <h2 className="text-[24px] font-medium text-[#1F2837] mb-6">
              Bulk Assign Leads
            </h2>

            {/* Assignee Selection */}
            <div className="space-y-4">
              <label className="block text-[#4B5563] text-[16px] mb-2">
                Assign to User:
              </label>
              <div className="relative" ref={assigneeDropdownRef}>
                <input
                  type="text"
                  placeholder="Search and select user..."
                  className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                  value={assigneeSearchTerm}
                  onChange={(e) => {
                    setAssigneeSearchTerm(e.target.value);
                    setIsAssigneeDropdownOpen(true); // Open dropdown on type
                  }}
                  onFocus={() => setIsAssigneeDropdownOpen(true)} // Open dropdown on focus
                />
                {isAssigneeDropdownOpen && (
                  <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
                    {users
                      .filter((user) =>
                        user.name
                          .toLowerCase()
                          .includes(assigneeSearchTerm.toLowerCase())
                      )
                      .map((user) => (
                        <button
                          key={user.id}
                          type="button"
                          onClick={() => {
                            setSelectedAssignee(user.name);
                            setAssigneeSearchTerm(user.name); // Set input value to selected name
                            setIsAssigneeDropdownOpen(false);
                          }}
                          className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                        >
                          {user.name}
                        </button>
                      ))}
                    {users.filter((user) =>
                      user.name
                        .toLowerCase()
                        .includes(assigneeSearchTerm.toLowerCase())
                    ).length === 0 && (
                      <div className="px-3 py-2 text-sm text-gray-500">
                        No users found.
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>

            {/* Assign button */}
            <div className="mt-8 flex justify-center">
              <button
                onClick={handleBulkAssign}
                disabled={
                  !selectedAssignee ||
                  selectedLeads.length === 0 ||
                  isBulkAssignLoading
                }
                className={`w-full md:w-[207px] h-[46px] bg-[#ef7e1b] text-white rounded-[10px] transition-colors ${
                  !selectedAssignee ||
                  selectedLeads.length === 0 ||
                  isBulkAssignLoading
                    ? "opacity-50 cursor-not-allowed"
                    : "hover:bg-[#ee7f1b]"
                }`}
              >
                {isBulkAssignLoading ? "Assigning..." : "Assign Selected Leads"}
              </button>
            </div>
          </div>
        </div>
      )}

      {isBulkEditModalOpen && (
        <div className="fixed inset-0 flex items-center justify-center z-50">
          {/* Frosted overlay */}
          <div
            className="absolute inset-0 bg-gray-50/10 backdrop-blur-sm border border-white/30"
            onClick={() => {
              setIsBulkEditModalOpen(false);
              setSelectedAssignee("");
              setAssigneeSearchTerm("");
              setBulkEditStatusSearch("");
              setBulkEditSelectedStatus(null);
              setBulkDeleteMessage(false);
              setBulkDeleteFollowUp(false);
              setBulkAssignUser(false);
              setBulkChangeStatus(false);
            }}
          />
          {/* Glassmorphism modal container */}
          <div className="w-11/12 max-w-[700px] max-h-[98vh] p-6 md:p-8 rounded-2xl bg-gradient-to-br from-[#FFFFFF] to-[#E6F4FF] shadow-lg relative z-10 custom-scrollbar overflow-y-auto">
            {/* Close button */}
            <button
              onClick={() => {
                setIsBulkEditModalOpen(false);
                setSelectedAssignee("");
                setAssigneeSearchTerm("");
                setBulkEditStatusSearch("");
                setBulkEditSelectedStatus(null);
                setBulkDeleteMessage(false);
                setBulkDeleteFollowUp(false);
                setBulkAssignUser(false);
                setBulkChangeStatus(false);
              }}
              className="absolute top-6 right-6 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors cursor-pointer"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13 1L1 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M1 1L13 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>
            {/* Modal title */}
            <h2 className="text-[24px] font-medium text-[#1F2837] mb-8 text-left">
              Bulk Edit Leads
            </h2>
            {/* Bulk Edit Options Section */}
            <div className="rounded-xl p-6 shadow-sm border border-[#E9EAEA] mb-5">
              <h3 className="text-lg font-semibold text-[#ef7e1b] mb-4">
                Bulk Edit Options
              </h3>
              <div className="space-y-4">
                {/* Assign User Option */}
                <div
                  className={`border-2 rounded-lg transition-all duration-300 ${
                    bulkAssignUser
                      ? "border-blue-400 bg-blue-50"
                      : "border-gray-200 hover:border-gray-300"
                  } ${
                    selectedLeads.length === 0
                      ? "cursor-not-allowed opacity-50"
                      : ""
                  }`}
                >
                  <label className="flex items-center cursor-pointer p-4">
                    <input
                      type="checkbox"
                      className="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                      checked={bulkAssignUser}
                      onChange={(e) => setBulkAssignUser(e.target.checked)}
                      disabled={selectedLeads.length === 0}
                    />
                    <span className="ml-4 flex flex-col">
                      <span className="font-semibold text-gray-700">
                        Assign to User
                      </span>
                      <span className="text-sm text-gray-500">
                        Assign selected leads to a specific user.
                      </span>
                    </span>
                  </label>

                  {/* Configuration section that expands when checkbox is checked */}
                  {bulkAssignUser && (
                    <div className="px-4 pb-4 border-t border-gray-200 pt-4">
                      <label className="block text-[#4B5563] text-[16px] mb-2">
                        Select User:
                      </label>
                      <div
                        className="relative"
                        ref={bulkEditAssigneeDropdownRef}
                      >
                        <input
                          type="text"
                          placeholder="Search and select user..."
                          className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                          value={assigneeSearchTerm}
                          onChange={(e) => {
                            setAssigneeSearchTerm(e.target.value);
                            setIsAssigneeDropdownOpen(true);
                          }}
                          onFocus={() => setIsAssigneeDropdownOpen(true)}
                        />
                        {isAssigneeDropdownOpen && (
                          <div className="absolute custom-scrollbar top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto">
                            {users
                              .filter((user) =>
                                user.name
                                  .toLowerCase()
                                  .includes(assigneeSearchTerm.toLowerCase())
                              )
                              .map((user) => (
                                <button
                                  key={user.id}
                                  type="button"
                                  onClick={() => {
                                    setSelectedAssignee(user.name);
                                    setAssigneeSearchTerm(user.name);
                                    setIsAssigneeDropdownOpen(false);
                                  }}
                                  className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                                >
                                  {user.name}
                                </button>
                              ))}
                            {users.filter((user) =>
                              user.name
                                .toLowerCase()
                                .includes(assigneeSearchTerm.toLowerCase())
                            ).length === 0 && (
                              <div className="px-3 py-2 text-sm text-gray-500">
                                No users found.
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                </div>

                {/* Status Change Option */}
                <div
                  className={`border-2 rounded-lg transition-all duration-300 ${
                    bulkChangeStatus
                      ? "border-blue-400 bg-blue-50"
                      : "border-gray-200 hover:border-gray-300"
                  } ${
                    selectedLeads.length === 0
                      ? "cursor-not-allowed opacity-50"
                      : ""
                  }`}
                >
                  <label className="flex items-center cursor-pointer p-4">
                    <input
                      type="checkbox"
                      className="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                      checked={bulkChangeStatus}
                      onChange={(e) => setBulkChangeStatus(e.target.checked)}
                      disabled={selectedLeads.length === 0}
                    />
                    <span className="ml-4 flex flex-col">
                      <span className="font-semibold text-gray-700">
                        Change Status
                      </span>
                      <span className="text-sm text-gray-500">
                        Update the status for selected leads.
                      </span>
                    </span>
                  </label>

                  {/* Configuration section that expands when checkbox is checked */}
                  {bulkChangeStatus && (
                    <div className="px-4 pb-4 border-t border-gray-200 pt-4">
                      <label className="block text-[#4B5563] text-[16px] mb-2">
                        Select Status:
                      </label>
                      <div className="relative" ref={bulkEditStatusDropdownRef}>
                        <input
                          type="text"
                          placeholder="Search and select status..."
                          className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                          value={bulkEditStatusSearch}
                          onChange={(e) => {
                            setBulkEditStatusSearch(e.target.value);
                            setIsBulkEditStatusDropdownOpen(true);
                          }}
                          onFocus={() => setIsBulkEditStatusDropdownOpen(true)}
                        />
                        {isBulkEditStatusDropdownOpen && (
                          <div className="absolute top-full custom-scrollbar left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto">
                            {statuses
                              .filter((status) =>
                                status.status_name
                                  .toLowerCase()
                                  .includes(bulkEditStatusSearch.toLowerCase())
                              )
                              .map((status) => (
                                <button
                                  key={status.status_id}
                                  type="button"
                                  onClick={() => {
                                    setBulkEditSelectedStatus(status);
                                    setBulkEditStatusSearch(status.status_name);
                                    setIsBulkEditStatusDropdownOpen(false);
                                  }}
                                  className={`w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] ${
                                    bulkEditSelectedStatus &&
                                    bulkEditSelectedStatus.status_id ===
                                      status.status_id
                                      ? "bg-[#E7EFF8] text-[#ef7e1b] font-bold"
                                      : ""
                                  }`}
                                >
                                  {status.status_name}
                                </button>
                              ))}
                            {statuses.filter((status) =>
                              status.status_name
                                .toLowerCase()
                                .includes(bulkEditStatusSearch.toLowerCase())
                            ).length === 0 && (
                              <div className="px-3 py-2 text-sm text-gray-500">
                                No statuses found.
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* Bulk Delete Section */}
            <div className="rounded-xl p-6 shadow-sm border border-[#E9EAEA] mt-5">
              <h3 className="text-lg font-semibold text-[#DD6B55] mb-4">
                Bulk Delete Actions
              </h3>
              <div className="space-y-4">
                <label
                  className={`flex items-center cursor-pointer p-4 border-2 rounded-lg transition-colors ${
                    bulkDeleteMessage
                      ? "border-red-400 bg-red-50"
                      : "border-gray-200 hover:border-gray-300"
                  } ${
                    selectedLeads.length === 0
                      ? "cursor-not-allowed opacity-50"
                      : ""
                  }`}
                >
                  <input
                    type="checkbox"
                    className="h-5 w-5 rounded border-gray-300 text-red-600 focus:ring-red-500"
                    checked={bulkDeleteMessage}
                    onChange={(e) => setBulkDeleteMessage(e.target.checked)}
                    disabled={selectedLeads.length === 0}
                  />
                  <span className="ml-4 flex flex-col">
                    <span className="font-semibold text-gray-700">
                      Bulk Delete Message
                    </span>
                    <span className="text-sm text-gray-500">
                      Permanently delete messages for selected leads.
                    </span>
                  </span>
                </label>
                <label
                  className={`flex items-center cursor-pointer p-4 border-2 rounded-lg transition-colors ${
                    bulkDeleteFollowUp
                      ? "border-red-400 bg-red-50"
                      : "border-gray-200 hover:border-gray-300"
                  } ${
                    selectedLeads.length === 0
                      ? "cursor-not-allowed opacity-50"
                      : ""
                  }`}
                >
                  <input
                    type="checkbox"
                    className="h-5 w-5 rounded border-gray-300 text-red-600 focus:ring-red-500"
                    checked={bulkDeleteFollowUp}
                    onChange={(e) => setBulkDeleteFollowUp(e.target.checked)}
                    disabled={selectedLeads.length === 0}
                  />
                  <span className="ml-4 flex flex-col">
                    <span className="font-semibold text-gray-700">
                      Bulk Delete Follow-up Date
                    </span>
                    <span className="text-sm text-gray-500">
                      Remove the scheduled follow-up dates from selected leads.
                    </span>
                  </span>
                </label>
              </div>

            </div>
 <button
                onClick={handleBulkActionsSubmit}
                disabled={
                  selectedLeads.length === 0 ||
                  (!bulkDeleteMessage &&
                    !bulkDeleteFollowUp &&
                    !bulkAssignUser &&
                    !bulkChangeStatus)
                }
                className={`mt-6 w-full h-[44px] bg-[#ef7e1b] text-white rounded-[10px] transition-colors text-base font-medium shadow-sm ${
                  selectedLeads.length === 0 ||
                  (!bulkDeleteMessage &&
                    !bulkDeleteFollowUp &&
                    !bulkAssignUser &&
                    !bulkChangeStatus)
                    ? "opacity-50 cursor-not-allowed"
                    : "hover:bg-[#ee7f1b] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#0e4053]"
                }`}
              >
                Apply Selected Actions
              </button>

            {/* Info and spacing at the bottom */}
            <div className="mt-8 text-center text-[#4B5563] text-sm">
              {selectedLeads.length === 0 ? (
                <span>Select leads to enable bulk actions.</span>
              ) : (
                <span>
                  {selectedLeads.length} lead
                  {selectedLeads.length > 1 ? "s" : ""} selected.
                </span>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default CustomLeadManager;
</file>

<file path="src/pages/dashboard/dashboard.jsx">
import React, { useEffect, useState, useRef } from "react";
import axios from "axios";
import Container1 from "./Container1";
import {
  BsCardChecklist,
  BsFillTelephoneOutboundFill,
  BsFillPersonCheckFill,
  BsFillClockFill,
  BsFillFileEarmarkTextFill,
  BsFillReplyFill,
  BsFillPersonLinesFill,
  BsFillBuildingFill,
} from "react-icons/bs";
// import AvgLeads from "./AvgLeads";
// import Quotation from "./Quotation";

import api from "../../api";
import { useAuth } from "../../auth/AuthContext";
import { useNavigate } from "react-router-dom";

const LEAD_STATUS_CARDS = [
  {
    id: 2,
    label: "Follow Ups",
    icon: <BsCardChecklist />,
  },
  {
    id: 3,
    label: "Get Call Back Us",
    icon: <BsFillTelephoneOutboundFill />,
  },
  {
    id: 4,
    label: "Contact In Future",
    icon: <BsFillPersonCheckFill />,
  },
  {
    id: 5,
    label: "Next Day Payments",
    icon: <BsFillClockFill />,
  },
  {
    id: 6,
    label: "Quote Send",
    icon: <BsFillFileEarmarkTextFill />,
  },
  {
    id: 7,
    label: "Call Back",
    icon: <BsFillReplyFill />,
  },
  {
    id: 8,
    label: "Construction",
    icon: <BsFillBuildingFill />,
  },
];

const Dashboard = () => {
  const [leads, setLeads] = useState([]);
  const [searchTerm, setSearchTerm] = useState("");
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10);
  const [isItemsPerPageDropdownOpen, setIsItemsPerPageDropdownOpen] =
    useState(false);

  // New: Ref for the items per page dropdown
  const itemsPerPageDropdownRef = useRef(null);

  // New: State for lead counts by status
  const [leadCounts, setLeadCounts] = useState({});

  // New: State for users and their today leads
  const [users, setUsers] = useState([]);
  const [userTodayLeads, setUserTodayLeads] = useState({}); // for created today
  const [userUpdatedLeads, setUserUpdatedLeads] = useState({}); // for updated today

  const { user, rolePermissions } = useAuth();
  console.log("the user is here", user);
  const navigate = useNavigate();

  useEffect(() => {
    const fetchLeads = async () => {
      try {
        const response = await api.get("/customeren/1");
        const data = response.data;
        if (data.success && Array.isArray(data.result)) {
          setLeads(data.result);
        }
      } catch (error) {
        // Optionally handle error
        console.error("Failed to fetch leads:", error);
      }
    };
    fetchLeads();
  }, []);

  // Fetch all lead counts for the status cards
  useEffect(() => {
    const fetchLeadCounts = async () => {
      try {
        const results = await Promise.all(
          LEAD_STATUS_CARDS.map((status) => api.get(`/leadscount/${status.id}`))
        );
        const counts = {};
        results.forEach((res, idx) => {
          counts[LEAD_STATUS_CARDS[idx].id] = res.data?.total_leads || 0;
        });
        setLeadCounts(counts);
      } catch (err) {
        console.error("Error fetching lead counts:", err);
      }
    };
    fetchLeadCounts();
  }, []);

  // Fetch all users and their todaycreated and todayupdated leads
  useEffect(() => {
    const fetchUsersAndTodayLeads = async () => {
      try {
        if (rolePermissions === "ALL") {
          // Existing logic for ALL
          const usersRes = await api.get("/allusers");
          if (usersRes.data.success && Array.isArray(usersRes.data.result)) {
            let filteredUsers = usersRes.data.result.filter(
              (user) => user.role !== "admin"
            );
            const roleOrder = { sales_manager: 1, manager: 2, user: 3 };
            filteredUsers.sort(
              (a, b) => (roleOrder[a.role] || 99) - (roleOrder[b.role] || 99)
            );
            setUsers(filteredUsers);

            const todayLeadsResults = await Promise.all(
              filteredUsers.map(async (user) => {
                const created = await api
                  .get(`/todaycreated/${user.id}`)
                  .then((res) => res.data.total_leads || 0)
                  .catch(() => 0);
                const updated = await api
                  .get(`/todayupdated/${user.id}`)
                  .then((res) => res.data.total_leads || 0)
                  .catch(() => 0);
                return {
                  id: user.id,
                  name: user.name || user.username, // fallback to username
                  role: user.role,
                  today_leads: created,
                  updated_leads: updated,
                };
              })
            );
            const todayLeadsMap = {};
            const updatedLeadsMap = {};
            todayLeadsResults.forEach((item) => {
              todayLeadsMap[item.id] = {
                today_leads: item.today_leads,
                role: item.role,
                name: item.name,
              };
              updatedLeadsMap[item.id] = {
                updated_leads: item.updated_leads,
              };
            });
            setUserTodayLeads(todayLeadsMap);
            setUserUpdatedLeads(updatedLeadsMap);
          }
        } else if (user && user.id) {
          // Only fetch for the current user
          setUsers([user]);
          const created = await api
            .get(`/todaycreated/${user.id}`)
            .then((res) => res.data.total_leads || 0)
            .catch(() => 0);
          const updated = await api
            .get(`/todayupdated/${user.id}`)
            .then((res) => res.data.total_leads || 0)
            .catch(() => 0);

          setUserTodayLeads({
            [user.id]: {
              today_leads: created,
              role: user.role,
              name: user.name || user.username, // fallback to username
            },
          });
          setUserUpdatedLeads({
            [user.id]: {
              updated_leads: updated,
            },
          });
        }
      } catch (err) {
        console.error("Error fetching users/today leads:", err);
      }
    };
    fetchUsersAndTodayLeads();
  }, [rolePermissions, user]);

  // Filtering and pagination logic
  const filteredLeads = leads.filter((lead) => {
    if (!searchTerm) return true;
    const term = searchTerm.toLowerCase();
    return (
      (lead.customer_name && lead.customer_name.toLowerCase().includes(term)) ||
      (lead.email && lead.email.toLowerCase().includes(term)) ||
      (lead.contact && lead.contact.toLowerCase().includes(term))
    );
  });

  const totalPages = Math.ceil(filteredLeads.length / itemsPerPage) || 1;
  const currentLeads = filteredLeads.slice(
    (currentPage - 1) * itemsPerPage,
    currentPage * itemsPerPage
  );

  const handlePreviousPage = () => {
    setCurrentPage((prev) => Math.max(prev - 1, 1));
  };
  const handleNextPage = () => {
    setCurrentPage((prev) => Math.min(prev + 1, totalPages));
  };
  const handleItemsPerPageChange = (num) => {
    setItemsPerPage(num);
    setCurrentPage(1);
  };

  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        itemsPerPageDropdownRef.current &&
        !itemsPerPageDropdownRef.current.contains(event.target)
      ) {
        setIsItemsPerPageDropdownOpen(false);
      }
    };

    if (isItemsPerPageDropdownOpen) {
      document.addEventListener("mousedown", handleClickOutside);
    } else {
      document.removeEventListener("mousedown", handleClickOutside);
    }

    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [isItemsPerPageDropdownOpen]);

  // Helper for date formatting
  const formatDateTimeForTable = (dateString) => {
    if (!dateString) return "-";
    const date = new Date(dateString);
    if (isNaN(date)) return dateString;
    return date.toLocaleString();
  };

  // Helper for role formatting
  const formatRole = (role) => {
    if (role === "sales_manager") return "Sales Manager";
    if (role === "manager") return "Manager";
    if (role === "user") return "User";
    return role;
  };

  //seperator

  const [dashboardData, setDashboardData] = useState({});
  const [error, setError] = useState(null);

  const fetchAllData = async () => {
    try {
      const token = localStorage.getItem("token");
      if (!token) {
        setError("No token found. Please login.");
        return;
      }

      const [leadsByStatusRes] = await Promise.all([
        api.get("/totalleads", {}),
      ]);

      setDashboardData({
        leadsByStatus: leadsByStatusRes.data,
      });
    } catch (err) {
      console.error("❌ Error fetching dashboard data:", err);
      setError("Failed to load dashboard data.");
    }
  };

  useEffect(() => {
    fetchAllData();
  }, []);

  return (
    <div className="box-border max-w-7xl w-full md:w-[95vw] lg:max-w-[1180px] md:mx-auto px-2 sm:px-4 lg:px-0 overflow-x-hidden">
      {/* Top Lead Status Cards */}
      <div className="flex flex-wrap justify-between md:justify-start gap-2 md:gap-7 sm:gap-4 mb-4 w-full lg:max-w-[85vw] custom-1322 custom-1400 ">
        {/* Total Leads card at the very start */}
        <Container1
          leads={dashboardData?.leadsByStatus?.total_leads || 0}
          icon={<BsFillPersonLinesFill />}
          totalLeadsLabel="Total Leads"
        />
        {/* Render a Container1 for each status */}
        {LEAD_STATUS_CARDS.map((status) => (
          <Container1
            key={status.id}
            leads={leadCounts[status.id] || 0}
            icon={status.icon}
            totalLeadsLabel={status.label}
          />
        ))}
      </div>

      {/* User Activity Today Section */}
      {users.length > 0 && (
        <div className="mb-8 w-full overflow-x-auto lg:w-5/6 md:w-[700px] custom-1300 py-4 ">
          <div className="text-[#727A90] text-sm font-medium mb-2 ml-1">
            User Activity Today
          </div>
          <div className="flex flex-wrap gap-4 w-full min-w-0 justify-center md:justify-start">
            {users.map((user) => {
              const todayData = userTodayLeads[user.id] || {};
              const updatedData = userUpdatedLeads[user.id] || {};
              // Avatar initials
              const initials = (
                todayData.name ||
                user.name ||
                user.username ||
                "?"
              )
                .split(" ")
                .map((n) => n[0])
                .join("")
                .toUpperCase();
              // Role badge color
              const roleColor =
                (todayData.role || user.role) === "admin"
                  ? "bg-blue-50 text-blue-600 border-blue-200"
                  : (todayData.role || user.role) === "manager"
                  ? "bg-green-50 text-green-600 border-green-200"
                  : (todayData.role || user.role) === "sales_manager"
                  ? "bg-purple-50 text-purple-600 border-purple-200"
                  : "bg-gray-50 text-gray-600 border-gray-200";
              return (
                <div
                  key={user.id}
                  className="flex flex-col items-center  justify-center bg-gradient-to-br from-white to-[#E7F4FF] rounded-[12px] shadow-[0_2px_8px_rgba(24,95,235,0.06)] px-2 sm:px-3 md:px-5 py-3 sm:py-4 min-w-[100px] sm:min-w-[120px] md:min-w-[150px] max-w-[120px] sm:max-w-[150px] md:max-w-[170px] border border-[#E9EAEA] cursor-pointer hover:shadow-lg transition w-full sm:w-auto mb-2 sm:mb-0 box-border overflow-hidden"
                  onClick={() =>
                    navigate("/leads/all", {
                      state: { assignedTo: user.id, updatedBy: user.id },
                    })
                  }
                  title={`View leads for ${
                    todayData.name || user.name || user.username
                  }`}
                >
                  {/* Avatar */}
                  <div className="w-8 h-8 rounded-full bg-[#e3e9f7] flex items-center justify-center text-sm font-semibold text-[#ef7e1b] mb-2 shadow-sm border border-[#d1e3fa]">
                    {initials}
                  </div>
                  {/* Name */}
                  <div className="text-[15px] font-semibold text-[#1F2837] mb-0.5 truncate w-full text-center max-w-full">
                    {todayData.name || user.name || user.username}
                  </div>
                  {/* Role badge */}
                  <div
                    className={`text-[11px] font-normal px-2 py-0.5 rounded-full border ${roleColor} mb-2 capitalize w-fit mx-auto`}
                  >
                    {formatRole(todayData.role || user.role)}
                  </div>
                  {/* Divider */}
                  <div className="w-full h-px bg-[#F0F4F8] my-1" />
                  {/* Today's Leads and Updated Leads Today */}
                  <div className="flex flex-col items-center mt-1 gap-1 w-full">
                    <div className="flex flex-row justify-between items-center w-full"></div>
                    <div className="flex flex-row justify-between items-center w-full">
                      <span className="text-[10px] text-[#727A90] mt-0.5 text-left ">
                        Today's <br></br>Updated Leads
                      </span>
                      <span className="text-2xl font-bold text-[#ef7e1b] leading-none text-right">
                        {updatedData.updated_leads ?? 0}
                      </span>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* Customer Enquiry Section */}
      <div
        className={`min-h-[797px] p-2 sm:p-4 md:p-6 mt-8 relative bg-gradient-to-br from-white to-[#E7F4FF] rounded-[10px] shadow-[2px_2px_6px_rgba(24,95,235,0.1)] flex flex-col w-full box-border overflow-x-auto md:w-11/12 lg:max-w-[75vw] xl:w-full  `}
      >
        {/* Header Section */}
        <div className="flex flex-wrap items-center justify-between gap-2 sm:gap-4 mb-8 w-full min-w-0">
          <h1 className="text-[18px] sm:text-[20px] md:text-[22px] font-medium text-[#1F2837] whitespace-nowrap truncate max-w-full   ">
            Customer Enquiry
          </h1>
          <div className="flex flex-wrap items-center gap-2 md:gap-3 lg:gap-4">
            <span className="text-[#727A90] text-xs sm:text-sm md:text-base lg:text-base whitespace-nowrap">
              Show
            </span>
            <div
              className="relative min-w-[56px] sm:min-w-[72px] md:min-w-[88px] lg:min-w-[88px] max-w-full"
              ref={itemsPerPageDropdownRef}
            >
              <button
                type="button"
                className="relative appearance-none h-[32px] sm:h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-8 sm:pr-10 md:pr-15 lg:pr-15 w-full min-w-[56px] sm:min-w-[72px] md:min-w-[88px] lg:min-w-[88px] bg-white border border-[#E9EAEA] rounded-[8px]  text-[#242729] text-[10px] sm:text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center box-border"
                onClick={() => setIsItemsPerPageDropdownOpen((open) => !open)}
              >
                <span className="truncate text-left flex-1">
                  {itemsPerPage}
                </span>
                <img
                  src="/caret-down.svg"
                  alt=""
                  aria-hidden="true"
                  className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
                />
              </button>
              {isItemsPerPageDropdownOpen && (
                <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar box-border">
                  {[5, 10, 20, 50].map((option) => (
                    <button
                      key={option}
                      type="button"
                      onClick={() => {
                        handleItemsPerPageChange(option);
                        setIsItemsPerPageDropdownOpen(false);
                      }}
                      className={`w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-xs sm:text-sm md:text-base lg:text-base ${
                        itemsPerPage === option
                          ? "bg-[#E7EFF8] font-bold text-[#ef7e1b]"
                          : "text-[#545454]"
                      }`}
                    >
                      {option}
                    </button>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Lead List Table */}
        <div className="hidden md:block w-full flex-grow overflow-x-auto overflow-y-hidden relative custom-scrollbar box-border">
          <table className="min-w-full border-collapse text-xs sm:text-sm md:text-base box-border">
            <thead>
              <tr className="text-left text-[#4B5563]">
                <th className="py-4 px-2 sm:px-4 md:px-6 font-medium text-sm whitespace-nowrap  max-w-[120px]">
                  Customer ID
                </th>
                <th className="py-4 px-2 sm:px-4 md:px-6 font-medium text-sm whitespace-nowrap  max-w-[180px]">
                  Customer Name
                </th>
                <th className="py-4 px-2 sm:px-4 md:px-6 font-medium text-sm  max-w-[160px]">
                  Email
                </th>
                <th className="py-4 px-2 sm:px-4 md:px-6 font-medium text-sm  max-w-[120px]">
                  Contact
                </th>
                <th className="py-4 px-2 sm:px-4 md:px-6 font-medium text-sm  max-w-[120px]">
                  City
                </th>
                <th className="py-4 px-2 sm:px-4 md:px-6 font-medium text-sm  max-w-[120px]">
                  WhatsApp
                </th>
                <th className="py-4 px-2 sm:px-4 md:px-6 font-medium text-sm  max-w-[180px]">
                  Requirements
                </th>
                <th className="py-4 px-2 sm:px-4 md:px-6 font-medium text-sm  max-w-[180px]">
                  Message
                </th>
                <th className="py-4 px-2 sm:px-4 md:px-6 font-medium text-sm  max-w-[120px]">
                  Source
                </th>
                <th className="py-4 px-2 sm:px-4 md:px-6 font-medium text-sm whitespace-nowrap  max-w-[120px]">
                  Status
                </th>
                <th className="py-4 px-2 sm:px-4 md:px-6 font-medium text-sm whitespace-nowrap  max-w-[120px]">
                  Assigned User
                </th>
              </tr>
            </thead>
            <tbody>
              {currentLeads.length === 0 ? (
                <tr>
                  <td
                    colSpan="11"
                    className="py-8 px-6 text-center text-[#4B5563]"
                  >
                    {searchTerm
                      ? "No leads found matching your search."
                      : "No leads available."}
                  </td>
                </tr>
              ) : (
                currentLeads.map((lead) => (
                  <tr
                    key={lead.customer_id}
                    className="border-t border-[#E5E7EB]"
                  >
                    <td className="py-4 px-2 sm:px-4 md:px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.customer_id}
                    </td>
                    <td className="py-4 px-2 sm:px-4 md:px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      <div className="flex items-center gap-3 ">
                        <div className="w-9 h-9 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                          <img
                            src={lead.profile_pic || "/dummyavatar.jpeg"}
                            alt={lead.customer_name}
                            className="w-full h-full object-cover"
                            onError={(e) => {
                              e.target.onerror = null;
                              e.target.src = "/dummyavatar.jpeg";
                            }}
                          />
                        </div>
                        <div className="flex flex-col">
                          <span className="text-[#1F2837] font-medium">
                            {lead.customer_name}
                          </span>
                        </div>
                      </div>
                    </td>
                    <td className="py-4 px-2 sm:px-4 md:px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.email}
                    </td>
                    <td className="py-4 px-2 sm:px-4 md:px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.contact}
                    </td>
                    <td className="py-4 px-2 sm:px-4 md:px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {(() => {
                        let parsedAddress = null;
                        if (
                          lead.city &&
                          typeof lead.city === "string" &&
                          lead.city.trim().startsWith("{")
                        ) {
                          try {
                            parsedAddress = JSON.parse(lead.city);
                          } catch (e) {
                            // ignore
                          }
                        } else if (lead.city && typeof lead.city === "object") {
                          parsedAddress = lead.city;
                        }
                        // Only show city if present and not empty
                        if (
                          parsedAddress &&
                          parsedAddress.city &&
                          parsedAddress.city.trim() !== ""
                        ) {
                          return parsedAddress.city;
                        }
                        // If not a JSON, but a plain string (legacy), show only if not empty and not a JSON string
                        if (
                          lead.city &&
                          typeof lead.city === "string" &&
                          lead.city.trim() !== "" &&
                          !lead.city.trim().startsWith("{")
                        ) {
                          return lead.city;
                        }
                        return "-";
                      })()}
                    </td>
                    <td className="py-4 px-2 sm:px-4 md:px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.whatsapp_number || "-"}
                    </td>
                    <td className="py-4 px-2 sm:px-4 md:px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.requirements}
                    </td>
                    <td className="py-4 px-2 sm:px-4 md:px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.message}
                    </td>
                    <td className="py-4 px-2 sm:px-4 md:px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.source}
                    </td>
                    <td className="py-4 px-2 sm:px-4 md:px-6 max-w-xs overflow-hidden truncate">
                      <span
                        className={`
                        px-3 py-1 rounded-lg text-sm flex items-center gap-2
                        ${
                          lead.status_name === "Fresh List"
                            ? "bg-[#27AE60] text-white"
                            : lead.status_name === "Follow Up"
                            ? "bg-[#ef7e1b] text-white"
                            : lead.status_name === "Get Call Back Us"
                            ? "bg-[#FFFBEB] text-[#D97706]"
                            : lead.status_name === "Contact In Future"
                            ? "bg-[#FFF8DD] text-[#F1C40F]"
                            : lead.status_name === "Next Day Payments"
                            ? "bg-[#27AE60] text-white"
                            : lead.status_name === "Quote Send"
                            ? "bg-[#ef7e1b] text-white"
                            : lead.status_name === "Call Back"
                            ? "bg-[#FFFBEB] text-[#D97706]"
                            : lead.status_name === "Construction"
                            ? "bg-[#FFF8DD] text-[#F1C40F]"
                            : lead.status_name === "NPC"
                            ? "bg-[#27AE60] text-white"
                            : lead.status_name === "Switch off"
                            ? "bg-[#ef7e1b] text-white"
                            : lead.status_name === "Not Reachable"
                            ? "bg-[#FFFBEB] text-[#D97706]"
                            : lead.status_name === "Quotation"
                            ? "bg-[#FFF8DD] text-[#ff0000]"
                            : lead.status_name === "Converted Client"
                            ? "bg-[#093d6e] text-white"
                            : "bg-[#173f12] text-white"
                        }
                      `}
                      >
                        {lead.status_name}
                      </span>
                    </td>
                    <td className="py-4 px-2 sm:px-4 md:px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.assigned_to}
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>

        {/* Lead List Cards for Mobile */}
        <div className="md:hidden w-full space-y-4 sm:space-y-6 pb-20 sm:pb-24 flex-grow overflow-x-auto">
          {currentLeads.length === 0 ? (
            <div className="py-12 px-6 text-center">
              <div className="w-16 h-16 mx-auto mb-4  rounded-full flex items-center justify-center">
                <svg
                  className="w-8 h-8 text-gray-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth="1.5"
                    d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-5.5a2.5 2.5 0 00-2.5 2.5v.5a2 2 0 01-2 2h-3a2 2 0 01-2-2v-.5a2.5 2.5 0 00-2.5-2.5H4"
                  />
                </svg>
              </div>
              <p className="text-gray-500 font-medium">
                {searchTerm
                  ? "No leads found matching your search."
                  : "No leads available."}
              </p>
            </div>
          ) : (
            currentLeads.map((lead) => (
              <div
                key={lead.customer_id}
                className="bg-white rounded-2xl border border-gray-100 hover:border-gray-200 transition-all duration-300 hover:shadow-lg p-2 sm:p-4 "
              >
                {/* Header Section */}
                <div className="p-4 sm:p-6 border-b border-gray-50">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-2 sm:space-x-4">
                      <div className="flex items-center space-x-3 ">
                        <div className="w-12 h-12 rounded-full bg-gray-100 overflow-hidden ring-1 ring-gray-200">
                          <img
                            src={lead.profile_pic || "/dummyavatar.jpeg"}
                            alt={lead.customer_name}
                            className="w-full h-full object-cover"
                            onError={(e) => {
                              e.target.onerror = null;
                              e.target.src = "/dummyavatar.jpeg";
                            }}
                          />
                        </div>
                        <div>
                          <h3 className="text-base font-semibold text-gray-900 whitespace-nowrap">
                            {lead.customer_name}
                          </h3>
                          <p className="text-xs text-gray-500">{lead.email}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {/* Details Section */}
                <div className="p-3 sm:p-4 space-y-3">
                  <div className="grid grid-cols-2 gap-2">
                    <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200 ">
                      <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                        <svg
                          className="w-3 h-3 text-gray-600"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="1.5"
                            d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                          />
                        </svg>
                      </div>
                      <div className="min-w-0 flex-1 ">
                        <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                          Contact
                        </p>
                        <p className="text-[10px] ml-1 text-gray-900">
                          {lead.contact}
                        </p>
                      </div>
                    </div>
                    <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200 ">
                      <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                        <svg
                          className="w-3 h-3 text-gray-600"
                          fill="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.465 3.488" />
                        </svg>
                      </div>
                      <div className="min-w-0 flex-1">
                        <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide ">
                          WhatsApp
                        </p>
                        <p className="text-[10px] ml-1 text-gray-900">
                          {lead.whatsapp_number || "-"}
                        </p>
                      </div>
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-2">
                    <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200 ">
                      <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                        <svg
                          className="w-3 h-3 text-gray-600"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="1.5"
                            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                          />
                        </svg>
                      </div>
                      <div className="min-w-0 flex-1">
                        <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide ">
                          City
                        </p>
                        <p className="text-[10px] ml-1 text-gray-900">
                          {(() => {
                            let parsedAddress = null;
                            if (
                              lead.city &&
                              typeof lead.city === "string" &&
                              lead.city.trim().startsWith("{")
                            ) {
                              try {
                                parsedAddress = JSON.parse(lead.city);
                              } catch (e) {
                                // ignore
                              }
                            } else if (
                              lead.city &&
                              typeof lead.city === "object"
                            ) {
                              parsedAddress = lead.city;
                            }
                            // Only show city if present and not empty
                            if (
                              parsedAddress &&
                              parsedAddress.city &&
                              parsedAddress.city.trim() !== ""
                            ) {
                              return parsedAddress.city;
                            }
                            // If not a JSON, but a plain string (legacy), show only if not empty and not a JSON string
                            if (
                              lead.city &&
                              typeof lead.city === "string" &&
                              lead.city.trim() !== "" &&
                              !lead.city.trim().startsWith("{")
                            ) {
                              return lead.city;
                            }
                            return "-";
                          })()}
                        </p>
                      </div>
                    </div>
                    <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200 ">
                      <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                        <svg
                          className="w-3 h-3 text-gray-600"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="1.5"
                            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
                          />
                        </svg>
                      </div>
                      <div className="min-w-0 flex-1">
                        <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide ">
                          Source
                        </p>
                        <p className="text-[10px] ml-1 text-gray-900">
                          {lead.source}
                        </p>
                      </div>
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-2">
                    <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200 ">
                      <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                        <svg
                          className="w-3 h-3 text-gray-600"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="1.5"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                          />
                        </svg>
                      </div>
                      <div className="min-w-0 flex-1">
                        <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide ">
                          Assigned User
                        </p>
                        <p className="text-[10px] ml-1 text-gray-900 whitespace-nowrap">
                          {lead.assigned_to}
                        </p>
                      </div>
                    </div>
                    <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200 ">
                      <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                        <svg
                          className="w-3 h-3 text-gray-600"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="1.5"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                          />
                        </svg>
                      </div>
                      <div className="min-w-0 flex-1">
                        <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                          Follow Up
                        </p>
                        <p className="text-[7px] sm:text-xs ml-1 text-gray-900 whitespace-nowrap">
                          {formatDateTimeForTable(lead.follow_up_date)}
                        </p>
                      </div>
                    </div>
                  </div>
                  <div className="flex items-start space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200 ">
                    <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                      <svg
                        className="w-3 h-3 text-gray-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="1.5"
                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                        />
                      </svg>
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                        Requirements
                      </p>
                      <p className="text-[10px] ml-1 text-gray-900 leading-relaxed">
                        {lead.requirements}
                      </p>
                    </div>
                  </div>
                  <div className="flex items-start space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200 ">
                    <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                      <svg
                        className="w-3 h-3 text-gray-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="1.5"
                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                        />
                      </svg>
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                        Message
                      </p>
                      <p className="text-[10px] ml-1 text-gray-900 leading-relaxed">
                        {lead.message}
                      </p>
                    </div>
                  </div>
                  <div className="flex items-start space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200 ">
                    <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                      <svg
                        className="w-3 h-3 text-gray-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="1.5"
                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                        />
                      </svg>
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                        Status
                      </p>
                      <span
                        className={`
                        px-3 py-1 rounded-full text-xs font-medium
                        ${
                          lead.status_name === "Fresh List"
                            ? "bg-emerald-100 text-emerald-800"
                            : lead.status_name === "Follow Up"
                            ? "bg-blue-100 text-blue-800"
                            : lead.status_name === "Get Call Back Us"
                            ? "bg-amber-100 text-amber-800"
                            : lead.status_name === "Contact In Future"
                            ? "bg-yellow-100 text-yellow-800"
                            : lead.status_name === "Next Day Payments"
                            ? "bg-emerald-100 text-emerald-800"
                            : lead.status_name === "Quote Send"
                            ? "bg-blue-100 text-blue-800"
                            : lead.status_name === "Call Back"
                            ? "bg-amber-100 text-amber-800"
                            : lead.status_name === "Construction"
                            ? "bg-yellow-100 text-yellow-800"
                            : lead.status_name === "NPC"
                            ? "bg-emerald-100 text-emerald-800"
                            : lead.status_name === "Switch off"
                            ? "bg-blue-100 text-blue-800"
                            : lead.status_name === "Not Reachable"
                            ? "bg-amber-100 text-amber-800"
                            : lead.status_name === "Quotation"
                            ? "bg-red-100 text-red-800"
                            : lead.status_name === "Converted Client"
                            ? "bg-[#093d6e] text-white"
                            : "bg-[#173f12] text-white"
                        }
                      `}
                      >
                        {lead.status_name}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            ))
          )}
        </div>
        {/* Pagination Controls */}
        {filteredLeads.length > 0 && (
          <div className="flex justify-center pt-4 sm:pt-7 mt-auto">
            <div className="flex items-center gap-1 sm:gap-2 lg:gap-3">
              <button
                onClick={handlePreviousPage}
                disabled={currentPage === 1}
                className={`w-[44px] h-[44px] lg:w-[52px] lg:h-[52px]
          rounded-full border border-[#7E7B7B]
          flex items-center justify-center transition-colors
          ${
            currentPage === 1
              ? "opacity-50 cursor-not-allowed"
              : "group hover:bg-blue-200 hover:border-white hover:text-white"
          }
        `}
              >
                <svg
                  width="33"
                  height="32"
                  viewBox="0 0 33 32"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  className={`stroke-current text-[#7E7B7B]
            ${currentPage === 1 ? "" : "group-hover"}
          `}
                >
                  <path
                    d="M23.1667 5.33398L12.06 13.3873C9.09198 15.5407 9.09198 16.462 12.06 18.614L23.1667 26.6673"
                    strokeWidth="1.5"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                </svg>
              </button>
              <div className="flex items-center gap-1 sm:gap-2 text-xs sm:text-sm lg:text-base text-[#4B5563]">
                <span>
                  Page {currentPage} of {totalPages}
                </span>
                <span>({filteredLeads.length} total)</span>
              </div>
              <button
                onClick={handleNextPage}
                disabled={currentPage === totalPages}
                className={`w-[44px] h-[44px] lg:w-[52px] lg:h-[52px]
          rounded-full border border-[#7E7B7B]
          flex items-center justify-center transition-colors
          ${
            currentPage === totalPages
              ? "opacity-50 cursor-not-allowed"
              : "group hover:bg-blue-200 hover:border-white hover:text-white"
          }
        `}
              >
                <svg
                  width="52"
                  height="52"
                  viewBox="0 0 52 52"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  className={`stroke-current text-[#7E7B7B]
            ${currentPage === totalPages ? "" : "group-hover:text-white"}
          `}
                >
                  <circle cx="26" cy="26" r="25.5" strokeWidth="1" />
                  <path
                    d="M20.8333 15.334L31.94 23.3873C34.908 25.5407 34.908 26.462 31.94 28.614L20.8333 36.6673"
                    strokeWidth="1.5"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                </svg>
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default Dashboard;
</file>

<file path="src/pages/leads/AllLeads.jsx">
import React, { useState, useEffect, useRef, useContext, useMemo } from "react";
import { FiChevronDown, FiEdit, FiUpload, FiDownload } from "react-icons/fi";
import { TbDotsVertical } from "react-icons/tb";
import api from "../../api";
import Swal from "sweetalert2";
import { FaCheck } from "react-icons/fa6";
import { FaFileImport } from "react-icons/fa6";

import { Country, State, City } from "country-state-city";

import { useAuth } from "../../auth/AuthContext";
import { useLocation } from "react-router-dom";
import { RxCross2 } from "react-icons/rx";

import "../../styles/scrollbar.css";
import { form } from "motion/react-client";
import { SidebarContext } from "../../components/Layout";

const CreateLeads = () => {
  // Mobile detection and search state
  const [isMobile, setIsMobile] = useState(() => window.innerWidth < 768);
  const [isSearchExpanded, setIsSearchExpanded] = useState(false);
  const [leads, setLeads] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [isModalOpenCreate, setIsModalOpenCreate] = useState(false);
  const [statuses, setStatuses] = useState([]);

  const [bulkDeleteMessage, setBulkDeleteMessage] = useState(false);
  const [bulkDeleteFollowUp, setBulkDeleteFollowUp] = useState(false);

  // New state variables for bulk edit checkboxes
  const [bulkAssignUser, setBulkAssignUser] = useState(false);
  const [bulkChangeStatus, setBulkChangeStatus] = useState(false);

  //New import, export handlers
  // Add these states for import/export file type selection
  const [importFileType, setImportFileType] = useState("csv"); // "csv" or "xls"
  const [exportFileType, setExportFileType] = useState("csv"); // "csv" or "xls"
  const [isExportModalOpen, setIsExportModalOpen] = useState(false);

  // Add new state for status dropdown
  const [isStatusDropdownOpen, setIsStatusDropdownOpen] = useState(false);
  const statusDropdownRef = useRef(null);
  const [isEditStatusDropdownOpen, setIsEditStatusDropdownOpen] =
    useState(false);
  const editStatusDropdownRef = useRef(null);
  // Add new state for assign to dropdown
  const [isAssignToDropdownOpen, setIsAssignToDropdownOpen] = useState(false);
  const assignToDropdownRef = useRef(null);
  // Add new state for CSV dropdown
  const [isCsvDropdownOpen, setIsCsvDropdownOpen] = useState(false);
  const csvDropdownRef = useRef(null);
  // New state for follow up date range filter
  const [dateRangeDropdownOpen, setDateRangeDropdownOpen] = useState(false);
  const dateRangeDropdownRef = useRef(null);
  const [timeRange, setTimeRange] = useState("all"); // "all", "7days", "30days", "90days", "custom"
  const [customDateRange, setCustomDateRange] = useState({
    fromDate: new Date(),
    toDate: new Date(),
  });

  // New state for created date range filter
  const [createdDateRangeDropdownOpen, setCreatedDateRangeDropdownOpen] =
    useState(false);
  const createdDateRangeDropdownRef = useRef(null);
  const [createdTimeRange, setCreatedTimeRange] = useState("all"); // "all", "7days", "30days", "90days", "custom"
  const [customCreatedDateRange, setCustomCreatedDateRange] = useState({
    fromDate: new Date(),
    toDate: new Date(),
  });

  // New state for Bulk Assign Modal
  const [isBulkAssignModalOpen, setIsBulkAssignModalOpen] = useState(false);
  const [selectedAssignee, setSelectedAssignee] = useState("");
  const [assigneeSearchTerm, setAssigneeSearchTerm] = useState("");
  const [isAssigneeDropdownOpen, setIsAssigneeDropdownOpen] = useState(false);
  const assigneeDropdownRef = useRef(null);

  // Add state for custom pagination dropdown
  const [isItemsPerPageDropdownOpen, setIsItemsPerPageDropdownOpen] =
    useState(false);
  const itemsPerPageDropdownRef = useRef(null);

  // Helper function to format date for display
  const formatDateForDisplay = (date) => {
    if (!date) return "";
    const d = new Date(date);
    return d.toLocaleDateString("en-GB"); // Adjust locale as needed
  };

  // Helper function to format date in "Jun 23, 2025" format
  const formatDateForTable = (date) => {
    if (!date) return "";
    const d = new Date(date);
    return d.toLocaleDateString("en-US", {
      month: "short",
      day: "numeric",
      year: "numeric",
    });
  };

  // New helper function to format date and time for table display (time above, date below)
  const formatDateTimeForTable = (dateString) => {
    if (!dateString) return "";
    const d = new Date(dateString);
    const time = d.toLocaleTimeString("en-US", {
      hour: "2-digit",
      minute: "2-digit",
      hour12: true,
    });
    const date = d.toLocaleDateString("en-US", {
      month: "short",
      day: "numeric",
      year: "numeric",
    });
    return (
      <div className="flex flex-col">
        <span>{time}</span>
        <span className="text-[10px] text-blue-600">{date}</span>
      </div>
    );
  };

  const { user, rolePermissions } = useAuth();
  const location = useLocation();

  // Extract module name from URL (e.g., 'leads' from '/leads/all')
  const pathParts = location.pathname.split("/").filter(Boolean);
  const moduleNameFromUrl = pathParts[0] ? pathParts[0].toLowerCase() : null;

  // Find permissions for the module from rolePermissions
  const permissionsForLeadsModule = useMemo(() => {
    if (rolePermissions === "ALL") {
      // Grant all positive permissions, do NOT include any inverse permissions
      return ["create", "edit", "delete", "view"];
    }
    if (!moduleNameFromUrl || !Array.isArray(rolePermissions)) return [];
    const found = rolePermissions.find(
      (perm) => perm.module && perm.module.toLowerCase() === moduleNameFromUrl
    );
    return found ? found.permissions : [];
  }, [rolePermissions, moduleNameFromUrl]);

  // Permission checks for bulk assign and CSV
  const hasBulkAssignPermission =
    rolePermissions === "ALL" || !rolePermissions?.includes("noBulkAssign");
  const hasCsvPermission =
    rolePermissions === "ALL" || !rolePermissions?.includes("noCsv");

  // Handler to apply custom date range
  const applyCustomDateRange = () => {
    if (customDateRange.fromDate && customDateRange.toDate) {
      setTimeRange("custom");
      setDateRangeDropdownOpen(false);
    } else {
      Swal.fire({
        icon: "error",
        title: "Invalid Date Range",
        text: "Please select both a start and end date for the custom range.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  const handleBulkActionsSubmit = async () => {
    if (selectedLeads.length === 0) {
      Swal.fire({
        icon: "info",
        title: "No Leads Selected",
        text: "Please select leads to perform bulk actions.",
        confirmButtonColor: "#2798FF",
      });
      return;
    }

    if (
      !bulkDeleteMessage &&
      !bulkDeleteFollowUp &&
      !bulkAssignUser &&
      !bulkChangeStatus
    ) {
      Swal.fire({
        icon: "info",
        title: "No Action Selected",
        text: "Please check an action to perform.",
        confirmButtonColor: "#2798FF",
      });
      return;
    }

    // Validate required selections for each action
    if (bulkAssignUser && !selectedAssignee) {
      Swal.fire({
        icon: "error",
        title: "User Not Selected",
        text: "Please select a user to assign leads to.",
        confirmButtonColor: "#DD6B55",
      });
      return;
    }

    if (bulkChangeStatus && !bulkEditSelectedStatus) {
      Swal.fire({
        icon: "error",
        title: "Status Not Selected",
        text: "Please select a status to change leads to.",
        confirmButtonColor: "#DD6B55",
      });
      return;
    }

    let loadingAlert;
    try {
      loadingAlert = Swal.fire({
        title: `Performing bulk actions for ${selectedLeads.length} leads...`,
        html: "Please wait, this may take a moment.",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      const successfulUpdates = [];
      const failedUpdates = [];

      // Use the current state, but don't rely on it changing mid-function
      const currentLeadsState = [...leads];

      for (const leadId of selectedLeads) {
        try {
          const leadToUpdate = currentLeadsState.find(
            (lead) => lead.customer_id === leadId
          );

          if (!leadToUpdate) {
            failedUpdates.push({ id: leadId, reason: "Lead not found." });
            continue;
          }

          const formDataToSend = new FormData();

          // Append all existing lead data that isn't changing
          safeAppend(
            formDataToSend,
            "customer_name",
            leadToUpdate.customer_name
          );
          safeAppend(formDataToSend, "email", leadToUpdate.email);
          safeAppend(formDataToSend, "contact_number", leadToUpdate.contact);
          safeAppend(formDataToSend, "city", leadToUpdate.city);
          safeAppend(
            formDataToSend,
            "whatsapp_number",
            leadToUpdate.whatsapp_number
          );
          safeAppend(formDataToSend, "requirements", leadToUpdate.requirements);
          safeAppend(formDataToSend, "source", leadToUpdate.source);
          safeAppend(formDataToSend, "status", leadToUpdate.status_name);
          safeAppend(formDataToSend, "status_id", leadToUpdate.status_id);

          // Handle assigned_to field
          let assignedToId = leadToUpdate.assigned_to;
          if (bulkAssignUser && selectedAssignee) {
            // Use the selected assignee
            const userObj = users.find((u) => u.name === selectedAssignee);
            assignedToId = userObj ? userObj.id : "";
          } else if (
            typeof assignedToId === "string" &&
            isNaN(Number(assignedToId))
          ) {
            // Use existing assignee if not changing
            const userObj = users.find((u) => u.name === assignedToId);
            assignedToId = userObj ? userObj.id : "";
          }
          safeAppend(
            formDataToSend,
            "assigned_to",
            parseInt(assignedToId, 10) || 0
          );

          // Handle status field
          let statusToUse = leadToUpdate.status_name;
          let statusIdToUse = leadToUpdate.status_id;
          if (bulkChangeStatus && bulkEditSelectedStatus) {
            statusToUse = bulkEditSelectedStatus.status_name;
            statusIdToUse = bulkEditSelectedStatus.status_id;
          }
          safeAppend(formDataToSend, "status", statusToUse);
          safeAppend(formDataToSend, "status_id", statusIdToUse);

          // Handle delete operations
          safeAppend(
            formDataToSend,
            "message",
            bulkDeleteMessage ? "" : leadToUpdate.message
          );
          safeAppend(
            formDataToSend,
            "follow_up_date",
            bulkDeleteFollowUp ? "" : leadToUpdate.follow_up_date_input
          );
          safeAppend(
            formDataToSend,
            "follow_up_time",
            bulkDeleteFollowUp ? "" : leadToUpdate.follow_up_time_input
          );

          const response = await api.post(
            `/udateleads/${leadId}`,
            formDataToSend,
            { headers: { "Content-Type": "multipart/form-data" } }
          );

          if (response.data.status || response.data.success) {
            successfulUpdates.push(leadId);
          } else {
            failedUpdates.push({
              id: leadId,
              reason: response.data.message || "Unknown error",
            });
          }
        } catch (err) {
          failedUpdates.push({
            id: leadId,
            reason: err.message || "Network error",
          });
        }
      }

      await loadingAlert.close();

      // Show a summary of results
      const actionsPerformed = [];
      if (bulkAssignUser) actionsPerformed.push("User Assignment");
      if (bulkChangeStatus) actionsPerformed.push("Status Change");
      if (bulkDeleteMessage) actionsPerformed.push("Message Deletion");
      if (bulkDeleteFollowUp) actionsPerformed.push("Follow-up Date Deletion");

      await Swal.fire({
        icon: successfulUpdates.length > 0 ? "success" : "error",
        title: "Bulk Actions Complete",
        html: `Successfully updated ${successfulUpdates.length} lead(s).<br/>
        Actions performed: ${actionsPerformed.join(", ")}<br/>${
          failedUpdates.length > 0
            ? `<span class="text-red-500">${failedUpdates.length} lead(s) failed.</span>`
            : ""
        }`,
        confirmButtonColor: "#2798FF",
      });

      // Fetch fresh data once at the end
      await fetchLeads();
    } catch (err) {
      if (loadingAlert) await loadingAlert.close();
      Swal.fire({
        icon: "error",
        title: "Bulk Actions Error",
        text: err.message || "An unexpected error occurred.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  // Handler for predefined time range changes
  const handleTimeRangeChange = (range) => {
    setTimeRange(range);
    setDateRangeDropdownOpen(false);
  };

  // Handler for custom date range input changes
  const handleCustomDateChange = (type, dateString) => {
    setCustomDateRange((prev) => ({
      ...prev,
      [type]: new Date(dateString),
    }));
  };

  // Handler for custom created date range input changes
  const handleCustomCreatedDateChange = (type, dateString) => {
    setCustomCreatedDateRange((prev) => ({
      ...prev,
      [type]: new Date(dateString),
    }));
  };

  // Handler for predefined time range changes for created date
  const handleCreatedTimeRangeChange = (range) => {
    setCreatedTimeRange(range);
    setCreatedDateRangeDropdownOpen(false);
  };

  // Handler to apply custom created date range
  const applyCustomCreatedDateRange = () => {
    if (customCreatedDateRange.fromDate && customCreatedDateRange.toDate) {
      setCreatedTimeRange("custom");
      setCreatedDateRangeDropdownOpen(false);
    } else {
      Swal.fire({
        icon: "error",
        title: "Invalid Date Range",
        text: "Please select both a start and end date for the custom range.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  // Consume SidebarContext
  const { isCollapsed } = useContext(SidebarContext);

  // New state for Import CSV Modal and file upload
  const [isImportModalOpen, setIsImportModalOpen] = useState(false);
  const [selectedFile, setSelectedFile] = useState(null);

  // Search, filter, and pagination state
  const [searchTerm, setSearchTerm] = useState("");
  const [filters, setFilters] = useState({
    customerName: "all",
    city: "all",
    requirements: "all",
    statusId: "all",
    assignedTo: "all",
    followUp: "all",
  });
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10);

  // Checkbox selection state for bulk operations
  const [selectedLeads, setSelectedLeads] = useState([]);

  // New state for dropdown and modal
  const [activeDropdown, setActiveDropdown] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingLead, setEditingLead] = useState(null);
  const [openStatusMenu, setOpenStatusMenu] = useState(null);
  const [formData, setFormData] = useState({
    name: "",
    email: "",
    phoneno: "",
    city: "",
    whatsapp: "",
    requirements: "",
    source: "",
    assigned_to: "",
    follow_up_date_input: "", // Changed from follow_up
    follow_up_time_input: "", // New field for time
    status: "new",
    message: "",
    role: "User",
    is_approved: false,
    profile_pic: null,
    // New address fields
    blockUnitStreetName: "",
    state: "",
    country: "",
    pincode: "",
  });
  const [imagePreview, setImagePreview] = useState(null);

  // For create: separate state
  const [createFormData, setCreateFormData] = useState({
    name: "",
    email: "",
    phoneno: "",
    city: "",
    whatsapp: "",
    requirements: "",
    source: "",
    assigned_to: "",
    follow_up_date_input: "", // Changed from follow_up
    follow_up_time_input: "", // New field for time
    status: "new",
    message: "",
    role: "User",
    is_approved: false,
    profile_pic: null,
    // New address fields
    blockUnitStreetName: "",
    state: "",
    country: "India",
    pincode: "",
  });
  const [createImagePreview, setCreateImagePreview] = useState(null);

  // Add state for users
  const [users, setUsers] = useState([]);

  // Set filters from navigation state (e.g., from Dashboard user card click)
  useEffect(() => {
    if (location.state && users.length > 0) {
      // Assigned To
      let assignedToName = filters.assignedTo;
      if (location.state.assignedTo) {
        const assignedUser = users.find(
          (u) => u.id === location.state.assignedTo
        );
        if (assignedUser) {
          assignedToName = assignedUser.name.toLowerCase();
        }
      }
      // Only update filters if changed
      if (filters.assignedTo !== assignedToName) {
        setFilters({ ...filters, assignedTo: assignedToName });
      }

      // Only update page if not already 1
      if (currentPage !== 1) setCurrentPage(1);

      // Set updated date filter to today, but only if not already set
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayEnd = new Date(
        today.getFullYear(),
        today.getMonth(),
        today.getDate(),
        23,
        59,
        59,
        999
      );
      const fromDate = customUpdatedDateRange?.fromDate;
      const toDate = customUpdatedDateRange?.toDate;
      const isAlreadyToday =
        updatedTimeRange === "custom" &&
        fromDate &&
        toDate &&
        fromDate.getTime() === today.getTime() &&
        toDate.getTime() === todayEnd.getTime();
      if (!isAlreadyToday) {
        setUpdatedTimeRange("custom");
        setCustomUpdatedDateRange({
          fromDate: today,
          toDate: todayEnd,
        });
      }
    }
    // eslint-disable-next-line
  }, [location.state, users]);

  // New state for Country, State, City pickers
  const [countries, setCountries] = useState([]);
  const [states, setStates] = useState([]);
  const [cities, setCities] = useState([]);
  const [selectedCountryObj, setSelectedCountryObj] = useState(null);
  const [selectedStateObj, setSelectedStateObj] = useState(null);
  const [selectedCityObj, setSelectedCityObj] = useState(null);

  const [countrySearchTerm, setCountrySearchTerm] = useState("");
  const [stateSearchTerm, setStateSearchTerm] = useState("");
  const [citySearchTerm, setCitySearchTerm] = useState("");

  const [countryDropdownOpen, setCountryDropdownOpen] = useState(false);
  const [stateDropdownOpen, setStateDropdownOpen] = useState(false);
  const [cityDropdownOpen, setCityDropdownOpen] = useState(false);

  const countryDropdownRef = useRef(null);
  const stateDropdownRef = useRef(null);
  const cityDropdownRef = useRef(null);

  // Add refs for filter dropdowns
  const customerNameDropdownRef = useRef(null);
  const cityFilterDropdownRef = useRef(null); // renamed to avoid conflict
  const assignedToDropdownRef = useRef(null);

  // Add function to fetch users
  const fetchUsers = async () => {
    try {
      const response = await api.get("/userlist");
      if (response.data.success) {
        // Filter users where is_approved is true
        const approvedUsers = response.data.result.filter(
          (user) => user.is_approved
        );
        setUsers(approvedUsers);
      }
    } catch (err) {
      console.error("Error fetching users:", err);
    }
  };

  // Add function to fetch statuses
  const fetchStatuses = async () => {
    try {
      const response = await api.get("/showleadstatus");
      if (response.data.success) {
        setStatuses(response.data.data); // Corrected to use response.data.data
      }
    } catch (err) {
      console.error("Error fetching statuses:", err);
    }
  };

  // Expose fetchLeads for use elsewhere
  const fetchLeads = async () => {
    try {
      setLoading(true);
      const response = await api.get("/showlead");
      if (response.data.success) {
        setLeads(
          Array.isArray(response.data.result) ? response.data.result : []
        );
      } else {
        setError("Failed to fetch leads");
        setLeads([]); // Defensive: set to empty array on error
      }
    } catch (err) {
      setError("Error fetching leads: " + err.message);
      setLeads([]); // Defensive: set to empty array on error
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchLeads();
    fetchUsers();
    fetchStatuses(); // Add this line to fetch statuses
  }, []);

  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth < 768);
      if (window.innerWidth >= 768) {
        setIsSearchExpanded(false);
      }
    };
    checkMobile();
    window.addEventListener("resize", checkMobile);
    return () => window.removeEventListener("resize", checkMobile);
  }, []);

  useEffect(() => {
    const allCountries = Country.getAllCountries();
    setCountries(allCountries);
  }, []);

  // Add useEffect for status dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        statusDropdownRef.current &&
        !statusDropdownRef.current.contains(event.target)
      ) {
        setIsStatusDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for assign to dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        assignToDropdownRef.current &&
        !assignToDropdownRef.current.contains(event.target)
      ) {
        setIsAssignToDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for CSV dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        csvDropdownRef.current &&
        !csvDropdownRef.current.contains(event.target)
      ) {
        setIsCsvDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for date range dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        dateRangeDropdownRef.current &&
        !dateRangeDropdownRef.current.contains(event.target)
      ) {
        setDateRangeDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for created date range dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        createdDateRangeDropdownRef.current &&
        !createdDateRangeDropdownRef.current.contains(event.target)
      ) {
        setCreatedDateRangeDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for assignee dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        assigneeDropdownRef.current &&
        !assigneeDropdownRef.current.contains(event.target)
      ) {
        setIsAssigneeDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for country dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        countryDropdownRef.current &&
        !countryDropdownRef.current.contains(event.target)
      ) {
        setCountryDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for state dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        stateDropdownRef.current &&
        !stateDropdownRef.current.contains(event.target)
      ) {
        setStateDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for city dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        cityDropdownRef.current &&
        !cityDropdownRef.current.contains(event.target)
      ) {
        setCityDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for status dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        editStatusDropdownRef.current &&
        !editStatusDropdownRef.current.contains(event.target)
      ) {
        setIsEditStatusDropdownOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for filter dropdowns click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        activeDropdown === "customerName" &&
        customerNameDropdownRef.current &&
        !customerNameDropdownRef.current.contains(event.target)
      ) {
        setActiveDropdown(null);
      }
      if (
        activeDropdown === "city" &&
        cityFilterDropdownRef.current &&
        !cityFilterDropdownRef.current.contains(event.target)
      ) {
        setActiveDropdown(null);
      }
      if (
        activeDropdown === "statusId" &&
        statusDropdownFilterRef.current &&
        !statusDropdownFilterRef.current.contains(event.target)
      ) {
        setActiveDropdown(null);
      }
      if (
        activeDropdown === "assignedTo" &&
        assignedToDropdownRef.current &&
        !assignedToDropdownRef.current.contains(event.target)
      ) {
        setActiveDropdown(null);
      }
      // Add follow up date range dropdown click outside
      if (
        dateRangeDropdownOpen &&
        followUpDateRangeDropdownRef.current &&
        !followUpDateRangeDropdownRef.current.contains(event.target)
      ) {
        setDateRangeDropdownOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [activeDropdown, dateRangeDropdownOpen]);

  // Add useEffect for custom pagination dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        itemsPerPageDropdownRef.current &&
        !itemsPerPageDropdownRef.current.contains(event.target)
      ) {
        setIsItemsPerPageDropdownOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Filtered lists for country, state, city
  const filteredCountries = useMemo(
    () =>
      countries.filter((country) =>
        country.name.toLowerCase().includes(countrySearchTerm.toLowerCase())
      ),
    [countries, countrySearchTerm]
  );

  const filteredStates = useMemo(
    () =>
      states.filter((state) =>
        state.name.toLowerCase().includes(stateSearchTerm.toLowerCase())
      ),
    [states, stateSearchTerm]
  );

  const filteredCities = useMemo(
    () =>
      cities.filter((city) =>
        city.name.toLowerCase().includes(citySearchTerm.toLowerCase())
      ),
    [cities, citySearchTerm]
  );

  const [updatedDateRangeDropdownOpen, setUpdatedDateRangeDropdownOpen] =
    useState(false);
  const updatedDateRangeDropdownRef = useRef(null);
  const [updatedTimeRange, setUpdatedTimeRange] = useState("all"); // "all", "7days", "30days", "90days", "custom"
  const [customUpdatedDateRange, setCustomUpdatedDateRange] = useState({
    fromDate: new Date(),
    toDate: new Date(),
  });

  // Handler for custom updated date range input changes
  const handleCustomUpdatedDateChange = (type, dateString) => {
    setCustomUpdatedDateRange((prev) => ({
      ...prev,
      [type]: new Date(dateString),
    }));
  };

  // Handler for predefined time range changes for updated date
  const handleUpdatedTimeRangeChange = (range) => {
    setUpdatedTimeRange(range);
    setUpdatedDateRangeDropdownOpen(false);
  };

  // Handler to apply custom updated date range
  const applyCustomUpdatedDateRange = () => {
    if (customUpdatedDateRange.fromDate && customUpdatedDateRange.toDate) {
      setUpdatedTimeRange("custom");
      setUpdatedDateRangeDropdownOpen(false);
    } else {
      Swal.fire({
        icon: "error",
        title: "Invalid Date Range",
        text: "Please select both a start and end date for the custom range.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  // Add useEffect for updated date range dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        updatedDateRangeDropdownRef.current &&
        !updatedDateRangeDropdownRef.current.contains(event.target)
      ) {
        setUpdatedDateRangeDropdownOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Filter leads based on search term and filter criteria
  const filteredLeads = useMemo(
    () =>
      leads.filter((lead) => {
        const searchLower = searchTerm.toLowerCase();

        // Parse the address object if it exists and is a string
        let parsedAddress = null;
        if (lead.city && typeof lead.city === "string") {
          try {
            parsedAddress = JSON.parse(lead.city);
          } catch (e) {
            console.error("Error parsing address JSON:", e);
          }
        } else if (lead.city && typeof lead.city === "object") {
          // If for some reason it's already an object (e.g., from an older API response or direct setting)
          parsedAddress = lead.city;
        }

        // Search across all relevant fields
        const matchesSearch =
          // Basic info
          lead?.customer_name?.toLowerCase()?.includes(searchLower) ||
          lead?.email?.toLowerCase()?.includes(searchLower) ||
          lead?.contact?.toLowerCase()?.includes(searchLower) ||
          // Check parsedAddress properties for search
          parsedAddress?.blockUnitStreetName
            ?.toLowerCase()
            ?.includes(searchLower) ||
          parsedAddress?.city?.toLowerCase()?.includes(searchLower) || // Check city in parsed address
          parsedAddress?.state?.toLowerCase()?.includes(searchLower) ||
          parsedAddress?.country?.toLowerCase()?.includes(searchLower) ||
          parsedAddress?.pincode?.toLowerCase()?.includes(searchLower) ||
          lead?.whatsapp_number?.toLowerCase()?.includes(searchLower) ||
          lead?.requirements?.toLowerCase()?.includes(searchLower) ||
          lead?.status_name?.toLowerCase()?.includes(searchLower) ||
          lead?.assigned_to?.toLowerCase()?.includes(searchLower) ||
          lead?.follow_up_date?.toLowerCase()?.includes(searchLower) ||
          // Status
          lead?.status_name?.toLowerCase()?.includes(searchLower) ||
          // Created date
          lead?.created?.toLowerCase()?.includes(searchLower) ||
          // Customer ID (convert to string for searching)
          String(lead?.customer_id)?.includes(searchLower);

        const matchesCustomerName =
          filters.customerName === "all" ||
          lead?.customer_name
            ?.toLowerCase()
            ?.includes(filters.customerName.toLowerCase());

        const matchesCity =
          filters.city === "all" ||
          parsedAddress?.city
            ?.toLowerCase()
            ?.includes(filters.city.toLowerCase()); // Use parsedAddress.city

        const matchesRequirements =
          filters.requirements === "all" ||
          lead?.requirements
            ?.toLowerCase()
            ?.includes(filters.requirements.toLowerCase());

        const matchesStatus =
          filters.statusId === "all" ||
          String(lead?.status_id) === String(filters.statusId);

        const matchesAssignedTo =
          filters.assignedTo === "all" ||
          lead?.assigned_to?.toLowerCase() === filters.assignedTo.toLowerCase();

        const matchesFollowUp =
          filters.followUp === "all" ||
          lead?.follow_up_date
            ?.toLowerCase()
            ?.includes(filters.followUp.toLowerCase());

        // New logic for date range filtering
        const matchesFollowUpDateRange = () => {
          if (timeRange === "all") return true;
          if (!lead.follow_up_date) return false; // Leads without follow_up_date won't match for specific ranges
          const followUpDate = new Date(lead.follow_up_date);
          const today = new Date();
          today.setHours(0, 0, 0, 0); // Normalize to start of day

          switch (timeRange) {
            case "7days":
              const sevenDaysAgo = new Date(today);
              sevenDaysAgo.setDate(today.getDate() - 7);
              return followUpDate >= sevenDaysAgo && followUpDate <= today;
            case "30days":
              const thirtyDaysAgo = new Date(today);
              thirtyDaysAgo.setDate(today.getDate() - 30);
              return followUpDate >= thirtyDaysAgo && followUpDate <= today;
            case "90days":
              const ninetyDaysAgo = new Date(today);
              ninetyDaysAgo.setDate(today.getDate() - 90);
              return followUpDate >= ninetyDaysAgo && followUpDate <= today;
            case "custom":
              const from = new Date(customDateRange.fromDate);
              from.setHours(0, 0, 0, 0);
              const to = new Date(customDateRange.toDate);
              to.setHours(23, 59, 59, 999);
              return followUpDate >= from && followUpDate <= to;
            default:
              return true;
          }
        };

        // New logic for created date range filtering
        const matchesCreatedDateRange = () => {
          if (!lead.created) return false; // Leads without created date won't match

          // Parse the created date string (format: "YYYY-MM-DD")
          const createdDateParts = lead.created.split("-");
          if (createdDateParts.length !== 3) return false;

          const createdDate = new Date(
            parseInt(createdDateParts[0]), // year
            parseInt(createdDateParts[1]) - 1, // month (0-indexed)
            parseInt(createdDateParts[2]) // day
          );

          const today = new Date();
          today.setHours(0, 0, 0, 0); // Normalize to start of day

          switch (createdTimeRange) {
            case "7days":
              const sevenDaysAgo = new Date(today);
              sevenDaysAgo.setDate(today.getDate() - 7);
              return createdDate >= sevenDaysAgo && createdDate <= today;
            case "30days":
              const thirtyDaysAgo = new Date(today);
              thirtyDaysAgo.setDate(today.getDate() - 30);
              return createdDate >= thirtyDaysAgo && createdDate <= today;
            case "90days":
              const ninetyDaysAgo = new Date(today);
              ninetyDaysAgo.setDate(today.getDate() - 90);
              return createdDate >= ninetyDaysAgo && createdDate <= today;
            case "custom":
              const from = new Date(customCreatedDateRange.fromDate);
              from.setHours(0, 0, 0, 0);
              const to = new Date(customCreatedDateRange.toDate);
              to.setHours(23, 59, 59, 999);
              return createdDate >= from && createdDate <= to;
            case "all":
            default:
              return true;
          }
        };

        // New logic for updated date range filtering
        const matchesUpdatedDateRange = () => {
          if (!lead.updated) return false; // Leads without updated date won't match

          // Parse the updated date string (format: "YYYY-MM-DD HH:MM:SS")
          let updatedDateObj;
          if (lead.updated.includes("-")) {
            // Try to parse as ISO or MySQL datetime
            updatedDateObj = new Date(lead.updated.replace(/-/g, "/"));
            if (isNaN(updatedDateObj.getTime())) {
              // fallback: try Date(lead.updated)
              updatedDateObj = new Date(lead.updated);
            }
          } else {
            updatedDateObj = new Date(lead.updated);
          }
          if (isNaN(updatedDateObj.getTime())) return false;

          const today = new Date();
          today.setHours(0, 0, 0, 0); // Normalize to start of day

          switch (updatedTimeRange) {
            case "7days": {
              const sevenDaysAgo = new Date(today);
              sevenDaysAgo.setDate(today.getDate() - 7);
              return updatedDateObj >= sevenDaysAgo && updatedDateObj <= today;
            }
            case "30days": {
              const thirtyDaysAgo = new Date(today);
              thirtyDaysAgo.setDate(today.getDate() - 30);
              return updatedDateObj >= thirtyDaysAgo && updatedDateObj <= today;
            }
            case "90days": {
              const ninetyDaysAgo = new Date(today);
              ninetyDaysAgo.setDate(today.getDate() - 90);
              return updatedDateObj >= ninetyDaysAgo && updatedDateObj <= today;
            }
            case "custom": {
              const from = new Date(customUpdatedDateRange.fromDate);
              from.setHours(0, 0, 0, 0);
              const to = new Date(customUpdatedDateRange.toDate);
              to.setHours(23, 59, 59, 999);
              return updatedDateObj >= from && updatedDateObj <= to;
            }
            case "all":
            default:
              return true;
          }
        };

        return (
          matchesSearch &&
          matchesCustomerName &&
          matchesCity &&
          matchesRequirements &&
          matchesStatus &&
          matchesAssignedTo &&
          matchesFollowUp &&
          matchesFollowUpDateRange() &&
          matchesCreatedDateRange() &&
          matchesUpdatedDateRange() // <-- add this
        );
      }),
    [
      leads,
      searchTerm,
      filters,
      timeRange,
      customDateRange,
      createdTimeRange,
      customCreatedDateRange,
      updatedTimeRange,
      customUpdatedDateRange,
    ]
  );

  // Open create modal: reset createFormData
  const openCreateModal = () => {
    setEditingLead(null);
    // Find India country object
    const india = countries.find((c) => c.name === "India");
    setCreateFormData({
      name: "",
      email: "",
      phoneno: "",
      city: "",
      whatsapp: "",
      requirements: "",
      source: "",
      assigned_to: "",
      follow_up_date_input: "", // Initialize with empty string
      follow_up_time_input: "", // Initialize with empty string
      status: "new",
      message: "",
      role: "User",
      is_approved: false,
      profile_pic: null,
      // New address fields
      blockUnitStreetName: "",
      state: "",
      country: "India",
      pincode: "",
    });
    if (india) {
      setSelectedCountryObj(india);
      setStates(State.getStatesOfCountry(india.isoCode));
      setSelectedStateObj(null);
      setSelectedCityObj(null);
      setCities([]);
      setCountrySearchTerm("India");
      setStateSearchTerm("");
      setCitySearchTerm("");
    } else {
      setSelectedCountryObj(null);
      setStates([]);
      setSelectedStateObj(null);
      setSelectedCityObj(null);
      setCities([]);
      setCountrySearchTerm("");
      setStateSearchTerm("");
      setCitySearchTerm("");
    }
    setIsModalOpenCreate(true);
  };

  // Helper function for form validation
  const validateFormData = (data) => {
    const errors = [];

    if (!data.name || data.name.trim() === "") {
      errors.push("Lead Name is required.");
    }
    if (!data.phoneno || data.phoneno.trim() === "") {
      errors.push("Contact is required.");
    }
    return errors;
  };

  // Function to handle submission of the Create Lead form:
  const handleCreateSubmit = async (e) => {
    e.preventDefault();

    const validationErrors = validateFormData(createFormData);
    if (validationErrors.length > 0) {
      Swal.fire({
        icon: "error",
        title: "Validation Error",
        html: validationErrors.map((err) => `<div>${err}</div>`).join(""),
        confirmButtonColor: "#DD6B55",
      });
      return;
    }

    let loadingAlert;

    try {
      const formData = new FormData();

      // --- FIX: Convert assigned_to (name) to user ID (int) ---
      let assignedToId = createFormData.assigned_to;
      // REMOVE: Validation for assigned_to user
      if (user?.role === "admin") {
        const assignedUser = users.find(
          (u) => u.name === createFormData.assigned_to
        );
        // If not found, just leave as is (no error)
        assignedToId = assignedUser ? assignedUser.id : "";
      } else {
        assignedToId = user.id;
      }

      // Find the selected status object from statuses array
      const selectedStatus = statuses.find(
        (status) =>
          status.status_name.toLowerCase().replace(/\s+/g, "_") ===
          createFormData.status
      );
      // REMOVE: Validation for status
      // If not found, just leave as is (no error)

      // Define the address object
      const addressObject = {
        name: createFormData.blockUnitStreetName,
        city: createFormData.city,
        state: createFormData.state,
        country: createFormData.country,
        pin: createFormData.pincode,
      };
      // If all address fields are empty (or country is default 'India'), send empty string
      const isAddressEmpty =
        !addressObject.name &&
        !addressObject.city &&
        !addressObject.state &&
        (!addressObject.country || addressObject.country === "India") &&
        !addressObject.pin;

      // Combine follow_up_date_input and follow_up_time_input
      let combinedFollowUpDate = null;
      if (createFormData.follow_up_date_input) {
        const datePart = createFormData.follow_up_date_input;
        const timePart = createFormData.follow_up_time_input
          ? createFormData.follow_up_time_input + ":00"
          : createFormData.follow_up_time_input;
        combinedFollowUpDate = `${datePart} ${timePart}`;
      }

      // Format the data to match API keys
      const formattedData = {
        customer_name: createFormData.name,
        email: createFormData.email,
        contact_number: createFormData.phoneno,
        whatsapp_number: createFormData.whatsapp,
        requirements: createFormData.requirements,
        source: createFormData.source,
        assigned_to:
          assignedToId && !isNaN(parseInt(assignedToId, 10))
            ? parseInt(assignedToId, 10)
            : 0,
        follow_up_date: combinedFollowUpDate, // Use the combined date and time
        status: selectedStatus ? selectedStatus.status_name : "",
        status_id: selectedStatus ? selectedStatus.status_id : "",
        message: createFormData.message,
        profile_image: createFormData.profile_pic,
        city: isAddressEmpty ? "" : JSON.stringify(addressObject), // Send empty string if address is empty
      };

      // If not admin, force assigned_to to user.id
      if (user?.role !== "admin") {
        formattedData.assigned_to = user.id;
      }
      // Ensure assigned_to is always an integer
      formattedData.assigned_to = parseInt(formattedData.assigned_to, 10);

      // Append all formatted fields
      Object.keys(formattedData).forEach((key) => {
        if (key === "profile_image" && formattedData[key]) {
          formData.append("profile_image", formattedData[key]);
        } else if (
          formattedData[key] !== null &&
          formattedData[key] !== undefined
        ) {
          // If value is null or undefined, send empty string instead
          formData.append(
            key,
            formattedData[key] === null ? "" : formattedData[key]
          );
        }
      });

      // Show loading state
      loadingAlert = Swal.fire({
        title: "Creating Lead...",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      const response = await api.post("/addlead", formData, {
        headers: {
          "Content-Type": "multipart/form-data",
        },
      });

      if (response.data.status || response.data.success) {
        const newLead = response.data.data;
        setLeads((prev) =>
          Array.isArray(prev) ? [...prev, newLead] : [newLead]
        );
        setIsModalOpenCreate(false);

        await loadingAlert.close();

        await Swal.fire({
          icon: "success",
          title: "Shop Owners Created Successfully",
          text: response.data.message || `Lead has been added to the system.`,
          confirmButtonColor: "#2798FF",
        });
        // Fetch leads again instead of reloading the page
        await fetchLeads();

        setCreateFormData({
          name: "",
          email: "",
          phoneno: "",
          city: "",
          whatsapp: "",
          requirements: "",
          source: "",
          assigned_to: "",
          follow_up_date_input: "", // Changed from follow_up
          follow_up_time_input: "", // New field for time
          status: "new",
          message: "",
          role: "User",
          is_approved: false,
          profile_pic: null,
          // New address fields
          blockUnitStreetName: "",
          state: "",
          country: "India",
          pincode: "",
        });
        if (createImagePreview) {
          URL.revokeObjectURL(createImagePreview);
        }
        setCreateImagePreview(null);

        // Clear address fields
        clearAddressFields();
      } else {
        throw new Error("Failed to create lead");
      }
    } catch (err) {
      if (loadingAlert) {
        await loadingAlert.close();
      }

      let errorTitle = "Error Creating Lead";
      let errorMessage =
        err.response && err.response.data && err.response.data.message
          ? err.response.data.message
          : "An error occurred while creating the lead. Please try again.";

      if (err.response) {
        if (err.response.status === 422) {
          const errors = err.response.data.errors;
          if (errors) {
            const firstError = Object.values(errors)[0];
            if (Array.isArray(firstError) && firstError.length > 0) {
              errorMessage = firstError[0];
            }
          }
        } else if (err.response.data?.message) {
          errorMessage = err.response.data.message;
        }
      } else if (err.request) {
        errorTitle = "Network Error";
        errorMessage =
          "Unable to connect to the server. Please check your internet connection.";
      } else {
        errorMessage = err.message;
      }

      await Swal.fire({
        icon: "error",
        title: errorTitle,
        text: errorMessage,
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  // New handler for file selection (drag/drop or input)
  const handleFileChange = (e) => {
    const file = e.target.files ? e.target.files[0] : e.dataTransfer.files[0];
    if (!file) {
      setSelectedFile(null);
      return;
    }

    if (importFileType === "csv") {
      // Accept only .csv files
      if (
        file.name.toLowerCase().endsWith(".csv") &&
        (file.type === "text/csv" ||
          file.type === "application/vnd.ms-excel" ||
          file.type === "")
      ) {
        setSelectedFile(file);
      } else {
        Swal.fire({
          icon: "error",
          title: "Invalid File Type",
          text: "Please upload a CSV file.",
          confirmButtonColor: "#DD6B55",
        });
        setSelectedFile(null);
      }
    } else if (importFileType === "xls") {
      // Accept only .xls or .xlsx files
      if (
        file.name.toLowerCase().endsWith(".xls") ||
        file.name.toLowerCase().endsWith(".xlsx")
      ) {
        setSelectedFile(file);
      } else {
        Swal.fire({
          icon: "error",
          title: "Invalid File Type",
          text: "Please upload an XLS or XLSX file.",
          confirmButtonColor: "#DD6B55",
        });
        setSelectedFile(null);
      }
    }
  };

  // Function to handle the actual CSV file upload
  const uploadCsvFile = async () => {
    if (!selectedFile) {
      Swal.fire({
        icon: "error",
        title: "No File Selected",
        text: "Please select a file to import.",
        confirmButtonColor: "#DD6B55",
      });
      return;
    }

    setIsImportModalOpen(false);
    let loadingAlert;
    try {
      loadingAlert = Swal.fire({
        title: `Importing Leads from ${importFileType.toUpperCase()}...`,
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      const formData = new FormData();
      formData.append(
        importFileType === "csv" ? "csv_file" : "file",
        selectedFile
      );

      let response;
      if (importFileType === "xls") {
        // Use the XLS import API
        response = await api.post("/import-xls", formData, {
          headers: {
            "Content-Type": "multipart/form-data",
          },
        });
      } else {
        // Default to CSV import API
        response = await api.post("/leads-import", formData, {
          headers: {
            "Content-Type": "multipart/form-data",
          },
        });
      }

      await loadingAlert.close();
      if (response.data.success) {
        // Prepare duplicate info
        const imported = response.data.imported || 0;
        const duplicateSkipped = response.data.duplicate_skipped || 0;
        const duplicateRecords =
          response.data.duplicate_records || response.data.dup_records || [];
        // Only show these fields in the table
        const displayFields = [
          "customer_name",
          "email",
          "contact_number",
          "city",
          "whatsapp_number",

        ];
        // If records are objects, get keys for table header
        let tableHeaders = [];
        if (
          duplicateRecords.length > 0 &&
          typeof duplicateRecords[0] === "object"
        ) {
          tableHeaders = Object.keys(duplicateRecords[0]);
        }
        // Table HTML (only displayFields)
        let duplicateTableHtml = "";
        if (duplicateRecords.length > 0) {
          const visibleHeaders = displayFields.filter((h) =>
            tableHeaders.includes(h)
          );
          duplicateTableHtml = `
            <div style="max-height:250px;overflow:auto;border:1px solid #eee;margin-top:10px;margin-bottom:10px;">
              <table style="width:100%;border-collapse:collapse;font-size:10px;">
                <thead>
                  <tr>
                    ${visibleHeaders
                      .map(
                        (h) =>
                          `<th style='border:1px solid #eee;padding:2px;background:#f8f8f8;'>${h}</th>`
                      )
                      .join("")}
                  </tr>
                </thead>
                <tbody>
                  ${duplicateRecords
                    .map(
                      (row) =>
                        `<tr>${visibleHeaders
                          .map(
                            (h) =>
                              `<td style='border:1px solid #eee;padding:2px;'>${
                                row[h] ?? ""
                              }</td>`
                          )
                          .join("")}</tr>`
                    )
                    .join("")}
                </tbody>
              </table>
            </div>
            <button id="copy-duplicates-btn" style="margin-bottom:10px;padding:6px 12px;background:#2798FF;color:#fff;border:none;border-radius:4px;cursor:pointer;">Copy Table to Clipboard (CSV)</button>
          `;
        }
        // Main HTML
        const html = `
          <div style='text-align:left;'>
            <div><b>Imported:</b> ${imported}</div>
            <div><b>Duplicates Skipped:</b> ${duplicateSkipped}</div>
            ${
              duplicateRecords.length > 0
                ? `<div style='margin-top:10px;'><b>Duplicate Records:</b>${duplicateTableHtml}</div>`
                : ""
            }
          </div>
        `;
        await Swal.fire({
          icon: "success",
          title: "Import Result",
          html,
          confirmButtonColor: "#2798FF",
          didOpen: () => {
            if (duplicateRecords.length > 0) {
              const btn = document.getElementById("copy-duplicates-btn");
              if (btn) {
                btn.onclick = () => {
                  // Convert table to CSV for clipboard (all fields)
                  const csv = [
                    tableHeaders.join(","),
                    ...duplicateRecords.map((row) =>
                      tableHeaders
                        .map(
                          (h) =>
                            `"${(row[h] ?? "").toString().replace(/"/g, '""')}"`
                        )
                        .join(",")
                    ),
                  ].join("\n");
                  copyToClipboard(csv);
                };
              }
            }
          },
        });
        // Refresh leads after import
        const refreshResponse = await api.get("/showlead");
        if (refreshResponse.data.success) {
          setLeads(
            Array.isArray(refreshResponse.data.result)
              ? refreshResponse.data.result
              : []
          );
        } else {
          setLeads([]);
        }
      } else {
        throw new Error(response.data.message || "Failed to import leads.");
      }
    } catch (err) {
      if (loadingAlert) {
        await loadingAlert.close();
      }
      Swal.fire({
        icon: "error",
        title: "Import Failed",
        text: err.message || "An error occurred during import.",
        confirmButtonColor: "#DD6B55",
      });
    }
    setSelectedFile(null); // Clear the selected file
  };
  // Add handlers for CSV import and export
  const handleImportCsv = () => {
    setSelectedFile(null); // Clear any previously selected file
    setIsImportModalOpen(true);
  };

  const handleExportCsv = async () => {
    setIsCsvDropdownOpen(false);
    let loadingAlert;
    try {
      loadingAlert = Swal.fire({
        title: `Exporting Leads as ${exportFileType.toUpperCase()}...`,
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      let response;
      if (exportFileType === "xls") {
        // Use the XLS export API
        response = await api.get("/export-xls", {
          responseType: "blob",
        });
      } else {
        // Default to CSV export API
        response = await api.get("/leads-export", {
          responseType: "blob",
        });
      }

      await loadingAlert.close();
      if (response.data) {
        const url = window.URL.createObjectURL(new Blob([response.data]));
        const link = document.createElement("a");
        link.href = url;
        link.setAttribute(
          "download",
          exportFileType === "csv" ? "leads.csv" : "leads.xls"
        );
        document.body.appendChild(link);
        link.click();
        link.parentNode.removeChild(link);
        await Swal.fire({
          icon: "success",
          title: "Export Successful!",
          text: `Leads exported to ${
            exportFileType === "csv" ? "leads.csv" : "leads.xls"
          }.`,
          confirmButtonColor: "#2798FF",
        });
      } else {
        throw new Error("Failed to export leads: No data received.");
      }
    } catch (err) {
      if (loadingAlert) {
        await loadingAlert.close();
      }
      Swal.fire({
        icon: "error",
        title: "Export Failed",
        text: err.message || "An error occurred during export.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  const handleDownloadSample = async () => {
    let loadingAlert;
    try {
      loadingAlert = Swal.fire({
        title: "Downloading Sample...",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      const response = await api.get("/leads-sample-download", {
        responseType: "blob", // Important for file downloads
      });

      await loadingAlert.close();

      if (response.data) {
        const url = window.URL.createObjectURL(new Blob([response.data]));
        const link = document.createElement("a");
        link.href = url;
        link.setAttribute("download", "sample_leads.csv");
        document.body.appendChild(link);
        link.click();
        link.parentNode.removeChild(link);
        await Swal.fire({
          icon: "success",
          title: "Download Successful!",
          text: "Sample leads CSV downloaded.",
          confirmButtonColor: "#2798FF",
        });
      } else {
        throw new Error("Failed to download sample: No data received.");
      }
    } catch (err) {
      if (loadingAlert) {
        await loadingAlert.close();
      }
      Swal.fire({
        icon: "error",
        title: "Download Failed",
        text: err.message || "An error occurred during download.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  // Calculate pagination
  const totalPages = Math.ceil(filteredLeads.length / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const currentLeads = filteredLeads.slice(startIndex, endIndex);

  // Reset to first page when search term or filters change
  useEffect(() => {
    setCurrentPage(1);
  }, [searchTerm, filters]);

  const handleSearchToggle = () => {
    setIsSearchExpanded(!isSearchExpanded);
  };

  const handleSearchBlur = () => {
    if (isMobile) {
      setIsSearchExpanded(false);
    }
  };

  const handleSearchChange = (e) => {
    setSearchTerm(e.target.value);
  };

  const handlePreviousPage = () => {
    if (currentPage > 1) {
      setCurrentPage(currentPage - 1);
    }
  };

  const handleNextPage = () => {
    if (currentPage < totalPages) {
      setCurrentPage(currentPage + 1);
    }
  };

  const handleItemsPerPageChange = (newItemsPerPage) => {
    setItemsPerPage(newItemsPerPage);
    setCurrentPage(1);
  };

  // Checkbox handlers for bulk selection
  const toggleLeadSelection = (leadId) => {
    setSelectedLeads((prev) =>
      prev.includes(leadId)
        ? prev.filter((id) => id !== leadId)
        : [...prev, leadId]
    );
  };

  const toggleSelectAll = () => {
    if (selectedLeads.length === currentLeads.length) {
      setSelectedLeads([]);
    } else {
      setSelectedLeads(currentLeads.map((lead) => lead.customer_id));
    }
  };

  const handleBulkDelete = async () => {
    const result = await Swal.fire({
      title: "Are you sure?",
      text: `You are about to delete ${selectedLeads.length} lead(s). This cannot be undone.`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#DD6B55",
      cancelButtonColor: "#aaa",
      confirmButtonText: "Yes, delete them!",
    });
    if (result.isConfirmed) {
      try {
        // Simulate bulk delete API call; adjust based on actual API
        await Promise.all(
          selectedLeads.map((id) => api.delete(`/deletelead/${id}`))
        );
        setLeads((prev) =>
          Array.isArray(prev)
            ? prev.filter((lead) => !selectedLeads.includes(lead.customer_id))
            : []
        );
        setSelectedLeads([]);
        await Swal.fire({
          icon: "success",
          title: " Deleted!",
          text: "Selected leads have been removed.",
          confirmButtonColor: "#2798FF",
        });
      } catch (err) {
        Swal.fire({
          icon: "error",
          title: "Bulk Delete Failed",
          text: err.message || "An error occurred during deletion.",
          confirmButtonColor: "#DD6B55",
        });
      }
    }
  };

  // Filter handlers
  const handleFilterChange = (filterName, value) => {
    setFilters((prev) => ({
      ...prev,
      [filterName]: value,
    }));
    setCurrentPage(1);
  };

  // New handlers for dropdown and modal
  const toggleDropdown = (userId) => {
    setActiveDropdown(activeDropdown === userId ? null : userId);

    // If we're opening the dropdown, scroll it into view
    if (activeDropdown !== userId) {
      // Use setTimeout to ensure the dropdown is rendered before scrolling
      setTimeout(() => {
        const dropdownElement = document.querySelector(
          `[data-dropdown-id="${userId}"]`
        );
        if (dropdownElement) {
          dropdownElement.scrollIntoView({
            behavior: "smooth",
            block: "nearest",
          });
        }
      }, 0);
    }
  };

  const handleEdit = (lead) => {
    setEditingLead(lead);

    // Reset country-state-city related states
    setSelectedCountryObj(null);
    setSelectedStateObj(null);
    setSelectedCityObj(null);
    setCountries(Country.getAllCountries()); // Re-fetch all countries
    setStates([]);
    setCities([]);
    setCountrySearchTerm("");
    setStateSearchTerm("");
    setCitySearchTerm("");

    // Parse the address from lead.city (which contains the full address as JSON)
    let blockUnitStreetName = "";
    let stateName = "";
    let countryName = "";
    let pincode = "";
    let cityName = "";

    let parsedAddress = null;
    if (lead.city && typeof lead.city === "string") {
      try {
        parsedAddress = JSON.parse(lead.city);
      } catch (e) {
        console.error("Error parsing lead.city JSON:", e);
      }
    } else if (lead.city && typeof lead.city === "object") {
      // If it's already an object (e.g., from an older API response or direct setting)
      parsedAddress = lead.city;
    }

    if (parsedAddress) {
      blockUnitStreetName = parsedAddress.name || "";
      cityName = parsedAddress.city || "";
      stateName = parsedAddress.state || "";
      countryName = parsedAddress.country || "";
      pincode = parsedAddress.pin || "";
    }

    // Parse follow_up_date into date and time components
    let followUpDate = "";
    let followUpTime = "";
    if (lead.follow_up_date) {
      const dateObj = new Date(lead.follow_up_date);
      followUpDate = dateObj.toLocaleDateString("en-CA", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
      }); // YYYY-MM-DD
      followUpTime = dateObj.toLocaleTimeString("en-US", {
        hour: "2-digit",
        minute: "2-digit",
        hour12: false,
      }); // HH:MM
    }

    setFormData({
      name: lead.customer_name,
      email: lead.email,
      phoneno: lead.contact,
      city: cityName, // Set the actual city name here
      whatsapp: lead.whatsapp_number,
      requirements: lead.requirements,
      source: lead.source,
      assigned_to: lead.assigned_to, // Now storing the name directly
      follow_up_date_input: followUpDate, // Set parsed date
      follow_up_time_input: followUpTime, // Set parsed time
      status: lead.status_name.toLowerCase().replace(/\s+/g, "_"),
      message: lead.message || "",
      role: lead.role || "User",
      is_approved: lead.is_approved,
      profile_pic: null,
      blockUnitStreetName: blockUnitStreetName,
      state: stateName,
      country: countryName,
      pincode: pincode,
    });
    setImagePreview(lead.profile_pic || null);
    setIsModalOpen(true);
    setActiveDropdown(null);

    // Also need to set selectedCountryObj and selectedStateObj for the dropdowns to work correctly on edit
    if (countryName) {
      const countryObj = Country.getAllCountries().find(
        (c) => c.name === countryName
      );
      if (countryObj) {
        setSelectedCountryObj(countryObj);
        setStates(State.getStatesOfCountry(countryObj.isoCode));
        setCountrySearchTerm(countryName); // Set search term so input shows name

        if (stateName) {
          const stateObj = State.getStatesOfCountry(countryObj.isoCode).find(
            (s) => s.name === stateName
          );
          if (stateObj) {
            setSelectedStateObj(stateObj);
            setCities(
              City.getCitiesOfState(stateObj.countryCode, stateObj.isoCode)
            );
            setStateSearchTerm(stateName); // Set search term so input shows name

            if (cityName) {
              const cityObj = City.getCitiesOfState(
                stateObj.countryCode,
                stateObj.isoCode
              ).find((c) => c.name === cityName);
              if (cityObj) {
                setSelectedCityObj(cityObj);
                setCitySearchTerm(cityName); // Set search term so input shows name
              }
            }
          }
        }
      }
    }

    // 1. Add state to track the index of the currently edited lead in filteredLeads
    const idx = filteredLeads.findIndex(
      (l) => l.customer_id === lead.customer_id
    );
    setEditingLeadIndex(idx);
  };

  const handleInputChange = (e) => {
    const { name, value, files } = e.target;
    if (name === "profile_pic") {
      const file = files[0];
      if (file) {
        setFormData((prev) => ({
          ...prev,
          profile_pic: file,
        }));
        if (imagePreview) {
          URL.revokeObjectURL(imagePreview);
        }
        setImagePreview(URL.createObjectURL(file));
      }
    } else {
      setFormData((prev) => ({
        ...prev,
        [name]: value,
      }));
    }
  };

  const handleCreateInputChange = (e) => {
    const { name, value } = e.target;
    setCreateFormData((prev) => ({
      ...prev,
      [name]: value,
    }));
  };

  // Add this function after handleCreateInputChange
  const handleProfilePictureChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      setCreateFormData((prev) => ({
        ...prev,
        profile_pic: file,
      }));
      if (createImagePreview) {
        URL.revokeObjectURL(createImagePreview);
      }
      setCreateImagePreview(URL.createObjectURL(file));
    }
  };

  // Handlers for Country, State, City pickers
  const handleCountrySearchChange = (e) => {
    const value = e.target.value;
    setCountrySearchTerm(value);
    setCountryDropdownOpen(true);

    // Clear dependent selections if country changes
    if (value === "") {
      setSelectedStateObj(null);
      setSelectedCityObj(null);
      setStates([]);
      setCities([]);
      setStateSearchTerm("");
      setCitySearchTerm("");
      setFormData((prev) => ({ ...prev, country: "", state: "", city: "" }));
      setCreateFormData((prev) => ({
        ...prev,
        country: "",
        state: "",
        city: "",
      }));
    }
  };

  const handleCountryClear = () => {
    setSelectedCountryObj(null);
    setSelectedStateObj(null);
    setSelectedCityObj(null);
    setStates([]);
    setCities([]);
    setCountrySearchTerm("");
    setStateSearchTerm("");
    setCitySearchTerm("");
    setFormData((prev) => ({ ...prev, country: "", state: "", city: "" }));
    setCreateFormData((prev) => ({
      ...prev,
      country: "",
      state: "",
      city: "",
    }));
  };

  const handleCountrySelect = (country) => {
    setSelectedCountryObj(country);
    setCountrySearchTerm(country.name);
    setCountryDropdownOpen(false);
    setStates(State.getStatesOfCountry(country.isoCode));

    // Clear dependent selections
    setSelectedStateObj(null);
    setSelectedCityObj(null);
    setCities([]);
    setStateSearchTerm("");
    setCitySearchTerm("");

    setFormData((prev) => ({
      ...prev,
      country: country.name,
      state: "",
      city: "",
    }));
    setCreateFormData((prev) => ({
      ...prev,
      country: country.name,
      state: "",
      city: "",
    }));
  };

  const handleStateSearchChange = (e) => {
    // Prevent state search if no country is selected
    if (!countrySearchTerm) {
      return;
    }

    const value = e.target.value;
    setStateSearchTerm(value);
    setStateDropdownOpen(true);

    // Clear dependent selections if state changes
    if (value === "") {
      setSelectedCityObj(null);
      setCities([]);
      setCitySearchTerm("");
      setFormData((prev) => ({ ...prev, state: "", city: "" }));
      setCreateFormData((prev) => ({ ...prev, state: "", city: "" }));
    }
  };

  const handleStateSelect = (state) => {
    setSelectedStateObj(state);
    setStateSearchTerm(state.name);
    setStateDropdownOpen(false);
    setCities(City.getCitiesOfState(state.countryCode, state.isoCode));

    // Clear dependent selections
    setSelectedCityObj(null);
    setCitySearchTerm("");

    setFormData((prev) => ({ ...prev, state: state.name, city: "" }));
    setCreateFormData((prev) => ({ ...prev, state: state.name, city: "" }));
  };

  const handleStateClear = () => {
    setSelectedStateObj(null);
    setSelectedCityObj(null);
    setCities([]);
    setStateSearchTerm("");
    setCitySearchTerm("");
    setFormData((prev) => ({ ...prev, state: "", city: "" }));
    setCreateFormData((prev) => ({ ...prev, state: "", city: "" }));
  };

  const handleCitySearchChange = (e) => {
    // Prevent city search if no state is selected
    if (!stateSearchTerm) {
      return;
    }

    const value = e.target.value;
    setCitySearchTerm(value);
    setCityDropdownOpen(true);

    if (value === "") {
      setFormData((prev) => ({ ...prev, city: "" }));
      setCreateFormData((prev) => ({ ...prev, city: "" }));
    }
  };

  const handleCitySelect = (city) => {
    setSelectedCityObj(city);
    setCitySearchTerm(city.name);
    setCityDropdownOpen(false);
    setFormData((prev) => ({ ...prev, city: city.name }));
    setCreateFormData((prev) => ({ ...prev, city: city.name }));
  };

  const handleCityClear = () => {
    setSelectedCityObj(null);
    setCitySearchTerm("");
    setFormData((prev) => ({ ...prev, city: "" }));
    setCreateFormData((prev) => ({ ...prev, city: "" }));
  };

  // Helper function to clear address fields
  const clearAddressFields = () => {
    setSelectedCountryObj(null);
    setSelectedStateObj(null);
    setSelectedCityObj(null);
    setStates([]);
    setCities([]);
    setCountrySearchTerm("");
    setStateSearchTerm("");
    setCitySearchTerm("");
    setCountryDropdownOpen(false);
    setStateDropdownOpen(false);
    setCityDropdownOpen(false);
  };

  // Helper for safe FormData appending (null/undefined -> "")
  const safeAppend = (formData, key, value) => {
    formData.append(key, value === null || value === undefined ? "" : value);
  };

  // Handle Bulk Assign
  const handleBulkAssign = async () => {
    if (selectedLeads.length === 0 || !selectedAssignee) {
      Swal.fire({
        icon: "error",
        title: "Selection Error",
        text: "Please select leads and an assignee to proceed.",
        confirmButtonColor: "#DD6B55",
      });
      return;
    }

    const assignedToUser = users.find((user) => user.name === selectedAssignee);

    if (!assignedToUser) {
      Swal.fire({
        icon: "error",
        title: "User Not Found",
        text: "Selected assignee not found in the user list.",
        confirmButtonColor: "#DD6B55",
      });
      return;
    }

    const assigneeId = assignedToUser.id;

    // Do not close the modal here; let the user close it manually

    let loadingAlert;
    try {
      loadingAlert = Swal.fire({
        title: `Assigning ${selectedLeads.length} Leads...`,
        html: "Please wait, this may take a moment.",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      const successfulAssignments = [];
      const failedAssignments = [];

      for (const leadId of selectedLeads) {
        try {
          const leadToUpdate = leads.find(
            (lead) => lead.customer_id === leadId
          );
          if (!leadToUpdate) {
            failedAssignments.push({
              id: leadId,
              reason: "Lead not found locally.",
            });
            continue;
          }

          const formDataToSend = new FormData();
          safeAppend(
            formDataToSend,
            "customer_name",
            leadToUpdate.customer_name
          );
          safeAppend(formDataToSend, "email", leadToUpdate.email);
          safeAppend(formDataToSend, "contact_number", leadToUpdate.contact);
          safeAppend(formDataToSend, "city", leadToUpdate.city);
          safeAppend(
            formDataToSend,
            "whatsapp_number",
            leadToUpdate.whatsapp_number
          );
          safeAppend(formDataToSend, "requirements", leadToUpdate.requirements);
          safeAppend(formDataToSend, "source", leadToUpdate.source);
          safeAppend(
            formDataToSend,
            "follow_up_date",
            leadToUpdate.follow_up_date_input
          );
          safeAppend(
            formDataToSend,
            "follow_up_time",
            leadToUpdate.follow_up_time_input
          );
          safeAppend(formDataToSend, "status", leadToUpdate.status_name);
          safeAppend(formDataToSend, "status_id", leadToUpdate.status_id);
          safeAppend(formDataToSend, "message", leadToUpdate.message);
          safeAppend(formDataToSend, "assigned_to", assigneeId);

          const response = await api.post(
            `/udateleads/${leadId}`,
            formDataToSend,
            {
              headers: {
                "Content-Type": "multipart/form-data",
              },
            }
          );

          if (response.data.status || response.data.success) {
            successfulAssignments.push(leadId);
          } else {
            failedAssignments.push({
              id: leadId,
              reason: response.data.message || "Unknown error",
            });
          }
        } catch (err) {
          failedAssignments.push({
            id: leadId,
            reason: err.message || "Network error",
          });
        }
      }

      await loadingAlert.close();

      if (successfulAssignments.length > 0) {
        await Swal.fire({
          icon: "success",
          title: "Bulk Assignment Complete!",
          html: `Successfully assigned ${
            successfulAssignments.length
          } lead(s).<br/>${
            failedAssignments.length > 0
              ? `<span class="text-red-500">${failedAssignments.length} lead(s) failed to assign.</span>`
              : ""
          }`,
          confirmButtonColor: "#2798FF",
        });
      } else if (failedAssignments.length > 0) {
        await Swal.fire({
          icon: "error",
          title: "Bulk Assignment Failed",
          html: `Failed to assign all leads. ${failedAssignments.length} lead(s) encountered errors.`, // You might show more details here if needed
          confirmButtonColor: "#DD6B55",
        });
      } else {
        // Should not happen if selectedLeads is not empty
        await Swal.fire({
          icon: "info",
          title: "No Leads Assigned",
          text: "No leads were assigned.",
          confirmButtonColor: "#DD6B55",
        });
      }

      // Refresh leads and reset state
      const refreshResponse = await api.get("/showlead");
      if (refreshResponse.data.success) {
        setLeads(
          Array.isArray(refreshResponse.data.result)
            ? refreshResponse.data.result
            : []
        );
      } else {
        setLeads([]);
      }
      setSelectedAssignee("");
      setAssigneeSearchTerm("");
    } catch (err) {
      if (loadingAlert) {
        await loadingAlert.close();
      }
      Swal.fire({
        icon: "error",
        title: "Bulk Assignment Error",
        text:
          err.message || "An unexpected error occurred during bulk assignment.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  // DELETE
  const handleDelete = async (id) => {
    const result = await Swal.fire({
      title: "Are you sure?",
      text: "This cannot be undone.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#DD6B55",
      cancelButtonColor: "#aaa",
      confirmButtonText: "Yes, delete it!",
    });
    if (result.isConfirmed) {
      try {
        const response = await api.delete(`/deletelead/${id}`);
        if (response.data.status || response.data.success) {
          setLeads((prev) =>
            Array.isArray(prev) ? prev.filter((l) => l.customer_id !== id) : []
          );
          await Swal.fire({
            icon: "success",
            title: "Lead Deleted!",
            text: response.data.message || "Lead has been removed.",
            confirmButtonColor: "#2798FF",
          });
        } else {
          throw new Error(response.data.message || "Server rejected delete");
        }
      } catch (err) {
        Swal.fire({
          icon: "error",
          title: "Delete Lead Failed",
          text: err.message,
          confirmButtonColor: "#DD6B55",
        });
      }
    }
    setOpenStatusMenu(null);
    setActiveDropdown(null);
  };

  const handleSubmit = async (e, action = "save") => {
    if (e && e.preventDefault) e.preventDefault();

    const validationErrors = validateFormData(formData);
    if (validationErrors.length > 0) {
      Swal.fire({
        icon: "error",
        title: "Validation Error",
        html: validationErrors.map((err) => `<div>${err}</div>`).join(""),
        confirmButtonColor: "#DD6B55",
      });
      return;
    }

    try {
      const formDataToSend = new FormData();
      // --- FIX: Convert assigned_to (name) to user ID (int) ---
      let assignedToId = formData.assigned_to;
      // REMOVE: Validation for assigned_to user
      if (user?.role === "admin") {
        const assignedUser = users.find((u) => u.name === formData.assigned_to);
        assignedToId = assignedUser ? assignedUser.id : "";
      } else {
        assignedToId = user.id;
      }

      // Find the selected status object from statuses array
      const selectedStatus = statuses.find(
        (status) =>
          status.status_name.toLowerCase().replace(/\s+/g, "_") ===
          formData.status
      );
      // REMOVE: Validation for status
      // If not found, just leave as is (no error)

      // Define the address object
      const addressObject = {
        name: formData.blockUnitStreetName,
        city: formData.city,
        state: formData.state,
        country: formData.country,
        pin: formData.pincode,
      };
      // If all address fields are empty (or country is default 'India'), send empty string
      const isAddressEmpty =
        !addressObject.name &&
        !addressObject.city &&
        !addressObject.state &&
        (!addressObject.country || addressObject.country === "India") &&
        !addressObject.pin;

      // Combine follow_up_date_input and follow_up_time_input
      let combinedFollowUpDate = null;
      if (formData.follow_up_date_input) {
        const datePart = formData.follow_up_date_input;
        const timePart = createFormData.follow_up_time_input
          ? createFormData.follow_up_time_input + ":00"
          : createFormData.follow_up_time_input;
        combinedFollowUpDate = `${datePart} ${timePart}`; // Ensure seconds are added
      }

      // Format the data to match API keys
      const formattedData = {
        customer_name: formData.name,
        email: formData.email,
        contact_number: formData.phoneno,
        city: isAddressEmpty ? "" : JSON.stringify(addressObject), // Send empty string if address is empty
        whatsapp_number: formData.whatsapp,
        requirements: formData.requirements,
        source: formData.source,
        assigned_to:
          assignedToId && !isNaN(parseInt(assignedToId, 10))
            ? parseInt(assignedToId, 10)
            : 0,
        follow_up_date: combinedFollowUpDate, // Use the combined date and time
        status: selectedStatus ? selectedStatus.status_name : "",
        status_id: selectedStatus ? selectedStatus.status_id : "",
        message: formData.message,
        profile_image: formData.profile_pic,
      };

      // If not admin, force assigned_to to user.id
      if (user?.role !== "admin") {
        formattedData.assigned_to = user.id;
      }
      // Ensure assigned_to is always an integer
      formattedData.assigned_to = parseInt(formattedData.assigned_to, 10);

      // Append all formatted fields
      Object.keys(formattedData).forEach((key) => {
        if (key === "profile_image" && formattedData[key]) {
          formDataToSend.append("profile_image", formattedData[key]);
        } else if (
          formattedData[key] !== null &&
          formattedData[key] !== undefined
        ) {
          // If value is null or undefined, send empty string instead
          formDataToSend.append(
            key,
            formattedData[key] === null ? "" : formattedData[key]
          );
        }
      });

      const response = await api.post(
        `/udateleads/${editingLead.customer_id}`,
        formDataToSend,
        {
          headers: {
            "Content-Type": "multipart/form-data",
          },
        }
      );
      if (response.data.status || response.data.success) {
        // Update the leads list with the edited lead
        setLeads((prevLeads) =>
          prevLeads.map((lead) =>
            lead.customer_id === editingLead.customer_id
              ? {
                  ...lead,
                  customer_name: response.data.lead.customer_name,
                  email: response.data.lead.email,
                  contact: response.data.lead.contact_number,
                  city: response.data.lead.city,
                  whatsapp_number: response.data.lead.whatsapp_number,
                  requirements: response.data.lead.requirements,
                  source: response.data.lead.source,
                  assigned_to:
                    users.find(
                      (user) => user.id == response.data.lead.assigned_to
                    )?.name || response.data.lead.assigned_to,
                  follow_up_date: response.data.lead.follow_up_date_input,
                  follow_up_time: response.data.lead.follow_up_time_input,
                  status_name: response.data.lead.status,
                  message: response.data.lead.message,
                  profile_pic: response.data.lead.profile_image, // Use profile_image from response
                }
              : lead
          )
        );
        if (action === "save") {
          setIsModalOpen(false); // Only close modal on Save
        }
        await Swal.fire({
          icon: "success",
          title: "Lead Updated",
          text:
            response.data.message ||
            `${formData.name} was successfully updated.`,
          confirmButtonColor: "#2798FF",
        });
        // Fetch leads again instead of reloading the page
        await fetchLeads();

        // Clear address fields
        clearAddressFields();
      } else {
        throw new Error(response.data.message || "Failed to update lead");
      }
    } catch (err) {
      let errorTitle = "Error Updating Lead";
      let errorMessage =
        err.response && err.response.data && err.response.data.message
          ? err.response.data.message
          : "An error occurred while updating the lead. Please try again.";

      if (err.response) {
        if (err.response.status === 422) {
          const errors = err.response.data.errors;
          if (errors) {
            const firstError = Object.values(errors)[0];
            if (Array.isArray(firstError) && firstError.length > 0) {
              errorMessage = firstError[0];
            }
          }
        } else if (err.response.data?.message) {
          errorMessage = err.response.data.message;
        }
      } else if (err.request) {
        errorTitle = "Network Error";
        errorMessage =
          "Unable to connect to the server. Please check your internet connection.";
      } else {
        errorMessage = err.message;
      }

      await Swal.fire({
        icon: "error",
        title: errorTitle,
        text: errorMessage,
        confirmButtonColor: "#DD6B55",
      });
    }
    setOpenStatusMenu(null);
    setActiveDropdown(null);
  };

  const handleStatusToggle = async (lead) => {
    const newIsApproved = !lead.is_approved;
    try {
      const response = await api.post(`/approval/${lead.customer_id}`, {
        is_approved: newIsApproved ? 1 : 0,
      });
      if (response.data.status || response.data.success) {
        setLeads((prev) =>
          prev.map((l) =>
            l.customer_id === lead.customer_id
              ? { ...l, is_approved: newIsApproved }
              : l
          )
        );
        await Swal.fire({
          icon: "success",
          title: "Status Updated",
          text:
            response.data.message ||
            `${lead.customer_name} is now ${
              newIsApproved ? "Approved" : "Pending"
            }.`,
          confirmButtonColor: "#2798FF",
        });
      } else {
        throw new Error(
          response.data.message || "Server did not confirm status update"
        );
      }
    } catch (err) {
      Swal.fire({
        icon: "error",
        title: "Failed to update lead status",
        text: err.message || "An error occurred",
        confirmButtonColor: "#DD6B55",
      });
    }
    setOpenStatusMenu(null);
    setActiveDropdown(null);
  };

  // Update the status dropdown in the create form
  const renderStatusDropdown = () => (
    <div className="relative" ref={statusDropdownRef}>
      <button
        type="button"
        onClick={() => setIsStatusDropdownOpen(!isStatusDropdownOpen)}
        className="w-full  h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] text-left flex items-center justify-between cursor-pointer"
      >
        <span>
          {statuses.find(
            (status) =>
              status.status_name.toLowerCase().replace(/\s+/g, "_") ===
              createFormData.status
          )?.status_name || "Select Status"}
        </span>
        <svg
          className={`w-4 h-4 transition-transform ${
            isStatusDropdownOpen ? "rotate-180" : ""
          }`}
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M19 9l-7 7-7-7"
          />
        </svg>
      </button>
      {isStatusDropdownOpen && (
        <div className="absolute top-full custom-scrollbar left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto cursor-pointer">
          {statuses.map((status) => (
            <button
              key={status.status_id}
              type="button"
              onClick={() => {
                handleCreateInputChange({
                  target: {
                    name: "status",
                    value: status.status_name
                      .toLowerCase()
                      .replace(/\s+/g, "_"),
                  },
                });
                setIsStatusDropdownOpen(false);
              }}
              className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
            >
              {status.status_name}
            </button>
          ))}
        </div>
      )}
    </div>
  );

  // Modified to accept props for reusability
  const renderAssignToDropdown = (currentValue, onValueChange) => (
    <div className="relative" ref={assignToDropdownRef}>
      <button
        type="button"
        onClick={() => setIsAssignToDropdownOpen(!isAssignToDropdownOpen)}
        className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] text-left flex items-center justify-between cursor-pointer"
      >
        <span>
          {users.find((user) => user.name === currentValue)?.name ||
            "Select User"}
        </span>
        <svg
          className={`w-4 h-4 transition-transform ${
            isAssignToDropdownOpen ? "rotate-180" : ""
          }`}
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M19 9l-7 7-7-7"
          />
        </svg>
      </button>
      {isAssignToDropdownOpen && (
        <div className="absolute custom-scrollbar top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto cursor-pointer">
          {users.map((user) => (
            <button
              key={user.id}
              type="button"
              onClick={() => {
                onValueChange(user.name); // Pass the user's name
                setIsAssignToDropdownOpen(false);
              }}
              className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
            >
              {user.name}
            </button>
          ))}
        </div>
      )}
    </div>
  );

  // Cleanup image preview URLs when component unmounts
  useEffect(() => {
    return () => {
      if (createImagePreview) {
        URL.revokeObjectURL(createImagePreview);
      }
      if (imagePreview) {
        URL.revokeObjectURL(imagePreview);
      }
    };
  }, [createImagePreview, imagePreview]);

  // 2. Add state to track the index of the currently edited lead in filteredLeads
  const [editingLeadIndex, setEditingLeadIndex] = useState(null);

  // 3. Add navigation handlers
  const handleEditBack = async (e) => {
    await handleSubmit(e, "back");
    if (editingLeadIndex > 0) {
      const prevLead = filteredLeads[editingLeadIndex - 1];
      handleEdit(prevLead);
    }
  };
  const handleEditNext = async (e) => {
    await handleSubmit(e, "next");
    if (editingLeadIndex < filteredLeads.length - 1) {
      const nextLead = filteredLeads[editingLeadIndex + 1];
      handleEdit(nextLead);
    }
  };

  // Add ref for follow up date range dropdown
  const followUpDateRangeDropdownRef = useRef(null);

  // Add ref for status filter dropdown
  const statusDropdownFilterRef = useRef(null);

  const [bulkEditStatusSearch, setBulkEditStatusSearch] = useState("");
  const [isBulkEditStatusDropdownOpen, setIsBulkEditStatusDropdownOpen] =
    useState(false);
  const [bulkEditSelectedStatus, setBulkEditSelectedStatus] = useState(null);

  const handleBulkChangeStatus = async () => {
    if (!bulkEditSelectedStatus || selectedLeads.length === 0) return;
    let loadingAlert;
    try {
      loadingAlert = Swal.fire({
        title: `Updating Status for ${selectedLeads.length} Leads...`,
        html: "Please wait, this may take a moment.",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });
      const successfulUpdates = [];
      const failedUpdates = [];
      for (const leadId of selectedLeads) {
        try {
          const leadToUpdate = leads.find(
            (lead) => lead.customer_id === leadId
          );
          if (!leadToUpdate) {
            failedUpdates.push({
              id: leadId,
              reason: "Lead not found locally.",
            });
            continue;
          }
          const formDataToSend = new FormData();
          safeAppend(
            formDataToSend,
            "customer_name",
            leadToUpdate.customer_name
          );
          safeAppend(formDataToSend, "email", leadToUpdate.email);
          safeAppend(formDataToSend, "contact_number", leadToUpdate.contact);
          safeAppend(formDataToSend, "city", leadToUpdate.city);
          safeAppend(
            formDataToSend,
            "whatsapp_number",
            leadToUpdate.whatsapp_number
          );
          safeAppend(formDataToSend, "requirements", leadToUpdate.requirements);
          safeAppend(formDataToSend, "source", leadToUpdate.source);
          safeAppend(
            formDataToSend,
            "follow_up_date",
            leadToUpdate.follow_up_date_input
          );
          safeAppend(
            formDataToSend,
            "follow_up_time",
            leadToUpdate.follow_up_time_input
          );
          safeAppend(
            formDataToSend,
            "status",
            bulkEditSelectedStatus.status_name
          );
          safeAppend(
            formDataToSend,
            "status_id",
            bulkEditSelectedStatus.status_id
          );
          safeAppend(formDataToSend, "message", leadToUpdate.message);
          // Ensure assigned_to is always an integer user ID
          let assignedToId = leadToUpdate.assigned_to;
          if (typeof assignedToId === "string" && isNaN(Number(assignedToId))) {
            const userObj = users.find((u) => u.name === assignedToId);
            assignedToId = userObj ? userObj.id : "";
          }
          if (!assignedToId || isNaN(Number(assignedToId))) {
            assignedToId = 0;
          }
          safeAppend(formDataToSend, "assigned_to", parseInt(assignedToId, 10));
          const response = await api.post(
            `/udateleads/${leadId}`,
            formDataToSend,
            {
              headers: {
                "Content-Type": "multipart/form-data",
              },
            }
          );
          if (response.data.status || response.data.success) {
            successfulUpdates.push(leadId);
          } else {
            failedUpdates.push({
              id: leadId,
              reason: response.data.message || "Unknown error",
            });
          }
        } catch (err) {
          failedUpdates.push({
            id: leadId,
            reason: err.message || "Network error",
          });
        }
      }
      await loadingAlert.close();
      if (successfulUpdates.length > 0) {
        await Swal.fire({
          icon: "success",
          title: "Bulk Status Update Complete!",
          html: `Successfully updated status for ${
            successfulUpdates.length
          } lead(s).<br/>${
            failedUpdates.length > 0
              ? `<span class=\"text-red-500\">${failedUpdates.length} lead(s) failed to update.</span>`
              : ""
          }`,
          confirmButtonColor: "#2798FF",
        });
      } else if (failedUpdates.length > 0) {
        await Swal.fire({
          icon: "error",
          title: "Bulk Status Update Failed",
          html: `Failed to update status for all leads. ${failedUpdates.length} lead(s) encountered errors.`,
          confirmButtonColor: "#DD6B55",
        });
      } else {
        await Swal.fire({
          icon: "info",
          title: "No Status Updated",
          text: "No leads were updated.",
          confirmButtonColor: "#DD6B55",
        });
      }
      // Refresh leads and reset state
      const refreshResponse = await api.get("/showlead");
      if (refreshResponse.data.success) {
        setLeads(
          Array.isArray(refreshResponse.data.result)
            ? refreshResponse.data.result
            : []
        );
      } else {
        setLeads([]);
      }
      setBulkEditStatusSearch("");
      setBulkEditSelectedStatus(null);
      setIsBulkEditStatusDropdownOpen(false);
      // Do not clear selectedLeads so user can perform more actions
    } catch (err) {
      if (loadingAlert) {
        await loadingAlert.close();
      }
      Swal.fire({
        icon: "error",
        title: "Bulk Status Update Error",
        text:
          err.message ||
          "An unexpected error occurred during bulk status update.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  // Add refs for bulk edit dropdowns
  const bulkEditAssigneeDropdownRef = useRef(null);
  const bulkEditStatusDropdownRef = useRef(null);

  // Add useEffect for bulk edit assignee dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        bulkEditAssigneeDropdownRef.current &&
        !bulkEditAssigneeDropdownRef.current.contains(event.target)
      ) {
        setIsAssigneeDropdownOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Add useEffect for bulk edit status dropdown click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        bulkEditStatusDropdownRef.current &&
        !bulkEditStatusDropdownRef.current.contains(event.target)
      ) {
        setIsBulkEditStatusDropdownOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // New state for Updated date range filter
  if (loading) {
    return (
      <div className="w-full min-h-[797px] flex items-center justify-center">
        Loading Leads...
      </div>
    );
  }

  // Add these handlers near other bulk handlers
  const handleBulkDeleteMessage = async () => {
    if (selectedLeads.length === 0) return;
    let loadingAlert;
    try {
      loadingAlert = Swal.fire({
        title: `Deleting Message for ${selectedLeads.length} Leads...`,
        html: "Please wait, this may take a moment.",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });
      const successfulUpdates = [];
      const failedUpdates = [];
      for (const leadId of selectedLeads) {
        try {
          const leadToUpdate = leads.find(
            (lead) => lead.customer_id === leadId
          );
          if (!leadToUpdate) {
            failedUpdates.push({
              id: leadId,
              reason: "Lead not found locally.",
            });
            continue;
          }
          const formDataToSend = new FormData();
          safeAppend(
            formDataToSend,
            "customer_name",
            leadToUpdate.customer_name
          );
          safeAppend(formDataToSend, "email", leadToUpdate.email);
          safeAppend(formDataToSend, "contact_number", leadToUpdate.contact);
          safeAppend(formDataToSend, "city", leadToUpdate.city);
          safeAppend(
            formDataToSend,
            "whatsapp_number",
            leadToUpdate.whatsapp_number
          );
          safeAppend(formDataToSend, "requirements", leadToUpdate.requirements);
          safeAppend(formDataToSend, "source", leadToUpdate.source);
          safeAppend(
            formDataToSend,
            "follow_up_date",
            leadToUpdate.follow_up_date_input
          );
          safeAppend(
            formDataToSend,
            "follow_up_time",
            leadToUpdate.follow_up_time_input
          );
          safeAppend(formDataToSend, "status", leadToUpdate.status_name);
          safeAppend(formDataToSend, "status_id", leadToUpdate.status_id);
          safeAppend(formDataToSend, "message", ""); // Clear message
          let assignedToId = leadToUpdate.assigned_to;
          if (typeof assignedToId === "string" && isNaN(Number(assignedToId))) {
            const userObj = users.find((u) => u.name === assignedToId);
            assignedToId = userObj ? userObj.id : "";
          }
          if (!assignedToId || isNaN(Number(assignedToId))) {
            assignedToId = 0;
          }
          safeAppend(formDataToSend, "assigned_to", parseInt(assignedToId, 10));
          const response = await api.post(
            `/udateleads/${leadId}`,
            formDataToSend,
            { headers: { "Content-Type": "multipart/form-data" } }
          );
          if (response.data.status || response.data.success) {
            successfulUpdates.push(leadId);
          } else {
            failedUpdates.push({
              id: leadId,
              reason: response.data.message || "Unknown error",
            });
          }
        } catch (err) {
          failedUpdates.push({
            id: leadId,
            reason: err.message || "Network error",
          });
        }
      }
      await loadingAlert.close();
      if (successfulUpdates.length > 0) {
        await Swal.fire({
          icon: "success",
          title: "Bulk Message Delete Complete!",
          html: `Successfully deleted message for ${
            successfulUpdates.length
          } lead(s).<br/>${
            failedUpdates.length > 0
              ? `<span class=\"text-red-500\">${failedUpdates.length} lead(s) failed.</span>`
              : ""
          }`,
          confirmButtonColor: "#2798FF",
        });
      } else if (failedUpdates.length > 0) {
        await Swal.fire({
          icon: "error",
          title: "Bulk Message Delete Failed",
          html: `Failed to delete message for all leads. ${failedUpdates.length} lead(s) encountered errors.`,
          confirmButtonColor: "#DD6B55",
        });
      }
      const refreshResponse = await api.get("/showlead");
      if (refreshResponse.data.success) {
        setLeads(
          Array.isArray(refreshResponse.data.result)
            ? refreshResponse.data.result
            : []
        );
      } else {
        setLeads([]);
      }
    } catch (err) {
      if (loadingAlert) await loadingAlert.close();
      Swal.fire({
        icon: "error",
        title: "Bulk Message Delete Error",
        text: err.message || "An unexpected error occurred.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  const handleBulkDeleteFollowUpDate = async () => {
    if (selectedLeads.length === 0) return;
    let loadingAlert;
    try {
      loadingAlert = Swal.fire({
        title: `Deleting Follow Up Date for ${selectedLeads.length} Leads...`,
        html: "Please wait, this may take a moment.",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });
      const successfulUpdates = [];
      const failedUpdates = [];
      for (const leadId of selectedLeads) {
        try {
          const leadToUpdate = leads.find(
            (lead) => lead.customer_id === leadId
          );
          if (!leadToUpdate) {
            failedUpdates.push({
              id: leadId,
              reason: "Lead not found locally.",
            });
            continue;
          }
          const formDataToSend = new FormData();
          safeAppend(
            formDataToSend,
            "customer_name",
            leadToUpdate.customer_name
          );
          safeAppend(formDataToSend, "email", leadToUpdate.email);
          safeAppend(formDataToSend, "contact_number", leadToUpdate.contact);
          safeAppend(formDataToSend, "city", leadToUpdate.city);
          safeAppend(
            formDataToSend,
            "whatsapp_number",
            leadToUpdate.whatsapp_number
          );
          safeAppend(formDataToSend, "requirements", leadToUpdate.requirements);
          safeAppend(formDataToSend, "source", leadToUpdate.source);
          safeAppend(formDataToSend, "follow_up_date", ""); // Clear follow up date
          safeAppend(formDataToSend, "follow_up_time", ""); // Clear follow up time
          safeAppend(formDataToSend, "status", leadToUpdate.status_name);
          safeAppend(formDataToSend, "status_id", leadToUpdate.status_id);
          safeAppend(formDataToSend, "message", leadToUpdate.message);
          let assignedToId = leadToUpdate.assigned_to;
          if (typeof assignedToId === "string" && isNaN(Number(assignedToId))) {
            const userObj = users.find((u) => u.name === assignedToId);
            assignedToId = userObj ? userObj.id : "";
          }
          if (!assignedToId || isNaN(Number(assignedToId))) {
            assignedToId = 0;
          }
          safeAppend(formDataToSend, "assigned_to", parseInt(assignedToId, 10));
          const response = await api.post(
            `/udateleads/${leadId}`,
            formDataToSend,
            { headers: { "Content-Type": "multipart/form-data" } }
          );
          if (response.data.status || response.data.success) {
            successfulUpdates.push(leadId);
          } else {
            failedUpdates.push({
              id: leadId,
              reason: response.data.message || "Unknown error",
            });
          }
        } catch (err) {
          failedUpdates.push({
            id: leadId,
            reason: err.message || "Network error",
          });
        }
      }
      await loadingAlert.close();
      if (successfulUpdates.length > 0) {
        await Swal.fire({
          icon: "success",
          title: "Bulk Follow Up Date Delete Complete!",
          html: `Successfully deleted follow up date for ${
            successfulUpdates.length
          } lead(s).<br/>${
            failedUpdates.length > 0
              ? `<span class=\"text-red-500\">${failedUpdates.length} lead(s) failed.</span>`
              : ""
          }`,
          confirmButtonColor: "#2798FF",
        });
      } else if (failedUpdates.length > 0) {
        await Swal.fire({
          icon: "error",
          title: "Bulk Follow Up Date Delete Failed",
          html: `Failed to delete follow up date for all leads. ${failedUpdates.length} lead(s) encountered errors.`,
          confirmButtonColor: "#DD6B55",
        });
      }
      const refreshResponse = await api.get("/showlead");
      if (refreshResponse.data.success) {
        setLeads(
          Array.isArray(refreshResponse.data.result)
            ? refreshResponse.data.result
            : []
        );
      } else {
        setLeads([]);
      }
    } catch (err) {
      if (loadingAlert) await loadingAlert.close();
      Swal.fire({
        icon: "error",
        title: "Bulk Follow Up Date Delete Error",
        text: err.message || "An unexpected error occurred.",
        confirmButtonColor: "#DD6B55",
      });
    }
  };

  // Clipboard helper for duplicate table
  const copyToClipboard = async (text) => {
    try {
      await navigator.clipboard.writeText(text);
      Swal.fire({
        icon: "success",
        title: "Copied!",
        text: "Duplicate records copied to clipboard.",
        showConfirmButton: false,
        timer: 1500,
      });
    } catch (err) {
      Swal.fire({
        icon: "error",
        title: "Copy Failed",
        text: "Failed to copy to clipboard.",
      });
    }
  };

  return (
    <div
      className={`min-h-[797px] p-4 md:p-6 relative bg-gradient-to-br from-white to-[#E7F4FF] rounded-[10px] shadow-[2px_2px_6px_rgba(24,95,235,0.1)] flex flex-col w-full   ${
        isCollapsed
          ? "lg:max-w-[85vw] md:w-[85vw]"
          : "lg:max-w-[75vw] md:w-[80vw]"
      } md:mx-auto`}
    >
      {/* Header Section */}
      <div className="flex flex-wrap items-center justify-between gap-4 mb-8">
        {/* Title */}
        <h1 className="text-[20px] md:text-[22px] font-medium text-[#1F2837] whitespace-nowrap">
          All Leads
        </h1>

        {/* Search Container */}
        <div className="flex-1 max-w-[400px] mx-1">
          {isMobile && !isSearchExpanded ? (
            <button
              onClick={handleSearchToggle}
              className="
          w-10 h-10
          flex items-center
          rounded-[6px]
          hover:bg-gray-50 transition-colors cursor-pointer
        "
            >
              {/* search icon SVG */}
              <svg
                width="20"
                height="20"
                viewBox="0 0 22 22"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M10.5417 19.25C15.3512 19.25 19.25 15.3512 19.25 10.5417C19.25 5.73223 15.3512 1.83334 10.5417 1.83334C5.73223 1.83334 1.83334 5.73223 1.33334 10.5417C1.83334 15.3512 5.73223 19.25 10.5417 19.25Z"
                  stroke="#787374"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M18.3333 18.3333L20.1667 20.1667"
                  stroke="#787374"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>
          ) : (
            <div className="relative w-full">
              {/* Search icon inside input */}
              <div className="absolute left-4 top-1/2 -translate-y-1/2 pointer-events-none">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 22 22"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M10.5417 19.25C15.3512 19.25 19.25 15.3512 19.25 10.5417C19.25 5.73223 15.3512 1.83334 10.5417 1.83334C5.73223 1.83334 1.83334 5.73223 1.33334 10.5417C1.83334 15.3512 5.73223 19.25 10.5417 19.25Z"
                    stroke="#787374"
                    strokeWidth="1.5"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                  <path
                    d="M18.3333 18.3333L20.1667 20.1667"
                    stroke="#787374"
                    strokeWidth="1.5"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                </svg>
              </div>
              <input
                type="search"
                placeholder={isMobile ? "Search" : "Search by Name, Contact"}
                value={searchTerm}
                onChange={handleSearchChange}
                className="
            w-full
            h-[44px]
            pl-12 pr-4
            bg-[#E9F1F9]
            rounded-[6px]
            text-[#787374] placeholder-[#787374]
            focus:outline-none
            text-sm md:text-base lg:text-base
          "
                onBlur={handleSearchBlur}
                autoFocus={isMobile && isSearchExpanded}
              />
            </div>
          )}
        </div>

        {/* Actions: Create Lead + Display Dropdown + Bulk Actions */}
        <div className="flex flex-wrap items-center gap-3 md:gap-4 lg:gap-4">
          {permissionsForLeadsModule.includes("create") && (
            <button
              className="hover:bg-blue-500 bg-[#ef7e1b] text-white h-[44px] px-5 rounded-[8px] flex items-center justify-center cursor-pointer"
              onClick={openCreateModal}
            >
              Create Lead
            </button>
          )}

          {hasBulkAssignPermission &&
            selectedLeads.length > 0 &&
            permissionsForLeadsModule.includes("edit") && (
              <button
                className="hover:bg-blue-500 bg-[#ef7e1b] text-white h-[44px] px-5 rounded-[8px] flex items-center justify-center cursor-pointer"
                onClick={() => setIsBulkAssignModalOpen(true)}
              >
                Bulk Edit
              </button>
            )}
          {hasBulkAssignPermission &&
            selectedLeads.length > 0 &&
            permissionsForLeadsModule.includes("delete") && (
              <button
                className="hover:bg-red-500 bg-[#DD6B55] text-white h-[44px] px-5 rounded-[8px] flex items-center justify-center cursor-pointer"
                onClick={handleBulkDelete}
              >
                Bulk Delete
              </button>
            )}

          {hasCsvPermission && (
            <div className="relative" ref={csvDropdownRef}>
              <button
                onClick={() => setIsCsvDropdownOpen(!isCsvDropdownOpen)}
                className={`
                  ${isMobile ? "w-10 h-10 rounded-[6px]" : "p-2 rounded-full"}
                  flex items-center justify-center cursor-pointer
                  hover:bg-gray-100 transition-colors
                `}
              >
                <FaFileImport className="w-6 h-6 text-[#727A90]" />
              </button>
              {isCsvDropdownOpen && (
                <div
                  className={`absolute left-0 mt-2 ${
                    isMobile ? "w-24" : "w-40"
                  } rounded-md shadow-lg bg-gradient-to-br from-white to-[#E7F4FF] z-10 overflow-hidden`}
                >
                  <button
                    onClick={handleImportCsv}
                    className="group flex items-center px-2 lg:px-3 py-2 text-xs text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors first:rounded-t-md cursor-pointer"
                  >
                    <FiUpload className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors" />
                    <span className="group-hover:text-white transition-colors whitespace-nowrap">
                      Import Leads
                    </span>
                  </button>
                  <svg
                    className="w-full h-[1px]"
                    viewBox="0 0 100 1"
                    preserveAspectRatio="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <polygon points="0,0 50,1 100,0" fill="#E5E7EB" />
                  </svg>
                  <button
                    onClick={() => {
                      setIsExportModalOpen(true);
                      setIsCsvDropdownOpen(false);
                    }}
                    className="group flex items-center px-2 lg:px-3 py-2 text-xs text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors last:rounded-b-md cursor-pointer"
                  >
                    <FiDownload className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors" />
                    <span className="group-hover:text-white transition-colors whitespace-nowrap">
                      Export Leads
                    </span>
                  </button>
                </div>
              )}
            </div>
          )}

          <span className="text-[#727A90] text-sm md:text-base lg:text-base whitespace-nowrap">
            Show
          </span>
          {/* Items per page custom dropdown */}
          <div className="relative min-w-[88px]" ref={itemsPerPageDropdownRef}>
            <button
              type="button"
              className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full min-w-[72px] md:min-w-[88px] lg:min-w-[88px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center"
              onClick={() => setIsItemsPerPageDropdownOpen((open) => !open)}
            >
              <span className="truncate text-left flex-1">{itemsPerPage}</span>
              <img
                src="/caret-down.svg"
                alt=""
                aria-hidden="true"
                className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
              />
            </button>
            {isItemsPerPageDropdownOpen && (
              <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
                {[5, 10, 20, 50].map((option) => (
                  <button
                    key={option}
                    type="button"
                    onClick={() => {
                      handleItemsPerPageChange(option);
                      setIsItemsPerPageDropdownOpen(false);
                    }}
                    className={`w-full px-3 py-2 text-left hover:bg-[#E7EFF8] ${
                      itemsPerPage === option
                        ? "bg-[#E7EFF8] font-bold text-[#ef7e1b]"
                        : "text-[#545454]"
                    }`}
                  >
                    {option}
                  </button>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Filter Section */}
      <div
        className={`grid grid-cols-2 gap-3 mb-2  ${
          rolePermissions === "ALL"
            ? "md:grid-cols-2 lg:grid-cols-6"
            : "md:grid-cols-2 lg:grid-cols-5"
        } `}
      >
        {" "}
        {/* changed from 6 to 7 */}
        {/* Customer Name Dropdown */}
        <div className="relative" ref={customerNameDropdownRef}>
          <button
            type="button"
            className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[120px] lg:min-w-[120px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center cursor-pointer"
            onClick={() =>
              setActiveDropdown(
                activeDropdown === "customerName" ? null : "customerName"
              )
            }
          >
            <span className="truncate text-left flex-1">
              {filters.customerName === "all"
                ? "Lead Name"
                : filters.customerName}
            </span>
            {/* Cross to clear filter */}
            {filters.customerName !== "all" && (
              <button
                type="button"
                className="absolute right-7 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 text-lg font-bold focus:outline-none"
                style={{ padding: 0, lineHeight: 1 }}
                tabIndex={-1}
                title="Clear filter"
                onClick={(e) => {
                  e.stopPropagation();
                  handleFilterChange("customerName", "all");
                }}
              >
                <RxCross2 />
              </button>
            )}
            <img
              src="/caret-down.svg"
              alt=""
              aria-hidden="true"
              className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
            />
          </button>
          {activeDropdown === "customerName" && (
            <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
              {Array.from(
                new Set(
                  leads
                    .map((lead) => lead.customer_name)
                    .filter(Boolean)
                    .map((name) => name.toLowerCase().trim())
                )
              ).map((name) => (
                <button
                  key={name}
                  type="button"
                  onClick={() => {
                    handleFilterChange("customerName", name);
                    setActiveDropdown(null);
                  }}
                  className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer"
                >
                  {name}
                </button>
              ))}
            </div>
          )}
        </div>
        {/* Status Dropdown (replaces Source) */}
        <div className="relative" ref={statusDropdownFilterRef}>
          <button
            type="button"
            className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[120px] lg:min-w-[120px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center cursor-pointer"
            onClick={() =>
              setActiveDropdown(
                activeDropdown === "statusId" ? null : "statusId"
              )
            }
          >
            <span className="truncate text-left flex-1">
              {filters.statusId === "all"
                ? "Status"
                : statuses.find(
                    (s) => String(s.status_id) === String(filters.statusId)
                  )?.status_name || "Status"}
            </span>
            {/* Cross to clear filter */}
            {filters.statusId !== "all" && (
              <button
                type="button"
                className="absolute right-7 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 text-lg font-bold focus:outline-none"
                style={{ padding: 0, lineHeight: 1 }}
                tabIndex={-1}
                title="Clear filter"
                onClick={(e) => {
                  e.stopPropagation();
                  handleFilterChange("statusId", "all");
                }}
              >
                <RxCross2 />
              </button>
            )}
            <img
              src="/caret-down.svg"
              alt=""
              aria-hidden="true"
              className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
            />
          </button>
          {activeDropdown === "statusId" && (
            <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
              {statuses.map((status) => (
                <button
                  key={status.status_id}
                  type="button"
                  onClick={() => {
                    handleFilterChange("statusId", status.status_id);
                    setActiveDropdown(null);
                  }}
                  className={`w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] ${
                    String(filters.statusId) === String(status.status_id)
                      ? "bg-[#E7EFF8] text-[#ef7e1b] font-bold"
                      : ""
                  }`}
                >
                  {status.status_name}
                </button>
              ))}
            </div>
          )}
        </div>
        {/* Assigned User Dropdown */}
        <div className="relative" ref={assignedToDropdownRef}>
          <button
            type="button"
            className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[120px] lg:min-w-[120px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center cursor-pointer"
            onClick={() =>
              setActiveDropdown(
                activeDropdown === "assignedTo" ? null : "assignedTo"
              )
            }
          >
            <span className="truncate text-left flex-1">
              {filters.assignedTo === "all"
                ? "Assigned User"
                : filters.assignedTo}
            </span>
            {/* Cross to clear filter */}
            {filters.assignedTo !== "all" && (
              <button
                type="button"
                className="absolute right-7 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 text-lg font-bold focus:outline-none"
                style={{ padding: 0, lineHeight: 1 }}
                tabIndex={-1}
                title="Clear filter"
                onClick={(e) => {
                  e.stopPropagation();
                  handleFilterChange("assignedTo", "all");
                }}
              >
                <RxCross2 />
              </button>
            )}
            <img
              src="/caret-down.svg"
              alt=""
              aria-hidden="true"
              className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
            />
          </button>
          {activeDropdown === "assignedTo" && (
            <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
              {Array.from(
                new Set(
                  leads
                    .map((lead) => lead.assigned_to)
                    .filter(Boolean)
                    .map((assigned) => assigned.toLowerCase().trim())
                )
              ).map((assigned) => (
                <button
                  key={assigned}
                  type="button"
                  onClick={() => {
                    handleFilterChange("assignedTo", assigned);
                    setActiveDropdown(null);
                  }}
                  className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer"
                >
                  {assigned}
                </button>
              ))}
            </div>
          )}
        </div>
        {/* New Follow Up Date Range Filter */}
        <div className="relative" ref={followUpDateRangeDropdownRef}>
          <button
            className="relative
          appearance-none
          h-[36px] md:h-[44px] lg:h-[44px]
          pl-2 pr-10 md:pr-15 lg:pr-15
          w-full md:min-w-[120px] lg:min-w-[120px]
          bg-white border border-[#E9EAEA]
          rounded-[8px]
          cursor-pointer
          text-[#242729] text-[8px] md:text-base lg:text-sm
          focus:outline-none cursor-pointer"
            onMouseDown={(e) => {
              e.stopPropagation();
              setDateRangeDropdownOpen((open) => !open);
            }}
          >
            <div className="flex items-center whitespace-nowrap">
              {timeRange === "all" && "Follow Up"}
              {timeRange === "7days" && "Last 7 Days"}
              {timeRange === "30days" && "Last 30 Days"}
              {timeRange === "90days" && "Last 90 Days"}
              {timeRange === "custom" && (
                <span className="text-[10px] whitespace-nowrap">
                  {`${formatDateForDisplay(
                    customDateRange.fromDate
                  )} - ${formatDateForDisplay(customDateRange.toDate)}`}
                </span>
              )}
            </div>
            <img
              src="/caret-down.svg"
              alt=""
              aria-hidden="true"
              className="
          pointer-events-none
          absolute right-2 md:right-3 lg:right-3
          top-1/2 -translate-y-1/2
          w-4 h-4
        "
            />
          </button>

          {dateRangeDropdownOpen && (
            <div className="absolute right-0 mt-2 w-72 bg-white border border-gray-200 rounded-lg shadow-lg z-10 cursor-pointer">
              <div className="px-4 pt-3  text-[#4B5563]">
                <p className="text-sm font-medium">Select Range</p>
              </div>

              <div className="p-2">
                {/* Predefined ranges */}
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    timeRange === "all"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  } cursor-pointer`}
                  onClick={() => handleTimeRangeChange("all")}
                >
                  <span>All Dates</span>
                  {timeRange === "all" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}
                </button>
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    timeRange === "7days"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  } cursor-pointer`}
                  onClick={() => handleTimeRangeChange("7days")}
                >
                  <span>Last 7 Days</span>
                  {timeRange === "7days" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}
                </button>
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    timeRange === "30days"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  } cursor-pointer`}
                  onClick={() => handleTimeRangeChange("30days")}
                >
                  <span>Last 30 Days</span>
                  {timeRange === "30days" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}
                </button>
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    timeRange === "90days"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  } cursor-pointer`}
                  onClick={() => handleTimeRangeChange("90days")}
                >
                  <span>Last 90 Days</span>
                  {timeRange === "90days" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}
                </button>

                <div className="border-t border-gray-200 my-2"></div>

                {/* Custom date range */}
                <div className="px-3 py-2">
                  <p className="text-sm font-medium text-[#4B5563] mb-2">
                    Custom Range
                  </p>
                  <div className="grid grid-cols-2 gap-2 mb-3">
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">
                        From
                      </label>
                      <input
                        type="date"
                        className="w-full h-[48px] text-sm px-2 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                        value={
                          customDateRange.fromDate
                            ? customDateRange.fromDate
                                .toISOString()
                                .split("T")[0]
                            : ""
                        }
                        onChange={(e) =>
                          handleCustomDateChange("fromDate", e.target.value)
                        }
                        max={
                          customDateRange.toDate
                            ? customDateRange.toDate.toISOString().split("T")[0]
                            : new Date().toISOString().split("T")[0]
                        }
                      />
                    </div>
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">
                        To
                      </label>
                      <input
                        type="date"
                        className="w-full h-[48px] text-sm px-2 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                        value={
                          customDateRange.toDate
                            ? customDateRange.toDate.toISOString().split("T")[0]
                            : ""
                        }
                        onChange={(e) =>
                          handleCustomDateChange("toDate", e.target.value)
                        }
                        min={
                          customDateRange.fromDate
                            ? customDateRange.fromDate
                                .toISOString()
                                .split("T")[0]
                            : ""
                        }
                        max={new Date().toISOString().split("T")[0]}
                      />
                    </div>
                  </div>
                  <button
                    className="hover:bg-blue-500
        bg-[#ef7e1b] text-white
        h-[44px] px-5
        rounded-[8px]
        flex items-center justify-center cursor-pointer
        w-full
      "
                    onClick={applyCustomDateRange}
                  >
                    Apply Custom Range
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
        {/* New Created Date Range Filter */}
        {rolePermissions === "ALL" && (
          <div className="relative" ref={createdDateRangeDropdownRef}>
            <button
              className="relative
          appearance-none
          h-[36px] md:h-[44px] lg:h-[44px]
          pl-2 pr-10 md:pr-15 lg:pr-15
          w-full md:min-w-[120px] lg:min-w-[120px]
          bg-white border border-[#E9EAEA]
          rounded-[8px]
          cursor-pointer
          text-[#242729] text-[8px] md:text-base lg:text-sm
          focus:outline-none cursor-pointer"
              onMouseDown={(e) => {
                e.stopPropagation();
                setCreatedDateRangeDropdownOpen((open) => !open);
              }}
            >
              <div className="flex items-center whitespace-nowrap ">
                {createdTimeRange === "all" && "Created"}
                {createdTimeRange === "7days" && "Last 7 Days"}
                {createdTimeRange === "30days" && "Last 30 Days"}
                {createdTimeRange === "90days" && "Last 90 Days"}
                {createdTimeRange === "custom" && (
                  <span className="text-[10px] whitespace-nowrap">
                    {`${formatDateForDisplay(
                      customCreatedDateRange.fromDate
                    )} - ${formatDateForDisplay(
                      customCreatedDateRange.toDate
                    )}`}
                  </span>
                )}
              </div>
              <img
                src="/caret-down.svg"
                alt=""
                aria-hidden="true"
                className="
          pointer-events-none
          absolute right-2 md:right-3 lg:right-3
          top-1/2 -translate-y-1/2
          w-4 h-4
        "
              />
            </button>

            {createdDateRangeDropdownOpen && (
              <div className="absolute right-0 mt-2 w-72 bg-white border border-gray-200 rounded-lg shadow-lg z-10 cursor-pointer">
                <div className="px-4 pt-3  text-[#4B5563]">
                  <p className="text-sm font-medium">Select Range</p>
                </div>

                <div className="p-2">
                  {/* Predefined ranges */}
                  <button
                    className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                      createdTimeRange === "all"
                        ? "bg-[#E7EFF8] text-[#ef7e1b]"
                        : "hover:bg-gray-100"
                    } cursor-pointer`}
                    onClick={() => handleCreatedTimeRangeChange("all")}
                  >
                    <span>All Dates</span>
                    {createdTimeRange === "all" && (
                      <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                    )}
                  </button>
                  <button
                    className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                      createdTimeRange === "7days"
                        ? "bg-[#E7EFF8] text-[#ef7e1b]"
                        : "hover:bg-gray-100"
                    } cursor-pointer`}
                    onClick={() => handleCreatedTimeRangeChange("7days")}
                  >
                    <span>Last 7 Days</span>
                    {createdTimeRange === "7days" && (
                      <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                    )}
                  </button>
                  <button
                    className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                      createdTimeRange === "30days"
                        ? "bg-[#E7EFF8] text-[#ef7e1b]"
                        : "hover:bg-gray-100"
                    } cursor-pointer`}
                    onClick={() => handleCreatedTimeRangeChange("30days")}
                  >
                    <span>Last 30 Days</span>
                    {createdTimeRange === "30days" && (
                      <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                    )}
                  </button>
                  <button
                    className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                      createdTimeRange === "90days"
                        ? "bg-[#E7EFF8] text-[#ef7e1b]"
                        : "hover:bg-gray-100"
                    } cursor-pointer`}
                    onClick={() => handleCreatedTimeRangeChange("90days")}
                  >
                    <span>Last 90 Days</span>
                    {createdTimeRange === "90days" && (
                      <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                    )}
                  </button>

                  <div className="border-t border-gray-200 my-2"></div>

                  {/* Custom date range */}
                  <div className="px-3 py-2">
                    <p className="text-sm font-medium text-[#4B5563] mb-2">
                      Custom Range
                    </p>
                    <div className="grid grid-cols-2 gap-2 mb-3">
                      <div>
                        <label className="block text-xs text-gray-500 mb-1">
                          From
                        </label>
                        <input
                          type="date"
                          className="w-full h-[48px] text-sm px-2 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                          value={
                            customCreatedDateRange.fromDate
                              ? customCreatedDateRange.fromDate
                                  .toISOString()
                                  .split("T")[0]
                              : ""
                          }
                          onChange={(e) =>
                            handleCustomCreatedDateChange(
                              "fromDate",
                              e.target.value
                            )
                          }
                          max={
                            customCreatedDateRange.toDate
                              ? customCreatedDateRange.toDate
                                  .toISOString()
                                  .split("T")[0]
                              : new Date().toISOString().split("T")[0]
                          }
                        />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-500 mb-1">
                          To
                        </label>
                        <input
                          type="date"
                          className="w-full h-[48px] text-sm px-2 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                          value={
                            customCreatedDateRange.toDate
                              ? customCreatedDateRange.toDate
                                  .toISOString()
                                  .split("T")[0]
                              : ""
                          }
                          onChange={(e) =>
                            handleCustomCreatedDateChange(
                              "toDate",
                              e.target.value
                            )
                          }
                          min={
                            customCreatedDateRange.fromDate
                              ? customCreatedDateRange.fromDate
                                  .toISOString()
                                  .split("T")[0]
                              : ""
                          }
                          max={new Date().toISOString().split("T")[0]}
                        />
                      </div>
                    </div>
                    <button
                      className="hover:bg-blue-500
        bg-[#ef7e1b] text-white
        h-[44px] px-5
        rounded-[8px]
        flex items-center justify-center cursor-pointer
        w-full
      "
                      onClick={applyCustomCreatedDateRange}
                    >
                      Apply Custom Range
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}
        {/* New Updated Date Range Filter */}
        <div
          className={`relative ${
            rolePermissions !== "ALL" ? "col-span-2 md:col-span-1" : ""
          }`}
          ref={updatedDateRangeDropdownRef}
        >
          <button
            className="relative
          appearance-none
          h-[36px] md:h-[44px] lg:h-[44px]
          pl-2 pr-10 md:pr-15 lg:pr-15
          w-full md:min-w-[120px] lg:min-w-[120px]
          bg-white border border-[#E9EAEA]
          rounded-[8px]
          text-[#242729] text-[8px] md:text-base lg:text-sm
          focus:outline-none cursor-pointer"
            onMouseDown={(e) => {
              e.stopPropagation();
              setUpdatedDateRangeDropdownOpen((open) => !open);
            }}
          >
            <div className="flex items-center whitespace-nowrap ">
              {updatedTimeRange === "all" && "Updated"}
              {updatedTimeRange === "7days" && "Last 7 Days"}
              {updatedTimeRange === "30days" && "Last 30 Days"}
              {updatedTimeRange === "90days" && "Last 90 Days"}
              {updatedTimeRange === "custom" && (
                <span className="text-[10px] whitespace-nowrap">
                  {`${formatDateForDisplay(
                    customUpdatedDateRange.fromDate
                  )} - ${formatDateForDisplay(customUpdatedDateRange.toDate)}`}
                </span>
              )}
            </div>
            <img
              src="/caret-down.svg"
              alt=""
              aria-hidden="true"
              className="
          pointer-events-none
          absolute right-2 md:right-3 lg:right-3
          top-1/2 -translate-y-1/2
          w-4 h-4
        "
            />
          </button>

          {updatedDateRangeDropdownOpen && (
            <div className="absolute right-0 mt-2 w-72 bg-white border border-gray-200 rounded-lg shadow-lg z-10 cursor-pointer">
              <div className="px-4 pt-3  text-[#4B5563]">
                <p className="text-sm font-medium">Select Range</p>
              </div>

              <div className="p-2">
                {/* Predefined ranges */}
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    updatedTimeRange === "all"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  } cursor-pointer`}
                  onClick={() => handleUpdatedTimeRangeChange("all")}
                >
                  <span>All Dates</span>
                  {updatedTimeRange === "all" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}
                </button>
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    updatedTimeRange === "7days"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  } cursor-pointer`}
                  onClick={() => handleUpdatedTimeRangeChange("7days")}
                >
                  <span>Last 7 Days</span>
                  {updatedTimeRange === "7days" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}
                </button>
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    updatedTimeRange === "30days"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  } cursor-pointer`}
                  onClick={() => handleUpdatedTimeRangeChange("30days")}
                >
                  <span>Last 30 Days</span>
                  {updatedTimeRange === "30days" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}
                </button>
                <button
                  className={`flex items-center justify-between w-full px-3 py-2 text-sm text-left rounded-md ${
                    updatedTimeRange === "90days"
                      ? "bg-[#E7EFF8] text-[#ef7e1b]"
                      : "hover:bg-gray-100"
                  } cursor-pointer`}
                  onClick={() => handleUpdatedTimeRangeChange("90days")}
                >
                  <span>Last 90 Days</span>
                  {updatedTimeRange === "90days" && (
                    <FaCheck className="h-4 w-4 text-[#ef7e1b]" />
                  )}
                </button>

                <div className="border-t border-gray-200 my-2"></div>

                {/* Custom date range */}
                <div className="px-3 py-2">
                  <p className="text-sm font-medium text-[#4B5563] mb-2">
                    Custom Range
                  </p>
                  <div className="grid grid-cols-2 gap-2 mb-3">
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">
                        From
                      </label>
                      <input
                        type="date"
                        className="w-full h-[48px] text-sm px-2 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                        value={
                          customUpdatedDateRange.fromDate
                            ? customUpdatedDateRange.fromDate
                                .toISOString()
                                .split("T")[0]
                            : ""
                        }
                        onChange={(e) =>
                          handleCustomUpdatedDateChange(
                            "fromDate",
                            e.target.value
                          )
                        }
                        max={
                          customUpdatedDateRange.toDate
                            ? customUpdatedDateRange.toDate
                                .toISOString()
                                .split("T")[0]
                            : new Date().toISOString().split("T")[0]
                        }
                      />
                    </div>
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">
                        To
                      </label>
                      <input
                        type="date"
                        className="w-full h-[48px] text-sm px-2 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                        value={
                          customUpdatedDateRange.toDate
                            ? customUpdatedDateRange.toDate
                                .toISOString()
                                .split("T")[0]
                            : ""
                        }
                        onChange={(e) =>
                          handleCustomUpdatedDateChange(
                            "toDate",
                            e.target.value
                          )
                        }
                        min={
                          customUpdatedDateRange.fromDate
                            ? customUpdatedDateRange.fromDate
                                .toISOString()
                                .split("T")[0]
                            : ""
                        }
                        max={new Date().toISOString().split("T")[0]}
                      />
                    </div>
                  </div>
                  <button
                    className="hover:bg-blue-500
        bg-[#ef7e1b] text-white
        h-[44px] px-5
        rounded-[8px]
        flex items-center justify-center cursor-pointer
        w-full
      "
                    onClick={applyCustomUpdatedDateRange}
                  >
                    Apply Custom Range
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* Search Results Info */}
      {searchTerm && (
        <div className="mb-4 text-sm text-[#4B5563]">
          Showing {filteredLeads.length} results for "{searchTerm}"
        </div>
      )}

      {/* Lead List Table */}
      <div className="hidden md:block w-full flex-grow overflow-x-auto overflow-y-hidden relative custom-scrollbar ">
        <table className="w-full min-w-[1800px] border-collapse">
          <thead>
            <tr className="text-left text-[#4B5563]">
              {hasBulkAssignPermission && (
                <th className="py-4 px-6 font-medium text-sm w-12">
                  <input
                    type="checkbox"
                    checked={
                      selectedLeads.length === currentLeads.length &&
                      currentLeads.length > 0
                    }
                    onChange={toggleSelectAll}
                    className="w-4 h-4 rounded border-[#E9EAEA] cursor-pointer"
                  />
                </th>
              )}
              <th className="py-4 px-6 font-medium text-sm whitespace-nowrap">
                Lead ID
              </th>
              <th className="py-4 px-6 font-medium text-sm whitespace-nowrap">
                Lead Name
              </th>
              <th className="py-4 px-6 font-medium text-sm">Email</th>
              <th className="py-4 px-6 font-medium text-sm">Contact</th>
              <th className="py-4 px-6 font-medium text-sm">City</th>
              <th className="py-4 px-6 font-medium text-sm">WhatsApp</th>
              <th className="py-4 px-6 font-medium text-sm">Requirements</th>
              <th className="py-4 px-6 font-medium text-sm">Status</th>
              <th className="py-4 px-6 font-medium text-sm whitespace-nowrap">
                Assigned User
              </th>
              {rolePermissions === "ALL" && (
                <th className="py-4 px-6 font-medium text-sm">Created</th>
              )}
              <th className="py-4 px-6 font-medium text-sm">Updated</th>
              <th className="py-4 px-6 font-medium text-sm whitespace-nowrap">
                Follow Up
              </th>
              {(permissionsForLeadsModule.includes("edit") ||
                permissionsForLeadsModule.includes("delete")) && (
                <th className="py-4 px-6 font-medium text-sm">Action</th>
              )}
            </tr>
          </thead>
          <tbody>
            {currentLeads.length === 0 ? (
              <tr>
                <td
                  colSpan="15"
                  className="py-8 px-6 text-center text-[#4B5563]"
                >
                  {searchTerm
                    ? "No leads found matching your search."
                    : "No leads available."}
                </td>
              </tr>
            ) : (
              currentLeads.map((lead) => {
                const isStatusMenuOpen = openStatusMenu === lead.customer_id;
                return (
                  <tr
                    key={lead.customer_id}
                    className="border-t border-[#E5E7EB]"
                  >
                    {hasBulkAssignPermission && (
                      <td className="py-4 px-6 w-12">
                        <input
                          type="checkbox"
                          checked={selectedLeads.includes(lead.customer_id)}
                          onChange={() => toggleLeadSelection(lead.customer_id)}
                          className="w-4 h-4 rounded border-[#E9EAEA] cursor-pointer bg-[#E9EAEA]"
                        />
                      </td>
                    )}
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.customer_id}
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      <div
                        className="flex items-center gap-3 group cursor-pointer"
                        onClick={() => handleEdit(lead)}
                      >
                        <div className="w-9 h-9 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden group-hover:bg-blue-100 group-hover:shadow-md group-hover:shadow-blue-300 transition-all duration-200">
                          {lead.profile_pic ? (
                            <img
                              src={lead.profile_pic}
                              alt={lead.customer_name}
                              className="w-full h-full object-cover"
                              onError={(e) => {
                                e.target.onerror = null;
                                e.target.src = "/dummyavatar.jpeg";
                              }}
                            />
                          ) : (
                            <img
                              src="/dummyavatar.jpeg"
                              alt={lead.customer_name}
                              className="w-full h-full object-cover"
                            />
                          )}
                        </div>
                        <div className="flex flex-col">
                          <span className="text-[#1F2837] font-medium group-hover:text-blue-600 transition-colors">
                            {lead.customer_name}
                          </span>
                        </div>
                      </div>
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.email}
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.contact}
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {(() => {
                        let parsedAddress = null;
                        if (
                          lead.city &&
                          typeof lead.city === "string" &&
                          lead.city.trim().startsWith("{")
                        ) {
                          try {
                            parsedAddress = JSON.parse(lead.city);
                          } catch (e) {
                            // ignore
                          }
                        } else if (lead.city && typeof lead.city === "object") {
                          parsedAddress = lead.city;
                        }
                        // Only show city if present and not empty
                        if (
                          parsedAddress &&
                          parsedAddress.city &&
                          parsedAddress.city.trim() !== ""
                        ) {
                          return parsedAddress.city;
                        }
                        // If not a JSON, but a plain string (legacy), show only if not empty and not a JSON string
                        if (
                          lead.city &&
                          typeof lead.city === "string" &&
                          lead.city.trim() !== "" &&
                          !lead.city.trim().startsWith("{")
                        ) {
                          return lead.city;
                        }
                        return "";
                      })()}
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.whatsapp_number}
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.requirements}
                    </td>
                    <td className="py-4 px-6 max-w-xs overflow-hidden truncate">
                      <div className="relative inline-block">
                        <span
                          className={`
                            px-3 py-1 rounded-lg text-sm
                            flex items-center gap-2
                            ${
                              lead.status_name === "Fresh List"
                                ? "bg-[#27AE60] text-white"
                                : lead.status_name === "Follow Up"
                                ? "bg-[#ef7e1b] text-white"
                                : lead.status_name === "Get Call Back Us"
                                ? "bg-[#FFFBEB] text-[#D97706]"
                                : lead.status_name === "Contact In Future"
                                ? "bg-[#FFF8DD] text-[#F1C40F]"
                                : lead.status_name === "Next Day Payments"
                                ? "bg-[#27AE60] text-white"
                                : lead.status_name === "Quote Send"
                                ? "bg-[#ef7e1b] text-white"
                                : lead.status_name === "Call Back"
                                ? "bg-[#FFFBEB] text-[#D97706]"
                                : lead.status_name === "Construction"
                                ? "bg-[#FFF8DD] text-[#F1C40F]"
                                : lead.status_name === "NPC"
                                ? "bg-[#27AE60] text-white"
                                : lead.status_name === "Switch off"
                                ? "bg-[#ef7e1b] text-white"
                                : lead.status_name === "Not Reachable"
                                ? "bg-[#FFFBEB] text-[#D97706]"
                                : lead.status_name === "Quotation"
                                ? "bg-[#FFF8DD] text-[#ff0000]"
                                : lead.status_name === "Converted Client"
                                ? "bg-[#093d6e] text-white"
                                : "bg-[#173f12] text-white"
                            }
                          `}
                        >
                          {lead.status_name}
                        </span>
                      </div>
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {lead.assigned_to}
                    </td>
                    {rolePermissions === "ALL" && (
                      <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                        {formatDateTimeForTable(lead.created)}
                      </td>
                    )}
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {formatDateTimeForTable(lead.updated)}
                    </td>
                    <td className="py-4 px-6 text-sm text-[#4B5563] max-w-xs overflow-hidden truncate">
                      {formatDateTimeForTable(lead.follow_up_date)}
                    </td>
                    {(permissionsForLeadsModule.includes("edit") ||
                      permissionsForLeadsModule.includes("delete")) && (
                      <td className="py-4 px-6 relative">
                        <button
                          onClick={() => toggleDropdown(lead.customer_id)}
                          className="p-2 text-[#4B5563] hover:bg-blue-200 hover:text-white rounded-full transition-colors cursor-pointer"
                        >
                          <TbDotsVertical className="w-4 h-4" />
                        </button>
                        {activeDropdown === lead.customer_id && (
                          <div className="relative">
                            <div
                              data-dropdown-id={lead.customer_id}
                              className="absolute left-3 w-24 rounded-md shadow-md bg-gradient-to-br from-white to-[#E7F4FF] z-10 overflow-hidden"
                            >
                              <div className="">
                                {permissionsForLeadsModule.includes("edit") && (
                                  <button
                                    onClick={() => handleEdit(lead)}
                                    className="group flex items-center px-2 py-1 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors first:rounded-t-md cursor-pointer"
                                  >
                                    <svg
                                      xmlns="http://www.w3.org/2000/svg"
                                      width="24"
                                      height="24"
                                      viewBox="0 0 24 24"
                                      className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                    >
                                      <path
                                        fill="currentColor"
                                        d="M4 14v-2h7v2zm0-4V8h11v2zm0-4V4h11v2zm9 14v-3.075l6.575-6.55l3.075 3.05L16.075 20zm7.5-6.575l-.925-.925zm-6 5.075h.95l3.025-3.05l-.45-.475l-.475-.45l-3.05 3.025zm3.525-3.525l-.475-.45l.925.925z"
                                      />
                                    </svg>
                                    <span className="group-hover:text-white transition-colors">
                                      Edit
                                    </span>
                                  </button>
                                )}

                                <svg
                                  className="w-full h-[1px]"
                                  viewBox="0 0 100 1"
                                  preserveAspectRatio="none"
                                  xmlns="http://www.w3.org/2000/svg"
                                >
                                  <polygon
                                    points="0,0 50,1 100,0"
                                    fill="#E5E7EB"
                                  />
                                </svg>

                                {permissionsForLeadsModule.includes(
                                  "delete"
                                ) && (
                                  <button
                                    onClick={() =>
                                      handleDelete(lead.customer_id)
                                    }
                                    className="group flex items-center px-2 py-1 text-sm text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors last:rounded-b-md cursor-pointer"
                                  >
                                    <svg
                                      xmlns="http://www.w3.org/2000/svg"
                                      width="24"
                                      height="24"
                                      viewBox="0 0 24 24"
                                      className="mr-2 w-4 h-4 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                    >
                                      <path
                                        fill="currentColor"
                                        d="M7.616 20q-.672 0-1.144-.472T6 18.385V6H5V5h4v-.77h6V5h4v1h-1v12.385q0 .69-.462 1.153T16.384 20zM17 6H7v12.385q0 .269.173.442t.443.173h8.769q.23 0 .423-.192t.192-.424zM9.808 17h1V8h-1zm3.384 0h1V8h-1zM7 6v13z"
                                      />
                                    </svg>
                                    <span className="group-hover:text-white transition-colors">
                                      Delete
                                    </span>
                                  </button>
                                )}
                              </div>
                            </div>
                          </div>
                        )}
                      </td>
                    )}
                  </tr>
                );
              })
            )}
          </tbody>
        </table>
      </div>

      {/* Lead List Cards for Mobile */}
      <div className="md:hidden w-full space-y-6 pb-24 flex-grow overflow-x-auto">
        {currentLeads.length === 0 ? (
          <div className="py-12 px-6 text-center">
            <div className="w-16 h-16 mx-auto mb-4  rounded-full flex items-center justify-center">
              <svg
                className="w-8 h-8 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth="1.5"
                  d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-5.5a2.5 2.5 0 00-2.5 2.5v.5a2 2 0 01-2 2h-3a2 2 0 01-2-2v-.5a2.5 2.5 0 00-2.5-2.5H4"
                />
              </svg>
            </div>
            <p className="text-gray-500 font-medium">
              {searchTerm
                ? "No leads found matching your search."
                : "No leads available."}
            </p>
          </div>
        ) : (
          currentLeads.map((lead) => {
            const isStatusMenuOpen = openStatusMenu === lead.customer_id;
            return (
              <div
                key={lead.customer_id}
                className="bg-white rounded-2xl border border-gray-100 hover:border-gray-200 transition-all duration-300 hover:shadow-lg cursor-pointer"
              >
                {/* Header Section */}
                <div className="p-4 sm:p-6 border-b border-gray-50">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-2 sm:space-x-4">
                      {hasBulkAssignPermission && (
                        <input
                          type="checkbox"
                          checked={selectedLeads.includes(lead.customer_id)}
                          onChange={() => toggleLeadSelection(lead.customer_id)}
                          className="w-5 h-5 rounded border-gray-300 text-gray-900 focus:ring-gray-500 focus:ring-2"
                        />
                      )}

                      <div
                        className="flex items-center space-x-3 group cursor-pointer"
                        onClick={() => handleEdit(lead)}
                      >
                        <div className="w-12 h-12 rounded-full bg-gray-100 overflow-hidden ring-1 ring-gray-200 group-hover:bg-blue-100 group-hover:shadow-md group-hover:shadow-blue-300 transition-all duration-200">
                          {lead.profile_pic ? (
                            <img
                              src={lead.profile_pic}
                              alt={lead.customer_name}
                              className="w-full h-full object-cover"
                              onError={(e) => {
                                e.target.onerror = null;
                                e.target.src = "/dummyavatar.jpeg";
                              }}
                            />
                          ) : (
                            <img
                              src="/dummyavatar.jpeg"
                              alt={lead.customer_name}
                              className="w-full h-full object-cover"
                            />
                          )}
                        </div>

                        <div>
                          <h3 className="text-base font-semibold text-gray-900 whitespace-nowrap group-hover:text-blue-600 transition-colors">
                            {lead.customer_name}
                          </h3>
                          <p className="text-xs text-gray-500">{lead.email}</p>
                          {rolePermissions === "ALL" && (
                            <div className="flex flex-col gap-1 mt-1">
                              <div className="flex items-center gap-2">
                                <span className="inline-block px-2 py-0.5 rounded bg-blue-50 text-blue-700 text-[11px] font-medium">
                                  Created
                                </span>
                                <span className=" text-[10px] text-gray-500 font-mono ">
                                  {formatDateTimeForTable(lead.created)}
                                </span>
                              </div>
                              {lead.updated &&
                                lead.updated !== lead.created && (
                                  <div className="flex items-center gap-2">
                                    <span className="inline-block px-2 py-0.5 rounded bg-green-50 text-green-700 text-[11px] font-medium">
                                      Updated
                                    </span>
                                    <span className=" text-[10px] text-gray-500 font-mono">
                                      {formatDateTimeForTable(lead.updated)}
                                    </span>
                                  </div>
                                )}
                            </div>
                          )}
                        </div>
                      </div>
                    </div>

                    {/* Actions Menu */}
                    {(permissionsForLeadsModule.includes("edit") ||
                      permissionsForLeadsModule.includes("delete")) && (
                      <div className="relative">
                        <button
                          onClick={() => toggleDropdown(lead.customer_id)}
                          className="p-1 text-[#4B5563] rounded-full hover:bg-gray-100 cursor-pointer"
                        >
                          <TbDotsVertical className="w-4 h-4" />
                        </button>

                        {activeDropdown === lead.customer_id && (
                          <div className="absolute right-0 mt-1 w-24 sm:w-28 rounded-md shadow-md bg-gradient-to-br from-white to-[#E7F4FF] z-20 overflow-hidden">
                            <div>
                              {/* EDIT button */}
                              {permissionsForLeadsModule.includes("edit") && (
                                <button
                                  onClick={() => handleEdit(lead)}
                                  className="group flex items-center px-3 py-2 text-xs text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors first:rounded-t-md cursor-pointer"
                                >
                                  <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="16"
                                    height="16"
                                    viewBox="0 0 24 24"
                                    className="mr-2 w-3 h-3 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                  >
                                    <path
                                      fill="currentColor"
                                      d="M4 14v-2h7v2zm0-4V8h11v2zm0-4V4h11v2zm9 14v-3.075l6.575-6.55l3.075 3.05L16.075 20zm7.5-6.575l-.925-.925zm-6 5.075h.95l3.025-3.05l-.45-.475l-.475-.45l-3.05 3.025zm3.525-3.525l-.475-.45l.925.925z"
                                    />
                                  </svg>
                                  <span className="group-hover:text-white transition-colors">
                                    Edit
                                  </span>
                                </button>
                              )}

                              {/* Tapered separator */}
                              <svg
                                className="w-full h-[1px]"
                                viewBox="0 0 100 1"
                                preserveAspectRatio="none"
                                xmlns="http://www.w3.org/2000/svg"
                              >
                                <polygon
                                  points="0,0 50,1 100,0"
                                  fill="#E5E7EB"
                                />
                              </svg>

                              {/* DELETE button */}
                              {permissionsForLeadsModule.includes("delete") && (
                                <button
                                  onClick={() => handleDelete(lead.customer_id)}
                                  className="group flex items-center px-3 py-2 text-xs text-[#4B5563] hover:bg-[#ee7f1b] w-full transition-colors last:rounded-b-md cursor-pointer"
                                >
                                  <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="16"
                                    height="16"
                                    viewBox="0 0 24 24"
                                    className="mr-2 w-3 h-3 fill-current text-[#4B5563] group-hover:text-white transition-colors"
                                  >
                                    <path
                                      fill="currentColor"
                                      d="M7.616 20q-.672 0-1.144-.472T6 18.385V6H5V5h4v-.77h6V5h4v1h-1v12.385q0 .69-.462 1.153T16.384 20zM17 6H7v12.385q0 .269.173.442t.443.173h8.769q.23 0 .423-.192t.192-.424zM9.808 17h1V8h-1zm3.384 0h1V8h-1zM7 6v13z"
                                    />
                                  </svg>
                                  <span className="group-hover:text-white transition-colors">
                                    Delete
                                  </span>
                                </button>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>

                {/* Details Section */}
                <div className="p-3 sm:p-4 space-y-3">
                  {/* Contact & WhatsApp Row */}
                  <div className="grid grid-cols-2 gap-2">
                    <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200 cursor-pointer">
                      <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                        <svg
                          className="w-3 h-3 text-gray-600"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="1.5"
                            d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                          />
                        </svg>
                      </div>
                      <div className="min-w-0 flex-1 ">
                        <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                          Contact
                        </p>
                        <p className="text-[10px] ml-1 text-gray-900">
                          {lead.contact}
                        </p>
                      </div>
                    </div>

                    <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200 cursor-pointer">
                      <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                        <svg
                          className="w-3 h-3 text-gray-600"
                          fill="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.465 3.488" />
                        </svg>
                      </div>
                      <div className="min-w-0 flex-1">
                        <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide ">
                          WhatsApp
                        </p>
                        <p className="text-[10px] ml-1 text-gray-900">
                          {lead.whatsapp_number}
                        </p>
                      </div>
                    </div>
                  </div>

                  {/* City & Source Row */}
                  <div className="grid grid-cols-2 gap-2">
                    <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200 cursor-pointer">
                      <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                        <svg
                          className="w-3 h-3 text-gray-600"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="1.5"
                            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                          />
                        </svg>
                      </div>
                      <div className="min-w-0 flex-1">
                        <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide ">
                          City
                        </p>
                        <p className="text-[10px] ml-1 text-gray-900">
                          {(() => {
                            let parsedAddress = null;
                            if (
                              lead.city &&
                              typeof lead.city === "string" &&
                              lead.city.trim().startsWith("{")
                            ) {
                              try {
                                parsedAddress = JSON.parse(lead.city);
                              } catch (e) {
                                // ignore
                              }
                            } else if (
                              lead.city &&
                              typeof lead.city === "object"
                            ) {
                              parsedAddress = lead.city;
                            }
                            // Only show city if present and not empty
                            if (
                              parsedAddress &&
                              parsedAddress.city &&
                              parsedAddress.city.trim() !== ""
                            ) {
                              return parsedAddress.city;
                            }
                            // If not a JSON, but a plain string (legacy), show only if not empty and not a JSON string
                            if (
                              lead.city &&
                              typeof lead.city === "string" &&
                              lead.city.trim() !== "" &&
                              !lead.city.trim().startsWith("{")
                            ) {
                              return lead.city;
                            }
                            return "";
                          })()}
                        </p>
                      </div>
                    </div>

                    <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200 cursor-pointer">
                      <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                        <svg
                          className="w-3 h-3 text-gray-600"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="1.5"
                            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
                          />
                        </svg>
                      </div>
                      <div className="min-w-0 flex-1">
                        <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide ">
                          Source
                        </p>
                        <p className="text-[10px] ml-1 text-gray-900">
                          {lead.source}
                        </p>
                      </div>
                    </div>
                  </div>

                  {/* Assigned To & Follow Up Row */}
                  <div className="grid grid-cols-2 gap-2">
                    <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200 cursor-pointer">
                      <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                        <svg
                          className="w-3 h-3 text-gray-600"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="1.5"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                          />
                        </svg>
                      </div>
                      <div className="min-w-0 flex-1">
                        <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide ">
                          Assigned User
                        </p>
                        <p className="text-[10px] ml-1 text-gray-900 whitespace-nowrap">
                          {lead.assigned_to}
                        </p>
                      </div>
                    </div>

                    <div className="flex items-center space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200 cursor-pointer">
                      <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                        <svg
                          className="w-3 h-3 text-gray-600"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="1.5"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                          />
                        </svg>
                      </div>
                      <div className="min-w-0 flex-1">
                        <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                          Follow Up
                        </p>
                        <p className="text-[10px] ml-1 text-gray-900 whitespace-nowrap">
                          {formatDateTimeForTable(lead.follow_up_date)}
                        </p>
                      </div>
                    </div>
                  </div>
                  {/* Requirements */}
                  <div className="flex items-start space-x-1 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200 cursor-pointer">
                    <div className="w-7 h-7 bg-white rounded-md flex items-center justify-center shadow-sm">
                      <svg
                        className="w-3 h-3 text-gray-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="1.5"
                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                        />
                      </svg>
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-[10px] ml-1 font-medium text-gray-500 uppercase tracking-wide">
                        Requirements
                      </p>
                      <p className="text-[10px] ml-1 text-gray-900 leading-relaxed">
                        {lead.requirements}
                      </p>
                    </div>
                  </div>
                </div>

                {/* Status Footer */}
                <div className="px-3 sm:px-4 py-3  border-t border-gray-100 rounded-b-2xl">
                  <div className="flex items-center justify-between">
                    <span className="text-xs font-medium text-gray-600">
                      Status
                    </span>
                    <span
                      className={`
                  px-3 py-1 rounded-full text-xs font-medium
                  ${
                    lead.status_name === "Fresh List"
                      ? "bg-emerald-100 text-emerald-800"
                      : lead.status_name === "Follow Up"
                      ? "bg-blue-100 text-blue-800"
                      : lead.status_name === "Get Call Back Us"
                      ? "bg-amber-100 text-amber-800"
                      : lead.status_name === "Contact In Future"
                      ? "bg-yellow-100 text-yellow-800"
                      : lead.status_name === "Next Day Payments"
                      ? "bg-emerald-100 text-emerald-800"
                      : lead.status_name === "Quote Send"
                      ? "bg-blue-100 text-blue-800"
                      : lead.status_name === "Call Back"
                      ? "bg-amber-100 text-amber-800"
                      : lead.status_name === "Construction"
                      ? "bg-yellow-100 text-yellow-800"
                      : lead.status_name === "NPC"
                      ? "bg-emerald-100 text-emerald-800"
                      : lead.status_name === "Switch off"
                      ? "bg-blue-100 text-blue-800"
                      : lead.status_name === "Not Reachable"
                      ? "bg-amber-100 text-amber-800"
                      : lead.status_name === "Quotation"
                      ? "bg-red-100 text-red-800"
                      : lead.status_name === "Converted Client"
                      ? "bg-[#093d6e] text-white"
                      : "bg-[#173f12] text-white"
                  }
                `}
                    >
                      {lead.status_name}
                    </span>
                  </div>
                </div>
              </div>
            );
          })
        )}
      </div>
      {/* Edit Modal */}
      {isModalOpen && (
        <div className="fixed inset-0 flex items-center justify-center z-50">
          {/* Frosted overlay */}
          <div
            className="absolute inset-0 bg-gray-50/10 backdrop-blur-sm border border-white/30"
            onClick={() => setIsModalOpen(false)}
          />

          {/* Glassmorphism modal container */}
          <div
            className="
        w-11/12 max-w-[1000px] max-h-[90vh] overflow-y-auto p-6 md:p-8
        rounded-2xl
        bg-gradient-to-br from-[#FFFFFF] to-[#E6F4FF]
        shadow-lg
        relative z-10 custom-scrollbar
      "
          >
            {/* Close button */}
            <button
              onClick={() => setIsModalOpen(false)}
              className="absolute top-6 right-6 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors cursor-pointer"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13 1L1 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M1 1L13 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Modal title */}
            <h2 className="text-[24px] sm:text-[29px] font-medium text-[#1F2837] mb-8">
              Edit Lead
            </h2>

            {/* Form */}
            <form onSubmit={handleSubmit}>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                {/* Profile Picture Upload */}
                <div className="md:col-span-1 flex flex-col items-center">
                  <label className="block text-[#4B5563] text-[16px] mb-4 w-full">
                    Profile Picture
                  </label>
                  <div className="relative w-32 h-32">
                    <img
                      src={
                        imagePreview ||
                        editingLead?.profile_pic ||
                        "/dummyavatar.jpeg"
                      }
                      alt="Profile Preview"
                      className="w-32 h-32 rounded-full object-cover border-2 border-white shadow-md"
                    />
                    <label
                      htmlFor="edit-file-upload"
                      className="absolute bottom-1 right-1 bg-[#ef7e1b] text-white rounded-full p-2 cursor-pointer hover:bg-blue-600 transition-colors"
                    >
                      <FiEdit className="w-4 h-4" />
                      <input
                        type="file"
                        name="profile_pic"
                        id="edit-file-upload"
                        onChange={handleInputChange}
                        className="hidden"
                        accept="image/*"
                      />
                    </label>
                  </div>
                  <p className="text-xs text-gray-500 mt-2">
                    PNG, JPG, GIF up to 10MB
                  </p>
                </div>

                {/* Customer Name and Details */}
                <div className="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                  {/* Customer Name */}
                  <div className="space-y-2 md:col-start-1 md:row-start-1">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Lead Name
                    </label>
                    <div className="relative">
                      <input
                        type="text"
                        name="name"
                        value={formData.name}
                        onChange={handleInputChange}
                        className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                        required
                      />
                    </div>
                  </div>

                  {/* Email */}
                  <div className="space-y-2 md:col-start-2 md:row-start-1">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Email
                    </label>
                    <input
                      type="email"
                      name="email"
                      value={formData.email}
                      onChange={handleInputChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                    />
                  </div>

                  {/* Contact */}
                  <div className="space-y-2 md:col-start-1 md:row-start-2">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Contact
                    </label>
                    <input
                      type="text"
                      name="phoneno"
                      value={formData.phoneno}
                      onChange={handleInputChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                      required
                    />
                  </div>

                  {/* WhatsApp */}
                  <div className="space-y-2 md:col-start-2 md:row-start-2">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      WhatsApp
                    </label>
                    <input
                      type="text"
                      name="whatsapp"
                      value={formData.whatsapp}
                      onChange={handleInputChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                    />
                  </div>

                  {/* Requirements */}
                  <div className="space-y-2 md:col-start-2 md:row-start-3">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Requirements
                    </label>
                    <input
                      type="text"
                      name="requirements"
                      value={formData.requirements}
                      onChange={handleInputChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                    />
                  </div>

                  {/* Source */}
                  <div className="space-y-2 md:col-start-1 md:row-start-3">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Source
                    </label>
                    <input
                      type="text"
                      name="source"
                      value={formData.source}
                      onChange={handleInputChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                    />
                  </div>

                  {/* Follow Up */}
                  <div className="space-y-2 md:col-start-1 md:row-start-4">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Follow Up
                    </label>
                    <div className="flex gap-2">
                      {" "}
                      {/* Added flex container */}
                      <input
                        type="date"
                        name="follow_up_date_input"
                        value={formData.follow_up_date_input}
                        onChange={handleInputChange}
                        className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] placeholder:text-sm"
                      />
                      <input
                        type="time"
                        name="follow_up_time_input"
                        value={formData.follow_up_time_input}
                        onChange={handleInputChange}
                        className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] placeholder:text-sm"
                      />
                    </div>
                  </div>

                  {/* Status */}
                  <div className="space-y-2 md:col-start-2 md:row-start-4">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Status
                    </label>
                    <div className="relative" ref={editStatusDropdownRef}>
                      <button
                        type="button"
                        onClick={() =>
                          setIsEditStatusDropdownOpen(!isEditStatusDropdownOpen)
                        }
                        className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] text-left flex items-center justify-between cursor-pointer"
                      >
                        <span>
                          {statuses.find(
                            (status) =>
                              status.status_name
                                .toLowerCase()
                                .replace(/\s+/g, "_") === formData.status
                          )?.status_name || "Select Status"}
                        </span>
                        <svg
                          className={`w-4 h-4 transition-transform ${
                            isEditStatusDropdownOpen ? "rotate-180" : ""
                          }`}
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M19 9l-7 7-7-7"
                          />
                        </svg>
                      </button>
                      {isEditStatusDropdownOpen && (
                        <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
                          {statuses.map((status) => (
                            <button
                              key={status.status_id}
                              type="button"
                              onClick={() => {
                                handleInputChange({
                                  target: {
                                    name: "status",
                                    value: status.status_name
                                      .toLowerCase()
                                      .replace(/\s+/g, "_"),
                                  },
                                });
                                setIsEditStatusDropdownOpen(false);
                              }}
                              className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                            >
                              {status.status_name}
                            </button>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Assign To */}
                  {user?.role === "admin" && (
                    <div className="space-y-2 md:col-span-2 md:row-start-5">
                      <label className="block text-[#4B5563] text-[16px] mb-2">
                        Assign To
                      </label>
                      <div className="relative" ref={assignToDropdownRef}>
                        <button
                          type="button"
                          onClick={() =>
                            setIsAssignToDropdownOpen(!isAssignToDropdownOpen)
                          }
                          className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] text-left flex items-center justify-between cursor-pointer"
                        >
                          <span>
                            {users.find(
                              (user) => user.name === formData.assigned_to
                            )?.name || "Select User"}
                          </span>
                          <svg
                            className={`w-4 h-4 transition-transform ${
                              isAssignToDropdownOpen ? "rotate-180" : ""
                            }`}
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M19 9l-7 7-7-7"
                            />
                          </svg>
                        </button>
                        {isAssignToDropdownOpen && (
                          <div className="absolute custom-scrollbar top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto">
                            {users.map((user) => (
                              <button
                                key={user.id}
                                type="button"
                                onClick={() => {
                                  handleInputChange({
                                    target: {
                                      name: "assigned_to",
                                      value: user.name,
                                    },
                                  });
                                  setIsAssignToDropdownOpen(false);
                                }}
                                className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                              >
                                {user.name}
                              </button>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Message */}
                  <div className="space-y-2 md:col-start-1 md:col-span-2 md:row-start-6">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Message
                    </label>
                    <textarea
                      name="message"
                      value={formData.message}
                      onChange={handleInputChange}
                      rows="2"
                      className="w-full min-h-[58px] p-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] resize-none"
                    />
                  </div>

                  {/* Address */}
                  <div className="space-y-1 md:col-span-2 md:row-start-7">
                    <label className="block text-[#4B5563] text-sm font-medium">
                      Address
                    </label>
                    <div className="w-full rounded-[12px]  border border-white/20 flex flex-col">
                      <input
                        type="text"
                        name="blockUnitStreetName"
                        value={formData.blockUnitStreetName}
                        onChange={handleInputChange}
                        className="w-full h-[44px] px-3 flex items-center text-[#545454] border-b  bg-[#E7EFF8]/60 border border-white/20 outline-none rounded-t-[12px]"
                        placeholder="Block/Unit/Street Name"
                      />

                      {/* State and City Dropdowns */}
                      <div className="grid grid-cols-2  w-full">
                        {/* State Dropdown */}
                        <div className="relative" ref={stateDropdownRef}>
                          <input
                            type="text"
                            name="stateSearch"
                            value={formData.state || stateSearchTerm}
                            onChange={handleStateSearchChange}
                            onFocus={() =>
                              countrySearchTerm && setStateDropdownOpen(true)
                            }
                            onBlur={() => setStateDropdownOpen(false)}
                            className={`w-full h-[44px] px-4 border border-white/20 outline-none text-[#545454] placeholder-[#545454] text-[16px] ${
                              !countrySearchTerm
                                ? "bg-gray-300 cursor-not-allowed opacity-60"
                                : "bg-[#E7EFF8]/60"
                            }`}
                            placeholder="Select State"
                            disabled={!countrySearchTerm}
                            readOnly={!countrySearchTerm}
                            autoComplete="off"
                          />
                          {stateDropdownOpen && countrySearchTerm && (
                            <div className="absolute custom-scrollbar z-10 w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                              {filteredStates.length > 0 ? (
                                filteredStates.map((state) => (
                                  <div
                                    key={state.isoCode}
                                    className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                    onClick={() => handleStateSelect(state)}
                                    onMouseDown={(e) => e.preventDefault()}
                                  >
                                    {state.name}
                                  </div>
                                ))
                              ) : (
                                <div className="p-3 text-gray-500">
                                  No states found
                                </div>
                              )}
                            </div>
                          )}
                        </div>

                        {/* City Dropdown */}
                        <div className="relative" ref={cityDropdownRef}>
                          <input
                            type="text"
                            name="citySearch"
                            value={formData.city || citySearchTerm}
                            onChange={handleCitySearchChange}
                            onFocus={() =>
                              stateSearchTerm && setCityDropdownOpen(true)
                            }
                            onBlur={() => setCityDropdownOpen(false)}
                            className={`w-full h-[44px] px-4 border border-white/20 outline-none text-[#545454] placeholder-[#545454] text-[16px] ${
                              !stateSearchTerm
                                ? "bg-gray-300 cursor-not-allowed opacity-60"
                                : "bg-[#E7EFF8]/60"
                            }`}
                            placeholder="Select City"
                            disabled={!stateSearchTerm}
                            readOnly={!stateSearchTerm}
                            autoComplete="off"
                          />
                          {cityDropdownOpen && stateSearchTerm && (
                            <div className="absolute z-10 custom-scrollbar w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                              {filteredCities.length > 0 ? (
                                filteredCities.map((city) => (
                                  <div
                                    key={city.name}
                                    className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                    onClick={() => handleCitySelect(city)}
                                    onMouseDown={(e) => e.preventDefault()}
                                  >
                                    {city.name}
                                  </div>
                                ))
                              ) : (
                                <div className="p-3 text-gray-500">
                                  No cities found
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Pincode and Country */}
                      <div className="grid grid-cols-2  w-full">
                        {/* Pincode Input */}
                        <input
                          type="text"
                          name="pincode"
                          value={formData.pincode}
                          onChange={handleInputChange}
                          className="w-full h-[44px] px-3 flex items-center text-[#545454] bg-[#E7EFF8]/60 border border-white/20 rounded-bl-[12px] outline-none"
                          placeholder="Pincode"
                        />
                        {/* Country Dropdown */}
                        <div className="relative" ref={countryDropdownRef}>
                          <input
                            type="text"
                            name="countrySearch"
                            value={formData.country || countrySearchTerm}
                            onChange={handleCountrySearchChange}
                            onFocus={() => setCountryDropdownOpen(true)}
                            onBlur={() => setCountryDropdownOpen(false)}
                            className="w-full h-[44px] px-4 bg-[#E7EFF8]/60 border border-white/20  outline-none text-[#545454] placeholder-[#545454] rounded-br-[12px] text-[16px]"
                            placeholder="Select Country"
                            autoComplete="off"
                          />
                          {countryDropdownOpen && (
                            <div className="absolute z-10 custom-scrollbar w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                              {filteredCountries.length > 0 ? (
                                filteredCountries.map((country) => (
                                  <div
                                    key={country.isoCode}
                                    className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                    onClick={() => handleCountrySelect(country)}
                                    onMouseDown={(e) => e.preventDefault()}
                                  >
                                    {country.name}
                                  </div>
                                ))
                              ) : (
                                <div className="p-3 text-gray-500">
                                  No countries found
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Save button */}
              <div className="mt-10 flex justify-center gap-2 lg:ml-64 items-center">
                {/* Back Button */}
                <button
                  type="button"
                  onClick={(e) => handleEditBack(e)}
                  className={`flex items-center justify-center w-10 h-[46px] rounded-[10px] border border-gray-300
                    ${
                      editingLeadIndex === 0 || editingLeadIndex === null
                        ? " text-gray-400 cursor-not-allowed border border-gray-300"
                        : "bg-[#ef7e1b] text-white hover:bg-[#ee7f1b] transition-colors"
                    }
                  `}
                  disabled={editingLeadIndex === 0 || editingLeadIndex === null}
                  title="Back"
                >
                  <svg
                    width="18"
                    height="18"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    viewBox="0 0 24 24"
                  >
                    <path d="M15 18l-6-6 6-6" />
                  </svg>
                </button>
                {/* Cancel button (existing) */}
                <button
                  type="button"
                  onClick={() => setIsModalOpen(false)}
                  className="w-full md:w-[207px] h-[46px] text-[#ef7e1b] border border-[#0e4053] rounded-[10px] hover:bg-[#ee7f1b] hover:text-white transition-colors cursor-pointer"
                >
                  Cancel
                </button>
                {/* Save button (existing) */}
                <button
                  type="submit"
                  className="w-full md:w-[207px] h-[46px] bg-[#ef7e1b] text-white rounded-[10px] hover:bg-[#ee7f1b] transition-colors cursor-pointer"
                  onClick={(e) => handleSubmit(e, "save")}
                >
                  Save
                </button>
                {/* Save and Next Button */}
                <button
                  type="button"
                  onClick={(e) => handleEditNext(e)}
                  className={`flex items-center justify-center w-14 h-[46px] rounded-[10px]
                    ${
                      editingLeadIndex === null ||
                      editingLeadIndex === filteredLeads.length - 1
                        ? " text-gray-400 cursor-not-allowed border border-gray-300"
                        : "bg-[#ef7e1b] text-white hover:bg-[#ee7f1b] transition-colors"
                    }
                  `}
                  title="Save and next"
                  disabled={
                    editingLeadIndex === null ||
                    editingLeadIndex === filteredLeads.length - 1
                  }
                >
                  <span className="sr-only">Save and next</span>
                  <svg
                    width="18"
                    height="18"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    viewBox="0 0 24 24"
                  >
                    <path d="M9 6l6 6-6 6" />
                  </svg>
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Create Modal */}
      {isModalOpenCreate && (
        <div className="fixed inset-0 flex items-center justify-center z-50">
          {/* Frosted overlay */}
          <div
            className="absolute inset-0 bg-gray-50/10 backdrop-blur-sm border border-white/30"
            onClick={() => setIsModalOpenCreate(false)}
          />

          {/* Glassmorphism modal container */}
          <div
            className="
        w-11/12 max-w-[1000px] max-h-[90vh] overflow-y-auto p-6 md:p-8
        rounded-2xl
        bg-gradient-to-br from-[#FFFFFF] to-[#E6F4FF]
        shadow-lg
        relative z-10 custom-scrollbar
      "
          >
            {/* Close button */}
            <button
              onClick={() => setIsModalOpenCreate(false)}
              className="absolute top-6 right-6 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors cursor-pointer"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13 1L1 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M1 1L13 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Modal title */}
            <h2 className="text-[24px] sm:text-[29px] font-medium text-[#1F2837] mb-8">
              Create Lead
            </h2>

            {/* Form */}
            <form onSubmit={handleCreateSubmit}>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                {/* Profile Picture Upload */}
                <div className="md:col-span-1 flex flex-col items-center">
                  <label className="block text-[#4B5563] text-[16px] mb-4 w-full">
                    Profile Picture
                  </label>
                  <div className="relative w-32 h-32">
                    <img
                      alt="Profile Preview"
                      className="w-32 h-32 rounded-full object-cover border-2 border-white shadow-md"
                      src={createImagePreview || "/dummyavatar.jpeg"}
                    />
                    <label
                      htmlFor="file-upload"
                      className="absolute bottom-1 right-1 bg-[#ef7e1b] text-white rounded-full p-2 cursor-pointer hover:bg-blue-600 transition-colors"
                    >
                      <svg
                        stroke="currentColor"
                        fill="none"
                        strokeWidth="2"
                        viewBox="0 0 24 24"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        className="w-4 h-4"
                        height="1em"
                        width="1em"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                      <input
                        id="file-upload"
                        className="hidden"
                        accept="image/*"
                        type="file"
                        onChange={handleProfilePictureChange}
                      />
                    </label>
                  </div>
                  <p className="text-xs text-gray-500 mt-2">
                    PNG, JPG, GIF up to 10MB
                  </p>
                </div>

                {/* Customer Name */}
                <div className="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                  {/* Customer Name */}
                  <div className="space-y-2 md:col-start-1 md:row-start-1">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Lead Name
                    </label>
                    <div className="relative">
                      <input
                        type="text"
                        name="name"
                        value={createFormData.name}
                        onChange={handleCreateInputChange}
                        className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                        required
                      />
                    </div>
                  </div>

                  {/* Email */}
                  <div className="space-y-2 md:col-start-2 md:row-start-1">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Email
                    </label>
                    <input
                      type="email"
                      name="email"
                      value={createFormData.email}
                      onChange={handleCreateInputChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                    />
                  </div>

                  {/* Contact */}
                  <div className="space-y-2 md:col-start-1 md:row-start-2">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Contact
                    </label>
                    <input
                      type="text"
                      name="phoneno"
                      value={createFormData.phoneno}
                      onChange={handleCreateInputChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                      required
                    />
                  </div>

                  {/* WhatsApp */}
                  <div className="space-y-2 md:col-start-2 md:row-start-2">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      WhatsApp
                    </label>
                    <input
                      type="text"
                      name="whatsapp"
                      value={createFormData.whatsapp}
                      onChange={handleCreateInputChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                    />
                  </div>

                  {/* Requirements */}
                  <div className="space-y-2 md:col-start-2 md:row-start-3">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Requirements
                    </label>
                    <input
                      type="text"
                      name="requirements"
                      value={createFormData.requirements}
                      onChange={handleCreateInputChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                    />
                  </div>

                  {/* Source */}
                  <div className="space-y-2 md:col-start-1 md:row-start-3">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Source
                    </label>
                    <input
                      type="text"
                      name="source"
                      value={createFormData.source}
                      onChange={handleCreateInputChange}
                      className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                    />
                  </div>

                  {/* Follow Up */}
                  <div className="space-y-2 md:col-start-1 md:row-start-4">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Follow Up
                    </label>
                    <div className="flex gap-2">
                      {" "}
                      {/* Added flex container */}
                      <input
                        type="date"
                        name="follow_up_date_input"
                        value={createFormData.follow_up_date_input}
                        onChange={handleCreateInputChange}
                        className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] placeholder:text-sm"
                      />
                      <input
                        type="time"
                        name="follow_up_time_input"
                        value={createFormData.follow_up_time_input}
                        onChange={handleCreateInputChange}
                        className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] placeholder:text-sm"
                      />
                    </div>
                  </div>

                  {/* Status */}
                  <div className="space-y-2 md:col-start-2 md:row-start-4">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Status
                    </label>
                    {renderStatusDropdown()}
                  </div>

                  {/* Assign To */}
                  {user?.role === "admin" && (
                    <div className="space-y-2 md:col-span-2 md:row-start-5">
                      <label className="block text-[#4B5563] text-[16px] mb-2">
                        Assign To
                      </label>
                      <div className="relative" ref={assignToDropdownRef}>
                        <button
                          type="button"
                          onClick={() =>
                            setIsAssignToDropdownOpen(!isAssignToDropdownOpen)
                          }
                          className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] text-left flex items-center justify-between cursor-pointer"
                        >
                          <span>
                            {users.find(
                              (user) => user.name === createFormData.assigned_to
                            )?.name || "Select User"}
                          </span>
                          <svg
                            className={`w-4 h-4 transition-transform ${
                              isAssignToDropdownOpen ? "rotate-180" : ""
                            }`}
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M19 9l-7 7-7-7"
                            />
                          </svg>
                        </button>
                        {isAssignToDropdownOpen && (
                          <div className="absolute custom-scrollbar top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto">
                            {users.map((user) => (
                              <button
                                key={user.id}
                                type="button"
                                onClick={() => {
                                  handleCreateInputChange({
                                    target: {
                                      name: "assigned_to",
                                      value: user.name,
                                    },
                                  });
                                  setIsAssignToDropdownOpen(false);
                                }}
                                className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                              >
                                {user.name}
                              </button>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Message */}
                  <div className="space-y-2 md:col-start-1 md:col-span-2 md:row-start-6">
                    <label className="block text-[#4B5563] text-[16px] mb-2">
                      Message
                    </label>
                    <textarea
                      name="message"
                      value={createFormData.message}
                      onChange={handleCreateInputChange}
                      rows="2"
                      className="w-full min-h-[58px] p-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] resize-none"
                    />
                  </div>

                  {/* Address */}
                  <div className="space-y-1 md:col-span-2 md:row-start-7">
                    <label className="block text-[#4B5563] text-sm font-medium">
                      Address
                    </label>
                    <div className="w-full rounded-[12px]  border border-white/20 flex flex-col">
                      <input
                        type="text"
                        name="blockUnitStreetName"
                        value={createFormData.blockUnitStreetName}
                        onChange={handleCreateInputChange}
                        className="w-full h-[44px] px-3 flex items-center text-[#545454] border-b  bg-[#E7EFF8]/60 border border-white/20 outline-none rounded-t-[12px]"
                        placeholder="Block/Unit/Street Name"
                      />

                      {/* State and City Dropdowns */}
                      <div className="grid grid-cols-2  w-full">
                        {/* State Dropdown */}
                        <div className="relative" ref={stateDropdownRef}>
                          <input
                            type="text"
                            name="stateSearch"
                            value={createFormData.state || stateSearchTerm}
                            onChange={handleStateSearchChange}
                            onFocus={() =>
                              countrySearchTerm && setStateDropdownOpen(true)
                            }
                            onBlur={() => setStateDropdownOpen(false)}
                            className={`w-full h-[44px] px-4 border border-white/20 outline-none text-[#545454] placeholder-[#545454] text-[16px] ${
                              !countrySearchTerm
                                ? "bg-gray-300 cursor-not-allowed opacity-60"
                                : "bg-[#E7EFF8]/60"
                            }`}
                            placeholder="Select State"
                            disabled={!countrySearchTerm}
                            readOnly={!countrySearchTerm}
                            autoComplete="off"
                          />
                          {stateDropdownOpen && countrySearchTerm && (
                            <div className="absolute custom-scrollbar z-10 w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                              {filteredStates.length > 0 ? (
                                filteredStates.map((state) => (
                                  <div
                                    key={state.isoCode}
                                    className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                    onClick={() => handleStateSelect(state)}
                                    onMouseDown={(e) => e.preventDefault()}
                                  >
                                    {state.name}
                                  </div>
                                ))
                              ) : (
                                <div className="p-3 text-gray-500">
                                  No states found
                                </div>
                              )}
                            </div>
                          )}
                        </div>

                        {/* City Dropdown */}
                        <div className="relative" ref={cityDropdownRef}>
                          <input
                            type="text"
                            name="citySearch"
                            value={createFormData.city || citySearchTerm}
                            onChange={handleCitySearchChange}
                            onFocus={() =>
                              stateSearchTerm && setCityDropdownOpen(true)
                            }
                            onBlur={() => setCityDropdownOpen(false)}
                            className={`w-full h-[44px] px-4 border border-white/20 outline-none text-[#545454] placeholder-[#545454] text-[16px] ${
                              !stateSearchTerm
                                ? "bg-gray-300 cursor-not-allowed opacity-60"
                                : "bg-[#E7EFF8]/60"
                            }`}
                            placeholder="Select City"
                            disabled={!stateSearchTerm}
                            readOnly={!stateSearchTerm}
                            autoComplete="off"
                          />
                          {cityDropdownOpen && stateSearchTerm && (
                            <div className="absolute custom-scrollbar z-10 w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                              {filteredCities.length > 0 ? (
                                filteredCities.map((city) => (
                                  <div
                                    key={city.name}
                                    className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                    onClick={() => handleCitySelect(city)}
                                    onMouseDown={(e) => e.preventDefault()}
                                  >
                                    {city.name}
                                  </div>
                                ))
                              ) : (
                                <div className="p-3 text-gray-500">
                                  No cities found
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Pincode and Country */}
                      <div className="grid grid-cols-2  w-full">
                        {/* Pincode Input */}
                        <input
                          type="text"
                          name="pincode"
                          value={createFormData.pincode}
                          onChange={handleCreateInputChange}
                          className="w-full h-[44px] px-3 flex items-center text-[#545454] bg-[#E7EFF8]/60 border border-white/20 rounded-bl-[12px] outline-none"
                          placeholder="Pincode"
                        />
                        {/* Country Dropdown */}
                        <div className="relative" ref={countryDropdownRef}>
                          <input
                            type="text"
                            name="countrySearch"
                            value={createFormData.country || countrySearchTerm}
                            onChange={handleCountrySearchChange}
                            onFocus={() => setCountryDropdownOpen(true)}
                            onBlur={() => setCountryDropdownOpen(false)}
                            className="w-full h-[44px] px-4 bg-[#E7EFF8]/60 border border-white/20  outline-none text-[#545454] placeholder-[#545454] rounded-br-[12px] text-[16px]"
                            placeholder="Select Country"
                            autoComplete="off"
                          />
                          {countryDropdownOpen && (
                            <div className="absolute z-10 custom-scrollbar w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                              {filteredCountries.length > 0 ? (
                                filteredCountries.map((country) => (
                                  <div
                                    key={country.isoCode}
                                    className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                    onClick={() => handleCountrySelect(country)}
                                    onMouseDown={(e) => e.preventDefault()}
                                  >
                                    {country.name}
                                  </div>
                                ))
                              ) : (
                                <div className="p-3 text-gray-500">
                                  No countries found
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Save button */}
              <div className="mt-10 flex justify-center">
                <button
                  type="submit"
                  className="w-full md:w-[207px] h-[46px] bg-[#ef7e1b] text-white rounded-[10px] hover:bg-[#ee7f1b] transition-colors lg:mr-20 cursor-pointer"
                >
                  Save
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Pagination Controls */}
      {filteredLeads.length > 0 && (
        <div className="flex justify-center pt-7 mt-auto">
          <div className="flex items-center gap-2 lg:gap-3">
            {/* Previous Page */}
            <button
              onClick={handlePreviousPage}
              disabled={currentPage === 1}
              className={`w-[44px] h-[44px] lg:w-[52px] lg:h-[52px]
          rounded-full border border-[#7E7B7B]
          flex items-center justify-center transition-colors
          ${
            currentPage === 1
              ? "opacity-50 cursor-not-allowed"
              : "group hover:bg-blue-200 hover:border-white hover:text-white"
          }
        `}
            >
              <svg
                width="33"
                height="32"
                viewBox="0 0 33 32"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                className={`stroke-current text-[#7E7B7B]
            ${currentPage === 1 ? "" : "group-hover"}
          `}
              >
                <path
                  d="M23.1667 5.33398L12.06 13.3873C9.09198 15.5407 9.09198 16.462 12.06 18.614L23.1667 26.6673"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Page Info */}
            <div className="flex items-center gap-2 text-sm lg:text-base text-[#4B5563]">
              <span>
                Page {currentPage} of {totalPages}
              </span>
              <span>({filteredLeads.length} total)</span>
            </div>

            {/* Next Page */}
            <button
              onClick={handleNextPage}
              disabled={currentPage === totalPages}
              className={`w-[44px] h-[44px] lg:w-[52px] lg:h-[52px]
          rounded-full border border-[#7E7B7B]
          flex items-center justify-center transition-colors
          ${
            currentPage === totalPages
              ? "opacity-50 cursor-not-allowed"
              : "group hover:bg-blue-200 hover:border-white hover:text-white"
          }
        `}
            >
              <svg
                width="52"
                height="52"
                viewBox="0 0 52 52"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                className={`stroke-current text-[#7E7B7B]
            ${currentPage === totalPages ? "" : "group-hover:text-white"}
          `}
              >
                <circle cx="26" cy="26" r="25.5" strokeWidth="1" />
                <path
                  d="M20.8333 15.334L31.94 23.3873C34.908 25.5407 34.908 26.462 31.94 28.614L20.8333 36.6673"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>
          </div>
        </div>
      )}

      {/* Import CSV Modal */}
      {isImportModalOpen && (
        <div className="fixed inset-0 flex items-center justify-center z-50">
          {/* Frosted overlay */}
          <div
            className="absolute inset-0 bg-gray-50/10 backdrop-blur-sm border border-white/30"
            onClick={() => {
              setIsImportModalOpen(false);
              setSelectedFile(null); // Clear selected file on modal close
            }}
          />

          {/* Glassmorphism modal container */}
          <div
            className="
              w-11/12 max-w-[500px] max-h-[90vh] overflow-y-auto p-6 md:p-8
              rounded-2xl
              bg-gradient-to-br from-[#FFFFFF] to-[#E6F4FF]
              shadow-lg
              relative z-10 custom-scrollbar
            "
          >
            {/* Close button */}
            <button
              onClick={() => {
                setIsImportModalOpen(false);
                setSelectedFile(null); // Clear selected file on modal close
              }}
              className="absolute top-6 right-6 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors cursor-pointer"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13 1L1 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M1 1L13 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Modal title */}
            <h2 className="text-[24px] font-medium text-[#1F2837] mb-6">
              Import Leads
            </h2>

            {/* File Type Radio Buttons */}
            <div className="flex items-center gap-6 mb-6">
              <label className="flex items-center gap-2">
                <input
                  type="radio"
                  name="importFileType"
                  value="csv"
                  checked={importFileType === "csv"}
                  onChange={() => setImportFileType("csv")}
                  className="accent-[#0e4053]"
                />
                <span>CSV</span>
              </label>
              <label className="flex items-center gap-2">
                <input
                  type="radio"
                  name="importFileType"
                  value="xls"
                  checked={importFileType === "xls"}
                  onChange={() => setImportFileType("xls")}
                  className="accent-[#0e4053]"
                />
                <span>XLS</span>
              </label>
            </div>

            {/* File Upload Area */}
            <div
              className="border-2 border-dashed border-[#A0AEC0] rounded-lg p-6 text-center cursor-pointer hover:border-[#2798FF] transition-colors"
              onDragOver={(e) => e.preventDefault()}
              onDrop={(e) => {
                e.preventDefault();
                handleFileChange(e);
              }}
              onClick={() =>
                document.getElementById("import-file-upload").click()
              }
            >
              <input
                type="file"
                id="import-file-upload"
                accept={importFileType === "csv" ? ".csv" : ".xls"}
                className="hidden"
                onChange={handleFileChange}
              />
              <FiUpload className="mx-auto w-10 h-10 text-[#A0AEC0] mb-3" />
              <p className="text-[#4B5563] text-sm">
                {selectedFile
                  ? `Selected file: ${selectedFile.name}`
                  : `Drag & drop your ${importFileType.toUpperCase()} file here, or click to browse`}
              </p>
              <p className="text-xs text-gray-500 mt-1">
                Only {importFileType === "csv" ? ".csv" : ".xls"} files are
                supported
              </p>
            </div>
            <h6 className="text-xs text-right text-[#1F2837] mt-3">
              <button
                type="button"
                onClick={
                  importFileType === "csv"
                    ? handleDownloadSample
                    : async () => {
                        let loadingAlert;
                        try {
                          loadingAlert = Swal.fire({
                            title: "Downloading Sample...",
                            allowOutsideClick: false,
                            didOpen: () => {
                              Swal.showLoading();
                            },
                          });

                          const response = await api.get(
                            "/leadssample-downloadxls",
                            {
                              responseType: "blob", // Important for file downloads
                            }
                          );

                          await loadingAlert.close();

                          if (response.data) {
                            const url = window.URL.createObjectURL(
                              new Blob([response.data])
                            );
                            const link = document.createElement("a");
                            link.href = url;
                            link.setAttribute("download", "sample_leads.xls");
                            document.body.appendChild(link);
                            link.click();
                            link.parentNode.removeChild(link);
                            await Swal.fire({
                              icon: "success",
                              title: "Download Successful!",
                              text: "Sample leads XLS downloaded.",
                              confirmButtonColor: "#2798FF",
                            });
                          } else {
                            throw new Error(
                              "Failed to download sample: No data received."
                            );
                          }
                        } catch (err) {
                          if (loadingAlert) {
                            await loadingAlert.close();
                          }
                          Swal.fire({
                            icon: "error",
                            title: "Download Failed",
                            text:
                              err.message ||
                              "An error occurred during download.",
                            confirmButtonColor: "#DD6B55",
                          });
                        }
                      }
                }
                className="text-[#2798FF] hover:underline focus:outline-none focus:ring-2 focus:ring-[#2798FF] rounded-md px-2 py-1 -mr-2 transition-colors duration-200 cursor-pointer"
              >
                {importFileType === "csv"
                  ? "View Sample File CSV"
                  : "View Sample File XLS"}
              </button>
            </h6>

            {/* Submit button */}
            <div className="mt-8 flex justify-center">
              <button
                onClick={uploadCsvFile}
                disabled={!selectedFile}
                className={`w-full md:w-[207px] h-[46px] bg-[#ef7e1b] text-white rounded-[10px] transition-colors ${
                  !selectedFile
                    ? "opacity-50 cursor-not-allowed"
                    : "hover:bg-[#ee7f1b]"
                }`}
              >
                Import
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Export CSV Modal */}
      {isExportModalOpen && (
        <div className="fixed inset-0 flex items-center justify-center z-50">
          {/* Frosted overlay */}
          <div
            className="absolute inset-0 bg-gray-50/10 backdrop-blur-sm border border-white/30"
            onClick={() => setIsExportModalOpen(false)}
          />

          {/* Glassmorphism modal container */}
          <div
            className="
        w-11/12 max-w-[400px] max-h-[90vh] overflow-y-auto p-6 md:p-8
        rounded-2xl
        bg-gradient-to-br from-[#FFFFFF] to-[#E6F4FF]
        shadow-lg
        relative z-10 custom-scrollbar
      "
          >
            {/* Close button */}
            <button
              onClick={() => setIsExportModalOpen(false)}
              className="absolute top-6 right-6 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors cursor-pointer"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13 1L1 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M1 1L13 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Modal title */}
            <h2 className="text-[24px] font-medium text-[#1F2837] mb-6">
              Export Leads
            </h2>

            {/* File Type Radio Buttons */}
            <div className="flex items-center gap-6 mb-8">
              <label className="flex items-center gap-2">
                <input
                  type="radio"
                  name="exportFileType"
                  value="csv"
                  checked={exportFileType === "csv"}
                  onChange={() => setExportFileType("csv")}
                  className="accent-[#0e4053]"
                />
                <span>CSV</span>
              </label>
              <label className="flex items-center gap-2">
                <input
                  type="radio"
                  name="exportFileType"
                  value="xls"
                  checked={exportFileType === "xls"}
                  onChange={() => setExportFileType("xls")}
                  className="accent-[#0e4053]"
                />
                <span>XLS</span>
              </label>
            </div>

            {/* Export Button */}
            <div className="mt-8 flex justify-center">
              <button
                onClick={async () => {
                  setIsExportModalOpen(false);
                  await handleExportCsv();
                }}
                className="w-full md:w-[207px] h-[46px] bg-[#ef7e1b] text-white rounded-[10px] hover:bg-[#ee7f1b] transition-colors"
              >
                Export
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Bulk Assign Modal */}
      {isBulkAssignModalOpen && (
        <div className="fixed inset-0 flex items-center justify-center z-50">
          {/* Frosted overlay */}
          <div
            className="absolute inset-0 bg-gray-50/10 backdrop-blur-sm border border-white/30"
            onClick={() => {
              setIsBulkAssignModalOpen(false);
              setSelectedAssignee("");
              setAssigneeSearchTerm("");
              setBulkEditStatusSearch("");
              setBulkEditSelectedStatus(null);
              setBulkDeleteMessage(false);
              setBulkDeleteFollowUp(false);
              setBulkAssignUser(false);
              setBulkChangeStatus(false);
            }}
          />

          {/* Glassmorphism modal container */}
          <div
            className="
              w-11/12 max-w-[700px] max-h-[98vh]  p-6 md:p-8
              rounded-2xl
              bg-gradient-to-br from-[#FFFFFF] to-[#E6F4FF]
              shadow-lg
              relative z-10 custom-scrollbar overflow-y-auto

            "
          >
            {/* Close button */}
            <button
              onClick={() => {
                setIsBulkAssignModalOpen(false);
                setSelectedAssignee("");
                setAssigneeSearchTerm("");
                setBulkEditStatusSearch("");
                setBulkEditSelectedStatus(null);
                setBulkDeleteMessage(false);
                setBulkDeleteFollowUp(false);
                setBulkAssignUser(false);
                setBulkChangeStatus(false);
              }}
              className="absolute top-6 right-6 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors cursor-pointer"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 14 14"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13 1L1 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M1 1L13 13"
                  stroke="#1F2837"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>

            {/* Modal title */}
            <h2 className="text-[24px] font-medium text-[#1F2837] mb-8 text-left">
              Bulk Edit Leads
            </h2>

            {/* Bulk Edit Options Section */}
            <div className="rounded-xl p-6 shadow-sm border border-[#E9EAEA] mb-5">
              <h3 className="text-lg font-semibold text-[#ef7e1b] mb-4">
                Bulk Edit Options
              </h3>
              <div className="space-y-4">
                {/* Assign User Option */}
                <div
                  className={`border-2 rounded-lg transition-all duration-300 ${
                    bulkAssignUser
                      ? "border-blue-400 bg-blue-50"
                      : "border-gray-200 hover:border-gray-300"
                  } ${
                    selectedLeads.length === 0
                      ? "cursor-not-allowed opacity-50"
                      : ""
                  }`}
                >
                  <label className="flex items-center cursor-pointer p-4">
                    <input
                      type="checkbox"
                      className="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                      checked={bulkAssignUser}
                      onChange={(e) => setBulkAssignUser(e.target.checked)}
                      disabled={selectedLeads.length === 0}
                    />
                    <span className="ml-4 flex flex-col">
                      <span className="font-semibold text-gray-700">
                        Assign to User
                      </span>
                      <span className="text-sm text-gray-500">
                        Assign selected leads to a specific user.
                      </span>
                    </span>
                  </label>

                  {/* Configuration section that expands when checkbox is checked */}
                  {bulkAssignUser && (
                    <div className="px-4 pb-4 border-t border-gray-200 pt-4">
                      <label className="block text-[#4B5563] text-[16px] mb-2">
                        Select User:
                      </label>
                      <div
                        className="relative"
                        ref={bulkEditAssigneeDropdownRef}
                      >
                        <input
                          type="text"
                          placeholder="Search and select user..."
                          className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                          value={assigneeSearchTerm}
                          onChange={(e) => {
                            setAssigneeSearchTerm(e.target.value);
                            setIsAssigneeDropdownOpen(true);
                          }}
                          onFocus={() => setIsAssigneeDropdownOpen(true)}
                        />
                        {isAssigneeDropdownOpen && (
                          <div className="absolute custom-scrollbar top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto">
                            {users
                              .filter((user) =>
                                user.name
                                  .toLowerCase()
                                  .includes(assigneeSearchTerm.toLowerCase())
                              )
                              .map((user) => (
                                <button
                                  key={user.id}
                                  type="button"
                                  onClick={() => {
                                    setSelectedAssignee(user.name);
                                    setAssigneeSearchTerm(user.name);
                                    setIsAssigneeDropdownOpen(false);
                                  }}
                                  className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454]"
                                >
                                  {user.name}
                                </button>
                              ))}
                            {users.filter((user) =>
                              user.name
                                .toLowerCase()
                                .includes(assigneeSearchTerm.toLowerCase())
                            ).length === 0 && (
                              <div className="px-3 py-2 text-sm text-gray-500">
                                No users found.
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                </div>

                {/* Status Change Option */}
                <div
                  className={`border-2 rounded-lg transition-all duration-300 ${
                    bulkChangeStatus
                      ? "border-blue-400 bg-blue-50"
                      : "border-gray-200 hover:border-gray-300"
                  } ${
                    selectedLeads.length === 0
                      ? "cursor-not-allowed opacity-50"
                      : ""
                  }`}
                >
                  <label className="flex items-center cursor-pointer p-4">
                    <input
                      type="checkbox"
                      className="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                      checked={bulkChangeStatus}
                      onChange={(e) => setBulkChangeStatus(e.target.checked)}
                      disabled={selectedLeads.length === 0}
                    />
                    <span className="ml-4 flex flex-col">
                      <span className="font-semibold text-gray-700">
                        Change Status
                      </span>
                      <span className="text-sm text-gray-500">
                        Update the status for selected leads.
                      </span>
                    </span>
                  </label>

                  {/* Configuration section that expands when checkbox is checked */}
                  {bulkChangeStatus && (
                    <div className="px-4 pb-4 border-t border-gray-200 pt-4">
                      <label className="block text-[#4B5563] text-[16px] mb-2">
                        Select Status:
                      </label>
                      <div className="relative" ref={bulkEditStatusDropdownRef}>
                        <input
                          type="text"
                          placeholder="Search and select status..."
                          className="w-full h-[48px] px-3 rounded-[12px] bg-[#E7EFF8] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                          value={bulkEditStatusSearch}
                          onChange={(e) => {
                            setBulkEditStatusSearch(e.target.value);
                            setIsBulkEditStatusDropdownOpen(true);
                          }}
                          onFocus={() => setIsBulkEditStatusDropdownOpen(true)}
                        />
                        {isBulkEditStatusDropdownOpen && (
                          <div className="absolute top-full custom-scrollbar left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto">
                            {statuses
                              .filter((status) =>
                                status.status_name
                                  .toLowerCase()
                                  .includes(bulkEditStatusSearch.toLowerCase())
                              )
                              .map((status) => (
                                <button
                                  key={status.status_id}
                                  type="button"
                                  onClick={() => {
                                    setBulkEditSelectedStatus(status);
                                    setBulkEditStatusSearch(status.status_name);
                                    setIsBulkEditStatusDropdownOpen(false);
                                  }}
                                  className={`w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] ${
                                    bulkEditSelectedStatus &&
                                    bulkEditSelectedStatus.status_id ===
                                      status.status_id
                                      ? "bg-[#E7EFF8] text-[#ef7e1b] font-bold"
                                      : ""
                                  }`}
                                >
                                  {status.status_name}
                                </button>
                              ))}
                            {statuses.filter((status) =>
                              status.status_name
                                .toLowerCase()
                                .includes(bulkEditStatusSearch.toLowerCase())
                            ).length === 0 && (
                              <div className="px-3 py-2 text-sm text-gray-500">
                                No statuses found.
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* Bulk Delete Section */}
            <div className="rounded-xl p-6 shadow-sm border border-[#E9EAEA] mt-5">
              <h3 className="text-lg font-semibold text-[#DD6B55] mb-4">
                Bulk Delete Actions
              </h3>
              <div className="space-y-4">
                <label
                  className={`flex items-center cursor-pointer p-4 border-2 rounded-lg transition-colors ${
                    bulkDeleteMessage
                      ? "border-red-400 bg-red-50"
                      : "border-gray-200 hover:border-gray-300"
                  } ${
                    selectedLeads.length === 0
                      ? "cursor-not-allowed opacity-50"
                      : ""
                  }`}
                >
                  <input
                    type="checkbox"
                    className="h-5 w-5 rounded border-gray-300 text-red-600 focus:ring-red-500"
                    checked={bulkDeleteMessage}
                    onChange={(e) => setBulkDeleteMessage(e.target.checked)}
                    disabled={selectedLeads.length === 0}
                  />
                  <span className="ml-4 flex flex-col">
                    <span className="font-semibold text-gray-700">
                      Bulk Delete Message
                    </span>
                    <span className="text-sm text-gray-500">
                      Permanently delete messages for selected leads.
                    </span>
                  </span>
                </label>
                <label
                  className={`flex items-center cursor-pointer p-4 border-2 rounded-lg transition-colors ${
                    bulkDeleteFollowUp
                      ? "border-red-400 bg-red-50"
                      : "border-gray-200 hover:border-gray-300"
                  } ${
                    selectedLeads.length === 0
                      ? "cursor-not-allowed opacity-50"
                      : ""
                  }`}
                >
                  <input
                    type="checkbox"
                    className="h-5 w-5 rounded border-gray-300 text-red-600 focus:ring-red-500"
                    checked={bulkDeleteFollowUp}
                    onChange={(e) => setBulkDeleteFollowUp(e.target.checked)}
                    disabled={selectedLeads.length === 0}
                  />
                  <span className="ml-4 flex flex-col">
                    <span className="font-semibold text-gray-700">
                      Bulk Delete Follow-up Date
                    </span>
                    <span className="text-sm text-gray-500">
                      Remove the scheduled follow-up dates from selected leads.
                    </span>
                  </span>
                </label>
              </div>
            </div>
            <button
              onClick={handleBulkActionsSubmit}
              disabled={
                selectedLeads.length === 0 ||
                (!bulkDeleteMessage &&
                  !bulkDeleteFollowUp &&
                  !bulkAssignUser &&
                  !bulkChangeStatus)
              }
              className={`mt-6 w-full h-[44px] bg-[#ef7e1b] text-white rounded-[10px] transition-colors text-base font-medium shadow-sm ${
                selectedLeads.length === 0 ||
                (!bulkDeleteMessage &&
                  !bulkDeleteFollowUp &&
                  !bulkAssignUser &&
                  !bulkChangeStatus)
                  ? "opacity-50 cursor-not-allowed"
                  : "hover:bg-[#ee7f1b] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#0e4053]"
              }`}
            >
              Apply Selected Actions
            </button>

            {/* Info and spacing at the bottom */}
            <div className="mt-8 text-center text-[#4B5563] text-sm">
              {selectedLeads.length === 0 ? (
                <span>Select leads to enable bulk actions.</span>
              ) : (
                <span>
                  {selectedLeads.length} lead
                  {selectedLeads.length > 1 ? "s" : ""} selected.
                </span>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default CreateLeads;
</file>

<file path="src/pages/invoice/CreateInvoice.jsx">
import api from "@/api";
import React, { useState, useEffect, useRef, useMemo, useContext } from "react";
import Swal from "sweetalert2"; // Import SweetAlert2
import { Country, State, City } from "country-state-city";
import {
  Document,
  Page,
  Text,
  View as PDFView,
  StyleSheet,
  PDFDownloadLink,
  Image as PDFImage,
} from "@react-pdf/renderer";
import { useLocation } from "react-router-dom";
import { RxCross2 } from "react-icons/rx";

import { useAuth } from "../../auth/AuthContext";
import { SidebarContext } from "../../components/Layout";

// PDF Styles (pixel-perfect, Tailwind-inspired)

const convertImageUrlForPdf = (url) => {
  if (typeof url === "string" && url.includes("/public/")) {
    const filename = url.substring(url.lastIndexOf("/") + 1);
    const publicIndex = url.indexOf("/public/");
    if (publicIndex !== -1) {
      const baseUrl = url.substring(0, publicIndex);
      return `${baseUrl}/public/api/image-proxy/${filename}`;
    }
  }
  return url;
};

const formatDate = (dateString) => {
  if (!dateString) return "";
  try {
    // Try to parse "YYYY-MM-DD"
    if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
      const [year, month, day] = dateString.split("-");
      return `${day}/${month}/${year}`;
    }
    // Try to parse "DD MM YYYY"
    if (/^\d{2} \d{2} \d{4}$/.test(dateString)) {
      const [day, month, year] = dateString.split(" ");
      return `${day}/${month}/${year}`;
    }
    // Fallback: try Date parsing
    const date = new Date(dateString);
    if (!isNaN(date)) {
      const day = String(date.getDate()).padStart(2, "0");
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }
    return dateString;
  } catch (e) {
    console.error("Error formatting date:", e);
    return dateString;
  }
};

const parseDateToISO = (dateString) => {
  if (!dateString) return "";
  const parts = dateString.split(" ");
  if (parts.length === 3) {
    const day = parts[0];
    const month = parts[1];
    const year = parts[2];
    return `${year}-${month}-${day}`;
  }
  return dateString;
};

const InvoicePDF = ({
  invoiceData,
  serviceItems,
  organizationEmail,
  user,
  isGstEnabled,
  subTotal,
  cgstTotal,
  sgstTotal,
  igstTotal,
  totalGstPayable,
  grandTotal,
  balance,
  roundOffDecimal, // Pass this prop to PDF
}) => {
  // Calculate totalRowsCount for dynamic rowSpan in PDF, mirroring HTML logic
  let totalRowsCount = 1; // SUB TOTAL
  if (isGstEnabled) totalRowsCount += 4; // CGST, SGST, IGST, TOTAL GST PAYABLE
  totalRowsCount += 3; // GRAND TOTAL, Received Amount, Balance

  const pdfStyles = StyleSheet.create({
    page: {
      flexDirection: "column",
      backgroundColor: "#fff",
      padding: 16, // reduce padding for more content
      minHeight: "100vh",
      borderRadius: 16, // matches rounded-2xl
      fontFamily: "Helvetica",
      fontSize: 10, // base font size smaller
      maxHeight: 842, // A4 height in pt
      maxWidth: 595, // A4 width in pt
    },
    headerSection: {
      flexDirection: "row",
      marginBottom: 16, // reduce spacing
      alignItems: "flex-start",
      justifyContent: "space-between",
      marginTop: 5,
    },
    logo: {
      width: 158, // smaller logo
      height: 70,

      marginRight: 18, // tighter spacing
      objectFit: "cover",
    },
    companyInfo: {
      flexDirection: "column",
      flexGrow: 1,
    },
    companyName: {
      fontSize: 28, // smaller title
      fontWeight: "bold",
      color: "#2798FF", // text-[rgb(39,152,255)]
      marginBottom: 4,
    },
    address: {
      fontSize: 11,
      color: "#1F2937", // text-[rgb(31,41,55)]
      marginBottom: 1,
    },
    contactRow: {
      flexDirection: "row",
      gap: 8,
      marginBottom: 1,
      marginTop: 4,
    },
    contact: {
      fontSize: 11,
      color: "#1F2937",
      marginRight: 8,
    },
    invoiceTitle: {
      fontSize: 20,
      fontWeight: "bold",
      color: "#2798FF",
      textAlign: "right",
      marginTop: 15,
    },
    divider: {
      width: "100%",
      height: 1, // thinner divider
      backgroundColor: "#2798FF",
      marginVertical: 6,
    },
    detailsRow: {
      flexDirection: "row",
      justifyContent: "space-between",
      fontSize: 9,
      color: "#4B5563",
      marginBottom: 2,
    },
    sectionTitle: {
      fontWeight: "bold",
      fontSize: 12,
      color: "#4B5563",
      marginBottom: 4,
    },
    partyBlock: {
      flex: 1,
      paddingRight: 8, // tighter
      paddingLeft: 0,
      marginTop: 10,
    },
    partyBlockRight: {
      flex: 1,
      paddingLeft: 8,
      paddingRight: 0,
      marginTop: 10,
    },
    partyLabel: {
      fontWeight: "bold",
      fontSize: 12,
      color: "#4B5563",
      marginBottom: 4,
    },
    partyField: {
      fontSize: 10,
      color: "#1F2837",
      fontWeight: "600",
      marginBottom: 4,
    },
    partyAddress: {
      fontSize: 9,
      color: "#545454",
      marginBottom: 3,
    },
    partyContact: {
      fontSize: 9,
      color: "#545454",
      marginBottom: 3,
    },
    table: {
      width: "100%",
      marginTop: 0,
      borderWidth: 1,
      borderColor: "#E5E7EB",
      borderTopLeftRadius: 8,
      borderTopRightRadius: 8,
      borderBottomLeftRadius: 0,
      borderBottomRightRadius: 0,
      overflow: "hidden",
      marginBottom: 0,
    },
    tableHeader: {
      flexDirection: "row",
      backgroundColor: "#E7EFF8",
      color: "#4B5563",
      fontWeight: "bold",
      fontSize: 10,
      borderBottomWidth: 0,
      overflow: "hidden",
      marginTop: -1, // Overlap border with previous table
      marginBottom: 0, // Changed from 12 to 0 to remove gap with items
      borderTopWidth: 0, // No top border
      borderTopLeftRadius: 0,
      borderTopRightRadius: 0,
    },
    th: {
      padding: 4,
      borderRightWidth: 1,
      borderColor: "#E5E7EB",
      textAlign: "center",
      fontWeight: "500",
      fontSize: 9,
      // Remove any top/bottom border
      borderTopWidth: 0,
      borderBottomWidth: 0,
    },
    thDesc: { width: "50%", textAlign: "left" },
    thQty: { width: "10%", textAlign: "center" },
    thRate: { width: isGstEnabled ? "17%" : "27%", textAlign: "center" },
    thGst: { width: "10%", textAlign: "center" },
    thAmt: {
      width: "50%",
      textAlign: "right",
      // Remove border on the right to avoid double border with table outer border
      borderRightWidth: 0,
      alignItems: "flex-end", // <-- Add this
      display: "flex", // <-- And this
    },
    td: {
      padding: 4,
      borderRightWidth: 1,
      borderColor: "#E5E7EB",
      fontSize: 9,
      color: "#545454",
      textAlign: "center",
      // Remove any top/bottom border
      borderTopWidth: 0,
      borderBottomWidth: 0,
      // Add flex properties for vertical alignment.
      justifyContent: "center",
    },
    tdDesc: { width: "50%", textAlign: "left" },
    tdQty: { width: "10%", textAlign: "center" },
    tdRate: { width: isGstEnabled ? "17%" : "27%", textAlign: "center" },
    tdGst: { width: "10%", textAlign: "center" },
    tdAmt: {
      width: "50%",
      textAlign: "right",
      // Remove border on the right to avoid double border with table outer border
      borderRightWidth: 0,
    },
    tableRow: {
      flexDirection: "row",
      // Remove bottom border
      borderBottomWidth: 0,
      borderColor: "#E5E7EB",
      marginBottom: 0, // Reduce vertical gap between rows
      paddingTop: 0, // Remove any top padding
      paddingBottom: 0, // Remove any bottom padding
    },
    totalsBlock: {
      marginTop: 0,
      alignItems: "flex-end",
      flexDirection: "column",
      gap: 2,
    },
    totalRow: {
      flexDirection: "row",
      justifyContent: "flex-end",
      gap: 8,
      fontSize: 9,
      color: "#1F2837",
    },
    totalLabel: { fontWeight: "bold" },
    totalValue: { fontWeight: "bold" },
    bankBlock: {
      marginTop: 0,
      fontSize: 10,
      color: "#4B5563",
      width: "50%",
      paddingRight: 5,
    },
    bankBlockRight: {
      marginTop: 0,
      fontSize: 10,
      color: "#4B5563",
      width: "50%",
      textAlign: "right",
      paddingLeft: 0,
    },
    termsBlock: {
      marginTop: 0,
      fontSize: 8,
      color: "#4B5563",
      width: "50%",
      paddingRight: 8,
    },
    signBlock: {
      width: "50%",
      textAlign: "center",
      paddingLeft: 8,
    },
    seal: {
      width: 96,
      height: 96,
      margin: "0 auto 0 auto",
      objectFit: "contain",
    },
    signatory: {
      fontWeight: "bold",
      fontSize: 9,
      color: "#1F2837",
      textAlign: "center",
      marginTop: 0,
    },
    tableBody: {
      // New style for the table body container
      flexGrow: 1,
      flexDirection: "column",
    },
    totalsTable: {
      width: "100%",
      borderWidth: 1,
      borderColor: "#E5E7EB",
      borderTopLeftRadius: 0,
      borderTopRightRadius: 0,
      borderBottomLeftRadius: 8,
      borderBottomRightRadius: 8,
      overflow: "hidden",
      marginTop: -1, // Overlap border with previous table
      marginBottom: 12,
      borderTopWidth: 0, // No top border
    },
    totalsTableRow: {
      flexDirection: "row",

      // Remove borderTopWidth here as it will be applied to specific cells
      flexGrow: 1,
      minHeight: 28,
      alignItems: "stretch",
    },
    // New style for the label column when it spans Rate and GST
    totalsLabelColSpan: {
      width: "27%", // Combined width of RATE (16.6%) and GST (10%)
      textAlign: "right", // Align the text to the right
      borderRightWidth: 1, // Keep right border to separate from Amount
      borderColor: "#E5E7EB",
      padding: 4, // Match other cell padding
      borderLeftWidth: 1, // Add left border
      borderBottomWidth: 1, // Add bottom border here
    },

    // Existing totalsTdAmt (Amount column)
    totalsTdAmt: {
      width: "13.4%", // Matches amount column width
      textAlign: "right",
      borderRightWidth: 0,
      // Inherits padding and font from pdfStyles.td where applied
      borderBottomWidth: 1, // Add bottom border here
    },
    // Updated styles for the terms and conditions section
    termsColumn: {
      width: "50%",
      paddingRight: 8,
      fontSize: 8,
      color: "#4B5563",
      flexDirection: "column",
      justifyContent: "flex-start",
    },
    emptySpacerColumn: {
      // New style for the empty column between terms and totals
      width: "10%",
      backgroundColor: "#fff", // Explicitly white background for clarity in PDF
      borderColor: "#E5E7EB",
      borderLeftWidth: 0, // Remove left border
      borderRightWidth: 0, // Remove right border
      borderTopWidth: 0, // Add top border for visual separation from items table
    },
    totalsColumn: {
      width: "100%",
      borderLeftWidth: 0, // Keep left border to separate from empty column
      borderColor: "#E5E7EB",
      flexDirection: "column", // For individual total rows
      borderTopWidth: 0, // Add top border for visual separation from items table
    },
    // Redefine existing totals styles relative to their new parent (totalsColumn)
    // These will be percentages of 45% of the page. Original combined totals was 40% of page (26.6% label, 13.4% amount)
    // Now totalsColumn is 45% of page. So percentages are: label (26.6/40)*100 = 66.5%, amount (13.4/40)*100 = 33.5%
    totalsLabelRelativeWidth: { width: "70.5%" },
    totalsAmountRelativeWidth: { width: "40.5%" },
  });

  return (
    <Document>
      <Page size="A4" style={pdfStyles.page}>
        {/* Header */}
        <PDFView
          style={{ width: "100%", alignItems: "flex-end", marginBottom: 4 }}
        >
          <PDFImage
            src={"/invoice-text.png"}
            style={{ width: 60, height: 15 }}
            cache={false}
          />
        </PDFView>

        <PDFView style={pdfStyles.headerSection}>
          <PDFView style={{ flexDirection: "row", alignItems: "center" }}>
            {user?.profile_pic && user.profile_pic !== "" && (
              <PDFImage
                src={convertImageUrlForPdf(user.profile_pic)}
                style={pdfStyles.logo}
                cache={false}
              />
            )}
            <PDFView style={pdfStyles.companyInfo}>
              <Text style={pdfStyles.companyName}>
                {invoiceData.companyName}
              </Text>
              {/* Address block: match view mode */}
              {invoiceData.addressLine1 && (
                <Text style={pdfStyles.address}>
                  {invoiceData.addressLine1}
                </Text>
              )}
              {/* Combine City, State, Country, Pincode into one line */}
              {(invoiceData.addressLine2 ||
                invoiceData.companyPincode ||
                invoiceData.companyCountry) && (
                <Text style={pdfStyles.address}>
                  {invoiceData.addressLine2}
                  {invoiceData.addressLine2 &&
                    (invoiceData.companyCountry ||
                      invoiceData.companyPincode) &&
                    ", "}
                  {invoiceData.companyCountry}
                  {invoiceData.companyCountry && invoiceData.companyPincode
                    ? ", "
                    : ""}
                  {invoiceData.companyPincode}
                </Text>
              )}
              <PDFView style={pdfStyles.contactRow}>
                {organizationEmail && (
                  <Text style={pdfStyles.contact}>
                    Email: {organizationEmail}
                  </Text>
                )}
                <Text style={pdfStyles.contact}>
                  Mobile: {invoiceData.mobile}
                </Text>
              </PDFView>
            </PDFView>
          </PDFView>
          {/* <Text style={pdfStyles.invoiceTitle}>Invoice</Text> */}
        </PDFView>
        <PDFView style={pdfStyles.divider} />
        {/* Invoice Details */}
        <PDFView style={pdfStyles.detailsRow}>
          <Text>Invoice No.: {invoiceData.invoiceNo}</Text>
          <Text>Invoice Date: {formatDate(invoiceData.invoiceDate)}</Text>
        </PDFView>
        <PDFView style={pdfStyles.divider} />
        {/* Bill To / Ship To */}
        <PDFView
          style={{
            flexDirection: "row",
            justifyContent: "space-between",
            marginBottom: 32, // mb-8
          }}
        >
          {/* Bill To */}
          <PDFView style={pdfStyles.partyBlock}>
            <Text style={pdfStyles.partyLabel}>BILL TO</Text>
            <Text style={pdfStyles.partyField}>{invoiceData.billToName}</Text>
            {invoiceData.billToAddress?.blockUnitStreetName && (
              <Text style={pdfStyles.partyAddress}>
                {invoiceData.billToAddress.blockUnitStreetName}
              </Text>
            )}
            {(invoiceData.billToAddress?.state ||
              invoiceData.billToAddress?.city) && (
              <Text style={pdfStyles.partyAddress}>
                {invoiceData.billToAddress?.state}
                {invoiceData.billToAddress?.state &&
                invoiceData.billToAddress?.city
                  ? ", "
                  : ""}
                {invoiceData.billToAddress?.city}
              </Text>
            )}
            {(invoiceData.billToAddress?.pincode ||
              invoiceData.billToAddress?.country) && (
              <Text style={pdfStyles.partyAddress}>
                {invoiceData.billToAddress?.pincode}
                {invoiceData.billToAddress?.pincode &&
                invoiceData.billToAddress?.country
                  ? ", "
                  : ""}
                {invoiceData.billToAddress?.country}
              </Text>
            )}
            {invoiceData.billToEmail && (
              <Text style={pdfStyles.partyContact}>
                Email: {invoiceData.billToEmail}
              </Text>
            )}
            {invoiceData.billToPhone && (
              <Text style={pdfStyles.partyContact}>
                Mobile: {invoiceData.billToPhone}
              </Text>
            )}
            {invoiceData.billToAddress?.gstin && (
              <Text style={pdfStyles.partyContact}>
                GSTIN: {invoiceData.billToAddress.gstin}
              </Text>
            )}
          </PDFView>
          {/* Ship To */}
          <PDFView style={pdfStyles.partyBlockRight}>
            <Text style={pdfStyles.partyLabel}>SHIP TO</Text>
            <Text style={pdfStyles.partyField}>{invoiceData.shipToName}</Text>
            {invoiceData.shipToAddress?.blockUnitStreetName && (
              <Text style={pdfStyles.partyAddress}>
                {invoiceData.shipToAddress.blockUnitStreetName}
              </Text>
            )}
            {(invoiceData.shipToAddress?.state ||
              invoiceData.shipToAddress?.city) && (
              <Text style={pdfStyles.partyAddress}>
                {invoiceData.shipToAddress?.state}
                {invoiceData.shipToAddress?.state &&
                invoiceData.shipToAddress?.city
                  ? ", "
                  : ""}
                {invoiceData.shipToAddress?.city}
              </Text>
            )}
            {(invoiceData.shipToAddress?.pincode ||
              invoiceData.shipToAddress?.country) && (
              <Text style={pdfStyles.partyAddress}>
                {invoiceData.shipToAddress?.pincode}
                {invoiceData.shipToAddress?.pincode &&
                invoiceData.shipToAddress?.country
                  ? ", "
                  : ""}
                {invoiceData.shipToAddress?.country}
              </Text>
            )}
            {invoiceData.shipToEmail && (
              <Text style={pdfStyles.partyContact}>
                Email: {invoiceData.shipToEmail}
              </Text>
            )}
            {invoiceData.shipToPhone && (
              <Text style={pdfStyles.partyContact}>
                Mobile: {invoiceData.shipToPhone}
              </Text>
            )}
            {invoiceData.shipToAddress?.gstin && (
              <Text style={pdfStyles.partyContact}>
                GSTIN: {invoiceData.shipToAddress.gstin}
              </Text>
            )}
          </PDFView>
        </PDFView>
        {/* Items Table - EXTENDED */}
        <PDFView
          style={{
            ...pdfStyles.table,

            marginBottom: 0,
          }}
        >
          <PDFView style={pdfStyles.tableHeader}>
            <Text style={[pdfStyles.th, pdfStyles.thDesc]}>ITEMS</Text>
            <Text style={[pdfStyles.th, pdfStyles.thQty]}>QTY</Text>
            <Text style={[pdfStyles.th, pdfStyles.thRate]}>RATE</Text>
            {/* GST Column - Only show if GST breakdown is enabled */}
            {isGstEnabled && (
              <Text style={[pdfStyles.th, pdfStyles.thGst]}>GST</Text>
            )}
            <Text style={[pdfStyles.th, pdfStyles.thAmt]}>AMOUNT</Text>
          </PDFView>
          <PDFView style={pdfStyles.tableBody}>
            {/* Wrap rows in a new flex container */}
            {serviceItems.map((item, idx) => (
              <PDFView
                style={{
                  ...pdfStyles.tableRow,
                  flexGrow: undefined,
                  marginBottom: 0,
                  paddingTop: 0,
                  paddingBottom: 0,
                }}
                key={idx}
              >
                <Text style={[pdfStyles.td, pdfStyles.tdDesc]}>
                  {item.description}
                </Text>
                <Text style={[pdfStyles.td, pdfStyles.tdQty]}>
                  {item.quantity}
                </Text>
                <Text style={[pdfStyles.td, pdfStyles.tdRate]}>
                  {(isNaN(parseFloat(item.rate))
                    ? 0
                    : parseFloat(item.rate)
                  ).toFixed(roundOffDecimal)}
                </Text>
                {/* GST Column - Only show if GST breakdown is enabled */}
                {isGstEnabled && (
                  <Text style={[pdfStyles.td, pdfStyles.tdGst]}>
                    {isNaN(parseFloat(item.taxRate))
                      ? 0
                      : parseFloat(item.taxRate)}
                  </Text>
                )}
                <Text
                  style={[
                    pdfStyles.td,
                    pdfStyles.tdAmt,
                    { alignSelf: "flex-end" },
                  ]}
                >
                  {(isNaN(parseFloat(item.amount))
                    ? 0
                    : parseFloat(item.amount)
                  ).toFixed(roundOffDecimal)}
                </Text>
              </PDFView>
            ))}
            {/* Add empty rows to visually extend the table if there are few items */}
            {Array.from({ length: Math.max(0, 5 - serviceItems.length) }).map(
              (_, idx) => (
                <PDFView
                  style={{
                    ...pdfStyles.tableRow,
                    flexGrow: undefined,
                    marginBottom: 0,
                    paddingTop: 0,
                    paddingBottom: 0,
                  }}
                  key={`empty-${idx}`}
                >
                  <Text style={[pdfStyles.td, pdfStyles.tdDesc]}>
                    {"\u00A0"}{" "}
                  </Text>
                  <Text style={[pdfStyles.td, pdfStyles.tdQty]}>
                    {"\u00A0"}{" "}
                  </Text>
                  <Text style={[pdfStyles.td, pdfStyles.tdRate]}>
                    {"\u00A0"}{" "}
                  </Text>
                  {/* GST Column - Only show if GST breakdown is enabled */}
                  {isGstEnabled && (
                    <Text style={[pdfStyles.td, pdfStyles.tdGst]}>
                      {"\u00A0"}{" "}
                    </Text>
                  )}
                  <Text style={[pdfStyles.td, pdfStyles.tdAmt]}>
                    {"\u00A0"}{" "}
                  </Text>
                </PDFView>
              )
            )}
          </PDFView>{" "}
          {/* End of new flex container */}
        </PDFView>
        {/* Combined Terms and Conditions and Totals Table */}
        <PDFView
          style={[
            pdfStyles.totalsTable,
            {
              flexDirection: "row",
              marginTop: 0,
              marginBottom: 12,
              borderTopWidth: 0, // Remove top border for the entire combined block
            },
          ]}
        >
          {/* Right Column: Totals */}
          <PDFView style={pdfStyles.totalsColumn}>
            {/* Subtotal */}
            <PDFView style={pdfStyles.totalsTableRow}>
              <PDFView
                style={[
                  pdfStyles.td,
                  pdfStyles.totalsLabelRelativeWidth,
                  { borderTopWidth: 0 }, // Added borderBottomWidth
                ]}
              >
                <Text style={{ fontWeight: "bold", textAlign: "right" }}>
                  SUB TOTAL
                </Text>
              </PDFView>
              <PDFView
                style={[
                  pdfStyles.td,
                  pdfStyles.totalsAmountRelativeWidth,
                  {
                    borderRightWidth: 0,
                    borderTopWidth: 0,
                    borderBottomWidth: 0,
                  }, // Added borderBottomWidth
                ]}
              >
                <Text
                  style={{
                    fontWeight: "bold",
                    textAlign: "right",
                    borderTopWidth: 0,
                  }}
                >
                  {subTotal.toFixed(roundOffDecimal)}
                </Text>
              </PDFView>
            </PDFView>

            {/* CGST */}
            {isGstEnabled && (
              <PDFView style={[pdfStyles.totalsTableRow, { minHeight: 18 }]}>
                <PDFView
                  style={[
                    pdfStyles.td,
                    pdfStyles.totalsLabelRelativeWidth,
                    { borderBottomWidth: 1, borderTopWidth: 1 }, // Added borderBottomWidth
                  ]}
                >
                  <Text style={{ fontSize: 5, textAlign: "right" }}>
                    CGST AMOUNT
                  </Text>
                </PDFView>
                <PDFView
                  style={[
                    pdfStyles.td,
                    pdfStyles.totalsAmountRelativeWidth,
                    {
                      borderRightWidth: 0,
                      borderBottomWidth: 1,
                      borderTopWidth: 1,
                    }, // Added borderBottomWidth
                  ]}
                >
                  <Text style={{ fontSize: 5, textAlign: "right" }}>
                    {cgstTotal.toFixed(roundOffDecimal)}
                  </Text>
                </PDFView>
              </PDFView>
            )}

            {/* SGST */}
            {isGstEnabled && (
              <PDFView style={[pdfStyles.totalsTableRow, { minHeight: 18 }]}>
                <PDFView
                  style={[
                    pdfStyles.td,
                    pdfStyles.totalsLabelRelativeWidth,
                    { borderBottomWidth: 1 }, // Added borderBottomWidth
                  ]}
                >
                  <Text style={{ fontSize: 5, textAlign: "right" }}>
                    SGST AMOUNT
                  </Text>
                </PDFView>
                <PDFView
                  style={[
                    pdfStyles.td,
                    pdfStyles.totalsAmountRelativeWidth,
                    { borderRightWidth: 0, borderBottomWidth: 1 }, // Added borderBottomWidth
                  ]}
                >
                  <Text style={{ fontSize: 5, textAlign: "right" }}>
                    {sgstTotal.toFixed(roundOffDecimal)}
                  </Text>
                </PDFView>
              </PDFView>
            )}

            {/* IGST */}
            {isGstEnabled && (
              <PDFView style={[pdfStyles.totalsTableRow, { minHeight: 18 }]}>
                <PDFView
                  style={[
                    pdfStyles.td,
                    pdfStyles.totalsLabelRelativeWidth,
                    { borderBottomWidth: 1 }, // Added borderBottomWidth
                  ]}
                >
                  <Text style={{ fontSize: 5, textAlign: "right" }}>
                    IGST AMOUNT
                  </Text>
                </PDFView>
                <PDFView
                  style={[
                    pdfStyles.td,
                    pdfStyles.totalsAmountRelativeWidth,
                    { borderRightWidth: 0, borderBottomWidth: 1 }, // Added borderBottomWidth
                  ]}
                >
                  <Text style={{ fontSize: 5, textAlign: "right" }}>
                    {igstTotal.toFixed(roundOffDecimal)}
                  </Text>
                </PDFView>
              </PDFView>
            )}

            {/* Total GST Payable - New Row */}
            {isGstEnabled && (
              <PDFView style={[pdfStyles.totalsTableRow, { minHeight: 18 }]}>
                <PDFView
                  style={[
                    pdfStyles.td,
                    pdfStyles.totalsLabelRelativeWidth,
                    { borderBottomWidth: 0, minHeight: 18 }, // Changed from 0 to 1
                  ]}
                >
                  <Text
                    style={{
                      fontWeight: "normal",
                      fontSize: 5,
                      textAlign: "right",
                    }}
                  >
                    TOTAL GST PAYABLE
                  </Text>
                </PDFView>
                <PDFView
                  style={[
                    pdfStyles.td,
                    pdfStyles.totalsAmountRelativeWidth,
                    { borderBottomWidth: 0, borderRightWidth: 0 }, // Changed from 0 to 1
                  ]}
                >
                  <Text
                    style={{
                      fontWeight: "normal",
                      fontSize: 5,
                      textAlign: "right",
                    }}
                  >
                    {totalGstPayable.toFixed(roundOffDecimal)}
                  </Text>
                </PDFView>
              </PDFView>
            )}
          </PDFView>
        </PDFView>
        {/* Bank Details and Totals */}
        <PDFView
          style={{
            flexDirection: "row",
            justifyContent: "space-between",
            marginBottom: 32,
            marginTop: 32, // Add some top margin to separate from the combined totals table
          }}
        >
          {/* Left Column: Bank Details */}
          <PDFView style={[pdfStyles.bankBlock, {marginLeft:5}]}>
            {/* Bank details with clear separation */}
            <PDFView style={{ flexDirection: "row", marginBottom: 8 }}>
              <Text style={{ fontWeight: "bold", width: 80 }}>Bank Name:</Text>
              <Text style={{ color: "#545454" }}>{invoiceData.bankName}</Text>
            </PDFView>
            <PDFView style={{ flexDirection: "row", marginBottom: 8 }}>
              <Text style={{ fontWeight: "bold", width: 80 }}>
                Account Name:
              </Text>
              <Text style={{ color: "#545454" }}>
                {invoiceData.accountName}
              </Text>
            </PDFView>
            <PDFView style={{ flexDirection: "row", marginBottom: 8 }}>
              <Text style={{ fontWeight: "bold", width: 80 }}>IFSC Code:</Text>
              <Text style={{ color: "#545454" }}>{invoiceData.ifscCode}</Text>
            </PDFView>
            <PDFView style={{ flexDirection: "row", marginBottom: 8 }}>
              <Text style={{ fontWeight: "bold", width: 80 }}>Account No:</Text>
              <Text style={{ color: "#545454" }}>{invoiceData.accountNo}</Text>
            </PDFView>
            <PDFView style={{ flexDirection: "row", marginBottom: 8 }}>
              <Text style={{ fontWeight: "bold", width: 80 }}>
                Bank Branch:
              </Text>
              <Text style={{ color: "#545454" }}>{invoiceData.bankBranch}</Text>
            </PDFView>
          </PDFView>

          {/* Right Column: Totals */}
          <PDFView style={[pdfStyles.bankBlockRight, {marginRight:5}]}>
            {/* GRAND TOTAL */}
            <PDFView
              style={{
                flexDirection: "row",
                justifyContent: "flex-end",
                marginBottom: 15,
              }}
            >
              <Text style={{ fontWeight: "bold", marginRight: 8 }}>
                GRAND TOTAL:
              </Text>
              <Text style={{ fontWeight: "bold", borderBottomWidth: 1, borderColor: "#E5E7EB", width: 80, }}>
                {grandTotal.toFixed(roundOffDecimal)}
              </Text>
            </PDFView>
            {/* Received Amount */}
            <PDFView
              style={{
                flexDirection: "row",
                justifyContent: "flex-end",
                marginBottom: 15,
              }}
            >
              <Text style={{ fontWeight: "bold", marginRight: 8 }}>
                Received Amount:
              </Text>
              <Text style={{ borderBottomWidth: 1, borderColor: "#E5E7EB",width: 80, }}>
                {(invoiceData.receivedAmount || 0).toFixed(roundOffDecimal)}
              </Text>
            </PDFView>
            {/* Balance */}
            <PDFView
              style={{
                flexDirection: "row",
                justifyContent: "flex-end",
                marginBottom: 15,
              }}
            >
              <Text style={{ fontWeight: "bold", marginRight: 10 }}>
                Balance:
              </Text>
              <Text style={{ borderBottomWidth: 1, borderColor: "#E5E7EB", width: 80, }}>
                {balance.toFixed(roundOffDecimal)}
              </Text>
            </PDFView>
          </PDFView>
        </PDFView>

        {/* Terms and Conditions and Authorised Signatory */}
        <PDFView
          style={{
            flexDirection: "row",
            justifyContent: "space-between",
            marginBottom: 32,
            marginTop: 16,
          }}
        >
          {/* Left Column: Terms and Conditions */}
          <PDFView style={[pdfStyles.termsColumn, {marginLeft: 5}]}>
            <Text style={{ fontWeight: "bold", marginBottom: 8, fontSize: 11 }}>
              TERMS AND CONDITIONS:
            </Text>
            <PDFView>
              {invoiceData.termsAndConditions?.map((term, idx) => (
                <PDFView
                  key={idx}
                  style={{ flexDirection: "row", marginBottom: 2 }}
                >
                  <Text
                    style={{
                      width: 8,
                      textAlign: "right",
                      marginRight: 1,
                      fontSize: 10,
                      marginBottom: 3,
                    }}
                  >{`${idx + 1}.`}</Text>
                  <Text style={{ flexGrow: 1, marginBottom: 3, fontSize: 10 }}>
                    {term}
                  </Text>
                </PDFView>
              ))}
            </PDFView>
          </PDFView>

          {/* Right Column: Authorised Signatory */}
          <PDFView style={[pdfStyles.bankBlockRight, {paddingLeft: 100}, {marginTop:-30}, {marginRight:5}]}>
            <PDFView
              style={{
                width: "100%",
                textAlign: "center",
                marginTop: 0,
                marginBottom: 0,
              }}
            >
              {invoiceData.upload_seal && invoiceData.upload_seal !== "" && (
                <PDFImage
                  src={convertImageUrlForPdf(invoiceData.upload_seal)}
                  style={pdfStyles.seal}
                  cache={false}
                />
              )}
              <Text style={pdfStyles.signatory}>AUTHORISED SIGNATORY FOR</Text>
              <Text
                style={{ color: "#545454", fontSize: 12, textAlign: "center" }}
              >
                {invoiceData.authorisedSignatory}
              </Text>
            </PDFView>
          </PDFView>
        </PDFView>
      </Page>
    </Document>
  );
};

const invoiceComponent = () => {
  const { user: authUser, rolePermissions } = useAuth();

  const canEditCompanyFields = rolePermissions === "ALL";
  const canEditInvoiceNumber = rolePermissions === "ALL";
  const { isCollapsed } = useContext(SidebarContext);

  const location = useLocation();
  const [isEditMode, setIsEditMode] = useState(false);
  const [organizationEmail, setOrganizationEmail] = useState(""); // New state for organization email
  const [receivedAmount, setReceivedAmount] = useState(0); // New state for received amount
  const [combinedAddressSecondLine, setCombinedAddressSecondLine] =
    useState(""); // New state for combined address line

  const [invoiceData, setInvoiceData] = useState({
    companyName: "",
    addressLine1: "",
    addressLine2: "",
    mobile: "",
    companyState: "", // Added for GST compliance
    companyPincode: "", // New field for company pincode
    companyCountry: "", // New field for company country
    invoiceNo: "",
    invoiceDate: formatDate(new Date().toISOString().slice(0, 10)),
    billToName: "",
    billToPhone: "",
    billToEmail: "",
    billToState: "",
    billToAddress: {
      blockUnitStreetName: "",
      city: "",
      state: "",
      pincode: "",
      country: "",
      gstin: "",
    },
    shipToName: "",
    shipToPhone: "",
    shipToEmail: "",
    shipToState: "",
    shipToAddress: {
      blockUnitStreetName: "",
      city: "",
      state: "",
      pincode: "",
      country: "",
      gstin: "",
    },
    bankName: "",
    accountName: "",
    ifscCode: "",
    accountNo: "",
    bankBranch: "",
    termsAndConditions: [],
    authorisedSignatory: "",
    upload_seal: "",
  });

  const [serviceItems, setServiceItems] = useState([
    {
      description: "",
      quantity: 0,
      rate: 0,
      taxRate: 0, // Default GST rate (total GST)
      amount: 0, // This will be calculated by GST logic
      taxAmount: 0, // Total GST amount for the item
      cgstAmount: 0, // CGST amount for the item
      sgstAmount: 0, // SGST amount for the item
      igstAmount: 0, // IGST amount for the item
    },
  ]);

  // State for manually edited amounts and totals
  const [editedServiceItemAmounts, setEditedServiceItemAmounts] = useState({});
  const [editedSubTotal, setEditedSubTotal] = useState(null);
  const [editedCgstTotal, setEditedCgstTotal] = useState(null);
  const [editedSgstTotal, setEditedSgstTotal] = useState(null);
  const [editedIgstTotal, setEditedIgstTotal] = useState(null);

  // New state for manually edited Total GST Payable
  const [editedTotalGstPayable, setEditedTotalGstPayable] = useState(null);

  const [editedGrandTotal, setEditedGrandTotal] = useState(null);
  const [editedBalance, setEditedBalance] = useState(null);

  // States for manually edited GST labels and percentages
  const [editedCgstLabel, setEditedCgstLabel] = useState(null);
  const [editedSgstLabel, setEditedSgstLabel] = useState(null);
  const [editedIgstLabel, setEditedIgstLabel] = useState(null);
  const [editedCgstPercentage, setEditedCgstPercentage] = useState(null);
  const [editedSgstPercentage, setEditedSgstPercentage] = useState(null);
  const [editedIgstPercentage, setEditedIgstPercentage] = useState(null);

  // Dummy user object to simulate user context data
  const [user, setUser] = useState({
    profile_pic: "", // Placeholder image path
    phoneno: "",
    email: "",
    address: "",
  });

  // To store the original state for discarding changes
  const [originalInvoiceData, setOriginalInvoiceData] = useState(invoiceData);
  const [originalServiceItems, setOriginalServiceItems] =
    useState(serviceItems);

  // New state for selected lead ID
  const [selectedLeadId, setSelectedLeadId] = useState(null);

  // Address form state for Bill To
  // Initialize with the invoiceData's billToAddress to ensure existing data is shown
  const [formData, setFormData] = useState(invoiceData.billToAddress);
  const [gstinError, setGstinError] = useState("");
  const [countryDropdownOpen, setCountryDropdownOpen] = useState(false);
  const [stateDropdownOpen, setStateDropdownOpen] = useState(false);
  const [cityDropdownOpen, setCityDropdownOpen] = useState(false);
  const [countrySearchTerm, setCountrySearchTerm] = useState("");
  const [stateSearchTerm, setStateSearchTerm] = useState("");
  const [citySearchTerm, setCitySearchTerm] = useState("");
  const [selectedCountryObj, setSelectedCountryObj] = useState(null);
  const [selectedStateObj, setSelectedStateObj] = useState(null);
  const [selectedCityObj, setSelectedCityObj] = useState(null);
  const countryDropdownRef = useRef(null);
  const stateDropdownRef = useRef(null);
  const cityDropdownRef = useRef(null);

  const [leadDropdownOpen, setLeadDropdownOpen] = useState(false);
  const [leadSearchTerm, setLeadSearchTerm] = useState("");
  const [leads, setLeads] = useState([]);
  const [leadsLoading, setLeadsLoading] = useState(false);
  const leadDropdownRef = useRef(null);

  // Ship To state (mirrors Bill To)
  // Initialize with the invoiceData's shipToAddress
  const [shipToFormData, setShipToFormData] = useState(
    invoiceData.shipToAddress
  );
  const [shipToGstinError, setShipToGstinError] = useState("");
  const [shipToLeadDropdownOpen, setShipToLeadDropdownOpen] = useState(false);
  const [shipToLeadSearchTerm, setShipToLeadSearchTerm] = useState("");
  const shipToDropdownRef = useRef(null);
  const [shipToCountryDropdownOpen, setShipToCountryDropdownOpen] =
    useState(false);
  const [shipToStateDropdownOpen, setShipToStateDropdownOpen] = useState(false);
  const [shipToCityDropdownOpen, setShipToCityDropdownOpen] = useState(false);
  const [shipToCountrySearchTerm, setShipToCountrySearchTerm] = useState("");
  const [shipToStateSearchTerm, setShipToStateSearchTerm] = useState("");
  const [shipToCitySearchTerm, setShipToCitySearchTerm] = useState("");
  const [shipToSelectedCountryObj, setShipToSelectedCountryObj] =
    useState(null);
  const [shipToSelectedStateObj, setShipToSelectedStateObj] = useState(null);
  const [shipToSelectedCityObj, setShipToSelectedCityObj] = useState(null);
  const shipToCountryDropdownRef = useRef(null);
  const shipToStateDropdownRef = useRef(null);
  const shipToCityDropdownRef = useRef(null);

  // User options for calculations
  const [roundOffOption, setRoundOffOption] = useState("nearest"); // "nearest", "up", "down", "none"
  const [roundOffDecimal, setRoundOffDecimal] = useState(0); // 0, 1, 2, 3
  const [gstCalculationMethod, setGstCalculationMethod] = useState("inclusive"); // "inclusive", "exclusive"
  const [isGstEnabled, setIsGstEnabled] = useState(false); // Changed from showGstBreakdown and set to false
  const [applyRoundOffTo, setApplyRoundOffTo] = useState("all"); // "all", "subtotal", "gst", "grandtotal"

  // Add refs and state for Calculation Options dropdowns
  const [openCalcDropdown, setOpenCalcDropdown] = useState(null); // 'roundOff', 'decimal', 'applyTo', 'gstMethod', or null
  const roundOffRef = useRef(null);
  const decimalRef = useRef(null);
  const applyToRef = useRef(null);
  const gstMethodRef = useRef(null);

  // Function to auto-resize textarea
  const autoResizeTextarea = (eOrElement) => {
    const element = eOrElement.target || eOrElement;
    if (element) {
      element.style.height = "auto";
      element.style.height = element.scrollHeight + "px";
    }
  };

  useEffect(() => {
    const fetchOrganizationData = async () => {
      try {
        const data = await api.get("/orglist"); // Directly get data
        console.log("this is API Response: fetch", data);
        if (data.data.success && data.data.result) {
          let orgData = null;
          if (Array.isArray(data.data.result)) {
            orgData = data.data.result[0];
          } else if (typeof data.data.result === "object") {
            orgData = Object.values(data.data.result)[0];
          }
          if (orgData) {
            console.log("Organization data here");
            let parsedAddress = {
              blockUnitStreetName: "",
              city: "",
              state: "",
              pincode: "",
              country: "",
            };

            // Attempt to parse the address if it's a JSON string
            if (orgData.address && typeof orgData.address === "string") {
              try {
                const addressObj = JSON.parse(orgData.address);
                parsedAddress = {
                  blockUnitStreetName: addressObj.blockUnitStreetName || "",
                  city: addressObj.city || "",
                  state: addressObj.state || "",
                  pincode: addressObj.pincode || "",
                  country: addressObj.country || "",
                };
              } catch (e) {
                console.error("Failed to parse address JSON:", e);
                // Fallback if JSON parsing fails, treat as plain text if needed
                // For now, it will just use empty strings from parsedAddress
              }
            }

            // Construct addressLine1 and addressLine2 based on the desired format
            // First line: blockUnitStreetName
            const addressLine1 = parsedAddress.blockUnitStreetName.replace(
              /\r$/,
              ""
            ); // Remove trailing carriage return

            // Second line: City, State
            let addressLine2Parts = [];
            if (parsedAddress.city) addressLine2Parts.push(parsedAddress.city);
            if (parsedAddress.state)
              addressLine2Parts.push(parsedAddress.state);
            const addressLine2 = addressLine2Parts.join(", ");

            // Third line for PDF: Pincode, Country (not used for addressLine1/2 but for direct PDF rendering)

            // Parse term_info (handle double-encoded JSON)
            let parsedTerms = [];
            if (orgData.term_info) {
              try {
                let termObj = orgData.term_info;
                // Step 1: Remove extra quotes if present
                if (
                  typeof termObj === "string" &&
                  termObj.startsWith('"') &&
                  termObj.endsWith('"')
                ) {
                  termObj = termObj.slice(1, -1);
                }
                // Step 2: Replace escaped quotes
                if (typeof termObj === "string") {
                  termObj = termObj.replace(/\\"/g, '"');
                }
                // Step 3: Parse first time
                if (typeof termObj === "string") {
                  termObj = JSON.parse(termObj);
                }
                // Step 4: If still a string, parse again
                if (typeof termObj === "string") {
                  termObj = JSON.parse(termObj);
                }
                // Step 5: Now termObj is an object
                parsedTerms = Object.values(termObj)
                  .map((t) => t.replace(/\\n/g, "\n"))
                  .filter((t) => t && t.trim() && t !== "N"); // Remove empty or 'N'
              } catch (e) {
                parsedTerms = [];
              }
            }

            setInvoiceData((prev) => ({
              ...prev,
              companyName: orgData.organizationname || prev.companyName,
              addressLine1: addressLine1 || prev.addressLine1,
              addressLine2: addressLine2 || prev.addressLine2, // This will now correctly combine city and state
              mobile: orgData.phone || prev.mobile,
              companyState: parsedAddress.state || prev.companyState, // Use parsed state for GST compliance
              companyPincode: parsedAddress.pincode || prev.companyPincode,
              companyCountry: parsedAddress.country || prev.companyCountry,
              authorisedSignatory:
                orgData.organizationname || prev.authorisedSignatory,
              upload_seal: orgData.upload_seal || "",
              // Autofill bank details
              bankName: orgData.bank_name || prev.bankName,
              accountName: orgData.account_name || prev.accountName,
              ifscCode: orgData.ifsc_code || prev.ifscCode,
              accountNo: orgData.account_no || prev.accountNo,
              bankBranch: orgData.bank_branch || prev.bankBranch,
              // Autofill terms and conditions
              termsAndConditions:
                parsedTerms.length > 0 ? parsedTerms : ["Terms and conditions"],
            }));
            setOrganizationEmail(orgData.email || "");
            setUser((prev) => ({
              ...prev,
              profile_pic: orgData.profile_image || prev.profile_pic,
            }));
          }
        } else if (!data.data.success) {
          // Handle API success: false case
          console.error("API returned success: false", data.data.message);
          Swal.fire({
            icon: "error",
            title: "Error!",
            text: data.data.message || "Failed to load organization data.",
            confirmButtonColor: "#3085d6",
          });
        }
      } catch (error) {
        console.error("Error fetching organization data:", error);
        Swal.fire({
          icon: "error",
          title: "Error!",
          text: "Failed to load organization data.",
          confirmButtonColor: "#3085d6",
        });
      }
    };

    const fetchInvoiceNumber = async () => {
      try {
        const response = await api.get("/getinvoiceno");
        console.log("Invoice number API response:", response);
        if (response.data.success) {
          setInvoiceData((prev) => ({
            ...prev,
            invoiceNo: response.data.invoice_no || prev.invoiceNo,
          }));
        } else {
          console.error("Failed to get invoice number:", response.data.message);
        }
      } catch (error) {
        console.error("Error fetching invoice number:", error);
        // Don't show error alert for invoice number as it's not critical
      }
    };

    fetchOrganizationData();
    if (!(location && location.state && location.state.mode === "edit" && location.state.invoice)) {
  fetchInvoiceNumber();
} else {
  console.log("Skipping invoice fetch (edit mode)");
}

    // Set default country to India for Bill To and Ship To
    const india = Country.getAllCountries().find(
      (country) => country.name === "India"
    );
    if (india) {
      setSelectedCountryObj(india);
      setCountrySearchTerm("India");
      setFormData((prev) => ({ ...prev, country: "India" }));
      setShipToSelectedCountryObj(india);
      setShipToCountrySearchTerm("India");
      setShipToFormData((prev) => ({ ...prev, country: "India" }));
    }
  }, []); // Run once on component mount

  // Effect to resize textareas when entering edit mode or terms change
  useEffect(() => {
    if (isEditMode) {
      const textareas = document.querySelectorAll(".terms-textarea");
      textareas.forEach((textarea) => {
        autoResizeTextarea(textarea);
      });
    }
  }, [isEditMode, invoiceData.termsAndConditions]);

  // Effect to update combinedAddressSecondLine when invoiceData changes
  useEffect(() => {
    const parts = [];
    if (invoiceData.addressLine2) parts.push(invoiceData.addressLine2);
    if (invoiceData.companyCountry) parts.push(invoiceData.companyCountry);
    if (invoiceData.companyPincode) parts.push(invoiceData.companyPincode);
    setCombinedAddressSecondLine(parts.join(", "));
  }, [
    invoiceData.addressLine2,
    invoiceData.companyCountry,
    invoiceData.companyPincode,
  ]);

  // Effect to recalculate GST when companyState or shipToState changes
  useEffect(() => {
    console.log("GST recalculation effect triggered:", {
      companyState: invoiceData.companyState,
      shipToState: invoiceData.shipToState,
    });

    const updatedServiceItems = serviceItems.map((item) => {
      const baseAmount = item.quantity * item.rate;
      const { taxAmount, cgstAmount, sgstAmount, igstAmount, amount } =
        calculateItemGST(
          baseAmount,
          item.taxRate,
          invoiceData.companyState,
          invoiceData.shipToState,
          isGstEnabled // Pass isGstEnabled to calculation
        );
      return {
        ...item,
        taxAmount,
        cgstAmount,
        sgstAmount,
        igstAmount,
        amount,
      };
    });
    setServiceItems(updatedServiceItems);
  }, [
    invoiceData.companyState,
    invoiceData.shipToState,
    gstCalculationMethod,
    roundOffOption,
    roundOffDecimal,
    applyRoundOffTo,
    isGstEnabled, // Add isGstEnabled as a dependency
  ]); // Include all calculation dependencies

  // Initial calculation effect - runs once when component mounts
  useEffect(() => {
    console.log("Initial calculation effect running");
    console.log("Initial state values:", {
      companyState: invoiceData.companyState,
      shipToState: invoiceData.shipToState,
      serviceItems: serviceItems,
    });

    const updatedServiceItems = serviceItems.map((item) => {
      const baseAmount = item.quantity * item.rate;
      const { taxAmount, cgstAmount, sgstAmount, igstAmount, amount } =
        calculateItemGST(
          baseAmount,
          item.taxRate,
          invoiceData.companyState,
          invoiceData.shipToState,
          isGstEnabled // Pass isGstEnabled to calculation
        );
      return {
        ...item,
        taxAmount,
        cgstAmount,
        sgstAmount,
        igstAmount,
        amount,
      };
    });
    setServiceItems(updatedServiceItems);

    // Clear any manual overrides on initial mount to ensure consistent starting state
    setEditedServiceItemAmounts({});
    setEditedSubTotal(null);
    setEditedCgstTotal(null);
    setEditedSgstTotal(null);
    setEditedIgstTotal(null);
    setEditedTotalGstPayable(null);
    setEditedGrandTotal(null);
    setEditedBalance(null);
    setEditedCgstLabel(null);
    setEditedSgstLabel(null);
    setEditedIgstLabel(null);
    setEditedCgstPercentage(null);
    setEditedSgstPercentage(null);
    setEditedIgstPercentage(null);
  }, []); // Only run once on mount

  useEffect(() => {
    if (
      location.state &&
      location.state.mode === "edit" &&
      location.state.invoice
    ) {
      // Prefill all relevant states for edit mode
      setIsEditMode(true);
      const inv = location.state.invoice;
      setInvoiceData({
        ...invoiceData,
        // Map fields from the passed invoice to CreateInvoice's state structure
        companyName: inv.company_name || inv.bill_to_name || "",
        addressLine1: inv.bill_to_address || "",
        addressLine2: inv.ship_to_address || "",
        mobile: inv.contact || "",
        invoiceNo: inv.invoice_no || (inv.id ? String(inv.id) : ""),
        invoiceDate: inv.invoice_date ? formatDate(inv.invoice_date) : "",
        billToName: inv.bill_to_name || "",
        billToPhone: inv.bill_to_phone || inv.contact || "",
        billToEmail: inv.bill_to_email || "",
        billToState: inv.bill_to_state || "",
        billToAddress:
          typeof inv.bill_to_address === "object" ? inv.bill_to_address : {},
        shipToName: inv.ship_to_name || "",
        shipToPhone: inv.ship_to_phone || "",
        shipToEmail: inv.ship_to_email || "",
        shipToState: inv.ship_to_state || "",
        shipToAddress:
          typeof inv.ship_to_address === "object" ? inv.ship_to_address : {},
        bankName: inv.bank_name || "",
        accountName: inv.account_name || "",
        ifscCode: inv.ifsc_code || "",
        accountNo: inv.account_no || "",
        bankBranch: inv.bank_branch || "",
        termsAndConditions: inv.termsAndConditions || ["Terms and conditions"],
        authorisedSignatory: inv.authorisedSignatory || "",
        upload_seal: inv.upload_seal || "",
      });
      setServiceItems(
        Array.isArray(inv.items)
          ? inv.items.map((item) => ({
              description: item.item_name || item.serviceName || "",
              quantity: parseFloat(item.qty || item.quantity || 0),
              rate: parseFloat(item.rate || item.totalItemPrice || 0),
              taxRate: parseFloat(item.gst || 0),
              amount: parseFloat(item.amount || item.totalItemPrice || 0),
              taxAmount: parseFloat(item.taxAmount || 0),
              cgstAmount: parseFloat(item.cgstAmount || 0),
              sgstAmount: parseFloat(item.sgstAmount || 0),
              igstAmount: parseFloat(item.igstAmount || 0),
            }))
          : [
              {
                description: "",
                quantity: 1,
                rate: 0,
                taxRate: 0,
                amount: 0,
                taxAmount: 0,
                cgstAmount: 0,
                sgstAmount: 0,
                igstAmount: 0,
              },
            ]
      );
      // Optionally set other states (receivedAmount, etc.)
    }
  }, []); // Only run on mount

  const validateGstin = (gstin) => {
    if (!gstin) {
      // Optional field
      setGstinError("");
      return true;
    }
    const gstinRegex =
      /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;
    if (gstinRegex.test(gstin)) {
      setGstinError("");
      return true;
    } else {
      setGstinError("Invalid GSTIN format.");
      return false;
    }
  };

  // Handlers for address fields
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    if (
      [
        "blockUnitStreetName",
        "state",
        "city",
        "pincode",
        "country",
        "gstin",
      ].includes(name)
    ) {
      const updatedValue = name === "gstin" ? value.toUpperCase() : value;
      setFormData((prev) => ({ ...prev, [name]: updatedValue }));
      // Update invoiceData.billToState when formData.state changes
      if (name === "state") {
        setInvoiceData((prev) => ({ ...prev, billToState: updatedValue }));
        // Also try to set selectedStateObj if state is manually entered
        if (selectedCountryObj) {
          const foundState = State.getStatesOfCountry(
            selectedCountryObj.isoCode
          ).find((s) => s.name.toLowerCase() === updatedValue.toLowerCase());
          setSelectedStateObj(foundState || null);
          // Reset cities if state changes
          setFilteredCities(
            foundState
              ? City.getCitiesOfState(
                  selectedCountryObj.isoCode,
                  foundState.isoCode
                )
              : []
          );
        }
      } else if (name === "country") {
        // Try to set selectedCountryObj if country is manually entered
        const foundCountry = Country.getAllCountries().find(
          (c) => c.name.toLowerCase() === updatedValue.toLowerCase()
        );
        setSelectedCountryObj(foundCountry || null);
        setSelectedStateObj(null);
      }

      if (name === "gstin") {
        validateGstin(updatedValue);
      }
    } else if (name === "invoiceDate") {
      // Convert the YYYY-MM-DD value from the input to DD MM YYYY for state
      const [year, month, day] = value.split("-");
      setInvoiceData((prev) => ({
        ...prev,
        [name]: `${day} ${month} ${year}`,
      }));
    } else {
      setInvoiceData((prev) => ({ ...prev, [name]: value }));
    }
  };

  // Country search and select
  const handleCountrySearchChange = (e) => {
    const value = e.target.value;
    setCountrySearchTerm(value);
    setCountryDropdownOpen(true);

    // Clear dependent selections if country changes
    if (value === "") {
      setSelectedStateObj(null);
      setSelectedCityObj(null);
      setStateSearchTerm("");
      setCitySearchTerm("");
    }
  };
  const handleCountrySelect = (country) => {
    setFormData((prev) => ({
      ...prev,
      country: country.name,
      state: "",
      city: "",
    }));
    setSelectedCountryObj(country);
    setCountrySearchTerm(country.name);
    setCountryDropdownOpen(false);

    // Clear dependent selections
    setSelectedStateObj(null);
    setSelectedCityObj(null);
    setStateSearchTerm("");
    setCitySearchTerm("");
  };

  // State search and select
  const handleStateSearchChange = (e) => {
    // Prevent state search if no country is selected
    if (!countrySearchTerm) {
      return;
    }

    const value = e.target.value;
    setStateSearchTerm(value);
    setStateDropdownOpen(true);

    // Clear dependent selections if state changes
    if (value === "") {
      setSelectedCityObj(null);
      setCitySearchTerm("");
    }
  };
  const handleStateSelect = (state) => {
    setFormData((prev) => ({ ...prev, state: state.name, city: "" }));
    setSelectedStateObj(state);
    setStateSearchTerm(state.name);
    setStateDropdownOpen(false);
    setFilteredCities(
      City.getCitiesOfState(selectedCountryObj.isoCode, state.isoCode)
    );
    setInvoiceData((prev) => ({ ...prev, billToState: state.name }));

    // Clear dependent selections
    setSelectedCityObj(null);
    setCitySearchTerm("");
  };

  // City search and select
  const handleCitySearchChange = (e) => {
    // Prevent city search if no state is selected
    if (!stateSearchTerm) {
      return;
    }

    const value = e.target.value;
    setCitySearchTerm(value);
    setCityDropdownOpen(true);
  };
  const handleCitySelect = (city) => {
    setFormData((prev) => ({ ...prev, city: city.name }));
    setSelectedCityObj(city);
    setCitySearchTerm(city.name);
    setCityDropdownOpen(false);
  };

  // Close dropdowns on outside click
  useEffect(() => {
    function handleClickOutside(event) {
      if (
        countryDropdownRef.current &&
        !countryDropdownRef.current.contains(event.target)
      ) {
        setCountryDropdownOpen(false);
      }
      if (
        stateDropdownRef.current &&
        !stateDropdownRef.current.contains(event.target)
      ) {
        setStateDropdownOpen(false);
      }
      if (
        cityDropdownRef.current &&
        !cityDropdownRef.current.contains(event.target)
      ) {
        setCityDropdownOpen(false);
      }
      if (
        leadDropdownRef.current &&
        !leadDropdownRef.current.contains(event.target)
      ) {
        setLeadDropdownOpen(false);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, []);

  const calculateItemGST = (
    baseAmount,
    taxRate,
    companyState,
    shipToState,
    isGstEnabled
  ) => {
    let cgstAmount = 0;
    let sgstAmount = 0;
    let igstAmount = 0;
    let finalAmount = 0;

    // If GST is disabled, return all zeros for GST related amounts
    if (!isGstEnabled) {
      return {
        taxAmount: 0,
        cgstAmount: 0,
        sgstAmount: 0,
        igstAmount: 0,
        amount: baseAmount, // Amount is just baseAmount if no GST
      };
    }

    // Ensure inputs are numbers, default to 0 if NaN
    baseAmount = isNaN(baseAmount) ? 0 : baseAmount;
    taxRate = isNaN(taxRate) ? 0 : taxRate;

    const companyStateClean = companyState
      ? companyState.toLowerCase().trim()
      : "";
    const shipToStateClean = shipToState
      ? shipToState.toLowerCase().trim()
      : "";

    // Debug logging
    console.log("GST Calculation Debug:", {
      companyState,
      shipToState,
      companyStateClean,
      shipToStateClean,
      areEqual: companyStateClean === shipToStateClean,
      taxRate,
      gstCalculationMethod,
      baseAmount,
    });

    // Handle GST calculation method (inclusive vs exclusive)
    if (gstCalculationMethod === "exclusive") {
      // GST is added on top of base amount
      if (companyStateClean === shipToStateClean) {
        // Same state: CGST + SGST (9% + 9% = 18%)
        const halfTaxRate = taxRate / 2;
        cgstAmount = baseAmount * (halfTaxRate / 100);
        sgstAmount = baseAmount * (halfTaxRate / 100);
        console.log("Same state - CGST/SGST calculated:", {
          cgstAmount,
          sgstAmount,
          halfTaxRate,
        });
      } else {
        // Different state: IGST (18%)
        igstAmount = baseAmount * (taxRate / 100);
        console.log("Different state - IGST calculated:", { igstAmount });
      }
      finalAmount = baseAmount + cgstAmount + sgstAmount + igstAmount;
    } else {
      // GST is inclusive (base amount already includes GST)
      const taxAmountFromInclusive = baseAmount * (taxRate / (100 + taxRate));
      if (companyStateClean === shipToStateClean) {
        // Same state: CGST + SGST (9% + 9% = 18%)
        const halfTaxRate = taxRate / 2;
        cgstAmount = taxAmountFromInclusive * (halfTaxRate / taxRate);
        sgstAmount = taxAmountFromInclusive * (halfTaxRate / taxRate);
        console.log("Same state (inclusive) - CGST/SGST calculated:", {
          cgstAmount,
          sgstAmount,
          halfTaxRate,
        });
      } else {
        // Different state: IGST (18%)
        igstAmount = taxAmountFromInclusive;
        console.log("Different state (inclusive) - IGST calculated:", {
          igstAmount,
        });
      }
      finalAmount = baseAmount; // Amount stays the same, GST is extracted from it
    }

    const taxAmount = cgstAmount + sgstAmount + igstAmount;

    // Ensure all returned values are numbers, defaulting to 0 if NaN
    return {
      taxAmount: isNaN(taxAmount) ? 0 : taxAmount,
      cgstAmount: isNaN(cgstAmount) ? 0 : cgstAmount,
      sgstAmount: isNaN(sgstAmount) ? 0 : sgstAmount,
      igstAmount: isNaN(igstAmount) ? 0 : igstAmount,
      amount: isNaN(finalAmount) ? 0 : finalAmount,
    };
  };

  // Helper function to apply round off based on user options
  const applyRoundOff = (value) => {
    if (isNaN(value) || value === null) {
      return 0; // Return 0 if the value is NaN or null
    }
    if (roundOffOption === "none") {
      return value;
    }

    const multiplier = Math.pow(10, roundOffDecimal);
    let roundedValue;

    switch (roundOffOption) {
      case "nearest":
        roundedValue = Math.round(value * multiplier) / multiplier;
        break;
      case "up":
        roundedValue = Math.ceil(value * multiplier) / multiplier;
        break;
      case "down":
        roundedValue = Math.floor(value * multiplier) / multiplier;
        break;
      default:
        roundedValue = value;
    }

    return parseFloat(roundedValue.toFixed(roundOffDecimal));
  };

  const handleServiceItemChange = (index, field, value) => {
    const newServiceItems = [...serviceItems];
    // Ensure numerical fields are parsed as floats immediately upon change
    if (field === "quantity" || field === "rate" || field === "taxRate") {
      newServiceItems[index][field] = parseFloat(value) || 0;
    } else {
      newServiceItems[index][field] = value;
    }

    if (field === "quantity" || field === "rate" || field === "taxRate") {
      const qty = newServiceItems[index].quantity; // Already a number due to parsing above
      const rate = newServiceItems[index].rate; // Already a number
      const taxRate = newServiceItems[index].taxRate; // Already a number

      const baseAmount = qty * rate;
      const { taxAmount, cgstAmount, sgstAmount, igstAmount, amount } =
        calculateItemGST(
          baseAmount,
          taxRate,
          invoiceData.companyState,
          invoiceData.shipToState,
          isGstEnabled // Pass isGstEnabled to calculation
        );

      newServiceItems[index].taxAmount =
        applyRoundOffTo === "all" || applyRoundOffTo === "gst"
          ? applyRoundOff(taxAmount)
          : taxAmount;
      newServiceItems[index].amount =
        applyRoundOffTo === "all" ? applyRoundOff(amount) : amount; // Round final amount for item only if applyRoundOffTo is "all"
      newServiceItems[index].cgstAmount =
        applyRoundOffTo === "all" || applyRoundOffTo === "gst"
          ? applyRoundOff(cgstAmount)
          : cgstAmount;
      newServiceItems[index].sgstAmount =
        applyRoundOffTo === "all" || applyRoundOffTo === "gst"
          ? applyRoundOff(sgstAmount)
          : sgstAmount;
      newServiceItems[index].igstAmount =
        applyRoundOffTo === "all" || applyRoundOffTo === "gst"
          ? applyRoundOff(igstAmount)
          : igstAmount;
    }
    setServiceItems(newServiceItems);
    // Clear any manual override for this item's amount if quantity, rate, or taxRate changed
    if (field === "quantity" || field === "rate" || field === "taxRate") {
      setEditedServiceItemAmounts((prev) => {
        const newEditedAmounts = { ...prev };
        delete newEditedAmounts[index];
        return newEditedAmounts;
      });
    }
  };

  const addServiceItem = () => {
    setServiceItems([
      ...serviceItems,
      {
        description: "",
        quantity: 0,
        rate: 0,
        taxRate: 0,
        amount: 0,
        taxAmount: 0,
        cgstAmount: 0,
        sgstAmount: 0,
        igstAmount: 0,
      },
    ]);
  };

  const removeServiceItem = (index) => {
    if (serviceItems.length === 1) {
      Swal.fire(
        "Cannot Delete Last Item",
        "At least one service item is required.",
        "error"
      );
      return;
    }

    Swal.fire({
      title: "Are you sure?",
      text: "You won't be able to revert this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, delete it!",
    }).then((result) => {
      if (result.isConfirmed) {
        const newServiceItems = serviceItems.filter((_, i) => i !== index);
        setServiceItems(newServiceItems);
        Swal.fire("Deleted!", "Your service item has been deleted.", "success");
      }
    });
  };

  const handleEditedTotalChange = (field, value) => {
    const parsedValue = parseFloat(value);
    const roundedValue = isNaN(parsedValue) ? null : applyRoundOff(parsedValue); // Apply rounding here
    switch (field) {
      case "subTotal":
        setEditedSubTotal(roundedValue);
        break;
      case "cgstTotal":
        setEditedCgstTotal(roundedValue);
        break;
      case "sgstTotal":
        setEditedSgstTotal(roundedValue);
        break;
      case "igstTotal":
        setEditedIgstTotal(roundedValue);
        break;
      default:
        break;
    }
  };

  // Handler for Total GST Payable manual edit
  const handleEditedTotalGstPayableChange = (value) => {
    const parsedValue = parseFloat(value);
    const roundedValue = isNaN(parsedValue) ? null : applyRoundOff(parsedValue); // Apply rounding here
    setEditedTotalGstPayable(roundedValue);
  };

  const handleEditedOverallTotalChange = (field, value) => {
    const parsedValue = parseFloat(value);
    const roundedValue = isNaN(parsedValue) ? null : applyRoundOff(parsedValue); // Apply rounding here
    switch (field) {
      case "grandTotal":
        setEditedGrandTotal(roundedValue);
        break;
      case "balance":
        setEditedBalance(roundedValue);
        break;
      default:
        break;
    }
  };

  const calculateSubTotal = () => {
    const rawSubTotal =
      editedSubTotal !== null && editedSubTotal !== ""
        ? parseFloat(editedSubTotal)
        : serviceItems.reduce((sum, item) => {
            // If GST is disabled, item.amount will be equal to baseAmount (qty * rate)
            // So, no need to subtract taxAmount when GST is disabled, as taxAmount will be 0
            return sum + item.amount - (isGstEnabled ? item.taxAmount : 0); // Only subtract taxAmount if GST is enabled
          }, 0);

    // Apply round off based on user settings
    if (applyRoundOffTo === "all" || applyRoundOffTo === "subtotal") {
      return applyRoundOff(rawSubTotal);
    }
    return rawSubTotal;
  };

  const calculateGrandTotal = () => {
    // Sum the effective subtotal and effective GST totals
    const effectiveSubTotal = calculateSubTotal();
    // Only include GST totals if GST is enabled
    const effectiveCgstTotal = isGstEnabled ? calculateCgstTotal() : 0;
    const effectiveSgstTotal = isGstEnabled ? calculateSgstTotal() : 0;
    const effectiveIgstTotal = isGstEnabled ? calculateIgstTotal() : 0;

    const rawGrandTotal =
      effectiveSubTotal +
      effectiveCgstTotal +
      effectiveSgstTotal +
      effectiveIgstTotal;

    // Apply round off based on user settings
    if (applyRoundOffTo === "all" || applyRoundOffTo === "grandtotal") {
      return applyRoundOff(rawGrandTotal);
    }
    return rawGrandTotal;
  };

  const calculateCgstTotal = () => {
    // If GST is disabled, return 0 for CGST
    if (!isGstEnabled) return 0;
    const rawCgstTotal =
      editedCgstTotal !== null && editedCgstTotal !== ""
        ? parseFloat(editedCgstTotal)
        : serviceItems.reduce((sum, item) => sum + item.cgstAmount, 0);

    // Apply round off based on user settings
    if (applyRoundOffTo === "all" || applyRoundOffTo === "gst") {
      return applyRoundOff(rawCgstTotal);
    }
    return rawCgstTotal;
  };

  const calculateSgstTotal = () => {
    // If GST is disabled, return 0 for SGST
    if (!isGstEnabled) return 0;

    const rawSgstTotal =
      editedSgstTotal !== null && editedSgstTotal !== ""
        ? parseFloat(editedSgstTotal)
        : serviceItems.reduce((sum, item) => sum + item.sgstAmount, 0);

    // Apply round off based on user settings
    if (applyRoundOffTo === "all" || applyRoundOffTo === "gst") {
      return applyRoundOff(rawSgstTotal);
    }
    return rawSgstTotal;
  };

  const calculateIgstTotal = () => {
    // If GST is disabled, return 0 for IGST
    if (!isGstEnabled) return 0;

    const rawIgstTotal =
      editedIgstTotal !== null && editedIgstTotal !== ""
        ? parseFloat(editedIgstTotal)
        : serviceItems.reduce((sum, item) => sum + item.igstAmount, 0);

    // Apply round off based on user settings
    if (applyRoundOffTo === "all" || applyRoundOffTo === "gst") {
      return applyRoundOff(rawIgstTotal);
    }
    return rawIgstTotal;
  };

  // New function to calculate Total GST Payable
  const calculateTotalGstPayable = () => {
    // If GST is disabled, return 0 for Total GST Payable
    if (!isGstEnabled) return 0;

    const rawTotalGst =
      editedTotalGstPayable !== null && editedTotalGstPayable !== ""
        ? parseFloat(editedTotalGstPayable)
        : calculateCgstTotal() + calculateSgstTotal() + calculateIgstTotal();

    // Apply round off based on user settings
    if (applyRoundOffTo === "all" || applyRoundOffTo === "gst") {
      return applyRoundOff(rawTotalGst);
    }
    return rawTotalGst;
  };

  // Derived state for grand total and balance
  const displayedGrandTotal = calculateGrandTotal();
  const displayedBalance = displayedGrandTotal - receivedAmount;

  const toggleMode = () => {
    if (isEditMode) {
      Swal.fire({
        title: "Are you sure?",
        text: "All unsaved changes will be lost!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, exit!",
      }).then((result) => {
        if (result.isConfirmed) {
          setInvoiceData(originalInvoiceData);
          setServiceItems(originalServiceItems);
          setFormData(originalInvoiceData.billToAddress || formData);
          setShipToFormData(
            originalInvoiceData.shipToAddress || shipToFormData
          );
          setIsEditMode(false);
          setReceivedAmount(0); // Reset received amount on exit if not saved
        }
      });
    } else {
      setOriginalInvoiceData(invoiceData);
      setOriginalServiceItems(serviceItems);
      setFormData(invoiceData.billToAddress || formData);
      setShipToFormData(invoiceData.shipToAddress || shipToFormData);
      setIsEditMode(true);
      // setOriginalReceivedAmount(receivedAmount); // If you want to revert received amount
    }
  };

  const saveChanges = () => {
    if (formData.gstin && gstinError) {
      Swal.fire({
        icon: "error",
        title: "Invalid Input",
        text: "Please correct the invalid GSTIN before saving.",
        confirmButtonColor: "#3085d6",
      });
      return;
    }
    if (shipToFormData.gstin && shipToGstinError) {
      Swal.fire({
        icon: "error",
        title: "Invalid Input",
        text: "Please correct the invalid Ship To GSTIN before saving.",
        confirmButtonColor: "#3085d6",
      });
      return;
    }
    const newInvoiceData = {
      ...invoiceData,
      billToAddress: { ...formData },
      shipToAddress: { ...shipToFormData },
      receivedAmount: receivedAmount,
      grandTotal: displayedGrandTotal, // Save the calculated grand total
      balance: displayedBalance, // Save the calculated balance
    };
    setInvoiceData(newInvoiceData); // This might cause issues if invoiceData still has these keys, consider separate save data
    setOriginalInvoiceData(newInvoiceData); // Set original to the new saved state
    setOriginalServiceItems(serviceItems);
    setIsEditMode(false);
    setFormData(newInvoiceData.billToAddress);
    setShipToFormData(newInvoiceData.shipToAddress);
    console.log("Saving changes:", newInvoiceData, serviceItems);
    Swal.fire({
      icon: "success",
      title: "Success!",
      text: "Changes saved successfully!",
      confirmButtonColor: "#3085d6",
    });
  };

  const submitInvoice = async () => {
    if (formData.gstin && gstinError) {
      Swal.fire({
        icon: "error",
        title: "Invalid Input",
        text: "Please correct the invalid GSTIN before submitting.",
        confirmButtonColor: "#3085d6",
      });
      return;
    }
    if (shipToFormData.gstin && shipToGstinError) {
      Swal.fire({
        icon: "error",
        title: "Invalid Input",
        text: "Please correct the invalid Ship To GSTIN before submitting.",
        confirmButtonColor: "#3085d6",
      });
      return;
    }

    // Format invoice_date to ISO string
    let invoiceDateISO = "";
    try {
      invoiceDateISO = new Date(
        parseDateToISO(invoiceData.invoiceDate)
      ).toISOString();
    } catch (e) {
      console.error("Error formatting invoice date:", e);
      Swal.fire({
        icon: "error",
        title: "Date Error",
        text: "Could not format invoice date. Please check the date format.",
        confirmButtonColor: "#3085d6",
      });
      return;
    }

    console.log("formData at submission:", formData);
    console.log("shipToFormData at submission:", shipToFormData);

    const billToAddressObject = {
      name: formData.blockUnitStreetName,
      city: formData.city,
      state: formData.state,
      country: formData.country,
      pin: formData.pincode,
    };

    const shipToAddressObject = {
      name: shipToFormData.blockUnitStreetName,
      city: shipToFormData.city,
      state: shipToFormData.state,
      country: shipToFormData.country,
      pin: shipToFormData.pincode,
    };

    // Determine GST percentage for the overall invoice (using first item's tax rate as a proxy or default to 0)
    const overallGstPercentage =
      serviceItems.length > 0 ? `${serviceItems[0].taxRate}%` : "0%";

    console.log("shipToAddressObject", shipToAddressObject);
    console.log("billToAddressObject", billToAddressObject);

    const formattedData = {
      invoice_no: invoiceData.invoiceNo,
      invoice_date: invoiceDateISO,
      lead_id: selectedLeadId,
      bill_to_name: invoiceData.billToName,
      bill_to_phone: invoiceData.billToPhone,
      bill_to_email: invoiceData.billToEmail, // Added billToEmail

      bill_to_address: JSON.stringify(billToAddressObject), // Stringify formatted billToAddress
      bill_to_gsttin: formData.gstin, // Added bill_to_gsttin
      ship_to_name: invoiceData.shipToName,
      ship_to_phone: invoiceData.shipToPhone,
      ship_to_email: invoiceData.shipToEmail, // Added shipToEmail

      ship_to_address: JSON.stringify(shipToAddressObject), // Stringify formatted shipToAddress
      ship_to_gsttin: shipToFormData.gstin, // Added ship_to_gsttin
      sub_total: calculateSubTotal().toFixed(roundOffDecimal),
      grand_total: displayedGrandTotal.toFixed(roundOffDecimal),
      received_amount: receivedAmount.toFixed(roundOffDecimal),
      balance: displayedBalance.toFixed(roundOffDecimal),
      bank_name: invoiceData.bankName,
      account_name: invoiceData.accountName,
      ifsc_code: invoiceData.ifscCode,
      account_no: invoiceData.accountNo,
      bank_branch: invoiceData.bankBranch,
      payment_mode: "manual", // Hardcoded as per example
      gst: overallGstPercentage, // This will be "0%" if GST is disabled initially
      gst_payable: isGstEnabled
        ? calculateTotalGstPayable().toFixed(roundOffDecimal)
        : "0.00", // Conditionally include GST payable
      terms: invoiceData.termsAndConditions.join("\n"), // Join terms with newline
      signatory_by: invoiceData.authorisedSignatory, // Added signatory_by
      // created_at and updated_at and id are typically generated by the backend
      items: serviceItems.map((item) => ({
        item_name: item.description,
        qty: item.quantity,
        rate: item.rate.toFixed(roundOffDecimal),
        gst: isGstEnabled ? item.taxRate : 0, // Set GST to 0 if disabled
        amount: item.amount.toFixed(roundOffDecimal), // Apply rounding here for submission
      })),
    };

    console.log("Submitting invoice payload:", formattedData);

    try {
      const response = await api.post("/addinvoice", formattedData);
      if (response.data.success) {
        Swal.fire({
          icon: "success",
          title: "Invoice Saved!",
          text:
            response.data.message ||
            "Your invoice has been successfully saved.",
          confirmButtonColor: "#3085d6",
        });
        // Optionally reset form or navigate away
      } else {
        const errorMessage =
          response.data.message || "Failed to save invoice. Please try again.";
        let detailedErrors = "";
        if (response.data.errors) {
          detailedErrors = Object.keys(response.data.errors)
            .map((key) => {
              const fieldErrors = response.data.errors[key];
              // Format field names to be more readable (e.g., "invoice_no" to "Invoice No")
              const readableFieldName = key
                .replace(/_/g, " ")
                .replace(/\.0\./, " item 1 ")
                .toLowerCase()
                .split(" ")
                .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
                .join(" ");
              return `<li style="margin-bottom: 4px;"><strong>${readableFieldName}</strong>: <ul>${fieldErrors
                .map((err) => `<li>${err}</li>`)
                .join("")}</ul></li>`;
            })
            .join("");
        }

        Swal.fire({
          icon: "error",
          title: "Saving Failed!",
          html: `<p>${errorMessage}</p>${
            detailedErrors
              ? `<div style="text-align: left; background: #f7f7f7; padding: 10px; border-radius: 5px; margin-top: 10px; overflow-x: auto;"><ul style="list-style-type: none; padding: 0; margin: 0;">${detailedErrors}</ul></div>`
              : ""
          }`,
          confirmButtonColor: "#3085d6",
        });
      }
    } catch (error) {
      console.error("Error saving invoice:", error);
      const errorMessage =
        error.response && error.response.data && error.response.data.message
          ? error.response.data.message
          : "An error occurred while saving the invoice. Please check your network and try again.";
      let detailedErrors = "";
      if (error.response && error.response.data && error.response.data.errors) {
        detailedErrors = Object.keys(error.response.data.errors)
          .map((key) => {
            const fieldErrors = error.response.data.errors[key];
            const readableFieldName = key
              .replace(/_/g, " ")
              .replace(/\.0\./, " item 1 ")
              .toLowerCase()
              .split(" ")
              .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
              .join(" ");
            return `<li style="margin-bottom: 4px;"><strong>${readableFieldName}</strong>: <ul>${fieldErrors
              .map((err) => `<li>${err}</li>`)
              .join("")}</ul></li>`;
          })
          .join("");
      }

      Swal.fire({
        icon: "error",
        title: "Error!",
        html: `<p>${errorMessage}</p>${
          detailedErrors
            ? `<div style="text-align: left; background: #f7f7f7; padding: 10px; border-radius: 5px; margin-top: 10px; overflow-x: auto;"><ul style="list-style-type: none; padding: 0; margin: 0;">${detailedErrors}</ul></div>`
            : ""
        }`,
        confirmButtonColor: "#3085d6",
      });
    }
  };

  // Fetch leads when dropdown is opened
  useEffect(() => {
    if (leadDropdownOpen && leads.length === 0) {
      setLeadsLoading(true);
      api
        .get("/showlead")
        .then((res) => {
          if (res.data.success) {
            setLeads(res.data.result);
          }
        })
        .catch(() => {})
        .finally(() => setLeadsLoading(false));
    }
  }, [leadDropdownOpen]);

  // Filtered leads based on search
  const filteredLeads = leads.filter((lead) => {
    const term = leadSearchTerm.toLowerCase();
    return (
      lead.customer_name.toLowerCase().includes(term) ||
      lead.email.toLowerCase().includes(term) ||
      lead.contact.toLowerCase().includes(term)
    );
  });

  // Parse address helper
  function parseLeadAddress(addressString) {
    let parsedAddress = {
      blockUnitStreetName: "",
      city: "",
      state: "",
      country: "",
      pincode: "",
    };

    if (addressString && typeof addressString === "string") {
      try {
        const addressObj = JSON.parse(addressString);
        parsedAddress = {
          blockUnitStreetName: addressObj.name || "",
          city: addressObj.city || "",
          state: addressObj.state || "",
          country: addressObj.country || "",
          pincode: addressObj.pin || "",
        };
      } catch (e) {
        console.error("Failed to parse lead address JSON:", e);
        // Fallback if parsing fails, assume the string itself is the city
        parsedAddress.city = addressString;
      }
    }
    return parsedAddress;
  }

  // Autofill Bill To fields from lead
  const handleLeadSelect = (lead) => {
    const parsedAddress = parseLeadAddress(lead.city || "");
    setInvoiceData((prev) => ({
      ...prev,
      billToName: lead.customer_name || prev.billToName,
      billToPhone: lead.contact || prev.billToPhone,
      billToEmail: lead.email || prev.billToEmail,
      billToState: parsedAddress.state || prev.billToState,
      shipToName: lead.customer_name || prev.shipToName,
      shipToPhone: lead.contact || prev.shipToPhone,
      shipToEmail: lead.email || prev.shipToEmail,
      shipToState: parsedAddress.state || prev.shipToState,
    }));

    // Set Bill To form data
    setFormData((prev) => ({
      ...prev,
      ...parsedAddress,
    }));

    // Set Bill To selected country and state objects
    const countryFromParsed = Country.getAllCountries().find(
      (c) => c.name.toLowerCase() === parsedAddress.country.toLowerCase()
    );
    setSelectedCountryObj(countryFromParsed || null);
    if (countryFromParsed && parsedAddress.state) {
      const stateFromParsed = State.getStatesOfCountry(
        countryFromParsed.isoCode
      ).find((s) => s.name.toLowerCase() === parsedAddress.state.toLowerCase());
      setSelectedStateObj(stateFromParsed || null);
    }

    // Set Bill To search terms for dropdowns
    setCountrySearchTerm(parsedAddress.country || "");
    setStateSearchTerm(parsedAddress.state || "");
    setCitySearchTerm(parsedAddress.city || "");

    // Set Ship To form data
    setShipToFormData((prev) => ({
      ...prev,
      ...parsedAddress,
    }));

    // Set Ship To selected country and state objects
    setShipToSelectedCountryObj(countryFromParsed || null);
    if (countryFromParsed && parsedAddress.state) {
      const stateFromParsed = State.getStatesOfCountry(
        countryFromParsed.isoCode
      ).find((s) => s.name.toLowerCase() === parsedAddress.state.toLowerCase());
      setShipToSelectedStateObj(stateFromParsed || null);
    }

    // Set Ship To search terms for dropdowns
    setShipToCountrySearchTerm(parsedAddress.country || "");
    setShipToStateSearchTerm(parsedAddress.state || "");
    setShipToCitySearchTerm(parsedAddress.city || "");

    setLeadDropdownOpen(false);
    setLeadSearchTerm("");
    setShipToLeadDropdownOpen(false);
    setShipToLeadSearchTerm("");
    setSelectedLeadId(lead.customer_id); // Set selectedLeadId here
  };

  // Ship To lead select (independent)
  const handleShipToLeadSelect = (lead) => {
    const parsedAddress = parseLeadAddress(lead.city || "");
    setInvoiceData((prev) => ({
      ...prev,
      shipToName: lead.customer_name || prev.shipToName,
      shipToPhone: lead.contact || prev.shipToPhone,
      shipToEmail: lead.email || prev.shipToEmail,
      shipToState: parsedAddress.state || prev.shipToState,
    }));

    setShipToFormData((prev) => ({
      ...prev,
      ...parsedAddress,
    }));

    // Set Ship To selected country and state objects
    const countryFromParsed = Country.getAllCountries().find(
      (c) => c.name.toLowerCase() === parsedAddress.country.toLowerCase()
    );
    setShipToSelectedCountryObj(countryFromParsed || null);
    if (countryFromParsed && parsedAddress.state) {
      const stateFromParsed = State.getStatesOfCountry(
        countryFromParsed.isoCode
      ).find((s) => s.name.toLowerCase() === parsedAddress.state.toLowerCase());
      setShipToSelectedStateObj(stateFromParsed || null);
    }

    // Set Ship To search terms for dropdowns
    setShipToCountrySearchTerm(parsedAddress.country || "");
    setShipToStateSearchTerm(parsedAddress.state || "");
    setShipToCitySearchTerm(parsedAddress.city || "");

    setShipToLeadDropdownOpen(false);
    setShipToLeadSearchTerm("");
    setSelectedLeadId(lead.customer_id); // Set selectedLeadId here
  };

  // Ship To input change
  const handleShipToInputChange = (e) => {
    const { name, value } = e.target;
    if (
      [
        "blockUnitStreetName",
        "state",
        "city",
        "pincode",
        "country",
        "gstin",
      ].includes(name)
    ) {
      const updatedValue = name === "gstin" ? value.toUpperCase() : value;
      setShipToFormData((prev) => ({ ...prev, [name]: updatedValue }));
      // Update invoiceData.shipToState when shipToFormData.state changes
      if (name === "state") {
        setInvoiceData((prev) => ({ ...prev, shipToState: updatedValue }));
        // Also try to set shipToSelectedStateObj if state is manually entered
        if (shipToSelectedCountryObj) {
          const foundState = State.getStatesOfCountry(
            shipToSelectedCountryObj.isoCode
          ).find((s) => s.name.toLowerCase() === updatedValue.toLowerCase());
          setShipToSelectedStateObj(foundState || null);
          // Reset cities if state changes
          setShipToFilteredCities(
            foundState
              ? City.getCitiesOfState(
                  shipToSelectedCountryObj.isoCode,
                  foundState.isoCode
                )
              : []
          );
        }
      } else if (name === "country") {
        // Try to set shipToSelectedCountryObj if country is manually entered
        const foundCountry = Country.getAllCountries().find(
          (c) => c.name.toLowerCase() === updatedValue.toLowerCase()
        );
        setShipToSelectedCountryObj(foundCountry || null);
        setShipToSelectedStateObj(null);
      }
      if (name === "gstin") {
        if (!updatedValue) {
          setShipToGstinError("");
        } else {
          const gstinRegex =
            /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;
          setShipToGstinError(
            gstinRegex.test(updatedValue) ? "" : "Invalid GSTIN format."
          );
        }
      }
    } else {
      setInvoiceData((prev) => ({ ...prev, [name]: value }));
    }
  };

  // Ship To dropdown outside click
  useEffect(() => {
    function handleClickOutside(event) {
      if (
        shipToDropdownRef.current &&
        !shipToDropdownRef.current.contains(event.target)
      ) {
        setShipToLeadDropdownOpen(false);
      }
      if (
        shipToCountryDropdownRef.current &&
        !shipToCountryDropdownRef.current.contains(event.target)
      ) {
        setShipToCountryDropdownOpen(false);
      }
      if (
        shipToStateDropdownRef.current &&
        !shipToStateDropdownRef.current.contains(event.target)
      ) {
        setShipToStateDropdownOpen(false);
      }
      if (
        shipToCityDropdownRef.current &&
        !shipToCityDropdownRef.current.contains(event.target)
      ) {
        setShipToCityDropdownOpen(false);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, []);

  // Handlers for Ship To address fields
  const handleShipToCountrySearchChange = (e) => {
    const value = e.target.value;
    setShipToCountrySearchTerm(value);
    setShipToCountryDropdownOpen(true);

    // Clear dependent selections if country changes
    if (value === "") {
      setShipToFormData((prev) => ({ ...prev, country: "" }));
      setShipToSelectedCountryObj(null);
      setShipToSelectedStateObj(null);
      setShipToSelectedCityObj(null);
      setShipToStateSearchTerm("");
      setShipToCitySearchTerm("");
    }
  };
  const handleShipToCountrySelect = (country) => {
    setShipToFormData((prev) => ({
      ...prev,
      country: country.name,
      state: "",
      city: "",
    }));
    setShipToSelectedCountryObj(country);
    setShipToCountrySearchTerm(country.name);
    setShipToCountryDropdownOpen(false);

    // Clear dependent selections
    setShipToSelectedStateObj(null);
    setShipToSelectedCityObj(null);
    setShipToStateSearchTerm("");
    setShipToCitySearchTerm("");
  };

  const handleShipToStateSearchChange = (e) => {
    // Prevent state search if no country is selected
    if (!shipToCountrySearchTerm) {
      return;
    }

    const value = e.target.value;
    setShipToStateSearchTerm(value);
    setShipToStateDropdownOpen(true);

    // Clear dependent selections if state changes
    if (value === "") {
      setShipToSelectedCityObj(null);
      setShipToCitySearchTerm("");
    }
  };
  const handleShipToStateSelect = (state) => {
    console.log("handleShipToStateSelect called with:", state.name);
    setShipToFormData((prev) => ({ ...prev, state: state.name, city: "" }));
    setShipToSelectedStateObj(state);
    setShipToStateSearchTerm(state.name);
    setShipToStateDropdownOpen(false);
    setInvoiceData((prev) => {
      console.log(
        "Updating shipToState from",
        prev.shipToState,
        "to",
        state.name
      );
      return { ...prev, shipToState: state.name };
    });

    // Clear dependent selections
    setShipToSelectedCityObj(null);
    setShipToCitySearchTerm("");
  };

  const handleShipToCitySearchChange = (e) => {
    // Prevent city search if no state is selected
    if (!shipToStateSearchTerm) {
      return;
    }

    const value = e.target.value;
    setShipToCitySearchTerm(value);
    setShipToCityDropdownOpen(true);
  };
  const handleShipToCitySelect = (city) => {
    setShipToFormData((prev) => ({ ...prev, city: city.name }));
    setShipToSelectedCityObj(city);
    setShipToCitySearchTerm(city.name);
    setShipToCityDropdownOpen(false);
  };

  const handleEditedItemAmountChange = (index, value) => {
    const newServiceItems = [...serviceItems];
    const parsedValue = parseFloat(value);
    const roundedValue = isNaN(parsedValue) ? null : applyRoundOff(parsedValue);

    // Update the item's amount directly
    newServiceItems[index].amount = roundedValue;

    if (
      !isNaN(parsedValue) &&
      parsedValue >= 0 &&
      newServiceItems[index].taxRate > 0
    ) {
      // Calculate base amount from the edited total amount and tax rate
      const taxRate = newServiceItems[index].taxRate;

      let baseAmount;
      if (gstCalculationMethod === "exclusive") {
        // For exclusive GST: baseAmount = totalAmount / (1 + taxRate/100)
        baseAmount = roundedValue / (1 + taxRate / 100); // Use roundedValue here
      } else {
        // For inclusive GST: baseAmount = totalAmount (since total already includes GST)
        baseAmount = roundedValue; // Use roundedValue here
      }

      // Recalculate GST components using the base amount
      const { taxAmount, cgstAmount, sgstAmount, igstAmount } =
        calculateItemGST(
          baseAmount,
          taxRate,
          invoiceData.companyState,
          invoiceData.shipToState,
          isGstEnabled // Pass isGstEnabled to calculation
        );

      newServiceItems[index].taxAmount = taxAmount;
      newServiceItems[index].cgstAmount = cgstAmount;
      newServiceItems[index].sgstAmount = sgstAmount;
      newServiceItems[index].igstAmount = igstAmount;
      // Note: quantity and rate are not updated by editing the final amount
    } else if (isNaN(parsedValue) || parsedValue === null || parsedValue < 0) {
      // If the input is invalid or cleared, reset tax amounts to 0
      newServiceItems[index].amount = 0;
      newServiceItems[index].taxAmount = 0;
      newServiceItems[index].cgstAmount = 0;
      newServiceItems[index].sgstAmount = 0;
      newServiceItems[index].igstAmount = 0;
    }

    setServiceItems(newServiceItems);

    // Clear any manual override for this item's amount to allow calculated values to take over if input is cleared
    setEditedServiceItemAmounts((prev) => {
      const newEditedAmounts = { ...prev };
      if (value === "" || isNaN(parsedValue)) {
        delete newEditedAmounts[index];
      } else {
        newEditedAmounts[index] = roundedValue; // Store rounded value
      }
      return newEditedAmounts;
    });
  };

  const handleEditedGstLabelChange = (field, value) => {
    switch (field) {
      case "cgstLabel":
        setEditedCgstLabel(value);
        break;
      case "sgstLabel":
        setEditedSgstLabel(value);
        break;
      case "igstLabel":
        setEditedIgstLabel(value);
        break;
      default:
        break;
    }
  };

  const handleEditedGstPercentageChange = (field, value) => {
    const parsedValue = parseFloat(value) || null;
    switch (field) {
      case "cgstPercentage":
        setEditedCgstPercentage(parsedValue);
        break;
      case "sgstPercentage":
        setEditedSgstPercentage(parsedValue);
        break;
      case "igstPercentage":
        setEditedIgstPercentage(parsedValue);
        break;
      default:
        break;
    }
  };

  // Handler for combined address second line input
  const handleCombinedAddressSecondLineChange = (e) => {
    const value = e.target.value;
    setCombinedAddressSecondLine(value);

    const parts = value.split(",").map((p) => p.trim());
    let newAddressLine2 = "";
    let newCompanyCountry = "";
    let newCompanyPincode = "";

    // Attempt to parse: expecting City, State, Country, Pincode
    // This parsing is heuristic and might need refinement based on actual data variations
    if (parts.length >= 2) {
      newAddressLine2 = parts[0] + ", " + parts[1]; // City, State
    }
    if (parts.length >= 3) {
      newCompanyCountry = parts[2]; // Country
    }
    if (parts.length >= 4) {
      newCompanyPincode = parts[3]; // Pincode
    }

    setInvoiceData((prev) => ({
      ...prev,
      addressLine2: newAddressLine2,
      companyCountry: newCompanyCountry,
      companyPincode: newCompanyPincode,
    }));
  };

  // Bill To filtered lists
  const filteredCountries = useMemo(
    () =>
      Country.getAllCountries().filter(
        (country) =>
          country.name &&
          country.name.toLowerCase().includes(countrySearchTerm.toLowerCase())
      ),
    [countrySearchTerm]
  );
  const filteredStates = useMemo(
    () =>
      selectedCountryObj
        ? State.getStatesOfCountry(selectedCountryObj.isoCode).filter(
            (state) =>
              state.name &&
              state.name.toLowerCase().includes(stateSearchTerm.toLowerCase())
          )
        : [],
    [selectedCountryObj, stateSearchTerm]
  );
  const filteredCities = useMemo(
    () =>
      selectedCountryObj && selectedStateObj
        ? City.getCitiesOfState(
            selectedCountryObj.isoCode,
            selectedStateObj.isoCode
          ).filter(
            (city) =>
              city.name &&
              city.name.toLowerCase().includes(citySearchTerm.toLowerCase())
          )
        : [],
    [selectedCountryObj, selectedStateObj, citySearchTerm]
  );
  // Ship To filtered lists
  const shipToFilteredCountries = useMemo(
    () =>
      Country.getAllCountries().filter(
        (country) =>
          country.name &&
          country.name
            .toLowerCase()
            .includes(shipToCountrySearchTerm.toLowerCase())
      ),
    [shipToCountrySearchTerm]
  );
  const shipToFilteredStates = useMemo(
    () =>
      shipToSelectedCountryObj
        ? State.getStatesOfCountry(shipToSelectedCountryObj.isoCode).filter(
            (state) =>
              state.name &&
              state.name
                .toLowerCase()
                .includes(shipToStateSearchTerm.toLowerCase())
          )
        : [],
    [shipToSelectedCountryObj, shipToStateSearchTerm]
  );
  const shipToFilteredCities = useMemo(
    () =>
      shipToSelectedCountryObj && shipToSelectedStateObj
        ? City.getCitiesOfState(
            shipToSelectedCountryObj.isoCode,
            shipToSelectedStateObj.isoCode
          ).filter(
            (city) =>
              city.name &&
              city.name
                .toLowerCase()
                .includes(shipToCitySearchTerm.toLowerCase())
          )
        : [],
    [shipToSelectedCountryObj, shipToSelectedStateObj, shipToCitySearchTerm]
  );

  const companyStateClean = invoiceData.companyState
    ? invoiceData.companyState.toLowerCase().trim()
    : "";
  const shipToStateClean = invoiceData.shipToState
    ? invoiceData.shipToState.toLowerCase().trim()
    : "";
  const isIntraState = companyStateClean === shipToStateClean;

  useEffect(() => {
    function handleClickOutside(event) {
      if (
        openCalcDropdown === "roundOff" &&
        roundOffRef.current &&
        !roundOffRef.current.contains(event.target)
      ) {
        setOpenCalcDropdown(null);
      } else if (
        openCalcDropdown === "decimal" &&
        decimalRef.current &&
        !decimalRef.current.contains(event.target)
      ) {
        setOpenCalcDropdown(null);
      } else if (
        openCalcDropdown === "applyTo" &&
        applyToRef.current &&
        !applyToRef.current.contains(event.target)
      ) {
        setOpenCalcDropdown(null);
      } else if (
        openCalcDropdown === "gstMethod" &&
        gstMethodRef.current &&
        !gstMethodRef.current.contains(event.target)
      ) {
        setOpenCalcDropdown(null);
      }
    }
    if (openCalcDropdown) {
      document.addEventListener("mousedown", handleClickOutside);
    } else {
      document.removeEventListener("mousedown", handleClickOutside);
    }
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [openCalcDropdown]);

  // Effect to clear manually edited GST percentages when item count changes
  useEffect(() => {
    // Only clear if we are transitioning to or from multiple items context
    // Or if the GST breakdown is not shown (then percentages are irrelevant)
    if (serviceItems.length > 1 || !isGstEnabled) {
      // Changed showGstBreakdown to isGstEnabled
      setEditedCgstPercentage(null);
      setEditedSgstPercentage(null);
      setEditedIgstPercentage(null);
    }
  }, [serviceItems.length, isGstEnabled]); // Changed showGstBreakdown to isGstEnabled

  const handleRemoveTerm = (index) => {
    setInvoiceData((prev) => ({
      ...prev,
      termsAndConditions: prev.termsAndConditions.filter((_, i) => i !== index),
    }));
  };

  // Handler to copy Bill To fields to Ship To
  const copyBillToToShipTo = () => {
    setInvoiceData((prev) => ({
      ...prev,
      shipToName: prev.billToName,
      shipToPhone: prev.billToPhone,
      shipToEmail: prev.billToEmail,
      shipToState: prev.billToState,
      shipToAddress: { ...formData },
    }));
    setShipToFormData({ ...formData });
    setShipToSelectedCountryObj(selectedCountryObj);
    setShipToSelectedStateObj(selectedStateObj);
    setShipToSelectedCityObj(selectedCityObj);
    setShipToCountrySearchTerm(countrySearchTerm);
    setShipToStateSearchTerm(stateSearchTerm);
    setShipToCitySearchTerm(citySearchTerm);
  };

  // Handler to copy Ship To fields to Bill To
  const copyShipToToBillTo = () => {
    setInvoiceData((prev) => ({
      ...prev,
      billToName: prev.shipToName,
      billToPhone: prev.shipToPhone,
      billToEmail: prev.shipToEmail,
      billToState: prev.shipToState,
      billToAddress: { ...shipToFormData },
    }));
    setFormData({ ...shipToFormData });
    setSelectedCountryObj(shipToSelectedCountryObj);
    setSelectedStateObj(shipToSelectedStateObj);
    setSelectedCityObj(shipToSelectedCityObj);
    setCountrySearchTerm(shipToCountrySearchTerm);
    setStateSearchTerm(shipToStateSearchTerm);
    setCitySearchTerm(shipToCitySearchTerm);
  };

  console.log("here is collapsed", isCollapsed);

  // w-[90vw]   ${
  //       isCollapsed ? "lg:w-[70%] xl:w-[70%]" : "lg:w-[100%] xl:w-[70%]"
  //     } h-auto bg-white  p-4 sm:p-6 lg:px-[23px] lg:py-[20px] min-h-screen rounded-2xl flex flex-col relative

// Finds the max decimal places used in given numbers
const getMaxDecimalPlaces = (numbers = []) => {
  let maxDecimals = 0;
  numbers.forEach(num => {
    if (typeof num === "number" && !isNaN(num)) {
      const decimals = num.toString().split(".")[1]?.length || 0;
      if (decimals > maxDecimals) {
        maxDecimals = decimals;
      }
    }
  });
  return maxDecimals;
};

useEffect(() => {

  if (location?.state?.invoice) {
    const invoice = location.state.invoice;
console.log('running this round off effect')
    // Collect numeric values you care about
    const numericFields = [
      invoice?.subTotal,
      invoice?.totalAmount,
      invoice?.totalTaxAmount,
      invoice?.cgstAmount,
      invoice?.sgstAmount,
      invoice?.igstAmount,
      ...(invoice?.items?.map(item => item.amount) || [])
    ];

    const maxDecimals = getMaxDecimalPlaces(numericFields);

    // Example: update your decimalPlaces state or settings
    // Set decimal places based on round off setting
switch (location?.state?.invoice?.roundOff) {
  case "0 Decimal Places":
    setRoundOffDecimal(0);
    break;
  case "1 Decimal Places":
    setRoundOffDecimal(1);
    break;
  case "2 Decimal Places":
    setRoundOffDecimal(2);
    break;
  case "3 Decimal Places":
    setRoundOffDecimal(3);
    break;
  case "4 Decimal Places":
    setRoundOffDecimal(4);
    break;
  default:
    if (maxDecimals > 0) {
      setRoundOffDecimal(maxDecimals);
    }
    break;
}
  }
}, [location]);


  return (
    <div
      className={`w-[90vw] md:w-[85vw]  lg:w-[90%] xl:w-[70%]  h-auto bg-white p-4 sm:p-6 lg:p-[23px] min-h-screen rounded-2xl flex flex-col relative`}
    >
      <div className="text-right mb-2 mt-1">
        <h2 className="text-[rgb(39,152,255)] text-base sm:text-2xl lg:text-2xl xl:text-2xl font-bold font-quicksand">
          Invoice
        </h2>
      </div>
      {/* Header */}
      <div className="flex justify-between items-center mb-1 sm:mb-5">
        <div className="flex items-center ">
          {user?.profile_pic && ( // Conditionally render image
            <img
              src={user?.profile_pic}
              alt="Logo"
              className=" h-9 w-15 sm:h-12  md:h-24 sm:w-56 xl:mr-7 lg:mr-8 mr-5  ml-1 mb-2"
            />
          )}{" "}
          {/* Placeholder for logo */}
          <div className="">
            {isEditMode && canEditCompanyFields ? (
              <input
                type="text"
                name="companyName"
                placeholder="Enter Company Name"
                value={invoiceData.companyName}
                onChange={handleInputChange}
                className="text-[rgb(39,152,255)] mb-1 text-sm sm:text-3xl lg:text-[37px] tracking-wide font-bold w-4/5 px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
              />
            ) : (
              <h1 className="text-[rgb(39,152,255)] mb-3 text-sm sm:text-3xl lg:text-[37px] tracking-wide font-bold whitespace-nowrap">
                {invoiceData.companyName}
              </h1>
            )}

            {isEditMode && canEditCompanyFields ? (
              <div className="my-1">
                <input
                  type="text"
                  name="addressLine1"
                  placeholder="Enter Address Line 1"
                  value={invoiceData.addressLine1}
                  onChange={handleInputChange}
                  className="text-[8px] sm:text-xs text-[rgb(31,41,55)] w-4/5 block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] mb-1 whitespace-nowrap"
                />
                {/* Combined input for City, State, Country, Pincode */}
                <input
                  type="text"
                  name="combinedAddressSecondLine"
                  value={combinedAddressSecondLine}
                  onChange={handleCombinedAddressSecondLineChange}
                  placeholder="City, State, Country, Pincode"
                  className="text-[8px] sm:text-xs text-[rgb(31,41,55)] w-4/5 block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] mb-1 whitespace-nowrap"
                />
                <div className="flex gap-2">
                  <input
                    type="email"
                    name="organizationEmail"
                    value={organizationEmail}
                    placeholder="Enter Organization Email"
                    onChange={(e) => setOrganizationEmail(e.target.value)}
                    className="text-[8px] sm:text-xs text-[rgb(31,41,55)] w-20 sm:w-44 block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] mb-1"
                  />
                  <input
                    type="text"
                    name="mobile"
                    value={invoiceData.mobile}
                    onChange={handleInputChange}
                    placeholder="Enter Mobile Number"
                    className="text-[8px] sm:text-xs text-[rgb(31,41,55)] w-20 sm:w-44 block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                  />
                </div>
              </div>
            ) : (
              <div className="my-3">
                {/* Display each address line separately */}
                {invoiceData.addressLine1 && (
                  <p className="text-[8px] sm:text-sm text-[rgb(31,41,55)]">
                    {invoiceData.addressLine1}
                  </p>
                )}
                {/* Combine City, State, Country, Pincode into one line */}
                {(invoiceData.addressLine2 ||
                  invoiceData.companyPincode ||
                  invoiceData.companyCountry) && (
                  <p className="text-[8px] sm:text-sm text-[rgb(31,41,55)]">
                    {invoiceData.addressLine2}
                    {invoiceData.addressLine2 &&
                      (invoiceData.companyCountry ||
                        invoiceData.companyPincode) &&
                      ", "}
                    {invoiceData.companyCountry}
                    {invoiceData.companyCountry && invoiceData.companyPincode
                      ? ", "
                      : ""}
                    {invoiceData.companyPincode}
                  </p>
                )}
                {/* Email and Mobile will remain here as the last line */}
                <div className="flex gap-2 my-1">
                  {organizationEmail && (
                    <p className="text-[8px] sm:text-sm text-[rgb(31,41,55)] flex gap-1">
                      <p className="font-medium">Email:</p>
                      <p>{organizationEmail}</p>
                    </p>
                  )}
                  <p className="text-[8px] sm:text-sm text-[rgb(31,41,55)] flex gap-1">
                    <p className="font-medium">Mobile:</p>
                    {invoiceData.mobile}
                  </p>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>

      <hr className="border-t-2 border-[rgb(39,152,255)] mb-3.5" />

      {/* Invoice Details */}
      <div className="flex justify-between mb-3.5 text-xs sm:text-sm text-[#4B5563]">
        <div>
          Invoice No.:{" "}
          {isEditMode && canEditInvoiceNumber ? (
            <input
              type="text"
              name="invoiceNo"
              value={invoiceData.invoiceNo}
              onChange={handleInputChange}
              placeholder="No."
              className="w-24 px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
            />
          ) : (
            invoiceData.invoiceNo
          )}
        </div>
        <div>
          Invoice Date:{" "}
          {isEditMode ? (
            <input
              type="date"
              name="invoiceDate"
              value={parseDateToISO(invoiceData.invoiceDate)}
              onChange={handleInputChange}
              placeholder="Select Date"
              className="w-32 px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
            />
          ) : (
            formatDate(invoiceData.invoiceDate)
          )}
        </div>
      </div>

      <hr className="border-t border-[#E5E7EB] mb-6" />

      {/* Bill To / Ship To */}
      <div className="flex justify-between mb-8">
        <div className="w-1/2 pr-4">
          <h3 className="font-bold text-sm sm:text-lg mb-2 text-[#4B5563]">
            BILL TO
            {isEditMode && (
              <button
                type="button"
                onClick={copyBillToToShipTo}
                className="ml-3 px-2 py-1 bg-blue-50 text-[rgb(39,152,255)] rounded-2xl text-xs  hover:bg-blue-100 transition"
                style={{ marginLeft: 12 }}
              >
                Copy to Ship To
              </button>
            )}
          </h3>
          {/* Lead Search & Dropdown */}
          {isEditMode && (
            <div className="mb-2 relative" ref={leadDropdownRef}>
              <input
                type="text"
                placeholder="Search customer by name, email, or phone..."
                value={leadSearchTerm}
                onChange={(e) => {
                  setLeadSearchTerm(e.target.value);
                  setLeadDropdownOpen(true);
                }}
                onFocus={() => setLeadDropdownOpen(true)}
                className="w-full px-3 py-2 rounded-[12px] border border-[#E7EFF8] bg-[#F8FAFC] text-[#545454] focus:ring-2 focus:ring-[#0e4053] outline-none mb-1"
              />
              {leadDropdownOpen && (
                <div className="absolute z-20 w-full custom-scrollbar bg-white rounded-xl shadow-2xl border border-gray-200 mt-1 max-h-72 overflow-y-auto animate-fade-in">
                  {leadsLoading ? (
                    <div className="flex flex-col items-center justify-center p-6 text-gray-500">
                      <svg
                        className="animate-spin h-6 w-6 mb-2 text-blue-400"
                        fill="none"
                        viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <circle
                          className="opacity-25"
                          cx="12"
                          cy="12"
                          r="10"
                          stroke="currentColor"
                          strokeWidth="4"
                        ></circle>
                        <path
                          className="opacity-75"
                          fill="currentColor"
                          d="M4 12a8 8 0 018-8v8z"
                        ></path>
                      </svg>
                      Loading...
                    </div>
                  ) : filteredLeads.length > 0 ? (
                    filteredLeads.map((lead, idx) => (
                      <div
                        key={lead.customer_id}
                        className="flex items-center gap-3 px-4 py-3 cursor-pointer transition-colors hover:bg-blue-50/80 group"
                        style={{
                          borderBottom:
                            idx !== filteredLeads.length - 1
                              ? "1px solid #F1F5F9"
                              : "none",
                        }}
                        onClick={() => handleLeadSelect(lead)}
                      >
                        <img
                          src={lead.profile_pic}
                          alt="pic"
                          className="h-9 w-9 rounded-full object-cover border border-gray-200 shadow-sm"
                        />
                        <div className="flex flex-col flex-1 min-w-0">
                          <span className=" text-xs sm:text-base font-semibold text-gray-800 truncate group-hover:text-blue-700">
                            {lead.customer_name}
                          </span>
                          <span className="text-[10px] sm:text-xs text-gray-500 truncate">
                            {lead.email}
                          </span>
                          <span className="text-[10px]  sm:text-xs text-gray-400 truncate">
                            {lead.contact}
                          </span>
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="flex flex-col items-center justify-center p-6 text-gray-400">
                      <svg
                        className="h-8 w-8 mb-2"
                        fill="none"
                        stroke="currentColor"
                        strokeWidth="1.5"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-3A2.25 2.25 0 008.25 5.25V9m10.5 0A2.25 2.25 0 0121 11.25v7.5A2.25 2.25 0 0118.75 21H5.25A2.25 2.25 0 013 18.75v-7.5A2.25 2.25 0 015.25 9m13.5 0h-13.5"
                        />
                      </svg>
                      No leads found
                    </div>
                  )}
                </div>
              )}
            </div>
          )}
          {isEditMode ? (
            <>
              <div className="space-y-1">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Organisation
                </label>
                <div>
                  <input
                    type="text"
                    name="billToName"
                    value={invoiceData.billToName}
                    onChange={handleInputChange}
                    placeholder="Enter Bill To Name"
                    className="font-semibold text-[#1F2837] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] mb-1"
                  />
                  <div className="flex gap-2"></div>
                </div>
              </div>

              {/* Address */}
              <div className="space-y-1 mt-2">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Address
                </label>
                <div className="w-full rounded-[12px]  border border-white/20 flex flex-col">
                  <input
                    type="text"
                    name="blockUnitStreetName"
                    value={formData.blockUnitStreetName}
                    onChange={handleInputChange}
                    className="w-full h-[44px] px-3 flex items-center text-[#545454] border-b  bg-[#E7EFF8]/60 border border-white/20 outline-none rounded-t-[12px]"
                    placeholder="Block/Unit/Street Name"
                  />
                  {/* State and City Dropdowns */}
                  <div className="grid grid-cols-2  w-full">
                    {/* State Dropdown */}
                    <div className="relative" ref={stateDropdownRef}>
                      <input
                        type="text"
                        name="stateSearch"
                        value={stateSearchTerm}
                        onChange={handleStateSearchChange}
                        onFocus={() =>
                          countrySearchTerm && setStateDropdownOpen(true)
                        }
                        onBlur={() => setStateDropdownOpen(false)}
                        className={`w-full h-[44px] px-4 border border-white/20 outline-none text-[#545454] placeholder-[#545454] text-[16px] ${
                          !countrySearchTerm
                            ? "bg-gray-300 cursor-not-allowed opacity-60"
                            : "bg-[#E7EFF8]/60"
                        }`}
                        placeholder="Select State"
                        disabled={!countrySearchTerm}
                        readOnly={!countrySearchTerm}
                        autoComplete="off"
                      />

                      {stateDropdownOpen && countrySearchTerm && (
                        <div className="absolute z-10 w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                          {filteredStates.length > 0 ? (
                            filteredStates.map((state) => (
                              <div
                                key={state.isoCode}
                                className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                onClick={() => handleStateSelect(state)}
                                onMouseDown={(e) => e.preventDefault()}
                              >
                                {state.name}
                              </div>
                            ))
                          ) : (
                            <div className="p-3 text-gray-500">
                              No states found
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                    {/* City Dropdown */}
                    <div className="relative" ref={cityDropdownRef}>
                      <input
                        type="text"
                        name="citySearch"
                        value={citySearchTerm}
                        onChange={handleCitySearchChange}
                        onFocus={() =>
                          stateSearchTerm && setCityDropdownOpen(true)
                        }
                        onBlur={() => setCityDropdownOpen(false)}
                        className={`w-full h-[44px] px-4 border border-white/20 outline-none text-[#545454] placeholder-[#545454] text-[16px] ${
                          !stateSearchTerm
                            ? "bg-gray-300 cursor-not-allowed opacity-60"
                            : "bg-[#E7EFF8]/60"
                        }`}
                        placeholder="Select City"
                        disabled={!stateSearchTerm}
                        readOnly={!stateSearchTerm}
                        autoComplete="off"
                      />

                      {cityDropdownOpen && stateSearchTerm && (
                        <div className="absolute z-10 w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                          {filteredCities.length > 0 ? (
                            filteredCities.map((city) => (
                              <div
                                key={city.name}
                                className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                onClick={() => handleCitySelect(city)}
                                onMouseDown={(e) => e.preventDefault()}
                              >
                                {city.name}
                              </div>
                            ))
                          ) : (
                            <div className="p-3 text-gray-500">
                              No cities found
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                  {/* Pincode and Country */}
                  <div className="grid grid-cols-2  w-full">
                    {/* Pincode Input */}
                    <input
                      type="text"
                      name="pincode"
                      value={formData.pincode}
                      onChange={handleInputChange}
                      className="w-full h-[44px] px-3 flex items-center text-[#545454] bg-[#E7EFF8]/60 border border-white/20 rounded-bl-[12px] outline-none"
                      placeholder="Pincode"
                    />
                    {/* Country Dropdown */}
                    <div className="relative" ref={countryDropdownRef}>
                      <input
                        type="text"
                        name="countrySearch"
                        value={countrySearchTerm}
                        onChange={handleCountrySearchChange}
                        onFocus={() => setCountryDropdownOpen(true)}
                        onBlur={() => setCountryDropdownOpen(false)}
                        className="w-full h-[44px] px-4 bg-[#E7EFF8]/60 border border-white/20  outline-none text-[#545454] placeholder-[#545454] rounded-br-[12px] text-[16px]"
                        placeholder="Select Country"
                        autoComplete="off"
                      />

                      {countryDropdownOpen && (
                        <div className="absolute z-10 w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                          {filteredCountries.length > 0 ? (
                            filteredCountries.map((country) => (
                              <div
                                key={country.isoCode}
                                className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                onClick={() => handleCountrySelect(country)}
                                onMouseDown={(e) => e.preventDefault()}
                              >
                                {country.name}
                              </div>
                            ))
                          ) : (
                            <div className="p-3 text-gray-500">
                              No countries found
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>

              <div className="space-y-1 mt-2">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Contact
                </label>
                <div>
                  <div className="flex gap-2">
                    <input
                      type="email"
                      name="billToEmail"
                      value={invoiceData.billToEmail}
                      onChange={handleInputChange}
                      placeholder="Enter Bill To Email"
                      className="text-[#545454] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none placeholder-[#545454]"
                    />
                    <input
                      type="text"
                      name="billToPhone"
                      value={invoiceData.billToPhone}
                      onChange={handleInputChange}
                      placeholder="Enter Bill To Phone"
                      className="text-[#545454] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454]"
                    />
                  </div>
                </div>
              </div>

              <div className="space-y-1 mt-2">
                <label className="block text-[#4B5563] text-sm font-medium">
                  GSTIN
                </label>
                <input
                  type="text"
                  name="gstin"
                  value={formData.gstin}
                  onChange={handleInputChange}
                  placeholder="Enter GSTIN (Optional)"
                  className={`text-[#545454] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border ${
                    gstinError ? "border-red-500" : "border-white/20"
                  } focus:ring-2 focus:ring-[#0e4053] outline-none placeholder-[#545454]`}
                />
                {gstinError && (
                  <p className="text-red-500 text-xs mt-1">{gstinError}</p>
                )}
              </div>
            </>
          ) : (
            <>
              {/* Organisation Name */}
              <p className=" text-xs sm:text-base font-semibold text-[#1F2837]">
                {invoiceData.billToName}
              </p>
              {/* Address first line */}
              {invoiceData.billToAddress?.blockUnitStreetName && (
                <p className="text-[#545454] text-[10px] sm:text-xs">
                  {invoiceData.billToAddress.blockUnitStreetName}
                </p>
              )}
              {/* State and City (comma separated) */}
              {(invoiceData.billToAddress?.state ||
                invoiceData.billToAddress?.city) && (
                <p className="text-[#545454] text-[10px] sm:text-xs">
                  {invoiceData.billToAddress?.state}
                  {invoiceData.billToAddress?.state &&
                  invoiceData.billToAddress?.city
                    ? ", "
                    : ""}
                  {invoiceData.billToAddress?.city}
                </p>
              )}
              {/* Pincode and Country (comma separated) */}
              {(invoiceData.billToAddress?.pincode ||
                invoiceData.billToAddress?.country) && (
                <p className="text-[#545454] text-[10px] sm:text-xs">
                  {invoiceData.billToAddress?.pincode}
                  {invoiceData.billToAddress?.pincode &&
                  invoiceData.billToAddress?.country
                    ? ", "
                    : ""}
                  {invoiceData.billToAddress?.country}
                </p>
              )}
              {/* Email and Phone (on separate lines) */}
              {invoiceData.billToEmail && (
                <p className="text-[#545454] text-[10px] sm:text-xs">
                  Email: {invoiceData.billToEmail}
                </p>
              )}
              {invoiceData.billToPhone && (
                <p className="text-[#545454] text-[10px] sm:text-xs">
                  Mobile: {invoiceData.billToPhone}
                </p>
              )}
              {/* GST number */}
              {invoiceData.billToAddress?.gstin && (
                <p className="text-[#545454] text-[10px] sm:text-xs">
                  GSTIN: {invoiceData.billToAddress.gstin}
                </p>
              )}
            </>
          )}
        </div>
        <div className="w-1/2 pl-4">
          <h3 className="font-bold text-sm sm:text-lg mb-2 text-[#4B5563]">
            SHIP TO
            {isEditMode && (
              <button
                type="button"
                onClick={copyShipToToBillTo}
                className="ml-3 px-2 py-1 bg-blue-50 text-[rgb(39,152,255)] rounded-2xl text-xs  hover:bg-blue-100 transition"
                style={{ marginLeft: 12 }}
              >
                Copy to Bill To
              </button>
            )}
          </h3>
          {/* Ship To Lead Search & Dropdown */}
          {isEditMode && (
            <div className="mb-2 relative" ref={shipToDropdownRef}>
              <input
                type="text"
                placeholder="Search customer by name, email, or phone..."
                value={shipToLeadSearchTerm}
                onChange={(e) => {
                  setShipToLeadSearchTerm(e.target.value);
                  setShipToLeadDropdownOpen(true);
                }}
                onFocus={() => setShipToLeadDropdownOpen(true)}
                className="w-full px-3 py-2 rounded-[12px] border border-[#E7EFF8] bg-[#F8FAFC] text-[#545454] focus:ring-2 focus:ring-[#0e4053] outline-none mb-1"
              />
              {shipToLeadDropdownOpen && (
                <div className="absolute z-20 custom-scrollbar w-full bg-white rounded-xl shadow-2xl border border-gray-200 mt-1 max-h-72 overflow-y-auto animate-fade-in">
                  {leadsLoading ? (
                    <div className="flex flex-col items-center justify-center p-6 text-gray-500">
                      <svg
                        className="animate-spin h-6 w-6 mb-2 text-blue-400"
                        fill="none"
                        viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <circle
                          className="opacity-25"
                          cx="12"
                          cy="12"
                          r="10"
                          stroke="currentColor"
                          strokeWidth="4"
                        ></circle>
                        <path
                          className="opacity-75"
                          fill="currentColor"
                          d="M4 12a8 8 0 018-8v8z"
                        ></path>
                      </svg>
                      Loading...
                    </div>
                  ) : filteredLeads.length > 0 ? (
                    filteredLeads.map((lead, idx) => (
                      <div
                        key={lead.customer_id}
                        className="flex items-center gap-3 px-4 py-3 cursor-pointer transition-colors hover:bg-blue-50/80 group"
                        style={{
                          borderBottom:
                            idx !== filteredLeads.length - 1
                              ? "1px solid #F1F5F9"
                              : "none",
                        }}
                        onClick={() => handleShipToLeadSelect(lead)}
                      >
                        <img
                          src={lead.profile_pic}
                          alt="pic"
                          className="h-9 w-9 rounded-full object-cover border border-gray-200 shadow-sm"
                        />
                        <div className="flex flex-col flex-1 min-w-0">
                          <span className="font-semibold text-gray-800 truncate group-hover:text-blue-700">
                            {lead.customer_name}
                          </span>
                          <span className="text-xs text-gray-500 truncate">
                            {lead.email}
                          </span>
                          <span className="text-xs text-gray-400 truncate">
                            {lead.contact}
                          </span>
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="flex flex-col items-center justify-center p-6 text-gray-400">
                      <svg
                        className="h-8 w-8 mb-2"
                        fill="none"
                        stroke="currentColor"
                        strokeWidth="1.5"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-3A2.25 2.25 0 008.25 5.25V9m10.5 0A2.25 2.25 0 0121 11.25v7.5A2.25 2.25 0 0118.75 21H5.25A2.25 2.25 0 013 18.75v-7.5A2.25 2.25 0 015.25 9m13.5 0h-13.5"
                        />
                      </svg>
                      No leads found
                    </div>
                  )}
                </div>
              )}
            </div>
          )}
          {isEditMode ? (
            <>
              <div className="space-y-1">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Organisation
                </label>
                <div>
                  <input
                    type="text"
                    name="shipToName"
                    value={invoiceData.shipToName}
                    onChange={handleShipToInputChange}
                    placeholder="Enter Ship To Name"
                    className="font-semibold text-[#1F2837] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] mb-1"
                  />
                </div>
              </div>
              {/* Address */}
              <div className="space-y-1 mt-2">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Address
                </label>
                <div className="w-full rounded-[12px] border border-white/20 flex flex-col">
                  <input
                    type="text"
                    name="blockUnitStreetName"
                    value={shipToFormData.blockUnitStreetName}
                    onChange={handleShipToInputChange}
                    className="w-full h-[44px] px-3 flex items-center text-[#545454] border-b bg-[#E7EFF8]/60 border border-white/20 outline-none rounded-t-[12px]"
                    placeholder="Block/Unit/Street Name"
                  />
                  <div className="grid grid-cols-2 w-full">
                    {/* State Dropdown for Ship To */}
                    <div className="relative" ref={shipToStateDropdownRef}>
                      <input
                        type="text"
                        name="shipToStateSearch"
                        value={shipToStateSearchTerm}
                        onChange={handleShipToStateSearchChange}
                        onFocus={() =>
                          shipToCountrySearchTerm &&
                          setShipToStateDropdownOpen(true)
                        }
                        onBlur={() => setShipToStateDropdownOpen(false)}
                        className={`w-full h-[44px] px-4 border border-white/20 outline-none text-[#545454] placeholder-[#545454] text-[16px] ${
                          !shipToCountrySearchTerm
                            ? "bg-gray-300 cursor-not-allowed opacity-60"
                            : "bg-[#E7EFF8]/60"
                        }`}
                        placeholder="Select State"
                        disabled={!shipToCountrySearchTerm}
                        readOnly={!shipToCountrySearchTerm}
                        autoComplete="off"
                      />

                      {shipToStateDropdownOpen && shipToCountrySearchTerm && (
                        <div className="absolute z-10 w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                          {shipToFilteredStates.length > 0 ? (
                            shipToFilteredStates.map((state) => (
                              <div
                                key={state.isoCode}
                                className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                onClick={() => handleShipToStateSelect(state)}
                                onMouseDown={(e) => e.preventDefault()}
                              >
                                {state.name}
                              </div>
                            ))
                          ) : (
                            <div className="p-3 text-gray-500">
                              No states found
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                    {/* City Dropdown for Ship To */}
                    <div className="relative" ref={shipToCityDropdownRef}>
                      <input
                        type="text"
                        name="shipToCitySearch"
                        value={shipToCitySearchTerm}
                        onChange={handleShipToCitySearchChange}
                        onFocus={() =>
                          shipToStateSearchTerm &&
                          setShipToCityDropdownOpen(true)
                        }
                        onBlur={() => setShipToCityDropdownOpen(false)}
                        className={`w-full h-[44px] px-4 border border-white/20 outline-none text-[#545454] placeholder-[#545454] text-[16px] ${
                          !shipToStateSearchTerm
                            ? "bg-gray-300 cursor-not-allowed opacity-60"
                            : "bg-[#E7EFF8]/60"
                        }`}
                        placeholder="Select City"
                        disabled={!shipToStateSearchTerm}
                        readOnly={!shipToStateSearchTerm}
                        autoComplete="off"
                      />

                      {shipToCityDropdownOpen && shipToStateSearchTerm && (
                        <div className="absolute z-10 w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                          {shipToFilteredCities.length > 0 ? (
                            shipToFilteredCities.map((city) => (
                              <div
                                key={city.name}
                                className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                onClick={() => handleShipToCitySelect(city)}
                                onMouseDown={(e) => e.preventDefault()}
                              >
                                {city.name}
                              </div>
                            ))
                          ) : (
                            <div className="p-3 text-gray-500">
                              No cities found
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                  <div className="grid grid-cols-2 w-full">
                    {/* Pincode Input for Ship To */}
                    <input
                      type="text"
                      name="pincode"
                      value={shipToFormData.pincode}
                      onChange={handleShipToInputChange}
                      className="w-full h-[44px] px-3 flex items-center text-[#545454] bg-[#E7EFF8]/60 border border-white/20 rounded-bl-[12px] outline-none"
                      placeholder="Pincode"
                    />
                    {/* Country Dropdown for Ship To */}
                    <div className="relative" ref={shipToCountryDropdownRef}>
                      <input
                        type="text"
                        name="shipToCountrySearch"
                        value={
                          shipToFormData.country || shipToCountrySearchTerm
                        }
                        onChange={handleShipToCountrySearchChange}
                        onFocus={() => setShipToCountryDropdownOpen(true)}
                        className="w-full h-[44px] px-4 bg-[#E7EFF8]/60 border border-white/20 outline-none text-[#545454] placeholder-[#545454] rounded-br-[12px] text-[16px]"
                        placeholder="Select Country"
                        autoComplete="off"
                      />

                      {shipToCountryDropdownOpen && (
                        <div className="absolute z-10 w-full mt-1 bg-white rounded-[12px] shadow-lg max-h-60 overflow-y-auto border border-gray-200">
                          {shipToFilteredCountries.length > 0 ? (
                            shipToFilteredCountries.map((country) => (
                              <div
                                key={country.isoCode}
                                className="p-3 hover:bg-[#E7EFF8]/60 cursor-pointer text-[#545454] text-sm"
                                onClick={() =>
                                  handleShipToCountrySelect(country)
                                }
                                onMouseDown={(e) => e.preventDefault()}
                              >
                                {country.name}
                              </div>
                            ))
                          ) : (
                            <div className="p-3 text-gray-500">
                              No countries found
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>

              <div className="space-y-1 mt-2">
                <label className="block text-[#4B5563] text-sm font-medium">
                  Contact
                </label>
                <div>
                  <div className="flex gap-2">
                    <input
                      type="text"
                      name="shipToPhone"
                      value={invoiceData.shipToPhone}
                      onChange={handleShipToInputChange}
                      placeholder="Enter Ship To Phone"
                      className="text-[#545454] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none placeholder-[#545454]"
                    />
                    <input
                      type="email"
                      name="shipToEmail"
                      value={invoiceData.shipToEmail}
                      onChange={handleShipToInputChange}
                      placeholder="Enter Ship To Email"
                      className="text-[#545454] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none placeholder-[#545454]"
                    />
                  </div>
                </div>
              </div>

              <div className="space-y-1 mt-2">
                <label className="block text-[#4B5563] text-sm font-medium">
                  GSTIN
                </label>
                <input
                  type="text"
                  name="gstin"
                  value={shipToFormData.gstin}
                  onChange={handleShipToInputChange}
                  placeholder="Enter GSTIN (Optional)"
                  className={`text-[#545454] w-full block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border ${
                    shipToGstinError ? "border-red-500" : "border-white/20"
                  } focus:ring-2 focus:ring-[#0e4053] outline-none placeholder-[#545454]`}
                />
                {shipToGstinError && (
                  <p className="text-red-500 text-xs mt-1">
                    {shipToGstinError}
                  </p>
                )}
              </div>
            </>
          ) : (
            <>
              {/* Organisation Name */}
              <p className="text-xs sm:text-base font-semibold text-[#1F2837]">
                {invoiceData.shipToName}
              </p>
              {/* Address first line */}
              {invoiceData.shipToAddress?.blockUnitStreetName && (
                <p className="text-[#545454] text-[10px] sm:text-xs">
                  {invoiceData.shipToAddress.blockUnitStreetName}
                </p>
              )}
              {/* State and City (comma separated) */}
              {(invoiceData.shipToAddress?.state ||
                invoiceData.shipToAddress?.city) && (
                <p className="text-[#545454] text-[10px] sm:text-xs">
                  {invoiceData.shipToAddress?.state}
                  {invoiceData.shipToAddress?.state &&
                  invoiceData.shipToAddress?.city
                    ? ", "
                    : ""}
                  {invoiceData.shipToAddress?.city}
                </p>
              )}
              {/* Pincode and Country (comma separated) */}
              {(invoiceData.shipToAddress?.pincode ||
                invoiceData.shipToAddress?.country) && (
                <p className="text-[#545454] text-[10px] sm:text-xs">
                  {invoiceData.shipToAddress?.pincode}
                  {invoiceData.shipToAddress?.pincode &&
                  invoiceData.shipToAddress?.country
                    ? ", "
                    : ""}
                  {invoiceData.shipToAddress?.country}
                </p>
              )}
              {/* Email and Phone (on separate lines) */}
              {invoiceData.shipToEmail && (
                <p className="text-[#545454] text-[10px] sm:text-xs">
                  Email: {invoiceData.shipToEmail}
                </p>
              )}
              {invoiceData.shipToPhone && (
                <p className="text-[#545454] text-[10px] sm:text-xs">
                  Mobile: {invoiceData.shipToPhone}
                </p>
              )}
              {/* GST number */}
              {invoiceData.shipToAddress?.gstin && (
                <p className="text-[#545454] text-[10px] sm:text-xs">
                  GSTIN: {invoiceData.shipToAddress.gstin}
                </p>
              )}
            </>
          )}
        </div>
      </div>

      {/* Items Table */}
      <div className="relative border border-[#E5E7EB] rounded-t-xl border-b-0 ">
        <table className="w-full table-fixed border-separate border-spacing-0">
          <thead>
            <tr className="bg-[#E7EFF8]/30 text-left text-[#4B5563]">
              <th className="border-r border-b border-[#E5E7EB] p-2 text-left w-[50%] font-medium text-[8px] sm:text-sm">
                ITEMS
              </th>
              <th
                className={`border-r border-b border-[#E5E7EB] p-2 text-center font-medium text-[8px] sm:text-sm w-[12%]`}
              >
                QTY
              </th>
              <th
                className={`border-r border-b border-[#E5E7EB] p-2 text-center font-medium text-[8px] sm:text-sm w-[16.6%]`}
              >
                RATE
              </th>
              {/* GST Column - Only show if GST breakdown is enabled */}
              {isGstEnabled && (
                <th
                  className={`border-r border-b border-[#E5E7EB] p-2 text-center font-medium text-[8px] sm:text-sm w-[12%]`}
                >
                  GST
                </th>
              )}
              <th
                className={`border-b border-[#E5E7EB] p-2 text-right font-medium text-[8px] sm:text-sm ${
                  isGstEnabled ? "w-[13.4%]" : "w-[23.4%]"
                }`}
              >
                AMOUNT
              </th>
              {/* Removed the delete button's <th> */}
            </tr>
          </thead>
          <tbody>
            {serviceItems.map((item, index) => (
              <tr key={index} className={isEditMode ? "group" : ""}>
                <td className="border-r border-[#E5E7EB] p-2 text-[#545454] align-middle w-[50%] text-[10px] sm:text-base">
                  {isEditMode ? (
                    <textarea
                      value={item.description}
                      onChange={(e) =>
                        handleServiceItemChange(
                          index,
                          "description",
                          e.target.value
                        )
                      }
                      placeholder="Enter Description"
                      className="w-full min-h-[44px] px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] resize-y text-[10px] sm:text-base"
                      style={{ resize: "vertical" }}
                    />
                  ) : (
                    item.description
                  )}
                </td>
                <td
                  className={`border-r  border-[#E5E7EB] p-2 text-center text-[#545454] align-middle w-[12%] text-[10px] sm:text-base`}
                >
                  {isEditMode ? (
                    <input
                      type="number"
                      value={item.quantity}
                      onChange={(e) =>
                        handleServiceItemChange(
                          index,
                          "quantity",
                          e.target.value
                        )
                      }
                      placeholder="0"
                      className="w-full sm:text-xs px-1 py-2 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] text-center text-[10px] "
                    />
                  ) : (
                    item.quantity
                  )}
                </td>
                <td
                  className={`border-r border-[#E5E7EB] p-2 text-center text-[#545454] align-middle w-[16.6%] text-[10px] sm:text-base`}
                >
                  {isEditMode ? (
                    <input
                      type="number"
                      value={item.rate}
                      onChange={(e) =>
                        handleServiceItemChange(index, "rate", e.target.value)
                      }
                      placeholder="0"
                      className="w-full px-1 py-2 sm:text-xs rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] text-right text-[10px] "
                    />
                  ) : (
                    (isNaN(parseFloat(item.rate))
                      ? 0
                      : parseFloat(item.rate)
                    ).toFixed(roundOffDecimal)
                  )}
                </td>
                {/* GST Column - Only show if GST breakdown is enabled */}
                {isGstEnabled && (
                  <td
                    className={`border-r  border-[#E5E7EB] p-2 text-center text-[#545454] align-middle w-[12%]`}
                  >
                    {isEditMode ? (
                      <input
                        type="number"
                        value={item.taxRate}
                        onChange={(e) =>
                          handleServiceItemChange(
                            index,
                            "taxRate",
                            e.target.value
                          )
                        }
                        placeholder="0"
                        className="w-full px-1 py-2 text-xs rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] text-center"
                      />
                    ) : isNaN(parseFloat(item.taxRate)) ? (
                      0
                    ) : (
                      parseFloat(item.taxRate)
                    )}
                  </td>
                )}
                <td
                  className={`border-[#E5E7EB] p-2 text-right text-[#545454] align-middle text-[10px] sm:text-base ${
                    isGstEnabled ? "w-[13.4%]" : "w-[23.4%]"
                  }`}
                  style={{ position: isEditMode ? "relative" : undefined }}
                >
                  {isEditMode ? (
                    <input
                      type="number"
                      value={
                        editedServiceItemAmounts[index] !== undefined &&
                        editedServiceItemAmounts[index] !== null
                          ? editedServiceItemAmounts[index]
                          : item.amount
                      }
                      onChange={(e) =>
                        handleEditedItemAmountChange(index, e.target.value)
                      }
                      placeholder="0"
                      className="w-full px-1 py-2 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] text-right"
                    />
                  ) : (
                    (isNaN(parseFloat(item.amount))
                      ? 0
                      : parseFloat(item.amount)
                    ).toFixed(roundOffDecimal)
                  )}
                  {isEditMode && (
                    <button
                      type="button"
                      onClick={() => removeServiceItem(index)}
                      className="-right-[15px]  sm:-right-[22px]"
                      style={{
                        position: "absolute",
                        top: "50%",

                        transform: "translateY(-50%)",
                        background: "none",
                        border: "none",
                        cursor: "pointer",
                        padding: 0,
                        display: "flex",
                        alignItems: "center",
                        zIndex: 1000,
                      }}
                      title="Remove Item"
                    >
                      <RxCross2 size={15} color="#e53e3e" className=" sm:h-5" />
                    </button>
                  )}
                </td>
                {isEditMode && (
                  <button
                    onClick={() => removeServiceItem(index)}
                    className="absolute top-1/2 -translate-y-1/2 right-[-21px] flex items-center justify-center w-5 h-5 rounded-full hover:bg-red-100"
                    title="Delete"
                  ></button>
                )}
              </tr>
            ))}
            {/* Add empty rows to visually extend the table if there are few items */}
            {Array.from({ length: Math.max(0, 4 - serviceItems.length) }).map(
              (_, idx) => (
                <tr key={`empty-${idx}`}>
                  <td className="border-r border-[#E5E7EB] p-2 text-[#545454] align-middle h-12 border-t-0 border-b-0 w-[50%]">
                    {" "}
                  </td>
                  <td className="border-r border-[#E5E7EB] p-2 text-center text-[#545454] align-middle h-12 border-t-0 border-b-0 w-[12%]">
                    {" "}
                  </td>
                  <td className="border-r border-[#E5E7EB] p-2 text-right text-[#545454] align-middle h-12 border-t-0 border-b-0 w-[16.6%]">
                    {" "}
                  </td>
                  {isGstEnabled && (
                    <td className="border-r border-[#E5E7EB] p-2 text-center text-[#545454] align-middle h-12 border-t-0 border-b-0 w-[12%]">
                      {" "}
                    </td>
                  )}
                  <td
                    className={`border-[#E5E7EB] p-2 text-right text-[#545454] align-middle h-12 border-t-0 border-b-0 ${
                      isGstEnabled ? "w-[13.4%]" : "w-[23.4%]"
                    }`}
                  >
                    {" "}
                  </td>
                  {/* Removed the delete button's <td> for empty rows */}
                </tr>
              )
            )}
            {isEditMode && (
              <tr>
                <td colSpan={isGstEnabled ? "5" : "4"} className="p-2">
                  <button
                    onClick={addServiceItem}
                    className="h-[44px] px-10 rounded-[12px] bg-[#ef7e1b] border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-white w-full"
                  >
                    Add Item
                  </button>
                </td>
              </tr>
            )}
          </tbody>
        </table>
        {/* Cross buttons for each item, positioned outside the table */}
        {isEditMode && (
          <div
            style={{
              position: "absolute",
              top: 0,
              right: "-32px",
              height: "100%",
              zIndex: 99,
            }}
          >
            {serviceItems.map((item, index) => (
              <div
                key={index}
                style={{
                  position: "absolute",
                  top: `${index * 44}px`, // 44px is the row height, adjust as needed
                  right: 0,
                  zIndex: 10,
                }}
              ></div>
            ))}
          </div>
        )}
      </div>
      {/* Totals Section - matches PDF layout */}
      <div className="border border-[#E5E7EB] border-t-0 rounded-b-xl overflow-hidden mb-8">
        <table className="w-full table-fixed border-separate border-spacing-0">
          <thead className="invisible h-0">
            <tr>
              <th className="w-[50%]"></th>
              <th className="w-[12%]"></th>
              <th className="w-[16.6%]"></th>
              {isGstEnabled && <th className="w-[12%]"></th>}
              <th className={isGstEnabled ? "w-[13.4%]" : "w-[23.4%]"}></th>
            </tr>
          </thead>
          <tbody>
            {/* Totals section with Terms and Conditions as a left cell spanning all total rows (view and edit mode) */}
            {(isEditMode || !isEditMode) &&
              (() => {
                // Determine how many total rows will be rendered
                let totalRowsCount = 1; // SUB TOTAL
                if (isGstEnabled) totalRowsCount += 4; // CGST, SGST, IGST, TOTAL GST PAYABLE
                totalRowsCount += 3; // GRAND TOTAL, Received Amount, Balance
                let rowIndex = 0;
                return (
                  <>
                    {/* First row: Terms and Conditions cell + SUB TOTAL */}
                    <tr>
                      {/* SUB TOTAL */}

                      <td
                        colSpan={isGstEnabled ? 4 : 3}
                        className=" border-t border-[#E5E7EB] py-2 px-3 text-[8px] sm:text-xs text-right font-bold text-[#1F2837] leading-tight h-6 align-middle"
                      >
                        SUB TOTAL
                      </td>
                      <td
                        className={`border-l border-t border-[#E5E7EB] py-2 px-2 text-xs sm:text-sm text-right font-bold text-[#1F2837] leading-tight h-6 align-middle ${
                          isGstEnabled ? "w-[13.4%]" : "w-[23.4%]"
                        }`}
                      >
                        {isEditMode ? (
                          <input
                            type="number"
                            value={
                              editedSubTotal !== null
                                ? editedSubTotal
                                : calculateSubTotal()
                            }
                            onChange={(e) =>
                              handleEditedTotalChange(
                                "subTotal",
                                e.target.value
                              )
                            }
                            placeholder="0"
                            className="w-full px-1 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] text-right"
                          />
                        ) : (
                          calculateSubTotal().toFixed(roundOffDecimal)
                        )}
                      </td>
                    </tr>
                    {/* CGST, SGST, IGST, TOTAL GST PAYABLE (if GST breakdown) */}
                    {isGstEnabled && ( // Conditionally render this whole block
                      <>
                        <tr>
                          <td
                            colSpan={4}
                            className=" border-t border-[#E5E7EB] py-0.5 sm:px-3 text-right text-[8px] sm:text-[0.625rem] font-medium text-[#1F2837] leading-tight h-6 align-middle"
                          >
                            {isEditMode ? (
                              <input
                                type="text"
                                value={
                                  editedCgstLabel !== null
                                    ? editedCgstLabel
                                    : serviceItems.length > 1
                                    ? "AGGREGATED CGST AMOUNT"
                                    : "CGST AMOUNT"
                                }
                                onChange={(e) =>
                                  handleEditedGstLabelChange(
                                    "cgstLabel",
                                    e.target.value
                                  )
                                }
                                className=" text-left pl-1 sm:pl-0 sm:text-right  bg-transparent border-none outline-none font-medium text-[8px] sm:text-[0.625rem] text-[#1F2837] w-24"
                              />
                            ) : (
                              <span>CGST AMOUNT</span>
                            )}
                            {serviceItems.length > 0 &&
                              (isEditMode ? (
                                <span className="inline-flex items-baseline">
                                  <input
                                    type="number"
                                    value={
                                      editedCgstPercentage !== null
                                        ? editedCgstPercentage
                                        : serviceItems.length > 1
                                        ? ""
                                        : isIntraState && serviceItems[0]
                                        ? serviceItems[0].taxRate / 2
                                        : ""
                                    }
                                    onChange={(e) =>
                                      handleEditedGstPercentageChange(
                                        "cgstPercentage",
                                        e.target.value
                                      )
                                    }
                                    className="ml-1 text-right bg-transparent border-b outline-none text-[8px] sm:text-[0.625rem] font-medium text-[#1F2837] w-8"
                                    readOnly={
                                      serviceItems.length === 1 ? false : false
                                    } // Keep editable
                                  />
                                  <span className="text-[8px] sm:text-[0.625rem] font-medium text-[#1F2837]">
                                    %
                                  </span>
                                </span>
                              ) : (
                                isIntraState &&
                                serviceItems.length === 1 && (
                                  <span className="ml-1">
                                    ({parseFloat(serviceItems[0].taxRate) / 2}%
                                    )
                                  </span>
                                )
                              ))}
                          </td>
                          <td className="border-l border-t text-xs border-[#E5E7EB] py-0.5 px-2 text-right  text-[#1F2837] leading-tight h-6 align-middle">
                            {isEditMode ? (
                              <input
                                type="number"
                                value={
                                  editedCgstTotal !== null
                                    ? editedCgstTotal
                                    : calculateCgstTotal()
                                }
                                onChange={(e) =>
                                  handleEditedTotalChange(
                                    "cgstTotal",
                                    e.target.value
                                  )
                                }
                                placeholder="0"
                                className="w-full px-1  py-1 text-xs rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] text-right"
                              />
                            ) : (
                              calculateCgstTotal().toFixed(roundOffDecimal)
                            )}
                          </td>
                        </tr>
                        <tr>
                          <td
                            colSpan={4}
                            className=" border-t border-[#E5E7EB] py-0.5 sm:px-3 text-right text-[8px] sm:text-[0.625rem] font-medium text-[#1F2837] leading-tight h-6 align-middle"
                          >
                            {isEditMode ? (
                              <input
                                type="text"
                                value={
                                  editedSgstLabel !== null
                                    ? editedSgstLabel
                                    : serviceItems.length > 1
                                    ? "AGGREGATED SGST AMOUNT"
                                    : "SGST AMOUNT"
                                }
                                onChange={(e) =>
                                  handleEditedGstLabelChange(
                                    "sgstLabel",
                                    e.target.value
                                  )
                                }
                                className="text-left pl-1 sm:pl-0 sm:text-right bg-transparent border-none outline-none font-medium text-[8px] sm:text-[0.625rem] text-[#1F2837] w-24"
                              />
                            ) : (
                              <span>SGST AMOUNT</span>
                            )}
                            {serviceItems.length > 0 &&
                              (isEditMode ? (
                                <span className="inline-flex items-baseline">
                                  <input
                                    type="number"
                                    value={
                                      editedSgstPercentage !== null
                                        ? editedSgstPercentage
                                        : serviceItems.length > 1
                                        ? ""
                                        : isIntraState && serviceItems[0]
                                        ? serviceItems[0].taxRate / 2
                                        : ""
                                    }
                                    onChange={(e) =>
                                      handleEditedGstPercentageChange(
                                        "sgstPercentage",
                                        e.target.value
                                      )
                                    }
                                    className="ml-1 text-right bg-transparent border-b outline-none text-[8px] sm:text-[0.625rem] font-medium text-[#1F2837] w-8"
                                    readOnly={
                                      serviceItems.length === 1 ? false : false
                                    } // Keep editable
                                  />
                                  <span className="text-[8px] sm:text-[0.625rem] font-medium text-[#1F2837]">
                                    %
                                  </span>
                                </span>
                              ) : (
                                isIntraState &&
                                serviceItems.length === 1 && (
                                  <span className="ml-1">
                                    ({parseFloat(serviceItems[0].taxRate) / 2}%
                                    )
                                  </span>
                                )
                              ))}
                          </td>
                          <td className="border-l border-t text-xs border-[#E5E7EB] py-0.5 px-2 text-right  text-[#1F2837] leading-tight h-6 align-middle">
                            {isEditMode ? (
                              <input
                                type="number"
                                value={
                                  editedSgstTotal !== null
                                    ? editedSgstTotal
                                    : calculateSgstTotal()
                                }
                                onChange={(e) =>
                                  handleEditedTotalChange(
                                    "sgstTotal",
                                    e.target.value
                                  )
                                }
                                placeholder="0"
                                className="w-full px-1 py-1 text-xs rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] text-right"
                              />
                            ) : (
                              calculateSgstTotal().toFixed(roundOffDecimal)
                            )}
                          </td>
                        </tr>
                        <tr>
                          <td
                            colSpan={4}
                            className=" border-t border-[#E5E7EB] py-0.5 sm:px-3 text-right text-[8px] sm:text-[0.625rem] font-medium text-[#1F2837] leading-tight h-6 align-middle"
                          >
                            {isEditMode ? (
                              <input
                                type="text"
                                value={
                                  editedIgstLabel !== null
                                    ? editedIgstLabel
                                    : serviceItems.length > 1
                                    ? "AGGREGATED IGST AMOUNT"
                                    : "IGST AMOUNT"
                                }
                                onChange={(e) =>
                                  handleEditedGstLabelChange(
                                    "igstLabel",
                                    e.target.value
                                  )
                                }
                                className="text-left pl-1 sm:pl-0 sm:text-right bg-transparent border-none outline-none font-medium text-[8px] sm:text-[0.625rem] text-[#1F2837] w-24"
                              />
                            ) : (
                              <span>IGST AMOUNT</span>
                            )}
                            {serviceItems.length > 0 &&
                              (isEditMode ? (
                                <span className="inline-flex items-baseline">
                                  <input
                                    type="number"
                                    value={
                                      editedIgstPercentage !== null
                                        ? editedIgstPercentage
                                        : serviceItems.length > 1
                                        ? ""
                                        : !isIntraState && serviceItems[0]
                                        ? serviceItems[0].taxRate
                                        : ""
                                    }
                                    onChange={(e) =>
                                      handleEditedGstPercentageChange(
                                        "igstPercentage",
                                        e.target.value
                                      )
                                    }
                                    className="ml-1 text-right bg-transparent border-b outline-none text-[8px] sm:text-[0.625rem] font-medium text-[#1F2837] w-8"
                                    readOnly={
                                      serviceItems.length === 1 ? false : false
                                    } // Keep editable
                                  />
                                  <span className="text-[8px] sm:text-[0.625rem] font-medium text-[#1F2837]">
                                    %
                                  </span>
                                </span>
                              ) : (
                                !isIntraState &&
                                serviceItems.length === 1 && (
                                  <span className="ml-1">
                                    ({parseFloat(serviceItems[0].taxRate)}%)
                                  </span>
                                )
                              ))}
                          </td>
                          <td className="border-l border-t text-xs border-[#E5E7EB] py-0.5 px-2 text-right  text-[#1F2837] leading-tight h-6 align-middle">
                            {isEditMode ? (
                              <input
                                type="number"
                                value={
                                  editedIgstTotal !== null
                                    ? editedIgstTotal
                                    : calculateIgstTotal()
                                }
                                onChange={(e) =>
                                  handleEditedTotalChange(
                                    "igstTotal",
                                    e.target.value
                                  )
                                }
                                placeholder="0"
                                className="w-full px-1 py-1 text-xs rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] text-right"
                              />
                            ) : (
                              calculateIgstTotal().toFixed(roundOffDecimal)
                            )}
                          </td>
                        </tr>
                        <tr>
                          <td
                            colSpan={4}
                            className=" border-t border-[#E5E7EB] py-0.5 px-3 text-right font-medium text-[8px] sm:text-[0.625rem] text-[#1F2837] leading-tight h-6 align-middle"
                          >
                            TOTAL GST PAYABLE
                          </td>
                          <td
                            className={`border-l border-t border-[#E5E7EB] text-xs py-0.5 px-2 text-right text-[#1F2837] leading-tight h-6 align-middle ${
                              !isEditMode ? "rounded-br-xl" : ""
                            }`}
                          >
                            {isEditMode ? (
                              <input
                                type="number"
                                value={
                                  editedTotalGstPayable !== null
                                    ? editedTotalGstPayable
                                    : calculateTotalGstPayable()
                                }
                                onChange={(e) =>
                                  handleEditedTotalGstPayableChange(
                                    e.target.value
                                  )
                                }
                                placeholder="0"
                                className="w-full px-1 py-1 text-xs rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] text-right"
                              />
                            ) : (
                              calculateTotalGstPayable().toFixed(
                                roundOffDecimal
                              )
                            )}
                          </td>
                        </tr>
                      </>
                    )}
                    {/* GRAND TOTAL */}

                    <td></td>
                  </>
                );
              })()}
          </tbody>
        </table>
      </div>

      {/* Bank Details and Totals */}
      <div className="flex justify-between mb-4 mt-4 mx-1 text-sm text-[#4B5563]">
        <div className="w-1/2 pr-4">
          <div className="flex mb-1">
            <span className="w-32 text-[8px] sm:text-sm font-semibold whitespace-nowrap">
              Bank Name:
            </span>
            {isEditMode && canEditCompanyFields ? (
              <input
                type="text"
                name="bankName"
                value={invoiceData.bankName}
                onChange={handleInputChange}
                placeholder="Enter Bank Name"
                className="flex-grow px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] whitespace-nowrap text-[8px] sm:text-sm "
              />
            ) : (
              <span className="text-[#545454] w-1/2 whitespace-nowrap text-[8px] sm:text-sm">
                {invoiceData.bankName}
              </span>
            )}
          </div>
          <div className="flex mb-1">
            <span className="w-32 font-semibold whitespace-nowrap text-[8px] sm:text-sm">
              Account Name:
            </span>
            {isEditMode && canEditCompanyFields ? (
              <input
                type="text"
                name="accountName"
                value={invoiceData.accountName}
                onChange={handleInputChange}
                placeholder="Enter Account Name"
                className="flex-grow px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] whitespace-nowrap text-[8px] sm:text-sm"
              />
            ) : (
              <span className="text-[#545454] whitespace-nowrap text-[8px] sm:text-sm">
                {invoiceData.accountName}
              </span>
            )}
          </div>
          <div className="flex mb-1">
            <span className="w-32 font-semibold whitespace-nowrap text-[8px] sm:text-sm">
              IFSC Code:
            </span>
            {isEditMode && canEditCompanyFields ? (
              <input
                type="text"
                name="ifscCode"
                value={invoiceData.ifscCode}
                onChange={handleInputChange}
                placeholder="Enter IFSC Code"
                className="flex-grow px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] whitespace-nowrap text-[8px] sm:text-sm"
              />
            ) : (
              <span className="text-[#545454] whitespace-nowrap text-[8px] sm:text-sm">
                {invoiceData.ifscCode}
              </span>
            )}
          </div>
          <div className="flex mb-1">
            <span className="w-32 font-semibold whitespace-nowrap text-[8px] sm:text-sm">
              Account No:
            </span>
            {isEditMode && canEditCompanyFields ? (
              <input
                type="text"
                name="accountNo"
                value={invoiceData.accountNo}
                onChange={handleInputChange}
                placeholder="Enter Account No."
                className="flex-grow px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] whitespace-nowrap  text-[8px] sm:text-sm"
              />
            ) : (
              <span className="text-[#545454] whitespace-nowrap text-[8px] sm:text-sm">
                {invoiceData.accountNo}
              </span>
            )}
          </div>
          <div className="flex mb-1">
            <span className="w-32 font-semibold whitespace-nowrap text-[8px] sm:text-sm">
              Bank Branch:
            </span>
            {isEditMode && canEditCompanyFields ? (
              <input
                type="text"
                name="bankBranch"
                value={invoiceData.bankBranch}
                onChange={handleInputChange}
                placeholder="Enter Bank Branch"
                className="flex-grow px-3 py-1  rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] whitespace-nowrap text-[8px] sm:text-sm"
              />
            ) : (
              <span className="text-[#545454] whitespace-nowrap text-[8px] sm:text-sm">
                {invoiceData.bankBranch}
              </span>
            )}
          </div>
        </div>
        <div className="flex flex-col space-y-2">
          {/* GRAND TOTAL */}
          <div className="flex items-center space-x-2">
            <span className="w-32 text-[8px] sm:text-xs font-bold text-[#1F2837] text-right">
              GRAND TOTAL
            </span>
            {isEditMode ? (
              <input
                type="number"
                value={displayedGrandTotal}
                onChange={(e) =>
                  handleEditedOverallTotalChange("grandTotal", e.target.value)
                }
                placeholder="0"
                className="w-14  sm:w-20 lg:w-28 xl:w-32 px-2 py-1 font-bold text-xs bg-transparent border-b-2 border-[#0e4053] focus:outline-none text-[#545454] placeholder-[#545454] text-right"
              />
            ) : (
              <span className="w-14  sm:w-20 lg:w-28 xl:w-32 px-2 py-1 font-bold text-xs text-[#545454] text-right border-b-2 border-[#E5E7EB]">
                {displayedGrandTotal.toFixed(roundOffDecimal)}
              </span>
            )}
          </div>

          {/* Received Amount */}
          <div className="flex items-center space-x-2">
            <span className="w-32  text-[8px] sm:text-xs font-bold text-[#1F2837] text-right">
              Received Amount
            </span>
            {isEditMode ? (
              <input
                type="number"
                name="receivedAmount"
                value={receivedAmount}
                onChange={(e) =>
                  setReceivedAmount(parseFloat(e.target.value) || 0)
                }
                placeholder="0"
                className="w-32 px-2 py-1 text-xs bg-transparent border-b-2 border-[#0e4053] focus:outline-none text-[#545454] placeholder-[#545454] text-right"
              />
            ) : (
              <span className="w-14  sm:w-20 lg:w-28 xl:w-32 px-2 py-1 text-xs text-[#545454] text-right border-b-2 border-[#E5E7EB]">
                {receivedAmount.toFixed(roundOffDecimal)}
              </span>
            )}
          </div>

          {/* Balance */}
          <div className="flex items-center space-x-2">
            <span className="w-32   text-[8px] sm:text-xs font-bold text-[#1F2837] text-right">
              Balance
            </span>
            {isEditMode ? (
              <input
                type="number"
                value={displayedBalance}
                onChange={(e) =>
                  handleEditedOverallTotalChange("balance", e.target.value)
                }
                placeholder="0"
                className="w-32 px-2 py-1 text-xs bg-transparent border-b-2 border-[#0e4053] focus:outline-none text-[#545454] placeholder-[#545454] text-right"
              />
            ) : (
              <span className="w-14  sm:w-20 lg:w-28 xl:w-32 px-2 py-1 text-xs text-[#545454] text-right border-b-2 border-[#E5E7EB]">
                {displayedBalance.toFixed(roundOffDecimal)}
              </span>
            )}
          </div>
        </div>
      </div>

      <div className="flex justify-between mb-4 mt-4 mx-1 text-sm text-[#4B5563] ">
        <div className="text-[8px] sm:text-xs text-[#4B5563] px-2 py-2 w-96">
          <span className="font-bold">TERMS AND CONDITIONS:</span>
          <ol className=" list-outside space-y-1 mt-2">
            {isEditMode && canEditCompanyFields ? (
              <>
                {invoiceData.termsAndConditions.map((term, index) => (
                  <li
                    key={index}
                    style={{
                      display: "flex",
                      alignItems: "flex-start",
                      marginBottom: "8px",
                    }}
                  >
                    <span className=" text-[#545454] font-medium min-w-[20px]">
                      {index + 1}.
                    </span>
                    <textarea
                      value={term}
                      onChange={(e) => {
                        const newTerms = [...invoiceData.termsAndConditions];
                        newTerms[index] = e.target.value;
                        setInvoiceData((prev) => ({
                          ...prev,
                          termsAndConditions: newTerms,
                        }));
                        autoResizeTextarea(e);
                      }}
                      onInput={autoResizeTextarea}
                      placeholder="Enter Term"
                      className="flex-1 px-3 py-1  overflow-y-hidden rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none text-[#545454] placeholder-[#545454] resize-y terms-textarea"
                    />
                    <button
                      type="button"
                      onClick={() => handleRemoveTerm(index)}
                      style={{
                        marginLeft: 8,
                        background: "none",
                        border: "none",
                        cursor: "pointer",
                        padding: 0,
                        display: "flex",
                        alignItems: "center",
                      }}
                      title="Remove"
                    >
                      <RxCross2 size={15} color="#e53e3e" />
                    </button>
                  </li>
                ))}
                <li>
                  <button
                    onClick={() =>
                      setInvoiceData((prev) => ({
                        ...prev,
                        termsAndConditions: [...prev.termsAndConditions, ""],
                      }))
                    }
                    className="text-blue-500 hover:text-blue-700 mt-2 ml-6"
                  >
                    Add Term
                  </button>
                </li>
              </>
            ) : (
              invoiceData.termsAndConditions?.map((term, index) => (
                <li key={index} className="mb-2 flex">
                  <span className=" mr-1 text-[#545454] font-medium">
                    {index + 1}.
                  </span>
                  <div
                    className="whitespace-pre-wrap text-[#545454]"
                    style={{ whiteSpace: "pre-wrap" }}
                  >
                    {term}
                  </div>
                </li>
              ))
            )}
          </ol>
        </div>
        <div className="w-1/2 pl-1 sm:pl-14  lg:pl-24 xl:pl-32 text-right">
          <div className="w-full text-center pl-4 sm:pl-0">
            {invoiceData.upload_seal && invoiceData.upload_seal !== "" && (
              <img
                src={invoiceData.upload_seal}
                alt="Authorised Seal"
                className="mx-auto mb-2 h-10 sm:h-20"
              />
            )}
            <p className=" text-[8px] sm:text-base font-bold text-[#1F2837] ">
              AUTHORISED SIGNATORY FOR
            </p>
            {isEditMode && canEditCompanyFields ? (
              <input
                type="text"
                name="authorisedSignatory"
                value={invoiceData.authorisedSignatory}
                onChange={handleInputChange}
                placeholder="Enter Authorised Signatory"
                className="text-[#545454] w-full text-center block px-3 py-1 rounded-[12px] bg-[#E7EFF8]/60 border border-white/20 focus:ring-2 focus:ring-[#0e4053] outline-none placeholder-[#545454] whitespace-nowrap text-[8px] sm:text-base"
              />
            ) : (
              <p className="text-[#545454] text-[8px] sm:text-base">
                {invoiceData.authorisedSignatory}
              </p>
            )}
          </div>
        </div>
      </div>

      {/* Calculation Breakdown (Edit Mode Only) */}
      {isEditMode &&
        isGstEnabled && ( // Only show calculation breakdown if GST is enabled
          <div className="mt-9 p-4 bg-[#F8FAFC] rounded-xl border border-[#E7EFF8] text-xs text-[#545454]">
            <h3 className="font-bold mb-3 text-base text-[#1F2837]">
              Calculation Breakdown
            </h3>
            <div className="space-y-4">
              {serviceItems.map((item, index) => {
                const preTaxAmount =
                  gstCalculationMethod === "inclusive"
                    ? item.amount - item.taxAmount
                    : item.quantity * item.rate;
                const baseAmount = item.quantity * item.rate;
                const halfTaxRate = parseFloat(item.taxRate) / 2;
                const companyStateClean = invoiceData.companyState
                  ? invoiceData.companyState.toLowerCase().trim()
                  : "";
                const shipToStateClean = invoiceData.shipToState
                  ? invoiceData.shipToState.toLowerCase().trim()
                  : "";
                const isIntraState = companyStateClean === shipToStateClean;

                return (
                  <div
                    key={index}
                    className=" pb-3 mb-3 last:border-b-0 last:pb-0 last:mb-0"
                  >
                    <p className="font-semibold mb-2 text-sm text-gray-800">
                      Item {index + 1}: {item.description || "New Item"}
                    </p>
                    <div className="flex justify-between items-center text-gray-600">
                      <span>
                        Calculation Type:{" "}
                        <span className="font-medium text-gray-700">
                          {gstCalculationMethod === "inclusive"
                            ? "GST Inclusive"
                            : "GST Exclusive"}
                        </span>
                      </span>
                    </div>

                    {gstCalculationMethod === "inclusive" ? (
                      <>
                        <div className="flex justify-between items-center text-gray-600">
                          <span>Gross Amount (Qty x Rate)</span>
                          <span className="font-medium text-gray-700">
                            {item.quantity} x{" "}
                            {parseFloat(item.rate).toFixed(roundOffDecimal)} ={" "}
                            {parseFloat(baseAmount).toFixed(roundOffDecimal)}
                          </span>
                        </div>
                        <div className="flex justify-between items-center text-gray-600 pl-4">
                          <span>
                            └ Pre-Tax Value (Gross / (1 + GST Rate/100))
                          </span>
                          <span className="font-medium text-gray-700">
                            {parseFloat(baseAmount).toFixed(roundOffDecimal)} /{" "}
                            {(1 + parseFloat(item.taxRate) / 100).toFixed(
                              roundOffDecimal
                            )}{" "}
                            ={" "}
                            {parseFloat(preTaxAmount).toFixed(roundOffDecimal)}
                          </span>
                        </div>
                        <div className="flex justify-between items-center text-gray-600 pl-4">
                          <span>└ Tax Amount (Gross - Pre-Tax)</span>
                          <span className="font-medium text-gray-700">
                            {parseFloat(baseAmount).toFixed(roundOffDecimal)} -{" "}
                            {parseFloat(preTaxAmount).toFixed(roundOffDecimal)}{" "}
                            ={" "}
                            {parseFloat(item.taxAmount).toFixed(
                              roundOffDecimal
                            )}
                          </span>
                        </div>
                      </>
                    ) : (
                      <>
                        <div className="flex justify-between items-center text-gray-600">
                          <span>Base Amount (Qty x Rate)</span>
                          <span className="font-medium text-gray-700">
                            {item.quantity} x{" "}
                            {parseFloat(item.rate).toFixed(roundOffDecimal)} ={" "}
                            {parseFloat(baseAmount).toFixed(roundOffDecimal)}
                          </span>
                        </div>
                      </>
                    )}

                    {isGstEnabled && ( // Conditionally render GST logic breakdown
                      <>
                        <div className="flex justify-between items-center mt-1 text-gray-600">
                          <span>
                            GST Logic:{" "}
                            <span className="font-medium text-gray-700">
                              {isIntraState
                                ? `Intra-State (${
                                    invoiceData.companyState || "N/A"
                                  } -> ${invoiceData.shipToState || "N/A"})`
                                : `Inter-State (${
                                    invoiceData.companyState || "N/A"
                                  } -> ${invoiceData.shipToState || "N/A"})`}
                            </span>
                          </span>
                        </div>
                        {isIntraState ? (
                          <>
                            <div className="flex justify-between items-center pl-4">
                              <span>
                                CGST ({isNaN(halfTaxRate) ? 0 : halfTaxRate}% of
                                Pre-Tax)
                              </span>
                              <span className="font-medium text-gray-700">
                                ={" "}
                                {(isNaN(parseFloat(item.cgstAmount))
                                  ? 0
                                  : parseFloat(item.cgstAmount)
                                ).toFixed(roundOffDecimal)}
                              </span>
                            </div>
                            <div className="flex justify-between items-center pl-4">
                              <span>
                                SGST ({isNaN(halfTaxRate) ? 0 : halfTaxRate}% of
                                Pre-Tax)
                              </span>
                              <span className="font-medium text-gray-700">
                                ={" "}
                                {(isNaN(parseFloat(item.sgstAmount))
                                  ? 0
                                  : parseFloat(item.sgstAmount)
                                ).toFixed(roundOffDecimal)}
                              </span>
                            </div>
                          </>
                        ) : (
                          <div className="flex justify-between items-center pl-4">
                            <span>
                              IGST (
                              {isNaN(parseFloat(item.taxRate))
                                ? 0
                                : parseFloat(item.taxRate)}
                              % of Pre-Tax)
                            </span>
                            <span className="font-medium text-gray-700">
                              ={" "}
                              {(isNaN(parseFloat(item.igstAmount))
                                ? 0
                                : parseFloat(item.igstAmount)
                              ).toFixed(roundOffDecimal)}
                            </span>
                          </div>
                        )}
                      </>
                    )}

                    <div className="flex justify-between items-center font-bold mt-2 pt-2 border-t border-gray-200 text-gray-800">
                      <span>
                        Total for item (
                        {gstCalculationMethod === "exclusive"
                          ? `Base + GST`
                          : `Gross Amount`}
                        )
                      </span>
                      <span className="text-[#1F2837]">
                        {gstCalculationMethod === "exclusive"
                          ? `${parseFloat(baseAmount).toFixed(
                              roundOffDecimal
                            )} + ${parseFloat(item.taxAmount).toFixed(
                              roundOffDecimal
                            )} = ${parseFloat(item.amount).toFixed(
                              roundOffDecimal
                            )}`
                          : `= ${parseFloat(item.amount).toFixed(
                              roundOffDecimal
                            )}`}
                      </span>
                    </div>
                  </div>
                );
              })}

              <div className="  border-[#E7EFF8] space-y-2 mt-4">
                <p className="font-semibold mb-2 text-sm text-gray-800">
                  Overall Totals
                </p>
                <div className="flex justify-between items-center">
                  <div>
                    <span className="font-semibold">Overall Subtotal:</span>
                    <span className="text-gray-500 text-xs pl-2">
                      (Sum of all items' pre-tax values)
                    </span>
                  </div>
                  <span className="font-medium text-[#1F2837]">
                    {calculateSubTotal().toFixed(roundOffDecimal)}
                  </span>
                </div>

                {isGstEnabled && ( // Only show overall GST totals if GST is enabled
                  <>
                    <div className="flex justify-between items-center">
                      <div>
                        <span className="font-semibold">Overall CGST:</span>
                        <span className="text-gray-500 text-xs pl-2">
                          (Sum of all items' CGST amounts)
                        </span>
                      </div>
                      <span className="font-medium text-[#1F2837]">
                        {calculateCgstTotal().toFixed(roundOffDecimal)}
                      </span>
                    </div>
                    <div className="flex justify-between items-center">
                      <div>
                        <span className="font-semibold">Overall SGST:</span>
                        <span className="text-gray-500 text-xs pl-2">
                          (Sum of all items' SGST amounts)
                        </span>
                      </div>
                      <span className="font-medium text-[#1F2837]">
                        {calculateSgstTotal().toFixed(roundOffDecimal)}
                      </span>
                    </div>
                    <div className="flex justify-between items-center">
                      <div>
                        <span className="font-semibold">Overall IGST:</span>
                        <span className="text-gray-500 text-xs pl-2">
                          (Sum of all items' IGST amounts)
                        </span>
                      </div>
                      <span className="font-medium text-[#1F2837]">
                        {calculateIgstTotal().toFixed(roundOffDecimal)}
                      </span>
                    </div>
                    <div className="flex justify-between items-center">
                      <div>
                        <span className="font-semibold">
                          Overall GST PAYABLE:
                        </span>
                        <span className="text-gray-500 text-xs pl-2">
                          (CGST + SGST + IGST)
                        </span>
                      </div>
                      <span className="font-medium text-[#1F2837]">
                        {calculateTotalGstPayable().toFixed(roundOffDecimal)}
                      </span>
                    </div>
                  </>
                )}
                <div className="flex justify-between items-center pt-2 border-t border-gray-200">
                  <div>
                    <span className="font-bold text-gray-800">
                      Grand Total:
                    </span>
                    <span className="text-gray-500 text-xs pl-2">
                      (Subtotal + Total GST)
                    </span>
                  </div>
                  <span className="font-bold text-[#1F2837]">
                    {displayedGrandTotal.toFixed(roundOffDecimal)}
                  </span>
                </div>
                {roundOffOption !== "none" && (
                  <div className="flex justify-between items-center text-blue-600 text-xs">
                    <span>
                      Rounding Applied: "{roundOffOption}" to {roundOffDecimal}{" "}
                      decimals on "{applyRoundOffTo}"
                    </span>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

      {/* User Options Section (Edit Mode Only) */}
      {isEditMode && (
        <div className="mt-6 p-4 bg-[#F8FAFC] rounded-xl border border-[#E7EFF8] text-sm text-[#545454]">
          <h3 className="font-bold mb-4 text-base text-[#1F2837]">
            Calculation Options
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {/* Round Off Options */}
            <div className="relative" ref={roundOffRef}>
              <label className="block text-[#4B5563] text-sm font-medium mb-1">
                Round Off Method
              </label>
              <button
                type="button"
                className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[120px] lg:min-w-[120px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center"
                onClick={() =>
                  setOpenCalcDropdown(
                    openCalcDropdown === "roundOff" ? null : "roundOff"
                  )
                }
              >
                {(() => {
                  switch (roundOffOption) {
                    case "nearest":
                      return "Nearest";
                    case "up":
                      return "Round Up";
                    case "down":
                      return "Round Down";
                    case "none":
                      return "No Rounding";
                    default:
                      return "";
                  }
                })()}
                <img
                  src="/caret-down.svg"
                  alt=""
                  aria-hidden="true"
                  className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
                />
              </button>
              {openCalcDropdown === "roundOff" && (
                <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
                  <button
                    type="button"
                    className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer"
                    onClick={() => {
                      setRoundOffOption("nearest");
                      setOpenCalcDropdown(null);
                    }}
                  >
                    Nearest
                  </button>
                  <button
                    type="button"
                    className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer whitespace-nowrap"
                    onClick={() => {
                      setRoundOffOption("up");
                      setOpenCalcDropdown(null);
                    }}
                  >
                    Round Up
                  </button>
                  <button
                    type="button"
                    className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer whitespace-nowrap"
                    onClick={() => {
                      setRoundOffOption("down");
                      setOpenCalcDropdown(null);
                    }}
                  >
                    Round Down
                  </button>
                  <button
                    type="button"
                    className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer whitespace-nowrap"
                    onClick={() => {
                      setRoundOffOption("none");
                      setOpenCalcDropdown(null);
                    }}
                  >
                    No Rounding
                  </button>
                </div>
              )}
            </div>

            {/* Decimal Places */}
            <div className="relative" ref={decimalRef}>
              <label className="block text-[#4B5563] text-sm font-medium mb-1">
                Decimal Places
              </label>
              <button
                type="button"
                className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[120px] lg:min-w-[120px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center"
                onClick={() =>
                  setOpenCalcDropdown(
                    openCalcDropdown === "decimal" ? null : "decimal"
                  )
                }
              >
                {(() => {
                  switch (roundOffDecimal) {
                    case 0:
                      return "0";
                    case 1:
                      return "1 Decimal";
                    case 2:
                      return "2 Decimals";
                    case 3:
                      return "3 Decimals";
                    default:
                      return "";
                  }
                })()}
                <img
                  src="/caret-down.svg"
                  alt=""
                  aria-hidden="true"
                  className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
                />
              </button>
              {openCalcDropdown === "decimal" && (
                <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
                  <button
                    type="button"
                    className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer whitespace-nowrap"
                    onClick={() => {
                      setRoundOffDecimal(0);
                      setOpenCalcDropdown(null);
                    }}
                  >
                    0
                  </button>
                  <button
                    type="button"
                    className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer whitespace-nowrap"
                    onClick={() => {
                      setRoundOffDecimal(1);
                      setOpenCalcDropdown(null);
                    }}
                  >
                    1 Decimal
                  </button>
                  <button
                    type="button"
                    className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer whitespace-nowrap"
                    onClick={() => {
                      setRoundOffDecimal(2);
                      setOpenCalcDropdown(null);
                    }}
                  >
                    2 Decimals
                  </button>
                  <button
                    type="button"
                    className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer whitespace-nowrap"
                    onClick={() => {
                      setRoundOffDecimal(3);
                      setOpenCalcDropdown(null);
                    }}
                  >
                    3 Decimals
                  </button>
                </div>
              )}
            </div>

            {/* Apply Round Off To */}
            <div className="relative" ref={applyToRef}>
              <label className="block text-[#4B5563] text-sm font-medium mb-1">
                Apply Round Off To
              </label>
              <button
                type="button"
                className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[120px] lg:min-w-[120px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center whitespace-nowrap"
                onClick={() =>
                  setOpenCalcDropdown(
                    openCalcDropdown === "applyTo" ? null : "applyTo"
                  )
                }
              >
                {(() => {
                  switch (applyRoundOffTo) {
                    case "all":
                      return "All Calculations";
                    case "subtotal":
                      return "Subtotal Only";
                    case "gst":
                      return "GST Only";
                    case "grandtotal":
                      return "Grand Total Only";
                    default:
                      return "";
                  }
                })()}
                <img
                  src="/caret-down.svg"
                  alt=""
                  aria-hidden="true"
                  className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
                />
              </button>
              {openCalcDropdown === "applyTo" && (
                <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
                  <button
                    type="button"
                    className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer whitespace-nowrap"
                    onClick={() => {
                      setApplyRoundOffTo("all");
                      setOpenCalcDropdown(null);
                    }}
                  >
                    All Calculations
                  </button>
                  <button
                    type="button"
                    className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer whitespace-nowrap"
                    onClick={() => {
                      setApplyRoundOffTo("subtotal");
                      setOpenCalcDropdown(null);
                    }}
                  >
                    Subtotal Only
                  </button>
                  <button
                    type="button"
                    className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer whitespace-nowrap"
                    onClick={() => {
                      setApplyRoundOffTo("gst");
                      setOpenCalcDropdown(null);
                    }}
                  >
                    GST Only
                  </button>
                  <button
                    type="button"
                    className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer whitespace-nowrap"
                    onClick={() => {
                      setApplyRoundOffTo("grandtotal");
                      setOpenCalcDropdown(null);
                    }}
                  >
                    Grand Total Only
                  </button>
                </div>
              )}
            </div>

            {/* GST Calculation Method */}
            <div className="relative" ref={gstMethodRef}>
              <label className="block text-[#4B5563] text-sm font-medium mb-1">
                GST Calculation
              </label>
              <button
                type="button"
                className="relative appearance-none h-[36px] md:h-[44px] lg:h-[44px] pl-2 pr-10 md:pr-15 lg:pr-15 w-full md:min-w-[120px] lg:min-w-[120px] bg-white border border-[#E9EAEA] rounded-[8px] cursor-pointer text-[#242729] text-[8px] md:text-base lg:text-sm focus:outline-none flex items-center whitespace-nowrap"
                onClick={() =>
                  setOpenCalcDropdown(
                    openCalcDropdown === "gstMethod" ? null : "gstMethod"
                  )
                }
              >
                {(() => {
                  switch (gstCalculationMethod) {
                    case "inclusive":
                      return "GST Inclusive";
                    case "exclusive":
                      return "GST Exclusive";
                    default:
                      return "";
                  }
                })()}
                <img
                  src="/caret-down.svg"
                  alt=""
                  aria-hidden="true"
                  className="pointer-events-none absolute right-2 md:right-3 lg:right-3 top-1/2 -translate-y-1/2 w-4 h-4"
                />
              </button>
              {openCalcDropdown === "gstMethod" && (
                <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-[12px] shadow-lg border border-gray-200 z-50 max-h-[200px] overflow-y-auto custom-scrollbar">
                  <button
                    type="button"
                    className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer whitespace-nowrap"
                    onClick={() => {
                      setGstCalculationMethod("inclusive");
                      setOpenCalcDropdown(null);
                    }}
                  >
                    GST Inclusive
                  </button>
                  <button
                    type="button"
                    className="w-full px-3 py-2 text-left hover:bg-[#E7EFF8] text-[#545454] cursor-pointer whitespace-nowrap"
                    onClick={() => {
                      setGstCalculationMethod("exclusive");
                      setOpenCalcDropdown(null);
                    }}
                  >
                    GST Exclusive
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* GST Billing Section (Edit Mode Only) */}
      {isEditMode && (
        <div className="mt-6 p-4 bg-[#F8FAFC] rounded-xl border border-[#E7EFF8] text-sm text-[#545454]">
          <h3 className="font-bold mb-4 text-base text-[#1F2837]">
            GST Billing
          </h3>
          <p className="mb-4 text-gray-700">
            Enable GST (Goods and Services Tax) billing for this invoice. This
            will allow you to apply GST rates to your service items and
            automatically calculate CGST, SGST, and IGST based on the supplier
            and customer's state.
          </p>
          <button
            type="button"
            className="w-full sm:w-auto px-6 py-2 bg-[#ef7e1b] rounded-[10px] text-white text-[16px] font-semibold flex items-center justify-center hover:bg-[#ee7f1b]"
            onClick={() => setIsGstEnabled(!isGstEnabled)} // Toggle GST state
          >
            {isGstEnabled ? "Disable GST" : "Enable GST"}
          </button>
        </div>
      )}

      {/* Action Buttons */}
      <div className="flex flex-col sm:flex-row justify-between items-center gap-4 mt-14">
        <div className="flex flex-col sm:flex-row gap-2 sm:gap-[10px] w-full sm:w-auto">
          {isEditMode ? (
            <>
              <button
                onClick={toggleMode}
                className="w-full sm:w-[150px] h-[40px] border border-[rgb(39,152,255)] rounded-[10px] text-[rgb(39,152,255)] text-[16px] font-semibold flex items-center justify-center hover:text-white hover:bg-[rgb(39,152,255)] mb-3"
              >
                Exit Edit Mode
              </button>
              <button
                onClick={saveChanges}
                className="w-full sm:w-[150px] h-[40px] bg-[rgb(39,152,255)] rounded-[10px] text-white text-[16px] font-semibold flex items-center justify-center hover:bg-[#ee7f1b]"
              >
                Save Changes
              </button>
            </>
          ) : (
            <>
              <button
                onClick={toggleMode}
                className="w-full sm:w-[150px] h-[40px] border border-[rgb(39,152,255)] rounded-[10px] text-[rgb(39,152,255)] text-[16px] font-semibold flex items-center justify-center hover:text-white hover:bg-[rgb(39,152,255)]"
              >
                Enter Edit Mode
              </button>
              <button
                onClick={submitInvoice}
                className="w-full sm:w-[150px] h-[40px] bg-[rgb(39,152,255)] rounded-[10px] text-white text-[16px] font-semibold flex items-center justify-center hover:bg-[#ee7f1b]"
              >
                Save Invoice
              </button>
            </>
          )}
        </div>

        {!isEditMode && (
          <PDFDownloadLink
            document={
              <InvoicePDF
                invoiceData={{
                  ...invoiceData,
                  // Ensure all required fields have fallback values
                  companyName: invoiceData.companyName || "",
                  invoiceNo: invoiceData.invoiceNo || "",
                  invoiceDate: invoiceData.invoiceDate || "",
                  billToName: invoiceData.billToName || "",
                  shipToName: invoiceData.shipToName || "",
                  mobile: invoiceData.mobile || "",
                  bankName: invoiceData.bankName || "",
                  accountName: invoiceData.accountName || "",
                  ifscCode: invoiceData.ifscCode || "",
                  accountNo: invoiceData.accountNo || "",
                  bankBranch: invoiceData.bankBranch || "",
                  authorisedSignatory: invoiceData.authorisedSignatory || "",
                  termsAndConditions: invoiceData.termsAndConditions || [],
                  receivedAmount: receivedAmount || 0,
                  billToAddress: invoiceData.billToAddress || {},
                  shipToAddress: invoiceData.shipToAddress || {},
                }}
                serviceItems={serviceItems.map((item) => ({
                  ...item,
                  // Ensure all item fields have fallback values
                  description: item.description || "",
                  quantity: item.quantity || 0,
                  rate: item.rate || 0,
                  taxRate: item.taxRate || 0,
                  amount: item.amount, // Already rounded in calculateItemGST
                  taxAmount: item.taxAmount, // Already rounded in calculateItemGST
                  cgstAmount: item.cgstAmount, // Already rounded in calculateItemGST
                  sgstAmount: item.sgstAmount, // Already rounded in calculateItemGST
                  igstAmount: item.igstAmount, // Already rounded in calculateItemGST
                }))}
                organizationEmail={organizationEmail || ""}
                user={{
                  ...user,
                  profile_pic: user?.profile_pic || "",
                }}
                isGstEnabled={isGstEnabled} // Pass isGstEnabled to PDF
                subTotal={calculateSubTotal()}
                cgstTotal={calculateCgstTotal()}
                sgstTotal={calculateSgstTotal()}
                igstTotal={calculateIgstTotal()}
                totalGstPayable={calculateTotalGstPayable()}
                grandTotal={displayedGrandTotal}
                balance={displayedBalance}
                roundOffDecimal={roundOffDecimal} // Pass roundOffDecimal to PDF
              />
            }
            fileName={`invoice-${invoiceData.invoiceNo || "export"}.pdf`}
            style={{ textDecoration: "none" }}
            onClick={() => {
              // Add a small delay to ensure the PDF is ready
              setTimeout(() => {
                console.log("PDF download initiated");
              }, 100);
            }}
          >
            {({ loading, error }) => {
              if (error) {
                console.error("PDF generation error:", error);
                return (
                  <>
                    {/* Desktop */}
                    <div className="hidden lg:flex justify-end items-center hover:bg-gray-100 p-4 rounded-full">
                      <p className="mr-4 text-red-500 text-sm">PDF Error</p>
                    </div>
                    {/* Mobile/Tablet */}
                    <div className="flex lg:hidden justify-center items-center w-full mt-2">
                      <p className="mr-2 text-red-500 text-sm">PDF Error</p>
                    </div>
                  </>
                );
              }

              return loading ? (
                <>
                  {/* Desktop */}
                  <div className="hidden lg:flex justify-end items-center hover:bg-gray-100 p-4 rounded-full">
                    <p className="mr-4 text-[#8B8B8B] text-sm">
                      Generating PDF...
                    </p>
                  </div>
                  {/* Mobile/Tablet */}
                  <div className="flex lg:hidden justify-center items-center w-full mt-2">
                    <p className="mr-2 text-[#8B8B8B] text-sm">
                      Generating PDF...
                    </p>
                  </div>
                </>
              ) : (
                <>
                  {/* Desktop */}
                  <div className="hidden lg:flex justify-end items-center hover:bg-gray-100 p-4 rounded-full">
                    <p className="mr-4 text-[#8B8B8B] text-sm">Export to</p>
                    <svg
                      width="30"
                      height="30"
                      viewBox="0 0 100 100"
                      fill="#727A90"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M12.5 90.625H21.875V100H12.5C5.60547 100 0 94.3945 0 87.5V12.5C0 5.60547 5.60547 0 12.5 0H44.8242C48.1445 0 51.3281 1.30859 53.6719 3.65234L71.3477 21.3281C73.6914 23.6719 75 26.8555 75 30.1758V59.375H65.625V31.25H50C46.543 31.25 43.75 28.457 43.75 25V9.375H12.5C10.7812 9.375 9.375 10.7812 9.375 12.5V87.5C9.375 89.2188 10.7812 90.625 12.5 90.625ZM34.375 68.75H40.625C46.6602 68.75 51.5625 73.6523 51.5625 79.6875C51.5625 85.7227 46.6602 90.625 40.625 90.625H37.5V96.875C37.5 98.5938 36.0938 100 34.375 100C32.6562 100 31.25 98.5938 31.25 96.875V71.875C31.25 70.1562 32.6562 68.75 34.375 68.75ZM40.625 84.375C43.2227 84.375 45.3125 82.2852 45.3125 79.6875C45.3125 77.0898 43.2227 75 40.625 75H37.5V84.375H40.625ZM59.375 68.75H65.625C70.8008 68.75 75 72.9492 75 78.125V90.625C75 95.8008 70.8008 100 65.625 100H59.375C57.6562 100 56.25 98.5938 56.25 96.875V71.875C56.25 70.1562 57.6562 68.75 59.375 68.75ZM65.625 93.75C67.3438 93.75 68.75 92.3438 68.75 90.625V78.125C68.75 76.4062 67.3438 75 65.625 75H62.5V93.75H65.625ZM81.25 71.875C81.25 70.1562 82.6562 68.75 84.375 68.75H93.75C95.4688 68.75 96.875 70.1562 96.875 71.875C96.875 73.5938 95.4688 75 93.75 75H87.5V81.25H93.75C95.4688 81.25 96.875 82.6562 96.875 84.375C96.875 86.0938 95.4688 87.5 93.75 87.5H87.5V96.875C87.5 98.5938 86.0938 100 84.375 100C82.6562 100 81.25 98.5938 81.25 96.875V71.875Z"
                        fill="#727A90"
                      />
                    </svg>
                  </div>
                  {/* Mobile/Tablet */}
                  <div className="flex lg:hidden justify-center items-center w-full mt-2">
                    <button
                      className="w-full text-[#8B8B8B] text-xs rounded-[10px] py-2 px-4 flex items-center justify-center  gap-2"
                      type="button"
                    >
                      Export to PDF
                      <svg
                        width="20"
                        height="20"
                        viewBox="0 0 100 100"
                        fill="#727A90"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          d="M12.5 90.625H21.875V100H12.5C5.60547 100 0 94.3945 0 87.5V12.5C0 5.60547 5.60547 0 12.5 0H44.8242C48.1445 0 51.3281 1.30859 53.6719 3.65234L71.3477 21.3281C73.6914 23.6719 75 26.8555 75 30.1758V59.375H65.625V31.25H50C46.543 31.25 43.75 28.457 43.75 25V9.375H12.5C10.7812 9.375 9.375 10.7812 9.375 12.5V87.5C9.375 89.2188 10.7812 90.625 12.5 90.625ZM34.375 68.75H40.625C46.6602 68.75 51.5625 73.6523 51.5625 79.6875C51.5625 85.7227 46.6602 90.625 40.625 90.625H37.5V96.875C37.5 98.5938 36.0938 100 34.375 100C32.6562 100 31.25 98.5938 31.25 96.875V71.875C31.25 70.1562 32.6562 68.75 34.375 68.75ZM40.625 84.375C43.2227 84.375 45.3125 82.2852 45.3125 79.6875C45.3125 77.0898 43.2227 75 40.625 75H37.5V84.375H40.625ZM59.375 68.75H65.625C70.8008 68.75 75 72.9492 75 78.125V90.625C75 95.8008 70.8008 100 65.625 100H59.375C57.6562 100 56.25 98.5938 56.25 96.875V71.875C56.25 70.1562 57.6562 68.75 59.375 68.75ZM65.625 93.75C67.3438 93.75 68.75 92.3438 68.75 90.625V78.125C68.75 76.4062 67.3438 75 65.625 75H62.5V93.75H65.625ZM81.25 71.875C81.25 70.1562 82.6562 68.75 84.375 68.75H93.75C95.4688 68.75 96.875 70.1562 96.875 71.875C96.875 73.5938 95.4688 75 93.75 75H87.5V81.25H93.75C95.4688 81.25 96.875 82.6562 96.875 84.375C96.875 86.0938 95.4688 87.5 93.75 87.5H87.5V96.875C87.5 98.5938 86.0938 100 84.375 100C82.6562 100 81.25 98.5938 81.25 96.875V71.875Z"
                          fill="#727A90"
                        />
                      </svg>
                    </button>
                  </div>
                </>
              );
            }}
          </PDFDownloadLink>
        )}
      </div>
    </div>
  );
};

export default invoiceComponent;
//before adding round off settings
</file>

<file path="src/pages/quotation/CreateQuotation.jsx">
import React, { useState, useEffect, useRef } from "react";
import Swal from "sweetalert2";
import api from "../../api";
import {
  Document,
  Page,
  Text,
  View,
  StyleSheet,
  PDFDownloadLink,
  Image,
  Svg,
  Path,
} from "@react-pdf/renderer";

import { useAuth } from "../../auth/AuthContext";
import { SidebarContext } from "../../components/Layout";
import dummyAvatar from "/Avatar2.png";
// import SimpleEditor from '../../components/TinyTapEditor';
import { SimpleEditor } from "@/components/tiptap-templates/simple/simple-editor";
import { FaPlus, FaMinus, FaTimes } from "react-icons/fa";
import { useLocation } from "react-router-dom"; // Import useLocation
import { useState as useLocalState } from "react";

const styles = StyleSheet.create({
  page: {
    flexDirection: "column",
    backgroundColor: "#ffffff",
    padding: 23,
    minHeight: "100vh",
    borderRadius: 16,
  },
  headerSection: {
    flexDirection: "row",
    marginBottom: 24,
    alignItems: "flex-start",
  },
  headerContentLeft: {
    flexDirection: "column",
    alignItems: "flex-start",
    flexGrow: 2,
  },
  organizationNameContainer: {
    flexDirection: "row",
    alignItems: "center",
    marginBottom: 8,
  },
  organizationNameText: {
    fontSize: 18,
    fontWeight: "bold",
    color: "#2798FF",
    marginLeft: 8,
  },
  officeAddressContainer: {
    flexDirection: "column",
    alignItems: "flex-start",
    flexGrow: 1,
  },
  officeAddressText: {
    fontSize: 12,
    color: "#1F2937",
    marginBottom: 2,
  },
  pdfIconMobile: {
    width: 0,
    height: 0,
    position: "absolute",
  },
  profileImageContainer: {
    width: 86,
    height: 86,
    borderRadius: 9999,
    borderWidth: 1,
    borderColor: "#2798FF",
    marginBottom: 0,
    marginRight: 16,
    overflow: "hidden",
  },
  contactInfoContainer: {
    flexDirection: "column",
    alignItems: "flex-start",
    marginLeft: 0,
    flexGrow: 1,
  },
  contactItem: {
    flexDirection: "row",
    alignItems: "center",
    marginBottom: 4,
  },
  contactIcon: {
    width: 18,
    height: 18,
    marginRight: 5,
    color: "#2798FF",
  },
  contactText: {
    fontSize: 12,
    color: "#1F2937",
  },
  quotationTitleContainer: {
    flexGrow: 1,
    textAlign: "right",
    alignSelf: "flex-start",
  },
  quotationTitleText: {
    color: "#2798FF",
    fontSize: 32,
    fontWeight: "bold",
  },
  section: {
    marginBottom: 24,
  },
  customerInfoSection: {
    flexDirection: "column",
    marginBottom: 32,
  },
  displayFieldContainer: {
    width: "100%",
    height: 33,
    paddingHorizontal: 12,
    borderRadius: 12,
    backgroundColor: "#FFFFFF",
    borderWidth: 1,
    borderColor: "#E7EFF8",
    flexDirection: "row",
    alignItems: "center",
    marginBottom: 16,
  },
  displayFieldText: {
    fontSize: 12,
    color: "#545454",
  },
  customerNameDisplay: {
    fontSize: 12,
    color: "#2798FF",
    fontWeight: "semibold",
  },
  addressBlock: {
    width: "100%",
    borderRadius: 12,
    backgroundColor: "#FFFFFF",
    borderWidth: 1,
    borderColor: "#E7EFF8",
    flexDirection: "column",
    overflow: "hidden",
    marginBottom: 16,
  },
  addressLine: {
    width: "100%",
    paddingHorizontal: 12,
    paddingVertical: 4,
    flexDirection: "row",
    alignItems: "center",
    color: "#545454",
    fontSize: 12,
  },
  addressLineBorder: {
    borderBottomWidth: 1,
    borderColor: "#E7EFF8",
  },
  phoneEmailContainer: {
    flexDirection: "row",
    gap: 8,
    justifyContent: "flex-start",
  },
  phoneEmailField: {
    flex: 1,
    height: 33,
    paddingHorizontal: 12,
    borderRadius: 12,
    borderWidth: 1,
    borderColor: "#E7EFF8",
    backgroundColor: "#FFFFFF",
    flexDirection: "row",
    alignItems: "center",
    fontSize: 12,
    color: "#545454",
  },
  phoneEmailIcon: {
    width: 18,
    height: 18,
    marginRight: 5,
    color: "#727A90",
  },
  tableHeadersContainer: {
    flexDirection: "row",
    marginBottom: 4,
  },
  tableHeaderCell: {
    fontSize: 10,
    fontWeight: "bold",
    color: "#8B8B8B",
    padding: 4,
  },
  tableColHeaderSrNo: {
    width: "7.4%",
    textAlign: "left",
  },
  tableColHeaderService: {
    width: "55.5%",
    textAlign: "left",
  },
  tableColHeaderQuantity: {
    width: "18.5%",
    textAlign: "right",
    whiteSpace: "nowrap",
  },
  tableColHeaderTotalPrice: {
    width: "18.5%",
    textAlign: "right",
    whiteSpace: "nowrap",
  },
  divider: {
    width: "100%",
    height: 1,
    backgroundColor: "#E5E7EB",
    marginVertical: 16,
  },
  tableRow: {
    flexDirection: "row",
    alignItems: "center",
    marginBottom: 10,
  },
  tableCell: {
    fontSize: 12,
    color: "#545454",
    paddingHorizontal: 12,
    paddingVertical: 8,
    borderRadius: 12,
    backgroundColor: "#FFFFFF",
    borderWidth: 1,
    borderColor: "#E7EFF8",
    flexDirection: "row",
    height: 33,
  },
  tableCellSrNo: {
    width: "7.4%",
    textAlign: "left",
    justifyContent: "flex-start",
    alignItems: "center",
  },
  tableCellService: {
    width: "55.5%",
    textAlign: "left",
    wordWrap: "break-word",
    justifyContent: "flex-start",
    alignItems: "center",
  },
  tableCellQuantity: {
    width: "18.5%",
    textAlign: "right",
    justifyContent: "flex-end",
    alignItems: "center",
  },
  tableCellTotalPrice: {
    width: "18.5%",
    textAlign: "right",
    justifyContent: "flex-end",
    alignItems: "center",
  },
  totalSection: {
    flexDirection: "row",
    justifyContent: "flex-end",
    alignItems: "center",
    marginBottom: 128,
    marginTop: "auto",
  },
  totalLabel: {
    color: "#2798FF",
    fontSize: 15,
    fontWeight: "bold",
    marginRight: 168,
  },
  totalValue: {
    color: "#2798FF",
    fontSize: 15,
    fontWeight: "bold",
  },
  footerButtonsContainer: {
    flexDirection: "row",
    justifyContent: "space-between",
    alignItems: "center",
    gap: 16,
  },
  buttonGroup: {
    flexDirection: "row",
    gap: 8,
  },
  button: {
    width: 100,
    height: 28,
    borderRadius: 8,
    alignItems: "center",
    justifyContent: "center",
    fontSize: 12,
    fontWeight: "semibold",
  },
  editModeButton: {
    borderColor: "#2798FF",
    borderWidth: 1,
    color: "#2798FF",
  },
  saveSubmitButton: {
    backgroundColor: "#2798FF",
    color: "#FFFFFF",
  },
  heading: {
    fontSize: 16,
    marginBottom: 10,
    color: "#4B5563",
    fontWeight: "bold",
  },
  text: {
    fontSize: 12,
    marginBottom: 5,
    color: "#545454",
  },
});

const QuotationCreate = () => {
  const [organisationInfo, setOrganisationInfo] = useState(null);
  const location = useLocation(); // Initialize useLocation
  const { quotation: editQuotation, lead_id: stateLeadId } =
    location.state || {}; // Get quotation data from navigation state

  const pdfDownloadLinkRef = useRef(null); // Ref for hidden PDFDownloadLink

  useEffect(() => {
    // Step 1: Fetch organisation info and set it
    const fetchOrganisationInfo = async () => {
      try {
        const response = await api.get("/orglist");
        // Pick the first org (or change logic as needed)
        const orgs = response.data.result;
        const firstOrg = orgs[Object.keys(orgs)[0]];
        setOrganisationInfo(firstOrg);
      } catch (error) {
        console.error("Error fetching organisation info:", error);
      }
    };
    fetchOrganisationInfo();

    // Step 2: If editing, pre-populate form with existing quotation data
    if (editQuotation) {
      setIsEditMode(true);

      // Set formData
      setFormData({
        userName: editQuotation.client_name || "",
        organizationAddress: {
          blockUnitStreetName: editQuotation.client_address || "", // Assuming client_address might contain this
          cityState: "", // Not directly available in quotation, keep as is or try to parse
          country: "", // Not directly available
        },
        customerPhone: editQuotation.client_contact_number || "", // Assuming this exists
        customerEmail: editQuotation.client_email || "", // Assuming this exists
      });

      // Set serviceItems (assuming items in quotation map to serviceItems)
      setServiceItems(
        editQuotation.items && editQuotation.items.length > 0
          ? editQuotation.items.map((item) => ({
              serviceName: item.item_name || "",
              quantity: item.qty || 1,
              totalItemPrice: parseFloat(item.amount) || 0,
            }))
          : [{ serviceName: "", quantity: 1, totalItemPrice: 0 }]
      );

      // Set quotationDetails
      setQuotationDetails((prev) => ({
        ...prev,
        quoteNumber: editQuotation.quote_no || prev.quoteNumber,
        quoteDate: editQuotation.date || prev.quoteDate,
        validUntil: editQuotation.valid_until || prev.validUntil,
        customerName: editQuotation.client_name || prev.customerName,
        customerAddressLine1:
          editQuotation.client_address || prev.customerAddressLine1, // Need to parse if complex
        customerAddressLine2: "", // Needs parsing or separate field in backend
        customerAddressLine3: "", // Needs parsing or separate field in backend
        dearSirMessage: editQuotation.introduction || prev.dearSirMessage,
        projectType: editQuotation.project_type || prev.projectType,
        plotSize: editQuotation.plot_size || prev.plotSize,
        packageType: editQuotation.package_type || prev.packageType,
        accountName:
          editQuotation.payment_info?.account_name || prev.accountName,
        bankName: editQuotation.payment_info?.bank_name || prev.bankName,
        accountNumber:
          editQuotation.payment_info?.account_number || prev.accountNumber,
        ifscCode: editQuotation.payment_info?.ifsc_code || prev.ifscCode,
        gstin: editQuotation.payment_info?.gstin || prev.gstin,
        branch: editQuotation.payment_info?.branch || prev.branch,
      }));

      // Set servicesIncluded
      setServicesIncluded(
        editQuotation.services && editQuotation.services.length > 0
          ? editQuotation.services.map((service, index) => ({
              id: (index + 1).toString(),
              title: service.title || "",
              mainDescription: service.description || "",
              bulletPoints: parseBulletpoints(service.bulletpoints), // Use helper here
            }))
          : [
              {
                id: "1",
                title: "Floor Plan Design",
                mainDescription: "",
                bulletPoints: [],
              },
            ] // Default if no services
      );

      // Set budgetItems
      setBudgetItems(
        editQuotation.items && editQuotation.items.length > 0
          ? editQuotation.items.map((item) => ({
              description: item.item_name || "",
              qty: item.qty || 1,
              rate: parseFloat(item.rate) || 0,
            }))
          : [
              {
                description: "Concept of Design & Prototype",
                qty: 1,
                rate: 4000,
              },
            ]
      );

      // Set deliveryTerms and scopeModifications
      setDeliveryTerms(
        editQuotation.conditions?.delivery_terms
          ?.split("\n")
          .filter(Boolean) || [
          "Drawing delivery time is subject to timely comments from client and payments as per agreed terms",
        ]
      );
      setScopeModifications(
        editQuotation.conditions?.scope_conditions
          ?.split("\n")
          .filter(Boolean) || [
          "If requirements change from initially provided specifications (plot size, number of floors, dimensions, direction etc.), additional charges will apply",
        ]
      );

      // Set original states for exit edit mode
      setOriginalFormData({
        userName: editQuotation.client_name || "",
        organizationAddress: {
          blockUnitStreetName: editQuotation.client_address || "",
          cityState: "",
          country: "",
        },
        customerPhone: editQuotation.client_contact_number || "",
        customerEmail: editQuotation.client_email || "",
      });
      setOriginalServiceItems(
        editQuotation.items && editQuotation.items.length > 0
          ? editQuotation.items.map((item) => ({
              serviceName: item.item_name || "",
              quantity: item.qty || 1,
              totalItemPrice: parseFloat(item.amount) || 0,
            }))
          : [{ serviceName: "", quantity: 1, totalItemPrice: 0 }]
      );
      setOriginalQuotationDetails((prev) => ({
        ...prev,
        quoteNumber: editQuotation.quote_no || prev.quoteNumber,
        quoteDate: editQuotation.date || prev.quoteDate,
        validUntil: editQuotation.valid_until || prev.validUntil,
        customerName: editQuotation.client_name || prev.customerName,
        customerAddressLine1:
          editQuotation.client_address || prev.customerAddressLine1,
        dearSirMessage: editQuotation.introduction || prev.dearSirMessage,
        projectType: editQuotation.project_type || prev.projectType,
        plotSize: editQuotation.plot_size || prev.plotSize,
        packageType: editQuotation.package_type || prev.packageType,
        accountName:
          editQuotation.payment_info?.account_name || prev.accountName,
        bankName: editQuotation.payment_info?.bank_name || prev.bankName,
        accountNumber:
          editQuotation.payment_info?.account_number || prev.accountNumber,
        ifscCode: editQuotation.payment_info?.ifsc_code || prev.ifscCode,
        gstin: editQuotation.payment_info?.gstin || prev.gstin,
        branch: editQuotation.payment_info?.branch || prev.branch,
      }));
      setOriginalServicesIncluded(
        editQuotation.services && editQuotation.services.length > 0
          ? editQuotation.services.map((service, index) => ({
              id: (index + 1).toString(),
              title: service.title || "",
              mainDescription: service.description || "",
              bulletPoints: parseBulletpoints(service.bulletpoints), // Use helper here
            }))
          : [
              {
                id: "1",
                title: "Floor Plan Design",
                mainDescription: "",
                bulletPoints: [],
              },
            ]
      );
    } else {
      // Not editing: fetch latest quotation number from API
      const fetchLatestQuotationNumber = async () => {
        try {
          const response = await api.get("/getquoteno");
          if (response.data.success && response.data.invoice_no) {
            setQuotationDetails((prev) => ({
              ...prev,
              quoteNumber: response.data.invoice_no,
            }));
          } else {
            // Fallback to random number if API fails
            setQuotationDetails((prev) => {
              if (!prev.quoteNumber) {
                return {
                  ...prev,
                  quoteNumber: Math.floor(
                    10000 + Math.random() * 90000
                  ).toString(),
                };
              }
              return prev;
            });
          }
        } catch (error) {
          console.error("Error fetching latest quotation number:", error);
          // Fallback to random number if API fails
          setQuotationDetails((prev) => {
            if (!prev.quoteNumber) {
              return {
                ...prev,
                quoteNumber: Math.floor(
                  10000 + Math.random() * 90000
                ).toString(),
              };
            }
            return prev;
          });
        }
      };
      fetchLatestQuotationNumber();
    }
  }, [editQuotation]);

  const [isEditMode, setIsEditMode] = useState(false);
  const [formData, setFormData] = useState({
    userName: "",
    organizationAddress: {
      blockUnitStreetName: "",
      cityState: "",
      country: "",
    },
    customerPhone: "",
    customerEmail: "",
  });
  const [serviceItems, setServiceItems] = useState([
    {
      serviceName: "",
      quantity: 1,
      totalItemPrice: 0,
    },
  ]);

  const [quotationDetails, setQuotationDetails] = useState({
    quoteNumber: "",
    quoteDate: "June 23, 2025",
    validUntil: "July 23, 2025",
    customerName: "Mr. John Doe",
    customerAddressLine1: "123 Main Street",
    customerAddressLine2: "Near Landmark A",
    customerAddressLine3: "City, State",
    dearSirMessage: `Greetings from RoyalHouseDesign! This is in reference to our recent discussion to assist you in designing work for your construction. We understand how important it is to get an accurate portrayal of design to satisfy your stated needs. Keeping your requirements in mind, please go through the complete description of the mentioned services offered:`,
    projectType: "Complete Designing - G+1",
    plotSize: "1,065 sq ft",
    packageType: "Royal Package",
    accountName: "ROYAL HOUSE DESIGN",
    bankName: "AXIS BANK",
    accountNumber: "924020037304194",
    ifscCode: "UTIB0004446",
    gstin: "29AAACD1234E1Z5",
    branch: "SANCHAR NAGAR INDORE",
    from: "", // New field
    printName: "", // New field
    position: "", // New field
    signApprove: "", // New field
    acceptanceDate: "", // New field
  });

  const [servicesIncluded, setServicesIncluded] = useState([
    {
      id: "1",
      title: "Floor Plan Design",
      mainDescription:
        "Customized floor plans with furniture layout designed as per client's plot, requirements, and bylaws",
      bulletPoints: [
        "2D Floor Plan with accurate dimensions",
        "Vastu compliant design principles",
        "Basic furniture layout planning",
        "Door and window location mapping",
        "Unlimited revisions until satisfaction",
      ],
    },
    {
      id: "2",
      title: "3D Elevation Design",
      mainDescription:
        "Stunning 3D front elevation with technical 2D working details for construction",
      bulletPoints: [
        "3D Front Elevation with day view",
        "2D Technical working details with dimensions",
        "Exclusive and customized design approach",
        "Color combinations and material specifications",
        "Balcony and boundary wall design",
        "Unlimited revisions for perfect results",
      ],
    },
    {
      id: "3",
      title: "Structural Drawings",
      mainDescription:
        "Complete set of detailed and certified structural drawings required for building construction",
      bulletPoints: [
        "Central line plan and excavation drawing",
        "Foundation and footing details",
        "Columns layout and detailed specifications",
        "Plinth and slab level beam layouts",
        "Roof plan with comprehensive details",
        "Stairs RCC construction details",
        "Boundary wall structural specifications",
        "Complete material schedules",
      ],
    },
    {
      id: "4",
      title: "Working Drawings",
      mainDescription:
        "Detailed working drawings with all specifications required for construction execution",
      bulletPoints: [
        "Comprehensive working plans",
        "Wall construction details",
        "Door and window sizing specifications",
        "Section drawings for clarity",
        "Kitchen section details",
        "Toilet details and fixture specifications",
        "Door and window section details",
        "Staircase construction details",
      ],
    },
    {
      id: "5",
      title: "Electrical Drawings",
      mainDescription:
        "Complete electrical layout planning with modern automation considerations",
      bulletPoints: [
        "Fan and switch board positioning",
        "Tube light and fixture locations",
        "CCTV system layout planning",
        "Electrical automation drawing",
        "Complete power distribution layout",
      ],
    },
    {
      id: "6",
      title: "Plumbing & Drainage",
      mainDescription:
        "Comprehensive water supply and drainage system design with sustainable solutions",
      bulletPoints: [
        "Complete pipeline routing details",
        "Water tank specifications and positioning",
        "Waste water management system",
        "Rainy season water outlet planning",
        "Rain water harvesting system",
        "Septic tank and bore well details",
        "Chamber and sewage system design",
        "Pipe circulation and water management",
      ],
    },
  ]);

  const [originalFormData, setOriginalFormData] = useState({
    userName: "",
    organizationAddress: {
      blockUnitStreetName: "",
      cityState: "",
      country: "",
    },
    customerPhone: "",
    customerEmail: "",
  });
  const [originalServiceItems, setOriginalServiceItems] = useState([]);
  const [originalQuotationDetails, setOriginalQuotationDetails] = useState({
    quoteNumber: "RHD-2025-001",
    quoteDate: "June 23, 2025",
    validUntil: "July 23, 2025",
    customerName: "Mr. John Doe",
    customerAddressLine1: "123 Main Street",
    customerAddressLine2: "Near Landmark A",
    customerAddressLine3: "City, State",
    dearSirMessage: `Greetings from RoyalHouseDesign! This is in reference to our recent discussion to assist you in designing work for your construction. We understand how important it is to get an accurate portrayal of design to satisfy your stated needs. Keeping your requirements in mind, please go through the complete description of the mentioned services offered:`,
    projectType: "Complete Designing - G+1",
    plotSize: "1,065 sq ft",
    packageType: "Royal Package",
    accountName: "ROYAL HOUSE DESIGN",
    bankName: "AXIS BANK",
    accountNumber: "924020037304194",
    ifscCode: "UTIB0004446",
    gstin: "29AAACD1234E1Z5",
    branch: "SANCHAR NAGAR INDORE",
    from: "", // New field
    printName: "", // New field
    position: "", // New field
    signApprove: "", // New field
    acceptanceDate: "", // New field
  });

  const [originalServicesIncluded, setOriginalServicesIncluded] = useState([]);

  const { user, rolePermissions } = useAuth();
  const { isCollapsed } = React.useContext(SidebarContext);
  const [isTabletView, setIsTabletView] = useState(false);

  const canEditQuotationNumber = rolePermissions === "ALL";

  useEffect(() => {
    const checkTabletView = () => {
      setIsTabletView(window.innerWidth >= 768 && window.innerWidth < 1024);
    };

    checkTabletView();
    window.addEventListener("resize", checkTabletView);

    return () => window.removeEventListener("resize", checkTabletView);
  }, []);

  console.log(JSON.stringify(user), "user saved in context is here");

  const handleInputChange = (field, value) => {
    setFormData((prev) => {
      if (field.includes(".")) {
        const [parentField, nestedField] = field.split(".");
        return {
          ...prev,
          [parentField]: {
            ...prev[parentField],
            [nestedField]: value,
          },
        };
      } else {
        return {
          ...prev,
          [field]: value,
        };
      }
    });
  };

  const handleQuotationDetailsChange = (field, value) => {
    setQuotationDetails((prev) => ({
      ...prev,
      [field]: value,
    }));
  };

  const handleBulletPointChange = (serviceId, bulletIndex, value) => {
    setServicesIncluded((prev) =>
      prev.map((item) =>
        item.id === serviceId
          ? {
              ...item,
              bulletPoints: item.bulletPoints.map((bullet, idx) =>
                idx === bulletIndex ? value : bullet
              ),
            }
          : item
      )
    );
  };

  const handleServiceItemChange = (index, field, value) => {
    const newServiceItems = [...serviceItems];
    if (field === "quantity" || field === "totalItemPrice") {
      newServiceItems[index][field] =
        value === "" ? "" : parseFloat(value) || 0;
    } else {
      newServiceItems[index][field] = value;
    }
    setServiceItems(newServiceItems);
  };

  const addServiceItem = () => {
    setServiceItems([
      ...serviceItems,
      {
        serviceName: "",
        quantity: 1,
        totalItemPrice: 0,
      },
    ]);
  };

  const calculateTotalServiceCharge = () => {
    return serviceItems.reduce((total, item) => {
      const itemPrice = parseFloat(item.totalItemPrice) || 0;
      return total + itemPrice;
    }, 0);
  };

  const validateForm = () => {
    if (!formData.userName.trim()) {
      Swal.fire("Validation Error", "Customer Name is required.", "error");
      return false;
    }
    if (!formData.organizationAddress.blockUnitStreetName.trim()) {
      Swal.fire(
        "Validation Error",
        "Block/Unit/Street Name is required.",
        "error"
      );
      return false;
    }
    if (!formData.organizationAddress.cityState.trim()) {
      Swal.fire("Validation Error", "City, State is required.", "error");
      return false;
    }
    if (!formData.organizationAddress.country.trim()) {
      Swal.fire("Validation Error", "Country is required.", "error");
      return false;
    }
    if (!formData.customerPhone.trim()) {
      Swal.fire(
        "Validation Error",
        "Customer Phone Number is required.",
        "error"
      );
      return false;
    }
    if (!formData.customerEmail.trim()) {
      Swal.fire(
        "Validation Error",
        "Customer Email Address is required.",
        "error"
      );
      return false;
    }
    if (
      !/^[\w-]+(?:\.[\w-]+)*@(?:[\w-]+\.)+[a-zA-Z]{2,7}$/.test(
        formData.customerEmail
      )
    ) {
      Swal.fire(
        "Validation Error",
        "Invalid Customer Email Address format.",
        "error"
      );
      return false;
    }

    if (serviceItems.length === 0) {
      Swal.fire(
        "Validation Error",
        "At least one service item is required.",
        "error"
      );
      return false;
    }

    for (const item of serviceItems) {
      if (!item.serviceName.trim()) {
        Swal.fire(
          "Validation Error",
          "Service Description is required for all items.",
          "error"
        );
        return false;
      }
      if (!item.quantity || item.quantity <= 0) {
        Swal.fire(
          "Validation Error",
          "Quantity must be a positive number for all service items.",
          "error"
        );
        return false;
      }
      if (!item.totalItemPrice || item.totalItemPrice <= 0) {
        Swal.fire(
          "Validation Error",
          "Total Price must be a positive number for all service items.",
          "error"
        );
        return false;
      }
    }

    // Validate new quotationDetails fields
    if (!quotationDetails.quoteNumber.trim()) {
      Swal.fire("Validation Error", "Quote Number is required.", "error");
      return false;
    }
    if (!quotationDetails.quoteDate.trim()) {
      Swal.fire("Validation Error", "Quote Date is required.", "error");
      return false;
    }
    if (!quotationDetails.validUntil.trim()) {
      Swal.fire("Validation Error", "Valid Until date is required.", "error");
      return false;
    }
    if (!quotationDetails.customerName.trim()) {
      Swal.fire("Validation Error", "Customer Name (To) is required.", "error");
      return false;
    }
    if (!quotationDetails.customerAddressLine1.trim()) {
      Swal.fire(
        "Validation Error",
        "Customer Address Line 1 is required.",
        "error"
      );
      return false;
    }
    if (!quotationDetails.customerAddressLine3.trim()) {
      Swal.fire(
        "Validation Error",
        "Customer Address Line 3 is required.",
        "error"
      );
      return false;
    }
    if (!quotationDetails.dearSirMessage.trim()) {
      Swal.fire(
        "Validation Error",
        "Introduction message is required.",
        "error"
      );
      return false;
    }
    // New validations for project overview fields
    if (!quotationDetails.projectType.trim()) {
      Swal.fire("Validation Error", "Project Type is required.", "error");
      return false;
    }
    if (!quotationDetails.plotSize.trim()) {
      Swal.fire("Validation Error", "Plot Size is required.", "error");
      return false;
    }
    if (!quotationDetails.packageType.trim()) {
      Swal.fire("Validation Error", "Package is required.", "error");
      return false;
    }

    // Validate services included
    if (servicesIncluded.length === 0) {
      Swal.fire(
        "Validation Error",
        "At least one included service is required.",
        "error"
      );
      return false;
    }

    for (const service of servicesIncluded) {
      if (!service.title.trim()) {
        Swal.fire(
          "Validation Error",
          "Service title is required for all included services.",
          "error"
        );
        return false;
      }
      if (!service.mainDescription.trim()) {
        Swal.fire(
          "Validation Error",
          "Service main description is required for all included services.",
          "error"
        );
        return false;
      }
      if (service.bulletPoints.length === 0) {
        Swal.fire(
          "Validation Error",
          `At least one bullet point is required for service '${service.title}'.`,
          "error"
        );
        return false;
      }
      for (const bullet of service.bulletPoints) {
        if (!bullet.trim()) {
          Swal.fire(
            "Validation Error",
            `All bullet points must have content for service '${service.title}'.`,
            "error"
          );
          return false;
        }
      }
    }

    return true;
  };

  const toggleMode = () => {
    if (isEditMode) {
      Swal.fire({
        title: "Are you sure?",
        text: "All unsaved changes will be lost!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, exit!",
      }).then((result) => {
        if (result.isConfirmed) {
          setFormData(originalFormData);
          setServiceItems(
            originalServiceItems.length === 0
              ? [{ serviceName: "", quantity: 1, totalItemPrice: 0 }]
              : originalServiceItems
          );
          setQuotationDetails(originalQuotationDetails);
          setServicesIncluded(originalServicesIncluded);
          setIsEditMode(false);
        }
      });
    } else {
      setOriginalFormData(formData);
      setOriginalServiceItems(
        serviceItems.length === 0
          ? [{ serviceName: "", quantity: 1, totalItemPrice: 0 }]
          : serviceItems
      );
      setOriginalQuotationDetails(quotationDetails);
      setOriginalServicesIncluded(servicesIncluded);
      setIsEditMode(true);
    }
  };

  const submitQuotation = async () => {
    // if (!validateForm()) {
    //   return;
    // }

    // Helper to format date to YYYY-MM-DD
    const formatDate = (dateStr) => {
      if (!dateStr) return "";
      // Try to parse as Date
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr; // fallback to original if parse fails
      return d.toISOString().slice(0, 10);
    };

    // Helper to strip HTML tags
    const stripHtmlTags = (html) => {
      if (!html) return "";
      const doc = new window.DOMParser().parseFromString(html, "text/html");
      return doc.body.textContent || "";
    };

    // Office address as string
    let officeAddress = "145 Sai Bagh Colony, Khandwa Road, Indore";
    if (organisationInfo?.address) {
      try {
        const addr = JSON.parse(organisationInfo.address);
        officeAddress = [
          addr.blockUnitStreetName,
          addr.city,
          addr.state,
          addr.country,
          addr.pincode,
        ]
          .filter(Boolean)
          .join(", ");
      } catch (e) {}
    }

    // Client address as string
    const clientAddress = [
      quotationDetails.customerAddressLine1,
      quotationDetails.customerAddressLine2,
      quotationDetails.customerAddressLine3,
    ]
      .filter(Boolean)
      .join(", ");

    // Services array
    const services = servicesIncluded.map((s) => ({
      title: s.title,
      description: s.mainDescription,
      bulletPoints: s.bulletPoints || [],
    }));

    // Budget items array
    const budget_items = budgetItems.map((b) => ({
      description: b.description,
      amount: parseFloat(b.qty) * parseFloat(b.rate) || 0,
    }));

    // Payment info
    const payment_info = {
      account_name: quotationDetails.accountName,
      bank_name: quotationDetails.bankName,
      account_number: quotationDetails.accountNumber,
      ifsc_code: quotationDetails.ifscCode,
      gstin: quotationDetails.gstin,
      branch: quotationDetails.branch,
    };

    // Conditions
    const conditions = {
      delivery_terms: deliveryTerms.join("\n"),
      scope_conditions: scopeModifications.join("\n"),
    };

    // Items (budgetItems mapped, filter out empty descriptions)
    const items = budgetItems
      .filter((item) => item.description && item.description.trim() !== "")
      .map((item) => ({
        item_name: item.description,
        qty: item.qty,
        rate: item.rate,
        gst: 0, // Dummy GST
      }));

    // Calculate totals
    const sub_total = calculateBudgetSubtotal();
    const grand_total = sub_total; // No extra charges for now

    // Dummy closing remarks
    const closing_remarks =
      "Thank you for the opportunity to serve you. We look forward to further communication with you after you have reviewed this proposal.";

    const formatData = {
      quote_no: quotationDetails.quoteNumber,
      lead_id: leadId || "0", // Use selected leadId if present
      date: formatDate(quotationDetails.quoteDate),
      valid_until: formatDate(quotationDetails.validUntil),
      office_address: officeAddress,
      client_name: quotationDetails.customerName,
      client_address: clientAddress,
      project_type: quotationDetails.projectType,
      plot_size: quotationDetails.plotSize,
      package_type: quotationDetails.packageType,
      introduction: stripHtmlTags(quotationDetails.dearSirMessage),
      closing_remarks,
      sub_total,
      grand_total,
      received_amount: "0", // Dummy for now
      balance: "0", // Dummy for now
      services,
      payment_info,
      conditions,
      items,
    };

    console.log("Quotation submitted:", formatData);

    try {
      const endpoint = editQuotation
        ? `/updatequotation/${editQuotation.id}`
        : "/addquotation";
      const response = await api.post(endpoint, formatData);
      Swal.fire({
        icon: "success",
        title: "Success!",
        text: response.data.message || "Quotation submitted successfully!",
        confirmButtonColor: "#3085d6",
      });
    } catch (error) {
      console.error("Error submitting quotation:", error);
      Swal.fire({
        icon: "error",
        title: "Error!",
        text: error.response?.data?.message || "Failed to submit .",
        confirmButtonColor: "#d33",
      });
    }
  };

  const saveChangesAndExitEditMode = () => {
    // if (!validateForm()) {
    //   return;
    // }
    console.log("Changes saved:", { formData, serviceItems, quotationDetails });
    Swal.fire({
      icon: "success",
      title: "Success!",
      text: "Changes saved successfully!",
      confirmButtonColor: "#3085d6",
    });
    setOriginalFormData(formData);
    setOriginalServiceItems(
      serviceItems.length === 0
        ? [{ serviceName: "", quantity: 1, totalItemPrice: 0 }]
        : serviceItems
    );
    setOriginalQuotationDetails(quotationDetails);
    setOriginalServicesIncluded(servicesIncluded);
    setIsEditMode(false);
  };

  const removeServiceItem = (index) => {
    if (serviceItems.length === 1) {
      Swal.fire(
        "Cannot Delete Last Item",
        "At least one service item is required.",
        "error"
      );
      return;
    }

    Swal.fire({
      title: "Are you sure?",
      text: "You won't be able to revert this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, delete it!",
    }).then((result) => {
      if (result.isConfirmed) {
        const newServiceItems = serviceItems.filter((_, i) => i !== index);
        setServiceItems(newServiceItems);
        Swal.fire("Deleted!", "Your service item has been deleted.", "success");
      }
    });
  };

  const handleServiceTitleChange = (id, value) => {
    setServicesIncluded((prev) =>
      prev.map((item) => (item.id === id ? { ...item, title: value } : item))
    );
  };

  const handleServiceMainDescriptionChange = (id, value) => {
    setServicesIncluded((prev) =>
      prev.map((item) =>
        item.id === id ? { ...item, mainDescription: value } : item
      )
    );
  };

  const addBulletPoint = (id) => {
    setServicesIncluded((prev) =>
      prev.map((item) =>
        item.id === id
          ? { ...item, bulletPoints: [...item.bulletPoints, ""] }
          : item
      )
    );
  };

  const removeBulletPoint = (id, index) => {
    console.log("button clicked", id, index);
    setServicesIncluded((prev) =>
      prev.map((item) =>
        item.id === id
          ? {
              ...item,
              bulletPoints: item.bulletPoints.filter((_, i) => i !== index),
            }
          : item
      )
    );
  };

  const addIncludedService = () => {
    setServicesIncluded((prev) => [
      ...prev,
      {
        id: (prev.length + 1).toString(), // Simple ID generation
        title: "",
        mainDescription: "",
        bulletPoints: [],
      },
    ]);
  };

  const removeIncludedService = (idToRemove) => {
    setServicesIncluded((prev) =>
      prev.filter((item) => item.id !== idToRemove)
    );
  };

  const [budgetItems, setBudgetItems] = useState([
    { description: "Concept of Design & Prototype", qty: 1, rate: 4000 },
    { description: "Application Development & Testing", qty: 1, rate: 3000 },
    { description: "Marketing Company & Promotion", qty: 1, rate: 2000 },
    { description: "Maintenance For Final Product", qty: 1, rate: 2000 },
  ]);

  const handleBudgetItemChange = (index, field, value) => {
    setBudgetItems((prev) => {
      const updated = [...prev];
      if (field === "qty" || field === "rate") {
        updated[index][field] = value === "" ? "" : parseFloat(value) || 0;
      } else {
        updated[index][field] = value;
      }
      return updated;
    });
  };

  const addBudgetItem = () => {
    setBudgetItems((prev) => [...prev, { description: "", qty: 1, rate: 0 }]);
  };

  const removeBudgetItem = (index) => {
    if (budgetItems.length === 1) {
      Swal.fire(
        "Cannot Delete Last Item",
        "At least one budget item is required.",
        "error"
      );
      return;
    }
    setBudgetItems((prev) => prev.filter((_, i) => i !== index));
  };

  const calculateBudgetSubtotal = () => {
    return budgetItems.reduce(
      (total, item) =>
        total + (parseFloat(item.qty) || 0) * (parseFloat(item.rate) || 0),
      0
    );
  };

  // Editable Delivery & Payment Terms and Scope & Modifications
  const [deliveryTerms, setDeliveryTerms] = useState([
    "Drawing delivery time is subject to timely comments from client and payments as per agreed terms",
    "All drawings will be designed as per requirements, plot details, and bylaws provided by the client",
  ]);
  const [scopeModifications, setScopeModifications] = useState([
    "If requirements change from initially provided specifications (plot size, number of floors, dimensions, direction etc.), additional charges will apply",
    "Time required to complete all services will depend entirely on client satisfaction and approval process",
  ]);

  const handleDeliveryTermChange = (idx, value) => {
    setDeliveryTerms((prev) =>
      prev.map((item, i) => (i === idx ? value : item))
    );
  };
  const addDeliveryTerm = () => setDeliveryTerms((prev) => [...prev, ""]);
  const removeDeliveryTerm = (idx) => {
    if (deliveryTerms.length === 1) return;
    setDeliveryTerms((prev) => prev.filter((_, i) => i !== idx));
  };

  const handleScopeModificationChange = (idx, value) => {
    setScopeModifications((prev) =>
      prev.map((item, i) => (i === idx ? value : item))
    );
  };
  const addScopeModification = () =>
    setScopeModifications((prev) => [...prev, ""]);
  const removeScopeModification = (idx) => {
    if (scopeModifications.length === 1) return;
    setScopeModifications((prev) => prev.filter((_, i) => i !== idx));
  };

  // Lead dropdown state
  const [leads, setLeads] = useState([]);
  const [leadSearchTerm, setLeadSearchTerm] = useState("");
  const [leadDropdownOpen, setLeadDropdownOpen] = useState(false);
  const [leadsLoading, setLeadsLoading] = useState(false);
  const [selectedLead, setSelectedLead] = useState(null);
  const [leadId, setLeadId] = useState("");
  const leadDropdownRef = useRef(null);

  // Extract lead_id from either location.state or editQuotation
  const editLeadId = editQuotation?.lead_id || stateLeadId;

  // Always fetch leads if editLeadId is present and leads are empty
  useEffect(() => {
    if (isEditMode && leads.length === 0 && !leadsLoading) {
      setLeadsLoading(true);
      api
        .get("/showlead")
        .then((res) => {
          if (res.data.success) {
            setLeads(res.data.result);
          }
        })
        .catch(() => {})
        .finally(() => setLeadsLoading(false));
    }
  }, [isEditMode, leads.length, leadsLoading]);

  // Pre-select lead if editLeadId is present and leads are loaded
  useEffect(() => {
    if (editLeadId && leads.length > 0) {
      const foundLead = leads.find((lead) => lead.customer_id === editLeadId);
      if (foundLead) {
        handleLeadSelect(foundLead);
      }
    }
  }, [leads, editLeadId]);

  // Close dropdown on outside click
  useEffect(() => {
    function handleClickOutside(event) {
      if (
        leadDropdownRef.current &&
        !leadDropdownRef.current.contains(event.target)
      ) {
        setLeadDropdownOpen(false);
      }
    }
    if (leadDropdownOpen) {
      document.addEventListener("mousedown", handleClickOutside);
    } else {
      document.removeEventListener("mousedown", handleClickOutside);
    }
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [leadDropdownOpen]);

  // Filtered leads
  const filteredLeads = leads.filter((lead) => {
    const term = leadSearchTerm.toLowerCase();
    return (
      lead.customer_name.toLowerCase().includes(term) ||
      (lead.email && lead.email.toLowerCase().includes(term)) ||
      (lead.contact && lead.contact.toLowerCase().includes(term))
    );
  });

  // Helper: parse address from lead.city (may be JSON)
  function parseLeadAddress(addressString) {
    let parsedAddress = {
      line1: "",
      line2: "",
      line3: "",
    };
    if (addressString && typeof addressString === "string") {
      try {
        const addressObj = JSON.parse(addressString);
        parsedAddress.line1 =
          addressObj.blockUnitStreetName || addressObj.name || "";
        parsedAddress.line2 = addressObj.city || "";
        parsedAddress.line3 = [
          addressObj.state,
          addressObj.country,
          addressObj.pincode,
        ]
          .filter(Boolean)
          .join(", ");
      } catch (e) {
        parsedAddress.line2 = addressString;
      }
    }
    return parsedAddress;
  }

  // Autofill on lead select
  const handleLeadSelect = (lead) => {
    setSelectedLead(lead);
    setLeadId(lead.customer_id);
    setLeadDropdownOpen(false);
    setLeadSearchTerm(lead.customer_name);
    // Fill customer fields
    setQuotationDetails((prev) => ({
      ...prev,
      customerName: lead.customer_name || prev.customerName,
      customerAddressLine1:
        parseLeadAddress(lead.city).line1 || prev.customerAddressLine1,
      customerAddressLine2:
        parseLeadAddress(lead.city).line2 || prev.customerAddressLine2,
      customerAddressLine3:
        parseLeadAddress(lead.city).line3 || prev.customerAddressLine3,
    }));
    setFormData((prev) => ({
      ...prev,
      customerEmail: lead.email || prev.customerEmail,
      customerPhone: lead.contact || prev.customerPhone,
    }));
  };

  // Clear lead selection
  const clearLeadSelection = () => {
    setSelectedLead(null);
    setLeadId("");
    setLeadSearchTerm("");
  };

  // Add state for Dear Sir heading
  const [dearSirHeading, setDearSirHeading] = useState("Dear Sir,");

  console.log('if collapsed', isCollapsed)
  return (
    <div
      className={` w-[90vw] md:w-[85vw]  lg:w-[90%] xl:w-[70%]  h-auto bg-white p-4 sm:p-6 lg:p-[23px] min-h-screen rounded-2xl flex flex-col relative`}
    >
      {/* Header Section */}
      <div className="grid grid-cols-3 gap-4 mb-8 px-4 sm:px-6 lg:px-[20px] mt-8">
        <div className="col-span-2 flex flex-col items-start justify-start">
          {/* Profile Picture and Organization Name */}
          <div className="flex items-start flex-col mb-4 lg:mb-4 lg:mr-8">
            <div
              className=" w-[65px] h-[28px]  md:w-[80px] md:h-[35px]  lg:w-[120px] lg:h-[50px] bg-cover bg-center"
              style={{
                backgroundImage: `url(${
                  organisationInfo?.profile_image ||
                  user?.profile_pic ||
                  "src/assets/dummyavatar.jpeg"
                })`,
              }}
            ></div>
            <span className=" text-md md:text-xl lg:text-2xl xl:text-3xl whitespace-nowrap">
              {organisationInfo?.organizationname || "Royal House Design"}
            </span>
          </div>

          {/* Office Address */}
          <div className="flex flex-col items-start mt-3">
            <span className="text-[rgb(31,41,55)] text-xs sm:text-base lg:text-[12px] font-medium"></span>
            <span className="text-[rgb(31,41,55)] text-xs sm:text-base lg:text-[12px]">
              <h4>
                <b>Quote #:</b>{" "}
                {isEditMode && canEditQuotationNumber ? (
                  <input
                    type="text"
                    value={quotationDetails.quoteNumber}
                    onChange={(e) =>
                      handleQuotationDetailsChange(
                        "quoteNumber",
                        e.target.value
                      )
                    }
                    className="border-b border-gray-300 outline-none px-1 w-28 sm:w-auto"
                  />
                ) : (
                  quotationDetails.quoteNumber
                )}
              </h4>

              <h4>
                <b>Date:</b>{" "}
                {isEditMode ? (
                  <input
                    type="text"
                    value={quotationDetails.quoteDate}
                    onChange={(e) =>
                      handleQuotationDetailsChange("quoteDate", e.target.value)
                    }
                    className="border-b border-gray-300 outline-none px-1 w-28 sm:w-auto"
                  />
                ) : (
                  quotationDetails.quoteDate
                )}
              </h4>
              <h4>
                <b>Valid Until:</b>{" "}
                {isEditMode ? (
                  <input
                    type="text"
                    value={quotationDetails.validUntil}
                    onChange={(e) =>
                      handleQuotationDetailsChange("validUntil", e.target.value)
                    }
                    className="border-b border-gray-300 outline-none px-1 w-28 sm:w-auto"
                  />
                ) : (
                  quotationDetails.validUntil
                )}
              </h4>
            </span>
          </div>
        </div>

        <div className="col-span-1 flex items-end justify-end">
          <div className="text-right">
            <div className=" text-[#2798FF] text-2xl sm:text-3xl lg:text-3xl xl:text-4xl font-quicksand font-bold ">
              Quotation
            </div>
          </div>
        </div>
      </div>

      {/* Address Section */}
      <div className="flex flex-col mb-8 w-full bg-gray-50 py-4 sm:py-6 px-[20px] lg:px-[20px] ">
        <div className="flex justify-between mb-10">
          <div className="w-1/2 lg:w-auto">
            <h3 className="font-semibold text-xs sm:text-base">Office</h3>
            {organisationInfo?.address ? (
              (() => {
                const addr = JSON.parse(organisationInfo.address);
                return (
                  <>
                    {addr.blockUnitStreetName && (
                      <p className="text-xs ">{addr.blockUnitStreetName}</p>
                    )}
                    {/* City, State */}
                    {(addr.city || addr.state) && (
                      <p className="text-xs">
                        {[addr.city, addr.state].filter(Boolean).join(", ")}
                      </p>
                    )}

                    {/* Country, Pincode */}
                    {(addr.country || addr.pincode) && (
                      <p className="text-xs">
                        {[addr.country, addr.pincode]
                          .filter(Boolean)
                          .join(", ")}
                      </p>
                    )}
                  </>
                );
              })()
            ) : (
              <>
                <p className="text-xs"></p>
                <p className="text-xs"></p>
                <p className="text-xs"></p>
              </>
            )}
          </div>

          <div className="lg:w-auto">
            <h3 className="font-semibold text-xs sm:text-base">
              To:{" "}
              {isEditMode ? (
                <input
                  type="text"
                  value={quotationDetails.customerName}
                  onChange={(e) =>
                    handleQuotationDetailsChange("customerName", e.target.value)
                  }
                  className="border-b border-gray-300 outline-none px-1 w-auto"
                />
              ) : (
                quotationDetails.customerName
              )}
            </h3>
            {isEditMode ? (
              <div className="flex flex-col max-w-xs">
                <input
                  type="text"
                  value={quotationDetails.customerAddressLine1}
                  onChange={(e) =>
                    handleQuotationDetailsChange(
                      "customerAddressLine1",
                      e.target.value
                    )
                  }
                  className="text-xs border-b border-gray-300 outline-none px-1 w-full"
                />
                <input
                  type="text"
                  value={quotationDetails.customerAddressLine2}
                  onChange={(e) =>
                    handleQuotationDetailsChange(
                      "customerAddressLine2",
                      e.target.value
                    )
                  }
                  className="text-xs border-b border-gray-300 outline-none px-1 w-full"
                />
                <input
                  type="text"
                  value={quotationDetails.customerAddressLine3}
                  onChange={(e) =>
                    handleQuotationDetailsChange(
                      "customerAddressLine3",
                      e.target.value
                    )
                  }
                  className="text-xs border-b border-gray-300 outline-none px-1 w-full"
                />
              </div>
            ) : (
              <>
                <p className="text-xs">
                  {quotationDetails.customerAddressLine1}
                </p>
                <p className="text-xs">
                  {quotationDetails.customerAddressLine2}
                </p>
                <p className="text-xs">
                  {quotationDetails.customerAddressLine3}
                </p>
              </>
            )}
          </div>
        </div>

        <div className="flex flex-col w-full"></div>

        <div className="font-sans mx-auto w-full">
          {/* Lead Dropdown Section - above Dear Sir, only in edit mode */}
          {isEditMode && (
            <div
              className="flex flex-col items-first mb-4 w-full"
              ref={leadDropdownRef}
            >
              <label className="block text-[#4B5563] text-sm font-medium mb-1">
                Fetch Lead
              </label>
              <div className="relative w-full">
                <input
                  type="text"
                  placeholder="Search customer by name, email, or phone..."
                  value={leadSearchTerm}
                  onChange={(e) => {
                    setLeadSearchTerm(e.target.value);
                    setLeadDropdownOpen(true);
                  }}
                  onFocus={() => setLeadDropdownOpen(true)}
                  className="w-full px-3 py-2 rounded-[12px] border border-[#E7EFF8] bg-[#F8FAFC] text-[#545454] focus:ring-2 focus:ring-[#0e4053] outline-none mb-1"
                />
                {selectedLead && (
                  <button
                    type="button"
                    onClick={clearLeadSelection}
                    className="absolute right-2 top-3 text-gray-400 hover:text-red-500"
                    title="Clear selection"
                  >
                    <FaTimes size={16} />
                  </button>
                )}
                {leadDropdownOpen && (
                  <div className="absolute z-20 w-full custom-scrollbar bg-white rounded-xl shadow-2xl border border-gray-200 mt-1 max-h-72 overflow-y-auto animate-fade-in">
                    {leadsLoading ? (
                      <div className="flex flex-col items-center justify-center p-6 text-gray-500">
                        <svg
                          className="animate-spin h-6 w-6 mb-2 text-blue-400"
                          fill="none"
                          viewBox="0 0 24 24"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <circle
                            className="opacity-25"
                            cx="12"
                            cy="12"
                            r="10"
                            stroke="currentColor"
                            strokeWidth="4"
                          ></circle>
                          <path
                            className="opacity-75"
                            fill="currentColor"
                            d="M4 12a8 8 0 018-8v8z"
                          ></path>
                        </svg>
                        Loading...
                      </div>
                    ) : filteredLeads.length > 0 ? (
                      filteredLeads.map((lead, idx) => (
                        <div
                          key={lead.customer_id}
                          className="flex items-center gap-3 px-4 py-3 cursor-pointer transition-colors hover:bg-blue-50/80 group"
                          style={{
                            borderBottom:
                              idx !== filteredLeads.length - 1
                                ? "1px solid #F1F5F9"
                                : "none",
                          }}
                          onClick={() => handleLeadSelect(lead)}
                        >
                          <img
                            src={lead.profile_pic}
                            alt="pic"
                            className="h-9 w-9 rounded-full object-cover border border-gray-200 shadow-sm"
                          />
                          <div className="flex flex-col flex-1 min-w-0">
                            <span className="font-semibold text-gray-800 truncate group-hover:text-blue-700">
                              {lead.customer_name}
                            </span>
                            <span className="text-xs text-gray-500 truncate">
                              {lead.email}
                            </span>
                            <span className="text-xs text-gray-400 truncate">
                              {lead.contact}
                            </span>
                          </div>
                        </div>
                      ))
                    ) : (
                      <div className="flex flex-col items-center justify-center p-6 text-gray-400">
                        <svg
                          className="h-8 w-8 mb-2"
                          fill="none"
                          stroke="currentColor"
                          strokeWidth="1.5"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-3A2.25 2.25 0 008.25 5.25V9m10.5 0A2.25 2.25 0 0121 11.25v7.5A2.25 2.25 0 0118.75 21H5.25A2.25 2.25 0 013 18.75v-7.5A2.25 2.25 0 015.25 9m13.5 0h-13.5"
                          />
                        </svg>
                        No leads found
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          )}
          {/* End Lead Dropdown Section */}
          {/* Main content grid */}
          <div className="grid grid-cols-[0.5fr_0.5fr_3fr] md:grid-cols-[1fr_auto_3fr]  md:gap-x-10 lg:gap-x-5  xl:gap-x-10  md:gap-y-8 gap-y-4 items-start min-w-0 overflow-hidden">
            {/* New Text Section */}
            <div className=" flex flex-col justify-start items-start text-left col-span-3 min-w-0">
              {isEditMode ? (
                <input
                  type="text"
                  value={dearSirHeading}
                  onChange={(e) => setDearSirHeading(e.target.value)}
                  className="text-md md:text-xl font-bold text-[#2798FF] mb-2 bg-transparent border-b border-[#2798FF] outline-none w-full min-w-0"
                  placeholder="Heading (e.g. Dear Sir,)"
                />
              ) : (
                <div className="text-md md:text-xl font-bold text-[#2798FF] mb-2">
                  {dearSirHeading}
                </div>
              )}
              {isEditMode ? (
                <div className=" w-[80vw] lg:w-full">
                  <SimpleEditor
                    initialContent={quotationDetails.dearSirMessage}
                    onUpdate={({ html }) =>
                      handleQuotationDetailsChange("dearSirMessage", html)
                    }
                  />
                </div>
              ) : (
                <div
                  className="text-xs md:text-sm text-gray-600 leading-relaxed"
                  dangerouslySetInnerHTML={{
                    __html: quotationDetails.dearSirMessage,
                  }}
                ></div>
              )}
            </div>
            {/* Payment Info Row */}
            <div className="xl:pr-5 pr-1 flex flex-col justify-start items-start text-left mt-3">
              <div className="text-[8px] md:text-xl font-bold text-gray-800 mb-1">
                PROJECT <br /> OVERVIEW
              </div>
            </div>
            <div className="relative self-stretch ">
              <div className="bg-gray-100 rounded-full mt-3 h-6 w-6  md:w-12 md:h-12 flex justify-center items-center z-10 absolute top-0 left-1/2 -translate-x-1/2 flex-shrink-0">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  className="text-[#2798FF] md:h-[35px] md:w-[35px] h-[20px] w-[20px]"
                >
                  <path
                    fill="currentColor"
                    d="M5.37 20q-.553 0-.942-.387q-.39-.387-.39-.94v-1.727l3.54-3.146V20zm3.053 0v-3.538h7.154V20zm8 0v-7.267L12.61 9.366l2.679-2.368l4.23 3.744q.212.206.327.46q.116.255.116.543v6.923q0 .553-.387.943t-.94.389zM4.039 15.788v-4.03q0-.287.115-.551t.327-.465l6.635-5.88q.2-.181.424-.259q.225-.078.461-.078t.46.078t.424.259l1.769 1.582z"
                  />
                </svg>
              </div>
            </div>
            <div className="pl-5">
              <div className="flex justify-center space-x-1 md:space-x-7 bg-gray-100 p-2 md:p-5 rounded-md">
                <div className="flex-1">
                  <div className="font-bold mb-1 text-[8px] md:text-sm text-gray-800">
                    PROJECT TYPE
                  </div>
                  {isEditMode ? (
                    <textarea
                      type="text"
                      value={quotationDetails.projectType}
                      onChange={(e) =>
                        handleQuotationDetailsChange(
                          "projectType",
                          e.target.value
                        )
                      }
                      className="text-[8px] md:text-xs border-b border-gray-300 outline-none w-full bg-gray-100 white"
                    />
                  ) : (
                    <div className="md:text-xs text-[8px] text-gray-700 leading-normal whitespace-pre-wrap">
                      {quotationDetails.projectType}
                    </div>
                  )}
                </div>
                <div className="flex-1">
                  <div className="font-bold mb-1 text-[8px] md:text-sm text-gray-800">
                    PLOT SIZE
                  </div>
                  {isEditMode ? (
                    <textarea
                      type="text"
                      value={quotationDetails.plotSize}
                      onChange={(e) =>
                        handleQuotationDetailsChange("plotSize", e.target.value)
                      }
                      className="text-[8px] md:text-xs border-b border-gray-300 outline-none w-full bg-gray-100"
                    />
                  ) : (
                    <div className="md:text-xs text-[8px] text-gray-700 leading-normal whitespace-pre-wrap">
                      {quotationDetails.plotSize}
                    </div>
                  )}
                </div>
                <div className="flex-1">
                  <div className="font-bold mb-1 text-[8px] md:text-sm text-gray-800">
                    PACKAGE
                  </div>
                  {isEditMode ? (
                    <textarea
                      type="text"
                      value={quotationDetails.packageType}
                      onChange={(e) =>
                        handleQuotationDetailsChange(
                          "packageType",
                          e.target.value
                        )
                      }
                      className="md:text-xs text-[8px] border-b border-gray-300 outline-none w-full bg-gray-100"
                    />
                  ) : (
                    <div className="md:text-xs text-[8px] text-gray-700 leading-normal whitespace-pre-wrap ">
                      {quotationDetails.packageType}
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* Terms & Conditions Row */}
            <div className="xl:pr-5 pr-1 flex flex-col justify-start items-start text-left">
              <div className="text-[8px] md:text-xl font-bold text-gray-800 mb-1">
                SERVICES <br /> INCLUDED
              </div>
            </div>
            <div className="relative self-stretch mb-5  md:mb-0">
              <div className="bg-[#ef7e1b] text-white rounded-full h-6 w-6  md:w-12 md:h-12 flex justify-center items-center text-[10px] sm:text-lg font-bold z-10 absolute top-0 left-1/2 -translate-x-1/2 flex-shrink-0">
                02.
              </div>
              <div className="w-0.5 bg-[#ef7e1b] absolute left-1/2 -translate-x-1/2 top-8 bottom-0 z-0"></div>
              <div className="bg-[#ef7e1b] rounded-full w-2 h-2 absolute bottom-0 left-1/2 -translate-x-1/2 z-10"></div>
            </div>
            <div className="pl-5">
              <div className="grid grid-cols-2 md:gap-x-6 gap-x-1 md:gap-y-6 gap-y-2 w-full">
                {isEditMode ? (
                  <>
                    {servicesIncluded.map((service, serviceIndex) => (
                      <div
                        key={service.id}
                        className="text-[8px] sm:text-sm text-slate-50 leading-relaxed flex items-start relative border p-1 md:p-4 rounded-lg shadow-sm"
                      >
                        <span className="font-bold mr-1 md:mr-3 text-xs md:text-lg text-[#2798FF] flex-shrink-0">
                          {(serviceIndex + 1).toString().padStart(2, "0")}
                        </span>
                        <div className="flex-grow">
                          <input
                            type="text"
                            value={service.title}
                            onChange={(e) =>
                              handleServiceTitleChange(
                                service.id,
                                e.target.value
                              )
                            }
                            className="font-bold text-[8px] md:text-lg text-[#2798FF] border-b border-gray-300 outline-none w-full mb-2"
                            placeholder="Service Title"
                          />
                          <textarea
                            value={service.mainDescription}
                            onChange={(e) =>
                              handleServiceMainDescriptionChange(
                                service.id,
                                e.target.value
                              )
                            }
                            className="text-[8px] md:text-xs text-gray-700 leading-normal border-b border-gray-300 outline-none w-full h-24 resize-none mb-2"
                            placeholder="Main Description"
                          ></textarea>
                          <ul className="text-[8px] md:text-xs text-gray-700">
                            {service.bulletPoints.map((bullet, bulletIndex) => (
                              <li
                                key={bulletIndex}
                                className="flex items-center mb-1 relative min-w-0 w-full"
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="1em"
                                  height="1em"
                                  viewBox="0 0 24 24"
                                  className="flex-shrink-0 mr-2 text-[#2798FF]"
                                >
                                  <path
                                    fill="#2798FF"
                                    d="m10.537 12l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354z"
                                  />
                                </svg>
                                <textarea
                                  value={bullet}
                                  onChange={(e) =>
                                    handleBulletPointChange(
                                      service.id,
                                      bulletIndex,
                                      e.target.value
                                    )
                                  }
                                  className="flex-grow border-b border-gray-300 outline-none md:px-1 text-[10px] md:text-xs min-w-0 w-full resize-y overflow-auto"
                                  placeholder="Bullet point description"
                                  rows={2}
                                  style={{ minWidth: 0, minHeight: "32px" }}
                                />
                                <button
                                  onClick={() =>
                                    removeBulletPoint(service.id, bulletIndex)
                                  }
                                  className="ml-2 rounded-full w-2 h-2 md:w-4 md:h-4 flex items-center justify-center text-[10px] font-bold text-red-500"
                                >
                                  <FaMinus size={10} />
                                </button>
                              </li>
                            ))}
                          </ul>
                          <button
                            onClick={() => addBulletPoint(service.id)}
                            className="mt-2 rounded-full md:w-6 md:h-6 h-3 w-3 flex items-center justify-center text-xl font-bold text-[#2798FF]"
                          >
                            <FaPlus size={14} />
                          </button>
                        </div>
                        <button
                          onClick={() => removeIncludedService(service.id)}
                          className="absolute top-1 right-1 rounded-full md:w-6 w-3 md:h-6 h-3 flex items-center justify-center text-xs font-bold text-red-500"
                        >
                          <FaTimes size={12} />
                        </button>
                      </div>
                    ))}
                    <div className="col-span-2 flex justify-center mt-4">
                      <button
                        onClick={addIncludedService}
                        className="rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold text-[#2798FF]"
                      >
                        <FaPlus size={20} />
                      </button>
                    </div>
                  </>
                ) : (
                  servicesIncluded.map((service, index) => (
                    <div
                      key={service.id}
                      className="text-[8px] md:text-sm text-gray-700 leading-relaxed flex items-start"
                    >
                      <span className="font-bold mr-1 md:mr-3 text-[8px] md:text-lg text-[#2798FF] flex-shrink-0">
                        {(index + 1).toString().padStart(2, "0")}
                      </span>
                      <div className="flex-grow">
                        <span className="font-bold text-[8px] md:text-lg text-[#2798FF] whitespace-pre-wrap">
                          {service.title}
                        </span>
                        <p className="text-[8px] md:text-xs text-gray-700 leading-normal mb-1 md:mb-2 whitespace-pre-wrap">
                          {service.mainDescription}
                        </p>
                        <ul className="text-[8px] md:text-xs text-gray-700">
                          {service.bulletPoints.map((bullet, bulletIndex) => (
                            <li
                              key={bulletIndex}
                              className="flex items-start md:mb-1 whitespace-pre-wrap md:text-xs text-[8px]"
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="1em"
                                height="1em"
                                viewBox="0 0 24 24"
                                className="flex-shrink-0 mr-2 text-[#2798FF]"
                              >
                                <path
                                  fill="#2798FF"
                                  d="m10.537 12l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354z"
                                />
                              </svg>
                              {bullet}
                            </li>
                          ))}
                        </ul>
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>

            {/* Budget Breakdown Row */}
            <div className="xl:pr-5 pr-1 flex flex-col justify-start items-start text-left">
              <div className="text-[8px] md:text-xl font-bold text-gray-800 mb-1">
                BUDGET <br /> BREAKDOWN
              </div>
            </div>
            <div className="relative self-stretch mb-5  md:mb-0">
              <div className="bg-[#ef7e1b] text-white rounded-full md:w-12 md:h-12 h-6 w-6 flex justify-center items-center text-[10px] md:text-lg font-bold z-10 absolute top-0 left-1/2 -translate-x-1/2 flex-shrink-0">
                03.
              </div>
              <div className="w-0.5 bg-[#ef7e1b] absolute left-1/2 -translate-x-1/2 top-8 bottom-0 z-0"></div>
              <div className="bg-[#ef7e1b] rounded-full w-2 h-2 absolute bottom-0 left-1/2 -translate-x-1/2 z-10"></div>
            </div>
            <div className="pl-5">
              {/* Updated: Two-row header for Description, Qty, Rate, empty, Amount */}
              <div className="mb-5">
                {/* First header row: Description (colSpan=3), empty, Amount */}
                <div className="grid grid-cols-[1.5fr_0.5fr_0.5fr_0.1fr_1fr] text-white text-sm font-bold">
                  <div></div>
                </div>
                {/* Second header row: Description, Qty, Rate, empty, Amount */}
                <div className="grid grid-cols-[1.5fr_0.5fr_0.5fr_0.1fr_1fr] text-white text-[10px] md:text-xs font-semibold">
                  <div className="p-1 md:p-2.5 bg-[#ef7e1b] border-t border-[#2798FF]">
                    Description
                  </div>
                  <div className="p-1 md:p-2.5 bg-[#ef7e1b] border-t border-[#2798FF] text-center">
                    Qty
                  </div>
                  <div className="p-1 md:p-2.5 bg-[#ef7e1b] border-t border-[#2798FF] text-center">
                    Rate
                  </div>
                  <div className="bg-gray-50 border-t border-gray-50"></div>
                  <div className="text-right p-1 md:p-2.5 bg-gray-700 border-t border-gray-700">
                    Amount
                  </div>
                </div>
                {/* Data rows: Editable in edit mode, static otherwise */}
                {isEditMode ? (
                  <>
                    {budgetItems.map((item, idx) => (
                      <div
                        key={idx}
                        className="grid grid-cols-[1.5fr_0.5fr_0.5fr_0.1fr_1fr] py-2 text-[10px] md:text-sm text-gray-700 items-center"
                      >
                        <div className="flex items-center min-w-0 w-full">
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="1em"
                            height="1em"
                            viewBox="0 0 24 24"
                            className="flex-shrink-0 mr-1 text-xs md:text-xl"
                          >
                            <path
                              fill="#2798FF"
                              d="m10.537 12l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354z"
                            />
                          </svg>
                          <textarea
                            value={item.description}
                            onChange={(e) =>
                              handleBudgetItemChange(
                                idx,
                                "description",
                                e.target.value
                              )
                            }
                            className="border-b border-gray-300 outline-none px-1 flex-grow bg-transparent min-w-0 w-full resize-y overflow-auto"
                            placeholder="Description"
                            rows={2}
                            style={{ minWidth: 0, minHeight: "32px" }}
                          />
                        </div>
                        <div className="flex justify-center">
                          <input
                            type="number"
                            min="1"
                            value={item.qty}
                            onChange={(e) =>
                              handleBudgetItemChange(idx, "qty", e.target.value)
                            }
                            className="text-center border-b border-gray-300 outline-none px-1 bg-transparent md:w-16 w-full"
                            placeholder="Qty"
                          />
                        </div>
                        <div className="flex justify-center">
                          <input
                            type="number"
                            min="0"
                            value={item.rate}
                            onChange={(e) =>
                              handleBudgetItemChange(
                                idx,
                                "rate",
                                e.target.value
                              )
                            }
                            className="text-center border-b border-gray-300 outline-none px-1 bg-transparent w-full md:w-20"
                            placeholder="Rate"
                          />
                        </div>
                        <div className="flex justify-center">
                          <button
                            onClick={() => removeBudgetItem(idx)}
                            className="ml-2 rounded-full w-4 h-4 flex items-center justify-center text-[10px] font-bold text-red-500"
                            title="Remove row"
                            style={{ minWidth: "16px" }}
                          >
                            <FaMinus size={10} />
                          </button>
                        </div>
                        <div className="text-right md:pr-4 flex items-center justify-end w-full">
                          Rs{" "}
                          {(
                            parseFloat(item.qty) * parseFloat(item.rate) || 0
                          ).toLocaleString()}
                        </div>
                      </div>
                    ))}
                    <div className="flex justify-center mt-2">
                      <button
                        onClick={addBudgetItem}
                        className="rounded-full w-8 h-8 flex items-center justify-center text-2xl font-bold text-[#2798FF]"
                        title="Add row"
                      >
                        <FaPlus size={18} />
                      </button>
                    </div>
                  </>
                ) : (
                  <>
                    {budgetItems.map((item, idx) => (
                      <div
                        key={idx}
                        className="grid grid-cols-[1.5fr_0.5fr_0.5fr_0.1fr_1fr] py-1 md:py-2 text-sm text-gray-700"
                      >
                        <div className="flex items-center min-w-0 w-full md:text-base text-[8px]">
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="1em"
                            height="1em"
                            viewBox="0 0 24 24"
                            className="flex-shrink-0 mr-1 text-xs md:text-xl"
                          >
                            <path
                              fill="#2798FF"
                              d="m10.537 12l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354z"
                            />
                          </svg>
                          {item.description}
                        </div>
                        <div className="text-center md:text-base text-[8px]">
                          {item.qty}
                        </div>
                        <div className="text-center md:text-base text-[8px]">
                          {item.rate}
                        </div>
                        <div></div>
                        <div className="text-right pr-0 md:pr-4 md:text-base text-[8px]">
                          Rs{" "}
                          {(
                            parseFloat(item.qty) * parseFloat(item.rate) || 0
                          ).toLocaleString()}
                        </div>
                      </div>
                    ))}
                  </>
                )}
                {/* Subtotal and Total rows */}
                <div className="grid grid-cols-[1.5fr_0.5fr_0.5fr_0.1fr_1fr] text-[8px] md:text-sm font-bold bg-gray-100 text-[#2798FF] whitespace-nowrap">
                  <div className="md:p-2.5 p-1 ">Sub total</div>
                  <div></div>
                  <div></div>
                  <div className="bg-gray-50"></div>
                  <div className="text-right p-1 md:p-2.5 whitespace-nowrap ">
                    Rs{" "}
                    {calculateBudgetSubtotal().toLocaleString(undefined, {
                      minimumFractionDigits: 2,
                      maximumFractionDigits: 2,
                    })}
                  </div>
                </div>
                <div className="grid grid-cols-[1.5fr_0.5fr_0.5fr_0.1fr_1fr] font-bold text-[8px] md:text-base">
                  <div className="pl-1 md:pl-4 border-t-2 border-[#2798FF] pt-2.5 text-[#2798FF]">
                    TOTAL
                  </div>
                  <div className="border-t-2 border-[#2798FF]"></div>
                  <div className="border-t-2 border-[#2798FF]"></div>
                  <div></div>
                  <div className="text-right whitespace-nowrap pr-0 md:pr-4 text-[#2798FF] border-t-2 border-[#2798FF] pt-2.5">
                    Rs{" "}
                    {calculateBudgetSubtotal().toLocaleString(undefined, {
                      minimumFractionDigits: 2,
                      maximumFractionDigits: 2,
                    })}
                  </div>
                </div>
              </div>
            </div>

            {/* Contact & Payment Information Row (Duplicated Payment Info Row) */}
            <div className="xl:pr-5 pr-1 flex flex-col justify-start items-start text-left">
              <div className="text-[8px] md:text-xl font-bold text-gray-800 mb-1">
                PAYMENT <br /> INFORMATION
              </div>
            </div>
            <div className="relative self-stretch mb-5  md:mb-0">
              <div className="bg-gray-100 rounded-full md:w-12 md:h-12 h-6 w-6 flex justify-center items-center z-10 absolute top-0 left-1/2 -translate-x-1/2 flex-shrink-0">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="33"
                  height="33"
                  viewBox="0 0 24 24"
                >
                  <g fill="none" fillRule="evenodd" clipRule="evenodd">
                    <path
                      fill="#0c6fff"
                      d="m14.022 16.483l-3.568 2.649c-.21.16-.52.48-.85.71a.7.7 0 0 1-.4.19a1.8 1.8 0 0 1-1.06-.55a14.5 14.5 0 0 1-1.448-1.69c-.79-1-1.56-1.999-2.3-2.999s-1.419-2.049-2.069-3.118c-1.349-2.18-1.269-1.41-.75-1.97q.47-.53 1-.999t1.11-.87l1.999-1.589l.66-.51c.16 0 .33.18.51.34q.372.349.7.74l.999 1.2l3.278 4.387a.361.361 0 1 0 .58-.43L9.254 7.488l-.95-1.26a7 7 0 0 0-1.119-1.16a1.48 1.48 0 0 0-.94-.32a1.4 1.4 0 0 0-.509.2q-.348.222-.66.49l-1.999 1.48c-.43.29-.84.59-1.24.91q-.6.497-1.139 1.059a4.6 4.6 0 0 0-.64.78a.7.7 0 0 0 0 .56q.144.381.36.73c.28.469.65.929.91 1.349c.65 1.089 1.34 2.168 2.119 3.208s1.6 2 2.449 2.999a11.5 11.5 0 0 0 1.999 1.999c.384.28.844.44 1.32.46a1.4 1.4 0 0 0 .76-.27q.526-.41.999-.88c.68-.56 1.36-1.14 1.999-1.689q.68-.549 1.38-1.08a.32.32 0 0 0-.36-.52z"
                    />
                    <path
                      fill="#0c6fff"
                      d="M8.914 11.175a2.38 2.38 0 0 0-2.998-.27a2.45 2.45 0 0 0-.89 1.74a2.15 2.15 0 0 0 .74 1.809c.396.308.887.47 1.39.46c.467.007.928-.117 1.329-.36a.33.33 0 0 0 .12-.44a.35.35 0 0 0 .27-.1a1.83 1.83 0 0 0 .04-2.839m-.58 2.309a.35.35 0 0 0 0 .47h-.12a1.76 1.76 0 0 1-.999.12a1.27 1.27 0 0 1-.77-.39a1.14 1.14 0 0 1-.23-1a1.33 1.33 0 0 1 .46-.89a1.24 1.24 0 0 1 1.55.07a1 1 0 0 1 .11 1.62m9.014-7.077a14 14 0 0 0-.379-1.55a7 7 0 0 0-.54-1.229a1.77 1.77 0 0 0-.81-.75a1.6 1.6 0 0 0-.74-.08q-.646.12-1.268.33a.324.324 0 0 0 .15.63q.495-.099.999-.13a.86.86 0 0 1 .45.09c.14.08.2.26.28.43q.215.518.32 1.07c.19.56.32 1.13.46 1.699s.33 1.17.49 1.75s.249.819.249.829c.08.42.62.08.66-.53c-.2-1.03-.12-1.53-.32-2.559"
                    />
                    <path
                      fill="#4a5565"
                      d="M23.968 16.523a7.7 7.7 0 0 0-.51-2.12a6.7 6.7 0 0 0-1.12-1.889a8.18 8.18 0 0 0-4.367-2.598c-.36-.17-.63.09-.62.52a5.7 5.7 0 0 1-.71 1.579a2.71 2.71 0 0 1-2.759.38a1.35 1.35 0 0 0-.83.09a1.54 1.54 0 0 0-1.079 1.529a2 2 0 0 0 .8 1.609c.13.07.4.2.74.34c.77.32 1.999.74 2.469 1c-.08.2.21.73.26.88a5.5 5.5 0 0 0 1.069 1.808a1.81 1.81 0 0 0 1.44.62a.36.36 0 1 0 0-.72a1.1 1.1 0 0 1-.82-.45a4.3 4.3 0 0 1-.76-1.559c-.05-.18-.07-.75-.15-1a.6.6 0 0 0-.24-.34a5.6 5.6 0 0 0-.74-.399c-.87-.4-2.288-1-2.618-1.2a.77.77 0 0 1-.21-.57a.41.41 0 0 1 .25-.42a1 1 0 0 1 .35 0q.732.074 1.469.06a3 3 0 0 0 2.209-1.289a3.26 3.26 0 0 0 .48-1.709a7.6 7.6 0 0 1 3.448 2.56c.37.497.672 1.042.9 1.618c.234.583.402 1.19.5 1.81c.23 1.504.161 3.04-.2 4.518a.37.37 0 0 0 .25.45a.36.36 0 0 0 .44-.25c.556-1.556.78-3.21.66-4.858"
                    />
                    <path
                      fill="#0c6fff"
                      d="M14.852 10.066c-.29-1-.55-2-.83-3c-.18-.669-.39-1.329-.58-1.998a7.7 7.7 0 0 0-.75-2a1.45 1.45 0 0 0-1.079-.71a.87.87 0 0 0-.46.1q-.383.23-.74.5l-2.438 1.55a.32.32 0 1 0 .27.57l2.639-1.26c.45-.23.58-.89 1 .3c.18.48.29 1 .37 1.29c.389 1.189.769 2.368 1.189 3.548s.69 1.61 1.14 2.669c.199.58.719.72.719.29c-.21-.7-.24-1.15-.45-1.85"
                    />
                  </g>
                </svg>
              </div>
              <div className="w-0.5 bg-[#ef7e1b] absolute left-1/2 -translate-x-1/2 top-8 bottom-0 z-0"></div>
              <div className="bg-[#ef7e1b] rounded-full w-2 h-2 absolute bottom-0 left-1/2 -translate-x-1/2 z-10"></div>
            </div>
            <div className="pl-5">
              <div className="grid grid-cols-2 gap-1">
                <div className="bg-gray-100 border border-gray-100 rounded-lg p-2 md:p-6 flex flex-col justify-items-start">
                  <strong className="md:text-xs text-[8px] text-gray-600 uppercase md:mb-1 block">
                    Account Name
                  </strong>
                  {isEditMode ? (
                    <input
                      type="text"
                      value={quotationDetails.accountName}
                      onChange={(e) =>
                        handleQuotationDetailsChange(
                          "accountName",
                          e.target.value
                        )
                      }
                      className="text-[8px] md:text-sm text-gray-900 font-medium border-b border-gray-300 outline-none px-1 w-full bg-gray-100"
                    />
                  ) : (
                    <span className="text-[8px] md:text-sm text-gray-900 font-medium">
                      {quotationDetails.accountName}
                    </span>
                  )}
                </div>
                <div className="bg-gray-100 border border-gray-100 rounded-lg p-2 md:p-6 flex flex-col justify-items-start">
                  <strong className="text-[8px] md:text-xs text-gray-600 uppercase md:mb-1 block">
                    Bank Name
                  </strong>
                  {isEditMode ? (
                    <input
                      type="text"
                      value={quotationDetails.bankName}
                      onChange={(e) =>
                        handleQuotationDetailsChange("bankName", e.target.value)
                      }
                      className="text-[8px] md:text-sm text-gray-900 font-medium border-b border-gray-300 outline-none px-1 w-full bg-gray-100"
                    />
                  ) : (
                    <span className="text-[8px] md:text-sm text-gray-900 font-medium">
                      {quotationDetails.bankName}
                    </span>
                  )}
                </div>
                <div className="bg-gray-100 border border-gray-100 rounded-lg p-2 md:p-6 flex flex-col justify-items-start">
                  <strong className="text-[8px] md:text-xs text-gray-600 uppercase md:mb-1 block">
                    Account Number
                  </strong>
                  {isEditMode ? (
                    <input
                      type="text"
                      value={quotationDetails.accountNumber}
                      onChange={(e) =>
                        handleQuotationDetailsChange(
                          "accountNumber",
                          e.target.value
                        )
                      }
                      className="text-[8px] md:text-sm text-gray-900 font-medium border-b border-gray-300 outline-none px-1 w-full bg-gray-100"
                    />
                  ) : (
                    <span className="text-[8px] md:text-sm text-gray-900 font-medium">
                      {quotationDetails.accountNumber}
                    </span>
                  )}
                </div>
                <div className="bg-gray-100 border border-gray-100 rounded-lg p-2 md:p-6 flex flex-col justify-items-start">
                  <strong className="text-[8px] md:text-xs text-gray-600 uppercase md:mb-1 block">
                    IFSC Code
                  </strong>
                  {isEditMode ? (
                    <input
                      type="text"
                      value={quotationDetails.ifscCode}
                      onChange={(e) =>
                        handleQuotationDetailsChange("ifscCode", e.target.value)
                      }
                      className="text-[8px] md:text-sm text-gray-900 font-medium border-b border-gray-300 outline-none px-1 w-full bg-gray-100"
                    />
                  ) : (
                    <span className="text-[8px] md:text-sm text-gray-900 font-medium">
                      {quotationDetails.ifscCode}
                    </span>
                  )}
                </div>
                <div className="bg-gray-100 border border-gray-100 rounded-lg p-2 flex flex-col justify-items-start md:p-6">
                  <strong className="text-[8px] md:text-xs text-gray-600 uppercase md:mb-1 block">
                    GSTIN
                  </strong>
                  {isEditMode ? (
                    <input
                      type="text"
                      value={quotationDetails.gstin}
                      onChange={(e) =>
                        handleQuotationDetailsChange("gstin", e.target.value)
                      }
                      className="text-[8px] md:text-sm text-gray-900 font-medium border-b border-gray-300 outline-none px-1 w-full bg-gray-100"
                    />
                  ) : (
                    <span className="text-[8px] md:text-sm text-gray-900 font-medium">
                      {quotationDetails.gstin}
                    </span>
                  )}
                </div>
                <div className="bg-gray-100 border border-gray-100 rounded-lg p-2 flex flex-col justify-items-start  md:p-6">
                  <strong className="text-[8px] md:text-xs text-gray-600 uppercase md:mb-1   block">
                    Branch
                  </strong>
                  {isEditMode ? (
                    <input
                      type="text"
                      value={quotationDetails.branch}
                      onChange={(e) =>
                        handleQuotationDetailsChange("branch", e.target.value)
                      }
                      className="text-[8px] md:text-sm text-gray-900 font-medium border-b border-gray-300 outline-none px-1 w-full bg-gray-100"
                    />
                  ) : (
                    <span className="text-[8px] md:text-sm text-gray-900 font-medium">
                      {quotationDetails.branch}
                    </span>
                  )}
                </div>
              </div>
            </div>

            <div className="xl:pr-5 pr-1 flex flex-col justify-start items-start text-left">
              <div className="text-[8px] md:text-xl font-bold text-gray-800 mb-1">
                PAYMENT <br /> CONDITIONS
              </div>
            </div>
            <div className="relative self-stretch">
              <div className="bg-gray-700 text-white rounded-full md:w-12 md:h-12 w-6 h-6 flex justify-center items-center text-[10px] md:text-lg font-bold z-10 absolute top-0 left-1/2 -translate-x-1/2 flex-shrink-0">
                05.
              </div>
              <div className="w-0.5 bg-gray-700 absolute left-1/2 -translate-x-1/2 top-8 bottom-0 z-0"></div>
              <div className="bg-gray-700 rounded-full w-2 h-2 absolute bottom-0 left-1/2 -translate-x-1/2 z-10"></div>
            </div>
            <div className="pl-5">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-x-1 md:gap-x-6 gap-y-6 w-full">
                {/* Delivery & Payment Terms */}
                <div className="text-[8px] md:text-sm text-gray-700 leading-relaxed flex items-start">
                  <div className="flex-grow">
                    <span className="font-bold text-[10px] md:text-lg text-gray-700 whitespace-nowrap">
                      Delivery & Payment Terms
                    </span>
                    <ul className="text-[8px] md:text-xs text-gray-700 mt-2">
                      {isEditMode
                        ? deliveryTerms.map((term, idx) => (
                            <li
                              key={idx}
                              className="flex items-center mb-1 min-w-0 w-full"
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="1em"
                                height="1em"
                                viewBox="0 0 24 24"
                                className="flex-shrink-0 mr-2"
                              >
                                <path
                                  fill="#364153"
                                  d="m10.537 12l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354z"
                                />
                              </svg>
                              <textarea
                                value={term}
                                onChange={(e) =>
                                  handleDeliveryTermChange(idx, e.target.value)
                                }
                                className="border-b border-gray-300 outline-none px-1 flex-grow bg-transparent min-w-0 w-full resize-y overflow-auto"
                                placeholder="Delivery/payment term"
                                rows={2}
                                style={{ minWidth: 0, minHeight: "32px" }}
                              />
                              <button
                                onClick={() => removeDeliveryTerm(idx)}
                                className="ml-2 rounded-full w-4 h-4 flex items-center justify-center text-[10px] font-bold text-red-500"
                                title="Remove term"
                                disabled={deliveryTerms.length === 1}
                              >
                                <FaMinus size={10} />
                              </button>
                            </li>
                          ))
                        : deliveryTerms.map((term, idx) => (
                            <li key={idx} className="flex items-start mb-1">
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="1em"
                                height="1em"
                                viewBox="0 0 24 24"
                                className="flex-shrink-0 mr-2"
                              >
                                <path
                                  fill="#364153"
                                  d="m10.537 12l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354z"
                                />
                              </svg>
                              {term}
                            </li>
                          ))}
                    </ul>
                    {isEditMode && (
                      <button
                        onClick={addDeliveryTerm}
                        className="mt-2 rounded-full w-6 h-6 flex items-center justify-center text-xl font-bold text-[#2798FF]"
                        title="Add term"
                      >
                        <FaPlus size={14} />
                      </button>
                    )}
                  </div>
                </div>

                {/* Scope & Modifications */}
                <div className="text-[8px] md:text-sm text-gray-700 leading-relaxed flex items-start">
                  <div className="flex-grow">
                    <span className="font-bold text-[10px] md:text-lg text-gray-700">
                      Scope & Modifications
                    </span>
                    <ul className="text-[8px] md:text-xs text-gray-700 mt-2">
                      {isEditMode
                        ? scopeModifications.map((term, idx) => (
                            <li
                              key={idx}
                              className="flex items-center mb-1 min-w-0 w-full"
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="1em"
                                height="1em"
                                viewBox="0 0 24 24"
                                className="flex-shrink-0 mr-2"
                              >
                                <path
                                  fill="#364153"
                                  d="m10.537 12l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354z"
                                />
                              </svg>
                              <textarea
                                value={term}
                                onChange={(e) =>
                                  handleScopeModificationChange(
                                    idx,
                                    e.target.value
                                  )
                                }
                                className="border-b border-gray-300 outline-none px-1 flex-grow bg-transparent min-w-0 w-full resize-y overflow-auto"
                                placeholder="Scope/modification term"
                                rows={2}
                                style={{ minWidth: 0, minHeight: "32px" }}
                              />
                              <button
                                onClick={() => removeScopeModification(idx)}
                                className="ml-2 rounded-full w-4 h-4 flex items-center justify-center text-[10px] font-bold text-red-500"
                                title="Remove term"
                                disabled={scopeModifications.length === 1}
                              >
                                <FaMinus size={10} />
                              </button>
                            </li>
                          ))
                        : scopeModifications.map((term, idx) => (
                            <li key={idx} className="flex items-start mb-1">
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="1em"
                                height="1em"
                                viewBox="0 0 24 24"
                                className="flex-shrink-0 mr-2"
                              >
                                <path
                                  fill="#364153"
                                  d="m10.537 12l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354z"
                                />
                              </svg>
                              {term}
                            </li>
                          ))}
                    </ul>
                    {isEditMode && (
                      <button
                        onClick={addScopeModification}
                        className="mt-2 rounded-full w-6 h-6 flex items-center justify-center text-xl font-bold text-[#2798FF]"
                        title="Add term"
                      >
                        <FaPlus size={14} />
                      </button>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className=" bg-white px-2 md:px-12  text-center">
        <p className=" text-gray-500 text-xs md:text-base leading-relaxed max-w-xl mx-auto mb-5">
          Thank you for the opportunity to serve you. We look forward to further
          communication with you after you have reviewed this proposal.
        </p>
        <p className="text-sm md:text-xl font-bold text-blue-900 uppercase tracking-wide mb-7 ">
          Your positive reply awaiting!
        </p>
      </div>

      {/* Edit/Save/Submit Buttons */}
      <div className="flex flex-col sm:flex-row justify-between items-center gap-4 mt-8 px-4 sm:px-6 lg:px-[20px] mb-4">
        <div className="flex flex-col sm:flex-row gap-2 sm:gap-[10px] w-full sm:w-auto">
          {isEditMode ? (
            <>
              <button
                onClick={toggleMode}
                className="w-full sm:w-[150px] h-[40px] border border-[#2798FF] rounded-[10px] text-[#2798FF] text-[16px] font-semibold flex items-center justify-center hover:text-white hover:bg-[#ee7f1b]"
              >
                Exit Edit Mode
              </button>
              <button
                onClick={saveChangesAndExitEditMode}
                className="w-full sm:w-[150px] h-[40px] bg-[#ef7e1b] rounded-[10px] text-white text-[16px] font-semibold flex items-center justify-center hover:bg-[#ee7f1b]"
              >
                Save Changes
              </button>
            </>
          ) : (
            <>
              <button
                onClick={toggleMode}
                className="w-full sm:w-[150px] h-[40px] border border-[#2798FF] rounded-[10px] text-[#2798FF] text-[16px] font-semibold flex items-center justify-center hover:text-white hover:bg-[#ee7f1b]"
              >
                Enter Edit Mode
              </button>
              <button
                onClick={submitQuotation}
                className="w-full sm:w-[150px] h-[40px] bg-[#ef7e1b] rounded-[10px] text-white text-[16px] font-semibold flex items-center justify-center hover:bg-[#ee7f1b]"
              >
                Submit Quotation
              </button>
              <div className="flex sm:hidden justify-center items-center w-full mt-2">
                <button
                  className="w-full text-[#8B8B8B] text-xs rounded-[10px] py-2 px-4 flex items-center justify-center  gap-2"
                  onClick={() => {
                    if (pdfDownloadLinkRef.current) {
                      pdfDownloadLinkRef.current.click();
                    }
                  }}
                  type="button"
                >
                  <span className="mr-2">Export to PDF</span>
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 100 100"
                    fill="#727A90"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M12.5 90.625H21.875V100H12.5C5.60547 100 0 94.3945 0 87.5V12.5C0 5.60547 5.60547 0 12.5 0H44.8242C48.1445 0 51.3281 1.30859 53.6719 3.65234L71.3477 21.3281C73.6914 23.6719 75 26.8555 75 30.1758V59.375H65.625V31.25H50C46.543 31.25 43.75 28.457 43.75 25V9.375H12.5C10.7812 9.375 9.375 10.7812 9.375 12.5V87.5C9.375 89.2188 10.7812 90.625 12.5 90.625ZM34.375 68.75H40.625C46.6602 68.75 51.5625 73.6523 51.5625 79.6875C51.5625 85.7227 46.6602 90.625 40.625 90.625H37.5V96.875C37.5 98.5938 36.0938 100 34.375 100C32.6562 100 31.25 98.5938 31.25 96.875V71.875C31.25 70.1562 32.6562 68.75 34.375 68.75ZM40.625 84.375C43.2227 84.375 45.3125 82.2852 45.3125 79.6875C45.3125 77.0898 43.2227 75 40.625 75H37.5V84.375H40.625ZM59.375 68.75H65.625C70.8008 68.75 75 72.9492 75 78.125V90.625C75 95.8008 70.8008 100 65.625 100H59.375C57.6562 100 56.25 98.5938 56.25 96.875V71.875C56.25 70.1562 57.6562 68.75 59.375 68.75ZM65.625 93.75C67.3438 93.75 68.75 92.3438 68.75 90.625V78.125C68.75 76.4062 67.3438 75 65.625 75H62.5V93.75H65.625ZM81.25 71.875C81.25 70.1562 82.6562 68.75 84.375 68.75H93.75C95.4688 68.75 96.875 70.1562 96.875 71.875C96.875 73.5938 95.4688 75 93.75 75H87.5V81.25H93.75C95.4688 81.25 96.875 82.6562 96.875 84.375C96.875 86.0938 95.4688 87.5 93.75 87.5H87.5V96.875C87.5 98.5938 86.0938 100 84.375 100C82.6562 100 81.25 98.5938 81.25 96.875V71.875Z"
                      fill="#727A90"
                    />
                  </svg>
                </button>
              </div>
            </>
          )}
        </div>
        {/* Export to PDF button (visible), triggers hidden PDFDownloadLink */}
        {!isEditMode && (
          <>
            <button
              className="hidden sm:flex justify-end items-center hover:bg-gray-100 p-4 rounded-full text-[#8B8B8B] text-sm"
              onClick={() => {
                if (pdfDownloadLinkRef.current) {
                  pdfDownloadLinkRef.current.click();
                }
              }}
              type="button"
            >
              <span className="mr-4">Export to PDF</span>
              <svg
                width="30"
                height="30"
                viewBox="0 0 100 100"
                fill="#727A90"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M12.5 90.625H21.875V100H12.5C5.60547 100 0 94.3945 0 87.5V12.5C0 5.60547 5.60547 0 12.5 0H44.8242C48.1445 0 51.3281 1.30859 53.6719 3.65234L71.3477 21.3281C73.6914 23.6719 75 26.8555 75 30.1758V59.375H65.625V31.25H50C46.543 31.25 43.75 28.457 43.75 25V9.375H12.5C10.7812 9.375 9.375 10.7812 9.375 12.5V87.5C9.375 89.2188 10.7812 90.625 12.5 90.625ZM34.375 68.75H40.625C46.6602 68.75 51.5625 73.6523 51.5625 79.6875C51.5625 85.7227 46.6602 90.625 40.625 90.625H37.5V96.875C37.5 98.5938 36.0938 100 34.375 100C32.6562 100 31.25 98.5938 31.25 96.875V71.875C31.25 70.1562 32.6562 68.75 34.375 68.75ZM40.625 84.375C43.2227 84.375 45.3125 82.2852 45.3125 79.6875C45.3125 77.0898 43.2227 75 40.625 75H37.5V84.375H40.625ZM59.375 68.75H65.625C70.8008 68.75 75 72.9492 75 78.125V90.625C75 95.8008 70.8008 100 65.625 100H59.375C57.6562 100 56.25 98.5938 56.25 96.875V71.875C56.25 70.1562 57.6562 68.75 59.375 68.75ZM65.625 93.75C67.3438 93.75 68.75 92.3438 68.75 90.625V78.125C68.75 76.4062 67.3438 75 65.625 75H62.5V93.75H65.625ZM81.25 71.875C81.25 70.1562 82.6562 68.75 84.375 68.75H93.75C95.4688 68.75 96.875 70.1562 96.875 71.875C96.875 73.5938 95.4688 75 93.75 75H87.5V81.25H93.75C95.4688 81.25 96.875 82.6562 96.875 84.375C96.875 86.0938 95.4688 87.5 93.75 87.5H87.5V96.875C87.5 98.5938 86.0938 100 84.375 100C82.6562 100 81.25 98.5938 81.25 96.875V71.875Z"
                  fill="#727A90"
                />
              </svg>
            </button>
            {/* Hidden PDFDownloadLink for programmatic click */}
            <div style={{ display: "none" }}>
              <PDFDownloadLink
                document={
                  <QuotationPDF
                    organisationInfo={organisationInfo}
                    formData={formData}
                    serviceItems={serviceItems}
                    calculateTotalServiceCharge={calculateTotalServiceCharge}
                    user={user}
                    dummyAvatar={dummyAvatar}
                    quotationDetails={quotationDetails}
                    servicesIncluded={servicesIncluded}
                    budgetItems={budgetItems}
                    calculateBudgetSubtotal={calculateBudgetSubtotal}
                    deliveryTerms={deliveryTerms}
                    scopeModifications={scopeModifications}
                  />
                }
                fileName={`Quotation-${quotationDetails.quoteNumber}.pdf`}
                ref={pdfDownloadLinkRef}
              >
                Download PDF
              </PDFDownloadLink>
            </div>
          </>
        )}
      </div>
    </div>
  );
};

const stripHtmlTags = (html) => {
  const doc = new DOMParser().parseFromString(html, "text/html");
  return doc.body.textContent || "";
};

const convertImageUrlForPdf = (url) => {
  if (typeof url === "string" && url.includes("/public/")) {
    const filename = url.substring(url.lastIndexOf("/") + 1);
    const publicIndex = url.indexOf("/public/");
    if (publicIndex !== -1) {
      const baseUrl = url.substring(0, publicIndex);
      return `${baseUrl}/public/api/image-proxy/${filename}`;
    }
  }
  return url;
};

const QuotationPDF = ({
  organisationInfo,
  formData,
  serviceItems,
  calculateTotalServiceCharge,
  user,
  dummyAvatar,
  quotationDetails,
  servicesIncluded,
  budgetItems = [],
  deliveryTerms = [],
  scopeModifications = [],
  calculateBudgetSubtotal = () => 0,
}) => {
  const firstPageServices = servicesIncluded.slice(0, 2);
  const remainingServices = servicesIncluded.slice(2);
  const hasRemainingServices = remainingServices.length > 0;

  const paymentConditionsItems = Math.max(
    deliveryTerms.length,
    scopeModifications.length
  );
  const paymentConditionsHeight = Math.max(40, paymentConditionsItems * 38 + 2); // 45 is an estimated row height
  console.log(
    "PDF Payment Conditions Height:",
    paymentConditionsHeight,
    "Items:",
    paymentConditionsItems
  );

  // Helper for comma-separated numbers
  const formatNumber = (num) => {
    return num.toLocaleString(undefined, {
      minimumFractionDigits: 0,
      maximumFractionDigits: 2,
    });
  };

  // Profile image logic
  let imageUrl = null;
  const profilePicUrl = organisationInfo?.profile_image || user?.profile_pic;
  if (
    profilePicUrl &&
    typeof profilePicUrl === "string" &&
    profilePicUrl.trim() !== "" &&
    (profilePicUrl.startsWith("http://") ||
      profilePicUrl.startsWith("https://"))
  ) {
    imageUrl = convertImageUrlForPdf(profilePicUrl);
  }

  // Office address logic
  let officeAddressLines = [
    "145 Sai Bagh Colony,",
    "Khandwa Road,",
    "Indore, Madhya Pradesh",
  ];
  const orgAddress =
    organisationInfo?.address || user?.organisationInfo?.address;
  if (orgAddress) {
    try {
      const addr = JSON.parse(orgAddress);
      officeAddressLines = [
        addr.blockUnitStreetName,
        [addr.city, addr.state].filter(Boolean).join(", "),
        [addr.country, addr.pincode].filter(Boolean).join(", "),
      ].filter(Boolean);
    } catch (e) {}
  }

  // Customer address logic
  const customerAddressLines = [
    quotationDetails.customerAddressLine1,
    quotationDetails.customerAddressLine2,
    quotationDetails.customerAddressLine3,
  ].filter(Boolean);

  // Main color palette
  const blue = "#2798FF";
  const gray700 = "#4B5563";
  const gray600 = "#545454";
  const gray100 = "#F3F4F6";
  const gray50 = "#F8FAFC";
  const white = "#FFFFFF";
  const dark = "#364153";
  const gray900 = "#1F2937";
  const gray800 = "#4B5563";
  const gray400 = "#8B8B8B";
  const gray200 = "#E5E7EB";
  const gray300 = "#E7EFF8";
  const grayText = "#545454";
  const blueDark = "#0e4053";
  const blue700 = "#0e4053";

  // PDF styles (translated from Tailwind/CSS)
  const pdfStyles = StyleSheet.create({
    page: {
      backgroundColor: white,
      minHeight: "100vh",
      borderRadius: 16,
      padding: 0,
      fontFamily: "Helvetica",
    },
    container: {
      width: "100%",
      minHeight: "100vh",
      borderRadius: 16,
      flexDirection: "column",
      position: "relative",
      overflow: "hidden",
    },
    headerRow: {
      flexDirection: "row",
      justifyContent: "space-between",
      alignItems: "flex-start",
      marginBottom: 32,
      marginTop: 5,
      paddingHorizontal: 25,
      gap: 24,
    },
    headerLeft: {
      flexDirection: "column",
      flexGrow: 2,
      marginTop: 32,
    },
    profileRow: {
      flexDirection: "column",
      alignItems: "flex-start",
      marginBottom: 16,
    },
    profileImage: {
      width: 120,
      height: 50,
      marginBottom: 8,
      objectFit: "contain",
    },
    orgName: {
      fontSize: 24,
      color: gray900,
    },
    headerDetails: {
      flexDirection: "column",
      alignItems: "flex-start",
      marginTop: 12,
    },
    headerDetailText: {
      fontSize: 12,
      color: gray700,
      marginBottom: 2,
    },
    headerRight: {
      flex: 1,
      alignItems: "flex-end",
      justifyContent: "flex-end",
      position: "relative",
      marginTop: 150,
    },
    quotationTitle: {
      color: blue,
      fontSize: 32,
      fontWeight: "bold",
      fontFamily: "Helvetica-Bold",
      textAlign: "right",
    },
    addressSection: {
      backgroundColor: gray50,
      paddingVertical: 24,
      paddingHorizontal: 25,
      marginBottom: 10,
      flexDirection: "column",
    },
    addressRow: {
      flexDirection: "row",
      justifyContent: "space-between",
    },
    addressBlock: {
      flexDirection: "column",
      alignItems: "flex-start",
    },
    addressTitle: {
      fontWeight: "bold",
      fontSize: 14,
      color: gray700,
      marginBottom: 2,
    },
    addressLine: {
      fontSize: 10,
      color: gray700,
      marginBottom: 2,
    },
    toBlock: {
      flexDirection: "column",
      alignItems: "flex-start",
    },
    toTitle: {
      fontWeight: "bold",
      fontSize: 14,
      color: gray700,
      marginBottom: 2,
    },
    toLine: {
      fontSize: 10,
      color: gray700,
      marginBottom: 2,
    },
    dearSirSection: {
      paddingHorizontal: 25,
      marginBottom: 24,
    },
    dearSirHeading: {
      fontSize: 20,
      fontWeight: "bold",
      color: blue,
      marginBottom: 8,
    },
    dearSirText: {
      fontSize: 12,
      color: gray600,
      lineHeight: 1.5,
    },
    projectOverviewRow: {
      flexDirection: "row",
      alignItems: "flex-start",
      marginBottom: 24,
      paddingHorizontal: 25,
    },
    projectOverviewLeft: {
      width: 120,
      flexDirection: "column",
      alignItems: "flex-start",
      marginRight: 20,
    },
    projectOverviewIconWrap: {
      backgroundColor: gray100,
      borderRadius: 24,
      width: 48,
      height: 48,
      alignItems: "center",
      justifyContent: "center",
      marginTop: 12,
    },
    projectOverviewCenter: {
      width: 48,
      alignItems: "center",
      justifyContent: "center",
      position: "relative",
    },
    projectOverviewRight: {
      flex: 1,
      flexDirection: "column",
      alignItems: "flex-start",
      justifyContent: "center",
    },
    projectOverviewTitle: {
      fontSize: 15,
      fontWeight: "bold",
      color: gray800,
      marginBottom: 4,
    },
    projectOverviewGrid: {
      flexDirection: "row",
      backgroundColor: gray100,
      borderRadius: 8,
      padding: 12,
      justifyContent: "space-between",
      width: "100%",
    },
    projectOverviewCol: {
      flex: 1,
      paddingHorizontal: 4,
      alignItems: "flex-start",
    },
    projectOverviewLabel: {
      fontWeight: "bold",
      fontSize: 10,
      color: gray800,
      marginBottom: 2,
    },
    projectOverviewValue: {
      fontSize: 10,
      color: gray700,
      whiteSpace: "nowrap",
    },
    sectionTitleRow: {
      flexDirection: "row",
      alignItems: "flex-start",
      marginBottom: 24,
      paddingHorizontal: 25,
    },
    sectionTitleLeft: {
      width: 120,
      flexDirection: "column",
      alignItems: "flex-start",
      marginRight: 20,
    },
    sectionTitle: {
      fontSize: 15,
      fontWeight: "bold",
      color: gray800,
      marginBottom: 4,
    },
    sectionTitleCenter: {
      width: 48,
      alignItems: "center",
      justifyContent: "center",
      position: "relative",
    },
    sectionTitleRight: {
      flex: 1,
      flexDirection: "column",
      alignItems: "flex-start",
      justifyContent: "center",
    },
    servicesGrid: {
      flexDirection: "row",
      flexWrap: "wrap",
      gap: 24,
      paddingHorizontal: 25,
      marginBottom: 24,
    },
    serviceCard: {
      width: "48%",
      backgroundColor: white,
      borderRadius: 8,
      padding: 16,
      marginBottom: 16,
      flexDirection: "row",
      alignItems: "flex-start",
      borderWidth: 1,
      borderColor: gray200,
    },
    serviceIndex: {
      fontWeight: "bold",
      fontSize: 18,
      color: blue,
      marginRight: 8,
      flexShrink: 0,
    },
    serviceContent: {
      flex: 1,
      flexDirection: "column",
    },
    serviceTitle: {
      fontWeight: "bold",
      fontSize: 16,
      color: blue,
      marginBottom: 2,
    },
    serviceDesc: {
      fontSize: 10,
      color: gray700,
      marginBottom: 4,
    },
    serviceBullets: {
      flexDirection: "column",
      marginLeft: 8,
    },
    serviceBulletRow: {
      flexDirection: "row",
      alignItems: "flex-start",
      marginBottom: 2,
    },
    serviceBulletIcon: {
      marginRight: 4,
      width: 8,
      height: 8,
    },
    serviceBulletText: {
      fontSize: 10,
      color: gray700,
    },
    budgetSection: {
      paddingHorizontal: 25,
      marginBottom: 24,
    },
    budgetTitleRow: {
      flexDirection: "row",
      alignItems: "flex-start",
      marginBottom: 8,
    },
    budgetTitleLeft: {
      width: 120,
      flexDirection: "column",
      alignItems: "flex-start",
      marginRight: 20,
    },
    budgetTitle: {
      fontSize: 15,
      fontWeight: "bold",
      color: gray800,
      marginBottom: 2,
    },
    budgetTitleCenter: {
      width: 48,
      alignItems: "center",
      justifyContent: "center",
      position: "relative",
    },
    budgetTitleRight: {
      flex: 1,
      flexDirection: "column",
      alignItems: "flex-start",
      justifyContent: "center",
    },
    budgetDate: {
      fontSize: 10,
      color: gray600,
      marginBottom: 2,
    },
    budgetTable: {
      flexDirection: "column",
      width: "100%",
      marginTop: 8,
      marginBottom: 8,
    },
    budgetTableHeaderRow: {
      flexDirection: "row",
    },
    budgetTableHeaderCell: {
      fontSize: 10,
      fontWeight: "bold",
      color: white,
      padding: 8,
      textAlign: "center",
      flex: 1,
    },
    budgetTableHeaderCellDesc: {
      flex: 3,
      textAlign: "left",
    },
    budgetTableHeaderCellAmount: {
      backgroundColor: gray700,
      color: white,
      textAlign: "right",
      flex: 2,
    },
    budgetTableRow: {
      flexDirection: "row",
      alignItems: "center",

      minHeight: 32,
    },
    budgetTableCell: {
      fontSize: 10,
      color: gray700,
      padding: 8,
      textAlign: "center",
    },
    budgetTableCellDesc: {
      flex: 3,
      textAlign: "left",
      flexDirection: "row",
      alignItems: "center",
    },
    budgetTableCellAmount: {
      color: gray700,
      textAlign: "right",
      flex: 2,
    },
    budgetSubtotalRow: {
      flexDirection: "row",
      backgroundColor: gray100,
      alignItems: "center",
      fontWeight: "bold",
    },
    budgetSubtotalCell: {
      fontSize: 10,
      color: blue,
      padding: 8,
      textAlign: "left",
      flex: 3,
      fontWeight: "bold",
    },
    budgetSubtotalCellAmount: {
      fontSize: 10,
      color: blue,
      padding: 8,
      textAlign: "right",
      flex: 2,
      fontWeight: "bold",
    },
    budgetTotalRow: {
      flexDirection: "row",
      alignItems: "center",
      fontWeight: "bold",
    },
    budgetTotalCell: {
      fontSize: 12,
      color: blue,
      padding: 8,
      textAlign: "left",
      flex: 3,
      fontWeight: "bold",
    },
    budgetTotalCellAmount: {
      fontSize: 12,
      color: blue,
      padding: 8,
      textAlign: "right",
      flex: 2,
      fontWeight: "bold",
    },
    paymentSection: {
      paddingHorizontal: 25,
      marginBottom: 24,
    },
    paymentTitleRow: {
      flexDirection: "row",
      alignItems: "flex-start",
      marginBottom: 8,
    },
    paymentTitleLeft: {
      width: 120,
      flexDirection: "column",
      alignItems: "flex-start",
      marginRight: 20,
    },
    paymentTitle: {
      fontSize: 14,
      fontWeight: "bold",
      color: gray800,
      marginBottom: 2,
    },
    paymentTitleCenter: {
      width: 48,
      alignItems: "center",
      justifyContent: "center",
      position: "relative",
    },
    paymentTitleRight: {
      flex: 1,
      flexDirection: "column",
      alignItems: "flex-start",
      justifyContent: "center",
    },
    paymentGrid: {
      flexDirection: "row",
      flexWrap: "wrap",
      gap: 4,
      marginTop: 4,
    },
    paymentCard: {
      width: "48%",
      backgroundColor: gray100,
      borderRadius: 8,
      padding: 16,

      borderWidth: 1,
      borderColor: gray100,
    },
    paymentLabel: {
      fontSize: 8,
      color: gray600,
      fontWeight: "bold",
      textTransform: "uppercase",
      marginBottom: 2,
    },
    paymentValue: {
      fontSize: 10,
      color: gray900,
      fontWeight: "medium",
    },
    conditionsSection: {
      paddingHorizontal: 25,
      marginBottom: 24,
    },
    conditionsTitleRow: {
      flexDirection: "row",
      alignItems: "flex-start",
      marginBottom: 8,
    },
    conditionsTitleLeft: {
      width: 120,
      flexDirection: "column",
      alignItems: "flex-start",
      marginRight: 20,
    },
    conditionsTitle: {
      fontSize: 15,
      fontWeight: "bold",
      color: gray800,
      marginBottom: 2,
    },
    conditionsTitleCenter: {
      width: 48,
      alignItems: "center",
      justifyContent: "center",
      position: "relative",
    },
    conditionsTitleRight: {
      flex: 1,
      flexDirection: "column",
      alignItems: "flex-start",
      justifyContent: "center",
    },
    conditionsGrid: {
      flexDirection: "row",
      gap: 24,
      marginTop: 8,
    },
    conditionsCol: {
      flex: 1,
      flexDirection: "column",
      marginRight: 16,
    },
    conditionsColTitle: {
      fontWeight: "bold",
      fontSize: 11,
      color: gray700,
      marginBottom: 4,
    },
    conditionsList: {
      flexDirection: "column",
    },
    conditionsListItem: {
      flexDirection: "row",
      alignItems: "flex-start",
      marginBottom: 4,
    },
    conditionsBulletIcon: {
      marginRight: 4,
      width: 8,
      height: 8,
    },
    conditionsBulletText: {
      fontSize: 10,
      color: gray700,
    },
    closingSection: {
      paddingHorizontal: 25,
      marginBottom: 24,
      marginTop: 20,
      alignItems: "center",
      justifyContent: "center",
    },
    closingText: {
      fontSize: 12,
      color: gray600,
      textAlign: "center",
      marginBottom: 8,
      maxWidth: 400,
    },
    closingTitle: {
      fontSize: 16,
      fontWeight: "bold",
      color: blueDark,
      textTransform: "uppercase",
      textAlign: "center",
      marginBottom: 8,
    },
  });

  // --- PDF Layout ---
  return (
    <Document>
      <Page size="A4" style={pdfStyles.page}>
        <View style={pdfStyles.container}>
          {/* Header Section */}
          <View style={pdfStyles.headerRow}>
            <View style={pdfStyles.headerLeft}>
              <View style={pdfStyles.profileRow}>
                {imageUrl && (
                  <Image src={imageUrl} style={pdfStyles.profileImage} />
                )}
                <Text style={pdfStyles.orgName}>
                  {organisationInfo?.organizationname ||
                    user?.organisationInfo?.organizationname ||
                    "Royal House Design"}
                </Text>
              </View>
              <View style={pdfStyles.headerDetails}>
                <Text style={pdfStyles.headerDetailText}>
                  <Text style={{ fontWeight: "bold" }}>Quote #:</Text>{" "}
                  {quotationDetails.quoteNumber}
                </Text>
                <Text style={pdfStyles.headerDetailText}>
                  <Text style={{ fontWeight: "bold" }}>Date:</Text>{" "}
                  {quotationDetails.quoteDate}
                </Text>
                <Text style={pdfStyles.headerDetailText}>
                  <Text style={{ fontWeight: "bold" }}>Valid Until:</Text>{" "}
                  {quotationDetails.validUntil}
                </Text>
              </View>
            </View>
            <View style={pdfStyles.headerRight}>
              <Image
                src={"/quotation-text.png"}
                style={{ width: 150, height: 40, marginBottom: 0 }}
                cache={false}
              />
            </View>
          </View>
          <View
            style={{
              backgroundColor: gray50,
            }}
          >
            {/* Address Section */}
            <View style={pdfStyles.addressSection}>
              <View style={pdfStyles.addressRow}>
                <View style={pdfStyles.addressBlock}>
                  <Text style={pdfStyles.addressTitle}>Office</Text>
                  {officeAddressLines.map((line, idx) => (
                    <Text key={idx} style={pdfStyles.addressLine}>
                      {line}
                    </Text>
                  ))}
                </View>
                <View style={pdfStyles.toBlock}>
                  <Text style={pdfStyles.toTitle}>
                    To: {quotationDetails.customerName}
                  </Text>
                  {customerAddressLines.map((line, idx) => (
                    <Text key={idx} style={pdfStyles.toLine}>
                      {line}
                    </Text>
                  ))}
                </View>
              </View>
            </View>

            {/* Main Content Grid (Stepper Sections) */}
            {/* 1. Dear Sir Section (spans all columns) */}

            <View
              style={{
                flexDirection: "row",
                paddingHorizontal: 25,
                marginBottom: 26,
              }}
            >
              <View style={{ flex: 1, paddingRight: 20, marginBottom: 15 }}>
                <Text style={pdfStyles.dearSirHeading}>Dear Sir,</Text>
                <Text style={pdfStyles.dearSirText}>
                  {stripHtmlTags(quotationDetails.dearSirMessage)}
                </Text>
              </View>
            </View>

            {/* 2. Project Overview Section */}
            <View
              style={{
                flexDirection: "row",
                alignItems: "flex-start",
                marginBottom: 45,
                paddingHorizontal: 25,
              }}
            >
              {/* Left: Title */}
              <View
                style={{
                  flex: 1,
                  paddingRight: 20,
                  justifyContent: "flex-start",
                }}
              >
                <Text style={pdfStyles.projectOverviewTitle}>
                  PROJECT {"\n"}OVERVIEW
                </Text>
              </View>
              {/* Center: Stepper */}
              <View
                style={{
                  width: 48,
                  alignItems: "center",
                  position: "relative",
                }}
              >
                {/* Top vertical line (if not first section) */}

                {/* Circle with number */}
                <View
                  style={{
                    backgroundColor: gray100,
                    borderRadius: 24,
                    width: 44,
                    height: 44,
                    alignItems: "center",
                    justifyContent: "center",
                    zIndex: 1,
                  }}
                >
                  <Svg width="43" height="43" viewBox="-8 -8 40 40">
                    <Path
                      fill={blue}
                      d="M5.37 20q-.553 0-.942-.387q-.39-.387-.39-.94v-1.727l3.54-3.146V20zm3.053 0v-3.538h7.154V20zm8 0v-7.267L12.61 9.366l2.679-2.368l4.23 3.744q.212.206.327.46q.116.255.116.543v6.923q0 .553-.387.943t-.94.389zM4.039 15.788v-4.03q0-.287.115-.551t.327-.465l6.635-5.88q.2-.181.424-.259q.225-.078.461-.078t.46.078t.424.259l1.769 1.582z"
                    />
                  </Svg>
                </View>
              </View>
              {/* Right: Content */}
              <View style={{ flex: 3, paddingLeft: 20 }}>
                <View style={pdfStyles.projectOverviewGrid}>
                  <View style={pdfStyles.projectOverviewCol}>
                    <Text style={pdfStyles.projectOverviewLabel}>
                      PROJECT TYPE
                    </Text>
                    <Text style={pdfStyles.projectOverviewValue}>
                      {quotationDetails.projectType}
                    </Text>
                  </View>
                  <View style={pdfStyles.projectOverviewCol}>
                    <Text style={pdfStyles.projectOverviewLabel}>
                      PLOT SIZE
                    </Text>
                    <Text style={pdfStyles.projectOverviewValue}>
                      {quotationDetails.plotSize}
                    </Text>
                  </View>
                  <View style={pdfStyles.projectOverviewCol}>
                    <Text style={pdfStyles.projectOverviewLabel}>PACKAGE</Text>
                    <Text style={pdfStyles.projectOverviewValue}>
                      {quotationDetails.packageType}
                    </Text>
                  </View>
                </View>
              </View>
            </View>

            {/* 3. Services Included Section */}
            <View
              style={{
                flexDirection: "row",
                alignItems: "flex-start",
                marginBottom: 24,
                paddingHorizontal: 25,
                height: 225,
              }}
            >
              {/* Left: Title */}
              <View
                style={{
                  flex: 1,
                  paddingRight: 20,
                  justifyContent: "flex-start",
                }}
              >
                <Text style={pdfStyles.sectionTitle}>
                  SERVICES {"\n"}INCLUDED
                </Text>
              </View>
              {/* Center: Stepper */}
              <View
                style={{
                  width: 48,
                  alignItems: "center",
                  position: "relative",
                }}
              >
                {/* Top vertical line */}

                {/* Circle with number */}
                <View
                  style={{
                    backgroundColor: blue,
                    borderRadius: 24,
                    width: 40,
                    height: 40,
                    alignItems: "center",
                    justifyContent: "center",
                    zIndex: 1,
                  }}
                >
                  <Text
                    style={{ color: white, fontWeight: "bold", fontSize: 12 }}
                  >
                    02.
                  </Text>
                </View>
                {/* Bottom vertical line */}
                <View
                  style={{
                    width: 2,
                    height: 400,
                    backgroundColor: blue,
                    position: "absolute",
                    top: 40,
                    left: 23,
                    zIndex: 0,
                  }}
                />
                {/* Bottom dot */}
              </View>
              {/* Right: Content */}
              <View style={{ flex: 3, paddingLeft: 20 }}>
                {/* 2-column grid for services */}
                <View
                  style={{
                    flexDirection: "row",
                    flexWrap: "wrap",
                    width: "100%",
                    justifyContent: "space-between",
                    paddingHorizontal: 0,
                    marginBottom: 0,
                  }}
                >
                  {firstPageServices.map((service, index) => (
                    <View
                      key={service.id}
                      style={{
                        width: "49%", // 2 columns with a small gap

                        maxWidth: "49%",
                        marginBottom: 15,

                        flexDirection: "row",
                        alignItems: "flex-start",
                      }}
                    >
                      {/* Number */}
                      <Text
                        style={{
                          fontWeight: "bold",

                          fontSize: 12,
                          color: blue,
                          width: 20,
                          textAlign: "right",
                          marginRight: 8,
                        }}
                      >
                        {(index + 1).toString().padStart(2, "0")}
                      </Text>
                      {/* Content */}
                      <View
                        style={{
                          flex: 1,
                          flexDirection: "column",
                          flexWrap: "wrap",
                        }}
                      >
                        <Text
                          style={{
                            fontWeight: "bold",
                            fontSize: 12,
                            color: blue,
                            marginBottom: 2,
                            wordBreak: "break-word", // ADD THIS
                          }}
                        >
                          {service.title}
                        </Text>
                        <Text
                          style={{
                            fontSize: 8,
                            color: "#374151",
                            marginBottom: 6,
                          }}
                        >
                          {service.mainDescription}
                        </Text>
                        <View style={{ marginLeft: 0 }}>
                          {service.bulletPoints.map((bullet, bulletIndex) => (
                            <View
                              key={bulletIndex}
                              style={{
                                flexDirection: "row",
                                alignItems: "flex-start",
                                marginBottom: 2,
                              }}
                            >
                              <Svg
                                width="10"
                                height="10"
                                viewBox="0 0 24 24"
                                style={{ marginRight: 6, marginTop: 2 }}
                              >
                                <Path
                                  fill={blue}
                                  d="m10.537 12l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354z"
                                />
                              </Svg>

                              <Text
                                style={{
                                  fontSize: 8,
                                  color: "#374151",
                                  flex: 1,
                                }}
                              >
                                {bullet}
                              </Text>
                            </View>
                          ))}
                        </View>
                      </View>
                    </View>
                  ))}
                </View>
              </View>
            </View>
          </View>
        </View>
      </Page>

      <Page size="A4" style={[pdfStyles.page, { backgroundColor: gray50 }]}>
        <View style={pdfStyles.container}>
          <View
            style={{
              backgroundColor: gray50,
            }}
          >
            <View
              style={{
                flexDirection: "row",
                alignItems: "flex-start",
                marginBottom: 24,
                paddingHorizontal: 25,
              }}
            >
              {/* Left: Title */}
              <View
                style={{
                  flex: 1,
                  paddingRight: 20,
                  justifyContent: "flex-start",
                }}
              ></View>
              {/* Center: Stepper */}
              <View
                style={{
                  width: 48,
                  alignItems: "center",
                  position: "relative",
                }}
              >
                {/* Top vertical line */}

                {/* Bottom vertical line */}
                <View
                  style={{
                    width: 2,
                    height: Math.max(
                      60,
                      Math.ceil(remainingServices.length / 2) * 200
                    ), // 60px per row, min 60
                    backgroundColor: blue,
                    position: "absolute",
                    top: 0,
                    left: 23,
                    zIndex: 0,
                  }}
                />
                {/* Bottom dot */}
                <View
                  style={{
                    width: 8,
                    height: 8,
                    borderRadius: 4,
                    backgroundColor: blue,
                    position: "absolute",
                    top:
                      Math.max(
                        60,
                        Math.ceil(remainingServices.length / 2) * 200
                      ) - 2, // -2 to center the dot
                    left: 20,
                  }}
                />
              </View>
              {/* Right: Content */}
              <View style={{ flex: 3, paddingLeft: 20, marginTop: 20 }}>
                {/* 2-column grid for services */}
                <View
                  style={{
                    flexDirection: "row",
                    flexWrap: "wrap",
                    width: "100%",
                    justifyContent: "space-between",
                    paddingHorizontal: 0,
                    marginBottom: 0,
                  }}
                >
                  {remainingServices.map((service, index) => (
                    <View
                      key={service.id}
                      style={{
                        width: "49%", // 2 columns with a small gap

                        maxWidth: "49%",
                        marginBottom: 15,

                        flexDirection: "row",
                        alignItems: "flex-start",
                      }}
                    >
                      {/* Number */}
                      <Text
                        style={{
                          fontWeight: "bold",

                          fontSize: 12,
                          color: blue,
                          width: 20,
                          textAlign: "right",
                          marginRight: 8,
                        }}
                      >
                        {(index + 3).toString().padStart(2, "0")}
                      </Text>
                      {/* Content */}
                      <View
                        style={{
                          flex: 1,
                          flexDirection: "column",
                          flexWrap: "wrap",
                        }}
                      >
                        <Text
                          style={{
                            fontWeight: "bold",
                            fontSize: 12,
                            color: blue,
                            marginBottom: 2,
                            wordBreak: "break-word", // ADD THIS
                          }}
                        >
                          {service.title}
                        </Text>
                        <Text
                          style={{
                            fontSize: 8,
                            color: "#374151",
                            marginBottom: 6,
                          }}
                        >
                          {service.mainDescription}
                        </Text>
                        <View style={{ marginLeft: 0 }}>
                          {service.bulletPoints.map((bullet, bulletIndex) => (
                            <View
                              key={bulletIndex}
                              style={{
                                flexDirection: "row",
                                alignItems: "flex-start",
                                marginBottom: 2,
                              }}
                            >
                              <Svg
                                width="10"
                                height="10"
                                viewBox="0 0 24 24"
                                style={{ marginRight: 6, marginTop: 2 }}
                              >
                                <Path
                                  fill={blue}
                                  d="m10.537 12l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354z"
                                />
                              </Svg>
                              <Text
                                style={{
                                  fontSize: 8,
                                  color: "#374151",
                                  flex: 1,
                                }}
                              >
                                {bullet}
                              </Text>
                            </View>
                          ))}
                        </View>
                      </View>
                    </View>
                  ))}
                </View>
              </View>
            </View>

            {/* 4. Budget Breakdown Section */}
            <View
              style={{
                flexDirection: "row",
                alignItems: "flex-start",
                marginBottom: 24,
                paddingHorizontal: 25,
              }}
            >
              {/* Left: Title and date */}
              <View
                style={{
                  flex: 1,
                  paddingRight: 20,
                  justifyContent: "flex-start",
                }}
              >
                <Text style={pdfStyles.budgetTitle}>
                  BUDGET {"\n"}BREAKDOWN
                </Text>
              </View>
              {/* Center: Stepper */}
              <View
                style={{
                  width: 48,
                  alignItems: "center",
                  position: "relative",
                }}
              >
                {/* Top vertical line */}

                {/* Circle with number */}
                <View
                  style={{
                    backgroundColor: blue,
                    borderRadius: 24,
                    width: 40,
                    height: 40,
                    alignItems: "center",
                    justifyContent: "center",
                    zIndex: 1,
                  }}
                >
                  <Text
                    style={{ color: white, fontWeight: "bold", fontSize: 12 }}
                  >
                    03.
                  </Text>
                </View>
                {/* Bottom vertical line */}
                <View
                  style={{
                    width: 2,
                    height: Math.max(80, budgetItems.length * 45), // 32px per budget row, min 80
                    backgroundColor: blue,
                    position: "absolute",
                    top: 40,
                    left: 23,
                    zIndex: 0,
                  }}
                />
                {/* Bottom dot */}
                <View
                  style={{
                    width: 8,
                    height: 8,
                    borderRadius: 4,
                    backgroundColor: blue,
                    position: "absolute",
                    top: Math.max(80, budgetItems.length * 45) + 40, // 48 = top:48 + circle radius
                    left: 20,
                  }}
                />
              </View>
              {/* Right: Content */}
              <View style={{ flex: 3, paddingLeft: 20 }}>
                <View style={pdfStyles.budgetTable}>
                  {/* Header */}
                  <View style={pdfStyles.budgetTableHeaderRow}>
                    <Text
                      style={[
                        pdfStyles.budgetTableHeaderCell,
                        pdfStyles.budgetTableHeaderCellDesc,
                        { backgroundColor: blue },
                      ]}
                    >
                      Description
                    </Text>
                    <Text
                      style={[
                        pdfStyles.budgetTableHeaderCell,
                        { flex: 0.5, backgroundColor: blue },
                      ]}
                    >
                      Qty
                    </Text>
                    <Text
                      style={[
                        pdfStyles.budgetTableHeaderCell,
                        { flex: 0.5, backgroundColor: blue },
                      ]}
                    >
                      Rate
                    </Text>
                    <Text
                      style={[
                        pdfStyles.budgetTableHeaderCell,
                        { flex: 0.1, backgroundColor: gray50 },
                      ]}
                    >
                      {" "}
                    </Text>
                    <Text
                      style={[
                        pdfStyles.budgetTableHeaderCell,
                        pdfStyles.budgetTableHeaderCellAmount,
                        { flex: 1.5 },
                      ]}
                    >
                      Amount
                    </Text>
                  </View>
                  {/* Rows */}
                  {budgetItems.map((item, idx) => (
                    <View key={idx} style={pdfStyles.budgetTableRow}>
                      <View
                        style={[
                          pdfStyles.budgetTableCell,
                          { flex: 3, textAlign: "left" },
                        ]}
                      >
                        <View
                          style={{ flexDirection: "row", alignItems: "center" }}
                        >
                          <Svg
                            width="12"
                            height="12"
                            viewBox="0 0 24 24"
                            style={{ marginRight: 4 }}
                          >
                            <Path
                              fill={blue}
                              d="m10.537 12l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354z"
                            />
                          </Svg>
                          <Text style={{ fontSize: 10 }}>
                            {item.description}
                          </Text>
                        </View>
                      </View>
                      <Text style={[pdfStyles.budgetTableCell, { flex: 0.5 }]}>
                        {item.qty}
                      </Text>
                      <Text style={[pdfStyles.budgetTableCell, { flex: 0.5 }]}>
                        {item.rate}
                      </Text>
                      <Text style={[pdfStyles.budgetTableCell, { flex: 0.1 }]}>
                        {" "}
                      </Text>
                      <Text
                        style={[
                          pdfStyles.budgetTableCell,
                          { flex: 1.5, textAlign: "right" },
                        ]}
                      >
                        Rs{" "}
                        {formatNumber(
                          parseFloat(item.qty) * parseFloat(item.rate) || 0
                        )}
                      </Text>
                    </View>
                  ))}
                  {/* Subtotal */}
                  <View style={pdfStyles.budgetSubtotalRow}>
                    <Text style={[pdfStyles.budgetSubtotalCell, { flex: 4 }]}>
                      Sub total
                    </Text>
                    <Text
                      style={[
                        pdfStyles.budgetTableCell,
                        { flex: 0.1, backgroundColor: gray50 },
                      ]}
                    >
                      {" "}
                    </Text>
                    <Text
                      style={[
                        pdfStyles.budgetSubtotalCellAmount,
                        { flex: 1.5, textAlign: "right" },
                      ]}
                    >
                      Rs {formatNumber(calculateBudgetSubtotal())}
                    </Text>
                  </View>
                  {/* Total */}
                  <View style={pdfStyles.budgetTotalRow}>
                    <Text
                      style={[
                        pdfStyles.budgetTotalCell,
                        { flex: 4, borderTopWidth: 2, borderTopColor: blue },
                      ]}
                    >
                      TOTAL
                    </Text>
                    <Text style={[pdfStyles.budgetTableCell, { flex: 0.1 }]}>
                      {" "}
                    </Text>
                    <Text
                      style={[
                        pdfStyles.budgetTotalCellAmount,
                        {
                          flex: 1.5,
                          textAlign: "right",
                          borderTopWidth: 2,
                          borderTopColor: blue,
                        },
                      ]}
                    >
                      Rs {formatNumber(calculateBudgetSubtotal())}
                    </Text>
                  </View>
                </View>
              </View>
            </View>
          </View>
        </View>
      </Page>
      <Page size="A4" style={pdfStyles.page}>
        <View style={pdfStyles.container}>
          <View
            style={{
              backgroundColor: gray50,
            }}
          >
            {/* 5. Payment Information Section */}
            <View
              style={{
                flexDirection: "row",
                alignItems: "flex-start",
                marginBottom: 24,
                paddingHorizontal: 25,
                marginTop: 20,
              }}
            >
              {/* Left: Title */}
              <View
                style={{
                  flex: 1,
                  paddingRight: 20,
                  justifyContent: "flex-start",
                }}
              >
                <Text style={pdfStyles.paymentTitle}>
                  PAYMENT {"\n"}INFORMATION
                </Text>
              </View>
              {/* Center: Stepper */}
              <View
                style={{
                  width: 48,
                  alignItems: "center",
                  position: "relative",
                }}
              >
                {/* Top vertical line */}

                {/* Circle with number */}
                <View
                  style={{
                    backgroundColor: gray100,
                    borderRadius: 24,
                    width: 44,
                    height: 44,
                    alignItems: "center",
                    justifyContent: "center",
                    zIndex: 1,
                  }}
                >
                  <Svg width="43" height="43" viewBox="-8 -8 40 40">
                    <Path
                      fill={blue}
                      d="m14.022 16.483l-3.568 2.649c-.21.16-.52.48-.85.71a.7.7 0 0 1-.4.19a1.8 1.8 0 0 1-1.06-.55a14.5 14.5 0 0 1-1.448-1.69c-.79-1-1.56-1.999-2.3-2.999s-1.419-2.049-2.069-3.118c-1.349-2.18-1.269-1.41-.75-1.97q.47-.53 1-.999t1.11-.87l1.999-1.589l.66-.51c.16 0 .33.18.51.34q.372.349.7.74l.999 1.2l3.278 4.387a.361.361 0 1 0 .58-.43L9.254 7.488l-.95-1.26a7 7 0 0 0-1.119-1.16a1.48 1.48 0 0 0-.94-.32a1.4 1.4 0 0 0-.509.2q-.348.222-.66.49l-1.999 1.48c-.43.29-.84.59-1.24.91q-.6.497-1.139 1.059a4.6 4.6 0 0 0-.64.78a.7.7 0 0 0 0 .56q.144.381.36.73c.28.469.65.929.91 1.349c.65 1.089 1.34 2.168 2.119 3.208s1.6 2 2.449 2.999a11.5 11.5 0 0 0 1.999 1.999c.384.28.844.44 1.32.46a1.4 1.4 0 0 0 .76-.27q.526-.41.999-.88c.68-.56 1.36-1.14 1.999-1.689q.68-.549 1.38-1.08a.32.32 0 0 0-.36-.52z"
                    />
                    <Path
                      fill={blue}
                      d="m14.022 16.483l-3.568 2.649c-.21.16-.52.48-.85.71a.7.7 0 0 1-.4.19a1.8 1.8 0 0 1-1.06-.55a14.5 14.5 0 0 1-1.448-1.69c-.79-1-1.56-1.999-2.3-2.999s-1.419-2.049-2.069-3.118c-1.349-2.18-1.269-1.41-.75-1.97q.47-.53 1-.999t1.11-.87l1.999-1.589l.66-.51c.16 0 .33.18.51.34q.372.349.7.74l.999 1.2l3.278 4.387a.361.361 0 1 0 .58-.43L9.254 7.488l-.95-1.26a7 7 0 0 0-1.119-1.16a1.48 1.48 0 0 0-.94-.32a1.4 1.4 0 0 0-.509.2q-.348.222-.66.49l-1.999 1.48c-.43.29-.84.59-1.24.91q-.6.497-1.139 1.059a4.6 4.6 0 0 0-.64.78a.7.7 0 0 0 0 .56q.144.381.36.73c.28.469.65.929.91 1.349c.65 1.089 1.34 2.168 2.119 3.208s1.6 2 2.449 2.999a11.5 11.5 0 0 0 1.999 1.999c.384.28.844.44 1.32.46a1.4 1.4 0 0 0 .76-.27q.526-.41.999-.88c.68-.56 1.36-1.14 1.999-1.689q.68-.549 1.38-1.08a.32.32 0 0 0-.36-.52z"
                    />
                    <Path
                      fill={blue}
                      d="M8.914 11.175a2.38 2.38 0 0 0-2.998-.27a2.45 2.45 0 0 0-.89 1.74a2.15 2.15 0 0 0 .74 1.809c.396.308.887.47 1.39.46c.467.007.928-.117 1.329-.36a.33.33 0 0 0 .12-.44a.35.35 0 0 0 .27-.1a1.83 1.83 0 0 0 .04-2.839m-.58 2.309a.35.35 0 0 0 0 .47h-.12a1.76 1.76 0 0 1-.999.12a1.27 1.27 0 0 1-.77-.39a1.14 1.14 0 0 1-.23-1a1.33 1.33 0 0 1 .46-.89a1.24 1.24 0 0 1 1.55.07a1 1 0 0 1 .11 1.62m9.014-7.077a14 14 0 0 0-.379-1.55a7 7 0 0 0-.54-1.229a1.77 1.77 0 0 0-.81-.75a1.6 1.6 0 0 0-.74-.08q-.646.12-1.268.33a.324.324 0 0 0 .15.63q.495-.099.999-.13a.86.86 0 0 1 .45.09c.14.08.2.26.28.43q.215.518.32 1.07c.19.56.32 1.13.46 1.699s.33 1.17.49 1.75s.249.819.249.829c.08.42.62.08.66-.53c-.2-1.03-.12-1.53-.32-2.559"
                    />
                    <Path
                      fill={dark}
                      d="M23.968 16.523a7.7 7.7 0 0 0-.51-2.12a6.7 6.7 0 0 0-1.12-1.889a8.18 8.18 0 0 0-4.367-2.598c-.36-.17-.63.09-.62.52a5.7 5.7 0 0 1-.71 1.579a2.71 2.71 0 0 1-2.759.38a1.35 1.35 0 0 0-.83.09a1.54 1.54 0 0 0-1.079 1.529a2 2 0 0 0 .8 1.609c.13.07.4.2.74.34c.77.32 1.999.74 2.469 1c-.08.2.21.73.26.88a5.5 5.5 0 0 0 1.069 1.808a1.81 1.81 0 0 0 1.44.62a.36.36 0 1 0 0-.72a1.1 1.1 0 0 1-.82-.45a4.3 4.3 0 0 1-.76-1.559c-.05-.18-.07-.75-.15-1a.6.6 0 0 0-.24-.34a5.6 5.6 0 0 0-.74-.399c-.87-.4-2.288-1-2.618-1.2a.77.77 0 0 1-.21-.57a.41.41 0 0 1 .25-.42a1 1 0 0 1 .35 0q.732.074 1.469.06a3 3 0 0 0 2.209-1.289a3.26 3.26 0 0 0 .48-1.709a7.6 7.6 0 0 1 3.448 2.56c.37.497.672 1.042.9 1.618c.234.583.402 1.19.5 1.81c.23 1.504.161 3.04-.2 4.518a.37.37 0 0 0 .25.45a.36.36 0 0 0 .44-.25c.556-1.556.78-3.21.66-4.858"
                    />
                    <Path
                      fill={blue}
                      d="M14.852 10.066c-.29-1-.55-2-.83-3c-.18-.669-.39-1.329-.58-1.998a7.7 7.7 0 0 0-.75-2a1.45 1.45 0 0 0-1.079-.71a.87.87 0 0 0-.46.1q-.383.23-.74.5l-2.438 1.55a.32.32 0 1 0 .27.57l2.639-1.26c.45-.23.58-.89 1 .3c.18.48.29 1 .37 1.29c.389 1.189.769 2.368 1.189 3.548s.69 1.61 1.14 2.669c.199.58.719.72.719.29c-.21-.7-.24-1.15-.45-1.85"
                    />
                  </Svg>
                </View>
                {/* Bottom vertical line */}
                <View
                  style={{
                    width: 2,
                    height: 135,
                    backgroundColor: blue,
                    position: "absolute",
                    top: 42,
                    left: 23,
                    zIndex: 0,
                  }}
                />
                {/* Bottom dot */}
                <View
                  style={{
                    width: 8,
                    height: 8,
                    borderRadius: 4,
                    backgroundColor: blue,
                    position: "absolute",
                    top: 175,
                    left: 20,
                  }}
                />
              </View>
              {/* Right: Content */}
              <View style={{ flex: 3, paddingLeft: 20 }}>
                <View style={pdfStyles.paymentGrid}>
                  <View style={pdfStyles.paymentCard}>
                    <Text style={pdfStyles.paymentLabel}>Account Name</Text>
                    <Text style={pdfStyles.paymentValue}>
                      {quotationDetails.accountName}
                    </Text>
                  </View>
                  <View style={pdfStyles.paymentCard}>
                    <Text style={pdfStyles.paymentLabel}>Bank Name</Text>
                    <Text style={pdfStyles.paymentValue}>
                      {quotationDetails.bankName}
                    </Text>
                  </View>
                  <View style={pdfStyles.paymentCard}>
                    <Text style={pdfStyles.paymentLabel}>Account Number</Text>
                    <Text style={pdfStyles.paymentValue}>
                      {quotationDetails.accountNumber}
                    </Text>
                  </View>
                  <View style={pdfStyles.paymentCard}>
                    <Text style={pdfStyles.paymentLabel}>IFSC Code</Text>
                    <Text style={pdfStyles.paymentValue}>
                      {quotationDetails.ifscCode}
                    </Text>
                  </View>
                  <View style={pdfStyles.paymentCard}>
                    <Text style={pdfStyles.paymentLabel}>GSTIN</Text>
                    <Text style={pdfStyles.paymentValue}>
                      {quotationDetails.gstin}
                    </Text>
                  </View>
                  <View style={pdfStyles.paymentCard}>
                    <Text style={pdfStyles.paymentLabel}>Branch</Text>
                    <Text style={pdfStyles.paymentValue}>
                      {quotationDetails.branch}
                    </Text>
                  </View>
                </View>
              </View>
            </View>

            {/* 6. Payment Conditions Section */}
            <View
              style={{
                flexDirection: "row",
                alignItems: "flex-start",
                marginBottom: 24,
                paddingHorizontal: 25,
              }}
            >
              {/* Left: Title */}
              <View
                style={{
                  flex: 1,
                  paddingRight: 20,
                  justifyContent: "flex-start",
                }}
              >
                <Text style={pdfStyles.conditionsTitle}>
                  PAYMENT {"\n"}CONDITIONS
                </Text>
              </View>
              {/* Center: Stepper */}
              <View
                style={{
                  width: 48,
                  alignItems: "center",
                  position: "relative",
                }}
              >
                {/* Top vertical line */}

                {/* Circle with number */}
                <View
                  style={{
                    backgroundColor: gray700,
                    borderRadius: 24,
                    width: 40,
                    height: 40,
                    alignItems: "center",
                    justifyContent: "center",
                    zIndex: 1,
                  }}
                >
                  <Text
                    style={{ color: white, fontWeight: "bold", fontSize: 12 }}
                  >
                    05.
                  </Text>
                </View>
                {/* Bottom vertical line */}
                <View
                  style={{
                    width: 2,
                    height: paymentConditionsHeight,
                    backgroundColor: gray700,
                    position: "absolute",
                    top: 40,
                    left: 23,
                    zIndex: 0,
                  }}
                />
                {/* Bottom dot */}
                <View
                  style={{
                    width: 8,
                    height: 8,
                    borderRadius: 4,
                    backgroundColor: gray700,
                    position: "absolute",
                    top: paymentConditionsHeight + 35,
                    left: 20,
                  }}
                />
              </View>
              {/* Right: Content */}
              <View style={{ flex: 3, paddingLeft: 20 }}>
                <View style={pdfStyles.conditionsGrid}>
                  {/* Delivery & Payment Terms */}
                  <View style={pdfStyles.conditionsCol}>
                    <Text style={pdfStyles.conditionsColTitle}>
                      Delivery & Payment Terms
                    </Text>
                    <View style={pdfStyles.conditionsList}>
                      {(deliveryTerms.length > 0
                        ? deliveryTerms
                        : [
                            "Drawing delivery time is subject to timely comments from client and payments as per agreed terms",
                            "All drawings will be designed as per requirements, plot details, and bylaws provided by the client",
                          ]
                      ).map((term, idx) => (
                        <View key={idx} style={pdfStyles.conditionsListItem}>
                          <Svg
                            width="8"
                            height="8"
                            viewBox="0 0 24 24"
                            style={pdfStyles.conditionsBulletIcon}
                          >
                            <Path
                              fill={dark}
                              d="m10.537 12l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354z"
                            />
                          </Svg>
                          <Text style={pdfStyles.conditionsBulletText}>
                            {term}
                          </Text>
                        </View>
                      ))}
                    </View>
                  </View>
                  {/* Scope & Modifications */}
                  <View style={pdfStyles.conditionsCol}>
                    <Text style={pdfStyles.conditionsColTitle}>
                      Scope & Modifications
                    </Text>
                    <View style={pdfStyles.conditionsList}>
                      {(scopeModifications.length > 0
                        ? scopeModifications
                        : [
                            "If requirements change from initially provided specifications (plot size, number of floors, dimensions, direction etc.), additional charges will apply",
                            "Time required to complete all services will depend entirely on client satisfaction and approval process",
                          ]
                      ).map((term, idx) => (
                        <View key={idx} style={pdfStyles.conditionsListItem}>
                          <Svg
                            width="8"
                            height="8"
                            viewBox="0 0 24 24"
                            style={pdfStyles.conditionsBulletIcon}
                          >
                            <Path
                              fill={dark}
                              d="m10.537 12l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354zm6.1 0l-4.24-4.246q-.141-.14-.154-.341t.153-.367q.16-.16.354-.16t.354.16l4.388 4.389q.131.13.184.267t.053.298t-.053.298t-.184.268l-4.388 4.388q-.14.14-.341.153t-.367-.153q-.16-.16-.16-.354t.16-.354z"
                            />
                          </Svg>
                          <Text style={pdfStyles.conditionsBulletText}>
                            {term}
                          </Text>
                        </View>
                      ))}
                    </View>
                  </View>
                </View>
              </View>
            </View>
          </View>

          {/* Closing Section */}
          <View style={pdfStyles.closingSection}>
            <Text style={pdfStyles.closingText}>
              Thank you for the opportunity to serve you. We look forward to
              further communication with you after you have reviewed this
              proposal.
            </Text>
            <Text style={pdfStyles.closingTitle}>
              Your positive reply awaiting!
            </Text>
          </View>
        </View>
      </Page>
    </Document>
  );
};

// Helper to parse bulletpoints JSON string to array
const parseBulletpoints = (bulletpoints) => {
  if (!bulletpoints) return [];
  try {
    const obj =
      typeof bulletpoints === "string"
        ? JSON.parse(bulletpoints)
        : bulletpoints;
    // Get values sorted by key (bulletpoint1, bulletpoint2, ...)
    return Object.keys(obj)
      .sort((a, b) => {
        // Extract numbers for sorting
        const numA = parseInt(a.replace(/\D/g, ""));
        const numB = parseInt(b.replace(/\D/g, ""));
        return numA - numB;
      })
      .map((key) => obj[key]);
  } catch (e) {
    return [];
  }
};

export default QuotationCreate;
</file>

</files>
